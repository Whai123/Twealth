คุณเป็น principal engineer แก้ bug production ของเว็บ https://twealth.ltd ที่ “keep refreshing / Updating app…” วนไม่หยุด (โดยเฉพาะบน Safari iOS)

สมมติฐานหลัก (โฟกัส): เป็น Service Worker/PWA update loop จาก SW เก่าที่ยังคุมหน้าเว็บอยู่ แม้ตอนนี้จะ disable PWA แล้ว ผู้ใช้เดิมยังติด SW เก่า → พยายามโหลด bundle/asset เดิมที่ 404/เปลี่ยนชื่อ → รีเฟรชวน

ภารกิจ: ทำ “SW kill-switch” เพื่อปลดล็อคผู้ใช้เดิมทันที
1) ค้นหาใน repo ว่าเคย register service worker ที่ path ไหน (เช่น /sw.js, /service-worker.js, /registerSW.js, vite-plugin-pwa)
   - หาใน index.html / src/main.tsx / src/main.ts / src/serviceWorker*
2) สร้างไฟล์ service worker “ชื่อและ path เดิม” ที่เคยใช้จริง (สำคัญมาก) โดยให้ทำงานดังนี้:
   - ใน install: self.skipWaiting()
   - ใน activate:
       - ลบ caches ทั้งหมด: caches.keys() แล้ว caches.delete(key)
       - unregister ตัวเอง: self.registration.unregister()
       - แจ้ง client ทุกตัวให้ reload/navigate ใหม่ เพื่อหลุดจาก loop
   ตัวอย่าง logic ที่ต้อง implement:
     self.addEventListener('install', (e)=> self.skipWaiting());
     self.addEventListener('activate', (e)=> {
       e.waitUntil((async ()=>{
         const keys = await caches.keys();
         await Promise.all(keys.map(k=>caches.delete(k)));
         await self.registration.unregister();
         const clientsList = await self.clients.matchAll({type:'window', includeUncontrolled:true});
         clientsList.forEach(c=> c.navigate(c.url));
       })());
     });
   - ไม่ต้อง cache อะไรเพิ่ม
3) ให้ server เสิร์ฟไฟล์ SW นี้ได้แน่นอน:
   - ตรวจว่า express/static เสิร์ฟจากโฟลเดอร์ไหน (dist/public หรือ server/public ฯลฯ)
   - ถ้าจำเป็น เพิ่ม route explicit:
       GET /sw.js (หรือ path เดิม) → ส่งไฟล์ kill-switch ด้วย Content-Type: application/javascript
4) ป้องกัน loop จาก HTML cache:
   - ตั้ง header สำหรับ “/” และ index.html เป็น no-store / no-cache
   - อย่างน้อย: res.set('Cache-Control','no-store') สำหรับ HTML
5) ตรวจว่าไม่มีโค้ด registerSW ใหม่หลงเหลือ:
   - ถ้าพบ ให้ disable/ลบออก (ชั่วคราว)
6) ทดสอบ:
   - เปิดหน้าใน browser ปกติ แล้วเช็คว่ารีเฟรชหยุด
   - บน Safari iOS ให้ทดสอบ 2 แบบ: normal + private
7) สรุปสิ่งที่แก้: path SW เดิมคืออะไร, แก้ไฟล์ไหนบ้าง, ทำไม kill-switch ถึงปลด loop ได้

ข้อห้าม: ห้ามเดา path ของ SW ให้ค้นจากโค้ดจริงก่อนเสมอ