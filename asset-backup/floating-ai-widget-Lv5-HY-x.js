import{p as A,r as n,ae as E,q as P,z as N,B as w,y as C,j as e,H as h,O as Q,Q as T,S as z,U as K,X as F,V as O,_ as R,Z as B}from"./index-NNgTI0RQ.js";import{S}from"./sparkles-yxnOzOhM.js";import{S as H}from"./send-CxgCRlQP.js";const $=[{label:"Add transaction",prompt:"Help me log a transaction"},{label:"Create goal",prompt:"I want to create a savings goal"},{label:"Budget advice",prompt:"Give me budget advice based on my spending"},{label:"Savings tips",prompt:"How can I save more money?"}];function V(){const[l]=A(),[i,g]=n.useState(!1),[r,c]=n.useState(""),[a,v]=n.useState(null),f=n.useRef(null),d=E(),{toast:k}=P(),o=n.useRef(!1),q=()=>{var s;(s=f.current)==null||s.scrollIntoView({behavior:"smooth"})},m=N({mutationFn:async()=>await(await w("POST","/api/chat/conversations",{title:"Quick Chat"})).json(),onSuccess:s=>{v(s.id),o.current=!1},onError:()=>{o.current=!1}}),{data:u=[],isFetched:j}=C({queryKey:["/api/chat/conversations"],enabled:i,staleTime:3e4});n.useEffect(()=>{if(!(!i||!j)&&!a){if(u.length>0){v(u[0].id);return}!o.current&&!m.isPending&&(o.current=!0,m.mutate())}},[i,j,u.length,a,m.isPending]);const{data:p}=C({queryKey:["/api/chat/conversations",a],enabled:!!a&&i}),b=(p==null?void 0:p.messages)||[],t=N({mutationFn:async s=>{if(!a)throw new Error("No conversation");return await(await w("POST",`/api/chat/conversations/${a}/messages`,{content:s,mode:"quick"})).json()},onSuccess:()=>{d.invalidateQueries({queryKey:["/api/chat/conversations",a]}),d.invalidateQueries({queryKey:["/api/financial-goals"]}),d.invalidateQueries({queryKey:["/api/transactions"]}),c(""),q()},onError:s=>{k({title:"Error",description:s.message||"Failed to send message",variant:"destructive"})}}),y=()=>{r.trim()&&!t.isPending&&t.mutate(r.trim())},I=s=>{c(s),t.isPending||t.mutate(s)};return l!=null&&l.startsWith("/ai-assistant")?null:i?e.jsx("div",{className:"fixed right-2 z-50 w-[calc(100vw-16px)] sm:w-96 max-w-[400px] bottom-[calc(72px+env(safe-area-inset-bottom,0px))] md:bottom-6 md:right-6",children:e.jsxs(Q,{className:"shadow-2xl",children:[e.jsx(T,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-primary/10 rounded-lg",children:e.jsx(S,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx(z,{className:"text-lg",children:"AI Assistant"}),e.jsx(K,{className:"text-xs",children:"Ask me anything"})]})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>g(!1),"data-testid":"button-close-ai-widget","aria-label":"Close AI assistant",className:"min-w-[44px] min-h-[44px]",children:e.jsx(F,{className:"h-4 w-4"})})]})}),e.jsxs(O,{className:"p-0",children:[b.length===0&&e.jsx("div",{className:"px-4 pb-3",children:e.jsx("div",{className:"grid grid-cols-2 gap-2",children:$.map((s,x)=>e.jsx("button",{onClick:()=>I(s.prompt),className:"p-3 text-left border rounded-lg hover:bg-muted transition-colors text-sm","data-testid":`quick-action-${x}`,children:e.jsx("div",{className:"font-medium",children:s.label})},x))})}),e.jsxs("div",{className:"h-96 overflow-y-auto px-4 pb-4 space-y-3",children:[b.map(s=>e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-lg px-3 py-2 text-sm ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,children:s.content})},s.id)),t.isPending&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"bg-muted rounded-lg px-3 py-2 text-sm flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 animate-spin"}),"Thinking..."]})}),e.jsx("div",{ref:f})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{value:r,onChange:s=>c(s.target.value),onKeyDown:s=>s.key==="Enter"&&y(),placeholder:"Ask anything...",disabled:t.isPending,className:"flex-1","data-testid":"input-ai-message"}),e.jsx(h,{onClick:y,disabled:!r.trim()||t.isPending,size:"sm","data-testid":"button-send-ai-message","aria-label":"Send message",className:"min-w-[44px] min-h-[44px]",children:e.jsx(H,{className:"h-4 w-4"})})]})})]})]})}):e.jsx("div",{className:"fixed right-4 z-50 bottom-[calc(72px+env(safe-area-inset-bottom,0px))] md:bottom-6 md:right-6",children:e.jsx(h,{onClick:()=>g(!0),size:"lg",className:"rounded-full h-12 w-12 min-h-[48px] min-w-[48px] shadow-lg","data-testid":"button-open-ai-widget",children:e.jsx(S,{className:"h-5 w-5"})})})}export{V as default};
