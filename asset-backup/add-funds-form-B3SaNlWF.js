import{r as $,a as I,a5 as L,aa as O,p as k,h as K,j as e,d as E,e as G,f as M,ab as y,I as D,B as S,L as R,O as P,o as B,ax as j,N as H,Q as U,R as v}from"./index-B1iCb0U8.js";import{T as V}from"./textarea-BqHY_pYZ.js";const Y=U({amount:v().min(1,"Amount is required").refine(d=>!isNaN(parseFloat(d))&&parseFloat(d)>0,"Must be a valid positive number"),description:v().optional(),date:v().min(1,"Date is required")});function J({goalId:d,goalTitle:o,currentAmount:f,targetAmount:b,onSuccess:u}){const[h,N]=$.useState(!1),{toast:c}=I(),s=L(),{user:n,isLoading:A}=O(),{register:x,handleSubmit:Q,formState:{errors:l},reset:T}=k({resolver:P(Y),defaultValues:{date:new Date().toISOString().split("T")[0]}}),q=K({mutationFn:a=>B("POST","/api/transactions",{userId:n==null?void 0:n.id,amount:parseFloat(a.amount),type:"transfer",category:"savings",description:a.description||`Added funds to ${o}`,goalId:d,date:new Date(a.date).toISOString()}),onMutate:async a=>{await s.cancelQueries({queryKey:["/api/financial-goals"]}),await s.cancelQueries({queryKey:["/api/transactions"]});const m=s.getQueryData(["/api/financial-goals"]),t=s.getQueryData(["/api/transactions"]),p=parseFloat(a.amount);s.setQueryData(["/api/financial-goals"],i=>Array.isArray(i)?i.map(r=>r.id===d?{...r,currentAmount:(parseFloat(r.currentAmount)+p).toString()}:r):i);const g={id:`temp-${Date.now()}`,userId:n==null?void 0:n.id,type:"transfer",amount:p,category:"savings",description:a.description||`Added funds to ${o}`,goalId:d,date:new Date(a.date).toISOString(),createdAt:new Date().toISOString()};return s.setQueryData(["/api/transactions"],i=>Array.isArray(i)?[g,...i]:[g]),{previousGoals:m,previousTransactions:t}},onSuccess:(a,m)=>{s.invalidateQueries({queryKey:["/api/financial-goals"]}),s.invalidateQueries({queryKey:["/api/transactions"]}),s.invalidateQueries({queryKey:["/api/dashboard/stats"]}),s.invalidateQueries({queryKey:["/api/goal-milestones"]}),c({title:"Funds added successfully",description:`$${parseFloat(m.amount).toLocaleString()} has been added to your ${o} goal.`,icon:e.jsx(H,{className:"h-5 w-5 text-green-600 dark:text-green-400"})}),T(),u==null||u()},onError:(a,m,t)=>{var i,r,F,w;t!=null&&t.previousGoals&&s.setQueryData(["/api/financial-goals"],t.previousGoals),t!=null&&t.previousTransactions&&s.setQueryData(["/api/transactions"],t.previousTransactions);const p=((i=a.message)==null?void 0:i.includes("fetch"))||((r=a.message)==null?void 0:r.includes("network")),g=((F=a.message)==null?void 0:F.includes("amount"))||((w=a.message)==null?void 0:w.includes("number"));c({title:"Couldn't Add Funds",description:p?"Check your internet connection and try again.":g?"Please enter a valid amount (numbers only, no symbols).":a.message||"Something went wrong. Your contribution wasn't saved - please try again.",variant:"destructive",icon:e.jsx(j,{className:"h-5 w-5"})})},onSettled:()=>{N(!1)}}),C=a=>{if(!n){c({title:"Sign In Required",description:"Please sign in to contribute to your financial goals.",variant:"destructive",icon:e.jsx(j,{className:"h-5 w-5"})});return}if(new Date(a.date)>new Date){c({title:"Invalid date",description:"Transaction date cannot be in the future.",variant:"destructive",icon:e.jsx(j,{className:"h-5 w-5"})});return}N(!0),q.mutate(a)};return A?e.jsx("div",{className:"p-6",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-6 bg-muted rounded w-3/4 mb-4"}),e.jsx("div",{className:"h-10 bg-muted rounded mb-4"}),e.jsx("div",{className:"h-10 bg-muted rounded mb-4"}),e.jsx("div",{className:"h-10 bg-muted rounded mb-4"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs(E,{children:[e.jsx(G,{children:"Add Funds to Goal"}),e.jsx(M,{children:"Record a contribution towards your goal"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Goal: ",o]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Current: $",parseFloat(f).toLocaleString()," / Target: $",parseFloat(b).toLocaleString()]}),e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"text-xs text-muted-foreground mb-1",children:["Progress: ",Math.round(parseFloat(f)/parseFloat(b)*100),"%"]})})]}),e.jsxs("form",{onSubmit:Q(C),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{htmlFor:"amount",children:"Amount ($)"}),e.jsx(D,{id:"amount",type:"number",step:"0.01",min:"0",...x("amount"),placeholder:"0.00","data-testid":"input-add-funds-amount"}),l.amount&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:l.amount.message})]}),e.jsxs("div",{children:[e.jsx(y,{htmlFor:"date",children:"Date"}),e.jsx(D,{id:"date",type:"date",...x("date"),"data-testid":"input-add-funds-date"}),l.date&&e.jsx("p",{className:"text-sm text-destructive mt-1",children:l.date.message})]})]}),e.jsxs("div",{children:[e.jsx(y,{htmlFor:"description",children:"Description (Optional)"}),e.jsx(V,{id:"description",...x("description"),placeholder:`Add a note about this contribution to ${o}`,rows:3,"data-testid":"input-add-funds-description"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(S,{type:"button",variant:"outline",onClick:u,disabled:h,"data-testid":"button-cancel-add-funds",children:"Cancel"}),e.jsx(S,{type:"submit",disabled:h,className:"min-w-[140px]","data-testid":"button-confirm-add-funds",children:h?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Adding..."]}):"Add Funds"})]})]})]})]})}export{J as A};
