{"file_contents":{"client/src/components/dashboard/smart-insights.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from\"@/components/ui/tabs\";\nimport { \n TrendingUp, \n TrendingDown, \n DollarSign, \n Target, \n Lightbulb, \n Calendar,\n PiggyBank,\n AlertTriangle,\n CheckCircle,\n ArrowUp,\n ArrowDown,\n Zap\n} from\"lucide-react\";\nimport { Progress } from\"@/components/ui/progress\";\nimport NotificationActions from\"./notification-actions\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface Transaction {\n id: string;\n amount: string;\n type: 'income' | 'expense' | 'transfer';\n category: string;\n description?: string;\n date: string;\n}\n\ninterface FinancialGoal {\n id: string;\n title: string;\n targetAmount: string;\n currentAmount: string;\n targetDate: string;\n category: string;\n priority: string;\n status: string;\n}\n\ninterface SmartInsight {\n type: 'trend' | 'suggestion' | 'warning' | 'achievement';\n title: string;\n description: string;\n value?: string;\n change?: number;\n priority: 'low' | 'medium' | 'high';\n actionable: boolean;\n action?: {\n  label: string;\n  type: string;\n  data?: any;\n };\n}\n\nexport default function SmartInsights() {\n const { formatAmount } = useUserCurrency();\n \n // Fetch user data\n const { data: transactions = [] } = useQuery<Transaction[]>({\n  queryKey: [\"/api/transactions\"],\n });\n\n const { data: goals = [] } = useQuery<FinancialGoal[]>({\n  queryKey: [\"/api/financial-goals\"],\n });\n\n const { data: stats } = useQuery({\n  queryKey: [\"/api/dashboard/stats\"],\n });\n\n // Calculate insights\n const generateInsights = (): SmartInsight[] => {\n  const insights: SmartInsight[] = [];\n  const now = new Date();\n  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n\n  // Filter recent transactions\n  const recentTransactions = transactions.filter(t => \n   new Date(t.date) >= thirtyDaysAgo\n  );\n\n  // 1. Spending Trends Analysis\n  const totalExpenses = recentTransactions\n   .filter(t => t.type === 'expense')\n   .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n  const totalIncome = recentTransactions\n   .filter(t => t.type === 'income')\n   .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n  const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : 0;\n\n  if (savingsRate < 10 && totalIncome > 0) {\n   insights.push({\n    type: 'warning',\n    title: 'Low Savings Rate',\n    description: `Your savings rate is ${savingsRate.toFixed(1)}%. Financial experts recommend saving at least 10-20% of income.`,\n    value: `${savingsRate.toFixed(1)}%`,\n    priority: 'high',\n    actionable: true,\n    action: {\n     label: 'Set Savings Goal',\n     type: 'create_goal',\n     data: { suggestedAmount: totalIncome * 0.15 }\n    }\n   });\n  } else if (savingsRate >= 20) {\n   insights.push({\n    type: 'achievement',\n    title: 'Excellent Savings Rate!',\n    description: `Your ${savingsRate.toFixed(1)}% savings rate is outstanding! You're building wealth effectively.`,\n    value: `${savingsRate.toFixed(1)}%`,\n    priority: 'medium',\n    actionable: false\n   });\n  }\n\n  // 2. Category Analysis\n  const expensesByCategory = recentTransactions\n   .filter(t => t.type === 'expense')\n   .reduce((acc, t) => {\n    acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount);\n    return acc;\n   }, {} as Record<string, number>);\n\n  const topExpenseCategory = Object.entries(expensesByCategory)\n   .sort(([,a], [,b]) => b - a)[0];\n\n  if (topExpenseCategory && totalExpenses > 0) {\n   const categoryPercent = (topExpenseCategory[1] / totalExpenses) * 100;\n   if (categoryPercent > 40) {\n    insights.push({\n     type: 'warning',\n     title: `High ${topExpenseCategory[0]} Spending`,\n     description: `${categoryPercent.toFixed(1)}% of your expenses are in ${topExpenseCategory[0]}. Consider reviewing this category.`,\n     value: formatAmount(topExpenseCategory[1]),\n     priority: 'medium',\n     actionable: true,\n     action: {\n      label: 'Review Transactions',\n      type: 'view_transactions',\n      data: { category: topExpenseCategory[0] }\n     }\n    });\n   }\n  }\n\n  // 3. Goal Progress Analysis\n  goals.forEach(goal => {\n   const currentAmount = parseFloat(goal.currentAmount ||\"0\");\n   const targetAmount = parseFloat(goal.targetAmount);\n   const progressPercent = (currentAmount / targetAmount) * 100;\n   const daysUntilTarget = Math.ceil((new Date(goal.targetDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n\n   // Almost complete goals\n   if (progressPercent >= 80 && progressPercent < 100) {\n    insights.push({\n     type: 'achievement',\n     title: `${goal.title} Almost Complete! `,\n     description: `You're ${progressPercent.toFixed(0)}% done! Just ${formatAmount(targetAmount - currentAmount)} more to go.`,\n     value: `${progressPercent.toFixed(0)}%`,\n     priority: 'medium',\n     actionable: true,\n     action: {\n      label: 'Add Funds',\n      type: 'add_transaction',\n      data: { goalId: goal.id, amount: targetAmount - currentAmount }\n     }\n    });\n   }\n\n   // Behind schedule goals\n   if (daysUntilTarget <= 60 && daysUntilTarget > 0 && progressPercent < 50) {\n    const requiredDaily = (targetAmount - currentAmount) / daysUntilTarget;\n    insights.push({\n     type: 'warning',\n     title: `${goal.title} Behind Schedule`,\n     description: `With ${daysUntilTarget} days left, you need to save ${formatAmount(requiredDaily)} daily to reach your goal.`,\n     value: `${formatAmount(requiredDaily)}/day`,\n     priority: 'high',\n     actionable: true,\n     action: {\n      label: 'Boost Savings',\n      type: 'add_transaction',\n      data: { goalId: goal.id, amount: requiredDaily * 7 }\n     }\n    });\n   }\n  });\n\n  // 4. Transaction Frequency\n  const recentWeekTransactions = transactions.filter(t => \n   new Date(t.date) >= sevenDaysAgo\n  );\n\n  if (recentWeekTransactions.length === 0) {\n   insights.push({\n    type: 'suggestion',\n    title: 'Track Your Spending',\n    description: 'No transactions recorded this week. Regular tracking helps you stay on top of your finances.',\n    priority: 'medium',\n    actionable: true,\n    action: {\n     label: 'Add Transaction',\n     type: 'add_transaction'\n    }\n   });\n  }\n\n  // 5. Optimal Savings Suggestion\n  if (totalIncome > 0 && savingsRate < 15) {\n   const suggestedSavings = totalIncome * 0.15;\n   const currentSavings = totalIncome - totalExpenses;\n   const additionalSavings = suggestedSavings - currentSavings;\n\n   if (additionalSavings > 0) {\n    insights.push({\n     type: 'suggestion',\n     title: 'Optimize Your Savings',\n     description: `Consider saving an additional ${formatAmount(additionalSavings)} monthly to reach the recommended 15% savings rate.`,\n     value: `+${formatAmount(additionalSavings)}`,\n     priority: 'medium',\n     actionable: true,\n     action: {\n      label: 'Create Savings Goal',\n      type: 'create_goal',\n      data: { amount: additionalSavings * 12, category: 'emergency' }\n     }\n    });\n   }\n  }\n\n  return insights.sort((a, b) => {\n   const priorityOrder = { high: 3, medium: 2, low: 1 };\n   return priorityOrder[b.priority] - priorityOrder[a.priority];\n  });\n };\n\n const insights = generateInsights();\n const trendInsights = insights.filter(i => i.type === 'trend');\n const suggestionInsights = insights.filter(i => i.type === 'suggestion');\n const warningInsights = insights.filter(i => i.type === 'warning');\n const achievementInsights = insights.filter(i => i.type === 'achievement');\n\n const getInsightIcon = (type: string) => {\n  switch (type) {\n   case 'trend':\n    return <TrendingUp className=\"text-blue-500\" size={16} />;\n   case 'suggestion':\n    return <Lightbulb className=\"text-yellow-500\" size={16} />;\n   case 'warning':\n    return <AlertTriangle className=\"text-red-500\" size={16} />;\n   case 'achievement':\n    return <CheckCircle className=\"text-green-500\" size={16} />;\n   default:\n    return <Zap className=\"text-blue-500\" size={16} />;\n  }\n };\n\n const getPriorityColor = (priority: string) => {\n  switch (priority) {\n   case 'high':\n    return 'border-l-red-500 bg-red-50 dark:bg-red-900/10';\n   case 'medium':\n    return 'border-l-yellow-500 bg-yellow-50 dark:bg-yellow-900/10';\n   case 'low':\n    return 'border-l-blue-500 bg-blue-50 dark:bg-blue-900/10';\n   default:\n    return 'border-l-gray-500 bg-gray-50 dark:bg-gray-900/10';\n  }\n };\n\n return (\n  <NotificationActions>\n   {(handlers) => (\n    <Card className=\"shadow-sm hover-lift\">\n   <CardHeader className=\"pb-4\">\n    <div className=\"flex items-center gap-2\">\n     <div className=\"w-8 h-8 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center\">\n      <Lightbulb className=\"text-white\" size={18} />\n     </div>\n     <CardTitle className=\"text-lg font-semibold text-foreground\">\n      Smart Financial Insights\n     </CardTitle>\n    </div>\n    <p className=\"text-sm text-muted-foreground\">\n     AI-powered analysis of your financial patterns and personalized recommendations\n    </p>\n   </CardHeader>\n\n   <CardContent className=\"p-6\">\n    <Tabs defaultValue=\"all\" className=\"space-y-4\">\n     <TabsList className=\"grid w-full grid-cols-4\">\n      <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n       All ({insights.length})\n      </TabsTrigger>\n      <TabsTrigger value=\"warnings\" data-testid=\"tab-warnings\">\n       Warnings ({warningInsights.length})\n      </TabsTrigger>\n      <TabsTrigger value=\"suggestions\" data-testid=\"tab-suggestions\">\n       Tips ({suggestionInsights.length})\n      </TabsTrigger>\n      <TabsTrigger value=\"achievements\" data-testid=\"tab-achievements\">\n       Wins ({achievementInsights.length})\n      </TabsTrigger>\n     </TabsList>\n\n     <TabsContent value=\"all\" className=\"space-y-3\">\n      {insights.length === 0 ? (\n       <div className=\"text-center py-8 text-muted-foreground\">\n        <Lightbulb size={32} className=\"mx-auto mb-2 opacity-50\" />\n        <p className=\"font-medium\">No insights available</p>\n        <p className=\"text-sm\">Add some transactions and goals to get personalized insights</p>\n       </div>\n      ) : (\n       insights.map((insight, index) => (\n        <Card\n         key={index}\n         className={`p-4 border-l-4 transition-all hover:shadow-md ${getPriorityColor(insight.priority)}`}\n         data-testid={`insight-${index}`}\n        >\n         <div className=\"flex items-start justify-between\">\n          <div className=\"flex-1\">\n           <div className=\"flex items-center gap-2 mb-2\">\n            {getInsightIcon(insight.type)}\n            <h4 className=\"font-medium text-sm\">{insight.title}</h4>\n            <Badge \n             variant={insight.priority === 'high' ? 'destructive' : 'secondary'}\n             className=\"text-xs\"\n            >\n             {insight.priority}\n            </Badge>\n           </div>\n           \n           <p className=\"text-sm text-muted-foreground mb-3\">\n            {insight.description}\n           </p>\n\n           {insight.value && (\n            <div className=\"flex items-center gap-2 mb-3\">\n             <Badge variant=\"outline\" className=\"font-mono\">\n              {insight.value}\n             </Badge>\n            </div>\n           )}\n\n           {insight.actionable && insight.action && (\n            <Button\n             size=\"sm\"\n             variant=\"outline\"\n             className=\"h-8 text-xs\"\n             onClick={() => {\n              const action = insight.action;\n              if (!action) return;\n\n              switch (action.type) {\n               case 'create_goal':\n                handlers.openGoalForm(action.data);\n                break;\n               case 'add_transaction':\n                handlers.openTransactionForm(action.data);\n                break;\n               case 'view_transactions':\n                handlers.navigateToTransactions(action.data?.category);\n                break;\n               case 'add_funds':\n                if (action.data?.goalId) {\n                 // We need to find the goal data for add funds\n                 const goal = goals?.find(g => g.id === action.data.goalId);\n                 if (goal) {\n                  handlers.openAddFundsForm(\n                   goal.id,\n                   goal.title,\n                   goal.currentAmount,\n                   goal.targetAmount\n                  );\n                 }\n                }\n                break;\n               default:\n                break;\n              }\n             }}\n             data-testid={`button-action-${index}`}\n            >\n             <Zap size={12} className=\"mr-1\" />\n             {insight.action.label}\n            </Button>\n           )}\n          </div>\n         </div>\n        </Card>\n       ))\n      )}\n     </TabsContent>\n\n     <TabsContent value=\"warnings\" className=\"space-y-3\">\n      {warningInsights.map((insight, index) => (\n       <Card\n        key={index}\n        className=\"p-4 border-l-4 border-l-red-500 bg-red-50 dark:bg-red-900/10\"\n        data-testid={`warning-${index}`}\n       >\n        <div className=\"flex items-center gap-2 mb-2\">\n         <AlertTriangle className=\"text-red-500\" size={16} />\n         <h4 className=\"font-medium text-sm text-red-700 dark:text-red-300\">\n          {insight.title}\n         </h4>\n        </div>\n        <p className=\"text-sm text-red-600 dark:text-red-400 mb-3\">\n         {insight.description}\n        </p>\n        {insight.actionable && insight.action && (\n         <Button\n          size=\"sm\"\n          variant=\"outline\"\n          className=\"h-8 text-xs border-red-200 text-red-700 hover:bg-red-100\"\n          onClick={() => {\n           const action = insight.action;\n           if (!action) return;\n\n           switch (action.type) {\n            case 'create_goal':\n             handlers.openGoalForm(action.data);\n             break;\n            case 'add_transaction':\n             handlers.openTransactionForm(action.data);\n             break;\n            case 'view_transactions':\n             handlers.navigateToTransactions(action.data?.category);\n             break;\n            case 'add_funds':\n             if (action.data?.goalId) {\n              const goal = goals?.find(g => g.id === action.data.goalId);\n              if (goal) {\n               handlers.openAddFundsForm(\n                goal.id,\n                goal.title,\n                goal.currentAmount,\n                goal.targetAmount\n               );\n              }\n             }\n             break;\n            default:\n             break;\n           }\n          }}\n         >\n          {insight.action.label}\n         </Button>\n        )}\n       </Card>\n      ))}\n     </TabsContent>\n\n     <TabsContent value=\"suggestions\" className=\"space-y-3\">\n      {suggestionInsights.map((insight, index) => (\n       <Card\n        key={index}\n        className=\"p-4 border-l-4 border-l-yellow-500 bg-yellow-50 dark:bg-yellow-900/10\"\n        data-testid={`suggestion-${index}`}\n       >\n        <div className=\"flex items-center gap-2 mb-2\">\n         <Lightbulb className=\"text-yellow-500\" size={16} />\n         <h4 className=\"font-medium text-sm text-yellow-700 dark:text-yellow-300\">\n          {insight.title}\n         </h4>\n        </div>\n        <p className=\"text-sm text-yellow-600 dark:text-yellow-400 mb-3\">\n         {insight.description}\n        </p>\n        {insight.actionable && insight.action && (\n         <Button\n          size=\"sm\"\n          variant=\"outline\"\n          className=\"h-8 text-xs border-yellow-200 text-yellow-700 hover:bg-yellow-100\"\n          onClick={() => {\n           const action = insight.action;\n           if (!action) return;\n\n           switch (action.type) {\n            case 'create_goal':\n             handlers.openGoalForm(action.data);\n             break;\n            case 'add_transaction':\n             handlers.openTransactionForm(action.data);\n             break;\n            case 'view_transactions':\n             handlers.navigateToTransactions(action.data?.category);\n             break;\n            case 'add_funds':\n             if (action.data?.goalId) {\n              const goal = goals?.find(g => g.id === action.data.goalId);\n              if (goal) {\n               handlers.openAddFundsForm(\n                goal.id,\n                goal.title,\n                goal.currentAmount,\n                goal.targetAmount\n               );\n              }\n             }\n             break;\n            default:\n             break;\n           }\n          }}\n         >\n          {insight.action.label}\n         </Button>\n        )}\n       </Card>\n      ))}\n     </TabsContent>\n\n     <TabsContent value=\"achievements\" className=\"space-y-3\">\n      {achievementInsights.map((insight, index) => (\n       <Card\n        key={index}\n        className=\"p-4 border-l-4 border-l-green-500 bg-green-50 dark:bg-green-900/10\"\n        data-testid={`achievement-${index}`}\n       >\n        <div className=\"flex items-center gap-2 mb-2\">\n         <CheckCircle className=\"text-green-500\" size={16} />\n         <h4 className=\"font-medium text-sm text-green-700 dark:text-green-300\">\n          {insight.title}\n         </h4>\n        </div>\n        <p className=\"text-sm text-green-600 dark:text-green-400 mb-3\">\n         {insight.description}\n        </p>\n        {insight.actionable && insight.action && (\n         <Button\n          size=\"sm\"\n          variant=\"outline\"\n          className=\"h-8 text-xs border-green-200 text-green-700 hover:bg-green-100\"\n          onClick={() => {\n           const action = insight.action;\n           if (!action) return;\n\n           switch (action.type) {\n            case 'create_goal':\n             handlers.openGoalForm(action.data);\n             break;\n            case 'add_transaction':\n             handlers.openTransactionForm(action.data);\n             break;\n            case 'view_transactions':\n             handlers.navigateToTransactions(action.data?.category);\n             break;\n            case 'add_funds':\n             if (action.data?.goalId) {\n              const goal = goals?.find(g => g.id === action.data.goalId);\n              if (goal) {\n               handlers.openAddFundsForm(\n                goal.id,\n                goal.title,\n                goal.currentAmount,\n                goal.targetAmount\n               );\n              }\n             }\n             break;\n            default:\n             break;\n           }\n          }}\n         >\n          {insight.action.label}\n         </Button>\n        )}\n       </Card>\n      ))}\n     </TabsContent>\n    </Tabs>\n   </CardContent>\n  </Card>\n    )}\n  </NotificationActions>\n );\n}","path":null,"size_bytes":18647,"size_tokens":null},"client/src/components/dashboard/time-value-insights.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from\"@/components/ui/tabs\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ComposedChart, Line, LineChart, Area, AreaChart } from\"recharts\";\nimport { Clock, DollarSign, TrendingUp, Calendar, Target, BarChart3 } from\"lucide-react\";\nimport { ChartContainer } from\"@/components/ui/chart\";\nimport { useState } from\"react\";\n\nexport default function TimeValueInsights() {\n const [range, setRange] = useState<'7d' | '30d' | '90d'>('30d');\n \n const { data: insights, isLoading } = useQuery({\n  queryKey: [\"/api/insights/time-value\", range],\n  queryFn: () => fetch(`/api/insights/time-value?range=${range}`).then(res => res.json()),\n });\n\n const { data: timeStats } = useQuery({\n  queryKey: [\"/api/dashboard/time-stats\", range],\n  queryFn: () => fetch(`/api/dashboard/time-stats?range=${range}`).then(res => res.json()),\n });\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-1/3 mb-6\"></div>\n     <div className=\"space-y-4\">\n      <div className=\"h-64 bg-muted rounded\"></div>\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4\">\n       {[...Array(3)].map((_, i) => (\n        <div key={i} className=\"h-20 bg-muted rounded\"></div>\n       ))}\n      </div>\n     </div>\n    </div>\n   </Card>\n  );\n }\n\n const currency = timeStats?.currency || 'USD';\n const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency;\n\n // Generate sample data for time vs money visualization\n const chartData = insights?.topCategories?.map((category: any, index: number) => ({\n  category: category.category.length > 15 ? category.category.substring(0, 15) + '...' : category.category,\n  timeHours: category.timeHours,\n  value: category.value,\n  efficiency: category.timeHours > 0 ? (category.value / category.timeHours) : 0,\n })) || [];\n\n // Time distribution data for the area chart\n const timeDistribution = insights?.topCategories?.map((category: any) => ({\n  name: category.category.length > 10 ? category.category.substring(0, 10) + '...' : category.category,\n  hours: category.timeHours,\n  value: category.value,\n })) || [];\n\n const rangeLabels = {\n  '7d': 'Last 7 days',\n  '30d': 'Last 30 days',\n  '90d': 'Last 90 days',\n };\n\n return (\n  <Card className=\"shadow-sm hover-lift\">\n   <CardHeader className=\"pb-4\">\n    <div className=\"flex items-center justify-between\">\n     <div className=\"flex items-center gap-2\">\n      <div className=\"w-8 h-8 bg-primary rounded-lg flex items-center justify-center\">\n       <BarChart3 className=\"text-primary-foreground\" size={18} />\n      </div>\n      <CardTitle className=\"text-lg font-semibold\">\n       Time = Money Insights\n      </CardTitle>\n     </div>\n     <div className=\"flex items-center gap-2\">\n      {(['7d', '30d', '90d'] as const).map((r) => (\n       <Button\n        key={r}\n        variant={range === r ?\"default\" :\"outline\"}\n        size=\"sm\"\n        onClick={() => setRange(r)}\n        className=\"\"\n        data-testid={`button-range-${r}`}\n       >\n        {r}\n       </Button>\n      ))}\n     </div>\n    </div>\n    <p className=\"text-sm text-muted-foreground\">\n     {rangeLabels[range]} • Track how your time converts to value\n    </p>\n   </CardHeader>\n   \n   <CardContent className=\"p-6\">\n    <Tabs defaultValue=\"overview\" className=\"space-y-6\">\n     <TabsList className=\"grid w-full grid-cols-1 sm:grid-cols-3\">\n      <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n      <TabsTrigger value=\"efficiency\" data-testid=\"tab-efficiency\">Efficiency</TabsTrigger>\n      <TabsTrigger value=\"distribution\" data-testid=\"tab-distribution\">Distribution</TabsTrigger>\n     </TabsList>\n     \n     <TabsContent value=\"overview\" className=\"space-y-6\">\n      {/* Key Metrics Cards */}\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4\">\n       <div className=\"p-4 rounded-lg bg-white dark:bg-gray-900 border border-blue-200 dark:border-blue-800\">\n        <div className=\"flex items-center gap-2 mb-2\">\n         <Clock className=\"text-time\" size={16} />\n         <span className=\"text-sm font-medium text-time\">Total Time</span>\n        </div>\n        <p className=\"text-2xl font-bold time-format\" data-testid=\"metric-total-time\">\n         {Math.round(insights?.totalTimeHours || 0)}h\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n         {range === '7d' ? 'this week' : range === '30d' ? 'this month' : 'this quarter'}\n        </p>\n       </div>\n       \n       <div className=\"p-4 rounded-lg bg-white dark:bg-gray-900 border border-yellow-200 dark:border-yellow-800\">\n        <div className=\"flex items-center gap-2 mb-2\">\n         <DollarSign className=\"text-money\" size={16} />\n         <span className=\"text-sm font-medium text-money\">Time Value</span>\n        </div>\n        <p className=\"text-2xl font-bold currency-format\" data-testid=\"metric-time-value\">\n         {currencySymbol}{Math.round(insights?.timeValue || 0).toLocaleString()}\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n         @ {currencySymbol}{timeStats?.hourlyRate || 50}/hr\n        </p>\n       </div>\n       \n       <div className={`p-4 rounded-lg ${insights?.netImpact >= 0 ? 'bg-white dark:bg-gray-900 border border-green-200 dark:border-green-800' : 'bg-white dark:bg-gray-900 border border-red-200 dark:border-red-800'}`}>\n        <div className=\"flex items-center gap-2 mb-2\">\n         <TrendingUp className={insights?.netImpact >= 0 ?\"text-value-positive\" :\"text-value-negative\"} size={16} />\n         <span className={`text-sm font-medium ${insights?.netImpact >= 0 ?\"text-value-positive\" :\"text-value-negative\"}`}>\n          Net Impact\n         </span>\n        </div>\n        <p className={`text-2xl font-bold currency-format ${insights?.netImpact >= 0 ?\"text-value-positive\" :\"text-value-negative\"}`} data-testid=\"metric-net-impact\">\n         {currencySymbol}{Math.round(insights?.netImpact || 0).toLocaleString()}\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n         {insights?.netImpact >= 0 ?\"Positive ROI\" :\"Needs optimization\"}\n        </p>\n       </div>\n      </div>\n\n      {/* Time vs Value Chart */}\n      <div className=\"space-y-4\">\n       <h3 className=\"text-base font-semibold flex items-center gap-2\">\n        <Target size={16} className=\"text-primary\" />\n        Category Performance\n       </h3>\n       <div className=\"h-80 overflow-hidden\">\n        <ChartContainer config={{\n         timeHours: { label:\"Time Hours\", color:\"hsl(var(--time-primary))\" },\n         value: { label:\"Value\", color:\"hsl(var(--money-primary))\" }\n        }}>\n         <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <ComposedChart \n           data={chartData}\n           margin={{ top: 10, right: 30, left: 20, bottom: 65 }}\n          >\n           <CartesianGrid strokeDasharray=\"3 3\" className=\"opacity-30\" />\n           <XAxis \n            dataKey=\"category\" \n            fontSize={11}\n            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n            angle={-45}\n            textAnchor=\"end\"\n            height={80}\n           />\n           <YAxis \n            yAxisId=\"time\"\n            orientation=\"left\"\n            fontSize={12}\n            tick={{ fill: 'hsl(var(--time-primary))' }}\n           />\n           <YAxis \n            yAxisId=\"value\"\n            orientation=\"right\"\n            fontSize={12}\n            tick={{ fill: 'hsl(var(--money-primary))' }}\n           />\n           <Tooltip \n            content={({ active, payload, label }) => {\n             if (active && payload && payload.length) {\n              const hours = Number(payload[0]?.value || 0);\n              const value = Number(payload[1]?.value || 0);\n              const efficiency = hours > 0 ? value / hours : 0;\n              return (\n               <div className=\"bg-card border rounded-lg p-3 shadow-lg sm:min-w-[200px]\">\n                <p className=\"font-medium mb-2 truncate\">{label}</p>\n                <p className=\"text-sm text-time\">\n                 {hours.toFixed(1)}h tracked\n                </p>\n                <p className=\"text-sm text-money\">\n                 {currencySymbol}{Math.round(value).toLocaleString()} earned\n                </p>\n                <p className=\"text-sm text-muted-foreground\">\n                 Efficiency: {currencySymbol}{Math.round(efficiency)}/hr\n                </p>\n               </div>\n              );\n             }\n             return null;\n            }}\n           />\n           <Bar \n            yAxisId=\"time\"\n            dataKey=\"timeHours\" \n            fill=\"hsl(var(--time-primary))\" \n            radius={[2, 2, 0, 0]}\n            opacity={0.8}\n           />\n           <Bar \n            yAxisId=\"value\"\n            dataKey=\"value\" \n            fill=\"hsl(var(--money-primary))\" \n            radius={[2, 2, 0, 0]}\n            opacity={0.8}\n           />\n          </ComposedChart>\n         </ResponsiveContainer>\n        </ChartContainer>\n       </div>\n      </div>\n     </TabsContent>\n     \n     <TabsContent value=\"efficiency\" className=\"space-y-6\">\n      <div className=\"space-y-4\">\n       <h3 className=\"text-base font-semibold\">Hourly Rate by Category</h3>\n       <div className=\"h-80 overflow-hidden\">\n        <ChartContainer config={{\n         efficiency: { label:\"Efficiency\", color:\"hsl(var(--productivity-medium))\" }\n        }}>\n         <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <BarChart \n           data={chartData}\n           margin={{ top: 10, right: 20, left: 20, bottom: 65 }}\n          >\n           <CartesianGrid strokeDasharray=\"3 3\" className=\"opacity-30\" />\n           <XAxis \n            dataKey=\"category\" \n            fontSize={11}\n            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n            angle={-45}\n            textAnchor=\"end\"\n            height={80}\n           />\n           <YAxis \n            fontSize={12}\n            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n           />\n           <Tooltip \n            content={({ active, payload, label }) => {\n             if (active && payload && payload.length) {\n              return (\n               <div className=\"bg-card border rounded-lg p-3 shadow-lg\">\n                <p className=\"font-medium mb-2\">{label}</p>\n                <p className=\"text-sm\">\n                 Efficiency: {currencySymbol}{Math.round(Number(payload[0]?.value || 0))}/hr\n                </p>\n               </div>\n              );\n             }\n             return null;\n            }}\n           />\n           <Bar \n            dataKey=\"efficiency\" \n            fill=\"hsl(var(--productivity-medium))\" \n            radius={[4, 4, 0, 0]}\n           />\n          </BarChart>\n         </ResponsiveContainer>\n        </ChartContainer>\n       </div>\n      </div>\n     </TabsContent>\n     \n     <TabsContent value=\"distribution\" className=\"space-y-6\">\n      <div className=\"space-y-4\">\n       <h3 className=\"text-base font-semibold\">Time Distribution</h3>\n       <div className=\"h-80 overflow-hidden\">\n        <ChartContainer config={{\n         hours: { label:\"Hours\", color:\"hsl(var(--time-primary))\" }\n        }}>\n         <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <AreaChart \n           data={timeDistribution}\n           margin={{ top: 10, right: 20, left: 20, bottom: 65 }}\n          >\n           <CartesianGrid strokeDasharray=\"3 3\" className=\"opacity-30\" />\n           <XAxis \n            dataKey=\"name\" \n            fontSize={11}\n            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n            angle={-45}\n            textAnchor=\"end\"\n            height={80}\n           />\n           <YAxis \n            fontSize={12}\n            tick={{ fill: 'hsl(var(--muted-foreground))' }}\n           />\n           <Tooltip \n            content={({ active, payload, label }) => {\n             if (active && payload && payload.length) {\n              const hours = Number(payload[0]?.value || 0);\n              const percentage = Math.round((hours / (insights?.totalTimeHours || 1)) * 100);\n              const value = Number(payload[1]?.value || 0);\n              return (\n               <div className=\"bg-card border rounded-lg p-3 shadow-lg sm:min-w-[200px]\">\n                <p className=\"font-medium mb-2 truncate\">{label}</p>\n                <p className=\"text-sm text-time\">\n                 {hours.toFixed(1)}h ({percentage}%)\n                </p>\n                <p className=\"text-sm text-money\">\n                 {currencySymbol}{Math.round(value).toLocaleString()}\n                </p>\n               </div>\n              );\n             }\n             return null;\n            }}\n           />\n           <Area \n            dataKey=\"hours\" \n            fill=\"hsl(var(--time-primary))\" \n            stroke=\"hsl(var(--time-primary))\"\n            fillOpacity={0.6}\n           />\n          </AreaChart>\n         </ResponsiveContainer>\n        </ChartContainer>\n       </div>\n      </div>\n     </TabsContent>\n    </Tabs>\n\n    {/* Upcoming High-Impact Events */}\n    {insights?.upcomingHighImpact && insights.upcomingHighImpact.length > 0 && (\n     <div className=\"mt-6 pt-6 border-t border-border\">\n      <h3 className=\"text-base font-semibold mb-4 flex items-center gap-2\">\n       <Calendar size={16} className=\"text-primary\" />\n       High-Impact Events Coming Up\n      </h3>\n      <div className=\"space-y-2\">\n       {insights.upcomingHighImpact.slice(0, 3).map((event: any, index: number) => (\n        <div key={event.eventId} className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50 hover:bg-muted/70 transition-colors\">\n         <div>\n          <p className=\"font-medium text-sm\" data-testid={`upcoming-event-${index}`}>\n           {event.title}\n          </p>\n          <p className=\"text-xs text-muted-foreground\">\n           Estimated value: {currencySymbol}{Math.round(event.estimatedValue).toLocaleString()}\n          </p>\n         </div>\n         <div className=\"value-badge-positive\">\n          High ROI\n         </div>\n        </div>\n       ))}\n      </div>\n     </div>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":14315,"size_tokens":null},"client/src/components/goals/smart-goal-insights.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { \n Lightbulb, \n TrendingUp, \n Target, \n AlertTriangle, \n Award,\n Zap,\n Brain,\n Calendar,\n DollarSign,\n PieChart,\n Clock,\n CheckCircle\n} from\"lucide-react\";\nimport { differenceInDays, differenceInMonths, addMonths } from\"date-fns\";\nimport { useQuery } from\"@tanstack/react-query\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface Goal {\n id: string;\n title: string;\n description?: string;\n targetAmount: string;\n currentAmount: string;\n targetDate: string;\n category?: string;\n priority: string;\n status: string;\n createdAt?: string;\n}\n\ninterface Transaction {\n id: string;\n amount: string;\n type: string;\n category?: string;\n date: string;\n goalId?: string;\n}\n\ninterface SmartGoalInsightsProps {\n goals: Goal[];\n onActionClick?: (action: string, goalId?: string) => void;\n}\n\nexport default function SmartGoalInsights({ goals, onActionClick }: SmartGoalInsightsProps) {\n const { formatAmount } = useUserCurrency();\n \n // Fetch transaction data for analysis\n const { data: transactions } = useQuery({\n  queryKey: [\"/api/transactions\"],\n  queryFn: () => fetch(\"/api/transactions\").then(res => res.json()),\n });\n\n const activeGoals = goals.filter(goal => goal.status === 'active');\n const completedGoals = goals.filter(goal => goal.status === 'completed');\n \n // Calculate insights\n const generateInsights = () => {\n  const insights: Array<{\n   id: string;\n   type: 'success' | 'warning' | 'info' | 'achievement';\n   icon: any;\n   title: string;\n   description: string;\n   action?: string;\n   goalId?: string;\n   priority: number;\n  }> = [];\n\n  // Achievement insights\n  if (completedGoals.length > 0) {\n   insights.push({\n    id: 'completion-celebration',\n    type: 'achievement',\n    icon: Award,\n    title: `${completedGoals.length} Goal${completedGoals.length > 1 ? 's' : ''} Completed!`,\n    description: `You've successfully completed ${completedGoals.length} financial goal${completedGoals.length > 1 ? 's' : ''}. Your dedication is paying off!`,\n    priority: 1\n   });\n  }\n\n  // Goals needing attention\n  const riskyGoals = activeGoals.filter(goal => {\n   const daysRemaining = differenceInDays(new Date(goal.targetDate), new Date());\n   const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n   const monthsRemaining = daysRemaining / 30;\n   const requiredMonthlyRate = monthsRemaining > 0 \n    ? (parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount)) / monthsRemaining\n    : Infinity;\n   \n   return daysRemaining < 60 && progress < 80 && requiredMonthlyRate > 1000;\n  });\n\n  if (riskyGoals.length > 0) {\n   insights.push({\n    id: 'goals-need-attention',\n    type: 'warning',\n    icon: AlertTriangle,\n    title: 'Goals Need Attention',\n    description: `${riskyGoals.length} goal${riskyGoals.length > 1 ? 's are' : ' is'} at risk of missing target dates. Consider adjusting timelines or increasing contributions.`,\n    action: 'review-timeline',\n    goalId: riskyGoals[0].id,\n    priority: 2\n   });\n  }\n\n  // High-performing goals\n  const excellentGoals = activeGoals.filter(goal => {\n   const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n   const daysRemaining = differenceInDays(new Date(goal.targetDate), new Date());\n   const expectedProgress = goal.createdAt \n    ? (1 - (daysRemaining / differenceInDays(new Date(goal.targetDate), new Date(goal.createdAt)))) * 100\n    : 0;\n   \n   return progress > expectedProgress + 20 && progress >= 30;\n  });\n\n  if (excellentGoals.length > 0) {\n   insights.push({\n    id: 'excellent-progress',\n    type: 'success',\n    icon: TrendingUp,\n    title: 'Excellent Progress!',\n    description: `You're ahead of schedule on ${excellentGoals.length} goal${excellentGoals.length > 1 ? 's' : ''}. Keep up the great work!`,\n    priority: 3\n   });\n  }\n\n  // Savings potential analysis\n  if (transactions && transactions.length > 0) {\n   const monthlyIncome = transactions\n    .filter((t: Transaction) => t.type === 'income' && new Date(t.date) >= addMonths(new Date(), -1))\n    .reduce((sum: number, t: Transaction) => sum + parseFloat(t.amount), 0);\n   \n   const monthlyExpenses = transactions\n    .filter((t: Transaction) => t.type === 'expense' && new Date(t.date) >= addMonths(new Date(), -1))\n    .reduce((sum: number, t: Transaction) => sum + parseFloat(t.amount), 0);\n   \n   const potentialSavings = monthlyIncome - monthlyExpenses;\n   \n   if (potentialSavings > 500 && activeGoals.length > 0) {\n    insights.push({\n     id: 'savings-opportunity',\n     type: 'info',\n     icon: DollarSign,\n     title: 'Savings Opportunity Identified',\n     description: `Based on your income patterns, you could potentially save an additional ${formatAmount(potentialSavings)} monthly towards your goals.`,\n     action: 'optimize-budget',\n     priority: 4\n    });\n   }\n  }\n\n  // Goal diversification insight\n  const categories = new Set(activeGoals.map(goal => goal.category).filter(Boolean));\n  if (activeGoals.length >= 3 && categories.size === 1) {\n   insights.push({\n    id: 'diversify-goals',\n    type: 'info',\n    icon: PieChart,\n    title: 'Consider Goal Diversification',\n    description: 'All your goals are in the same category. Consider diversifying across emergency funds, investments, and lifestyle goals.',\n    action: 'diversify-portfolio',\n    priority: 5\n   });\n  }\n\n  // Time-based insights\n  const shortTermGoals = activeGoals.filter(goal => \n   differenceInMonths(new Date(goal.targetDate), new Date()) <= 12\n  );\n  const longTermGoals = activeGoals.filter(goal => \n   differenceInMonths(new Date(goal.targetDate), new Date()) > 12\n  );\n\n  if (shortTermGoals.length === 0 && longTermGoals.length > 0) {\n   insights.push({\n    id: 'need-short-term-goals',\n    type: 'info',\n    icon: Clock,\n    title: 'Consider Short-term Goals',\n    description: 'Having some short-term goals (under 1 year) can help maintain motivation and create quick wins.',\n    action: 'create-short-term',\n    priority: 6\n   });\n  }\n\n  // Momentum insights\n  const goalContributions = transactions?.filter((t: Transaction) => \n   t.goalId && activeGoals.some(g => g.id === t.goalId)\n  ) || [];\n  \n  const recentContributions = goalContributions.filter((t: Transaction) => \n   differenceInDays(new Date(), new Date(t.date)) <= 7\n  );\n\n  if (recentContributions.length === 0 && activeGoals.length > 0) {\n   insights.push({\n    id: 'maintain-momentum',\n    type: 'info',\n    icon: Zap,\n    title: 'Maintain Your Momentum',\n    description: 'No contributions to goals this week. Small, consistent contributions lead to big results!',\n    action: 'quick-contribute',\n    priority: 7\n   });\n  }\n\n  return insights.sort((a, b) => a.priority - b.priority);\n };\n\n const insights = generateInsights();\n\n const getInsightColor = (type: string) => {\n  switch (type) {\n   case 'success': return 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950/20';\n   case 'warning': return 'border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-950/20';\n   case 'achievement': return 'border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950/20';\n   default: return 'border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950/20';\n  }\n };\n\n const getIconColor = (type: string) => {\n  switch (type) {\n   case 'success': return 'text-green-600';\n   case 'warning': return 'text-yellow-600';\n   case 'achievement': return 'text-blue-600';\n   default: return 'text-blue-600';\n  }\n };\n\n if (insights.length === 0) {\n  return (\n   <Card>\n    <CardHeader>\n     <CardTitle className=\"flex items-center\">\n      <Brain className=\"mr-2 h-5 w-5\" />\n      Smart Insights\n     </CardTitle>\n    </CardHeader>\n    <CardContent>\n     <div className=\"text-center py-8\">\n      <Lightbulb className=\"mx-auto h-12 w-12 text-muted-foreground mb-4\" />\n      <h3 className=\"text-lg font-medium mb-2\">Building Your Profile</h3>\n      <p className=\"text-muted-foreground\">\n       Create some goals and start saving to unlock personalized insights and recommendations.\n      </p>\n     </div>\n    </CardContent>\n   </Card>\n  );\n }\n\n return (\n  <Card>\n   <CardHeader>\n    <CardTitle className=\"flex items-center\">\n     <Brain className=\"mr-2 h-5 w-5\" />\n     Smart Insights\n    </CardTitle>\n   </CardHeader>\n   <CardContent>\n    <div className=\"space-y-4\">\n     {insights.slice(0, 5).map((insight) => (\n      <div \n       key={insight.id}\n       className={`p-4 rounded-lg border ${getInsightColor(insight.type)}`}\n       data-testid={`insight-${insight.id}`}\n      >\n       <div className=\"flex items-start justify-between\">\n        <div className=\"flex items-start space-x-3 flex-1\">\n         <insight.icon className={`h-5 w-5 mt-0.5 ${getIconColor(insight.type)}`} />\n         <div className=\"flex-1\">\n          <h4 className=\"font-medium mb-1\">{insight.title}</h4>\n          <p className=\"text-sm text-muted-foreground\">{insight.description}</p>\n         </div>\n        </div>\n        {insight.action && (\n         <Button \n          size=\"sm\" \n          variant=\"outline\"\n          onClick={() => onActionClick?.(insight.action!, insight.goalId)}\n          data-testid={`button-insight-action-${insight.id}`}\n          className=\"ml-4 shrink-0\"\n         >\n          Take Action\n         </Button>\n        )}\n       </div>\n      </div>\n     ))}\n     \n     {insights.length > 5 && (\n      <div className=\"text-center pt-2\">\n       <Button variant=\"ghost\" size=\"sm\" className=\"text-muted-foreground\">\n        View {insights.length - 5} More Insights\n       </Button>\n      </div>\n     )}\n    </div>\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":9726,"size_tokens":null},"client/src/pages/upgrade.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Elements } from \"@stripe/react-stripe-js\";\nimport { loadStripe } from \"@stripe/stripe-js\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Check, Zap, Crown, ArrowLeft, Loader2, Sparkles } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport PaymentForm from \"@/components/payment-form\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\nconst stripePromise = import.meta.env.VITE_STRIPE_PUBLIC_KEY \n  ? loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY)\n  : null;\n\nexport default function UpgradePage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [selectedPlan, setSelectedPlan] = useState<string | null>(null);\n  const [clientSecret, setClientSecret] = useState<string | null>(null);\n  const [paymentMode, setPaymentMode] = useState<'upgrade' | 'payment'>('upgrade');\n  const { formatAmount, convertFromUSD } = useUserCurrency();\n\n  const { data: plans = [], isLoading: plansLoading } = useQuery({\n    queryKey: ['/api/subscription/plans'],\n  }) as { data: any[], isLoading: boolean };\n\n  const { data: currentData } = useQuery({\n    queryKey: ['/api/subscription/current'],\n  });\n\n  const upgradeMutation = useMutation({\n    mutationFn: async (planId: string) => {\n      const response = await apiRequest(\"POST\", \"/api/subscription/upgrade\", { planId });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data.requiresPayment) {\n        if (!stripePromise) {\n          toast({\n            title: \"Payment Not Available\",\n            description: \"Payment processing is being set up. Please try again later or contact support.\",\n            variant: \"destructive\",\n          });\n          return;\n        }\n        toast({\n          title: \"Payment Required\",\n          description: \"Redirecting to payment...\",\n        });\n        paymentMutation.mutate(selectedPlan!);\n      } else {\n        toast({\n          title: \"Plan Updated\",\n          description: `You're now on ${data.subscription?.plan?.displayName}`,\n        });\n        queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n        queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n        setLocation('/subscription');\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Upgrade Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const paymentMutation = useMutation({\n    mutationFn: async (planId: string) => {\n      const response = await apiRequest(\"POST\", \"/api/subscription/create-payment-intent\", { planId });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data.requiresSetup) {\n        toast({\n          title: \"Payment Setup Required\",\n          description: \"Payment processing is not configured. Contact support.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setClientSecret(data.clientSecret);\n      setPaymentMode('payment');\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Payment Setup Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleUpgrade = (planId: string) => {\n    setSelectedPlan(planId);\n    const plan = plans.find((p: any) => p.id === planId);\n    \n    if (plan?.name === 'free' || parseFloat(plan?.priceUsd || '0') === 0) {\n      upgradeMutation.mutate(planId);\n    } else {\n      if (stripePromise) {\n        paymentMutation.mutate(planId);\n      } else {\n        toast({\n          title: \"Payment Not Available\",\n          description: \"Payment processing is being set up. Please try again later or contact support.\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  };\n\n  const getPlanIcon = (planName: string) => {\n    switch (planName) {\n      case 'free': return <Sparkles className=\"w-5 h-5\" />;\n      case 'pro': return <Crown className=\"w-5 h-5\" />;\n      case 'enterprise': return <Zap className=\"w-5 h-5\" />;\n      default: return <Sparkles className=\"w-5 h-5\" />;\n    }\n  };\n\n  const formatPrice = (priceUsd: string | undefined, billingInterval: string) => {\n    const price = parseFloat(priceUsd || \"0\");\n    if (isNaN(price) || price === 0) return { amount: formatAmount(0), period: \"forever\" };\n    return { \n      amount: formatAmount(convertFromUSD(price)), \n      period: `/${billingInterval === \"monthly\" ? \"mo\" : billingInterval}` \n    };\n  };\n\n  const isCurrentPlan = (planId: string) => {\n    return (currentData as any)?.subscription?.planId === planId;\n  };\n\n  const getPlanFeatures = (plan: any) => {\n    const features: string[] = [];\n    \n    if (plan.name === \"free\") {\n      features.push(\"50 Scout AI queries/month\");\n      features.push(\"Basic financial tracking\");\n      features.push(\"Up to 3 financial goals\");\n      features.push(\"30-day transaction history\");\n    } else if (plan.name === \"pro\") {\n      features.push(\"Unlimited Scout AI queries\");\n      features.push(\"25 Sonnet reasoning queries/month\");\n      features.push(\"5 GPT-5 math queries/month\");\n      features.push(\"Unlimited goals & history\");\n      features.push(\"Crypto portfolio tracking\");\n      features.push(\"Advanced analytics\");\n    } else if (plan.name === \"enterprise\") {\n      features.push(\"Everything in Pro, plus:\");\n      features.push(\"60 Sonnet reasoning/month\");\n      features.push(\"10 GPT-5 math/month\");\n      features.push(\"20 Opus CFO queries/month\");\n      features.push(\"Team collaboration\");\n      features.push(\"API access\");\n    }\n    \n    return features;\n  };\n\n  const sortedPlans = [...plans].sort((a: any, b: any) => {\n    const order: Record<string, number> = { free: 0, pro: 1, enterprise: 2 };\n    return (order[a.name] || 0) - (order[b.name] || 0);\n  });\n\n  if (paymentMode === 'payment' && clientSecret && stripePromise) {\n    return (\n      <div className=\"min-h-screen bg-white dark:bg-black\">\n        <div className=\"max-w-md mx-auto px-6 py-12\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => {\n              setPaymentMode('upgrade');\n              setClientSecret(null);\n            }}\n            className=\"mb-8\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to plans\n          </Button>\n\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-2xl font-bold text-black dark:text-white mb-2\">\n              Complete Payment\n            </h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">\n              Secure payment powered by Stripe\n            </p>\n          </div>\n\n          <Card className=\"border border-gray-200 dark:border-gray-800\">\n            <CardContent className=\"p-6\">\n              <Elements\n                stripe={stripePromise}\n                options={{\n                  clientSecret,\n                  appearance: {\n                    theme: 'stripe',\n                    variables: {\n                      colorPrimary: '#000000',\n                      colorBackground: '#ffffff',\n                      colorText: '#000000',\n                      fontFamily: '\"Inter\", system-ui, sans-serif',\n                      borderRadius: '8px',\n                    },\n                  },\n                }}\n              >\n                <PaymentForm \n                  onSuccess={() => {\n                    toast({\n                      title: \"Payment Successful\",\n                      description: \"Your subscription has been upgraded.\",\n                    });\n                    queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n                    queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n                    setLocation('/subscription');\n                  }}\n                  onError={(error: string) => {\n                    toast({\n                      title: \"Payment Failed\",\n                      description: error,\n                      variant: \"destructive\",\n                    });\n                  }}\n                />\n              </Elements>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-black\">\n      <div className=\"absolute inset-0 bg-gradient-to-b from-gray-50 to-white dark:from-gray-950 dark:to-black\" />\n      \n      <div className=\"relative\">\n        <header className=\"max-w-6xl mx-auto px-6 py-6\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation('/subscription')}\n            className=\"text-gray-600 dark:text-gray-400 hover:text-black dark:hover:text-white\"\n            data-testid=\"button-back-subscription\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to subscription\n          </Button>\n        </header>\n\n        <div className=\"max-w-6xl mx-auto px-6 pb-20\">\n          <div className=\"text-center mb-12\">\n            <Badge \n              variant=\"outline\" \n              className=\"mb-6 px-4 py-1.5 text-sm font-medium border-gray-200 dark:border-gray-800\"\n            >\n              Upgrade\n            </Badge>\n            <h1 className=\"text-4xl sm:text-5xl font-bold tracking-tight text-black dark:text-white mb-4\">\n              Choose your plan\n            </h1>\n            <p className=\"text-lg text-gray-600 dark:text-gray-400 max-w-xl mx-auto\">\n              Unlock AI-powered financial insights and advanced features\n            </p>\n          </div>\n\n          {plansLoading ? (\n            <div className=\"grid md:grid-cols-3 gap-8 max-w-5xl mx-auto\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-[450px] bg-gray-100 dark:bg-gray-900 rounded-2xl animate-pulse\" />\n              ))}\n            </div>\n          ) : (\n            <div className=\"grid md:grid-cols-3 gap-8 max-w-5xl mx-auto\">\n              {sortedPlans.map((plan: any) => {\n                const isPro = plan.name === 'pro';\n                const isEnterprise = plan.name === 'enterprise';\n                const isCurrent = isCurrentPlan(plan.id);\n                const { amount, period } = formatPrice(plan.priceUsd, plan.billingInterval);\n                const features = getPlanFeatures(plan);\n\n                return (\n                  <div\n                    key={plan.id}\n                    className={`relative rounded-2xl p-8 ${\n                      isPro\n                        ? \"border-2 border-black dark:border-white bg-gray-50 dark:bg-gray-950\"\n                        : \"border border-gray-200 dark:border-gray-800\"\n                    } ${isCurrent ? \"ring-2 ring-green-500\" : \"\"}`}\n                    data-testid={`card-plan-${plan.name.toLowerCase()}`}\n                  >\n                    {isPro && (\n                      <Badge className=\"absolute -top-3 left-1/2 -translate-x-1/2 bg-black dark:bg-white text-white dark:text-black px-4 py-1 text-xs font-medium\">\n                        Most Popular\n                      </Badge>\n                    )}\n                    {isEnterprise && (\n                      <Badge className=\"absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-amber-500 to-yellow-600 text-white px-4 py-1 text-xs font-medium\">\n                        Best for Teams\n                      </Badge>\n                    )}\n                    {isCurrent && (\n                      <Badge className=\"absolute -top-3 right-4 bg-green-500 text-white px-3 py-1 text-xs font-medium\">\n                        Current\n                      </Badge>\n                    )}\n\n                    <div className=\"mb-6\">\n                      <div className=\"flex items-center gap-2 mb-4\">\n                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${\n                          isPro \n                            ? \"bg-blue-100 dark:bg-blue-950 text-blue-600 dark:text-blue-400\"\n                            : isEnterprise\n                            ? \"bg-amber-100 dark:bg-amber-950 text-amber-600 dark:text-amber-400\"\n                            : \"bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400\"\n                        }`}>\n                          {getPlanIcon(plan.name)}\n                        </div>\n                        <h2 className=\"text-xl font-semibold text-black dark:text-white\">\n                          {plan.displayName}\n                        </h2>\n                      </div>\n\n                      <div className=\"flex items-baseline gap-1 mb-6\">\n                        <span className=\"text-4xl font-bold text-black dark:text-white\">\n                          {amount}\n                        </span>\n                        <span className=\"text-gray-500\">{period}</span>\n                      </div>\n\n                      <Button\n                        className={`w-full h-12 font-medium rounded-xl ${\n                          isPro\n                            ? \"bg-black dark:bg-white text-white dark:text-black hover:bg-gray-800 dark:hover:bg-gray-200\"\n                            : \"bg-gray-100 dark:bg-gray-900 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-800\"\n                        }`}\n                        onClick={() => handleUpgrade(plan.id)}\n                        disabled={isCurrent || upgradeMutation.isPending || paymentMutation.isPending}\n                        data-testid={`button-upgrade-${plan.name.toLowerCase()}`}\n                      >\n                        {(upgradeMutation.isPending || paymentMutation.isPending) && selectedPlan === plan.id ? (\n                          <>\n                            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                            Processing...\n                          </>\n                        ) : isCurrent ? (\n                          \"Current plan\"\n                        ) : parseFloat(plan.priceUsd) === 0 ? (\n                          \"Get started\"\n                        ) : (\n                          `Upgrade to ${plan.name}`\n                        )}\n                      </Button>\n                    </div>\n\n                    <div className=\"space-y-3\">\n                      {features.map((feature, index) => (\n                        <div key={index} className=\"flex items-start gap-3\">\n                          <Check className=\"w-4 h-4 text-black dark:text-white flex-shrink-0 mt-0.5\" />\n                          <span className=\"text-sm text-gray-600 dark:text-gray-400\">\n                            {feature}\n                          </span>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n\n          <div className=\"text-center mt-12\">\n            <p className=\"text-sm text-gray-500\">\n              Secure payments powered by Stripe. Cancel anytime.\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15348,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from\"react\"\n\nimport type {\n ToastActionElement,\n ToastProps,\n} from\"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 3\nconst TOAST_REMOVE_DELAY = 5000\n\ntype ToasterToast = ToastProps & {\n id: string\n title?: React.ReactNode\n description?: React.ReactNode\n action?: ToastActionElement\n icon?: React.ReactNode\n}\n\nconst actionTypes = {\n ADD_TOAST:\"ADD_TOAST\",\n UPDATE_TOAST:\"UPDATE_TOAST\",\n DISMISS_TOAST:\"DISMISS_TOAST\",\n REMOVE_TOAST:\"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n count = (count + 1) % Number.MAX_SAFE_INTEGER\n return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n | {\n   type: ActionType[\"ADD_TOAST\"]\n   toast: ToasterToast\n  }\n | {\n   type: ActionType[\"UPDATE_TOAST\"]\n   toast: Partial<ToasterToast>\n  }\n | {\n   type: ActionType[\"DISMISS_TOAST\"]\n   toastId?: ToasterToast[\"id\"]\n  }\n | {\n   type: ActionType[\"REMOVE_TOAST\"]\n   toastId?: ToasterToast[\"id\"]\n  }\n\ninterface State {\n toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n if (toastTimeouts.has(toastId)) {\n  return\n }\n\n const timeout = setTimeout(() => {\n  toastTimeouts.delete(toastId)\n  dispatch({\n   type:\"REMOVE_TOAST\",\n   toastId: toastId,\n  })\n }, TOAST_REMOVE_DELAY)\n\n toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n switch (action.type) {\n  case\"ADD_TOAST\":\n   return {\n    ...state,\n    toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n   }\n\n  case\"UPDATE_TOAST\":\n   return {\n    ...state,\n    toasts: state.toasts.map((t) =>\n     t.id === action.toast.id ? { ...t, ...action.toast } : t\n    ),\n   }\n\n  case\"DISMISS_TOAST\": {\n   const { toastId } = action\n\n   // ! Side effects ! - This could be extracted into a dismissToast() action,\n   // but I'll keep it here for simplicity\n   if (toastId) {\n    addToRemoveQueue(toastId)\n   } else {\n    state.toasts.forEach((toast) => {\n     addToRemoveQueue(toast.id)\n    })\n   }\n\n   return {\n    ...state,\n    toasts: state.toasts.map((t) =>\n     t.id === toastId || toastId === undefined\n      ? {\n        ...t,\n        open: false,\n       }\n      : t\n    ),\n   }\n  }\n  case\"REMOVE_TOAST\":\n   if (action.toastId === undefined) {\n    return {\n     ...state,\n     toasts: [],\n    }\n   }\n   return {\n    ...state,\n    toasts: state.toasts.filter((t) => t.id !== action.toastId),\n   }\n }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n memoryState = reducer(memoryState, action)\n listeners.forEach((listener) => {\n  listener(memoryState)\n })\n}\n\ntype Toast = Omit<ToasterToast,\"id\">\n\nfunction toast({ ...props }: Toast) {\n const id = genId()\n\n const update = (props: ToasterToast) =>\n  dispatch({\n   type:\"UPDATE_TOAST\",\n   toast: { ...props, id },\n  })\n const dismiss = () => dispatch({ type:\"DISMISS_TOAST\", toastId: id })\n\n dispatch({\n  type:\"ADD_TOAST\",\n  toast: {\n   ...props,\n   id,\n   open: true,\n   onOpenChange: (open) => {\n    if (!open) dismiss()\n   },\n  },\n })\n\n return {\n  id: id,\n  dismiss,\n  update,\n }\n}\n\nfunction useToast() {\n const [state, setState] = React.useState<State>(memoryState)\n\n React.useEffect(() => {\n  listeners.push(setState)\n  return () => {\n   const index = listeners.indexOf(setState)\n   if (index > -1) {\n    listeners.splice(index, 1)\n   }\n  }\n }, [state])\n\n return {\n  ...state,\n  toast,\n  dismiss: (toastId?: string) => dispatch({ type:\"DISMISS_TOAST\", toastId }),\n }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3569,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from\"react\"\nimport { Slot } from\"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst buttonVariants = cva(\n\"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium transition-all duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 active:scale-[0.98] [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n {\n  variants: {\n   variant: {\n    default:\"bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm hover:shadow active:shadow-none\",\n    destructive:\n    \"bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-sm hover:shadow active:shadow-none\",\n    outline:\n    \"border border-input bg-background hover:bg-accent hover:text-accent-foreground hover:border-accent\",\n    secondary:\n    \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n    ghost:\"hover:bg-accent hover:text-accent-foreground\",\n    link:\"text-primary underline-offset-4 hover:underline\",\n   },\n   size: {\n    default:\"h-11 min-h-[44px] px-4 py-2\",\n    sm:\"h-11 min-h-[44px] rounded-lg px-3 text-xs\",\n    lg:\"h-12 min-h-[48px] rounded-lg px-6 text-base\",\n    icon:\"h-11 w-11 min-h-[44px] min-w-[44px]\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n   size:\"default\",\n  },\n }\n)\n\nexport interface ButtonProps\n extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n  VariantProps<typeof buttonVariants> {\n asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n ({ className, variant, size, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot :\"button\"\n  return (\n   <Comp\n    className={cn(buttonVariants({ variant, size, className }))}\n    ref={ref}\n    {...props}\n   />\n  )\n }\n)\nButton.displayName =\"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1963,"size_tokens":null},"client/src/components/forms/group-form.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useUser } from \"@/lib/userContext\";\nimport { Home, Car, PiggyBank, Target } from \"lucide-react\";\n\nconst groupFormSchema = z.object({\n  name: z.string().min(1, \"Group name is required\"),\n  description: z.string().optional(),\n  category: z.enum([\"house\", \"car\", \"savings\", \"other\"]).default(\"other\"),\n  budget: z.preprocess(\n    (val) => (val === \"\" || val === undefined || val === null) ? undefined : String(val),\n    z.string().optional()\n  ),\n  color: z.string().default(\"#3B82F6\"),\n  status: z.enum([\"active\", \"planning\", \"archived\"]).default(\"active\"),\n});\n\ntype GroupFormData = z.infer<typeof groupFormSchema>;\n\ninterface GroupFormProps {\n  onSuccess?: () => void;\n}\n\nexport default function GroupForm({ onSuccess }: GroupFormProps) {\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { user, isLoading: userLoading } = useUser();\n\n  const {\n    register,\n    handleSubmit,\n    setValue,\n    watch,\n    formState: { errors },\n  } = useForm<GroupFormData>({\n    resolver: zodResolver(groupFormSchema),\n    defaultValues: {\n      category: \"other\",\n      color: \"#3B82F6\",\n      status: \"active\",\n    },\n  });\n\n  const createGroupMutation = useMutation({\n    mutationFn: (data: GroupFormData) => \n      apiRequest(\"POST\", \"/api/groups\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/groups\"] });\n      toast({\n        title: \"Group created\",\n        description: \"Your shared goal group has been created successfully.\",\n      });\n      onSuccess?.();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n    onSettled: () => {\n      setIsSubmitting(false);\n    },\n  });\n\n  const onSubmit = (data: GroupFormData) => {\n    if (!user) {\n      toast({\n        title: \"Error\",\n        description: \"You must be logged in to create a group.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setIsSubmitting(true);\n    createGroupMutation.mutate(data);\n  };\n\n  const categoryOptions = [\n    { value: \"house\", label: \"House / Property\", icon: Home, description: \"Down payment, renovation\" },\n    { value: \"car\", label: \"Vehicle\", icon: Car, description: \"Car, motorcycle, boat\" },\n    { value: \"savings\", label: \"Group Savings\", icon: PiggyBank, description: \"Vacation, event, gift\" },\n    { value: \"other\", label: \"Other Goal\", icon: Target, description: \"Custom shared goal\" },\n  ];\n\n  const watchCategory = watch(\"category\");\n\n  return (\n    <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4 pt-2\">\n      <div>\n        <Label htmlFor=\"name\">Group Name</Label>\n        <Input\n          id=\"name\"\n          {...register(\"name\")}\n          placeholder=\"e.g., Beach House Fund, Tesla Model 3\"\n          className=\"h-11\"\n          data-testid=\"input-group-name\"\n        />\n        {errors.name && (\n          <p className=\"text-sm text-destructive mt-1\">{errors.name.message}</p>\n        )}\n      </div>\n\n      <div>\n        <Label>Goal Category</Label>\n        <div className=\"grid grid-cols-2 gap-2 mt-1.5\">\n          {categoryOptions.map((option) => {\n            const Icon = option.icon;\n            const isSelected = watchCategory === option.value;\n            return (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => setValue(\"category\", option.value as any)}\n                className={`p-3 rounded-lg border text-left transition-all ${\n                  isSelected \n                    ? \"border-primary bg-primary/5 ring-1 ring-primary\" \n                    : \"border-border hover:border-primary/50\"\n                }`}\n                data-testid={`button-category-${option.value}`}\n              >\n                <div className=\"flex items-center gap-2\">\n                  <Icon className={`w-4 h-4 ${isSelected ? \"text-primary\" : \"text-muted-foreground\"}`} />\n                  <span className=\"text-sm font-medium\">{option.label}</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-0.5\">{option.description}</p>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n\n      <div>\n        <Label htmlFor=\"budget\">Target Amount (Optional)</Label>\n        <div className=\"relative\">\n          <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">$</span>\n          <Input\n            id=\"budget\"\n            type=\"number\"\n            {...register(\"budget\")}\n            placeholder=\"0.00\"\n            className=\"h-11 pl-7\"\n            data-testid=\"input-group-budget\"\n          />\n        </div>\n        <p className=\"text-xs text-muted-foreground mt-1\">\n          Set a target to track progress toward your goal\n        </p>\n      </div>\n\n      <div>\n        <Label htmlFor=\"description\">Description (Optional)</Label>\n        <Textarea\n          id=\"description\"\n          {...register(\"description\")}\n          placeholder=\"Describe your shared goal...\"\n          rows={2}\n          data-testid=\"textarea-group-description\"\n        />\n      </div>\n\n      <div className=\"flex justify-end pt-2\">\n        <Button\n          type=\"submit\"\n          disabled={isSubmitting || userLoading || !user}\n          className=\"min-h-[44px] min-w-[120px]\"\n          data-testid=\"button-submit-group\"\n        >\n          {isSubmitting ? \"Creating...\" : userLoading ? \"Loading...\" : \"Create Group\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n","path":null,"size_bytes":6200,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, \n  type InsertUser,\n  type UpsertUser, \n  type Group, \n  type InsertGroup,\n  type GroupMember,\n  type InsertGroupMember,\n  type Event,\n  type InsertEvent,\n  type FinancialGoal,\n  type InsertFinancialGoal,\n  type Transaction,\n  type InsertTransaction,\n  type Budget,\n  type InsertBudget,\n  type GoalContribution,\n  type InsertGoalContribution,\n  type GoalMilestone,\n  type InsertGoalMilestone,\n  type UserStreak,\n  type InsertUserStreak,\n  type UserAchievement,\n  type InsertUserAchievement,\n  type GroupInvite,\n  type InsertGroupInvite,\n  type CalendarShare,\n  type InsertCalendarShare,\n  type FriendRequest,\n  type InsertFriendRequest,\n  type Friendship,\n  type InsertFriendship,\n  type SharedGoal,\n  type InsertSharedGoal,\n  type SharedBudget,\n  type InsertSharedBudget,\n  type SharedBudgetMember,\n  type InsertSharedBudgetMember,\n  type SharedBudgetExpense,\n  type InsertSharedBudgetExpense,\n  type FriendGroupInvitation,\n  type InsertFriendGroupInvitation,\n  type EventExpense,\n  type InsertEventExpense,\n  type EventExpenseShare,\n  type InsertEventExpenseShare,\n  type UserSettings,\n  type InsertUserSettings,\n  type UserPreferences,\n  type InsertUserPreferences,\n  type FinancialPreferences,\n  type InsertFinancialPreferences,\n  type PrivacySettings,\n  type InsertPrivacySettings,\n  type EventTimeLog,\n  type InsertEventTimeLog,\n  type Notification,\n  type InsertNotification,\n  type ChatConversation,\n  type InsertChatConversation,\n  type ChatMessage,\n  type InsertChatMessage,\n  type MessageFeedback,\n  type InsertMessageFeedback,\n  type SubscriptionPlan,\n  type InsertSubscriptionPlan,\n  type Subscription,\n  type InsertSubscription,\n  type UsageTracking,\n  type InsertUsageTracking,\n  type SubscriptionAddOn,\n  type InsertSubscriptionAddOn,\n  type ReferralCode,\n  type InsertReferralCode,\n  type Referral,\n  type InsertReferral,\n  type BonusCredit,\n  type InsertBonusCredit,\n  type CryptoHolding,\n  type InsertCryptoHolding,\n  type CryptoPriceAlert,\n  type InsertCryptoPriceAlert,\n  type CryptoTransaction,\n  type InsertCryptoTransaction,\n  type InvestmentStrategy,\n  type InsertInvestmentStrategy,\n  type PassiveIncomeOpportunity,\n  type InsertPassiveIncomeOpportunity,\n  type UserFinancialProfile,\n  type InsertUserFinancialProfile,\n  type UserExpenseCategory,\n  type InsertUserExpenseCategory,\n  type UserDebt,\n  type InsertUserDebt,\n  type UserAsset,\n  type InsertUserAsset,\n  type AiUsageLog,\n  type InsertAiUsageLog,\n  type Playbook,\n  type InsertPlaybook,\n  users,\n  groups,\n  groupMembers,\n  events,\n  financialGoals,\n  transactions,\n  budgets,\n  goalContributions,\n  goalMilestones,\n  userStreaks,\n  userAchievements,\n  groupInvites,\n  calendarShares,\n  friendRequests,\n  friendships,\n  sharedGoals,\n  sharedBudgets,\n  sharedBudgetMembers,\n  sharedBudgetExpenses,\n  friendGroupInvitations,\n  eventExpenses,\n  eventExpenseShares,\n  userSettings,\n  userPreferences,\n  financialPreferences,\n  privacySettings,\n  eventTimeLogs,\n  notifications,\n  chatConversations,\n  chatMessages,\n  messageFeedback,\n  subscriptionPlans,\n  subscriptions,\n  usageTracking,\n  subscriptionAddOns,\n  referralCodes,\n  referrals,\n  bonusCredits,\n  cryptoHoldings,\n  cryptoPriceAlerts,\n  cryptoTransactions,\n  investmentStrategies,\n  passiveIncomeOpportunities,\n  userFinancialProfiles,\n  userExpenseCategories,\n  userDebts,\n  userAssets,\n  aiUsageLogs,\n  playbooks,\n  webhookEvents\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc, gte, lte, sql, or, exists } from \"drizzle-orm\";\nimport bcrypt from \"bcrypt\";\nimport { randomBytes } from \"crypto\";\n\n// Safe user type without password\nexport type SafeUser = Omit<User, 'password'>;\n\n// Event with group information for calendar display\nexport type EventWithGroup = Event & {\n  group?: {\n    id: string;\n    name: string;\n    color: string;\n  } | null;\n};\n\n// Event with populated attendee user details\nexport type EventWithAttendees = Event & {\n  attendeesWithUsers?: Array<{\n    userId: string;\n    status: 'yes' | 'no' | 'maybe';\n    user: SafeUser;\n  }>;\n};\n\nexport interface IStorage {\n  // User methods (IMPORTANT - these are mandatory for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<SafeUser>;\n  updateUser(id: string, updates: Partial<User>): Promise<SafeUser>;\n\n  // Group methods\n  getGroup(id: string): Promise<Group | undefined>;\n  getGroupsByUserId(userId: string): Promise<Group[]>;\n  createGroup(group: InsertGroup): Promise<Group>;\n  updateGroup(id: string, updates: Partial<Group>): Promise<Group>;\n  deleteGroup(id: string): Promise<void>;\n\n  // Group member methods\n  getGroupMembers(groupId: string): Promise<GroupMember[]>;\n  getGroupMembersWithUserInfo(groupId: string): Promise<Array<GroupMember & { user: SafeUser }>>;\n  addGroupMember(member: InsertGroupMember): Promise<GroupMember>;\n  removeGroupMember(groupId: string, userId: string): Promise<void>;\n  updateGroupMemberRole(groupId: string, userId: string, role: string): Promise<GroupMember>;\n\n  // Event methods\n  getEvent(id: string): Promise<Event | undefined>;\n  getEventsByUserId(userId: string): Promise<Event[]>;\n  getEventsByGroupId(groupId: string): Promise<Event[]>;\n  getUserAccessibleEventsWithGroups(userId: string, limit?: number, offset?: number): Promise<EventWithGroup[]>;\n  getUpcomingEvents(userId: string, limit?: number): Promise<Event[]>;\n  getUpcomingEventsWithAttendees(userId: string, limit?: number): Promise<EventWithAttendees[]>;\n  createEvent(event: InsertEvent): Promise<Event>;\n  updateEvent(id: string, updates: Partial<Event>): Promise<Event>;\n  deleteEvent(id: string): Promise<void>;\n\n  // Financial goal methods\n  getFinancialGoal(id: string): Promise<FinancialGoal | undefined>;\n  getFinancialGoalsByUserId(userId: string): Promise<FinancialGoal[]>;\n  createFinancialGoal(goal: InsertFinancialGoal): Promise<FinancialGoal>;\n  updateFinancialGoal(id: string, updates: Partial<FinancialGoal>): Promise<FinancialGoal>;\n  deleteFinancialGoal(id: string): Promise<void>;\n\n  // Transaction methods\n  getTransaction(id: string): Promise<Transaction | undefined>;\n  getTransactionsByUserId(userId: string, limit?: number): Promise<Transaction[]>;\n  getTransactionsByGoalId(goalId: string): Promise<Transaction[]>;\n  createTransaction(transaction: InsertTransaction): Promise<Transaction>;\n  bulkCreateTransactions(transactions: InsertTransaction[]): Promise<Transaction[]>;\n  updateTransaction(id: string, updates: Partial<Transaction>): Promise<Transaction>;\n  deleteTransaction(id: string): Promise<void>;\n  getFinancialSummary(userId: string, months?: number): Promise<{\n    totalIncome: number;\n    totalExpenses: number;\n    averageMonthlyIncome: number;\n    averageMonthlyExpenses: number;\n    netCashFlow: number;\n    transactionCount: number;\n    categoryBreakdown: Record<string, number>;\n  }>;\n\n  // Budget methods\n  getBudget(id: string): Promise<Budget | undefined>;\n  getBudgetsByUserId(userId: string): Promise<Budget[]>;\n  getBudgetByUserAndCategory(userId: string, category: string): Promise<Budget | undefined>;\n  createBudget(budget: InsertBudget): Promise<Budget>;\n  updateBudget(id: string, updates: Partial<Budget>): Promise<Budget>;\n  deleteBudget(id: string): Promise<void>;\n\n  // Goal contribution methods\n  getGoalContributions(goalId: string): Promise<GoalContribution[]>;\n  createGoalContribution(contribution: InsertGoalContribution): Promise<GoalContribution>;\n\n  // Goal milestone methods\n  getGoalMilestones(goalId: string): Promise<GoalMilestone[]>;\n  getUnseenMilestones(userId: string): Promise<(GoalMilestone & { goal: FinancialGoal })[]>;\n  createGoalMilestone(milestone: InsertGoalMilestone): Promise<GoalMilestone>;\n  markMilestonesSeen(userId: string): Promise<void>;\n  checkAndCreateMilestones(userId: string, goalId: string, currentAmount: number, targetAmount: number): Promise<GoalMilestone[]>;\n\n  // Streak methods\n  getUserStreak(userId: string): Promise<UserStreak | null>;\n  checkInStreak(userId: string): Promise<{ streakIncreased: boolean; newStreak: number; newAchievements: string[] }>;\n  getUserAchievements(userId: string): Promise<UserAchievement[]>;\n\n  // Dashboard methods\n  getUserStats(userId: string): Promise<{\n    totalSavings: number;\n    activeGoals: number;\n    monthlyIncome: number;\n    upcomingEvents: number;\n  }>;\n\n  // Group invite methods\n  createGroupInvite(invite: InsertGroupInvite): Promise<{ invite: GroupInvite; inviteUrl: string }>;\n  getGroupInviteByToken(token: string): Promise<GroupInvite | undefined>;\n  acceptGroupInvite(token: string, userId: string): Promise<GroupMember>;\n  revokeGroupInvite(token: string): Promise<void>;\n\n  // Calendar share methods  \n  createCalendarShare(share: InsertCalendarShare): Promise<{ share: CalendarShare; shareUrl: string }>;\n  getCalendarShareByToken(token: string): Promise<CalendarShare | undefined>;\n  getEventsForShare(token: string): Promise<Event[]>;\n\n  // Friend request methods\n  createFriendRequest(request: InsertFriendRequest): Promise<FriendRequest>;\n  getFriendRequest(id: string): Promise<FriendRequest | undefined>;\n  getFriendRequestsByUserId(userId: string): Promise<Array<FriendRequest & { fromUser: SafeUser; toUser: SafeUser }>>;\n  getPendingFriendRequests(userId: string): Promise<Array<FriendRequest & { fromUser: SafeUser }>>;\n  getSentFriendRequests(userId: string): Promise<Array<FriendRequest & { toUser: SafeUser }>>;\n  updateFriendRequestStatus(id: string, status: 'accepted' | 'declined'): Promise<FriendRequest>;\n  deleteFriendRequest(id: string): Promise<void>;\n  \n  // Friendship methods\n  createFriendship(friendship: InsertFriendship): Promise<Friendship>;\n  getFriendsByUserId(userId: string): Promise<Array<SafeUser>>;\n  areFriends(userId: string, friendId: string): Promise<boolean>;\n  removeFriendship(userId: string, friendId: string): Promise<void>;\n  searchUsers(query: string, excludeUserId: string): Promise<SafeUser[]>;\n  \n  // Shared Goals methods\n  shareGoal(share: InsertSharedGoal): Promise<SharedGoal>;\n  getSharedGoals(userId: string): Promise<Array<SharedGoal & { goal: FinancialGoal; owner: SafeUser }>>;\n  getGoalShares(goalId: string): Promise<Array<SharedGoal & { sharedWith: SafeUser | null }>>;\n  removeGoalShare(goalId: string, sharedWithUserId: string): Promise<void>;\n  updateGoalSharePermission(goalId: string, sharedWithUserId: string, permission: 'view' | 'contribute'): Promise<SharedGoal>;\n  shareGoalWithGroup(goalId: string, ownerId: string, groupId: string, permission: 'view' | 'contribute'): Promise<{ groupShare: SharedGoal; memberShares: SharedGoal[]; memberCount: number }>;\n  \n  // Shared Budgets methods\n  createSharedBudget(budget: InsertSharedBudget): Promise<SharedBudget>;\n  getSharedBudget(id: string): Promise<SharedBudget | undefined>;\n  getSharedBudgetsByUserId(userId: string): Promise<Array<SharedBudget & { members: Array<SafeUser> }>>;\n  updateSharedBudget(id: string, updates: Partial<SharedBudget>): Promise<SharedBudget>;\n  deleteSharedBudget(id: string): Promise<void>;\n  \n  addSharedBudgetMember(member: InsertSharedBudgetMember): Promise<SharedBudgetMember>;\n  getSharedBudgetMembers(budgetId: string): Promise<Array<SharedBudgetMember & { user: SafeUser }>>;\n  removeSharedBudgetMember(budgetId: string, userId: string): Promise<void>;\n  \n  createSharedBudgetExpense(expense: InsertSharedBudgetExpense): Promise<SharedBudgetExpense>;\n  getSharedBudgetExpenses(budgetId: string): Promise<Array<SharedBudgetExpense & { user: SafeUser }>>;\n  updateSharedBudgetExpense(id: string, updates: Partial<SharedBudgetExpense>): Promise<SharedBudgetExpense>;\n  deleteSharedBudgetExpense(id: string): Promise<void>;\n  \n  // Friend Group Invitations methods\n  createFriendGroupInvitation(invitation: InsertFriendGroupInvitation): Promise<FriendGroupInvitation>;\n  getFriendGroupInvitations(userId: string): Promise<Array<FriendGroupInvitation & { group: Group; invitedBy: SafeUser }>>;\n  updateFriendGroupInvitationStatus(id: string, status: 'accepted' | 'declined'): Promise<FriendGroupInvitation>;\n  deleteFriendGroupInvitation(id: string): Promise<void>;\n  bulkInviteFriendsToGroup(groupId: string, invitedBy: string, friendIds: string[], role?: string): Promise<FriendGroupInvitation[]>;\n  \n  // RSVP methods\n  updateEventRSVP(eventId: string, userId: string, status: 'yes' | 'no' | 'maybe'): Promise<Event>;\n  \n  // Event expense methods\n  getEventExpense(id: string): Promise<EventExpense | undefined>;\n  getEventExpensesByEventId(eventId: string): Promise<EventExpense[]>;\n  createEventExpense(expense: InsertEventExpense): Promise<EventExpense>;\n  updateEventExpense(id: string, updates: Partial<EventExpense>): Promise<EventExpense>;\n  deleteEventExpense(id: string): Promise<void>;\n  \n  // Event expense share methods\n  getEventExpenseShare(id: string): Promise<EventExpenseShare | undefined>;\n  getEventExpenseSharesByExpenseId(expenseId: string): Promise<EventExpenseShare[]>;\n  createEventExpenseShare(share: InsertEventExpenseShare): Promise<EventExpenseShare>;\n  updateEventExpenseShare(id: string, updates: Partial<EventExpenseShare>): Promise<EventExpenseShare>;\n  deleteEventExpenseShare(id: string): Promise<void>;\n  \n  // Event financial summary methods\n  getEventFinancialSummary(eventId: string): Promise<{\n    budget: number | null;\n    totalExpenses: number;\n    expensesByCategory: Record<string, number>;\n    unpaidShares: number;\n    expenseShares: Array<{\n      userId: string;\n      totalOwed: number;\n      totalPaid: number;\n    }>;\n  }>;\n  \n  // Utility methods for user management\n  getFirstUser(): Promise<SafeUser | undefined>;\n  \n  // User settings methods\n  getUserSettings(userId: string): Promise<UserSettings | undefined>;\n  createUserSettings(settings: InsertUserSettings): Promise<UserSettings>;\n  updateUserSettings(userId: string, updates: Partial<UserSettings>): Promise<UserSettings>;\n\n  // Time tracking methods\n  createTimeLog(timeLog: InsertEventTimeLog): Promise<EventTimeLog>;\n  getEventTimeLogs(eventId: string): Promise<EventTimeLog[]>;\n  getUserTimeLogs(userId: string, startDate?: Date, endDate?: Date): Promise<EventTimeLog[]>;\n  updateTimeLog(id: string, updates: Partial<EventTimeLog>): Promise<EventTimeLog>;\n  deleteTimeLog(id: string): Promise<void>;\n\n  // Time-value insights methods\n  getTimeValueInsights(userId: string, range: '7d' | '30d' | '90d'): Promise<{\n    totalTimeHours: number;\n    timeValue: number;\n    totalCost: number;\n    netImpact: number;\n    topCategories: Array<{ category: string; timeHours: number; value: number }>;\n    upcomingHighImpact: Array<{ eventId: string; title: string; estimatedValue: number }>;\n  }>;\n  calculateEventTimeValue(eventId: string, userId: string): Promise<{\n    plannedTimeValue: number;\n    actualTimeValue: number;\n    totalImpact: number;\n  }>;\n\n  // Notification methods\n  getNotification(id: string): Promise<Notification | undefined>;\n  getNotificationsByUserId(userId: string, limit?: number, offset?: number, includeRead?: boolean): Promise<Notification[]>;\n  getUnreadNotificationCount(userId: string): Promise<number>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  markNotificationAsRead(id: string): Promise<Notification>;\n  markAllNotificationsAsRead(userId: string): Promise<void>;\n  deleteNotification(id: string): Promise<void>;\n  archiveNotification(id: string): Promise<Notification>;\n\n  // Smart notification generation\n  generateSmartNotifications(userId: string): Promise<Notification[]>;\n  checkGoalDeadlines(userId: string): Promise<Notification[]>;\n  checkTransactionReminders(userId: string): Promise<Notification[]>;\n  checkBudgetWarnings(userId: string): Promise<Notification[]>;\n  checkGoalCompletions(userId: string): Promise<Notification[]>;\n\n  // User preferences methods\n  getUserPreferences(userId: string): Promise<UserPreferences | undefined>;\n  createUserPreferences(preferences: InsertUserPreferences): Promise<UserPreferences>;\n  updateUserPreferences(userId: string, updates: Partial<UserPreferences>): Promise<UserPreferences>;\n\n  // Financial preferences methods\n  getFinancialPreferences(userId: string): Promise<FinancialPreferences | undefined>;\n  createFinancialPreferences(preferences: InsertFinancialPreferences): Promise<FinancialPreferences>;\n  updateFinancialPreferences(userId: string, updates: Partial<FinancialPreferences>): Promise<FinancialPreferences>;\n\n  // Privacy settings methods\n  getPrivacySettings(userId: string): Promise<PrivacySettings | undefined>;\n  createPrivacySettings(settings: InsertPrivacySettings): Promise<PrivacySettings>;\n  updatePrivacySettings(userId: string, updates: Partial<PrivacySettings>): Promise<PrivacySettings>;\n\n  // Data export methods\n  exportUserData(userId: string, format: 'json' | 'csv'): Promise<string>;\n  deleteUserData(userId: string): Promise<void>;\n\n  // Chat methods\n  getChatConversations(userId: string): Promise<ChatConversation[]>;\n  getChatConversation(conversationId: string): Promise<ChatConversation | undefined>;\n  getChatConversationWithMessages(conversationId: string): Promise<(ChatConversation & { messages: ChatMessage[] }) | undefined>;\n  createChatConversation(conversation: InsertChatConversation): Promise<ChatConversation>;\n  updateChatConversation(id: string, updates: Partial<ChatConversation>): Promise<ChatConversation>;\n  deleteChatConversation(id: string): Promise<void>;\n  \n  getChatMessages(conversationId: string, limit?: number, offset?: number): Promise<ChatMessage[]>;\n  createChatMessage(message: InsertChatMessage): Promise<ChatMessage>;\n  getChatMessagesByUserId(userId: string, limit?: number): Promise<ChatMessage[]>;\n\n  // Message Feedback methods\n  getMessageFeedback(messageId: string, userId: string): Promise<MessageFeedback | undefined>;\n  createMessageFeedback(feedback: InsertMessageFeedback): Promise<MessageFeedback>;\n  updateMessageFeedback(messageId: string, userId: string, updates: Partial<MessageFeedback>): Promise<MessageFeedback>;\n  getMessageFeedbackStats(userId: string): Promise<{ helpful: number; notHelpful: number; total: number }>;\n\n  // Subscription Plan methods\n  getSubscriptionPlans(): Promise<SubscriptionPlan[]>;\n  getSubscriptionPlan(id: string): Promise<SubscriptionPlan | undefined>;\n  createSubscriptionPlan(plan: InsertSubscriptionPlan): Promise<SubscriptionPlan>;\n  updateSubscriptionPlan(id: string, updates: Partial<SubscriptionPlan>): Promise<SubscriptionPlan>;\n\n  // Subscription methods\n  getUserSubscription(userId: string): Promise<(Subscription & { plan: SubscriptionPlan }) | undefined>;\n  getSubscriptionByStripeId(stripeSubscriptionId: string): Promise<(Subscription & { plan: SubscriptionPlan }) | undefined>;\n  createSubscription(subscription: InsertSubscription): Promise<Subscription>;\n  updateSubscription(id: string, updates: Partial<Subscription>): Promise<Subscription>;\n  cancelSubscription(id: string): Promise<Subscription>;\n\n  // Usage Tracking methods\n  getUserUsage(userId: string): Promise<UsageTracking | undefined>;\n  createUsageRecord(usage: InsertUsageTracking): Promise<UsageTracking>;\n  updateUsageRecord(id: string, updates: Partial<UsageTracking>): Promise<UsageTracking>;\n  incrementUsage(userId: string, type: 'aiChatsUsed' | 'aiDeepAnalysisUsed' | 'aiInsightsGenerated', amount?: number): Promise<UsageTracking>;\n  \n  // Add-on methods\n  getUserAddOns(userId: string): Promise<SubscriptionAddOn[]>;\n  createAddOn(addOn: InsertSubscriptionAddOn): Promise<SubscriptionAddOn>;\n  \n  // Subscription helpers\n  initializeDefaultSubscription(userId: string): Promise<Subscription>;\n  checkUsageLimit(userId: string, type: 'aiChatsUsed' | 'aiDeepAnalysisUsed'): Promise<{ allowed: boolean; usage: number; limit: number }>;\n  resetUsage(userId: string): Promise<void>;\n  \n  // Webhook idempotency\n  isWebhookEventProcessed(eventId: string): Promise<boolean>;\n  markWebhookEventProcessed(eventId: string, eventType: string): Promise<void>;\n  cleanupOldWebhookEvents(maxAgeHours: number): Promise<number>;\n  \n  // Tier-aware AI methods\n  getUserSubscriptionWithUsage(userId: string): Promise<{ subscription: Subscription; usage: UsageTracking | null; plan: SubscriptionPlan } | null>;\n  incrementUsageCounters(userId: string, subscriptionId: string, modelType: 'scout' | 'sonnet' | 'gpt5' | 'opus'): Promise<void>;\n  insertAIUsageLog(log: Omit<InsertAiUsageLog, 'id' | 'createdAt'>): Promise<void>;\n\n  // Referral methods\n  getUserReferralCode(userId: string): Promise<ReferralCode | undefined>;\n  createReferralCode(referralCode: InsertReferralCode): Promise<ReferralCode>;\n  getReferralByCode(code: string): Promise<ReferralCode | undefined>;\n  processReferral(referredUserId: string, referralCode: string): Promise<Referral>;\n  getUserReferrals(userId: string): Promise<Referral[]>;\n  getUserBonusCredits(userId: string): Promise<BonusCredit[]>;\n  addBonusCredits(bonusCredit: InsertBonusCredit): Promise<BonusCredit>;\n  getAvailableBonusCredits(userId: string): Promise<number>;\n  useBonusCredits(userId: string, amount: number): Promise<void>;\n\n  // Crypto methods\n  getCryptoHolding(id: string): Promise<CryptoHolding | undefined>;\n  getUserCryptoHoldings(userId: string): Promise<CryptoHolding[]>;\n  createCryptoHolding(holding: InsertCryptoHolding): Promise<CryptoHolding>;\n  updateCryptoHolding(id: string, updates: Partial<CryptoHolding>): Promise<CryptoHolding>;\n  deleteCryptoHolding(id: string): Promise<void>;\n  \n  getCryptoPriceAlert(id: string): Promise<CryptoPriceAlert | undefined>;\n  getUserCryptoPriceAlerts(userId: string): Promise<CryptoPriceAlert[]>;\n  createCryptoPriceAlert(alert: InsertCryptoPriceAlert): Promise<CryptoPriceAlert>;\n  updateCryptoPriceAlert(id: string, updates: Partial<CryptoPriceAlert>): Promise<CryptoPriceAlert>;\n  deleteCryptoPriceAlert(id: string): Promise<void>;\n  \n  getCryptoTransaction(id: string): Promise<CryptoTransaction | undefined>;\n  getUserCryptoTransactions(userId: string, limit?: number): Promise<CryptoTransaction[]>;\n  createCryptoTransaction(transaction: InsertCryptoTransaction): Promise<CryptoTransaction>;\n  \n  getUserCryptoPortfolioValue(userId: string): Promise<{\n    totalValue: number;\n    holdings: Array<{\n      symbol: string;\n      name: string;\n      amount: string;\n      currentPrice: string;\n      value: number;\n      change24h: number;\n    }>;\n  }>;\n\n  // Financial Profile methods\n  getUserFinancialProfile(userId: string): Promise<UserFinancialProfile | undefined>;\n  createUserFinancialProfile(profile: InsertUserFinancialProfile): Promise<UserFinancialProfile>;\n  updateUserFinancialProfile(userId: string, updates: Partial<UserFinancialProfile>): Promise<UserFinancialProfile>;\n  \n  // Expense Categories methods\n  getUserExpenseCategories(userId: string): Promise<UserExpenseCategory[]>;\n  updateUserExpenseCategories(userId: string, categories: InsertUserExpenseCategory[]): Promise<UserExpenseCategory[]>;\n  \n  // Debts methods\n  getUserDebts(userId: string): Promise<UserDebt[]>;\n  createUserDebt(debt: InsertUserDebt): Promise<UserDebt>;\n  updateUserDebt(id: string, updates: Partial<UserDebt>): Promise<UserDebt>;\n  deleteUserDebt(id: string): Promise<void>;\n  \n  // Assets methods\n  getUserAssets(userId: string): Promise<UserAsset[]>;\n  createUserAsset(asset: InsertUserAsset): Promise<UserAsset>;\n  updateUserAsset(id: string, updates: Partial<UserAsset>): Promise<UserAsset>;\n  deleteUserAsset(id: string): Promise<void>;\n\n  // Playbook methods\n  getPlaybook(id: string): Promise<Playbook | undefined>;\n  getPlaybooksByUserId(userId: string, limit?: number): Promise<Playbook[]>;\n  createPlaybook(playbook: InsertPlaybook): Promise<Playbook>;\n  updatePlaybook(id: string, updates: Partial<Playbook>): Promise<Playbook>;\n  deletePlaybook(id: string): Promise<void>;\n  markPlaybookViewed(id: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User methods (IMPORTANT - these are mandatory for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    try {\n      // First try to find existing user by ID\n      const existingById = await db\n        .select()\n        .from(users)\n        .where(sql`${users.id} = ${userData.id}`)\n        .limit(1);\n      \n      // If found by ID, update that user\n      if (existingById.length > 0) {\n        const [user] = await db\n          .update(users)\n          .set({\n            ...userData,\n            updatedAt: new Date(),\n          })\n          .where(sql`${users.id} = ${userData.id}`)\n          .returning();\n        return user;\n      }\n      \n      // If not found by ID, try by email\n      if (userData.email) {\n        const existingByEmail = await db\n          .select()\n          .from(users)\n          .where(sql`${users.email} = ${userData.email}`)\n          .limit(1);\n        \n        if (existingByEmail.length > 0) {\n          // Update existing user found by email - DO NOT change ID to avoid FK violations\n          const { id, ...updateData } = userData;\n          const [user] = await db\n            .update(users)\n            .set({\n              ...updateData,\n              updatedAt: new Date(),\n            })\n            .where(sql`${users.id} = ${existingByEmail[0].id}`)\n            .returning();\n          return user;\n        }\n      }\n      \n      // No existing user found - insert new\n      const [user] = await db\n        .insert(users)\n        .values(userData)\n        .returning();\n      return user;\n    } catch (error) {\n      console.error('[Storage] ERROR in upsertUser:', error);\n      throw error;\n    }\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    // This method is kept for compatibility but not used in Replit Auth\n    return undefined;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user || undefined;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<SafeUser> {\n    const [user] = await db\n      .insert(users)\n      .values({\n        ...insertUser,\n        firstName: insertUser.firstName || null,\n        lastName: insertUser.lastName || null,\n        profileImageUrl: insertUser.profileImageUrl || null,\n      })\n      .returning();\n    \n    // Return user (no password field to exclude)\n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<SafeUser> {\n    const updateData = { ...updates, updatedAt: new Date() };\n    \n    const [user] = await db\n      .update(users)\n      .set(updateData)\n      .where(eq(users.id, id))\n      .returning();\n    \n    // Return user (no password field to exclude)\n    return user;\n  }\n\n  // Group methods\n  async getGroup(id: string): Promise<Group | undefined> {\n    const [group] = await db.select().from(groups).where(eq(groups.id, id));\n    return group || undefined;\n  }\n\n  async getGroupsByUserId(userId: string): Promise<any[]> {\n    const userGroups = await db\n      .select({ \n        group: groups,\n        memberCount: sql<number>`count(distinct ${groupMembers.userId})::int`\n      })\n      .from(groups)\n      .leftJoin(groupMembers, eq(groups.id, groupMembers.groupId))\n      .where(eq(groupMembers.userId, userId))\n      .groupBy(groups.id);\n    \n    return userGroups.map(ug => ({ ...ug.group, memberCount: ug.memberCount }));\n  }\n\n  async createGroup(insertGroup: InsertGroup): Promise<Group> {\n    const [group] = await db\n      .insert(groups)\n      .values({\n        ...insertGroup,\n        description: insertGroup.description || null,\n        color: insertGroup.color || \"#3B82F6\",\n        status: insertGroup.status || \"active\",\n      })\n      .returning();\n    \n    // Auto-add owner as admin member\n    await this.addGroupMember({\n      groupId: group.id,\n      userId: group.ownerId,\n      role: \"admin\",\n    });\n    \n    return group;\n  }\n\n  async updateGroup(id: string, updates: Partial<Group>): Promise<Group> {\n    const [group] = await db\n      .update(groups)\n      .set(updates)\n      .where(eq(groups.id, id))\n      .returning();\n    return group;\n  }\n\n  async deleteGroup(id: string): Promise<void> {\n    await db.delete(groups).where(eq(groups.id, id));\n  }\n\n  // Group member methods\n  async getGroupMembers(groupId: string): Promise<GroupMember[]> {\n    return await db.select().from(groupMembers).where(eq(groupMembers.groupId, groupId));\n  }\n\n  async getGroupMembersWithUserInfo(groupId: string): Promise<Array<GroupMember & { user: SafeUser }>> {\n    const membersWithUsers = await db\n      .select({\n        member: groupMembers,\n        user: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        }\n      })\n      .from(groupMembers)\n      .innerJoin(users, eq(groupMembers.userId, users.id))\n      .where(eq(groupMembers.groupId, groupId));\n\n    return membersWithUsers.map(({ member, user }) => ({\n      ...member,\n      user\n    }));\n  }\n\n  async addGroupMember(insertMember: InsertGroupMember): Promise<GroupMember> {\n    const [member] = await db\n      .insert(groupMembers)\n      .values({\n        ...insertMember,\n        role: insertMember.role || \"member\",\n      })\n      .returning();\n    return member;\n  }\n\n  async removeGroupMember(groupId: string, userId: string): Promise<void> {\n    await db\n      .delete(groupMembers)\n      .where(and(eq(groupMembers.groupId, groupId), eq(groupMembers.userId, userId)));\n  }\n\n  async updateGroupMemberRole(groupId: string, userId: string, role: string): Promise<GroupMember> {\n    const [member] = await db\n      .update(groupMembers)\n      .set({ role })\n      .where(and(eq(groupMembers.groupId, groupId), eq(groupMembers.userId, userId)))\n      .returning();\n    return member;\n  }\n\n  // Event methods\n  async getEvent(id: string): Promise<Event | undefined> {\n    const [event] = await db.select().from(events).where(eq(events.id, id));\n    return event || undefined;\n  }\n\n  async getEventsByUserId(userId: string): Promise<Event[]> {\n    return await db.select().from(events).where(eq(events.createdBy, userId));\n  }\n\n  async getEventsByGroupId(groupId: string): Promise<Event[]> {\n    return await db.select().from(events).where(eq(events.groupId, groupId));\n  }\n\n  async getUserAccessibleEventsWithGroups(userId: string, limit = 100, offset = 0): Promise<EventWithGroup[]> {\n    // Get personal events (events created by the user with no group)\n    const personalEvents = await db\n      .select({\n        event: events,\n        groupName: sql<string | null>`NULL`,\n        groupColor: sql<string | null>`NULL`,\n      })\n      .from(events)\n      .where(and(eq(events.createdBy, userId), sql`group_id IS NULL`))\n      .orderBy(desc(events.startTime))\n      .limit(limit)\n      .offset(offset);\n\n    // Get group events (events from groups the user belongs to)\n    const groupEvents = await db\n      .select({\n        event: events,\n        groupName: groups.name,\n        groupColor: groups.color,\n      })\n      .from(events)\n      .innerJoin(groups, eq(events.groupId, groups.id))\n      .innerJoin(groupMembers, eq(groups.id, groupMembers.groupId))\n      .where(eq(groupMembers.userId, userId))\n      .orderBy(desc(events.startTime))\n      .limit(limit)\n      .offset(offset);\n\n    // Combine and format the results\n    const combinedEvents: EventWithGroup[] = [\n      ...personalEvents.map(({ event }) => ({\n        ...event,\n        group: null,\n      })),\n      ...groupEvents.map(({ event, groupName, groupColor }) => ({\n        ...event,\n        group: groupName && groupColor ? {\n          id: event.groupId!,\n          name: groupName,\n          color: groupColor,\n        } : null,\n      }))\n    ];\n\n    return combinedEvents;\n  }\n\n\n  async getUpcomingEvents(userId: string, limit: number = 10): Promise<Event[]> {\n    return await db\n      .select()\n      .from(events)\n      .where(and(eq(events.createdBy, userId), gte(events.startTime, new Date())))\n      .orderBy(events.startTime)\n      .limit(limit);\n  }\n\n  async getUpcomingEventsWithAttendees(userId: string, limit: number = 10): Promise<EventWithAttendees[]> {\n    const upcomingEvents = await this.getUpcomingEvents(userId, limit);\n    \n    // Populate attendee user details for each event\n    const eventsWithAttendees: EventWithAttendees[] = await Promise.all(\n      upcomingEvents.map(async (event) => {\n        const attendees = Array.isArray(event.attendees) ? event.attendees : [];\n        \n        // Fetch user details for each attendee\n        const attendeesWithUsers = await Promise.all(\n          attendees.map(async (attendee: any) => {\n            const user = await this.getUser(attendee.userId);\n            return {\n              userId: attendee.userId,\n              status: attendee.status as 'yes' | 'no' | 'maybe',\n              user: user ? {\n                id: user.id,\n                email: user.email,\n                firstName: user.firstName,\n                lastName: user.lastName,\n                profileImageUrl: user.profileImageUrl,\n                createdAt: user.createdAt,\n                updatedAt: user.updatedAt,\n              } as SafeUser : {\n                id: attendee.userId,\n                email: '',\n                firstName: null,\n                lastName: null,\n                profileImageUrl: null,\n                createdAt: new Date(),\n                updatedAt: new Date(),\n              } as SafeUser,\n            };\n          })\n        );\n        \n        return {\n          ...event,\n          attendeesWithUsers,\n        };\n      })\n    );\n    \n    return eventsWithAttendees;\n  }\n\n  async createEvent(insertEvent: InsertEvent): Promise<Event> {\n    const [event] = await db\n      .insert(events)\n      .values({\n        ...insertEvent,\n        description: insertEvent.description || null,\n        location: insertEvent.location || null,\n        groupId: insertEvent.groupId || null,\n        status: insertEvent.status || \"scheduled\",\n        attendees: insertEvent.attendees || [],\n      })\n      .returning();\n    return event;\n  }\n\n  async updateEvent(id: string, updates: Partial<Event>): Promise<Event> {\n    const [event] = await db\n      .update(events)\n      .set(updates)\n      .where(eq(events.id, id))\n      .returning();\n    return event;\n  }\n\n  async deleteEvent(id: string): Promise<void> {\n    await db.delete(events).where(eq(events.id, id));\n  }\n\n  // Financial goal methods\n  async getFinancialGoal(id: string): Promise<FinancialGoal | undefined> {\n    const [goal] = await db.select().from(financialGoals).where(eq(financialGoals.id, id));\n    return goal || undefined;\n  }\n\n  async getFinancialGoalsByUserId(userId: string): Promise<FinancialGoal[]> {\n    return await db.select().from(financialGoals).where(eq(financialGoals.userId, userId));\n  }\n\n  async createFinancialGoal(insertGoal: InsertFinancialGoal): Promise<FinancialGoal> {\n    const [goal] = await db\n      .insert(financialGoals)\n      .values({\n        ...insertGoal,\n        description: insertGoal.description || null,\n        currentAmount: insertGoal.currentAmount || \"0\",\n        category: insertGoal.category || null,\n        priority: insertGoal.priority || \"medium\",\n        status: insertGoal.status || \"active\",\n      })\n      .returning();\n    return goal;\n  }\n\n  async updateFinancialGoal(id: string, updates: Partial<FinancialGoal>): Promise<FinancialGoal> {\n    const [goal] = await db\n      .update(financialGoals)\n      .set(updates)\n      .where(eq(financialGoals.id, id))\n      .returning();\n    return goal;\n  }\n\n  async deleteFinancialGoal(id: string): Promise<void> {\n    await db.delete(financialGoals).where(eq(financialGoals.id, id));\n  }\n\n  // Transaction methods\n  async getTransaction(id: string): Promise<Transaction | undefined> {\n    const [transaction] = await db.select().from(transactions).where(eq(transactions.id, id));\n    return transaction || undefined;\n  }\n\n  async getTransactionsByUserId(userId: string, limit: number = 100): Promise<Transaction[]> {\n    return await db\n      .select()\n      .from(transactions)\n      .where(eq(transactions.userId, userId))\n      .orderBy(desc(transactions.date))\n      .limit(limit);\n  }\n\n  async getTransactionsByGoalId(goalId: string): Promise<Transaction[]> {\n    return await db.select().from(transactions).where(eq(transactions.goalId, goalId));\n  }\n\n  async createTransaction(insertTransaction: InsertTransaction): Promise<Transaction> {\n    const [transaction] = await db\n      .insert(transactions)\n      .values(insertTransaction as typeof transactions.$inferInsert)\n      .returning();\n\n    // If this transaction is for a goal, update the goal's current amount\n    // Support both income and transfer transactions contributing to goals\n    if (transaction.goalId && (transaction.type === \"transfer\" || transaction.type === \"income\")) {\n      const goal = await this.getFinancialGoal(transaction.goalId);\n      if (goal) {\n        const newAmount = parseFloat(goal.currentAmount || \"0\") + parseFloat(transaction.amount.toString());\n        await this.updateFinancialGoal(transaction.goalId, { \n          currentAmount: newAmount.toString() \n        });\n\n        // Create goal contribution record\n        await this.createGoalContribution({\n          goalId: transaction.goalId,\n          transactionId: transaction.id,\n          amount: transaction.amount\n        });\n      }\n    }\n\n    return transaction;\n  }\n\n  async updateTransaction(id: string, updates: Partial<Transaction>): Promise<Transaction> {\n    const [transaction] = await db\n      .update(transactions)\n      .set(updates)\n      .where(eq(transactions.id, id))\n      .returning();\n    return transaction;\n  }\n\n  async deleteTransaction(id: string): Promise<void> {\n    await db.delete(transactions).where(eq(transactions.id, id));\n  }\n\n  async bulkCreateTransactions(insertTransactions: InsertTransaction[]): Promise<Transaction[]> {\n    if (insertTransactions.length === 0) return [];\n    \n    const createdTransactions = await db\n      .insert(transactions)\n      .values(insertTransactions as (typeof transactions.$inferInsert)[])\n      .returning();\n    \n    return createdTransactions;\n  }\n\n  async getFinancialSummary(userId: string, months: number = 6): Promise<{\n    totalIncome: number;\n    totalExpenses: number;\n    averageMonthlyIncome: number;\n    averageMonthlyExpenses: number;\n    netCashFlow: number;\n    transactionCount: number;\n    categoryBreakdown: Record<string, number>;\n  }> {\n    const startDate = new Date();\n    startDate.setMonth(startDate.getMonth() - months);\n    \n    const userTransactions = await db\n      .select()\n      .from(transactions)\n      .where(\n        and(\n          eq(transactions.userId, userId),\n          gte(transactions.date, startDate)\n        )\n      );\n    \n    let totalIncome = 0;\n    let totalExpenses = 0;\n    const categoryBreakdown: Record<string, number> = {};\n    \n    for (const tx of userTransactions) {\n      const amount = parseFloat(tx.amount.toString());\n      if (tx.type === 'income') {\n        totalIncome += amount;\n      } else if (tx.type === 'expense') {\n        totalExpenses += Math.abs(amount);\n      }\n      \n      const category = tx.category || 'Other';\n      categoryBreakdown[category] = (categoryBreakdown[category] || 0) + Math.abs(amount);\n    }\n    \n    return {\n      totalIncome,\n      totalExpenses,\n      averageMonthlyIncome: totalIncome / months,\n      averageMonthlyExpenses: totalExpenses / months,\n      netCashFlow: totalIncome - totalExpenses,\n      transactionCount: userTransactions.length,\n      categoryBreakdown,\n    };\n  }\n\n  // Budget methods\n  async getBudget(id: string): Promise<Budget | undefined> {\n    const result = await db.select().from(budgets).where(eq(budgets.id, id));\n    return result[0];\n  }\n\n  async getBudgetsByUserId(userId: string): Promise<Budget[]> {\n    return await db.select().from(budgets).where(eq(budgets.userId, userId));\n  }\n\n  async getBudgetByUserAndCategory(userId: string, category: string): Promise<Budget | undefined> {\n    const result = await db\n      .select()\n      .from(budgets)\n      .where(and(eq(budgets.userId, userId), eq(budgets.category, category)));\n    return result[0];\n  }\n\n  async createBudget(insertBudget: InsertBudget): Promise<Budget> {\n    const [budget] = await db\n      .insert(budgets)\n      .values(insertBudget as typeof budgets.$inferInsert)\n      .returning();\n    return budget;\n  }\n\n  async updateBudget(id: string, updates: Partial<Budget>): Promise<Budget> {\n    const [budget] = await db\n      .update(budgets)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(budgets.id, id))\n      .returning();\n    return budget;\n  }\n\n  async deleteBudget(id: string): Promise<void> {\n    await db.delete(budgets).where(eq(budgets.id, id));\n  }\n\n  // Goal contribution methods\n  async getGoalContributions(goalId: string): Promise<GoalContribution[]> {\n    return await db.select().from(goalContributions).where(eq(goalContributions.goalId, goalId));\n  }\n\n  async createGoalContribution(insertContribution: InsertGoalContribution): Promise<GoalContribution> {\n    const [contribution] = await db\n      .insert(goalContributions)\n      .values(insertContribution)\n      .returning();\n    return contribution;\n  }\n\n  // Goal milestone methods\n  async getGoalMilestones(goalId: string): Promise<GoalMilestone[]> {\n    return await db.select().from(goalMilestones).where(eq(goalMilestones.goalId, goalId)).orderBy(goalMilestones.milestone);\n  }\n\n  async getUnseenMilestones(userId: string): Promise<(GoalMilestone & { goal: FinancialGoal })[]> {\n    const results = await db\n      .select()\n      .from(goalMilestones)\n      .innerJoin(financialGoals, eq(goalMilestones.goalId, financialGoals.id))\n      .where(and(eq(goalMilestones.userId, userId), eq(goalMilestones.isSeen, false)))\n      .orderBy(desc(goalMilestones.celebratedAt));\n    \n    return results.map(r => ({\n      ...r.goal_milestones,\n      goal: r.financial_goals,\n    }));\n  }\n\n  async createGoalMilestone(milestone: InsertGoalMilestone): Promise<GoalMilestone> {\n    const [created] = await db\n      .insert(goalMilestones)\n      .values(milestone)\n      .returning();\n    return created;\n  }\n\n  async markMilestonesSeen(userId: string): Promise<void> {\n    await db\n      .update(goalMilestones)\n      .set({ isSeen: true })\n      .where(and(eq(goalMilestones.userId, userId), eq(goalMilestones.isSeen, false)));\n  }\n\n  async checkAndCreateMilestones(userId: string, goalId: string, currentAmount: number, targetAmount: number): Promise<GoalMilestone[]> {\n    const milestoneThresholds = [25, 50, 75, 100];\n    const currentPercentage = targetAmount > 0 ? (currentAmount / targetAmount) * 100 : 0;\n    const createdMilestones: GoalMilestone[] = [];\n\n    const existingMilestones = await this.getGoalMilestones(goalId);\n    const existingMilestoneValues = new Set(existingMilestones.map(m => m.milestone));\n\n    for (const threshold of milestoneThresholds) {\n      if (currentPercentage >= threshold && !existingMilestoneValues.has(threshold)) {\n        try {\n          const milestone = await this.createGoalMilestone({\n            goalId,\n            userId,\n            milestone: threshold,\n            amountAtMilestone: currentAmount.toFixed(2),\n          });\n          createdMilestones.push(milestone);\n        } catch (error: any) {\n          // Ignore unique constraint violations (milestone already exists)\n          if (!error.message?.includes('unique')) {\n            console.error('Error creating milestone:', error);\n          }\n        }\n      }\n    }\n\n    return createdMilestones;\n  }\n\n  // Streak methods\n  async getUserStreak(userId: string): Promise<UserStreak | null> {\n    const [streak] = await db\n      .select()\n      .from(userStreaks)\n      .where(eq(userStreaks.userId, userId));\n    return streak ?? null;\n  }\n\n  private computeWeeklyProgress(existingProgress: boolean[] | null, lastCheckIn: Date | null): boolean[] {\n    const now = new Date();\n    const todayIndex = now.getDay();\n    \n    const startOfWeek = new Date(now);\n    startOfWeek.setDate(now.getDate() - now.getDay());\n    startOfWeek.setHours(0, 0, 0, 0);\n    \n    let weekProgress: boolean[] = [false, false, false, false, false, false, false];\n    \n    if (existingProgress && Array.isArray(existingProgress) && lastCheckIn) {\n      const lastCheckInDate = new Date(lastCheckIn);\n      lastCheckInDate.setHours(0, 0, 0, 0);\n      \n      if (lastCheckInDate >= startOfWeek) {\n        weekProgress = [...existingProgress];\n      }\n    }\n    \n    weekProgress[todayIndex] = true;\n    \n    return weekProgress;\n  }\n\n  async checkInStreak(userId: string): Promise<{ streakIncreased: boolean; newStreak: number; newAchievements: string[] }> {\n    const existingStreak = await this.getUserStreak(userId);\n    const now = new Date();\n    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    const newAchievements: string[] = [];\n    \n    if (!existingStreak) {\n      const weeklyProgress = this.computeWeeklyProgress(null, null);\n      await db.insert(userStreaks).values({\n        userId,\n        currentStreak: 1,\n        longestStreak: 1,\n        totalCheckIns: 1,\n        lastCheckIn: now,\n        weeklyProgress,\n      });\n      \n      await this.checkAndUnlockAchievements(userId, 1, 1, newAchievements);\n      return { streakIncreased: true, newStreak: 1, newAchievements };\n    }\n    \n    // Handle null lastCheckIn - treat as new streak\n    if (!existingStreak.lastCheckIn) {\n      const weeklyProgress = this.computeWeeklyProgress(null, null);\n      await db\n        .update(userStreaks)\n        .set({ \n          currentStreak: 1, \n          longestStreak: 1, \n          totalCheckIns: 1,\n          lastCheckIn: now,\n          weeklyProgress,\n          updatedAt: now,\n        })\n        .where(eq(userStreaks.userId, userId));\n      \n      await this.checkAndUnlockAchievements(userId, 1, 1, newAchievements);\n      return { streakIncreased: true, newStreak: 1, newAchievements };\n    }\n    \n    const lastCheckIn = new Date(existingStreak.lastCheckIn);\n    const lastCheckInDate = new Date(lastCheckIn.getFullYear(), lastCheckIn.getMonth(), lastCheckIn.getDate());\n    const diffDays = Math.floor((today.getTime() - lastCheckInDate.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // Use nullish coalescing to handle nullable integer fields\n    const currentStreakValue = existingStreak.currentStreak ?? 0;\n    const longestStreakValue = existingStreak.longestStreak ?? 0;\n    \n    if (diffDays === 0) {\n      return { streakIncreased: false, newStreak: currentStreakValue, newAchievements: [] };\n    }\n    \n    const existingProgress = existingStreak.weeklyProgress as boolean[] | null;\n    const weeklyProgress = this.computeWeeklyProgress(existingProgress, existingStreak.lastCheckIn);\n    const newTotalCheckIns = (existingStreak.totalCheckIns ?? 0) + 1;\n    \n    if (diffDays === 1) {\n      const newStreak = currentStreakValue + 1;\n      const newLongest = Math.max(longestStreakValue, newStreak);\n      await db\n        .update(userStreaks)\n        .set({ \n          currentStreak: newStreak, \n          longestStreak: newLongest, \n          totalCheckIns: newTotalCheckIns,\n          lastCheckIn: now,\n          weeklyProgress,\n          updatedAt: now,\n        })\n        .where(eq(userStreaks.userId, userId));\n      \n      await this.checkAndUnlockAchievements(userId, newStreak, newTotalCheckIns, newAchievements);\n      return { streakIncreased: true, newStreak, newAchievements };\n    } else {\n      await db\n        .update(userStreaks)\n        .set({ \n          currentStreak: 1, \n          totalCheckIns: newTotalCheckIns,\n          lastCheckIn: now,\n          weeklyProgress,\n          updatedAt: now,\n        })\n        .where(eq(userStreaks.userId, userId));\n      \n      await this.checkAndUnlockAchievements(userId, 1, newTotalCheckIns, newAchievements);\n      return { streakIncreased: true, newStreak: 1, newAchievements };\n    }\n  }\n\n  private async checkAndUnlockAchievements(userId: string, currentStreak: number, totalCheckIns: number, newAchievements: string[]): Promise<void> {\n    const existingAchievements = await this.getUserAchievements(userId);\n    const existingIds = new Set(existingAchievements.map(a => a.achievementId));\n    \n    const streakMilestones = [\n      { id: 'streak_7', streak: 7, target: 7 },\n      { id: 'streak_30', streak: 30, target: 30 },\n    ];\n    \n    for (const milestone of streakMilestones) {\n      if (currentStreak >= milestone.streak && !existingIds.has(milestone.id)) {\n        try {\n          await db.insert(userAchievements).values({\n            userId,\n            achievementId: milestone.id,\n            progress: currentStreak,\n            target: milestone.target,\n            earnedAt: new Date(),\n          });\n          newAchievements.push(milestone.id);\n        } catch (e) {\n        }\n      }\n    }\n    \n    for (const milestone of streakMilestones) {\n      if (!existingIds.has(milestone.id) && currentStreak < milestone.streak) {\n        try {\n          await db.insert(userAchievements).values({\n            userId,\n            achievementId: milestone.id,\n            progress: currentStreak,\n            target: milestone.target,\n          }).onConflictDoUpdate({\n            target: [userAchievements.userId, userAchievements.achievementId],\n            set: { progress: currentStreak },\n          });\n        } catch (e) {\n          // Silently handle conflicts - achievement already exists\n        }\n      }\n    }\n  }\n\n  async getUserAchievements(userId: string): Promise<UserAchievement[]> {\n    return await db\n      .select()\n      .from(userAchievements)\n      .where(eq(userAchievements.userId, userId))\n      .orderBy(desc(userAchievements.earnedAt));\n  }\n\n  // Dashboard methods\n  async getUserStats(userId: string): Promise<{\n    totalSavings: number;\n    activeGoals: number;\n    monthlyIncome: number;\n    upcomingEvents: number;\n  }> {\n    const [userGoals] = await db\n      .select({\n        activeGoals: sql<number>`count(*)`,\n        totalSavings: sql<number>`coalesce(sum(cast(${financialGoals.currentAmount} as decimal)), 0)`,\n      })\n      .from(financialGoals)\n      .where(and(eq(financialGoals.userId, userId), eq(financialGoals.status, \"active\")));\n\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const [incomeData] = await db\n      .select({\n        monthlyIncome: sql<number>`coalesce(sum(cast(${transactions.amount} as decimal)), 0)`,\n      })\n      .from(transactions)\n      .where(\n        and(\n          eq(transactions.userId, userId),\n          eq(transactions.type, \"income\"),\n          gte(transactions.date, thirtyDaysAgo)\n        )\n      );\n\n    const [eventData] = await db\n      .select({\n        upcomingEvents: sql<number>`count(*)`,\n      })\n      .from(events)\n      .where(\n        and(\n          eq(events.createdBy, userId),\n          gte(events.startTime, new Date())\n        )\n      );\n\n    // Get user preferences to check for financial estimates\n    const [prefs] = await db\n      .select()\n      .from(userPreferences)\n      .where(eq(userPreferences.userId, userId))\n      .limit(1);\n\n    // Use actual transaction data if available, otherwise fall back to user estimates\n    const actualIncome = parseFloat(incomeData?.monthlyIncome?.toString() || \"0\");\n    const goalsTotal = parseFloat(userGoals?.totalSavings?.toString() || \"0\");\n    const savingsEstimate = parseFloat(prefs?.currentSavingsEstimate?.toString() || \"0\");\n    \n    // Monthly income: use actual transactions if available, otherwise estimate\n    const monthlyIncome = actualIncome > 0 ? actualIncome : parseFloat(prefs?.monthlyIncomeEstimate?.toString() || \"0\");\n    \n    // Total savings: use MAX of (goals total, initial estimate) to account for savings not yet allocated to goals\n    // This ensures we never show less than what the user said they have saved\n    const totalSavings = Math.max(goalsTotal, savingsEstimate);\n\n    return {\n      totalSavings,\n      activeGoals: userGoals?.activeGoals || 0,\n      monthlyIncome,\n      upcomingEvents: eventData?.upcomingEvents || 0,\n    };\n  }\n\n  // Utility methods\n  async getFirstUser(): Promise<SafeUser | undefined> {\n    const [user] = await db.select().from(users).limit(1);\n    return user;\n  }\n\n  // Helper method to generate secure tokens\n  private generateToken(): string {\n    return randomBytes(32).toString('hex');\n  }\n\n  // Group invite methods\n  async createGroupInvite(insertInvite: InsertGroupInvite): Promise<{ invite: GroupInvite; inviteUrl: string }> {\n    const token = this.generateToken();\n    \n    const [invite] = await db\n      .insert(groupInvites)\n      .values({\n        ...insertInvite,\n        token,\n      })\n      .returning();\n\n    const inviteUrl = `/invite/${token}`;\n    return { invite, inviteUrl };\n  }\n\n  async getGroupInviteByToken(token: string): Promise<GroupInvite | undefined> {\n    const [invite] = await db\n      .select()\n      .from(groupInvites)\n      .where(and(\n        eq(groupInvites.token, token),\n        gte(groupInvites.expiresAt, new Date()),\n        // Only return invites that haven't been accepted (single-use)\n        sql`${groupInvites.acceptedBy} IS NULL`\n      ));\n    return invite || undefined;\n  }\n\n  async acceptGroupInvite(token: string, userId: string): Promise<GroupMember> {\n    // Atomically consume the invite token (prevents race conditions)\n    const updatedInvites = await db\n      .update(groupInvites)\n      .set({\n        acceptedBy: userId,\n        acceptedAt: new Date(),\n      })\n      .where(and(\n        eq(groupInvites.token, token),\n        gte(groupInvites.expiresAt, new Date()),\n        sql`${groupInvites.acceptedBy} IS NULL`\n      ))\n      .returning();\n\n    if (updatedInvites.length === 0) {\n      throw new Error(\"Invalid, expired, or already used invite\");\n    }\n\n    const invite = updatedInvites[0];\n\n    // Check if user is already a member\n    const existingMembership = await db\n      .select()\n      .from(groupMembers)\n      .where(and(\n        eq(groupMembers.groupId, invite.groupId),\n        eq(groupMembers.userId, userId)\n      ));\n\n    if (existingMembership.length > 0) {\n      throw new Error(\"User is already a member of this group\");\n    }\n\n    // Add user to group\n    const member = await this.addGroupMember({\n      groupId: invite.groupId,\n      userId,\n      role: invite.role || \"member\",\n    });\n\n    return member;\n  }\n\n  async revokeGroupInvite(token: string): Promise<void> {\n    await db.delete(groupInvites).where(eq(groupInvites.token, token));\n  }\n\n  // Calendar share methods\n  async createCalendarShare(insertShare: InsertCalendarShare): Promise<{ share: CalendarShare; shareUrl: string }> {\n    const token = this.generateToken();\n    \n    const [share] = await db\n      .insert(calendarShares)\n      .values({\n        ...insertShare,\n        token,\n      })\n      .returning();\n\n    const shareUrl = `/shared/calendar/${token}`;\n    return { share, shareUrl };\n  }\n\n  async getCalendarShareByToken(token: string): Promise<CalendarShare | undefined> {\n    const [share] = await db\n      .select()\n      .from(calendarShares)\n      .where(eq(calendarShares.token, token));\n    \n    // Check if share exists and not expired\n    if (!share) return undefined;\n    if (share.expiresAt && new Date() > share.expiresAt) return undefined;\n    \n    return share;\n  }\n\n  async getCalendarSharesByUserId(userId: string): Promise<CalendarShare[]> {\n    const shares = await db\n      .select()\n      .from(calendarShares)\n      .where(\n        or(\n          eq(calendarShares.ownerId, userId),\n          // Also include shares for groups the user owns or is admin of\n          exists(\n            db.select().from(groupMembers)\n              .where(and(\n                eq(groupMembers.groupId, calendarShares.groupId!),\n                eq(groupMembers.userId, userId),\n                // User must be owner or admin to see group shares\n                sql`${groupMembers.role} IN ('owner', 'admin')`\n              ))\n          )\n        )\n      );\n    \n    return shares;\n  }\n\n  async getEventsForShare(token: string): Promise<Event[]> {\n    const share = await this.getCalendarShareByToken(token);\n    if (!share) {\n      throw new Error(\"Invalid or expired share token\");\n    }\n\n    if (share.scope === \"user\" && share.ownerId) {\n      return await this.getEventsByUserId(share.ownerId);\n    } else if (share.scope === \"group\" && share.groupId) {\n      return await this.getEventsByGroupId(share.groupId);\n    }\n\n    return [];\n  }\n\n  // Friend request methods\n  async createFriendRequest(insertRequest: InsertFriendRequest): Promise<FriendRequest> {\n    // Check if request already exists\n    const [existing] = await db\n      .select()\n      .from(friendRequests)\n      .where(\n        and(\n          eq(friendRequests.fromUserId, insertRequest.fromUserId),\n          eq(friendRequests.toUserId, insertRequest.toUserId),\n          eq(friendRequests.status, 'pending')\n        )\n      );\n\n    if (existing) {\n      throw new Error(\"Friend request already sent\");\n    }\n\n    // Check if they're already friends\n    const areFriends = await this.areFriends(insertRequest.fromUserId, insertRequest.toUserId);\n    if (areFriends) {\n      throw new Error(\"Already friends with this user\");\n    }\n\n    const [request] = await db\n      .insert(friendRequests)\n      .values(insertRequest)\n      .returning();\n\n    return request;\n  }\n\n  async getFriendRequest(id: string): Promise<FriendRequest | undefined> {\n    const [request] = await db\n      .select()\n      .from(friendRequests)\n      .where(eq(friendRequests.id, id));\n    return request || undefined;\n  }\n\n  async getFriendRequestsByUserId(userId: string): Promise<Array<FriendRequest & { fromUser: SafeUser; toUser: SafeUser }>> {\n    const requests = await db\n      .select({\n        request: friendRequests,\n        fromUser: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n        toUser: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        }\n      })\n      .from(friendRequests)\n      .innerJoin(users, eq(friendRequests.fromUserId, users.id))\n      .innerJoin(users, eq(friendRequests.toUserId, users.id))\n      .where(\n        or(\n          eq(friendRequests.fromUserId, userId),\n          eq(friendRequests.toUserId, userId)\n        )\n      );\n\n    return requests.map(({ request, fromUser, toUser }) => ({\n      ...request,\n      fromUser,\n      toUser,\n    }));\n  }\n\n  async getPendingFriendRequests(userId: string): Promise<Array<FriendRequest & { fromUser: SafeUser }>> {\n    const requests = await db\n      .select({\n        request: friendRequests,\n        fromUser: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        }\n      })\n      .from(friendRequests)\n      .innerJoin(users, eq(friendRequests.fromUserId, users.id))\n      .where(\n        and(\n          eq(friendRequests.toUserId, userId),\n          eq(friendRequests.status, 'pending')\n        )\n      );\n\n    return requests.map(({ request, fromUser }) => ({\n      ...request,\n      fromUser,\n    }));\n  }\n\n  async getSentFriendRequests(userId: string): Promise<Array<FriendRequest & { toUser: SafeUser }>> {\n    const requests = await db\n      .select({\n        request: friendRequests,\n        toUser: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        }\n      })\n      .from(friendRequests)\n      .innerJoin(users, eq(friendRequests.toUserId, users.id))\n      .where(\n        and(\n          eq(friendRequests.fromUserId, userId),\n          eq(friendRequests.status, 'pending')\n        )\n      );\n\n    return requests.map(({ request, toUser }) => ({\n      ...request,\n      toUser,\n    }));\n  }\n\n  async updateFriendRequestStatus(id: string, status: 'accepted' | 'declined'): Promise<FriendRequest> {\n    const [request] = await db\n      .update(friendRequests)\n      .set({ status, respondedAt: new Date() })\n      .where(eq(friendRequests.id, id))\n      .returning();\n\n    // If accepted, create friendship\n    if (status === 'accepted') {\n      await this.createFriendship({\n        userId: request.fromUserId,\n        friendId: request.toUserId,\n      });\n      // Also create reverse friendship for bidirectional lookup\n      await this.createFriendship({\n        userId: request.toUserId,\n        friendId: request.fromUserId,\n      });\n    }\n\n    return request;\n  }\n\n  async deleteFriendRequest(id: string): Promise<void> {\n    await db.delete(friendRequests).where(eq(friendRequests.id, id));\n  }\n\n  // Friendship methods\n  async createFriendship(insertFriendship: InsertFriendship): Promise<Friendship> {\n    const [friendship] = await db\n      .insert(friendships)\n      .values(insertFriendship)\n      .returning();\n\n    return friendship;\n  }\n\n  async getFriendsByUserId(userId: string): Promise<Array<SafeUser>> {\n    const friends = await db\n      .select({\n        id: users.id,\n        email: users.email,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        profileImageUrl: users.profileImageUrl,\n        createdAt: users.createdAt,\n        updatedAt: users.updatedAt,\n      })\n      .from(friendships)\n      .innerJoin(users, eq(friendships.friendId, users.id))\n      .where(eq(friendships.userId, userId));\n\n    return friends;\n  }\n\n  async areFriends(userId: string, friendId: string): Promise<boolean> {\n    const [friendship] = await db\n      .select()\n      .from(friendships)\n      .where(\n        and(\n          eq(friendships.userId, userId),\n          eq(friendships.friendId, friendId)\n        )\n      );\n\n    return !!friendship;\n  }\n\n  async removeFriendship(userId: string, friendId: string): Promise<void> {\n    // Remove both directions of friendship\n    await db\n      .delete(friendships)\n      .where(\n        or(\n          and(\n            eq(friendships.userId, userId),\n            eq(friendships.friendId, friendId)\n          ),\n          and(\n            eq(friendships.userId, friendId),\n            eq(friendships.friendId, userId)\n          )\n        )\n      );\n  }\n\n  async searchUsers(query: string, excludeUserId: string): Promise<SafeUser[]> {\n    const searchPattern = `%${query.toLowerCase()}%`;\n    \n    const foundUsers = await db\n      .select({\n        id: users.id,\n        email: users.email,\n        firstName: users.firstName,\n        lastName: users.lastName,\n        profileImageUrl: users.profileImageUrl,\n        createdAt: users.createdAt,\n        updatedAt: users.updatedAt,\n      })\n      .from(users)\n      .where(\n        and(\n          sql`${users.id} != ${excludeUserId}`,\n          or(\n            sql`LOWER(${users.email}) LIKE ${searchPattern}`,\n            sql`LOWER(${users.firstName}) LIKE ${searchPattern}`,\n            sql`LOWER(${users.lastName}) LIKE ${searchPattern}`,\n            sql`LOWER(CONCAT(${users.firstName}, ' ', ${users.lastName})) LIKE ${searchPattern}`\n          )\n        )\n      )\n      .limit(20);\n\n    return foundUsers;\n  }\n\n  // Shared Goals methods\n  async shareGoal(insertShare: InsertSharedGoal): Promise<SharedGoal> {\n    const [share] = await db\n      .insert(sharedGoals)\n      .values(insertShare)\n      .returning();\n\n    return share;\n  }\n\n  async getSharedGoals(userId: string): Promise<Array<SharedGoal & { goal: FinancialGoal; owner: SafeUser }>> {\n    const shares = await db\n      .select({\n        id: sharedGoals.id,\n        goalId: sharedGoals.goalId,\n        ownerId: sharedGoals.ownerId,\n        sharedWithUserId: sharedGoals.sharedWithUserId,\n        groupId: sharedGoals.groupId,\n        permission: sharedGoals.permission,\n        status: sharedGoals.status,\n        createdAt: sharedGoals.createdAt,\n        goal: financialGoals,\n        owner: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n      })\n      .from(sharedGoals)\n      .innerJoin(financialGoals, eq(sharedGoals.goalId, financialGoals.id))\n      .innerJoin(users, eq(sharedGoals.ownerId, users.id))\n      .where(and(\n        eq(sharedGoals.sharedWithUserId, userId),\n        eq(sharedGoals.status, 'active')\n      ));\n\n    return shares;\n  }\n\n  async getGoalShares(goalId: string): Promise<Array<SharedGoal & { sharedWith: SafeUser | null; group?: any }>> {\n    const shares = await db\n      .select({\n        id: sharedGoals.id,\n        goalId: sharedGoals.goalId,\n        ownerId: sharedGoals.ownerId,\n        sharedWithUserId: sharedGoals.sharedWithUserId,\n        groupId: sharedGoals.groupId,\n        permission: sharedGoals.permission,\n        status: sharedGoals.status,\n        createdAt: sharedGoals.createdAt,\n        sharedWith: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n      })\n      .from(sharedGoals)\n      .leftJoin(users, eq(sharedGoals.sharedWithUserId, users.id))\n      .where(and(\n        eq(sharedGoals.goalId, goalId),\n        eq(sharedGoals.status, 'active')\n      ));\n\n    return shares;\n  }\n\n  async removeGoalShare(goalId: string, sharedWithUserId: string): Promise<void> {\n    await db\n      .update(sharedGoals)\n      .set({ status: 'removed' })\n      .where(and(\n        eq(sharedGoals.goalId, goalId),\n        eq(sharedGoals.sharedWithUserId, sharedWithUserId)\n      ));\n  }\n\n  async updateGoalSharePermission(goalId: string, sharedWithUserId: string, permission: 'view' | 'contribute'): Promise<SharedGoal> {\n    const [share] = await db\n      .update(sharedGoals)\n      .set({ permission })\n      .where(and(\n        eq(sharedGoals.goalId, goalId),\n        eq(sharedGoals.sharedWithUserId, sharedWithUserId)\n      ))\n      .returning();\n\n    return share;\n  }\n\n  async shareGoalWithGroup(goalId: string, ownerId: string, groupId: string, permission: 'view' | 'contribute'): Promise<{ groupShare: SharedGoal; memberShares: SharedGoal[]; memberCount: number }> {\n    // Create group-level share entry\n    const [groupShare] = await db\n      .insert(sharedGoals)\n      .values({\n        goalId,\n        ownerId,\n        groupId,\n        sharedWithUserId: null,\n        permission,\n        status: 'active',\n      })\n      .returning();\n\n    // Get all group members (excluding owner)\n    const members = await db\n      .select()\n      .from(groupMembers)\n      .where(and(\n        eq(groupMembers.groupId, groupId),\n        sql`${groupMembers.userId} != ${ownerId}`\n      ));\n\n    // Create individual shares for each member\n    const memberSharesData = members.map(member => ({\n      goalId,\n      ownerId,\n      sharedWithUserId: member.userId,\n      groupId: null,\n      permission,\n      status: 'active' as const,\n    }));\n\n    let memberShares: SharedGoal[] = [];\n    if (memberSharesData.length > 0) {\n      memberShares = await db\n        .insert(sharedGoals)\n        .values(memberSharesData)\n        .onConflictDoNothing()\n        .returning();\n    }\n\n    return {\n      groupShare,\n      memberShares,\n      memberCount: members.length,\n    };\n  }\n\n  // Shared Budgets methods\n  async createSharedBudget(insertBudget: InsertSharedBudget): Promise<SharedBudget> {\n    const [budget] = await db\n      .insert(sharedBudgets)\n      .values(insertBudget)\n      .returning();\n\n    // Add creator as owner member\n    await db.insert(sharedBudgetMembers).values({\n      budgetId: budget.id,\n      userId: insertBudget.createdBy,\n      role: 'owner',\n    });\n\n    return budget;\n  }\n\n  async getSharedBudget(id: string): Promise<SharedBudget | undefined> {\n    const [budget] = await db\n      .select()\n      .from(sharedBudgets)\n      .where(eq(sharedBudgets.id, id));\n\n    return budget || undefined;\n  }\n\n  async getSharedBudgetsByUserId(userId: string): Promise<Array<SharedBudget & { members: Array<SafeUser> }>> {\n    // Get budgets where user is a member\n    const budgetsWithMembers = await db\n      .select({\n        id: sharedBudgets.id,\n        name: sharedBudgets.name,\n        description: sharedBudgets.description,\n        totalBudget: sharedBudgets.totalBudget,\n        currentSpent: sharedBudgets.currentSpent,\n        period: sharedBudgets.period,\n        createdBy: sharedBudgets.createdBy,\n        linkedGoalId: sharedBudgets.linkedGoalId,\n        status: sharedBudgets.status,\n        createdAt: sharedBudgets.createdAt,\n        updatedAt: sharedBudgets.updatedAt,\n      })\n      .from(sharedBudgets)\n      .innerJoin(sharedBudgetMembers, eq(sharedBudgets.id, sharedBudgetMembers.budgetId))\n      .where(eq(sharedBudgetMembers.userId, userId));\n\n    // For each budget, fetch all members\n    const results = await Promise.all(\n      budgetsWithMembers.map(async (budget) => {\n        const members = await this.getSharedBudgetMembers(budget.id);\n        return {\n          ...budget,\n          members: members.map(m => m.user),\n        };\n      })\n    );\n\n    return results;\n  }\n\n  async updateSharedBudget(id: string, updates: Partial<SharedBudget>): Promise<SharedBudget> {\n    const [budget] = await db\n      .update(sharedBudgets)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(sharedBudgets.id, id))\n      .returning();\n\n    return budget;\n  }\n\n  async deleteSharedBudget(id: string): Promise<void> {\n    await db.delete(sharedBudgets).where(eq(sharedBudgets.id, id));\n  }\n\n  async addSharedBudgetMember(insertMember: InsertSharedBudgetMember): Promise<SharedBudgetMember> {\n    const [member] = await db\n      .insert(sharedBudgetMembers)\n      .values(insertMember)\n      .returning();\n\n    return member;\n  }\n\n  async getSharedBudgetMembers(budgetId: string): Promise<Array<SharedBudgetMember & { user: SafeUser }>> {\n    const members = await db\n      .select({\n        id: sharedBudgetMembers.id,\n        budgetId: sharedBudgetMembers.budgetId,\n        userId: sharedBudgetMembers.userId,\n        role: sharedBudgetMembers.role,\n        joinedAt: sharedBudgetMembers.joinedAt,\n        user: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n      })\n      .from(sharedBudgetMembers)\n      .innerJoin(users, eq(sharedBudgetMembers.userId, users.id))\n      .where(eq(sharedBudgetMembers.budgetId, budgetId));\n\n    return members;\n  }\n\n  async removeSharedBudgetMember(budgetId: string, userId: string): Promise<void> {\n    await db\n      .delete(sharedBudgetMembers)\n      .where(and(\n        eq(sharedBudgetMembers.budgetId, budgetId),\n        eq(sharedBudgetMembers.userId, userId)\n      ));\n  }\n\n  async createSharedBudgetExpense(insertExpense: InsertSharedBudgetExpense): Promise<SharedBudgetExpense> {\n    const [expense] = await db\n      .insert(sharedBudgetExpenses)\n      .values(insertExpense)\n      .returning();\n\n    // Update budget's current spent amount\n    const budget = await this.getSharedBudget(insertExpense.budgetId);\n    if (budget) {\n      const currentSpent = parseFloat(budget.currentSpent?.toString() || '0');\n      const expenseAmount = parseFloat(expense.amount.toString());\n      await this.updateSharedBudget(insertExpense.budgetId, {\n        currentSpent: (currentSpent + expenseAmount).toString(),\n      });\n    }\n\n    return expense;\n  }\n\n  async getSharedBudgetExpenses(budgetId: string): Promise<Array<SharedBudgetExpense & { user: SafeUser }>> {\n    const expenses = await db\n      .select({\n        id: sharedBudgetExpenses.id,\n        budgetId: sharedBudgetExpenses.budgetId,\n        userId: sharedBudgetExpenses.userId,\n        amount: sharedBudgetExpenses.amount,\n        category: sharedBudgetExpenses.category,\n        description: sharedBudgetExpenses.description,\n        date: sharedBudgetExpenses.date,\n        createdAt: sharedBudgetExpenses.createdAt,\n        user: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n      })\n      .from(sharedBudgetExpenses)\n      .innerJoin(users, eq(sharedBudgetExpenses.userId, users.id))\n      .where(eq(sharedBudgetExpenses.budgetId, budgetId))\n      .orderBy(desc(sharedBudgetExpenses.date));\n\n    return expenses;\n  }\n\n  async updateSharedBudgetExpense(id: string, updates: Partial<SharedBudgetExpense>): Promise<SharedBudgetExpense> {\n    // Get old expense to adjust budget\n    const [oldExpense] = await db\n      .select()\n      .from(sharedBudgetExpenses)\n      .where(eq(sharedBudgetExpenses.id, id));\n\n    const [expense] = await db\n      .update(sharedBudgetExpenses)\n      .set(updates)\n      .where(eq(sharedBudgetExpenses.id, id))\n      .returning();\n\n    // Adjust budget if amount changed\n    if (updates.amount && oldExpense) {\n      const budget = await this.getSharedBudget(oldExpense.budgetId);\n      if (budget) {\n        const currentSpent = parseFloat(budget.currentSpent?.toString() || '0');\n        const oldAmount = parseFloat(oldExpense.amount.toString());\n        const newAmount = parseFloat(updates.amount.toString());\n        const diff = newAmount - oldAmount;\n        await this.updateSharedBudget(oldExpense.budgetId, {\n          currentSpent: (currentSpent + diff).toString(),\n        });\n      }\n    }\n\n    return expense;\n  }\n\n  async deleteSharedBudgetExpense(id: string): Promise<void> {\n    // Get expense to adjust budget\n    const [expense] = await db\n      .select()\n      .from(sharedBudgetExpenses)\n      .where(eq(sharedBudgetExpenses.id, id));\n\n    if (expense) {\n      const budget = await this.getSharedBudget(expense.budgetId);\n      if (budget) {\n        const currentSpent = parseFloat(budget.currentSpent?.toString() || '0');\n        const expenseAmount = parseFloat(expense.amount.toString());\n        await this.updateSharedBudget(expense.budgetId, {\n          currentSpent: (currentSpent - expenseAmount).toString(),\n        });\n      }\n    }\n\n    await db.delete(sharedBudgetExpenses).where(eq(sharedBudgetExpenses.id, id));\n  }\n\n  // Friend Group Invitations methods\n  async createFriendGroupInvitation(insertInvitation: InsertFriendGroupInvitation): Promise<FriendGroupInvitation> {\n    const [invitation] = await db\n      .insert(friendGroupInvitations)\n      .values(insertInvitation)\n      .returning();\n\n    return invitation;\n  }\n\n  async getFriendGroupInvitations(userId: string): Promise<Array<FriendGroupInvitation & { group: Group; invitedBy: SafeUser }>> {\n    const invitations = await db\n      .select({\n        id: friendGroupInvitations.id,\n        groupId: friendGroupInvitations.groupId,\n        invitedBy: users.id,\n        invitedUserId: friendGroupInvitations.invitedUserId,\n        role: friendGroupInvitations.role,\n        status: friendGroupInvitations.status,\n        message: friendGroupInvitations.message,\n        createdAt: friendGroupInvitations.createdAt,\n        respondedAt: friendGroupInvitations.respondedAt,\n        group: groups,\n        invitedByUser: {\n          id: users.id,\n          email: users.email,\n          firstName: users.firstName,\n          lastName: users.lastName,\n          profileImageUrl: users.profileImageUrl,\n          createdAt: users.createdAt,\n          updatedAt: users.updatedAt,\n        },\n      })\n      .from(friendGroupInvitations)\n      .innerJoin(groups, eq(friendGroupInvitations.groupId, groups.id))\n      .innerJoin(users, eq(friendGroupInvitations.invitedBy, users.id))\n      .where(eq(friendGroupInvitations.invitedUserId, userId));\n\n    return invitations.map(inv => ({\n      id: inv.id,\n      groupId: inv.groupId,\n      invitedBy: inv.invitedByUser,\n      invitedUserId: inv.invitedUserId,\n      role: inv.role,\n      status: inv.status,\n      message: inv.message,\n      createdAt: inv.createdAt,\n      respondedAt: inv.respondedAt,\n      group: inv.group,\n    })) as any;\n  }\n\n  async updateFriendGroupInvitationStatus(id: string, status: 'accepted' | 'declined'): Promise<FriendGroupInvitation> {\n    const [invitation] = await db\n      .update(friendGroupInvitations)\n      .set({ status, respondedAt: new Date() })\n      .where(eq(friendGroupInvitations.id, id))\n      .returning();\n\n    // If accepted, add user to group\n    if (status === 'accepted') {\n      await this.addGroupMember({\n        groupId: invitation.groupId,\n        userId: invitation.invitedUserId,\n        role: invitation.role,\n      });\n    }\n\n    return invitation;\n  }\n\n  async deleteFriendGroupInvitation(id: string): Promise<void> {\n    await db.delete(friendGroupInvitations).where(eq(friendGroupInvitations.id, id));\n  }\n\n  async bulkInviteFriendsToGroup(groupId: string, invitedBy: string, friendIds: string[], role?: string): Promise<FriendGroupInvitation[]> {\n    const invitationRole: 'admin' | 'member' = role === 'admin' ? 'admin' : 'member';\n    \n    const invitationsData = friendIds.map(friendId => ({\n      groupId,\n      invitedBy,\n      invitedUserId: friendId,\n      role: invitationRole,\n      status: 'pending' as const,\n    }));\n\n    const invitations = await db\n      .insert(friendGroupInvitations)\n      .values(invitationsData)\n      .onConflictDoNothing()\n      .returning();\n\n    return invitations;\n  }\n\n  // RSVP methods\n  async updateEventRSVP(eventId: string, userId: string, status: 'yes' | 'no' | 'maybe'): Promise<Event> {\n    const event = await this.getEvent(eventId);\n    if (!event) {\n      throw new Error(\"Event not found\");\n    }\n\n    // Parse current attendees\n    let attendees = Array.isArray(event.attendees) ? event.attendees : [];\n    \n    // Find existing RSVP\n    const existingIndex = attendees.findIndex((a: any) => a.userId === userId);\n    \n    if (existingIndex >= 0) {\n      // Update existing RSVP\n      attendees[existingIndex] = { userId, status };\n    } else {\n      // Add new RSVP\n      attendees.push({ userId, status });\n    }\n\n    // Update event with new attendees\n    return await this.updateEvent(eventId, { attendees });\n  }\n\n  // Event expense methods\n  async getEventExpense(id: string): Promise<EventExpense | undefined> {\n    const [expense] = await db.select().from(eventExpenses).where(eq(eventExpenses.id, id));\n    return expense || undefined;\n  }\n\n  async getEventExpensesByEventId(eventId: string): Promise<EventExpense[]> {\n    return await db.select().from(eventExpenses).where(eq(eventExpenses.eventId, eventId)).orderBy(desc(eventExpenses.date));\n  }\n\n  async createEventExpense(insertExpense: InsertEventExpense): Promise<EventExpense> {\n    const [expense] = await db\n      .insert(eventExpenses)\n      .values({\n        ...insertExpense,\n        description: insertExpense.description || null,\n        category: insertExpense.category || null,\n        receiptUrl: insertExpense.receiptUrl || null,\n      })\n      .returning();\n\n    // Update the event's actualCost\n    const event = await this.getEvent(insertExpense.eventId);\n    if (event) {\n      const currentCost = parseFloat(event.actualCost?.toString() || \"0\");\n      const newCost = currentCost + parseFloat(expense.amount.toString());\n      await this.updateEvent(insertExpense.eventId, { actualCost: newCost.toString() });\n    }\n\n    return expense;\n  }\n\n  async updateEventExpense(id: string, updates: Partial<EventExpense>): Promise<EventExpense> {\n    const oldExpense = await this.getEventExpense(id);\n    if (!oldExpense) {\n      throw new Error(\"Expense not found\");\n    }\n\n    const [expense] = await db\n      .update(eventExpenses)\n      .set(updates)\n      .where(eq(eventExpenses.id, id))\n      .returning();\n\n    // If amount changed, update event's actualCost\n    if (updates.amount) {\n      const event = await this.getEvent(oldExpense.eventId);\n      if (event) {\n        const currentCost = parseFloat(event.actualCost?.toString() || \"0\");\n        const oldAmount = parseFloat(oldExpense.amount.toString());\n        const newAmount = parseFloat(updates.amount.toString());\n        const newCost = currentCost - oldAmount + newAmount;\n        await this.updateEvent(oldExpense.eventId, { actualCost: newCost.toString() });\n      }\n    }\n\n    return expense;\n  }\n\n  async deleteEventExpense(id: string): Promise<void> {\n    const expense = await this.getEventExpense(id);\n    if (expense) {\n      // Update event's actualCost\n      const event = await this.getEvent(expense.eventId);\n      if (event) {\n        const currentCost = parseFloat(event.actualCost?.toString() || \"0\");\n        const expenseAmount = parseFloat(expense.amount.toString());\n        const newCost = Math.max(0, currentCost - expenseAmount);\n        await this.updateEvent(expense.eventId, { actualCost: newCost.toString() });\n      }\n    }\n    \n    await db.delete(eventExpenses).where(eq(eventExpenses.id, id));\n  }\n\n  // Event expense share methods\n  async getEventExpenseShare(id: string): Promise<EventExpenseShare | undefined> {\n    const [share] = await db.select().from(eventExpenseShares).where(eq(eventExpenseShares.id, id));\n    return share || undefined;\n  }\n\n  async getEventExpenseSharesByExpenseId(expenseId: string): Promise<EventExpenseShare[]> {\n    return await db.select().from(eventExpenseShares).where(eq(eventExpenseShares.expenseId, expenseId));\n  }\n\n  async createEventExpenseShare(insertShare: InsertEventExpenseShare): Promise<EventExpenseShare> {\n    const [share] = await db\n      .insert(eventExpenseShares)\n      .values(insertShare)\n      .returning();\n    return share;\n  }\n\n  async updateEventExpenseShare(id: string, updates: Partial<EventExpenseShare>): Promise<EventExpenseShare> {\n    const [share] = await db\n      .update(eventExpenseShares)\n      .set(updates)\n      .where(eq(eventExpenseShares.id, id))\n      .returning();\n    return share;\n  }\n\n  async deleteEventExpenseShare(id: string): Promise<void> {\n    await db.delete(eventExpenseShares).where(eq(eventExpenseShares.id, id));\n  }\n\n  // Event financial summary methods\n  async getEventFinancialSummary(eventId: string): Promise<{\n    budget: number | null;\n    totalExpenses: number;\n    expensesByCategory: Record<string, number>;\n    unpaidShares: number;\n    expenseShares: Array<{\n      userId: string;\n      totalOwed: number;\n      totalPaid: number;\n    }>;\n  }> {\n    // Get event budget\n    const event = await this.getEvent(eventId);\n    const budget = event?.budget ? parseFloat(event.budget.toString()) : null;\n\n    // Get all expenses for this event\n    const expenses = await this.getEventExpensesByEventId(eventId);\n    const totalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount.toString()), 0);\n\n    // Group expenses by category\n    const expensesByCategory: Record<string, number> = {};\n    expenses.forEach(expense => {\n      const category = expense.category || 'Other';\n      expensesByCategory[category] = (expensesByCategory[category] || 0) + parseFloat(expense.amount.toString());\n    });\n\n    // Get all expense shares\n    const allShares = await db\n      .select()\n      .from(eventExpenseShares)\n      .innerJoin(eventExpenses, eq(eventExpenseShares.expenseId, eventExpenses.id))\n      .where(eq(eventExpenses.eventId, eventId));\n\n    // Calculate unpaid shares total\n    const unpaidShares = allShares\n      .filter(({ event_expense_shares }) => !event_expense_shares.isPaid)\n      .reduce((sum, { event_expense_shares }) => sum + parseFloat(event_expense_shares.shareAmount.toString()), 0);\n\n    // Group shares by user\n    const userShares: Record<string, { totalOwed: number; totalPaid: number }> = {};\n    allShares.forEach(({ event_expense_shares }) => {\n      const userId = event_expense_shares.userId;\n      if (!userShares[userId]) {\n        userShares[userId] = { totalOwed: 0, totalPaid: 0 };\n      }\n      const shareAmount = parseFloat(event_expense_shares.shareAmount.toString());\n      userShares[userId].totalOwed += shareAmount;\n      if (event_expense_shares.isPaid) {\n        userShares[userId].totalPaid += shareAmount;\n      }\n    });\n\n    const expenseShares = Object.entries(userShares).map(([userId, { totalOwed, totalPaid }]) => ({\n      userId,\n      totalOwed,\n      totalPaid,\n    }));\n\n    return {\n      budget,\n      totalExpenses,\n      expensesByCategory,\n      unpaidShares,\n      expenseShares,\n    };\n  }\n\n  // User settings methods\n  async getUserSettings(userId: string): Promise<UserSettings | undefined> {\n    const [settings] = await db.select().from(userSettings).where(eq(userSettings.userId, userId));\n    return settings || undefined;\n  }\n\n  async createUserSettings(insertSettings: InsertUserSettings): Promise<UserSettings> {\n    const [settings] = await db\n      .insert(userSettings)\n      .values({\n        ...insertSettings,\n        currency: insertSettings.currency || \"USD\",\n        workHoursPerWeek: insertSettings.workHoursPerWeek || 40,\n        timeValueStrategy: insertSettings.timeValueStrategy || \"fixed\",\n      })\n      .returning();\n    return settings;\n  }\n\n  async updateUserSettings(userId: string, updates: Partial<UserSettings>): Promise<UserSettings> {\n    const [settings] = await db\n      .update(userSettings)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userSettings.userId, userId))\n      .returning();\n    return settings;\n  }\n\n  // Time tracking methods\n  async createTimeLog(insertTimeLog: InsertEventTimeLog): Promise<EventTimeLog> {\n    const [timeLog] = await db\n      .insert(eventTimeLogs)\n      .values({\n        ...insertTimeLog,\n        notes: insertTimeLog.notes || null,\n      })\n      .returning();\n    \n    // Update event's actual duration if this log is completed\n    if (timeLog.endedAt && timeLog.durationMinutes) {\n      const event = await this.getEvent(insertTimeLog.eventId);\n      if (event) {\n        const currentDuration = event.actualDurationMinutes || 0;\n        const newDuration = currentDuration + timeLog.durationMinutes;\n        await this.updateEvent(insertTimeLog.eventId, { \n          actualDurationMinutes: newDuration,\n          timeTracked: true\n        });\n      }\n    }\n    \n    return timeLog;\n  }\n\n  async getEventTimeLogs(eventId: string): Promise<EventTimeLog[]> {\n    return await db.select().from(eventTimeLogs).where(eq(eventTimeLogs.eventId, eventId));\n  }\n\n  async getUserTimeLogs(userId: string, startDate?: Date, endDate?: Date): Promise<EventTimeLog[]> {\n    if (startDate && endDate) {\n      return await db.select().from(eventTimeLogs).where(\n        and(\n          eq(eventTimeLogs.userId, userId),\n          gte(eventTimeLogs.startedAt, startDate),\n          lte(eventTimeLogs.startedAt, endDate)\n        )\n      );\n    }\n    \n    return await db.select().from(eventTimeLogs).where(eq(eventTimeLogs.userId, userId));\n  }\n\n  async updateTimeLog(id: string, updates: Partial<EventTimeLog>): Promise<EventTimeLog> {\n    const [timeLog] = await db\n      .update(eventTimeLogs)\n      .set(updates)\n      .where(eq(eventTimeLogs.id, id))\n      .returning();\n    return timeLog;\n  }\n\n  async deleteTimeLog(id: string): Promise<void> {\n    await db.delete(eventTimeLogs).where(eq(eventTimeLogs.id, id));\n  }\n\n  // Time-value insights methods\n  async getTimeValueInsights(userId: string, range: '7d' | '30d' | '90d'): Promise<{\n    totalTimeHours: number;\n    timeValue: number;\n    totalCost: number;\n    netImpact: number;\n    topCategories: Array<{ category: string; timeHours: number; value: number }>;\n    upcomingHighImpact: Array<{ eventId: string; title: string; estimatedValue: number }>;\n  }> {\n    // Get user settings for hourly rate\n    const settings = await this.getUserSettings(userId);\n    const hourlyRate = settings?.hourlyRate ? parseFloat(settings.hourlyRate.toString()) : 50;\n    \n    // Calculate date range\n    const days = range === '7d' ? 7 : range === '30d' ? 30 : 90;\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n    \n    // Get time logs for the period\n    const timeLogs = await this.getUserTimeLogs(userId, startDate, new Date());\n    const totalTimeMinutes = timeLogs.reduce((sum, log) => sum + (log.durationMinutes || 0), 0);\n    const totalTimeHours = totalTimeMinutes / 60;\n    const timeValue = totalTimeHours * hourlyRate;\n    \n    // Get user's events and calculate total costs\n    const userEvents = await this.getEventsByUserId(userId);\n    const recentEvents = userEvents.filter(event => \n      event.createdAt && new Date(event.createdAt) >= startDate\n    );\n    const totalCost = recentEvents.reduce((sum, event) => \n      sum + parseFloat(event.actualCost?.toString() || \"0\"), 0\n    );\n    \n    const netImpact = timeValue - totalCost;\n    \n    // Calculate top categories (simplified - using event descriptions as categories)\n    const categoryMap: Record<string, { timeHours: number; value: number }> = {};\n    for (const log of timeLogs) {\n      const event = userEvents.find(e => e.id === log.eventId);\n      const category = event?.description || \"Other\";\n      const hours = (log.durationMinutes || 0) / 60;\n      const value = hours * hourlyRate;\n      \n      if (!categoryMap[category]) {\n        categoryMap[category] = { timeHours: 0, value: 0 };\n      }\n      categoryMap[category].timeHours += hours;\n      categoryMap[category].value += value;\n    }\n    \n    const topCategories = Object.entries(categoryMap)\n      .map(([category, data]) => ({ category, ...data }))\n      .sort((a, b) => b.value - a.value)\n      .slice(0, 5);\n    \n    // Get upcoming high-impact events (with high budgets or long durations)\n    const upcomingEvents = userEvents.filter(event => \n      new Date(event.startTime) > new Date()\n    );\n    const upcomingHighImpact = upcomingEvents\n      .map(event => {\n        const budget = parseFloat(event.budget?.toString() || \"0\");\n        const plannedMinutes = event.plannedDurationMinutes || 60; // default 1 hour\n        const estimatedValue = (plannedMinutes / 60) * hourlyRate + budget;\n        return {\n          eventId: event.id,\n          title: event.title,\n          estimatedValue\n        };\n      })\n      .sort((a, b) => b.estimatedValue - a.estimatedValue)\n      .slice(0, 5);\n    \n    return {\n      totalTimeHours,\n      timeValue,\n      totalCost,\n      netImpact,\n      topCategories,\n      upcomingHighImpact,\n    };\n  }\n\n  async calculateEventTimeValue(eventId: string, userId: string): Promise<{\n    plannedTimeValue: number;\n    actualTimeValue: number;\n    totalImpact: number;\n  }> {\n    const event = await this.getEvent(eventId);\n    const settings = await this.getUserSettings(userId);\n    const hourlyRate = settings?.hourlyRate ? parseFloat(settings.hourlyRate.toString()) : 50;\n    \n    if (!event) {\n      return { plannedTimeValue: 0, actualTimeValue: 0, totalImpact: 0 };\n    }\n    \n    const plannedMinutes = event.plannedDurationMinutes || \n      ((new Date(event.endTime).getTime() - new Date(event.startTime).getTime()) / (1000 * 60));\n    const actualMinutes = event.actualDurationMinutes || 0;\n    \n    const plannedTimeValue = (plannedMinutes / 60) * hourlyRate;\n    const actualTimeValue = (actualMinutes / 60) * hourlyRate;\n    const actualCost = parseFloat(event.actualCost?.toString() || \"0\");\n    const totalImpact = actualTimeValue + actualCost;\n    \n    return {\n      plannedTimeValue,\n      actualTimeValue,\n      totalImpact,\n    };\n  }\n\n  // Notification methods\n  async getNotification(id: string): Promise<Notification | undefined> {\n    const [notification] = await db.select().from(notifications).where(eq(notifications.id, id));\n    return notification || undefined;\n  }\n\n  async getNotificationsByUserId(userId: string, limit: number = 50, offset: number = 0, includeRead: boolean = true): Promise<Notification[]> {\n    if (!includeRead) {\n      return await db\n        .select()\n        .from(notifications)\n        .where(and(eq(notifications.userId, userId), eq(notifications.isRead, false)))\n        .orderBy(desc(notifications.createdAt))\n        .limit(limit)\n        .offset(offset);\n    }\n\n    return await db\n      .select()\n      .from(notifications)\n      .where(eq(notifications.userId, userId))\n      .orderBy(desc(notifications.createdAt))\n      .limit(limit)\n      .offset(offset);\n  }\n\n  async getUnreadNotificationCount(userId: string): Promise<number> {\n    const [result] = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(notifications)\n      .where(and(eq(notifications.userId, userId), eq(notifications.isRead, false)));\n    \n    return result?.count || 0;\n  }\n\n  async createNotification(insertNotification: InsertNotification): Promise<Notification> {\n    const [notification] = await db\n      .insert(notifications)\n      .values({\n        ...insertNotification,\n        actionType: insertNotification.actionType || null,\n        actionData: insertNotification.actionData || {},\n        data: insertNotification.data || {},\n      })\n      .returning();\n    return notification;\n  }\n\n  async markNotificationAsRead(id: string): Promise<Notification> {\n    const [notification] = await db\n      .update(notifications)\n      .set({ \n        isRead: true, \n        readAt: new Date() \n      })\n      .where(eq(notifications.id, id))\n      .returning();\n    return notification;\n  }\n\n  async markAllNotificationsAsRead(userId: string): Promise<void> {\n    await db\n      .update(notifications)\n      .set({ \n        isRead: true, \n        readAt: new Date() \n      })\n      .where(and(eq(notifications.userId, userId), eq(notifications.isRead, false)));\n  }\n\n  async deleteNotification(id: string): Promise<void> {\n    await db.delete(notifications).where(eq(notifications.id, id));\n  }\n\n  async archiveNotification(id: string): Promise<Notification> {\n    const [notification] = await db\n      .update(notifications)\n      .set({ isArchived: true })\n      .where(eq(notifications.id, id))\n      .returning();\n    return notification;\n  }\n\n  // Smart notification generation\n  async generateSmartNotifications(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    \n    // Check various conditions and generate notifications\n    const dailyBriefing = await this.generateDailyBriefing(userId);\n    const deadlineNotifications = await this.checkGoalDeadlines(userId);\n    const transactionNotifications = await this.checkTransactionReminders(userId);\n    const budgetNotifications = await this.checkBudgetWarnings(userId);\n    const completionNotifications = await this.checkGoalCompletions(userId);\n    const riskAlerts = await this.checkFinancialRisks(userId);\n\n    if (dailyBriefing) newNotifications.push(dailyBriefing);\n    newNotifications.push(...deadlineNotifications);\n    newNotifications.push(...transactionNotifications);\n    newNotifications.push(...budgetNotifications);\n    newNotifications.push(...completionNotifications);\n    newNotifications.push(...riskAlerts);\n\n    return newNotifications;\n  }\n\n  async generateDailyBriefing(userId: string): Promise<Notification | null> {\n    // Check if we've already sent a daily briefing today\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    // Query for daily briefings created today (not just last 10)\n    const todaysBriefings = await db\n      .select()\n      .from(notifications)\n      .where(\n        and(\n          eq(notifications.userId, userId),\n          eq(notifications.type, 'daily_briefing'),\n          gte(notifications.createdAt, today)\n        )\n      )\n      .limit(1);\n\n    if (todaysBriefings.length > 0) return null;\n\n    // Get financial data\n    const transactions = await this.getTransactionsByUserId(userId, 100);\n    const goals = await this.getFinancialGoalsByUserId(userId);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n\n    const totalIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n    \n    const totalExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n\n    const netSavings = totalIncome - totalExpenses;\n    const savingsRate = totalIncome > 0 ? (netSavings / totalIncome) * 100 : 0;\n\n    const activeGoals = goals.filter(g => g.status === 'active').length;\n    const completedGoals = goals.filter(g => g.status === 'completed').length;\n\n    // Generate intelligent briefing based on financial state\n    let title = '';\n    let message = '';\n    let priority: 'low' | 'normal' | 'high' | 'urgent' = 'normal';\n\n    if (savingsRate >= 20) {\n      title = 'Financial Health: Strong';\n      message = `Your savings rate is ${savingsRate.toFixed(0)}%, well above the recommended 20%. You're on track with ${activeGoals} active goals. Net savings this month: $${netSavings.toFixed(2)}.`;\n      priority = 'low';\n    } else if (savingsRate >= 10) {\n      title = 'Financial Health: Good';\n      message = `Your savings rate is ${savingsRate.toFixed(0)}%. Consider increasing to 20% for stronger financial security. Net savings this month: $${netSavings.toFixed(2)}.`;\n      priority = 'normal';\n    } else if (savingsRate >= 0) {\n      title = 'Financial Health: Needs Attention';\n      message = `Your savings rate is ${savingsRate.toFixed(0)}%, below the recommended 20%. Review your expenses to identify savings opportunities. Net savings this month: $${netSavings.toFixed(2)}.`;\n      priority = 'high';\n    } else {\n      title = 'Financial Alert: Negative Cash Flow';\n      message = `You're spending $${Math.abs(netSavings).toFixed(2)} more than you're earning this month. Immediate action needed to prevent debt accumulation.`;\n      priority = 'urgent';\n    }\n\n    return await this.createNotification({\n      userId,\n      type: 'daily_briefing',\n      title,\n      message,\n      priority,\n      category: 'suggestions',\n      data: { \n        savingsRate,\n        totalIncome,\n        totalExpenses,\n        netSavings,\n        activeGoals,\n        completedGoals\n      },\n      actionType: 'view_transactions',\n      actionData: { period: '30d' }\n    });\n  }\n\n  async checkFinancialRisks(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    const transactions = await this.getTransactionsByUserId(userId, 100);\n    const goals = await this.getFinancialGoalsByUserId(userId);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n\n    // Risk 1: High expense volatility (spending varies drastically)\n    const weeklyExpenses: number[] = [];\n    for (let i = 0; i < 4; i++) {\n      const weekStart = new Date(Date.now() - (i + 1) * 7 * 24 * 60 * 60 * 1000);\n      const weekEnd = new Date(Date.now() - i * 7 * 24 * 60 * 60 * 1000);\n      const weekExpense = transactions\n        .filter(t => {\n          const tDate = new Date(t.date);\n          return t.type === 'expense' && tDate >= weekStart && tDate < weekEnd;\n        })\n        .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n      weeklyExpenses.push(weekExpense);\n    }\n\n    if (weeklyExpenses.length >= 3) {\n      const avgWeekly = weeklyExpenses.reduce((a, b) => a + b, 0) / weeklyExpenses.length;\n      const maxDeviation = Math.max(...weeklyExpenses.map(w => Math.abs(w - avgWeekly)));\n      const volatilityPercent = avgWeekly > 0 ? (maxDeviation / avgWeekly) * 100 : 0;\n\n      if (volatilityPercent > 50 && avgWeekly > 100) {\n        newNotifications.push(await this.createNotification({\n          userId,\n          type: 'risk_alert',\n          title: 'Risk Alert: Irregular Spending Pattern',\n          message: `Your weekly expenses vary by up to ${volatilityPercent.toFixed(0)}%. Establishing a consistent budget can improve financial stability.`,\n          priority: 'normal',\n          category: 'budget',\n          data: { volatilityPercent, avgWeekly, weeklyExpenses },\n          actionType: 'view_transactions',\n          actionData: { period: '30d' }\n        }));\n      }\n    }\n\n    // Risk 2: No emergency fund with active expenses\n    const totalIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n    const totalExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n    \n    const hasEmergencyGoal = goals.some(g => \n      g.status === 'active' && \n      (g.title.toLowerCase().includes('emergency') || g.category?.toLowerCase().includes('emergency'))\n    );\n\n    if (!hasEmergencyGoal && totalExpenses > 1000) {\n      const recommendedFund = totalExpenses; // 1 month of expenses minimum\n      newNotifications.push(await this.createNotification({\n        userId,\n        type: 'risk_alert',\n        title: 'Risk Alert: No Emergency Fund',\n        message: `You don't have an emergency fund goal. Financial experts recommend saving at least $${recommendedFund.toFixed(2)} (one month of expenses) for unexpected costs.`,\n        priority: 'high',\n        category: 'suggestions',\n        data: { recommendedFund, monthlyExpenses: totalExpenses },\n        actionType: 'create_goal',\n        actionData: { \n          title: 'Emergency Fund',\n          targetAmount: recommendedFund,\n          category: 'emergency'\n        }\n      }));\n    }\n\n    return newNotifications;\n  }\n\n  async checkGoalDeadlines(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    const goals = await this.getFinancialGoalsByUserId(userId);\n    const now = new Date();\n\n    for (const goal of goals) {\n      if (goal.status !== 'active') continue;\n\n      const targetDate = new Date(goal.targetDate);\n      const daysUntilDeadline = Math.ceil((targetDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n      const currentAmount = parseFloat(goal.currentAmount || \"0\");\n      const targetAmount = parseFloat(goal.targetAmount.toString());\n      const progressPercent = (currentAmount / targetAmount) * 100;\n\n      // Check if goal is close to deadline but far from target\n      if (daysUntilDeadline <= 30 && daysUntilDeadline > 0 && progressPercent < 50) {\n        const remainingAmount = targetAmount - currentAmount;\n        const suggestedDaily = remainingAmount / daysUntilDeadline;\n\n        const notification = await this.createNotification({\n          userId,\n          type: 'goal_deadline',\n          title: `Goal \"${goal.title}\" needs attention`,\n          message: `Only ${daysUntilDeadline} days left and you're ${progressPercent.toFixed(0)}% complete. Consider adding $${suggestedDaily.toFixed(2)} daily to reach your goal.`,\n          priority: 'high',\n          category: 'goals',\n          data: { goalId: goal.id, daysUntilDeadline, progressPercent, suggestedDaily },\n          actionType: 'add_transaction',\n          actionData: { goalId: goal.id, amount: suggestedDaily, type: 'transfer' }\n        });\n\n        newNotifications.push(notification);\n      }\n    }\n\n    return newNotifications;\n  }\n\n  async checkTransactionReminders(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    const recentTransactions = await this.getTransactionsByUserId(userId, 10);\n    const now = new Date();\n\n    // Check if no transactions in the last 7 days\n    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    const recentTransactionInLast7Days = recentTransactions.some(t => \n      new Date(t.date) >= sevenDaysAgo\n    );\n\n    if (!recentTransactionInLast7Days) {\n      const notification = await this.createNotification({\n        userId,\n        type: 'transaction_reminder',\n        title: `Don't forget to track your expenses`,\n        message: `You haven't added any transactions in the last 7 days. Keep track of your spending to stay on top of your financial goals.`,\n        priority: 'normal',\n        category: 'transactions',\n        data: { daysSinceLastTransaction: 7 },\n        actionType: 'add_transaction',\n        actionData: { type: 'expense' }\n      });\n\n      newNotifications.push(notification);\n    }\n\n    return newNotifications;\n  }\n\n  async checkBudgetWarnings(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    \n    // Get income and expenses for the last 30 days\n    const transactions = await this.getTransactionsByUserId(userId, 100);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n    \n    const totalIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n    \n    const totalExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n\n    // Check if expenses exceed income\n    if (totalExpenses > totalIncome && totalIncome > 0) {\n      const overspend = totalExpenses - totalIncome;\n      const overspendPercent = ((overspend / totalIncome) * 100).toFixed(0);\n\n      const notification = await this.createNotification({\n        userId,\n        type: 'budget_warning',\n        title: `Budget Alert: Spending Exceeds Income`,\n        message: `Your expenses ($${totalExpenses.toFixed(2)}) exceeded your income ($${totalIncome.toFixed(2)}) by $${overspend.toFixed(2)} (${overspendPercent}%) this month.`,\n        priority: 'urgent',\n        category: 'budget',\n        data: { totalIncome, totalExpenses, overspend, overspendPercent },\n        actionType: 'view_transactions',\n        actionData: { period: '30d' }\n      });\n\n      newNotifications.push(notification);\n    }\n\n    return newNotifications;\n  }\n\n  async checkGoalCompletions(userId: string): Promise<Notification[]> {\n    const newNotifications: Notification[] = [];\n    const goals = await this.getFinancialGoalsByUserId(userId);\n\n    for (const goal of goals) {\n      if (goal.status !== 'active') continue;\n\n      const currentAmount = parseFloat(goal.currentAmount || \"0\");\n      const targetAmount = parseFloat(goal.targetAmount.toString());\n      const progressPercent = (currentAmount / targetAmount) * 100;\n\n      // Check if goal is almost complete (90% or more)\n      if (progressPercent >= 90 && progressPercent < 100) {\n        const remainingAmount = targetAmount - currentAmount;\n\n        const notification = await this.createNotification({\n          userId,\n          type: 'goal_almost_complete',\n          title: `Almost there: \"${goal.title}\" is ${progressPercent.toFixed(0)}% complete`,\n          message: `You're so close. Just $${remainingAmount.toFixed(2)} more to reach your ${goal.title} goal.`,\n          priority: 'normal',\n          category: 'achievements',\n          data: { goalId: goal.id, progressPercent, remainingAmount },\n          actionType: 'add_transaction',\n          actionData: { goalId: goal.id, amount: remainingAmount, type: 'transfer' }\n        });\n\n        newNotifications.push(notification);\n      }\n      // Check if goal is complete\n      else if (progressPercent >= 100) {\n        const notification = await this.createNotification({\n          userId,\n          type: 'goal_complete',\n          title: `Goal completed: \"${goal.title}\"`,\n          message: `You've reached your ${goal.title} goal of $${targetAmount.toFixed(2)}. Time to set a new financial goal.`,\n          priority: 'high',\n          category: 'achievements',\n          data: { goalId: goal.id, completedAmount: targetAmount },\n          actionType: 'create_goal',\n          actionData: { suggestedAmount: targetAmount * 1.5 }\n        });\n\n        newNotifications.push(notification);\n        \n        // Mark goal as completed\n        await this.updateFinancialGoal(goal.id, { status: 'completed' });\n      }\n    }\n\n    return newNotifications;\n  }\n\n  // User preferences methods\n  async getUserPreferences(userId: string): Promise<UserPreferences | undefined> {\n    const [preferences] = await db.select().from(userPreferences).where(eq(userPreferences.userId, userId));\n    return preferences || undefined;\n  }\n\n  async createUserPreferences(insertPreferences: InsertUserPreferences): Promise<UserPreferences> {\n    const [preferences] = await db\n      .insert(userPreferences)\n      .values(insertPreferences as typeof userPreferences.$inferInsert)\n      .returning();\n    return preferences;\n  }\n\n  async updateUserPreferences(userId: string, updates: Partial<UserPreferences>): Promise<UserPreferences> {\n    const [preferences] = await db\n      .update(userPreferences)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userPreferences.userId, userId))\n      .returning();\n    return preferences;\n  }\n\n  // Financial preferences methods\n  async getFinancialPreferences(userId: string): Promise<FinancialPreferences | undefined> {\n    const [preferences] = await db.select().from(financialPreferences).where(eq(financialPreferences.userId, userId));\n    return preferences || undefined;\n  }\n\n  async createFinancialPreferences(insertPreferences: InsertFinancialPreferences): Promise<FinancialPreferences> {\n    const [preferences] = await db\n      .insert(financialPreferences)\n      .values({\n        ...insertPreferences,\n        defaultBudgetPeriod: insertPreferences.defaultBudgetPeriod || \"monthly\",\n        budgetWarningThreshold: insertPreferences.budgetWarningThreshold || 80,\n        autoSavingsFrequency: insertPreferences.autoSavingsFrequency || \"monthly\",\n        defaultGoalPriority: insertPreferences.defaultGoalPriority || \"medium\",\n        autoSavingsAmount: insertPreferences.autoSavingsAmount || \"0.00\",\n      })\n      .returning();\n    return preferences;\n  }\n\n  async updateFinancialPreferences(userId: string, updates: Partial<FinancialPreferences>): Promise<FinancialPreferences> {\n    const [preferences] = await db\n      .update(financialPreferences)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(financialPreferences.userId, userId))\n      .returning();\n    return preferences;\n  }\n\n  // Privacy settings methods\n  async getPrivacySettings(userId: string): Promise<PrivacySettings | undefined> {\n    const [settings] = await db.select().from(privacySettings).where(eq(privacySettings.userId, userId));\n    return settings || undefined;\n  }\n\n  async createPrivacySettings(insertSettings: InsertPrivacySettings): Promise<PrivacySettings> {\n    const [settings] = await db\n      .insert(privacySettings)\n      .values({\n        ...insertSettings,\n        dataRetentionPeriod: insertSettings.dataRetentionPeriod || 365,\n        profileVisibility: insertSettings.profileVisibility || \"private\",\n      })\n      .returning();\n    return settings;\n  }\n\n  async updatePrivacySettings(userId: string, updates: Partial<PrivacySettings>): Promise<PrivacySettings> {\n    const [settings] = await db\n      .update(privacySettings)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(privacySettings.userId, userId))\n      .returning();\n    return settings;\n  }\n\n  // Data export methods\n  async exportUserData(userId: string, format: 'json' | 'csv'): Promise<string> {\n    // Get all user data\n    const user = await this.getUser(userId);\n    const userSettings = await this.getUserSettings(userId);\n    const preferences = await this.getUserPreferences(userId);\n    const financialPrefs = await this.getFinancialPreferences(userId);\n    const privacySettings = await this.getPrivacySettings(userId);\n    const goals = await this.getFinancialGoalsByUserId(userId);\n    const transactions = await this.getTransactionsByUserId(userId, 1000);\n    const events = await this.getEventsByUserId(userId);\n    const groups = await this.getGroupsByUserId(userId);\n    const timeLogs = await this.getUserTimeLogs(userId);\n\n    const exportData = {\n      user,\n      userSettings,\n      preferences,\n      financialPreferences: financialPrefs,\n      privacySettings,\n      goals,\n      transactions,\n      events,\n      groups,\n      timeLogs,\n      exportedAt: new Date().toISOString()\n    };\n\n    if (format === 'json') {\n      return JSON.stringify(exportData, null, 2);\n    } else {\n      // For CSV, create a simplified flat format\n      const csvData = [\n        ['Data Type', 'Count', 'Details'],\n        ['Goals', goals.length, `Total: ${goals.length} goals`],\n        ['Transactions', transactions.length, `Total: ${transactions.length} transactions`],\n        ['Events', events.length, `Total: ${events.length} events`],\n        ['Groups', groups.length, `Total: ${groups.length} groups`],\n        ['Time Logs', timeLogs.length, `Total: ${timeLogs.length} time logs`],\n      ];\n      \n      return csvData.map(row => row.join(',')).join('\\n');\n    }\n  }\n\n  async deleteUserData(userId: string): Promise<void> {\n    // This is a critical operation - in real app would require additional confirmations\n    // Delete in reverse dependency order to avoid foreign key constraints\n    await db.delete(chatMessages).where(exists(\n      db.select().from(chatConversations)\n        .where(and(eq(chatConversations.userId, userId), eq(chatMessages.conversationId, chatConversations.id)))\n    ));\n    await db.delete(chatConversations).where(eq(chatConversations.userId, userId));\n    await db.delete(eventTimeLogs).where(eq(eventTimeLogs.userId, userId));\n    await db.delete(notifications).where(eq(notifications.userId, userId));\n    await db.delete(transactions).where(eq(transactions.userId, userId));\n    await db.delete(financialGoals).where(eq(financialGoals.userId, userId));\n    await db.delete(events).where(eq(events.createdBy, userId));\n    await db.delete(groupMembers).where(eq(groupMembers.userId, userId));\n    await db.delete(privacySettings).where(eq(privacySettings.userId, userId));\n    await db.delete(financialPreferences).where(eq(financialPreferences.userId, userId));\n    await db.delete(userPreferences).where(eq(userPreferences.userId, userId));\n    await db.delete(userSettings).where(eq(userSettings.userId, userId));\n    await db.delete(users).where(eq(users.id, userId));\n  }\n\n  // Chat methods\n  async getChatConversations(userId: string): Promise<ChatConversation[]> {\n    return db.select()\n      .from(chatConversations)\n      .where(eq(chatConversations.userId, userId))\n      .orderBy(desc(chatConversations.lastMessageAt));\n  }\n\n  async getChatConversation(conversationId: string): Promise<ChatConversation | undefined> {\n    const [conversation] = await db.select()\n      .from(chatConversations)\n      .where(eq(chatConversations.id, conversationId));\n    return conversation || undefined;\n  }\n\n  async getChatConversationWithMessages(conversationId: string): Promise<(ChatConversation & { messages: ChatMessage[] }) | undefined> {\n    const [conversation] = await db.select()\n      .from(chatConversations)\n      .where(eq(chatConversations.id, conversationId));\n    \n    if (!conversation) return undefined;\n\n    const messages = await db.select()\n      .from(chatMessages)\n      .where(eq(chatMessages.conversationId, conversationId))\n      .orderBy(chatMessages.createdAt);\n\n    return { ...conversation, messages };\n  }\n\n  async createChatConversation(conversation: InsertChatConversation): Promise<ChatConversation> {\n    const [newConversation] = await db.insert(chatConversations)\n      .values(conversation)\n      .returning();\n    return newConversation;\n  }\n\n  async updateChatConversation(id: string, updates: Partial<ChatConversation>): Promise<ChatConversation> {\n    const [updatedConversation] = await db.update(chatConversations)\n      .set(updates)\n      .where(eq(chatConversations.id, id))\n      .returning();\n    return updatedConversation;\n  }\n\n  async deleteChatConversation(id: string): Promise<void> {\n    await db.delete(chatMessages).where(eq(chatMessages.conversationId, id));\n    await db.delete(chatConversations).where(eq(chatConversations.id, id));\n  }\n\n  async getChatMessages(conversationId: string, limit = 50, offset = 0): Promise<ChatMessage[]> {\n    return db.select()\n      .from(chatMessages)\n      .where(eq(chatMessages.conversationId, conversationId))\n      .orderBy(desc(chatMessages.createdAt))\n      .limit(limit)\n      .offset(offset);\n  }\n\n  async createChatMessage(message: InsertChatMessage): Promise<ChatMessage> {\n    const [newMessage] = await db.insert(chatMessages)\n      .values(message)\n      .returning();\n\n    // Update conversation lastMessageAt\n    await db.update(chatConversations)\n      .set({ lastMessageAt: new Date() })\n      .where(eq(chatConversations.id, message.conversationId));\n\n    return newMessage;\n  }\n\n  async getChatMessagesByUserId(userId: string, limit = 100): Promise<ChatMessage[]> {\n    return db.select({\n      id: chatMessages.id,\n      conversationId: chatMessages.conversationId,\n      role: chatMessages.role,\n      content: chatMessages.content,\n      userContext: chatMessages.userContext,\n      tokenCount: chatMessages.tokenCount,\n      cost: chatMessages.cost,\n      createdAt: chatMessages.createdAt,\n    })\n      .from(chatMessages)\n      .innerJoin(chatConversations, eq(chatMessages.conversationId, chatConversations.id))\n      .where(eq(chatConversations.userId, userId))\n      .orderBy(desc(chatMessages.createdAt))\n      .limit(limit);\n  }\n\n  // Message Feedback methods\n  async getMessageFeedback(messageId: string, userId: string): Promise<MessageFeedback | undefined> {\n    const [feedback] = await db.select()\n      .from(messageFeedback)\n      .where(and(\n        eq(messageFeedback.messageId, messageId),\n        eq(messageFeedback.userId, userId)\n      ))\n      .limit(1);\n    return feedback;\n  }\n\n  async createMessageFeedback(feedback: InsertMessageFeedback): Promise<MessageFeedback> {\n    const [newFeedback] = await db.insert(messageFeedback)\n      .values({\n        ...feedback,\n        updatedAt: new Date()\n      })\n      .returning();\n    return newFeedback;\n  }\n\n  async updateMessageFeedback(messageId: string, userId: string, updates: Partial<MessageFeedback>): Promise<MessageFeedback> {\n    const [updated] = await db.update(messageFeedback)\n      .set({\n        ...updates,\n        updatedAt: new Date()\n      })\n      .where(and(\n        eq(messageFeedback.messageId, messageId),\n        eq(messageFeedback.userId, userId)\n      ))\n      .returning();\n    return updated;\n  }\n\n  async getMessageFeedbackStats(userId: string): Promise<{ helpful: number; notHelpful: number; total: number }> {\n    const userFeedback = await db.select()\n      .from(messageFeedback)\n      .where(eq(messageFeedback.userId, userId));\n    \n    const helpful = userFeedback.filter(f => f.rating === 'helpful').length;\n    const notHelpful = userFeedback.filter(f => f.rating === 'not_helpful').length;\n    \n    return {\n      helpful,\n      notHelpful,\n      total: userFeedback.length\n    };\n  }\n\n  // Subscription Plan methods\n  async getSubscriptionPlans(): Promise<SubscriptionPlan[]> {\n    return db.select()\n      .from(subscriptionPlans)\n      .where(eq(subscriptionPlans.isActive, true))\n      .orderBy(subscriptionPlans.sortOrder);\n  }\n\n  async getSubscriptionPlan(id: string): Promise<SubscriptionPlan | undefined> {\n    const [plan] = await db.select()\n      .from(subscriptionPlans)\n      .where(eq(subscriptionPlans.id, id));\n    return plan;\n  }\n\n  async createSubscriptionPlan(plan: InsertSubscriptionPlan): Promise<SubscriptionPlan> {\n    const [newPlan] = await db.insert(subscriptionPlans)\n      .values(plan)\n      .returning();\n    return newPlan;\n  }\n\n  async updateSubscriptionPlan(id: string, updates: Partial<SubscriptionPlan>): Promise<SubscriptionPlan> {\n    const [updatedPlan] = await db.update(subscriptionPlans)\n      .set(updates)\n      .where(eq(subscriptionPlans.id, id))\n      .returning();\n    return updatedPlan;\n  }\n\n  // Subscription methods\n  async getUserSubscription(userId: string): Promise<(Subscription & { plan: SubscriptionPlan }) | undefined> {\n    const [result] = await db.select({\n      id: subscriptions.id,\n      userId: subscriptions.userId,\n      planId: subscriptions.planId,\n      status: subscriptions.status,\n      currentPeriodStart: subscriptions.currentPeriodStart,\n      currentPeriodEnd: subscriptions.currentPeriodEnd,\n      cancelledAt: subscriptions.cancelledAt,\n      trialEnd: subscriptions.trialEnd,\n      stripeSubscriptionId: subscriptions.stripeSubscriptionId,\n      stripeCustomerId: subscriptions.stripeCustomerId,\n      localCurrency: subscriptions.localCurrency,\n      localPrice: subscriptions.localPrice,\n      freePremium: subscriptions.freePremium,\n      createdAt: subscriptions.createdAt,\n      plan: {\n        id: subscriptionPlans.id,\n        name: subscriptionPlans.name,\n        displayName: subscriptionPlans.displayName,\n        description: subscriptionPlans.description,\n        priceThb: subscriptionPlans.priceThb,\n        priceUsd: subscriptionPlans.priceUsd,\n        stripePriceId: subscriptionPlans.stripePriceId,\n        currency: subscriptionPlans.currency,\n        billingInterval: subscriptionPlans.billingInterval,\n        scoutLimit: subscriptionPlans.scoutLimit,\n        sonnetLimit: subscriptionPlans.sonnetLimit,\n        gpt5Limit: subscriptionPlans.gpt5Limit,\n        opusLimit: subscriptionPlans.opusLimit,\n        aiChatLimit: subscriptionPlans.aiChatLimit,\n        aiDeepAnalysisLimit: subscriptionPlans.aiDeepAnalysisLimit,\n        aiInsightsFrequency: subscriptionPlans.aiInsightsFrequency,\n        isLifetimeLimit: subscriptionPlans.isLifetimeLimit,\n        features: subscriptionPlans.features,\n        isActive: subscriptionPlans.isActive,\n        sortOrder: subscriptionPlans.sortOrder,\n        createdAt: subscriptionPlans.createdAt,\n      }\n    })\n      .from(subscriptions)\n      .innerJoin(subscriptionPlans, eq(subscriptions.planId, subscriptionPlans.id))\n      .where(and(\n        eq(subscriptions.userId, userId),\n        eq(subscriptions.status, 'active')\n      ));\n    \n    return result;\n  }\n\n  async getSubscriptionByStripeId(stripeSubscriptionId: string): Promise<(Subscription & { plan: SubscriptionPlan }) | undefined> {\n    const [row] = await db.select()\n      .from(subscriptions)\n      .innerJoin(subscriptionPlans, eq(subscriptions.planId, subscriptionPlans.id))\n      .where(eq(subscriptions.stripeSubscriptionId, stripeSubscriptionId));\n    \n    if (!row) return undefined;\n    \n    return { \n      ...row.subscriptions, \n      plan: row.subscription_plans \n    };\n  }\n\n  async createSubscription(subscription: InsertSubscription): Promise<Subscription> {\n    const [newSubscription] = await db.insert(subscriptions)\n      .values(subscription)\n      .returning();\n    return newSubscription;\n  }\n\n  async updateSubscription(id: string, updates: Partial<Subscription>): Promise<Subscription> {\n    const [updatedSubscription] = await db.update(subscriptions)\n      .set(updates)\n      .where(eq(subscriptions.id, id))\n      .returning();\n    return updatedSubscription;\n  }\n\n  async cancelSubscription(id: string): Promise<Subscription> {\n    const [cancelledSubscription] = await db.update(subscriptions)\n      .set({ \n        status: 'cancelled',\n        cancelledAt: new Date()\n      })\n      .where(eq(subscriptions.id, id))\n      .returning();\n    return cancelledSubscription;\n  }\n\n  // Usage Tracking methods\n  async getUserUsage(userId: string): Promise<UsageTracking | undefined> {\n    const subscription = await this.getUserSubscription(userId);\n    \n    // For lifetime limit plans (Free), get ALL TIME usage, not just this month\n    if (subscription?.plan?.isLifetimeLimit) {\n      const [usage] = await db.select()\n        .from(usageTracking)\n        .where(eq(usageTracking.userId, userId))\n        .orderBy(desc(usageTracking.createdAt))\n        .limit(1);\n      return usage;\n    }\n    \n    // For monthly limit plans (Pro), get current month usage\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n\n    const [usage] = await db.select()\n      .from(usageTracking)\n      .where(and(\n        eq(usageTracking.userId, userId),\n        gte(usageTracking.periodStart, startOfMonth),\n        lte(usageTracking.periodEnd, endOfMonth)\n      ));\n\n    return usage;\n  }\n\n  async createUsageRecord(usage: InsertUsageTracking): Promise<UsageTracking> {\n    const [newUsage] = await db.insert(usageTracking)\n      .values(usage)\n      .returning();\n    return newUsage;\n  }\n\n  async updateUsageRecord(id: string, updates: Partial<UsageTracking>): Promise<UsageTracking> {\n    const [updatedUsage] = await db.update(usageTracking)\n      .set(updates)\n      .where(eq(usageTracking.id, id))\n      .returning();\n    return updatedUsage;\n  }\n\n  async incrementUsage(userId: string, type: 'aiChatsUsed' | 'aiDeepAnalysisUsed' | 'aiInsightsGenerated', amount = 1): Promise<UsageTracking> {\n    let usage = await this.getUserUsage(userId);\n    const subscription = await this.getUserSubscription(userId);\n    const isLifetime = subscription?.plan?.isLifetimeLimit || false;\n    \n    if (!usage) {\n      // Create new usage record\n      const now = new Date();\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n      \n      // For lifetime plans, use account creation date as start, far future as end\n      const periodStart = isLifetime ? now : startOfMonth;\n      const periodEnd = isLifetime ? new Date('2099-12-31') : endOfMonth;\n      \n      usage = await this.createUsageRecord({\n        userId,\n        subscriptionId: subscription?.id || null,\n        periodStart,\n        periodEnd,\n        aiChatsUsed: type === 'aiChatsUsed' ? amount : 0,\n        aiDeepAnalysisUsed: type === 'aiDeepAnalysisUsed' ? amount : 0,\n        aiInsightsGenerated: type === 'aiInsightsGenerated' ? amount : 0,\n      });\n    } else {\n      // Update existing usage record\n      const updates: Partial<UsageTracking> = {};\n      if (type === 'aiChatsUsed') updates.aiChatsUsed = (usage.aiChatsUsed || 0) + amount;\n      if (type === 'aiDeepAnalysisUsed') updates.aiDeepAnalysisUsed = (usage.aiDeepAnalysisUsed || 0) + amount;\n      if (type === 'aiInsightsGenerated') updates.aiInsightsGenerated = (usage.aiInsightsGenerated || 0) + amount;\n      \n      usage = await this.updateUsageRecord(usage.id, updates);\n    }\n    \n    return usage;\n  }\n\n  // Add-on methods\n  async getUserAddOns(userId: string): Promise<SubscriptionAddOn[]> {\n    const now = new Date();\n    return db.select()\n      .from(subscriptionAddOns)\n      .where(and(\n        eq(subscriptionAddOns.userId, userId),\n        eq(subscriptionAddOns.isActive, true),\n        gte(subscriptionAddOns.expiresAt, now)\n      ));\n  }\n\n  async createAddOn(addOn: InsertSubscriptionAddOn): Promise<SubscriptionAddOn> {\n    const [newAddOn] = await db.insert(subscriptionAddOns)\n      .values(addOn)\n      .returning();\n    return newAddOn;\n  }\n\n  // Subscription helpers\n  async initializeDefaultSubscription(userId: string): Promise<Subscription> {\n    // Get or create the free plan\n    let freePlan = await db.select()\n      .from(subscriptionPlans)\n      .where(eq(subscriptionPlans.name, 'Free'))\n      .limit(1);\n\n    if (freePlan.length === 0) {\n      // Create default free plan if it doesn't exist\n      const [newFreePlan] = await db.insert(subscriptionPlans)\n        .values({\n          name: 'Free',\n          displayName: 'Twealth Free',\n          description: 'Get started with 50 AI chats per month',\n          priceThb: '0.00',\n          priceUsd: '0.00',\n          currency: 'USD',\n          billingInterval: 'monthly',\n          aiChatLimit: 50,\n          aiDeepAnalysisLimit: 0,\n          aiInsightsFrequency: 'never',\n          isLifetimeLimit: false,\n          features: ['basic_tracking', 'ai_chat', 'expense_tracking'],\n          sortOrder: 0,\n        })\n        .returning();\n      freePlan = [newFreePlan];\n    } else if (freePlan[0].aiChatLimit !== 50 || freePlan[0].isLifetimeLimit) {\n      // Update existing free plan to new limit and monthly settings\n      await db.update(subscriptionPlans)\n        .set({ \n          aiChatLimit: 50,\n          isLifetimeLimit: false,\n          billingInterval: 'monthly',\n          description: 'Get started with 50 AI chats per month',\n          features: ['basic_tracking', 'ai_chat', 'expense_tracking']\n        })\n        .where(eq(subscriptionPlans.id, freePlan[0].id));\n      freePlan[0].aiChatLimit = 50;\n      freePlan[0].isLifetimeLimit = false;\n    }\n\n    const now = new Date();\n    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n\n    return this.createSubscription({\n      userId,\n      planId: freePlan[0].id,\n      status: 'active',\n      currentPeriodStart: now,\n      currentPeriodEnd: endOfMonth,\n      localCurrency: 'THB',\n      localPrice: '0.00',\n    });\n  }\n\n  async checkUsageLimit(userId: string, type: 'aiChatsUsed' | 'aiDeepAnalysisUsed'): Promise<{ allowed: boolean; usage: number; limit: number }> {\n    const subscription = await this.getUserSubscription(userId);\n    const usage = await this.getUserUsage(userId);\n    \n    if (!subscription) {\n      return { allowed: false, usage: 0, limit: 0 };\n    }\n\n    // Free premium users have unlimited access\n    if (subscription.freePremium) {\n      return {\n        allowed: true,\n        usage: usage?.[type] || 0,\n        limit: 999999 // Unlimited\n      };\n    }\n\n    const currentUsage = usage?.[type] || 0;\n    const limit = type === 'aiChatsUsed' \n      ? subscription.plan.aiChatLimit || 0\n      : subscription.plan.aiDeepAnalysisLimit || 0;\n\n    // Check add-ons for extra quota\n    const addOns = await this.getUserAddOns(userId);\n    const extraQuota = addOns\n      .filter(addon => \n        (type === 'aiChatsUsed' && addon.addOnType === 'extra_chats') ||\n        (type === 'aiDeepAnalysisUsed' && addon.addOnType === 'extra_deep_analysis')\n      )\n      .reduce((total, addon) => total + addon.quantity, 0);\n\n    const totalLimit = limit + extraQuota;\n    \n    return {\n      allowed: currentUsage < totalLimit,\n      usage: currentUsage,\n      limit: totalLimit\n    };\n  }\n\n  async resetUsage(userId: string): Promise<void> {\n    const usage = await this.getUserUsage(userId);\n    \n    if (usage) {\n      // Reset all usage counters to 0\n      await this.updateUsageRecord(usage.id, {\n        aiChatsUsed: 0,\n        aiDeepAnalysisUsed: 0,\n        aiInsightsGenerated: 0,\n      });\n    }\n  }\n\n  // Webhook idempotency methods\n  async isWebhookEventProcessed(eventId: string): Promise<boolean> {\n    const result = await db.select()\n      .from(webhookEvents)\n      .where(eq(webhookEvents.id, eventId))\n      .limit(1);\n    return result.length > 0;\n  }\n\n  async markWebhookEventProcessed(eventId: string, eventType: string): Promise<void> {\n    await db.insert(webhookEvents)\n      .values({ id: eventId, eventType })\n      .onConflictDoNothing();\n  }\n\n  async cleanupOldWebhookEvents(maxAgeHours: number): Promise<number> {\n    const cutoff = new Date(Date.now() - maxAgeHours * 60 * 60 * 1000);\n    const result = await db.delete(webhookEvents)\n      .where(lte(webhookEvents.processedAt, cutoff))\n      .returning();\n    return result.length;\n  }\n\n  // Tier-aware AI methods\n  async getUserSubscriptionWithUsage(userId: string): Promise<{ subscription: Subscription; usage: UsageTracking | null; plan: SubscriptionPlan } | null> {\n    const subscription = await this.getUserSubscription(userId);\n    if (!subscription) {\n      return null;\n    }\n\n    const usage = await this.getUserUsage(userId);\n\n    return {\n      subscription,\n      usage: usage || null,\n      plan: subscription.plan,\n    };\n  }\n\n  async incrementUsageCounters(userId: string, subscriptionId: string, modelType: 'scout' | 'sonnet' | 'gpt5' | 'opus'): Promise<void> {\n    let usage = await this.getUserUsage(userId);\n    const subscription = await this.getUserSubscription(userId);\n    const isLifetime = subscription?.plan?.isLifetimeLimit || false;\n\n    if (!usage) {\n      // Create new usage record with appropriate counters\n      const now = new Date();\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n\n      const periodStart = isLifetime ? now : startOfMonth;\n      const periodEnd = isLifetime ? new Date('2099-12-31') : endOfMonth;\n\n      await this.createUsageRecord({\n        userId,\n        subscriptionId,\n        periodStart,\n        periodEnd,\n        scoutQueriesUsed: modelType === 'scout' ? 1 : 0,\n        sonnetQueriesUsed: modelType === 'sonnet' ? 1 : 0,\n        gpt5QueriesUsed: modelType === 'gpt5' ? 1 : 0,\n        opusQueriesUsed: modelType === 'opus' ? 1 : 0,\n        aiChatsUsed: 0,\n        aiDeepAnalysisUsed: 0,\n        aiInsightsGenerated: 0,\n      });\n    } else {\n      // Update existing counters\n      const updates: Partial<UsageTracking> = {};\n      if (modelType === 'scout') {\n        updates.scoutQueriesUsed = (usage.scoutQueriesUsed || 0) + 1;\n      } else if (modelType === 'sonnet') {\n        updates.sonnetQueriesUsed = (usage.sonnetQueriesUsed || 0) + 1;\n      } else if (modelType === 'gpt5') {\n        updates.gpt5QueriesUsed = (usage.gpt5QueriesUsed || 0) + 1;\n      } else if (modelType === 'opus') {\n        updates.opusQueriesUsed = (usage.opusQueriesUsed || 0) + 1;\n      }\n\n      await this.updateUsageRecord(usage.id, updates);\n    }\n  }\n\n  async insertAIUsageLog(log: Omit<InsertAiUsageLog, 'id' | 'createdAt'>): Promise<void> {\n    await db.insert(aiUsageLogs).values(log);\n  }\n\n  // Referral methods\n  async getUserReferralCode(userId: string): Promise<ReferralCode | undefined> {\n    const [result] = await db.select()\n      .from(referralCodes)\n      .where(and(eq(referralCodes.userId, userId), eq(referralCodes.isActive, true)))\n      .limit(1);\n    return result;\n  }\n\n  async createReferralCode(referralCode: InsertReferralCode): Promise<ReferralCode> {\n    const [result] = await db.insert(referralCodes).values(referralCode).returning();\n    return result;\n  }\n\n  async getReferralByCode(code: string): Promise<ReferralCode | undefined> {\n    const [result] = await db.select()\n      .from(referralCodes)\n      .where(and(eq(referralCodes.code, code), eq(referralCodes.isActive, true)))\n      .limit(1);\n    return result;\n  }\n\n  async processReferral(referredUserId: string, referralCode: string): Promise<Referral> {\n    const referralCodeRecord = await this.getReferralByCode(referralCode);\n    if (!referralCodeRecord) {\n      throw new Error('Invalid referral code');\n    }\n\n    // Check if referral already exists\n    const [existingReferral] = await db.select()\n      .from(referrals)\n      .where(eq(referrals.referredUserId, referredUserId))\n      .limit(1);\n    \n    if (existingReferral) {\n      throw new Error('User has already been referred');\n    }\n\n    // Create referral record\n    const [referral] = await db.insert(referrals).values({\n      referrerUserId: referralCodeRecord.userId,\n      referredUserId: referredUserId,\n      referralCodeId: referralCodeRecord.id,\n      status: 'pending'\n    }).returning();\n\n    // Update referral code usage count\n    await db.update(referralCodes)\n      .set({ currentUses: sql`${referralCodes.currentUses} + 1` })\n      .where(eq(referralCodes.id, referralCodeRecord.id));\n\n    return referral;\n  }\n\n  async getUserReferrals(userId: string): Promise<Referral[]> {\n    return await db.select()\n      .from(referrals)\n      .where(eq(referrals.referrerUserId, userId))\n      .orderBy(desc(referrals.createdAt));\n  }\n\n  async getUserBonusCredits(userId: string): Promise<BonusCredit[]> {\n    return await db.select()\n      .from(bonusCredits)\n      .where(eq(bonusCredits.userId, userId))\n      .orderBy(desc(bonusCredits.createdAt));\n  }\n\n  async addBonusCredits(bonusCredit: InsertBonusCredit): Promise<BonusCredit> {\n    const [result] = await db.insert(bonusCredits).values(bonusCredit).returning();\n    return result;\n  }\n\n  async getAvailableBonusCredits(userId: string): Promise<number> {\n    const [result] = await db.select({\n      total: sql<number>`sum(${bonusCredits.amount})`\n    })\n    .from(bonusCredits)\n    .where(and(\n      eq(bonusCredits.userId, userId),\n      eq(bonusCredits.isUsed, false),\n      or(\n        sql`${bonusCredits.expiresAt} IS NULL`,\n        gte(bonusCredits.expiresAt, new Date())\n      )\n    ));\n    \n    return result?.total || 0;\n  }\n\n  async useBonusCredits(userId: string, amount: number): Promise<void> {\n    const availableCredits = await db.select()\n      .from(bonusCredits)\n      .where(and(\n        eq(bonusCredits.userId, userId),\n        eq(bonusCredits.isUsed, false),\n        or(\n          sql`${bonusCredits.expiresAt} IS NULL`,\n          gte(bonusCredits.expiresAt, new Date())\n        )\n      ))\n      .orderBy(bonusCredits.createdAt); // Use oldest credits first\n\n    let remainingAmount = amount;\n    const creditsToUpdate: string[] = [];\n\n    for (const credit of availableCredits) {\n      if (remainingAmount <= 0) break;\n      \n      if (credit.amount <= remainingAmount) {\n        creditsToUpdate.push(credit.id);\n        remainingAmount -= credit.amount;\n      } else {\n        // Partial use - split the credit\n        await db.update(bonusCredits)\n          .set({ amount: credit.amount - remainingAmount })\n          .where(eq(bonusCredits.id, credit.id));\n        \n        // Create a new record for the used portion\n        await db.insert(bonusCredits).values({\n          userId: userId,\n          amount: remainingAmount,\n          source: credit.source,\n          referralId: credit.referralId,\n          description: `${credit.description} (used portion)`,\n          expiresAt: credit.expiresAt,\n          isUsed: true,\n          usedAt: new Date()\n        });\n        \n        remainingAmount = 0;\n        break;\n      }\n    }\n\n    // Mark credits as used\n    if (creditsToUpdate.length > 0) {\n      await db.update(bonusCredits)\n        .set({ isUsed: true, usedAt: new Date() })\n        .where(sql`${bonusCredits.id} = ANY(${creditsToUpdate})`);\n    }\n\n    if (remainingAmount > 0) {\n      throw new Error('Insufficient bonus credits available');\n    }\n  }\n\n  // Crypto methods\n  async getCryptoHolding(id: string): Promise<CryptoHolding | undefined> {\n    const [holding] = await db.select().from(cryptoHoldings).where(eq(cryptoHoldings.id, id));\n    return holding;\n  }\n\n  async getUserCryptoHoldings(userId: string): Promise<CryptoHolding[]> {\n    return await db.select()\n      .from(cryptoHoldings)\n      .where(eq(cryptoHoldings.userId, userId))\n      .orderBy(desc(cryptoHoldings.createdAt));\n  }\n\n  async createCryptoHolding(holding: InsertCryptoHolding): Promise<CryptoHolding> {\n    const [result] = await db.insert(cryptoHoldings).values(holding).returning();\n    return result;\n  }\n\n  async updateCryptoHolding(id: string, updates: Partial<CryptoHolding>): Promise<CryptoHolding> {\n    const [result] = await db.update(cryptoHoldings)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(cryptoHoldings.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteCryptoHolding(id: string): Promise<void> {\n    await db.delete(cryptoHoldings).where(eq(cryptoHoldings.id, id));\n  }\n\n  async getCryptoPriceAlert(id: string): Promise<CryptoPriceAlert | undefined> {\n    const [alert] = await db.select().from(cryptoPriceAlerts).where(eq(cryptoPriceAlerts.id, id));\n    return alert;\n  }\n\n  async getUserCryptoPriceAlerts(userId: string): Promise<CryptoPriceAlert[]> {\n    return await db.select()\n      .from(cryptoPriceAlerts)\n      .where(eq(cryptoPriceAlerts.userId, userId))\n      .orderBy(desc(cryptoPriceAlerts.createdAt));\n  }\n\n  async createCryptoPriceAlert(alert: InsertCryptoPriceAlert): Promise<CryptoPriceAlert> {\n    const [result] = await db.insert(cryptoPriceAlerts).values(alert).returning();\n    return result;\n  }\n\n  async updateCryptoPriceAlert(id: string, updates: Partial<CryptoPriceAlert>): Promise<CryptoPriceAlert> {\n    const [result] = await db.update(cryptoPriceAlerts)\n      .set(updates)\n      .where(eq(cryptoPriceAlerts.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteCryptoPriceAlert(id: string): Promise<void> {\n    await db.delete(cryptoPriceAlerts).where(eq(cryptoPriceAlerts.id, id));\n  }\n\n  async getCryptoTransaction(id: string): Promise<CryptoTransaction | undefined> {\n    const [transaction] = await db.select().from(cryptoTransactions).where(eq(cryptoTransactions.id, id));\n    return transaction;\n  }\n\n  async getUserCryptoTransactions(userId: string, limit: number = 50): Promise<CryptoTransaction[]> {\n    return await db.select()\n      .from(cryptoTransactions)\n      .where(eq(cryptoTransactions.userId, userId))\n      .orderBy(desc(cryptoTransactions.transactionDate))\n      .limit(limit);\n  }\n\n  async createCryptoTransaction(transaction: InsertCryptoTransaction): Promise<CryptoTransaction> {\n    const [result] = await db.insert(cryptoTransactions).values(transaction).returning();\n    return result;\n  }\n\n  async getUserCryptoPortfolioValue(userId: string): Promise<{\n    totalValue: number;\n    holdings: Array<{\n      symbol: string;\n      name: string;\n      amount: string;\n      currentPrice: string;\n      value: number;\n      change24h: number;\n    }>;\n  }> {\n    const holdings = await this.getUserCryptoHoldings(userId);\n    \n    const result = {\n      totalValue: 0,\n      holdings: holdings.map(h => {\n        const amount = parseFloat(h.amount);\n        const price = parseFloat(h.currentPrice || '0');\n        const value = amount * price;\n        \n        return {\n          symbol: h.symbol,\n          name: h.name,\n          amount: h.amount,\n          currentPrice: h.currentPrice || '0',\n          value,\n          change24h: 0 // Will be updated by API call\n        };\n      })\n    };\n\n    result.totalValue = result.holdings.reduce((sum, h) => sum + h.value, 0);\n    return result;\n  }\n\n  // ===== Investment Intelligence Methods =====\n\n  async getInvestmentStrategies(): Promise<InvestmentStrategy[]> {\n    return await db.select().from(investmentStrategies).orderBy(investmentStrategies.category);\n  }\n\n  async getInvestmentStrategiesByCategory(category: string): Promise<InvestmentStrategy[]> {\n    return await db.select()\n      .from(investmentStrategies)\n      .where(eq(investmentStrategies.category, category))\n      .orderBy(investmentStrategies.expectedReturn);\n  }\n\n  async getPassiveIncomeOpportunities(): Promise<PassiveIncomeOpportunity[]> {\n    return await db.select().from(passiveIncomeOpportunities).orderBy(passiveIncomeOpportunities.category);\n  }\n\n  async getPassiveIncomeOpportunitiesByCategory(category: string): Promise<PassiveIncomeOpportunity[]> {\n    return await db.select()\n      .from(passiveIncomeOpportunities)\n      .where(eq(passiveIncomeOpportunities.category, category))\n      .orderBy(passiveIncomeOpportunities.monthlyEarningsMax);\n  }\n\n  // ===== Financial Profile Methods =====\n\n  async getUserFinancialProfile(userId: string): Promise<UserFinancialProfile | undefined> {\n    const [profile] = await db.select().from(userFinancialProfiles)\n      .where(eq(userFinancialProfiles.userId, userId));\n    return profile;\n  }\n\n  async createUserFinancialProfile(profile: InsertUserFinancialProfile): Promise<UserFinancialProfile> {\n    const [result] = await db.insert(userFinancialProfiles)\n      .values(profile)\n      .returning();\n    return result;\n  }\n\n  async updateUserFinancialProfile(userId: string, updates: Partial<UserFinancialProfile>): Promise<UserFinancialProfile> {\n    const [result] = await db.update(userFinancialProfiles)\n      .set({ ...updates, lastUpdated: new Date() })\n      .where(eq(userFinancialProfiles.userId, userId))\n      .returning();\n    \n    if (!result) {\n      throw new Error('Financial profile not found');\n    }\n    return result;\n  }\n\n  async getUserExpenseCategories(userId: string): Promise<UserExpenseCategory[]> {\n    return await db.select()\n      .from(userExpenseCategories)\n      .where(eq(userExpenseCategories.userId, userId));\n  }\n\n  async updateUserExpenseCategories(userId: string, categories: InsertUserExpenseCategory[]): Promise<UserExpenseCategory[]> {\n    return await db.transaction(async (tx) => {\n      // Delete existing categories\n      await tx.delete(userExpenseCategories)\n        .where(eq(userExpenseCategories.userId, userId));\n      \n      // Insert new categories with userId\n      if (categories.length > 0) {\n        const valuesToInsert = categories.map(cat => ({\n          ...cat,\n          userId\n        }));\n        await tx.insert(userExpenseCategories).values(valuesToInsert);\n      }\n      \n      // Return updated list\n      return await tx.select()\n        .from(userExpenseCategories)\n        .where(eq(userExpenseCategories.userId, userId));\n    });\n  }\n\n  async getUserDebts(userId: string): Promise<UserDebt[]> {\n    return await db.select()\n      .from(userDebts)\n      .where(eq(userDebts.userId, userId));\n  }\n\n  async createUserDebt(debt: InsertUserDebt): Promise<UserDebt> {\n    const [result] = await db.insert(userDebts)\n      .values(debt)\n      .returning();\n    return result;\n  }\n\n  async updateUserDebt(id: string, updates: Partial<UserDebt>): Promise<UserDebt> {\n    const [result] = await db.update(userDebts)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userDebts.id, id))\n      .returning();\n    \n    if (!result) {\n      throw new Error('Debt not found');\n    }\n    return result;\n  }\n\n  async deleteUserDebt(id: string): Promise<void> {\n    const result = await db.delete(userDebts)\n      .where(eq(userDebts.id, id))\n      .returning();\n    \n    if (result.length === 0) {\n      throw new Error('Debt not found');\n    }\n  }\n\n  async getUserAssets(userId: string): Promise<UserAsset[]> {\n    return await db.select()\n      .from(userAssets)\n      .where(eq(userAssets.userId, userId));\n  }\n\n  async createUserAsset(asset: InsertUserAsset): Promise<UserAsset> {\n    const [result] = await db.insert(userAssets)\n      .values(asset)\n      .returning();\n    return result;\n  }\n\n  async updateUserAsset(id: string, updates: Partial<UserAsset>): Promise<UserAsset> {\n    const [result] = await db.update(userAssets)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userAssets.id, id))\n      .returning();\n    \n    if (!result) {\n      throw new Error('Asset not found');\n    }\n    return result;\n  }\n\n  async deleteUserAsset(id: string): Promise<void> {\n    const result = await db.delete(userAssets)\n      .where(eq(userAssets.id, id))\n      .returning();\n    \n    if (result.length === 0) {\n      throw new Error('Asset not found');\n    }\n  }\n\n  // Playbook methods\n  async getPlaybook(id: string): Promise<Playbook | undefined> {\n    const [playbook] = await db.select().from(playbooks).where(eq(playbooks.id, id));\n    return playbook;\n  }\n\n  async getPlaybooksByUserId(userId: string, limit: number = 10): Promise<Playbook[]> {\n    return await db\n      .select()\n      .from(playbooks)\n      .where(eq(playbooks.userId, userId))\n      .orderBy(desc(playbooks.weekStartDate))\n      .limit(limit);\n  }\n\n  async createPlaybook(playbook: InsertPlaybook): Promise<Playbook> {\n    const [result] = await db.insert(playbooks).values(playbook).returning();\n    return result;\n  }\n\n  async updatePlaybook(id: string, updates: Partial<Playbook>): Promise<Playbook> {\n    const [result] = await db\n      .update(playbooks)\n      .set(updates)\n      .where(eq(playbooks.id, id))\n      .returning();\n    \n    if (!result) {\n      throw new Error('Playbook not found');\n    }\n    return result;\n  }\n\n  async deletePlaybook(id: string): Promise<void> {\n    const result = await db.delete(playbooks)\n      .where(eq(playbooks.id, id))\n      .returning();\n    \n    if (result.length === 0) {\n      throw new Error('Playbook not found');\n    }\n  }\n\n  async markPlaybookViewed(id: string): Promise<void> {\n    await db\n      .update(playbooks)\n      .set({ isViewed: true, viewedAt: new Date() })\n      .where(eq(playbooks.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();","path":null,"size_bytes":149698,"size_tokens":null},"client/src/hooks/use-mobile-performance.ts":{"content":"import { useState, useEffect, useCallback, useMemo } from 'react';\nimport { isMobileDevice, getNetworkQuality, debounce, throttle } from '@/lib/performance';\n\n/**\n * Hook for mobile-optimized data fetching\n */\nexport function useMobileOptimizedQuery<T>(\n queryKey: string,\n queryFn: () => Promise<T>,\n options?: {\n  enabled?: boolean;\n  staleTime?: number;\n  refetchOnWindowFocus?: boolean;\n }\n) {\n const [data, setData] = useState<T | null>(null);\n const [isLoading, setIsLoading] = useState(false);\n const [error, setError] = useState<Error | null>(null);\n \n const isMobile = useMemo(() => isMobileDevice(), []);\n const networkQuality = useMemo(() => getNetworkQuality(), []);\n \n // Adjust stale time based on network quality\n const adjustedStaleTime = useMemo(() => {\n  const baseStaleTime = options?.staleTime ?? 5 * 60 * 1000; // 5 minutes\n  \n  if (networkQuality === 'slow') {\n   return baseStaleTime * 2; // Cache longer on slow networks\n  }\n  return baseStaleTime;\n }, [networkQuality, options?.staleTime]);\n \n const executeQuery = useCallback(async () => {\n  if (!options?.enabled && options?.enabled !== undefined) return;\n  \n  setIsLoading(true);\n  setError(null);\n  \n  try {\n   const result = await queryFn();\n   setData(result);\n  } catch (err) {\n   setError(err instanceof Error ? err : new Error('Query failed'));\n  } finally {\n   setIsLoading(false);\n  }\n }, [queryFn, options?.enabled]);\n \n useEffect(() => {\n  executeQuery();\n }, [executeQuery]);\n \n return {\n  data,\n  isLoading,\n  error,\n  refetch: executeQuery,\n  isMobile,\n  networkQuality\n };\n}\n\n/**\n * Hook for mobile-optimized form inputs with debouncing\n */\nexport function useMobileInput(initialValue: string = '', delay: number = 300) {\n const [value, setValue] = useState(initialValue);\n const [debouncedValue, setDebouncedValue] = useState(initialValue);\n \n const isMobile = useMemo(() => isMobileDevice(), []);\n \n // Use longer debounce on mobile to reduce API calls\n const adjustedDelay = isMobile ? delay * 1.5 : delay;\n \n const debouncedSetValue = useCallback(\n  debounce((newValue: string) => {\n   setDebouncedValue(newValue);\n  }, adjustedDelay),\n  [adjustedDelay]\n );\n \n useEffect(() => {\n  debouncedSetValue(value);\n }, [value, debouncedSetValue]);\n \n const handleChange = useCallback((newValue: string) => {\n  setValue(newValue);\n }, []);\n \n return {\n  value,\n  debouncedValue,\n  onChange: handleChange,\n  setValue,\n  isMobile\n };\n}\n\n/**\n * Hook for mobile-optimized scroll handling\n */\nexport function useMobileScroll(handler: () => void, delay: number = 100) {\n const isMobile = useMemo(() => isMobileDevice(), []);\n \n // Use throttle for scroll events to improve performance\n const throttledHandler = useCallback(\n  throttle(handler, isMobile ? delay * 2 : delay),\n  [handler, delay, isMobile]\n );\n \n useEffect(() => {\n  window.addEventListener('scroll', throttledHandler, { passive: true });\n  return () => window.removeEventListener('scroll', throttledHandler);\n }, [throttledHandler]);\n \n return { isMobile };\n}\n\n/**\n * Hook for mobile-optimized image loading\n */\nexport function useMobileImage(src: string) {\n const [isLoaded, setIsLoaded] = useState(false);\n const [error, setError] = useState<Error | null>(null);\n const [imageSrc, setImageSrc] = useState<string>('');\n \n const isMobile = useMemo(() => isMobileDevice(), []);\n const networkQuality = useMemo(() => getNetworkQuality(), []);\n \n useEffect(() => {\n  if (!src) return;\n  \n  // On slow networks, defer image loading\n  if (networkQuality === 'slow') {\n   const timer = setTimeout(() => {\n    setImageSrc(src);\n   }, 1000);\n   return () => clearTimeout(timer);\n  }\n  \n  setImageSrc(src);\n }, [src, networkQuality]);\n \n useEffect(() => {\n  if (!imageSrc) return;\n  \n  const img = new Image();\n  img.onload = () => setIsLoaded(true);\n  img.onerror = () => setError(new Error('Failed to load image'));\n  img.src = imageSrc;\n  \n  return () => {\n   img.onload = null;\n   img.onerror = null;\n  };\n }, [imageSrc]);\n \n return {\n  src: imageSrc,\n  isLoaded,\n  error,\n  isMobile,\n  networkQuality\n };\n}\n\n/**\n * Hook for mobile-optimized virtual scrolling\n */\nexport function useVirtualList<T>(\n items: T[],\n itemHeight: number,\n containerHeight: number,\n overscan: number = 3\n) {\n const [scrollTop, setScrollTop] = useState(0);\n const isMobile = useMemo(() => isMobileDevice(), []);\n \n // Increase overscan on mobile for smoother scrolling\n const adjustedOverscan = isMobile ? overscan * 2 : overscan;\n \n const visibleRange = useMemo(() => {\n  const startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - adjustedOverscan);\n  const endIndex = Math.min(\n   items.length - 1,\n   Math.ceil((scrollTop + containerHeight) / itemHeight) + adjustedOverscan\n  );\n  \n  return { startIndex, endIndex };\n }, [scrollTop, itemHeight, containerHeight, adjustedOverscan, items.length]);\n \n const visibleItems = useMemo(() => {\n  return items.slice(visibleRange.startIndex, visibleRange.endIndex + 1);\n }, [items, visibleRange]);\n \n const totalHeight = items.length * itemHeight;\n const offsetY = visibleRange.startIndex * itemHeight;\n \n const handleScroll = useCallback(\n  throttle((e: React.UIEvent<HTMLElement>) => {\n   setScrollTop(e.currentTarget.scrollTop);\n  }, isMobile ? 16 : 8), // Throttle more on mobile\n  [isMobile]\n );\n \n return {\n  visibleItems,\n  totalHeight,\n  offsetY,\n  onScroll: handleScroll,\n  isMobile\n };\n}\n\n/**\n * Hook for mobile performance monitoring\n */\nexport function useMobilePerformanceMonitor() {\n const isMobile = useMemo(() => isMobileDevice(), []);\n \n const measureRender = useCallback((componentName: string) => {\n  if (!isMobile) return () => {};\n  \n  const startTime = performance.now();\n  \n  return () => {\n   const duration = performance.now() - startTime;\n   if (duration > 16) { // More than one frame (60fps)\n    console.warn(`Slow render on mobile: ${componentName} took ${duration.toFixed(2)}ms`);\n   }\n  };\n }, [isMobile]);\n \n return { measureRender, isMobile };\n}","path":null,"size_bytes":5947,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { Link } from \"wouter\";\nimport { ArrowRight, Target, Sparkles, TrendingUp, TrendingDown, Brain, ChevronRight, Award, Star, Zap, DollarSign, PiggyBank, ArrowUpRight, ArrowDownRight } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useTranslation } from 'react-i18next';\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport NotificationsBell from \"@/components/dashboard/notifications-bell\";\nimport OnboardingWizard from \"@/components/onboarding/onboarding-wizard\";\nimport { useOnboarding } from \"@/hooks/use-onboarding\";\nimport { UserPreferences, FinancialGoal } from \"@shared/schema\";\nimport { SmartNudgeBanner } from \"@/components/smart-nudges\";\nimport { StreakWidget, AchievementBadges } from \"@/components/streak-system\";\nimport { useUserCurrency, useUserPreferences } from \"@/lib/userContext\";\n\ninterface DashboardStats {\n  totalTransactions: number;\n  monthlyIncome: number;\n  monthlyExpenses: number;\n  savingsRate: number;\n  totalGoals: number;\n  activeGoalsCount: number;\n  netWorth?: number;\n}\n\ninterface FinancialHealthResponse {\n  overall: number;\n  grade: string;\n  breakdown: {\n    savingsRate?: { value: number; score: number; weight: number };\n    emergencyFund?: { months: number; score: number; weight: number };\n    goalProgress?: { value: number; score: number; weight: number };\n    budgetAdherence?: { value: number; score: number; weight: number };\n    debtRatio?: { value: number; score: number; weight: number };\n  };\n  insights: string[];\n  recommendations: string[];\n}\n\ninterface SubscriptionResponse {\n  plan: {\n    name: string;\n    scoutLimit: number;\n    sonnetLimit: number;\n    gpt5Limit: number;\n    opusLimit: number;\n  };\n  usage: {\n    scoutQueriesUsed: number;\n    sonnetQueriesUsed: number;\n    gpt5QueriesUsed: number;\n    opusQueriesUsed: number;\n  };\n}\n\nfunction AnimatedNumber({ value, suffix = \"\", prefix = \"\", decimals = 0 }: { value: number; suffix?: string; prefix?: string; decimals?: number }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const duration = 1000;\n    const startTime = Date.now();\n    const startValue = displayValue;\n    \n    const animate = () => {\n      const now = Date.now();\n      const progress = Math.min((now - startTime) / duration, 1);\n      const easeOutQuart = 1 - Math.pow(1 - progress, 4);\n      const current = startValue + (value - startValue) * easeOutQuart;\n      \n      setDisplayValue(current);\n      \n      if (progress < 1) {\n        requestAnimationFrame(animate);\n      }\n    };\n    \n    requestAnimationFrame(animate);\n  }, [value]);\n  \n  return (\n    <span>\n      {prefix}{decimals > 0 ? displayValue.toFixed(decimals) : Math.round(displayValue).toLocaleString()}{suffix}\n    </span>\n  );\n}\n\nfunction getGreeting(): string {\n  const hour = new Date().getHours();\n  if (hour < 12) return \"Good morning\";\n  if (hour < 17) return \"Good afternoon\";\n  return \"Good evening\";\n}\n\nfunction getMotivationalMessage(healthScore: number, savingsRate: number): string {\n  if (healthScore >= 80) return \"Outstanding financial discipline. Keep it up!\";\n  if (healthScore >= 60) return \"You're making solid progress toward your goals.\";\n  if (savingsRate > 15) return \"Great savings rate! Consider investing the surplus.\";\n  return \"Small steps lead to big changes. Start with one goal.\";\n}\n\nexport default function Dashboard() {\n  const { t } = useTranslation();\n  const { showOnboarding, completeOnboarding } = useOnboarding();\n  const { formatAmount, currencySymbol } = useUserCurrency();\n  const { getUserName } = useUserPreferences();\n  \n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n  \n  const { data: financialHealth, isLoading: healthLoading } = useQuery<FinancialHealthResponse>({\n    queryKey: [\"/api/financial-health\"],\n  });\n  \n  const { data: goals, isLoading: goalsLoading } = useQuery<FinancialGoal[]>({\n    queryKey: [\"/api/financial-goals\"],\n  });\n\n  const { data: preferences } = useQuery<UserPreferences>({\n    queryKey: ['/api/user-preferences'],\n  });\n\n  const { data: subscription } = useQuery<SubscriptionResponse>({\n    queryKey: [\"/api/subscription\"],\n  });\n  \n  const healthScore = financialHealth?.overall ?? 0;\n  const healthGrade = financialHealth?.grade ?? 'Building';\n  const savingsRate = financialHealth?.breakdown?.savingsRate?.value ?? 0;\n  const emergencyFundMonths = financialHealth?.breakdown?.emergencyFund?.months ?? 0;\n  \n  const activeGoals = Array.isArray(goals) ? goals.filter((g) => g.status === \"active\") : [];\n  const nextGoal = activeGoals.length > 0 ? activeGoals[0] : null;\n  const nextGoalProgress = nextGoal \n    ? Math.min(100, (parseFloat(nextGoal.currentAmount || '0') / parseFloat(String(nextGoal.targetAmount))) * 100)\n    : 0;\n  \n  const tierName = subscription?.plan?.name ?? 'Free';\n  const scoutUsed = subscription?.usage?.scoutQueriesUsed ?? 0;\n  const scoutLimit = subscription?.plan?.scoutLimit ?? 50;\n  const queriesRemaining = scoutLimit - scoutUsed;\n  \n  const monthlyIncome = stats?.monthlyIncome ?? 0;\n  const monthlyExpenses = stats?.monthlyExpenses ?? 0;\n  const netCashFlow = monthlyIncome - monthlyExpenses;\n  const monthlySavingsCapacity = monthlyIncome - parseFloat(String(preferences?.monthlyExpensesEstimate ?? '0'));\n  \n  const isPositiveCashFlow = netCashFlow >= 0;\n  \n  if (showOnboarding) {\n    return <OnboardingWizard onComplete={completeOnboarding} />;\n  }\n\n  const aiNextSteps = useMemo(() => {\n    const steps = [];\n    \n    if (emergencyFundMonths < 3) {\n      steps.push({\n        icon: Star,\n        title: \"Build Emergency Fund\",\n        description: `${emergencyFundMonths.toFixed(1)} months saved. Target: 3-6 months.`,\n        action: \"Create Goal\",\n        href: \"/financial-goals\",\n        priority: \"high\"\n      });\n    }\n    \n    if (savingsRate < 20 && monthlySavingsCapacity > 0) {\n      steps.push({\n        icon: TrendingUp,\n        title: \"Increase Savings Rate\",\n        description: `Currently ${savingsRate.toFixed(0)}%. Potential: ${formatAmount(monthlySavingsCapacity)}/mo.`,\n        action: \"Optimize\",\n        href: \"/money-tracking\",\n        priority: \"medium\"\n      });\n    }\n    \n    if (nextGoal && nextGoalProgress < 50 && nextGoal.targetDate) {\n      const daysToTarget = Math.ceil((new Date(nextGoal.targetDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));\n      if (daysToTarget > 0) {\n        steps.push({\n          icon: Target,\n          title: `Accelerate \"${nextGoal.title}\"`,\n          description: `${daysToTarget} days left. ${nextGoalProgress.toFixed(0)}% complete.`,\n          action: \"Review\",\n          href: \"/financial-goals\",\n          priority: \"medium\"\n        });\n      }\n    }\n    \n    if (queriesRemaining > 10) {\n      steps.push({\n        icon: Brain,\n        title: \"Get AI Advice\",\n        description: `${queriesRemaining} queries available. Ask anything!`,\n        action: \"Chat\",\n        href: \"/ai-assistant\",\n        priority: \"low\"\n      });\n    }\n    \n    return steps.slice(0, 3);\n  }, [emergencyFundMonths, savingsRate, monthlySavingsCapacity, nextGoal, nextGoalProgress, queriesRemaining, formatAmount]);\n\n  const getHealthColor = (score: number) => {\n    if (score >= 75) return { text: \"text-emerald-600 dark:text-emerald-400\", bg: \"bg-emerald-500\", light: \"bg-emerald-50 dark:bg-emerald-950/30\", border: \"border-emerald-200 dark:border-emerald-800\" };\n    if (score >= 60) return { text: \"text-blue-600 dark:text-blue-400\", bg: \"bg-blue-500\", light: \"bg-blue-50 dark:bg-blue-950/30\", border: \"border-blue-200 dark:border-blue-800\" };\n    if (score >= 40) return { text: \"text-amber-600 dark:text-amber-400\", bg: \"bg-amber-500\", light: \"bg-amber-50 dark:bg-amber-950/30\", border: \"border-amber-200 dark:border-amber-800\" };\n    return { text: \"text-red-600 dark:text-red-400\", bg: \"bg-red-500\", light: \"bg-red-50 dark:bg-red-950/30\", border: \"border-red-200 dark:border-red-800\" };\n  };\n\n  const healthColors = getHealthColor(healthScore);\n\n  return (\n    <div className=\"min-h-screen-mobile bg-gradient-to-b from-background to-muted/20 pb-20 md:pb-0\">\n      <header className=\"bg-background/80 backdrop-blur-xl border-b border-border/40 sticky top-0 z-30\">\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-6\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <div className=\"flex-1 min-w-0\">\n              <motion.div\n                initial={{ opacity: 0, y: -10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ duration: 0.3 }}\n              >\n                <h1 className=\"text-lg sm:text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight text-foreground truncate\">\n                  {getGreeting()}\n                </h1>\n                <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 line-clamp-1 sm:line-clamp-none\">\n                  {getMotivationalMessage(healthScore, savingsRate)}\n                </p>\n              </motion.div>\n            </div>\n            \n            <div className=\"flex items-center gap-2 sm:gap-3 flex-shrink-0\">\n              <NotificationsBell />\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-10 space-y-4 sm:space-y-6 lg:space-y-10\">\n        \n        <SmartNudgeBanner />\n        \n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.4, delay: 0.1 }}\n        >\n          <Card className=\"border-0 shadow-lg sm:shadow-xl bg-gradient-to-br from-white to-gray-50/50 dark:from-gray-900 dark:to-gray-900/50 overflow-hidden\">\n            <CardContent className=\"p-0\">\n              <div className=\"grid lg:grid-cols-2 gap-0\">\n                <div className=\"p-4 sm:p-6 lg:p-8 xl:p-10\">\n                  <div className=\"flex flex-wrap items-center gap-2 mb-3 sm:mb-4\">\n                    <Badge \n                      className={`${healthColors.light} ${healthColors.text} ${healthColors.border} border text-xs font-medium px-2 sm:px-3 py-0.5 sm:py-1`}\n                    >\n                      {healthGrade}\n                    </Badge>\n                    <span className=\"text-[10px] sm:text-xs text-muted-foreground\">AI-Powered Analysis</span>\n                  </div>\n                  \n                  <h2 className=\"text-xs sm:text-sm lg:text-base font-medium text-muted-foreground mb-2 sm:mb-3\">\n                    Financial Health Score\n                  </h2>\n                  \n                  {healthLoading ? (\n                    <Skeleton className=\"h-16 sm:h-20 lg:h-24 w-32 sm:w-40\" />\n                  ) : (\n                    <div className=\"flex items-end gap-2 sm:gap-3 mb-3 sm:mb-4\">\n                      <span \n                        className={`text-5xl sm:text-6xl lg:text-7xl xl:text-8xl font-bold tracking-tighter ${healthColors.text}`}\n                        data-testid=\"hero-health-score\"\n                      >\n                        <AnimatedNumber value={healthScore} />\n                      </span>\n                      <span className=\"text-xl sm:text-2xl lg:text-3xl font-semibold text-muted-foreground/30 mb-1 sm:mb-2\">/100</span>\n                    </div>\n                  )}\n                  \n                  <div className=\"h-1.5 sm:h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden mb-3 sm:mb-4\">\n                    <motion.div \n                      className={`h-full ${healthColors.bg} rounded-full`}\n                      initial={{ width: 0 }}\n                      animate={{ width: `${healthScore}%` }}\n                      transition={{ duration: 1, delay: 0.3, ease: \"easeOut\" }}\n                    />\n                  </div>\n                  \n                  <p className=\"text-xs sm:text-sm text-muted-foreground line-clamp-2 sm:line-clamp-none\">\n                    Based on savings rate, emergency fund, debt ratio, and goal progress\n                  </p>\n                </div>\n                \n                <div className=\"bg-gray-50/50 dark:bg-gray-800/30 p-4 sm:p-6 lg:p-8 xl:p-10 border-t lg:border-t-0 lg:border-l border-border/30\">\n                  <h3 className=\"text-xs sm:text-sm font-medium text-muted-foreground mb-4 sm:mb-6\">Key Metrics</h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-4 sm:gap-6\">\n                    <motion.div \n                      className=\"space-y-0.5 sm:space-y-1\"\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.3, delay: 0.4 }}\n                      data-testid=\"metric-savings-rate\"\n                    >\n                      <div className=\"flex items-center gap-1.5 sm:gap-2\">\n                        <div className=\"p-1 sm:p-1.5 rounded-md bg-emerald-100 dark:bg-emerald-900/30\">\n                          <PiggyBank className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-emerald-600 dark:text-emerald-400\" />\n                        </div>\n                        <span className=\"text-[10px] sm:text-xs text-muted-foreground\">Savings Rate</span>\n                      </div>\n                      <div className=\"text-xl sm:text-2xl lg:text-3xl font-bold text-foreground\">\n                        <AnimatedNumber value={savingsRate} suffix=\"%\" decimals={1} />\n                      </div>\n                    </motion.div>\n                    \n                    <motion.div \n                      className=\"space-y-0.5 sm:space-y-1\"\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.3, delay: 0.5 }}\n                      data-testid=\"metric-emergency-fund\"\n                    >\n                      <div className=\"flex items-center gap-1.5 sm:gap-2\">\n                        <div className=\"p-1 sm:p-1.5 rounded-md bg-blue-100 dark:bg-blue-900/30\">\n                          <Star className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-blue-600 dark:text-blue-400\" />\n                        </div>\n                        <span className=\"text-[10px] sm:text-xs text-muted-foreground\">Emergency Fund</span>\n                      </div>\n                      <div className=\"text-xl sm:text-2xl lg:text-3xl font-bold text-foreground\">\n                        <AnimatedNumber value={emergencyFundMonths} suffix=\" mo\" decimals={1} />\n                      </div>\n                    </motion.div>\n                    \n                    <motion.div \n                      className=\"space-y-0.5 sm:space-y-1\"\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.3, delay: 0.6 }}\n                      data-testid=\"metric-cash-flow\"\n                    >\n                      <div className=\"flex items-center gap-1.5 sm:gap-2\">\n                        <div className={`p-1 sm:p-1.5 rounded-md ${isPositiveCashFlow ? 'bg-emerald-100 dark:bg-emerald-900/30' : 'bg-red-100 dark:bg-red-900/30'}`}>\n                          {isPositiveCashFlow ? (\n                            <ArrowUpRight className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-emerald-600 dark:text-emerald-400\" />\n                          ) : (\n                            <ArrowDownRight className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-red-600 dark:text-red-400\" />\n                          )}\n                        </div>\n                        <span className=\"text-[10px] sm:text-xs text-muted-foreground\">Monthly Flow</span>\n                      </div>\n                      <div className={`text-xl sm:text-2xl lg:text-3xl font-bold ${isPositiveCashFlow ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}`}>\n                        {isPositiveCashFlow ? '+' : ''}<AnimatedNumber value={netCashFlow} prefix={currencySymbol} />\n                      </div>\n                    </motion.div>\n                    \n                    <motion.div \n                      className=\"space-y-0.5 sm:space-y-1\"\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      transition={{ duration: 0.3, delay: 0.7 }}\n                      data-testid=\"metric-goals\"\n                    >\n                      <div className=\"flex items-center gap-1.5 sm:gap-2\">\n                        <div className=\"p-1 sm:p-1.5 rounded-md bg-purple-100 dark:bg-purple-900/30\">\n                          <Target className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-purple-600 dark:text-purple-400\" />\n                        </div>\n                        <span className=\"text-[10px] sm:text-xs text-muted-foreground\">Active Goals</span>\n                      </div>\n                      <div className=\"text-xl sm:text-2xl lg:text-3xl font-bold text-foreground\">\n                        <AnimatedNumber value={activeGoals.length} />\n                      </div>\n                    </motion.div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4, delay: 0.2 }}\n          >\n            <Card className=\"h-full border-border/40 hover:border-border/60 transition-colors\">\n              <CardContent className=\"p-4 sm:p-6\">\n                <div className=\"flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6\">\n                  <div className=\"p-2 sm:p-2.5 rounded-xl bg-gradient-to-br from-primary to-primary/80 shadow-lg shadow-primary/20\">\n                    <Sparkles className=\"w-4 h-4 sm:w-5 sm:h-5 text-primary-foreground\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-sm sm:text-base font-semibold text-foreground\">AI Insights</h3>\n                    <p className=\"text-[10px] sm:text-xs text-muted-foreground\">Personalized recommendations</p>\n                  </div>\n                </div>\n                \n                <div className=\"space-y-2 sm:space-y-3\">\n                  <AnimatePresence>\n                    {aiNextSteps.length > 0 ? (\n                      aiNextSteps.map((step, idx) => (\n                        <motion.div\n                          key={idx}\n                          initial={{ opacity: 0, x: -10 }}\n                          animate={{ opacity: 1, x: 0 }}\n                          transition={{ duration: 0.2, delay: idx * 0.1 }}\n                        >\n                          <Link href={step.href}>\n                            <button \n                              className=\"w-full text-left p-3 sm:p-4 rounded-xl border border-border/40 hover:border-primary/30 hover:bg-primary/5 transition-all group min-h-[56px] touch-target\"\n                              data-testid={`ai-step-${idx}`}\n                            >\n                              <div className=\"flex items-start gap-2 sm:gap-3\">\n                                <div className={`p-1.5 sm:p-2 rounded-lg flex-shrink-0 ${\n                                  step.priority === 'high' \n                                    ? 'bg-orange-100 dark:bg-orange-900/30' \n                                    : step.priority === 'medium' \n                                    ? 'bg-blue-100 dark:bg-blue-900/30' \n                                    : 'bg-gray-100 dark:bg-gray-800'\n                                }`}>\n                                  <step.icon className={`w-3.5 h-3.5 sm:w-4 sm:h-4 ${\n                                    step.priority === 'high' \n                                      ? 'text-orange-600 dark:text-orange-400' \n                                      : step.priority === 'medium' \n                                      ? 'text-blue-600 dark:text-blue-400' \n                                      : 'text-muted-foreground'\n                                  }`} />\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"flex items-center justify-between gap-2 mb-0.5 sm:mb-1\">\n                                    <span className=\"font-medium text-xs sm:text-sm text-foreground truncate\">{step.title}</span>\n                                    <ChevronRight className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-muted-foreground group-hover:translate-x-1 group-hover:text-primary transition-all flex-shrink-0\" />\n                                  </div>\n                                  <p className=\"text-[10px] sm:text-xs text-muted-foreground leading-relaxed line-clamp-2\">{step.description}</p>\n                                </div>\n                              </div>\n                            </button>\n                          </Link>\n                        </motion.div>\n                      ))\n                    ) : (\n                      <motion.div \n                        className=\"text-center py-6 sm:py-8\"\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                      >\n                        <div className=\"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mx-auto mb-2 sm:mb-3\">\n                          <Award className=\"w-5 h-5 sm:w-6 sm:h-6 text-emerald-600 dark:text-emerald-400\" />\n                        </div>\n                        <p className=\"text-xs sm:text-sm font-medium text-foreground\">Excellent work!</p>\n                        <p className=\"text-[10px] sm:text-xs text-muted-foreground mt-1\">No urgent actions needed</p>\n                      </motion.div>\n                    )}\n                  </AnimatePresence>\n                </div>\n                \n                <Link href=\"/ai-assistant\">\n                  <Button className=\"w-full mt-4 sm:mt-6 group min-h-[44px]\" data-testid=\"button-view-ai-insights\">\n                    <Brain className=\"w-4 h-4 mr-2\" />\n                    <span className=\"text-sm sm:text-base\">Ask AI Anything</span>\n                    <ArrowRight className=\"w-4 h-4 ml-auto group-hover:translate-x-1 transition-transform\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n          </motion.div>\n          \n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4, delay: 0.3 }}\n          >\n            <Card className=\"h-full border-border/40 hover:border-border/60 transition-colors\">\n              <CardContent className=\"p-4 sm:p-6\">\n                <div className=\"flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6\">\n                  <div className=\"p-2 sm:p-2.5 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg shadow-blue-500/20\">\n                    <Target className=\"w-4 h-4 sm:w-5 sm:h-5 text-white\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-sm sm:text-base font-semibold text-foreground\">Next Goal</h3>\n                    <p className=\"text-[10px] sm:text-xs text-muted-foreground\">Track your progress</p>\n                  </div>\n                </div>\n                \n                {nextGoal ? (\n                  <div className=\"space-y-3 sm:space-y-4\">\n                    <div>\n                      <h4 className=\"font-medium text-sm sm:text-base text-foreground mb-1 truncate\">{nextGoal.title}</h4>\n                      <div className=\"flex items-baseline gap-1\">\n                        <span className=\"text-xl sm:text-2xl font-bold text-foreground\">\n                          {formatAmount(parseFloat(nextGoal.currentAmount || '0'))}\n                        </span>\n                        <span className=\"text-xs sm:text-sm text-muted-foreground\">\n                          / {formatAmount(parseFloat(String(nextGoal.targetAmount)))}\n                        </span>\n                      </div>\n                    </div>\n                    \n                    <div>\n                      <div className=\"flex items-center justify-between text-[10px] sm:text-xs text-muted-foreground mb-1.5 sm:mb-2\">\n                        <span className=\"font-medium\">{nextGoalProgress.toFixed(0)}% complete</span>\n                        {nextGoal.targetDate && (\n                          <span>{new Date(nextGoal.targetDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>\n                        )}\n                      </div>\n                      <div className=\"h-2.5 sm:h-3 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden\">\n                        <motion.div \n                          className=\"h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full\"\n                          initial={{ width: 0 }}\n                          animate={{ width: `${Math.min(100, nextGoalProgress)}%` }}\n                          transition={{ duration: 0.8, delay: 0.4, ease: \"easeOut\" }}\n                        />\n                      </div>\n                    </div>\n                    \n                    {nextGoal.targetDate && (\n                      <div className=\"p-3 sm:p-4 rounded-xl bg-blue-50 dark:bg-blue-950/30 border border-blue-100 dark:border-blue-900/50\">\n                        <p className=\"text-[10px] sm:text-xs text-muted-foreground mb-0.5 sm:mb-1\">Monthly contribution needed</p>\n                        <p className=\"text-lg sm:text-xl font-bold text-foreground\">\n                          {formatAmount(Math.max(0, (parseFloat(String(nextGoal.targetAmount)) - parseFloat(nextGoal.currentAmount || '0')) / \n                            Math.max(1, Math.ceil((new Date(nextGoal.targetDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24 * 30)))))}\n                          <span className=\"text-xs sm:text-sm font-normal text-muted-foreground\">/month</span>\n                        </p>\n                      </div>\n                    )}\n                    \n                    <Link href=\"/financial-goals\">\n                      <Button variant=\"outline\" className=\"w-full group min-h-[44px]\" data-testid=\"button-manage-goals\">\n                        <span className=\"text-sm\">Manage Goals</span>\n                        <ArrowRight className=\"w-4 h-4 ml-auto group-hover:translate-x-1 transition-transform\" />\n                      </Button>\n                    </Link>\n                  </div>\n                ) : (\n                  <div className=\"text-center py-6 sm:py-8\">\n                    <div className=\"w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mx-auto mb-3 sm:mb-4\">\n                      <Target className=\"w-5 h-5 sm:w-6 sm:h-6 text-muted-foreground\" />\n                    </div>\n                    <p className=\"text-xs sm:text-sm font-medium text-foreground mb-1\">No active goals</p>\n                    <p className=\"text-[10px] sm:text-xs text-muted-foreground mb-4 sm:mb-6\">Set a target to start tracking</p>\n                    <Link href=\"/financial-goals?create=1\">\n                      <Button className=\"w-full min-h-[44px]\" data-testid=\"button-create-first-goal\">\n                        <Target className=\"w-4 h-4 mr-2\" />\n                        <span className=\"text-sm\">Create First Goal</span>\n                      </Button>\n                    </Link>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </motion.div>\n          \n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4, delay: 0.4 }}\n            className=\"md:col-span-2 lg:col-span-1\"\n          >\n            <Card className=\"h-full border-border/40 hover:border-border/60 transition-colors\">\n              <CardContent className=\"p-4 sm:p-6\">\n                <div className=\"flex items-center gap-2 sm:gap-3 mb-4 sm:mb-6\">\n                  <div className=\"p-2 sm:p-2.5 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg shadow-violet-500/20\">\n                    <Zap className=\"w-4 h-4 sm:w-5 sm:h-5 text-white\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-sm sm:text-base font-semibold text-foreground\">Quick Actions</h3>\n                    <p className=\"text-[10px] sm:text-xs text-muted-foreground\">Common tasks</p>\n                  </div>\n                </div>\n                \n                <div className=\"space-y-2 sm:space-y-3\">\n                  <Link href=\"/money-tracking?add=1\">\n                    <Button variant=\"outline\" className=\"w-full justify-start h-11 sm:h-12 group touch-target\" data-testid=\"button-add-transaction\">\n                      <div className=\"p-1 sm:p-1.5 rounded-md bg-emerald-100 dark:bg-emerald-900/30 mr-2 sm:mr-3\">\n                        <DollarSign className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-emerald-600 dark:text-emerald-400\" />\n                      </div>\n                      <span className=\"text-sm\">Add Transaction</span>\n                      <ChevronRight className=\"w-4 h-4 ml-auto group-hover:translate-x-1 transition-transform\" />\n                    </Button>\n                  </Link>\n                  \n                  <Link href=\"/money-tracking\">\n                    <Button variant=\"outline\" className=\"w-full justify-start h-11 sm:h-12 group touch-target\" data-testid=\"button-view-spending\">\n                      <div className=\"p-1 sm:p-1.5 rounded-md bg-blue-100 dark:bg-blue-900/30 mr-2 sm:mr-3\">\n                        <TrendingUp className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 dark:text-blue-400\" />\n                      </div>\n                      <span className=\"text-sm\">View Spending</span>\n                      <ChevronRight className=\"w-4 h-4 ml-auto group-hover:translate-x-1 transition-transform\" />\n                    </Button>\n                  </Link>\n                  \n                  <Link href=\"/subscription\">\n                    <Button variant=\"outline\" className=\"w-full justify-start h-11 sm:h-12 group touch-target\" data-testid=\"button-upgrade-plan\">\n                      <div className=\"p-1 sm:p-1.5 rounded-md bg-violet-100 dark:bg-violet-900/30 mr-2 sm:mr-3\">\n                        <Sparkles className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-violet-600 dark:text-violet-400\" />\n                      </div>\n                      <span className=\"text-sm\">AI Plan</span>\n                      <Badge variant=\"secondary\" className=\"ml-auto text-[10px] sm:text-xs\">\n                        {tierName}\n                      </Badge>\n                    </Button>\n                  </Link>\n                </div>\n                \n                <div className=\"mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-border/40\">\n                  <div className=\"flex items-center justify-between mb-2 sm:mb-3\">\n                    <span className=\"text-xs sm:text-sm font-medium text-foreground\">AI Queries</span>\n                    <span className=\"text-xs sm:text-sm text-muted-foreground\">{queriesRemaining} remaining</span>\n                  </div>\n                  <div className=\"h-1.5 sm:h-2 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden\">\n                    <motion.div \n                      className=\"h-full bg-gradient-to-r from-violet-500 to-purple-600 rounded-full\"\n                      initial={{ width: 0 }}\n                      animate={{ width: `${Math.max(0, (queriesRemaining / scoutLimit) * 100)}%` }}\n                      transition={{ duration: 0.6, delay: 0.5, ease: \"easeOut\" }}\n                    />\n                  </div>\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground mt-1.5 sm:mt-2\">\n                    {scoutUsed} of {scoutLimit} used this month\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        </div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.4, delay: 0.5 }}\n        >\n          <Card className=\"border-border/40 bg-gradient-to-r from-gray-50 to-gray-100/50 dark:from-gray-900/50 dark:to-gray-800/30\">\n            <CardContent className=\"p-4 sm:p-6 lg:p-8\">\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4\">\n                <div className=\"w-full sm:w-auto\">\n                  <h3 className=\"text-base sm:text-lg font-semibold text-foreground mb-0.5 sm:mb-1\">Explore More</h3>\n                  <p className=\"text-xs sm:text-sm text-muted-foreground\">\n                    Access detailed analytics and advanced features\n                  </p>\n                </div>\n                <div className=\"flex flex-wrap gap-2 sm:gap-3 w-full sm:w-auto\">\n                  <Link href=\"/money-tracking\" className=\"flex-1 sm:flex-none\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto group min-h-[40px] touch-target\" data-testid=\"button-view-transactions\">\n                      <span className=\"text-xs sm:text-sm\">Transactions</span>\n                      <ArrowRight className=\"w-3.5 h-3.5 ml-1.5 sm:ml-2 group-hover:translate-x-1 transition-transform\" />\n                    </Button>\n                  </Link>\n                  <Link href=\"/financial-goals\" className=\"flex-1 sm:flex-none\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto group min-h-[40px] touch-target\" data-testid=\"button-all-goals\">\n                      <span className=\"text-xs sm:text-sm\">All Goals</span>\n                      <ArrowRight className=\"w-3.5 h-3.5 ml-1.5 sm:ml-2 group-hover:translate-x-1 transition-transform\" />\n                    </Button>\n                  </Link>\n                  <Link href=\"/groups\" className=\"flex-1 sm:flex-none\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto group min-h-[40px] touch-target\" data-testid=\"button-groups\">\n                      <span className=\"text-xs sm:text-sm\">Groups</span>\n                      <ArrowRight className=\"w-3.5 h-3.5 ml-1.5 sm:ml-2 group-hover:translate-x-1 transition-transform\" />\n                    </Button>\n                  </Link>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6\">\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4, delay: 0.55 }}\n          >\n            <StreakWidget />\n          </motion.div>\n          \n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4, delay: 0.6 }}\n          >\n            <AchievementBadges />\n          </motion.div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":35643,"size_tokens":null},"client/src/pages/financial-goals.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useTranslation } from 'react-i18next';\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus, Target, MoreHorizontal, Edit, Trash2, TrendingUp, DollarSign, \n  Calendar, BarChart3, Lightbulb, Award, Settings, Share2, CheckCircle2, \n  AlertCircle, Sparkles, Clock, Zap, Trophy, Star, PiggyBank\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport EmptyState from \"@/components/ui/empty-state\";\nimport { Skeleton, SkeletonGoal } from \"@/components/ui/skeleton\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Drawer, DrawerContent, DrawerTrigger, DrawerTitle, DrawerDescription } from \"@/components/ui/drawer\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport GoalForm from \"@/components/forms/goal-form\";\nimport EditGoalForm from \"@/components/forms/edit-goal-form\";\nimport AddFundsForm from \"@/components/forms/add-funds-form\";\nimport AdvancedProgressVisualization from \"@/components/goals/advanced-progress-visualization\";\nimport SmartGoalInsights from \"@/components/goals/smart-goal-insights\";\nimport AutomatedSavingsSuggestions from \"@/components/goals/automated-savings-suggestions\";\nimport AchievementMilestones from \"@/components/goals/achievement-milestones\";\nimport ShareGoalDialog from \"@/components/sharing/share-goal-dialog\";\nimport { CollapsibleList } from \"@/components/virtual-list\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\nfunction AnimatedNumber({ value, prefix = \"$\", delay = 0 }: { value: number; prefix?: string; delay?: number }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      const duration = 1000;\n      const steps = 60;\n      const increment = value / steps;\n      let current = 0;\n      \n      const interval = setInterval(() => {\n        current += increment;\n        if (current >= value) {\n          setDisplayValue(value);\n          clearInterval(interval);\n        } else {\n          setDisplayValue(current);\n        }\n      }, duration / steps);\n      \n      return () => clearInterval(interval);\n    }, delay);\n    \n    return () => clearTimeout(timer);\n  }, [value, delay]);\n  \n  return <span>{prefix}{Math.round(displayValue).toLocaleString()}</span>;\n}\n\nfunction CircularProgress({ \n  progress, \n  size = 120, \n  strokeWidth = 8,\n  delay = 0 \n}: { \n  progress: number; \n  size?: number; \n  strokeWidth?: number;\n  delay?: number;\n}) {\n  const [animatedProgress, setAnimatedProgress] = useState(0);\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (animatedProgress / 100) * circumference;\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      const duration = 1200;\n      const steps = 60;\n      const increment = progress / steps;\n      let current = 0;\n      \n      const interval = setInterval(() => {\n        current += increment;\n        if (current >= progress) {\n          setAnimatedProgress(progress);\n          clearInterval(interval);\n        } else {\n          setAnimatedProgress(current);\n        }\n      }, duration / steps);\n      \n      return () => clearInterval(interval);\n    }, delay);\n    \n    return () => clearTimeout(timer);\n  }, [progress, delay]);\n  \n  const getProgressColor = () => {\n    if (animatedProgress >= 80) return \"stroke-green-500\";\n    if (animatedProgress >= 50) return \"stroke-primary\";\n    if (animatedProgress >= 25) return \"stroke-amber-500\";\n    return \"stroke-red-500\";\n  };\n  \n  return (\n    <div className=\"relative\" style={{ width: size, height: size }}>\n      <svg className=\"transform -rotate-90\" width={size} height={size}>\n        <circle\n          className=\"stroke-muted\"\n          strokeWidth={strokeWidth}\n          fill=\"transparent\"\n          r={radius}\n          cx={size / 2}\n          cy={size / 2}\n        />\n        <circle\n          className={`${getProgressColor()} transition-all duration-300`}\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          fill=\"transparent\"\n          r={radius}\n          cx={size / 2}\n          cy={size / 2}\n          style={{\n            strokeDasharray: circumference,\n            strokeDashoffset: offset,\n          }}\n        />\n      </svg>\n      <div className=\"absolute inset-0 flex items-center justify-center\">\n        <span className=\"text-xl sm:text-2xl font-bold\">{Math.round(animatedProgress)}%</span>\n      </div>\n    </div>\n  );\n}\n\nfunction RecentContributions({ goalId }: { goalId: string }) {\n  const { formatAmount } = useUserCurrency();\n  const { data: transactions, isLoading } = useQuery({\n    queryKey: [\"/api/transactions\", goalId],\n    queryFn: () => fetch(`/api/transactions?goalId=${goalId}&limit=5`).then(res => res.json()),\n  });\n\n  if (isLoading) {\n    return (\n      <div>\n        <h4 className=\"font-semibold mb-3\">Recent Contributions</h4>\n        <div className=\"space-y-2\">\n          {[...Array(3)].map((_, i) => (\n            <div key={i} className=\"flex justify-between items-center p-3 bg-muted/50 rounded-lg\">\n              <div className=\"space-y-1\">\n                <Skeleton className=\"h-3 w-20\" />\n                <Skeleton className=\"h-2 w-32\" />\n              </div>\n              <Skeleton className=\"h-4 w-16\" />\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const recentTransactions = transactions || [];\n\n  return (\n    <div>\n      <h4 className=\"font-semibold mb-3\">Recent Contributions</h4>\n      {recentTransactions.length === 0 ? (\n        <div className=\"text-center py-6 text-muted-foreground\">\n          <DollarSign className=\"mx-auto h-8 w-8 mb-2 opacity-50\" />\n          <p className=\"text-sm\">No contributions yet</p>\n          <p className=\"text-xs\">Start adding funds or income to see contributions here</p>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          {recentTransactions.map((transaction: any, index: number) => (\n            <motion.div \n              key={transaction.id} \n              className=\"flex justify-between items-center p-3 bg-muted/50 rounded-lg\"\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: index * 0.1 }}\n            >\n              <div className=\"flex items-start space-x-3\">\n                <div className={`p-1.5 rounded-full ${transaction.type === 'income' ? 'bg-green-100 dark:bg-green-900/20' : 'bg-blue-100 dark:bg-blue-900/20'}`}>\n                  {transaction.type === 'income' ? (\n                    <TrendingUp className={`h-3 w-3 ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400'}`} />\n                  ) : (\n                    <DollarSign className={`h-3 w-3 ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400'}`} />\n                  )}\n                </div>\n                <div className=\"min-w-0 flex-1\">\n                  <p className=\"text-sm font-medium\">\n                    {transaction.type === 'income' ? 'Income' : 'Transfer'}\n                    {transaction.category && ` - ${transaction.category}`}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground truncate\">\n                    {transaction.description || `${transaction.type === 'income' ? 'Income' : 'Transfer'} contribution`}\n                  </p>\n                  <div className=\"flex items-center text-xs text-muted-foreground mt-1\">\n                    <Calendar className=\"h-3 w-3 mr-1\" />\n                    {new Date(transaction.date).toLocaleDateString()}\n                  </div>\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <span className={`font-semibold ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400'}`}>\n                  +{formatAmount(parseFloat(transaction.amount))}\n                </span>\n              </div>\n            </motion.div>\n          ))}\n          {recentTransactions.length === 5 && (\n            <div className=\"text-center py-2\">\n              <p className=\"text-xs text-muted-foreground\">Showing last 5 contributions</p>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction GoalCard({ \n  goal, \n  onEdit, \n  onDelete, \n  onAddFunds, \n  onViewDetails, \n  onShare,\n  delay = 0\n}: { \n  goal: any; \n  onEdit: () => void; \n  onDelete: () => void; \n  onAddFunds: () => void; \n  onViewDetails: () => void;\n  onShare: () => void;\n  delay?: number;\n}) {\n  const { formatAmount, currencySymbol } = useUserCurrency();\n  const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n  const remaining = parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount);\n  const daysLeft = Math.ceil((new Date(goal.targetDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));\n  \n  const getDaysColor = () => {\n    if (daysLeft < 0) return \"text-red-600 dark:text-red-400\";\n    if (daysLeft < 30) return \"text-amber-600 dark:text-amber-400\";\n    return \"text-green-600 dark:text-green-400\";\n  };\n  \n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"active\":\n        return <Badge className=\"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-0\">Active</Badge>;\n      case \"completed\":\n        return <Badge className=\"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-0\">Completed</Badge>;\n      case \"paused\":\n        return <Badge className=\"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-0\">Paused</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n    >\n      <Card className=\"group relative overflow-hidden border-border/40 hover:shadow-lg hover:border-border transition-all duration-300\">\n        <div className=\"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-primary/50 via-primary to-primary/50\" \n          style={{ \n            clipPath: `inset(0 ${100 - Math.min(progress, 100)}% 0 0)` \n          }} \n        />\n        \n        <CardHeader className=\"pb-3 sm:pb-4 p-4 sm:p-6\">\n          <div className=\"flex items-start justify-between gap-2\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 mb-1\">\n                {getStatusBadge(goal.status)}\n                {progress >= 100 && (\n                  <Badge className=\"bg-primary/10 text-primary border-0\">\n                    <Trophy className=\"w-3 h-3 mr-1\" />\n                    Goal Reached\n                  </Badge>\n                )}\n              </div>\n              <CardTitle \n                className=\"text-base sm:text-lg font-semibold truncate\" \n                data-testid={`text-goal-title-${goal.id}`}\n                title={goal.title}\n              >\n                {goal.title}\n              </CardTitle>\n              {goal.description && (\n                <p className=\"text-xs sm:text-sm text-muted-foreground line-clamp-2 mt-1\" title={goal.description}>\n                  {goal.description}\n                </p>\n              )}\n            </div>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity\" data-testid={`button-goal-menu-${goal.id}`}>\n                  <MoreHorizontal size={16} />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={onEdit}>\n                  <Edit size={16} className=\"mr-2\" />\n                  Edit Goal\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={onShare}>\n                  <Share2 size={16} className=\"mr-2\" />\n                  Share with Friends\n                </DropdownMenuItem>\n                <DropdownMenuItem className=\"text-destructive\" onClick={onDelete}>\n                  <Trash2 size={16} className=\"mr-2\" />\n                  Delete Goal\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"p-4 sm:p-6 pt-0\">\n          <div className=\"flex items-center gap-4 sm:gap-6 mb-4 sm:mb-6\">\n            <CircularProgress progress={Math.min(progress, 100)} size={80} strokeWidth={6} delay={delay * 1000 + 200} />\n            <div className=\"flex-1 min-w-0 space-y-2\">\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Current</p>\n                <p className=\"text-lg sm:text-xl font-bold text-primary\">\n                  <AnimatedNumber value={parseFloat(goal.currentAmount)} prefix={currencySymbol} delay={delay * 1000 + 100} />\n                </p>\n              </div>\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Target</p>\n                <p className=\"text-sm font-medium\">{formatAmount(parseFloat(goal.targetAmount))}</p>\n              </div>\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3 mb-4\">\n            <div className=\"flex items-center gap-2 p-2.5 sm:p-3 rounded-lg bg-muted/50\">\n              <Clock className=\"w-4 h-4 text-muted-foreground\" />\n              <div className=\"min-w-0\">\n                <p className=\"text-[10px] sm:text-xs text-muted-foreground\">Time Left</p>\n                <p className={`text-xs sm:text-sm font-semibold ${getDaysColor()}`}>\n                  {daysLeft > 0 ? `${daysLeft} days` : daysLeft === 0 ? \"Due today\" : \"Overdue\"}\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2 p-2.5 sm:p-3 rounded-lg bg-muted/50\">\n              <DollarSign className=\"w-4 h-4 text-muted-foreground\" />\n              <div className=\"min-w-0\">\n                <p className=\"text-[10px] sm:text-xs text-muted-foreground\">Remaining</p>\n                <p className=\"text-xs sm:text-sm font-semibold\">{formatAmount(remaining)}</p>\n              </div>\n            </div>\n          </div>\n          \n          {daysLeft > 0 && remaining > 0 && (\n            <div className=\"p-2.5 sm:p-3 rounded-lg bg-primary/5 border border-primary/10 mb-4\">\n              <div className=\"flex items-center gap-2\">\n                <Zap className=\"w-4 h-4 text-primary\" />\n                <p className=\"text-xs text-muted-foreground\">\n                  Save <span className=\"font-semibold text-foreground\">{formatAmount(Math.ceil(remaining / daysLeft))}/day</span> to reach your goal\n                </p>\n              </div>\n            </div>\n          )}\n          \n          <div className=\"flex gap-2\">\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              className=\"flex-1 text-xs h-9\"\n              onClick={onAddFunds}\n              data-testid={`button-add-funds-${goal.id}`}\n            >\n              <Plus className=\"w-3.5 h-3.5 mr-1.5\" />\n              Add Funds\n            </Button>\n            <Button \n              size=\"sm\" \n              className=\"flex-1 text-xs h-9\"\n              onClick={onViewDetails}\n              data-testid={`button-view-details-${goal.id}`}\n            >\n              View Details\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction SummaryCard({ \n  title, \n  value, \n  icon: Icon, \n  colorClass, \n  bgClass,\n  delay = 0,\n  suffix = \"\",\n  currencyPrefix = \"\"\n}: { \n  title: string; \n  value: number; \n  icon: any; \n  colorClass: string; \n  bgClass: string;\n  delay?: number;\n  suffix?: string;\n  currencyPrefix?: string;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n    >\n      <Card className=\"border-border/40 hover:shadow-md transition-shadow\">\n        <CardContent className=\"p-4 sm:p-6\">\n          <div className=\"flex items-center gap-2 sm:gap-3 mb-2 sm:mb-3\">\n            <div className={`p-2 rounded-xl ${bgClass}`}>\n              <Icon className={`w-4 h-4 sm:w-5 sm:h-5 ${colorClass}`} />\n            </div>\n            <span className=\"text-xs sm:text-sm font-medium text-muted-foreground\">{title}</span>\n          </div>\n          <p className={`text-xl sm:text-2xl md:text-3xl font-bold tracking-tight ${colorClass}`}>\n            <AnimatedNumber value={value} prefix={suffix ? \"\" : currencyPrefix} delay={delay * 1000} />\n            {suffix && <span className=\"text-lg sm:text-xl text-muted-foreground/60\">{suffix}</span>}\n          </p>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nexport default function FinancialGoals() {\n  const { t } = useTranslation();\n  const { formatAmount, currencySymbol } = useUserCurrency();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isFirstGoalDialogOpen, setIsFirstGoalDialogOpen] = useState(false);\n  const [activeTab, setActiveTab] = useState('overview');\n  \n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get('create') === '1') {\n      setIsCreateDialogOpen(true);\n      window.history.replaceState({}, '', '/financial-goals');\n    }\n  }, []);\n  \n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isAddFundsDialogOpen, setIsAddFundsDialogOpen] = useState(false);\n  const [isViewDetailsDialogOpen, setIsViewDetailsDialogOpen] = useState(false);\n  const [isShareDialogOpen, setIsShareDialogOpen] = useState(false);\n  const [selectedGoal, setSelectedGoal] = useState<any>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: goals, isLoading } = useQuery({\n    queryKey: [\"/api/financial-goals\"],\n    queryFn: () => fetch(\"/api/financial-goals\").then(res => res.json()),\n  });\n\n  const financialGoals = goals || [];\n\n  const deleteGoalMutation = useMutation({\n    mutationFn: (goalId: string) => apiRequest(\"DELETE\", `/api/financial-goals/${goalId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n      toast({\n        title: \"Goal deleted\",\n        description: \"The financial goal has been successfully deleted.\",\n        icon: <CheckCircle2 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Couldn't Delete Goal\",\n        description: error.message || \"Something went wrong. Please try again.\",\n        variant: \"destructive\",\n        icon: <AlertCircle className=\"h-5 w-5\" />,\n      });\n    },\n  });\n\n  const handleDeleteGoal = (goalId: string) => {\n    if (confirm(\"Are you sure you want to delete this goal?\")) {\n      deleteGoalMutation.mutate(goalId);\n    }\n  };\n\n  const handleEditGoal = (goal: any) => {\n    setSelectedGoal(goal);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleAddFunds = (goal: any) => {\n    setSelectedGoal(goal);\n    setIsAddFundsDialogOpen(true);\n  };\n\n  const handleViewDetails = (goal: any) => {\n    setSelectedGoal(goal);\n    setIsViewDetailsDialogOpen(true);\n  };\n\n  const handleShareGoal = (goal: any) => {\n    setSelectedGoal(goal);\n    setIsShareDialogOpen(true);\n  };\n\n  const handleInsightAction = (action: string, goalId?: string) => {\n    switch (action) {\n      case 'review-timeline':\n        if (goalId) {\n          const goal = financialGoals.find((g: any) => g.id === goalId);\n          if (goal) handleEditGoal(goal);\n        }\n        break;\n      case 'quick-contribute':\n        if (goalId) {\n          const goal = financialGoals.find((g: any) => g.id === goalId);\n          if (goal) handleAddFunds(goal);\n        } else if (financialGoals.length > 0) {\n          handleAddFunds(financialGoals[0]);\n        }\n        break;\n      case 'create-short-term':\n        setIsCreateDialogOpen(true);\n        break;\n      default:\n        toast({\n          title: \"Coming Soon\",\n          description: \"This feature will be available in a future update.\",\n        });\n    }\n  };\n\n  const handleSavingsSuggestion = (suggestion: any) => {\n    toast({\n      title: \"Suggestion Noted\",\n      description: `We'll help you implement: ${suggestion.title}`,\n    });\n  };\n\n  const handleCelebrateMilestone = (milestone: any) => {\n    toast({\n      title: \"Congratulations!\",\n      description: `You've unlocked: ${milestone.title}`,\n    });\n  };\n\n  const totalSaved = financialGoals.reduce((sum: number, goal: any) => sum + parseFloat(goal.currentAmount || 0), 0);\n  const activeGoals = financialGoals.filter((goal: any) => goal.status === \"active\").length;\n  const avgProgress = financialGoals.length > 0 \n    ? Math.round(financialGoals.reduce((sum: number, goal: any) => {\n        const progress = (parseFloat(goal.currentAmount || 0) / parseFloat(goal.targetAmount || 1)) * 100;\n        return sum + progress;\n      }, 0) / financialGoals.length)\n    : 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n          <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6\">\n            <Skeleton className=\"h-8 w-48 mb-2\" />\n            <Skeleton className=\"h-4 w-64\" />\n          </div>\n        </header>\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-8\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6\">\n            {[...Array(3)].map((_, i) => (\n              <Card key={i} className=\"p-6\">\n                <Skeleton className=\"h-10 w-10 rounded-xl mb-3\" />\n                <Skeleton className=\"h-4 w-24 mb-2\" />\n                <Skeleton className=\"h-8 w-32\" />\n              </Card>\n            ))}\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n            {[...Array(6)].map((_, i) => (\n              <SkeletonGoal key={i} />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen-mobile bg-background pb-20 md:pb-0\">\n      <Drawer open={isFirstGoalDialogOpen} onOpenChange={setIsFirstGoalDialogOpen}>\n        <DrawerContent className=\"max-h-[90vh]\">\n          <div className=\"p-4 pb-6\">\n            <DrawerTitle className=\"text-xl font-semibold mb-2\">Create Your First Goal</DrawerTitle>\n            <DrawerDescription className=\"text-muted-foreground mb-4\">\n              Start your financial journey by setting up your first savings goal\n            </DrawerDescription>\n            <GoalForm onSuccess={() => setIsFirstGoalDialogOpen(false)} />\n          </div>\n        </DrawerContent>\n      </Drawer>\n      \n      <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-4 sm:py-6\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <motion.div \n              className=\"flex-1 min-w-0\"\n              initial={{ opacity: 0, x: -20 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ duration: 0.4 }}\n            >\n              <h1 className=\"text-xl sm:text-2xl md:text-3xl font-semibold tracking-tight text-foreground\">\n                Financial Goals\n              </h1>\n              <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 hidden sm:block\">\n                Track your savings progress and achieve your financial targets\n              </p>\n            </motion.div>\n            \n            <motion.div\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.3, delay: 0.2 }}\n            >\n              <Drawer open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n                <DrawerTrigger asChild>\n                  <Button \n                    className=\"shadow-sm min-h-[44px]\"\n                    data-testid=\"button-create-goal\"\n                  >\n                    <Plus className=\"h-4 w-4 sm:mr-2\" />\n                    <span className=\"hidden sm:inline\">New Goal</span>\n                    <span className=\"sm:hidden\">New</span>\n                  </Button>\n                </DrawerTrigger>\n                <DrawerContent className=\"max-h-[90vh]\">\n                  <div className=\"p-4 pb-6\">\n                    <DrawerTitle className=\"text-xl font-semibold mb-2\">Create New Goal</DrawerTitle>\n                    <DrawerDescription className=\"text-muted-foreground mb-4\">\n                      Set up a new financial goal to track your savings progress\n                    </DrawerDescription>\n                    <GoalForm onSuccess={() => setIsCreateDialogOpen(false)} />\n                  </div>\n                </DrawerContent>\n              </Drawer>\n            </motion.div>\n          </div>\n        </div>\n      </header>\n      \n      <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-4 sm:py-6 md:py-8\">\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4 sm:space-y-6\">\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.3 }}\n          >\n            <TabsList className=\"grid w-full grid-cols-4 h-auto bg-muted/50\">\n              <TabsTrigger value=\"overview\" data-testid=\"tab-overview\" className=\"text-xs sm:text-sm min-h-[44px] py-2.5 sm:py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm\" aria-label=\"Overview\">\n                <Target className=\"h-4 w-4 sm:mr-2\" />\n                <span className=\"sr-only sm:not-sr-only\">Overview</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"analytics\" data-testid=\"tab-analytics\" className=\"text-xs sm:text-sm min-h-[44px] py-2.5 sm:py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm\" aria-label=\"Analytics\">\n                <BarChart3 className=\"h-4 w-4 sm:mr-2\" />\n                <span className=\"sr-only sm:not-sr-only\">Analytics</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"insights\" data-testid=\"tab-insights\" className=\"text-xs sm:text-sm min-h-[44px] py-2.5 sm:py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm\" aria-label=\"Insights\">\n                <Lightbulb className=\"h-4 w-4 sm:mr-2\" />\n                <span className=\"sr-only sm:not-sr-only\">Insights</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"achievements\" data-testid=\"tab-achievements\" className=\"text-xs sm:text-sm min-h-[44px] py-2.5 sm:py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm\" aria-label=\"Achievements\">\n                <Award className=\"h-4 w-4 sm:mr-2\" />\n                <span className=\"sr-only sm:not-sr-only\">Achievements</span>\n              </TabsTrigger>\n            </TabsList>\n          </motion.div>\n\n          <TabsContent value=\"overview\" className=\"space-y-4 sm:space-y-6\">\n            {financialGoals.length === 0 ? (\n              <EmptyState\n                illustration=\"goals\"\n                title=\"No Financial Goals Yet\"\n                description=\"Create your first financial goal to start tracking your savings progress and build your future.\"\n                actionLabel=\"Create Your First Goal\"\n                onAction={() => setIsFirstGoalDialogOpen(true)}\n                actionTestId=\"button-create-first-goal\"\n              />\n            ) : (\n              <>\n                <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4\">\n                  <SummaryCard\n                    title=\"Total Saved\"\n                    value={totalSaved}\n                    icon={PiggyBank}\n                    colorClass=\"text-green-600 dark:text-green-400\"\n                    bgClass=\"bg-green-100 dark:bg-green-900/30\"\n                    delay={0}\n                    currencyPrefix={currencySymbol}\n                  />\n                  <SummaryCard\n                    title=\"Active Goals\"\n                    value={activeGoals}\n                    icon={Target}\n                    colorClass=\"text-primary\"\n                    bgClass=\"bg-primary/10\"\n                    delay={0.1}\n                    suffix=\"\"\n                  />\n                  <SummaryCard\n                    title=\"Avg Progress\"\n                    value={avgProgress}\n                    icon={TrendingUp}\n                    colorClass=\"text-blue-600 dark:text-blue-400\"\n                    bgClass=\"bg-blue-100 dark:bg-blue-900/30\"\n                    delay={0.2}\n                    suffix=\"%\"\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n                  <AnimatePresence mode=\"popLayout\">\n                    {financialGoals.map((goal: any, index: number) => (\n                      <GoalCard\n                        key={goal.id}\n                        goal={goal}\n                        onEdit={() => handleEditGoal(goal)}\n                        onDelete={() => handleDeleteGoal(goal.id)}\n                        onAddFunds={() => handleAddFunds(goal)}\n                        onViewDetails={() => handleViewDetails(goal)}\n                        onShare={() => handleShareGoal(goal)}\n                        delay={index * 0.1}\n                      />\n                    ))}\n                  </AnimatePresence>\n                </div>\n              </>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"analytics\" className=\"space-y-6\">\n            <AdvancedProgressVisualization \n              goals={financialGoals} \n              onGoalClick={handleViewDetails}\n            />\n          </TabsContent>\n\n          <TabsContent value=\"insights\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <SmartGoalInsights \n                goals={financialGoals}\n                onActionClick={handleInsightAction}\n              />\n              <AutomatedSavingsSuggestions \n                goals={financialGoals}\n                onImplementSuggestion={handleSavingsSuggestion}\n              />\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"achievements\" className=\"space-y-6\">\n            <AchievementMilestones \n              goals={financialGoals}\n              onCelebrate={handleCelebrateMilestone}\n            />\n          </TabsContent>\n        </Tabs>\n        \n        <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n          <DialogContent className=\"w-[95vw] max-w-2xl max-h-[90vh] overflow-y-auto\">\n            {selectedGoal && (\n              <EditGoalForm \n                goal={selectedGoal} \n                onSuccess={() => setIsEditDialogOpen(false)} \n              />\n            )}\n          </DialogContent>\n        </Dialog>\n        \n        <Dialog open={isAddFundsDialogOpen} onOpenChange={setIsAddFundsDialogOpen}>\n          <DialogContent className=\"w-[95vw] max-w-md max-h-[90vh] overflow-y-auto\">\n            {selectedGoal && (\n              <AddFundsForm \n                goalId={selectedGoal.id}\n                goalTitle={selectedGoal.title}\n                currentAmount={selectedGoal.currentAmount}\n                targetAmount={selectedGoal.targetAmount}\n                onSuccess={() => setIsAddFundsDialogOpen(false)} \n              />\n            )}\n          </DialogContent>\n        </Dialog>\n        \n        {selectedGoal && (\n          <ShareGoalDialog\n            goalId={selectedGoal.id}\n            goalTitle={selectedGoal.title}\n            open={isShareDialogOpen}\n            onOpenChange={setIsShareDialogOpen}\n          />\n        )}\n        \n        <Dialog open={isViewDetailsDialogOpen} onOpenChange={setIsViewDetailsDialogOpen}>\n          <DialogContent className=\"w-[95vw] max-w-2xl max-h-[90vh] overflow-y-auto\">\n            {selectedGoal && (\n              <div className=\"space-y-6\">\n                <div>\n                  <h2 className=\"text-xl font-semibold mb-1\">{selectedGoal.title}</h2>\n                  {selectedGoal.description && (\n                    <p className=\"text-muted-foreground text-sm\">{selectedGoal.description}</p>\n                  )}\n                </div>\n                \n                <div className=\"flex items-center justify-center py-6\">\n                  <CircularProgress \n                    progress={Math.min((parseFloat(selectedGoal.currentAmount) / parseFloat(selectedGoal.targetAmount)) * 100, 100)} \n                    size={160} \n                    strokeWidth={12}\n                  />\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"p-4 rounded-xl bg-muted/50\">\n                    <p className=\"text-xs text-muted-foreground mb-1\">Current Amount</p>\n                    <p className=\"text-xl font-bold text-green-600\">{formatAmount(parseFloat(selectedGoal.currentAmount))}</p>\n                  </div>\n                  <div className=\"p-4 rounded-xl bg-muted/50\">\n                    <p className=\"text-xs text-muted-foreground mb-1\">Target Amount</p>\n                    <p className=\"text-xl font-bold\">{formatAmount(parseFloat(selectedGoal.targetAmount))}</p>\n                  </div>\n                  <div className=\"p-4 rounded-xl bg-muted/50\">\n                    <p className=\"text-xs text-muted-foreground mb-1\">Remaining</p>\n                    <p className=\"text-xl font-bold\">{formatAmount(parseFloat(selectedGoal.targetAmount) - parseFloat(selectedGoal.currentAmount))}</p>\n                  </div>\n                  <div className=\"p-4 rounded-xl bg-muted/50\">\n                    <p className=\"text-xs text-muted-foreground mb-1\">Target Date</p>\n                    <p className=\"text-xl font-bold\">{new Date(selectedGoal.targetDate).toLocaleDateString()}</p>\n                  </div>\n                </div>\n                \n                <RecentContributions goalId={selectedGoal.id} />\n                \n                <div className=\"flex gap-3\">\n                  <Button variant=\"outline\" className=\"flex-1\" onClick={() => handleEditGoal(selectedGoal)}>\n                    <Edit className=\"w-4 h-4 mr-2\" />\n                    Edit Goal\n                  </Button>\n                  <Button className=\"flex-1\" onClick={() => { setIsViewDetailsDialogOpen(false); handleAddFunds(selectedGoal); }}>\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Add Funds\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":35630,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { Button } from \"../components/ui/button\";\nimport { Card } from \"../components/ui/card\";\nimport { Badge } from \"../components/ui/badge\";\nimport { Link, useLocation } from \"wouter\";\nimport { useTranslation } from \"react-i18next\";\nimport { motion, useInView } from \"framer-motion\";\nimport { useRef, useEffect, useState } from \"react\";\nimport { \n  Shield, \n  Check, \n  Brain, \n  Target, \n  Wallet, \n  TrendingUp,\n  Sparkles,\n  ArrowRight,\n  Zap,\n  Lock,\n  Globe,\n  MessageSquare,\n  ChevronRight,\n  BarChart3,\n  PiggyBank\n} from \"lucide-react\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\nfunction useReducedMotion() {\n  const [prefersReducedMotion, setPrefersReducedMotion] = useState(false);\n  \n  useEffect(() => {\n    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');\n    setPrefersReducedMotion(mediaQuery.matches);\n    \n    const handler = (event: MediaQueryListEvent) => setPrefersReducedMotion(event.matches);\n    mediaQuery.addEventListener('change', handler);\n    return () => mediaQuery.removeEventListener('change', handler);\n  }, []);\n  \n  return prefersReducedMotion;\n}\n\nfunction AnimatedCounter({ value, suffix = \"\", prefix = \"\" }: { value: number; suffix?: string; prefix?: string }) {\n  const [count, setCount] = useState(0);\n  const ref = useRef(null);\n  const isInView = useInView(ref, { once: true });\n  const prefersReducedMotion = useReducedMotion();\n\n  useEffect(() => {\n    if (prefersReducedMotion) {\n      setCount(value);\n      return;\n    }\n    if (isInView) {\n      const duration = 2000;\n      const steps = 60;\n      const increment = value / steps;\n      let current = 0;\n      const timer = setInterval(() => {\n        current += increment;\n        if (current >= value) {\n          setCount(value);\n          clearInterval(timer);\n        } else {\n          setCount(Math.floor(current));\n        }\n      }, duration / steps);\n      return () => clearInterval(timer);\n    }\n  }, [isInView, value, prefersReducedMotion]);\n\n  return <span ref={ref}>{prefix}{count}{suffix}</span>;\n}\n\nfunction FloatingElement({ children, delay = 0, className = \"\" }: { children: React.ReactNode; delay?: number; className?: string }) {\n  const prefersReducedMotion = useReducedMotion();\n  \n  if (prefersReducedMotion) {\n    return <div className={className}>{children}</div>;\n  }\n  \n  return (\n    <motion.div\n      initial={{ y: 0 }}\n      animate={{ y: [-10, 10, -10] }}\n      transition={{ duration: 6, repeat: Infinity, delay, ease: \"easeInOut\" }}\n      className={className}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\nexport default function Landing() {\n  const [, setLocation] = useLocation();\n  const { t } = useTranslation();\n  const { formatAmount, convertFromUSD } = useUserCurrency();\n\n  const fadeInUp = {\n    initial: { opacity: 0, y: 30 },\n    animate: { opacity: 1, y: 0 },\n    transition: { duration: 0.6 }\n  };\n\n  const staggerContainer = {\n    animate: { transition: { staggerChildren: 0.1 } }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-black overflow-hidden\">\n      {/* Animated Background Gradient */}\n      <div className=\"fixed inset-0 pointer-events-none\">\n        <div className=\"absolute top-0 left-1/4 w-[600px] h-[600px] bg-blue-500/20 dark:bg-blue-500/10 rounded-full blur-[120px] animate-pulse\" />\n        <div className=\"absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-purple-500/15 dark:bg-purple-500/10 rounded-full blur-[100px] animate-pulse\" style={{ animationDelay: \"1s\" }} />\n        <div className=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-blue-600/10 dark:bg-blue-600/5 rounded-full blur-[150px]\" />\n      </div>\n\n      {/* Header with Glassmorphism */}\n      <header className=\"border-b border-gray-200/50 dark:border-gray-800/50 bg-white/70 dark:bg-black/70 backdrop-blur-xl sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8 py-4 flex items-center justify-between\">\n          <motion.div \n            className=\"flex items-center gap-3\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ duration: 0.5 }}\n          >\n            <div className=\"relative\">\n              <div className=\"absolute inset-0 bg-blue-500/20 rounded-full blur-md\" />\n              <img src={logoUrl} alt=\"Twealth\" className=\"w-9 h-9 relative\" />\n            </div>\n            <span className=\"text-xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400 bg-clip-text text-transparent\">Twealth</span>\n          </motion.div>\n          <motion.div \n            className=\"flex items-center gap-4\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ duration: 0.5 }}\n          >\n            <Button \n              onClick={() => setLocation(\"/login\")}\n              variant=\"ghost\"\n              className=\"text-sm font-medium hidden sm:flex hover:bg-blue-50 dark:hover:bg-blue-950/50\"\n              data-testid=\"header-signin-button\"\n            >\n              {t('landing.header.signIn')}\n            </Button>\n            <Button \n              onClick={() => setLocation(\"/login\")}\n              size=\"sm\"\n              className=\"text-sm font-medium bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white shadow-lg shadow-blue-500/25 border-0\"\n              data-testid=\"header-getstarted-button\"\n            >\n              {t('landing.header.getStarted')}\n              <ChevronRight className=\"w-4 h-4 ml-1\" />\n            </Button>\n          </motion.div>\n        </div>\n      </header>\n\n      {/* Hero Section */}\n      <section className=\"relative pt-20 sm:pt-28 pb-20\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\n          <div className=\"grid lg:grid-cols-2 gap-12 lg:gap-16 items-center\">\n            {/* Left Content */}\n            <motion.div \n              className=\"text-center lg:text-left\"\n              initial={{ opacity: 0, y: 40 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.7 }}\n            >\n              <motion.div\n                initial={{ opacity: 0, scale: 0.9 }}\n                animate={{ opacity: 1, scale: 1 }}\n                transition={{ duration: 0.5, delay: 0.2 }}\n              >\n                <Badge \n                  className=\"mb-6 px-4 py-2 text-sm font-medium bg-gradient-to-r from-blue-500/10 to-purple-500/10 border-blue-200/50 dark:border-blue-800/50 text-blue-700 dark:text-blue-300\"\n                >\n                  <Sparkles className=\"w-4 h-4 mr-2\" />\n                  {t('landing.hero.badge')}\n                </Badge>\n              </motion.div>\n              \n              <h1 className=\"text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight mb-6 leading-[1.1]\">\n                <span className=\"bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 dark:from-white dark:via-gray-200 dark:to-white bg-clip-text text-transparent\">\n                  {t('landing.hero.title')}\n                </span>\n                <br />\n                <span className=\"bg-gradient-to-r from-blue-600 via-blue-500 to-purple-600 bg-clip-text text-transparent\">\n                  {t('landing.hero.titleHighlight')}\n                </span>\n              </h1>\n              \n              <p className=\"text-lg sm:text-xl text-gray-600 dark:text-gray-400 mb-8 max-w-xl mx-auto lg:mx-0 leading-relaxed\">\n                {t('landing.hero.subtitle')}\n              </p>\n              \n              <div className=\"flex flex-col sm:flex-row gap-4 justify-center lg:justify-start mb-8\">\n                <Button \n                  onClick={() => setLocation(\"/login\")} \n                  size=\"lg\"\n                  className=\"h-14 px-8 text-base font-semibold bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl shadow-xl shadow-blue-500/30 border-0 group\"\n                  data-testid=\"hero-get-started-button\"\n                >\n                  {t('landing.hero.startFree')}\n                  <ArrowRight className=\"w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform\" />\n                </Button>\n                <Button \n                  onClick={() => setLocation(\"/subscription\")}\n                  variant=\"outline\" \n                  size=\"lg\"\n                  className=\"h-14 px-8 text-base font-medium border-2 border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-700 hover:bg-blue-50/50 dark:hover:bg-blue-950/30 rounded-xl transition-all\"\n                  data-testid=\"hero-view-pricing-button\"\n                >\n                  {t('landing.hero.viewPricing')}\n                </Button>\n              </div>\n              \n              <div className=\"flex flex-wrap items-center justify-center lg:justify-start gap-6 text-sm\">\n                <div className=\"flex items-center gap-2 text-gray-600 dark:text-gray-400\">\n                  <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center\">\n                    <Check className=\"w-3 h-3 text-green-600 dark:text-green-400\" />\n                  </div>\n                  <span>{t('landing.hero.freeForever')}</span>\n                </div>\n                <div className=\"flex items-center gap-2 text-gray-600 dark:text-gray-400\">\n                  <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center\">\n                    <Check className=\"w-3 h-3 text-green-600 dark:text-green-400\" />\n                  </div>\n                  <span>{t('landing.hero.noCreditCard')}</span>\n                </div>\n                <div className=\"flex items-center gap-2 text-gray-600 dark:text-gray-400\">\n                  <div className=\"w-5 h-5 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center\">\n                    <Shield className=\"w-3 h-3 text-blue-600 dark:text-blue-400\" />\n                  </div>\n                  <span>{t('landing.hero.bankSecurity')}</span>\n                </div>\n              </div>\n            </motion.div>\n\n            {/* Right - AI Preview Mockup */}\n            <motion.div \n              className=\"relative hidden lg:block\"\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.8, delay: 0.3 }}\n            >\n              {/* Glow Effect */}\n              <div className=\"absolute inset-0 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-3xl blur-3xl\" />\n              \n              {/* Main Card */}\n              <div className=\"relative bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl rounded-3xl border border-gray-200/50 dark:border-gray-700/50 shadow-2xl p-6 overflow-hidden\">\n                {/* Header */}\n                <div className=\"flex items-center gap-3 mb-6\">\n                  <div className=\"w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30\">\n                    <Brain className=\"w-5 h-5 text-white\" />\n                  </div>\n                  <div>\n                    <div className=\"font-semibold text-gray-900 dark:text-white\">AI Financial Advisor</div>\n                    <div className=\"text-xs text-green-500 flex items-center gap-1\">\n                      <span className=\"w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse\" />\n                      Online\n                    </div>\n                  </div>\n                </div>\n\n                {/* Chat Preview */}\n                <div className=\"space-y-4 mb-6\">\n                  <FloatingElement delay={0}>\n                    <div className=\"flex justify-end\">\n                      <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2.5 rounded-2xl rounded-tr-md max-w-[80%] text-sm shadow-lg\">\n                        How can I save more money this month?\n                      </div>\n                    </div>\n                  </FloatingElement>\n                  \n                  <FloatingElement delay={0.5}>\n                    <div className=\"flex gap-3\">\n                      <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0\">\n                        <Sparkles className=\"w-4 h-4 text-white\" />\n                      </div>\n                      <div className=\"bg-gray-100 dark:bg-gray-800 px-4 py-3 rounded-2xl rounded-tl-md max-w-[85%]\">\n                        <p className=\"text-sm text-gray-700 dark:text-gray-300 mb-2\">\n                          Based on your spending patterns, here are 3 actionable steps:\n                        </p>\n                        <div className=\"space-y-1.5\">\n                          <div className=\"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400\">\n                            <div className=\"w-4 h-4 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                              <span className=\"text-blue-600 dark:text-blue-400 font-medium\">1</span>\n                            </div>\n                            Reduce dining out by 20%\n                          </div>\n                          <div className=\"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400\">\n                            <div className=\"w-4 h-4 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                              <span className=\"text-blue-600 dark:text-blue-400 font-medium\">2</span>\n                            </div>\n                            Cancel unused subscriptions\n                          </div>\n                          <div className=\"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400\">\n                            <div className=\"w-4 h-4 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                              <span className=\"text-blue-600 dark:text-blue-400 font-medium\">3</span>\n                            </div>\n                            Set up automatic savings\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </FloatingElement>\n                </div>\n\n                {/* Input */}\n                <div className=\"flex items-center gap-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl px-4 py-3 border border-gray-200/50 dark:border-gray-700/50\">\n                  <MessageSquare className=\"w-5 h-5 text-gray-400\" />\n                  <span className=\"text-sm text-gray-400 flex-1\">Ask your AI CFO anything...</span>\n                  <div className=\"w-8 h-8 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center\">\n                    <ArrowRight className=\"w-4 h-4 text-white\" />\n                  </div>\n                </div>\n\n                {/* Floating Stats */}\n                <FloatingElement delay={1} className=\"absolute -right-4 top-20\">\n                  <div className=\"bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 px-4 py-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center\">\n                        <TrendingUp className=\"w-4 h-4 text-green-600\" />\n                      </div>\n                      <div>\n                        <div className=\"text-xs text-gray-500\">Savings</div>\n                        <div className=\"text-sm font-bold text-green-600\">+23%</div>\n                      </div>\n                    </div>\n                  </div>\n                </FloatingElement>\n\n                <FloatingElement delay={1.5} className=\"absolute -left-4 bottom-24\">\n                  <div className=\"bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 px-4 py-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center\">\n                        <BarChart3 className=\"w-4 h-4 text-blue-600\" />\n                      </div>\n                      <div>\n                        <div className=\"text-xs text-gray-500\">Health Score</div>\n                        <div className=\"text-sm font-bold text-blue-600\">85/100</div>\n                      </div>\n                    </div>\n                  </div>\n                </FloatingElement>\n              </div>\n            </motion.div>\n          </div>\n        </div>\n      </section>\n\n      {/* Stats Section with Animation */}\n      <section className=\"relative py-16\">\n        <div className=\"absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700\" />\n        <div className=\"absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=%2260%22 height=%2260%22 viewBox=%220 0 60 60%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23ffffff%22 fill-opacity=%220.05%22%3E%3Cpath d=%22M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-50\" />\n        <div className=\"relative max-w-7xl mx-auto px-6 lg:px-8\">\n          <motion.div \n            className=\"grid grid-cols-2 md:grid-cols-4 gap-8\"\n            initial=\"initial\"\n            whileInView=\"animate\"\n            viewport={{ once: true }}\n            variants={staggerContainer}\n          >\n            <motion.div variants={fadeInUp} className=\"text-center\">\n              <div className=\"text-4xl sm:text-5xl font-bold text-white mb-2\">\n                <AnimatedCounter value={4} />\n              </div>\n              <div className=\"text-blue-100 text-sm font-medium\">{t('landing.stats.aiModels')}</div>\n            </motion.div>\n            <motion.div variants={fadeInUp} className=\"text-center\">\n              <div className=\"text-4xl sm:text-5xl font-bold text-white mb-2\">\n                <AnimatedCounter value={11} />\n              </div>\n              <div className=\"text-blue-100 text-sm font-medium\">{t('landing.stats.languages')}</div>\n            </motion.div>\n            <motion.div variants={fadeInUp} className=\"text-center\">\n              <div className=\"text-4xl sm:text-5xl font-bold text-white mb-2\">\n                <AnimatedCounter value={99} suffix=\"%\" />\n              </div>\n              <div className=\"text-blue-100 text-sm font-medium\">{t('landing.stats.uptime')}</div>\n            </motion.div>\n            <motion.div variants={fadeInUp} className=\"text-center\">\n              <div className=\"text-4xl sm:text-5xl font-bold text-white mb-2\">\n                {formatAmount(convertFromUSD(0))}\n              </div>\n              <div className=\"text-blue-100 text-sm font-medium\">{t('landing.stats.setupFee')}</div>\n            </motion.div>\n          </motion.div>\n        </div>\n      </section>\n\n      {/* Features Section with Glass Cards */}\n      <section className=\"relative py-24\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\n          <motion.div \n            className=\"text-center mb-16\"\n            initial={{ opacity: 0, y: 30 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.6 }}\n          >\n            <Badge className=\"mb-4 px-4 py-1.5 bg-blue-50 dark:bg-blue-950/50 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800\">\n              Features\n            </Badge>\n            <h2 className=\"text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4\">\n              {t('landing.features.title')}\n            </h2>\n            <p className=\"text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto\">\n              {t('landing.features.subtitle')}\n            </p>\n          </motion.div>\n          \n          <motion.div \n            className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\"\n            initial=\"initial\"\n            whileInView=\"animate\"\n            viewport={{ once: true }}\n            variants={staggerContainer}\n          >\n            {[\n              { icon: Brain, title: t('landing.features.aiAdvisor.title'), desc: t('landing.features.aiAdvisor.description'), gradient: \"from-blue-500 to-blue-600\", bg: \"bg-blue-500/10\" },\n              { icon: Wallet, title: t('landing.features.smartTracking.title'), desc: t('landing.features.smartTracking.description'), gradient: \"from-purple-500 to-purple-600\", bg: \"bg-purple-500/10\" },\n              { icon: Target, title: t('landing.features.goalManagement.title'), desc: t('landing.features.goalManagement.description'), gradient: \"from-green-500 to-green-600\", bg: \"bg-green-500/10\" },\n              { icon: TrendingUp, title: t('landing.features.investmentInsights.title'), desc: t('landing.features.investmentInsights.description'), gradient: \"from-amber-500 to-orange-600\", bg: \"bg-amber-500/10\" },\n              { icon: Zap, title: t('landing.features.aiPlaybooks.title'), desc: t('landing.features.aiPlaybooks.description'), gradient: \"from-rose-500 to-pink-600\", bg: \"bg-rose-500/10\" },\n              { icon: PiggyBank, title: t('landing.features.healthScore.title'), desc: t('landing.features.healthScore.description'), gradient: \"from-cyan-500 to-teal-600\", bg: \"bg-cyan-500/10\" },\n            ].map((feature, index) => (\n              <motion.div key={index} variants={fadeInUp}>\n                <Card className=\"group relative p-6 bg-white/60 dark:bg-gray-900/60 backdrop-blur-sm border-gray-200/50 dark:border-gray-700/50 hover:border-blue-300 dark:hover:border-blue-700 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/10 overflow-hidden\">\n                  <div className=\"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity\" />\n                  <div className=\"relative\">\n                    <div className={`w-14 h-14 rounded-2xl ${feature.bg} flex items-center justify-center mb-5 group-hover:scale-110 transition-transform duration-300`}>\n                      <div className={`w-10 h-10 rounded-xl bg-gradient-to-br ${feature.gradient} flex items-center justify-center shadow-lg`}>\n                        <feature.icon className=\"w-5 h-5 text-white\" />\n                      </div>\n                    </div>\n                    <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">{feature.title}</h3>\n                    <p className=\"text-gray-600 dark:text-gray-400 leading-relaxed text-sm\">\n                      {feature.desc}\n                    </p>\n                  </div>\n                </Card>\n              </motion.div>\n            ))}\n          </motion.div>\n        </div>\n      </section>\n\n      {/* Trust Section */}\n      <section className=\"py-16 bg-gray-50/50 dark:bg-gray-950/50 border-y border-gray-100 dark:border-gray-900\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\n          <motion.div \n            className=\"flex flex-wrap justify-center items-center gap-8 md:gap-16\"\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.6 }}\n          >\n            <div className=\"flex items-center gap-3 text-gray-500 dark:text-gray-400\">\n              <div className=\"w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center\">\n                <Lock className=\"w-5 h-5\" />\n              </div>\n              <div className=\"text-sm\">\n                <div className=\"font-semibold text-gray-700 dark:text-gray-300\">256-bit Encryption</div>\n                <div className=\"text-xs\">Bank-level security</div>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 text-gray-500 dark:text-gray-400\">\n              <div className=\"w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center\">\n                <Shield className=\"w-5 h-5\" />\n              </div>\n              <div className=\"text-sm\">\n                <div className=\"font-semibold text-gray-700 dark:text-gray-300\">SOC 2 Compliant</div>\n                <div className=\"text-xs\">Enterprise security</div>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 text-gray-500 dark:text-gray-400\">\n              <div className=\"w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center\">\n                <Globe className=\"w-5 h-5\" />\n              </div>\n              <div className=\"text-sm\">\n                <div className=\"font-semibold text-gray-700 dark:text-gray-300\">11 Languages</div>\n                <div className=\"text-xs\">Global support</div>\n              </div>\n            </div>\n          </motion.div>\n        </div>\n      </section>\n\n      {/* Pricing Preview */}\n      <section className=\"py-24\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8\">\n          <motion.div \n            className=\"text-center mb-16\"\n            initial={{ opacity: 0, y: 30 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.6 }}\n          >\n            <Badge className=\"mb-4 px-4 py-1.5 bg-blue-50 dark:bg-blue-950/50 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800\">\n              Pricing\n            </Badge>\n            <h2 className=\"text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4\">\n              {t('landing.pricing.title')}\n            </h2>\n            <p className=\"text-lg text-gray-600 dark:text-gray-400\">\n              {t('landing.pricing.subtitle')}\n            </p>\n          </motion.div>\n          \n          <motion.div \n            className=\"grid md:grid-cols-3 gap-6 max-w-5xl mx-auto\"\n            initial=\"initial\"\n            whileInView=\"animate\"\n            viewport={{ once: true }}\n            variants={staggerContainer}\n          >\n            {/* Free Plan */}\n            <motion.div variants={fadeInUp}>\n              <Card className=\"relative p-6 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-gray-200/50 dark:border-gray-700/50 hover:border-gray-300 dark:hover:border-gray-600 transition-all hover:shadow-lg h-full\">\n                <div className=\"mb-6\">\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">{t('landing.pricing.free.name')}</h3>\n                  <div className=\"flex items-baseline gap-1\">\n                    <span className=\"text-4xl font-bold text-gray-900 dark:text-white\">{formatAmount(convertFromUSD(0))}</span>\n                    <span className=\"text-gray-500\">{t('landing.pricing.perMonth')}</span>\n                  </div>\n                </div>\n                <ul className=\"space-y-3 mb-6\">\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.free.aiQueries')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.free.expenseTracking')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.free.goalManagement')}\n                  </li>\n                </ul>\n                <Button \n                  onClick={() => setLocation(\"/login\")}\n                  variant=\"outline\" \n                  className=\"w-full h-12 border-2 hover:bg-gray-50 dark:hover:bg-gray-800\"\n                  data-testid=\"pricing-free-button\"\n                >\n                  {t('landing.pricing.free.button')}\n                </Button>\n              </Card>\n            </motion.div>\n            \n            {/* Pro Plan - Featured */}\n            <motion.div variants={fadeInUp}>\n              <Card className=\"relative p-6 bg-gradient-to-b from-blue-600 to-blue-700 border-0 shadow-2xl shadow-blue-500/30 h-full overflow-hidden\">\n                <div className=\"absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=%2260%22 height=%2260%22 viewBox=%220 0 60 60%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23ffffff%22 fill-opacity=%220.05%22%3E%3Cpath d=%22M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')]\" />\n                <Badge className=\"absolute top-4 right-4 bg-white/20 text-white border-white/30 backdrop-blur-sm\">\n                  {t('landing.pricing.pro.badge')}\n                </Badge>\n                <div className=\"relative mb-6\">\n                  <h3 className=\"text-lg font-semibold text-white mb-2\">{t('landing.pricing.pro.name')}</h3>\n                  <div className=\"flex items-baseline gap-1\">\n                    <span className=\"text-4xl font-bold text-white\">{formatAmount(convertFromUSD(9.99))}</span>\n                    <span className=\"text-blue-200\">{t('landing.pricing.perMonth')}</span>\n                  </div>\n                </div>\n                <ul className=\"relative space-y-3 mb-6\">\n                  <li className=\"flex items-center gap-3 text-sm text-white/90\">\n                    <div className=\"w-5 h-5 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-white\" />\n                    </div>\n                    {t('landing.pricing.pro.scoutQueries')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-white/90\">\n                    <div className=\"w-5 h-5 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-white\" />\n                    </div>\n                    {t('landing.pricing.pro.sonnetQueries')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-white/90\">\n                    <div className=\"w-5 h-5 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-white\" />\n                    </div>\n                    {t('landing.pricing.pro.gptQueries')}\n                  </li>\n                </ul>\n                <Button \n                  onClick={() => setLocation(\"/login\")}\n                  className=\"relative w-full h-12 bg-white text-blue-600 hover:bg-blue-50 font-semibold\"\n                  data-testid=\"pricing-pro-button\"\n                >\n                  {t('landing.pricing.pro.button')}\n                </Button>\n              </Card>\n            </motion.div>\n            \n            {/* Enterprise Plan */}\n            <motion.div variants={fadeInUp}>\n              <Card className=\"relative p-6 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-gray-200/50 dark:border-gray-700/50 hover:border-gray-300 dark:hover:border-gray-600 transition-all hover:shadow-lg h-full\">\n                <div className=\"mb-6\">\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">{t('landing.pricing.enterprise.name')}</h3>\n                  <div className=\"flex items-baseline gap-1\">\n                    <span className=\"text-4xl font-bold text-gray-900 dark:text-white\">{formatAmount(convertFromUSD(49.99))}</span>\n                    <span className=\"text-gray-500\">{t('landing.pricing.perMonth')}</span>\n                  </div>\n                </div>\n                <ul className=\"space-y-3 mb-6\">\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.enterprise.everythingInPro')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.enterprise.opusQueries')}\n                  </li>\n                  <li className=\"flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400\">\n                    <div className=\"w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-3 h-3 text-green-600\" />\n                    </div>\n                    {t('landing.pricing.enterprise.prioritySupport')}\n                  </li>\n                </ul>\n                <Button \n                  onClick={() => setLocation(\"/login\")}\n                  variant=\"outline\" \n                  className=\"w-full h-12 border-2 hover:bg-gray-50 dark:hover:bg-gray-800\"\n                  data-testid=\"pricing-enterprise-button\"\n                >\n                  {t('landing.pricing.enterprise.button')}\n                </Button>\n              </Card>\n            </motion.div>\n          </motion.div>\n        </div>\n      </section>\n\n      {/* CTA Section */}\n      <section className=\"relative py-24 overflow-hidden\">\n        <div className=\"absolute inset-0 bg-gradient-to-r from-blue-600 via-blue-700 to-purple-700\" />\n        <div className=\"absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=%2260%22 height=%2260%22 viewBox=%220 0 60 60%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23ffffff%22 fill-opacity=%220.05%22%3E%3Cpath d=%22M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')]\" />\n        <div className=\"absolute top-0 left-1/4 w-96 h-96 bg-white/10 rounded-full blur-3xl\" />\n        <div className=\"absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl\" />\n        \n        <motion.div \n          className=\"relative max-w-4xl mx-auto px-6 lg:px-8 text-center\"\n          initial={{ opacity: 0, y: 30 }}\n          whileInView={{ opacity: 1, y: 0 }}\n          viewport={{ once: true }}\n          transition={{ duration: 0.6 }}\n        >\n          <h2 className=\"text-4xl sm:text-5xl font-bold text-white mb-6\">\n            {t('landing.cta.title')}\n          </h2>\n          <p className=\"text-xl text-blue-100 mb-10 max-w-2xl mx-auto\">\n            {t('landing.cta.subtitle')}\n          </p>\n          <Button \n            onClick={() => setLocation(\"/login\")} \n            size=\"lg\"\n            className=\"h-14 px-10 text-lg font-semibold bg-white text-blue-600 hover:bg-blue-50 rounded-xl shadow-2xl group\"\n            data-testid=\"cta-get-started-button\"\n          >\n            {t('landing.cta.button')}\n            <ArrowRight className=\"w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform\" />\n          </Button>\n        </motion.div>\n      </section>\n\n      {/* Footer */}\n      <footer className=\"border-t border-gray-100 dark:border-gray-900 bg-white dark:bg-black\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8 py-12\">\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-8 mb-12\">\n            <div>\n              <h4 className=\"text-sm font-semibold text-gray-900 dark:text-white mb-4\">{t('landing.footer.product')}</h4>\n              <ul className=\"space-y-3\">\n                <li><Link href=\"/\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.dashboard')}</Link></li>\n                <li><Link href=\"/subscription\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.pricing')}</Link></li>\n                <li><Link href=\"/ai-assistant\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.aiAdvisor')}</Link></li>\n              </ul>\n            </div>\n            <div>\n              <h4 className=\"text-sm font-semibold text-gray-900 dark:text-white mb-4\">{t('landing.footer.features')}</h4>\n              <ul className=\"space-y-3\">\n                <li><Link href=\"/financial-goals\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.goals')}</Link></li>\n                <li><Link href=\"/money-tracking\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.moneyTracking')}</Link></li>\n                <li><Link href=\"/playbooks\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.aiPlaybooks')}</Link></li>\n              </ul>\n            </div>\n            <div>\n              <h4 className=\"text-sm font-semibold text-gray-900 dark:text-white mb-4\">{t('landing.footer.resources')}</h4>\n              <ul className=\"space-y-3\">\n                <li><Link href=\"/investments\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.investments')}</Link></li>\n                <li><Link href=\"/calendar\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.calendar')}</Link></li>\n                <li><Link href=\"/settings\" className=\"text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors\">{t('landing.footer.settings')}</Link></li>\n              </ul>\n            </div>\n            <div>\n              <h4 className=\"text-sm font-semibold text-gray-900 dark:text-white mb-4\">{t('landing.footer.legal')}</h4>\n              <ul className=\"space-y-3\">\n                <li><span className=\"text-sm text-gray-500 cursor-default\">{t('landing.footer.privacyPolicy')}</span></li>\n                <li><span className=\"text-sm text-gray-500 cursor-default\">{t('landing.footer.termsOfService')}</span></li>\n                <li><span className=\"text-sm text-gray-500 cursor-default\">{t('landing.footer.cookiePolicy')}</span></li>\n              </ul>\n            </div>\n          </div>\n          <div className=\"pt-8 border-t border-gray-100 dark:border-gray-900 flex flex-col sm:flex-row justify-between items-center gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <img src={logoUrl} alt=\"Twealth\" className=\"w-6 h-6\" />\n              <span className=\"text-sm text-gray-600 dark:text-gray-400\">{t('landing.footer.copyright')}</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-xs text-gray-500 bg-gray-50 dark:bg-gray-900 px-3 py-1.5 rounded-full\">\n              <Shield className=\"w-3.5 h-3.5\" />\n              <span>{t('landing.footer.socCertified')}</span>\n            </div>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":40376,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\", \"Inter\", \"sans-serif\"],\n        serif: [\"var(--font-serif)\", \"Georgia\", \"serif\"],\n        mono: [\"var(--font-mono)\", \"Menlo\", \"monospace\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2820,"size_tokens":null},"client/src/components/dashboard/quick-stats.tsx":{"content":"import { memo } from 'react';\nimport { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent } from\"@/components/ui/card\";\nimport { PiggyBank, TrendingUp, DollarSign, Wallet, ArrowUpCircle, ArrowDownCircle, TrendingDown, Minus } from\"lucide-react\";\nimport { UserPreferences } from\"@shared/schema\";\nimport { SkeletonStat } from\"@/components/ui/skeleton\";\nimport Sparkline from\"@/components/ui/sparkline\";\nimport { useLocation } from\"wouter\";\n\nfunction QuickStats() {\n const [, setLocation] = useLocation();\n \n const { data: stats, isLoading: statsLoading } = useQuery({\n  queryKey: [\"/api/dashboard/stats\"],\n });\n\n const { data: financialHealth, isLoading: healthLoading } = useQuery({\n  queryKey: [\"/api/financial-health\"],\n });\n \n const { data: transactions } = useQuery({\n  queryKey: [\"/api/transactions\"],\n });\n\n if (statsLoading || healthLoading) {\n  return (\n   <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6\">\n    {[...Array(4)].map((_, i) => (\n     <SkeletonStat key={i} />\n    ))}\n   </div>\n  );\n }\n\n // Real financial data - use same calculation as Financial Health Service\n const totalSavings = (stats as any)?.totalSavings || 0;\n const monthlyIncome = (stats as any)?.monthlyIncome || 0;\n \n // Calculate actual monthly expenses from last 30 days of transactions (same as financialHealthService.ts)\n const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n const transactionList = Array.isArray(transactions) ? transactions : [];\n const recentExpenses = transactionList\n  .filter((t: any) => t.type === 'expense' && new Date(t.date) >= thirtyDaysAgo)\n  .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n \n const monthlyExpenses = recentExpenses;\n const monthlySavingsCapacity = monthlyIncome - monthlyExpenses;\n const savingsRate = monthlyIncome > 0 ? ((monthlySavingsCapacity / monthlyIncome) * 100) : 0;\n \n // Generate 7-day sparkline data for each metric\n const generateSparklineData = (type: 'savings' | 'income' | 'expenses' | 'capacity') => {\n  const data: number[] = [];\n  const now = new Date();\n  \n  // For savings, calculate cumulative net worth at end of each day\n  if (type === 'savings') {\n    for (let i = 6; i >= 0; i--) {\n      const dayEnd = new Date(now);\n      dayEnd.setDate(dayEnd.getDate() - i);\n      dayEnd.setHours(23, 59, 59, 999);\n      \n      // Calculate net worth as of that day (all transactions up to that point)\n      const transactionsUpToDay = transactionList.filter((t: any) => {\n        const tDate = new Date(t.date);\n        return tDate <= dayEnd;\n      });\n      \n      const netWorth = transactionsUpToDay.reduce((sum: number, t: any) => {\n        const amount = parseFloat(t.amount);\n        return sum + (t.type === 'income' ? amount : -amount);\n      }, 0);\n      \n      data.push(netWorth); // Allow negative values to show true financial state\n    }\n  } else {\n    // For income, expenses, capacity - daily values\n    for (let i = 6; i >= 0; i--) {\n      const dayStart = new Date(now);\n      dayStart.setDate(dayStart.getDate() - i);\n      dayStart.setHours(0, 0, 0, 0);\n      \n      const dayEnd = new Date(dayStart);\n      dayEnd.setHours(23, 59, 59, 999);\n      \n      const dayTransactions = transactionList.filter((t: any) => {\n        const tDate = new Date(t.date);\n        return tDate >= dayStart && tDate <= dayEnd;\n      });\n      \n      if (type === 'income') {\n        const dayIncome = dayTransactions\n          .filter((t: any) => t.type === 'income')\n          .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n        data.push(dayIncome);\n      } else if (type === 'expenses') {\n        const dayExpenses = dayTransactions\n          .filter((t: any) => t.type === 'expense')\n          .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n        data.push(dayExpenses);\n      } else if (type === 'capacity') {\n        const dayIncome = dayTransactions\n          .filter((t: any) => t.type === 'income')\n          .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n        const dayExpenses = dayTransactions\n          .filter((t: any) => t.type === 'expense')\n          .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n        data.push(dayIncome - dayExpenses);\n      }\n    }\n  }\n  \n  return data.length > 0 ? data : [0, 0, 0, 0, 0, 0, 0];\n };\n \n // Calculate 7-day trends with proper handling of all scenarios\n const calculateTrend = (sparklineData: number[]) => {\n  if (sparklineData.length < 2) return { direction: 'neutral' as const, percent: 0 };\n  \n  const recent = sparklineData.slice(-3).reduce((a, b) => a + b, 0) / 3;\n  const older = sparklineData.slice(0, 3).reduce((a, b) => a + b, 0) / 3;\n  const absoluteChange = recent - older;\n  const epsilon = 0.01;\n  \n  // Handle near-zero baseline (both positive and negative)\n  if (Math.abs(older) < epsilon) {\n    if (Math.abs(recent) < epsilon) {\n      // Both near zero = neutral\n      return { direction: 'neutral' as const, percent: 0 };\n    } else if (recent > epsilon) {\n      // Starting from zero, now positive = upward trend\n      const magnitude = Math.min(Math.abs(recent), 1000);\n      return { direction: 'up' as const, percent: magnitude };\n    } else if (recent < -epsilon) {\n      // Starting from zero, now negative = downward trend\n      const magnitude = Math.min(Math.abs(recent), 1000);\n      return { direction: 'down' as const, percent: magnitude };\n    }\n  }\n  \n  // Normal case: calculate percentage change based on absolute value of baseline\n  const percentChange = (absoluteChange / Math.abs(older)) * 100;\n  \n  // Direction is based on whether we're getting better or worse\n  // For negative values: -2000 → -500 is UP (recovery)\n  // For positive values: 1000 → 2000 is UP (growth)\n  const direction = absoluteChange > 1 ? 'up' as const : \n                    absoluteChange < -1 ? 'down' as const : \n                    'neutral' as const;\n  \n  return {\n    direction,\n    percent: Math.min(Math.abs(percentChange), 999) // Cap at 999% for display\n  };\n };\n \n // Generate sparkline and trend data for each metric\n const savingsSparkline = generateSparklineData('savings');\n const incomeSparkline = generateSparklineData('income');\n const expensesSparkline = generateSparklineData('expenses');\n const capacitySparkline = generateSparklineData('capacity');\n \n const savingsTrend = calculateTrend(savingsSparkline);\n const incomeTrend = calculateTrend(incomeSparkline);\n const expensesTrend = calculateTrend(expensesSparkline);\n const capacityTrend = calculateTrend(capacitySparkline);\n \n const statCards = [\n  {\n   title:\"Total Savings\",\n   value: `$${totalSavings.toLocaleString()}`,\n   subtext:\"Current net worth\",\n   insight: savingsTrend.direction === 'up' ? \"Net worth growing steadily!\" : savingsTrend.direction === 'down' ? \"Review recent expenses.\" : \"Track your progress daily.\",\n   icon: PiggyBank,\n   iconBg:\"bg-green-100 dark:bg-green-900/20\",\n   iconColor:\"text-green-600 dark:text-green-300\",\n   valueColor:\"text-green-600 dark:text-green-400\",\n   sparklineData: savingsSparkline,\n   sparklineColor: savingsTrend.direction === 'down' ? 'red' as const : 'green' as const,\n   trend: savingsTrend,\n   badge: totalSavings >= 10000 ?\"Excellent\" : totalSavings >= 5000 ?\"Good\" : totalSavings >= 1000 ?\"Building\" :\"Start Now\",\n   onClick: () => setLocation('/money')\n  },\n  {\n   title:\"Monthly Income\",\n   value: `$${monthlyIncome.toLocaleString()}`,\n   subtext:\"Earnings per month\",\n   insight: incomeTrend.direction === 'up' ? \"Income trending upward\" : incomeTrend.direction === 'down' ? \"Income decreased recently\" : \"Income stable this week\",\n   icon: ArrowUpCircle,\n   iconBg:\"bg-blue-100 dark:bg-blue-900/20\",\n   iconColor:\"text-blue-600 dark:text-blue-300\",\n   valueColor:\"text-blue-600 dark:text-blue-400\",\n   sparklineData: incomeSparkline,\n   sparklineColor: 'blue' as const,\n   trend: incomeTrend,\n   badge: monthlyIncome > 0 ?\"Active\" :\"Set Income\",\n   onClick: () => setLocation('/money?filter=income')\n  },\n  {\n   title:\"Monthly Expenses\",\n   value: `$${monthlyExpenses.toLocaleString()}`,\n   subtext:\"Spending per month\",\n   insight: expensesTrend.direction === 'down' ? \"Spending decreased - nice work!\" : expensesTrend.direction === 'up' ? \"Spending increased recently\" : \"Spending stable this week\",\n   icon: ArrowDownCircle,\n   iconBg:\"bg-orange-100 dark:bg-orange-900/20\",\n   iconColor:\"text-orange-600 dark:text-orange-300\",\n   valueColor:\"text-orange-600 dark:text-orange-400\",\n   sparklineData: expensesSparkline,\n   sparklineColor: expensesTrend.direction === 'down' ? 'green' as const : 'red' as const,\n   trend: expensesTrend,\n   badge: monthlyExpenses > 0 ? (monthlyExpenses < monthlyIncome ?\"Healthy\" :\"Review\") :\"Track Expenses\",\n   onClick: () => setLocation('/money?filter=expense')\n  },\n  {\n   title:\"Savings Capacity\",\n   value: `$${monthlySavingsCapacity.toLocaleString()}`,\n   subtext: `${savingsRate.toFixed(1)}% savings rate`,\n   insight: savingsRate >= 20 ? \"Excellent! Consider investing.\" : savingsRate >= 10 ? \"Good progress. Aim higher!\" : monthlySavingsCapacity > 0 ? \"Build your savings buffer.\" : \"Review expenses to improve.\",\n   icon: Wallet,\n   iconBg: monthlySavingsCapacity > 0 ?\"bg-blue-100 dark:bg-blue-900/20\" :\"bg-red-100 dark:bg-red-900/20\",\n   iconColor: monthlySavingsCapacity > 0 ?\"text-blue-600 dark:text-blue-300\" :\"text-red-600 dark:text-red-300\",\n   valueColor: monthlySavingsCapacity > 0 ?\"text-blue-600 dark:text-blue-400\" :\"text-red-600 dark:text-red-400\",\n   sparklineData: capacitySparkline,\n   sparklineColor: monthlySavingsCapacity > 0 ? 'blue' as const : 'red' as const,\n   trend: capacityTrend,\n   badge: monthlySavingsCapacity > 0 ? (savingsRate >= 20 ?\"Excellent\" : savingsRate >= 10 ?\"Good\" :\"Fair\") :\"Deficit\",\n   onClick: () => setLocation('/budgets')\n  }\n ];\n\n return (\n  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6\">\n   {statCards.map((stat, index) => (\n    <Card \n     key={index} \n     className=\"card-interactive cursor-pointer touch-target bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 md:p-6\" \n     onClick={stat.onClick}\n     data-testid={`card-${stat.title.toLowerCase().replace(/\\s+/g, '-')}`}\n     role=\"button\"\n     tabIndex={0}\n     onKeyDown={(e) => {\n       if (e.key === 'Enter' || e.key === ' ') {\n         e.preventDefault();\n         stat.onClick();\n       }\n     }}\n    >\n     <CardContent className=\"p-0 space-y-4\">\n      {/* Header with icon and badge */}\n      <div className=\"flex items-start justify-between gap-3\">\n       <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center gap-2 mb-1\">\n         <p \n          className=\"text-sm text-gray-600 dark:text-gray-400 font-medium\" \n          data-testid={`text-${stat.title.toLowerCase().replace(/\\s+/g, '-')}`}\n         >\n          {stat.title}\n         </p>\n         {stat.badge && (\n          <span className=\"text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium border border-gray-200 dark:border-gray-600\">\n           {stat.badge}\n          </span>\n         )}\n        </div>\n        \n        {/* Trend indicator */}\n        {stat.trend && stat.trend.percent > 0 && (\n         <div className={`flex items-center gap-1 text-xs ${\n           stat.trend.direction === 'up' ? 'text-green-600 dark:text-green-400' : \n           stat.trend.direction === 'down' ? 'text-red-600 dark:text-red-400' : \n           'text-gray-600 dark:text-gray-400'\n         }`}>\n          {stat.trend.direction === 'up' && <TrendingUp size={12} />}\n          {stat.trend.direction === 'down' && <TrendingDown size={12} />}\n          {stat.trend.direction === 'neutral' && <Minus size={12} />}\n          <span className=\"font-medium\">{stat.trend.percent.toFixed(1)}% (7d)</span>\n         </div>\n        )}\n       </div>\n       <div className={`w-11 h-11 rounded-xl ${stat.iconBg} flex items-center justify-center flex-shrink-0`}>\n        <stat.icon className={stat.iconColor} size={18} />\n       </div>\n      </div>\n      \n      {/* Value */}\n      <div>\n       <p \n        className={`headline-card ${stat.valueColor} mb-1`}\n        data-testid={`value-${stat.title.toLowerCase().replace(/\\s+/g, '-')}`}\n       >\n        {stat.value}\n       </p>\n       <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n        {stat.subtext}\n       </p>\n      </div>\n      \n      {/* Sparkline */}\n      {stat.sparklineData && stat.sparklineData.length > 0 && (\n       <div className=\"pt-2 border-t border-gray-200 dark:border-gray-700\">\n        <Sparkline \n         data={stat.sparklineData} \n         color={stat.sparklineColor} \n         className=\"h-8 w-full\"\n        />\n       </div>\n      )}\n      \n      {/* Contextual insight */}\n      {stat.insight && (\n       <p className=\"text-xs text-gray-600 dark:text-gray-400 italic pt-1\">\n        {stat.insight}\n       </p>\n      )}\n     </CardContent>\n    </Card>\n   ))}\n  </div>\n );\n}\n\n// Export with React.memo for mobile performance optimization\nexport default memo(QuickStats);\n","path":null,"size_bytes":13091,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from\"react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n HTMLTextAreaElement,\n React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n return (\n  <textarea\n   className={cn(\n   \"flex min-h-[120px] w-full rounded-lg border border-input bg-background px-3 py-3 text-base ring-offset-background transition-all duration-150 placeholder:text-muted-foreground focus-visible:outline-none focus-visible:border-primary focus-visible:ring-2 focus-visible:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm resize-y\",\n    className\n   )}\n   ref={ref}\n   {...props}\n  />\n )\n})\nTextarea.displayName =\"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":702,"size_tokens":null},"server/aiService.ts":{"content":"import Groq from \"groq-sdk\";\nimport crypto from 'crypto';\nimport { LUXURY_VEHICLES, findVehicle, calculateTotalOwnershipCost } from './luxuryAssets';\nimport { marketDataService } from './marketDataService';\nimport { taxService } from './taxService';\nimport { spendingPatternService } from './spendingPatternService';\nimport { systemPromptCache } from './services/systemPromptCache';\nimport { detectLanguage, calculateInvestmentPlans, calculateRealisticTimeline } from './financialCalculations';\n\n// Using Groq with Llama 4 Scout (17B MoE) for fast, powerful CFO-level AI with native tool-use\nconst groq = new Groq({ \n  apiKey: process.env.GROQ_API_KEY || \"\" \n});\n\n// Cost optimization: In-memory cache for AI responses\ninterface CacheEntry {\n  response: string;\n  timestamp: number;\n  tokenCount: number;\n}\n\nclass ResponseCache {\n  private cache = new Map<string, CacheEntry>();\n  private readonly CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours\n  private readonly MAX_CACHE_SIZE = 1000;\n  private hits = 0;\n  private misses = 0;\n\n  private generateCacheKey(message: string, context: Partial<UserContext>): string {\n    // Create a stable hash for similar queries and contexts\n    // CRITICAL: Include userId AND subscription tier to prevent cross-user/tier data leakage\n    const normalizedMessage = message.toLowerCase().trim();\n    const contextKey = JSON.stringify({\n      userId: context.userId || 'anonymous', // User isolation - required for privacy\n      tier: context.subscriptionTier || 'free', // Tier isolation - different advice per tier\n      savingsRange: this.getSavingsRange(context.totalSavings || 0),\n      incomeRange: this.getIncomeRange(context.monthlyIncome || 0),\n      activeGoals: context.activeGoals || 0\n    });\n    return crypto.createHash('md5').update(normalizedMessage + contextKey).digest('hex');\n  }\n\n  private getSavingsRange(amount: number): string {\n    if (amount < 1000) return 'low';\n    if (amount < 10000) return 'medium';\n    if (amount < 50000) return 'high';\n    return 'very-high';\n  }\n\n  private getIncomeRange(amount: number): string {\n    if (amount < 30000) return 'low';\n    if (amount < 80000) return 'medium';\n    if (amount < 150000) return 'high';\n    return 'very-high';\n  }\n\n  get(message: string, context: Partial<UserContext>): string | null {\n    const key = this.generateCacheKey(message, context);\n    const entry = this.cache.get(key);\n    \n    if (!entry) {\n      this.misses++;\n      return null;\n    }\n    \n    // Check if expired\n    if (Date.now() - entry.timestamp > this.CACHE_TTL) {\n      this.cache.delete(key);\n      this.misses++;\n      return null;\n    }\n    \n    this.hits++;\n    return entry.response;\n  }\n\n  set(message: string, context: Partial<UserContext>, response: string, tokenCount: number): void {\n    const key = this.generateCacheKey(message, context);\n    \n    // Cleanup old entries if cache is full\n    if (this.cache.size >= this.MAX_CACHE_SIZE) {\n      const oldestKey = this.cache.keys().next().value;\n      if (oldestKey) this.cache.delete(oldestKey);\n    }\n    \n    this.cache.set(key, {\n      response,\n      timestamp: Date.now(),\n      tokenCount\n    });\n  }\n\n  getStats(): { size: number; hitRate: number; hits: number; misses: number; totalRequests: number } {\n    const totalRequests = this.hits + this.misses;\n    const hitRate = totalRequests > 0 ? this.hits / totalRequests : 0;\n    \n    return {\n      size: this.cache.size,\n      hitRate,\n      hits: this.hits,\n      misses: this.misses,\n      totalRequests\n    };\n  }\n}\n\nconst responseCache = new ResponseCache();\n\nexport interface UserContext {\n  userId?: string;\n  userName?: string; // User's first name for personalization\n  subscriptionTier?: 'free' | 'pro' | 'enterprise'; // User's subscription tier for cache isolation\n  totalSavings: number;\n  monthlyIncome: number;\n  monthlyExpenses: number;\n  activeGoals: number;\n  language?: string; // User's preferred language (en, es, id, th, pt, hi, vi, tl, ms, tr, ar)\n  cryptoEnabled?: boolean; // Whether user has enabled crypto features\n  experienceLevel?: 'beginner' | 'intermediate' | 'advanced'; // User's financial experience level\n  conversationMemory?: {\n    financialPriorities?: string[];\n    investmentPreferences?: string[];\n    lifeEvents?: { event: string; timeframe?: string }[];\n    spendingHabits?: string[];\n    riskTolerance?: string;\n    lastUpdated?: string;\n  }; // User's conversation history and preferences\n  impossibleGoalWarning?: string; // Backend pre-validation flag when goal is mathematically impossible\n  recentTransactions: Array<{\n    amount: number;\n    category: string;\n    description: string;\n    date: string;\n  }>;\n  upcomingEvents: Array<{\n    title: string;\n    date: string;\n    estimatedValue: number;\n  }>;\n  financialProfile?: {\n    monthlyIncome: number;\n    monthlyExpenses: number;\n    monthlySavings: number;\n    totalSavings: number;\n    savingsGoal: number;\n    emergencyFund: number;\n  };\n  expenseCategories?: Array<{\n    category: string;\n    monthlyBudget: number;\n  }>;\n  debts?: Array<{\n    name: string;\n    balance: number; // Current amount owed (same as remainingAmount)\n    originalAmount?: number; // Original total debt amount\n    remainingAmount: number; // Current balance (alias for clarity)\n    totalAmount: number; // Original or current balance for backward compatibility\n    monthlyPayment: number;\n    interestRate: number; // APR as percentage\n    minimumPayment?: number;\n  }>;\n  assets?: Array<{\n    name: string;\n    type: string;\n    value: number; // Current value\n    currentValue: number; // Alias for clarity\n    purchasePrice?: number; // Original purchase price\n  }>;\n}\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant';\n  content: string;\n  timestamp: Date;\n}\n\nexport interface ToolCall {\n  name: string;\n  arguments: any;\n}\n\n// Define available tools for the AI agent\nconst TOOLS = [\n  {\n    type: \"function\",\n    function: {\n      name: \"create_financial_goal\",\n      description: \"Create a financial goal when user gives a direct command or confirms. TWO SCENARIOS: (A) Complete command with amount ('Create a goal to save $5000') → IMMEDIATELY call this tool with all extracted details. (B) Incomplete command without amount ('Make a savings goal') → ASK for missing details first: 'I can set that up! What's your target amount and timeline?'. NEVER call this tool without targetAmount. Extract: name (purpose), targetAmount (required: $5000 or 5000), targetDate (calculate from timeline or ask), description. Set userConfirmed=true for all imperative commands.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"REQUIRED: Set to true. TRUE when: (1) User explicitly confirms with 'yes', 'add it', 'sure', OR (2) User gives IMPERATIVE COMMAND like 'Create a goal to...', 'Add a goal for...', 'Make a goal for...'. Imperative commands ARE confirmations! Only false if user just casually mentions wanting something without commanding or confirming.\"\n          },\n          name: {\n            type: \"string\",\n            description: \"The name of the goal (e.g., 'Buy Lamborghini')\"\n          },\n          targetAmount: {\n            type: \"string\",\n            description: \"The target amount in dollars (e.g., '5000', '$10000', '2500.00'). Can include dollar signs and decimals.\"\n          },\n          targetDate: {\n            type: \"string\",\n            description: \"The target date in YYYY-MM-DD format\"\n          },\n          description: {\n            type: \"string\",\n            description: \"A brief description of the goal and plan to achieve it\"\n          }\n        },\n        required: [\"userConfirmed\", \"name\", \"targetAmount\", \"targetDate\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_calendar_event\",\n      description: \"Create a calendar event when user gives direct command or confirms. IMMEDIATE EXECUTION: When user says 'Create a reminder for...', 'Add calendar event for...', 'Set a reminder to...', call this tool IMMEDIATELY. NO confirmation needed for imperative commands - they ARE the confirmation! Extract title, date (YYYY-MM-DD), description. Calculate dates: 'next week' = 7 days from now, 'next month' = 30 days from now, 'tomorrow' = 1 day from now.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"REQUIRED: Set to true. TRUE when: (1) User explicitly confirms with 'yes', 'set it', 'sure', OR (2) User gives IMPERATIVE COMMAND like 'Create a reminder for...', 'Add event for...', 'Set reminder to...'. Imperative commands ARE confirmations! Only false if user casually mentions a date without commanding or confirming.\"\n          },\n          title: {\n            type: \"string\",\n            description: \"The event title (e.g., 'Review Portfolio', 'Pay Rent', 'Check Budget')\"\n          },\n          date: {\n            type: \"string\",\n            description: \"The event date in YYYY-MM-DD format. Calculate from today's date if relative (next week, tomorrow, etc.)\"\n          },\n          description: {\n            type: \"string\",\n            description: \"Event description or notes with financial context\"\n          }\n        },\n        required: [\"userConfirmed\", \"title\", \"date\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"add_transaction\",\n      description: \"Record a transaction when user explicitly states they spent/received money with specific amount. CRITICAL: Call this tool AND simultaneously provide detailed financial insights in natural language (impact on budget, monthly spend comparison, savings rate effect, actionable advice). NEVER just call the tool silently - ALWAYS explain the transaction's financial impact with specific numbers. Use when user says 'I spent $X on Y' or 'I earned $X from Y'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          type: {\n            type: \"string\",\n            enum: [\"income\", \"expense\"],\n            description: \"Type of transaction\"\n          },\n          amount: {\n            type: \"string\",\n            description: \"Transaction amount in dollars (e.g., '300', '45.50', '$100'). Can include dollar signs and decimals.\"\n          },\n          category: {\n            type: \"string\",\n            description: \"Transaction category (e.g., 'groceries', 'salary', 'entertainment')\"\n          },\n          description: {\n            type: \"string\",\n            description: \"Transaction description\"\n          },\n          date: {\n            type: \"string\",\n            description: \"Transaction date in YYYY-MM-DD format (defaults to today if not specified)\"\n          }\n        },\n        required: [\"type\", \"amount\", \"category\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_group\",\n      description: \"Create a group ONLY after user explicitly confirms. CRITICAL: userConfirmed parameter MUST be true. WORKFLOW: (1) User mentions group/collaboration → (2) You explain benefits WITHOUT calling this tool → (3) You ask 'Want me to create this group for you?' → (4) User confirms → (5) THEN call with userConfirmed=true.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"REQUIRED: Must be true. Can ONLY be true when user explicitly confirmed with words like 'yes', 'create it', 'make it', 'sure'. If user just mentioned a group idea without confirming, DON'T call this tool.\"\n          },\n          name: {\n            type: \"string\",\n            description: \"The group name (e.g., 'Family Budget', 'Roommates Expenses')\"\n          },\n          description: {\n            type: \"string\",\n            description: \"What this group is for\"\n          }\n        },\n        required: [\"userConfirmed\", \"name\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"add_crypto_holding\",\n      description: \"Track crypto holding ONLY when user explicitly states a PAST purchase with specific amounts. CRITICAL: Use ONLY for completed transactions like 'I bought 0.5 BTC at $50000' or 'I own 2 ETH purchased at $3000'. DO NOT use for: questions about crypto, future plans, hypothetical scenarios, or educational discussions. For informational queries, just explain in text without calling this tool.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          symbol: {\n            type: \"string\",\n            description: \"Crypto symbol in uppercase (e.g., 'BTC', 'ETH', 'BNB')\"\n          },\n          amount: {\n            type: \"string\",\n            description: \"Amount of cryptocurrency owned (e.g., '0.5', '2', '1.25'). Accepts decimal values.\"\n          },\n          purchasePrice: {\n            type: \"string\",\n            description: \"Purchase price per unit in USD (e.g., '50000', '$3000', '1500.50'). Can include dollar signs.\"\n          }\n        },\n        required: [\"symbol\", \"amount\", \"purchasePrice\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_portfolio_allocation\",\n      description: \"Calculate portfolio allocation ONLY when user asks about investment strategy. CRITICAL: After calling this tool, you MUST explain the allocation breakdown with specific dollar amounts, fund recommendations (VTI/VOO/BND), and WHY this allocation works for their age/risk. NEVER just say 'Action completed' - always provide detailed investment advice explaining stocks/bonds/alternatives percentages.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          age: {\n            type: \"number\",\n            description: \"User's age for age-based allocation\"\n          },\n          riskTolerance: {\n            type: \"string\",\n            enum: [\"conservative\", \"moderate\", \"aggressive\"],\n            description: \"Risk tolerance level\"\n          },\n          investmentAmount: {\n            type: \"number\",\n            description: \"Amount to allocate\"\n          }\n        },\n        required: [\"age\", \"riskTolerance\", \"investmentAmount\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_debt_payoff\",\n      description: \"Calculate debt payoff strategies ONLY when user asks about paying off debts. CRITICAL: After calling this tool, you MUST explain BOTH avalanche (highest interest first) and snowball (smallest balance first) methods with total interest saved, payoff timeline, and clear recommendation. NEVER just say 'Action completed' - provide detailed comparison and advice.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          debts: {\n            type: \"array\",\n            description: \"Array of debts with balance and interest rate\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                balance: { type: \"number\" },\n                interestRate: { type: \"number\" },\n                minPayment: { type: \"number\" }\n              }\n            }\n          },\n          extraPayment: {\n            type: \"number\",\n            description: \"Extra monthly payment amount available\"\n          }\n        },\n        required: [\"debts\", \"extraPayment\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"project_future_value\",\n      description: \"Calculate future value with compound interest ONLY when user asks about long-term growth projections. CRITICAL: After calling this tool, you MUST explain the power of compounding with specific numbers - show future value (nominal), inflation-adjusted real value, total invested, and total growth percentage. Demonstrate why starting early matters. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          principal: {\n            type: \"number\",\n            description: \"Starting amount\"\n          },\n          monthlyContribution: {\n            type: \"number\",\n            description: \"Monthly contribution amount\"\n          },\n          annualReturn: {\n            type: \"number\",\n            description: \"Expected annual return percentage (e.g., 8 for 8%)\"\n          },\n          years: {\n            type: \"number\",\n            description: \"Number of years to project\"\n          },\n          inflationRate: {\n            type: \"number\",\n            description: \"Annual inflation rate percentage (e.g., 3 for 3%)\"\n          }\n        },\n        required: [\"principal\", \"monthlyContribution\", \"annualReturn\", \"years\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_retirement_needs\",\n      description: \"Calculate retirement needs ONLY when user asks about retirement planning. CRITICAL: After calling this tool, you MUST explain the 4% rule, target amount needed (annual expenses × 25), required monthly savings, years to retirement, and whether they're on track. Include pro tips like 401(k) matching, Roth IRA benefits, and Social Security optimization. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          currentAge: {\n            type: \"number\",\n            description: \"Current age\"\n          },\n          retirementAge: {\n            type: \"number\",\n            description: \"Desired retirement age\"\n          },\n          annualExpenses: {\n            type: \"number\",\n            description: \"Expected annual expenses in retirement\"\n          },\n          currentSavings: {\n            type: \"number\",\n            description: \"Current retirement savings\"\n          }\n        },\n        required: [\"currentAge\", \"retirementAge\", \"annualExpenses\", \"currentSavings\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"save_financial_estimates\",\n      description: \"Save user's financial estimates when they provide monthly income, monthly expenses, or current savings. Use this IMMEDIATELY when user mentions these numbers to populate their financial profile. Examples: 'I make $5000/month', 'I spend about $3000 monthly', 'I have $10000 saved'. This helps provide better personalized advice.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyIncome: {\n            type: [\"number\", \"string\"],\n            description: \"Estimated monthly income in dollars. Can be number or string like '$5000' or '5000'. Only include if user provided this information.\"\n          },\n          monthlyExpenses: {\n            type: [\"number\", \"string\"],\n            description: \"Estimated monthly expenses in dollars. Can be number or string like '$3000' or '3000'. Only include if user provided this information.\"\n          },\n          currentSavings: {\n            type: [\"number\", \"string\"],\n            description: \"Current total savings/net worth in dollars. Can be number or string like '$10000' or '10000'. Only include if user provided this information.\"\n          }\n        }\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_luxury_purchase\",\n      description: \"CALL IMMEDIATELY when user mentions luxury items: Lamborghini, Ferrari, Porsche, Tesla, McLaren, Bentley, Rolls Royce, mansion, yacht, private jet. Triggers: 'want to buy', 'wanna buy', 'afford', 'can I get', 'looking to purchase'. Provides: down payment (10%/20%/30%), financing (3/5/7yr), monthly cost, insurance, maintenance, depreciation, opportunity cost. MUST call this tool first, then explain results with user's income/savings context.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          itemName: {\n            type: \"string\",\n            description: \"Name of the luxury item (e.g., 'McLaren 765 LT', 'Beverly Hills Mansion', 'Yacht')\"\n          },\n          purchasePrice: {\n            type: \"number\",\n            description: \"Purchase price in dollars\"\n          },\n          itemType: {\n            type: \"string\",\n            enum: [\"vehicle\", \"real-estate\", \"luxury-item\"],\n            description: \"Type of luxury purchase\"\n          }\n        },\n        required: [\"itemName\", \"purchasePrice\", \"itemType\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_affordability\",\n      description: \"Call for major purchase affordability questions. Calculates: debt-to-income ratio, max affordable price (2.5x annual income), savings timeline, emergency fund impact. After calling, explain with user's income/savings data. Triggers: 'can I afford', 'should I buy', 'is it responsible'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          purchasePrice: {\n            type: \"number\",\n            description: \"Total purchase price in dollars\"\n          },\n          userMonthlyIncome: {\n            type: \"number\",\n            description: \"User's monthly income\"\n          },\n          userMonthlySavings: {\n            type: \"number\",\n            description: \"User's monthly savings amount\"\n          }\n        },\n        required: [\"purchasePrice\", \"userMonthlyIncome\", \"userMonthlySavings\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"compare_financing_options\",\n      description: \"Lease vs buy comparison for vehicles and major purchases. CRITICAL: After calling this tool, you MUST explain: 3-year lease costs with monthly payments, buy costs with financing (down payment + monthly payments), equity analysis (what you own vs owe), total cost comparison over 3/5 years, and pros/cons of each option. Provide clear recommendation based on user's financial situation. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          itemName: {\n            type: \"string\",\n            description: \"Name of the item (e.g., 'Tesla Model S', 'Porsche 911')\"\n          },\n          purchasePrice: {\n            type: \"number\",\n            description: \"Purchase price in dollars\"\n          },\n          itemType: {\n            type: \"string\",\n            enum: [\"vehicle\", \"real-estate\", \"luxury-item\"],\n            description: \"Type of purchase\"\n          }\n        },\n        required: [\"itemName\", \"purchasePrice\", \"itemType\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"generate_spending_insights\",\n      description: \"Call when user asks about spending patterns. Provides: top 3 categories with percentages/amounts, trends, budget warnings, actionable recommendations. After calling, explain with specific numbers. Triggers: 'analyze spending', 'where does my money go', 'spending review', 'budget analysis'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          transactionData: {\n            type: \"array\",\n            description: \"Array of recent transactions to analyze\",\n            items: {\n              type: \"object\",\n              properties: {\n                amount: { type: \"number\" },\n                category: { type: \"string\" },\n                description: { type: \"string\" },\n                date: { type: \"string\" }\n              }\n            }\n          },\n          timeframe: {\n            type: \"string\",\n            enum: [\"week\", \"month\", \"year\"],\n            description: \"Time period to analyze\"\n          }\n        },\n        required: [\"transactionData\", \"timeframe\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_goal_progress\",\n      description: \"Track detailed progress toward a financial goal ONLY when user asks about goal status, progress tracking, or 'am I on track?'. CRITICAL: After calling this tool, you MUST explain: exact progress percentage with visual representation (e.g., '42% complete - almost halfway!'), money still needed with breakdown, months remaining vs months needed at current pace, on-track status with specific verdict (ahead by X months/on track/behind by X months), adjustment recommendations with exact numbers ('Increase contribution by $347/month to stay on track'), milestone achievements (25%/50%/75%/100% markers with dates). NEVER just say 'Action completed' - provide motivational progress update.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          goalName: {\n            type: \"string\",\n            description: \"Name of the financial goal (e.g., 'McLaren 765 LT', 'House Down Payment')\"\n          },\n          targetAmount: {\n            type: \"number\",\n            description: \"Target amount for the goal in dollars\"\n          },\n          currentAmount: {\n            type: \"number\",\n            description: \"Current amount saved toward goal in dollars\"\n          },\n          targetDate: {\n            type: \"string\",\n            description: \"Target completion date in YYYY-MM-DD format\"\n          },\n          monthlyContribution: {\n            type: \"number\",\n            description: \"Current monthly contribution amount in dollars\"\n          }\n        },\n        required: [\"goalName\", \"targetAmount\", \"currentAmount\", \"targetDate\", \"monthlyContribution\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_net_worth_projection\",\n      description: \"Project future net worth with compound growth ONLY when user asks about wealth building, long-term projections, or 'where will I be in X years?'. CRITICAL: After calling this tool, you MUST explain: current net worth baseline, 1-year projection with monthly breakdown, 5-year projection showing compound effect, 10-year projection demonstrating long-term wealth building, detailed breakdown of savings vs investment growth portions, specific recommendations to accelerate growth (increase savings rate by X%, invest Y% in stocks, reduce expenses by $Z). Show the power of compounding with actual numbers. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          currentNetWorth: {\n            type: \"number\",\n            description: \"Current total net worth in dollars\"\n          },\n          monthlyIncome: {\n            type: \"number\",\n            description: \"Monthly income in dollars\"\n          },\n          monthlyExpenses: {\n            type: \"number\",\n            description: \"Monthly expenses in dollars\"\n          },\n          investmentReturn: {\n            type: \"number\",\n            description: \"Expected annual investment return percentage (default 8%)\",\n            default: 8\n          }\n        },\n        required: [\"currentNetWorth\", \"monthlyIncome\", \"monthlyExpenses\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"generate_budget_recommendations\",\n      description: \"Generate smart budget optimization recommendations ONLY when user asks about budgeting help, spending optimization, or 'how should I allocate my money?'. CRITICAL: After calling this tool, you MUST explain: recommended budget allocation using 50/30/20 rule (50% needs, 30% wants, 20% savings) or custom allocation based on their specific goals, category-by-category breakdown with current vs recommended amounts and exact dollar differences, identified savings opportunities with specific amounts ('Reduce dining from $600 to $400 = $200/month saved'), specific actionable steps with numbers ('Cut subscription services by $50, redirect to emergency fund. Cancel gym membership $80, use free park workouts'). Tie recommendations to their stated financial goals. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyIncome: {\n            type: \"number\",\n            description: \"Monthly income in dollars\"\n          },\n          currentSpending: {\n            type: \"object\",\n            description: \"Current spending breakdown by category with amounts\",\n            additionalProperties: {\n              type: \"number\"\n            }\n          },\n          financialGoals: {\n            type: \"array\",\n            description: \"Array of financial goals to optimize budget for\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                targetAmount: { type: \"number\" },\n                monthlyContribution: { type: \"number\" }\n              }\n            }\n          }\n        },\n        required: [\"monthlyIncome\", \"currentSpending\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"suggest_group_invites\",\n      description: \"Suggest which friends to invite to a financial group based on shared goals, interests, and financial collaboration potential. CRITICAL: After calling this tool, you MUST explain: why each friend is a good match (shared goals, similar financial timeline, complementary skills), specific collaboration opportunities ('Sarah has an investment goal too - you could share research and split index fund fees'), benefits of inviting each person with concrete examples, suggested roles ('Make David a contributor since he's experienced with budgeting'), specific invitation message suggestions. Provide personalized reasoning for each suggested friend. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          groupName: {\n            type: \"string\",\n            description: \"Name of the group to invite friends to\"\n          },\n          groupPurpose: {\n            type: \"string\",\n            description: \"Purpose of the group (e.g., 'Investment Club', 'Vacation Savings', 'Household Budget')\"\n          },\n          availableFriends: {\n            type: \"array\",\n            description: \"List of available friends with their financial interests\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                email: { type: \"string\" },\n                sharedGoals: {\n                  type: \"array\",\n                  items: { type: \"string\" },\n                  description: \"Financial goals they have in common with user\"\n                },\n                financialInterests: {\n                  type: \"array\",\n                  items: { type: \"string\" },\n                  description: \"Their financial interests or expertise areas\"\n                }\n              }\n            }\n          },\n          maxInvites: {\n            type: \"number\",\n            description: \"Maximum number of friends to suggest (default 5)\",\n            default: 5\n          }\n        },\n        required: [\"groupName\", \"groupPurpose\", \"availableFriends\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"suggest_savings_adjustment\",\n      description: \"Analyze current budget and suggest optimal savings adjustments to accelerate goal achievement. CRITICAL: After calling this tool, you MUST explain: current savings rate vs optimal savings rate with exact percentages, specific categories to reduce with dollar amounts ('Reduce dining $200/month: cook 3 more meals/week at $15/meal savings'), reallocation strategy with exact numbers ('Redirect $200 dining savings + $100 entertainment cut = $300/month extra toward goal'), timeline improvement ('Reach goal 8 months faster with adjustments'), priority-based recommendations (cut wants before needs, maintain emergency fund), painless savings hacks with specific examples ('Use $50 cash-only for entertainment to avoid overspending'). Calculate exact impact on goals. NEVER just say 'Action completed'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          currentMonthlyIncome: {\n            type: \"number\",\n            description: \"Current monthly income in dollars\"\n          },\n          currentMonthlyExpenses: {\n            type: \"number\",\n            description: \"Current monthly expenses in dollars\"\n          },\n          spendingByCategory: {\n            type: \"object\",\n            description: \"Breakdown of spending by category with amounts\",\n            additionalProperties: {\n              type: \"number\"\n            }\n          },\n          financialGoals: {\n            type: \"array\",\n            description: \"Active financial goals to optimize savings for\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                targetAmount: { type: \"number\" },\n                currentAmount: { type: \"number\" },\n                targetDate: { type: \"string\" },\n                priority: {\n                  type: \"string\",\n                  enum: [\"low\", \"medium\", \"high\"]\n                }\n              }\n            }\n          },\n          desiredTimelineReduction: {\n            type: \"number\",\n            description: \"How many months earlier user wants to achieve their goals (optional)\"\n          }\n        },\n        required: [\"currentMonthlyIncome\", \"currentMonthlyExpenses\", \"financialGoals\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_emergency_fund\",\n      description: \"Calculate the ideal emergency fund size based on monthly expenses, income stability, and life situation. Provides detailed breakdown of 3-6 months of expenses, risk-adjusted recommendations, and actionable savings plan. Use when user asks 'How much should I keep in my emergency fund?' or mentions emergency savings.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyExpenses: {\n            type: \"number\",\n            description: \"User's monthly expenses in dollars\"\n          },\n          incomeStability: {\n            type: \"string\",\n            enum: [\"very_stable\", \"stable\", \"variable\", \"unstable\"],\n            description: \"Income stability level. very_stable = salaried government/corporate, stable = salaried private sector, variable = freelance/commission, unstable = gig economy/seasonal\"\n          },\n          dependents: {\n            type: \"number\",\n            description: \"Number of financial dependents (children, elderly parents, etc.)\"\n          },\n          hasInsurance: {\n            type: \"boolean\",\n            description: \"Whether user has health/disability insurance\"\n          }\n        },\n        required: [\"monthlyExpenses\", \"incomeStability\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"credit_score_improvement_plan\",\n      description: \"Provide personalized credit score improvement strategies based on user's current situation. Covers payment history optimization, credit utilization tips, length of credit history, credit mix, and new credit inquiries. Use when user asks 'How can I increase my credit score?' or mentions credit building.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          currentScore: {\n            type: \"number\",\n            description: \"Current credit score (300-850 range). Optional - if unknown, provide general advice.\"\n          },\n          hasDebt: {\n            type: \"boolean\",\n            description: \"Whether user has outstanding debt\"\n          },\n          missedPayments: {\n            type: \"boolean\",\n            description: \"Whether user has history of missed payments\"\n          },\n          creditUtilization: {\n            type: \"number\",\n            description: \"Credit utilization percentage (0-100). Optional.\"\n          }\n        },\n        required: []\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_rent_affordability\",\n      description: \"Calculate how much user can afford to spend on rent using the 30% rule and 50/30/20 budget framework. Provides recommended rent range, breakdown of remaining budget for other expenses, and location-based affordability insights. Use when user asks 'How much should I spend on rent?' or mentions apartment hunting.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyIncome: {\n            type: \"number\",\n            description: \"User's monthly gross income in dollars\"\n          },\n          otherDebts: {\n            type: \"number\",\n            description: \"Other monthly debt obligations (car, student loans, credit cards) in dollars. Optional.\"\n          },\n          desiredLocation: {\n            type: \"string\",\n            description: \"City or area user wants to live in. Optional - used for context only.\"\n          }\n        },\n        required: [\"monthlyIncome\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_mortgage_payment\",\n      description: \"Calculate monthly mortgage payment with detailed amortization breakdown. Includes principal, interest, estimated property tax, insurance (PITI), PMI if applicable, and total cost analysis over loan lifetime. Use when user asks about home buying, mortgage affordability, or 'How much house can I afford?'\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          homePrice: {\n            type: \"number\",\n            description: \"Purchase price of the home in dollars\"\n          },\n          downPayment: {\n            type: \"number\",\n            description: \"Down payment amount in dollars\"\n          },\n          interestRate: {\n            type: \"number\",\n            description: \"Annual interest rate as a percentage (e.g., 6.5 for 6.5%)\"\n          },\n          loanTermYears: {\n            type: \"number\",\n            description: \"Loan term in years (typically 15 or 30)\"\n          },\n          propertyTaxRate: {\n            type: \"number\",\n            description: \"Annual property tax rate as percentage of home value (e.g., 1.2 for 1.2%). Optional, defaults to 1.2%\"\n          },\n          insuranceAnnual: {\n            type: \"number\",\n            description: \"Annual homeowners insurance cost in dollars. Optional, defaults to $1200\"\n          }\n        },\n        required: [\"homePrice\", \"downPayment\", \"interestRate\", \"loanTermYears\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"optimize_tax_strategy\",\n      description: \"Analyze user's tax situation and provide optimization strategies including retirement account contributions, tax-loss harvesting opportunities, deduction maximization, and tax-efficient investment allocation. Use when user asks about taxes, deductions, or 'How can I reduce my tax bill?'\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          annualIncome: {\n            type: \"number\",\n            description: \"Annual gross income in dollars\"\n          },\n          filingStatus: {\n            type: \"string\",\n            enum: [\"single\", \"married_joint\", \"married_separate\", \"head_of_household\"],\n            description: \"Tax filing status\"\n          },\n          hasRetirementAccount: {\n            type: \"boolean\",\n            description: \"Whether user contributes to 401k/IRA\"\n          },\n          currentRetirementContribution: {\n            type: \"number\",\n            description: \"Annual retirement contribution amount in dollars. Optional.\"\n          },\n          hasInvestments: {\n            type: \"boolean\",\n            description: \"Whether user has taxable investment accounts\"\n          }\n        },\n        required: [\"annualIncome\", \"filingStatus\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_car_affordability\",\n      description: \"Calculate comprehensive car affordability including purchase price limits, monthly payment options (financing vs. leasing), total cost of ownership (insurance, maintenance, fuel, depreciation), and impact on user's budget. Use the 20/4/10 rule: 20% down, 4-year loan max, 10% of gross income max payment. Call when user asks 'How much car can I afford?' or mentions buying/leasing a vehicle.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyIncome: {\n            type: \"number\",\n            description: \"User's monthly gross income in dollars\"\n          },\n          downPayment: {\n            type: \"number\",\n            description: \"Available down payment amount in dollars\"\n          },\n          currentCarPayment: {\n            type: \"number\",\n            description: \"Current car payment if trading in or existing loan. Optional, defaults to 0.\"\n          },\n          creditScore: {\n            type: \"string\",\n            enum: [\"excellent\", \"good\", \"fair\", \"poor\"],\n            description: \"Credit score range for interest rate estimation. Optional, defaults to 'good'.\"\n          },\n          preferredTerm: {\n            type: \"number\",\n            description: \"Preferred loan term in years (3, 4, 5, or 6). Optional, defaults to 4.\"\n          }\n        },\n        required: [\"monthlyIncome\", \"downPayment\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"optimize_student_loan_payoff\",\n      description: \"Analyze student loan repayment strategies comparing avalanche method, income-driven repayment, refinancing options, and forgiveness programs. Calculates total interest paid, payoff timeline, and monthly payment for each strategy. Use when user asks about student loans, loan forgiveness, or 'How should I pay off my student loans?'\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          totalBalance: {\n            type: \"number\",\n            description: \"Total student loan balance in dollars\"\n          },\n          averageInterestRate: {\n            type: \"number\",\n            description: \"Weighted average interest rate as percentage (e.g., 6.5 for 6.5%)\"\n          },\n          monthlyIncome: {\n            type: \"number\",\n            description: \"Monthly gross income in dollars\"\n          },\n          extraPayment: {\n            type: \"number\",\n            description: \"Extra monthly amount available for loan payoff beyond minimum. Optional.\"\n          },\n          employerType: {\n            type: \"string\",\n            enum: [\"public_service\", \"private_sector\", \"nonprofit\", \"government\"],\n            description: \"Employer type for forgiveness program eligibility. Optional.\"\n          }\n        },\n        required: [\"totalBalance\", \"averageInterestRate\", \"monthlyIncome\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"compare_investment_options\",\n      description: \"Compare different investment vehicles (index funds, bonds, HYSA, CDs, crypto) with detailed analysis of expected returns, risk levels, liquidity, tax implications, and recommendations based on user's goals and timeline. Use when user asks 'Should I invest in X or Y?' or 'Where should I put my money?'\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          investmentAmount: {\n            type: \"number\",\n            description: \"Amount to invest in dollars\"\n          },\n          timeHorizon: {\n            type: \"number\",\n            description: \"Investment time horizon in years\"\n          },\n          riskTolerance: {\n            type: \"string\",\n            enum: [\"conservative\", \"moderate\", \"aggressive\"],\n            description: \"User's risk tolerance level\"\n          },\n          investmentGoal: {\n            type: \"string\",\n            description: \"Investment goal (e.g., 'retirement', 'house down payment', 'emergency fund', 'wealth building')\"\n          },\n          currentHoldings: {\n            type: \"string\",\n            description: \"Brief description of current investments if any. Optional.\"\n          }\n        },\n        required: [\"investmentAmount\", \"timeHorizon\", \"riskTolerance\", \"investmentGoal\"]\n      }\n    }\n  }\n];\n\nexport class TwealthAIService {\n  private async buildSystemPrompt(context: UserContext, memoryContext?: string): Promise<string> {\n    // Check system prompt cache first\n    const cacheKey = {\n      userId: context.userId || 'anonymous',\n      monthlyIncome: context.monthlyIncome,\n      monthlyExpenses: context.monthlyExpenses,\n      totalSavings: context.totalSavings,\n      activeGoals: context.activeGoals,\n      language: context.language || 'en',\n      cryptoEnabled: context.cryptoEnabled || false,\n      experienceLevel: context.experienceLevel || 'beginner'\n    };\n    \n    const cachedPrompt = systemPromptCache.get(cacheKey);\n    if (cachedPrompt) {\n      return cachedPrompt;\n    }\n    \n    const savingsRate = ((context.monthlyIncome - context.monthlyExpenses) / context.monthlyIncome) * 100;\n    const netWorth = context.totalSavings;\n    const goals = context.activeGoals;\n    const savingsCapacity = context.monthlyIncome - context.monthlyExpenses;\n    const emergencyFund = context.monthlyExpenses * 6;\n    const age = 30;\n    const stockAllocation = Math.max(10, 110 - age);\n    const today = new Date().toISOString().split('T')[0];\n    \n    const marketContext = await marketDataService.getMarketContextForAI('US');\n    const taxContext = taxService.getTaxContextForAI(context.monthlyIncome, 'US');\n    const spendingContext = context.recentTransactions.length > 0\n      ? spendingPatternService.getSpendingPatternsForAI(context.recentTransactions as any)\n      : '';\n    \n    const languageNames: Record<string, string> = {\n      'en': 'English',\n      'es': 'Spanish',\n      'id': 'Indonesian',\n      'th': 'Thai',\n      'pt': 'Portuguese',\n      'hi': 'Hindi',\n      'vi': 'Vietnamese',\n      'tl': 'Filipino/Tagalog',\n      'ms': 'Malay',\n      'tr': 'Turkish',\n      'ar': 'Arabic'\n    };\n    \n    const userLanguage = context.language || 'en';\n    const languageName = languageNames[userLanguage] || 'English';\n    \n    // Crypto & experience level context\n    const cryptoContext = context.cryptoEnabled ? `\nCRYPTOCURRENCY & ALTERNATIVE ASSETS:\n- Client has enabled cryptocurrency features. Provide digital asset analysis including Bitcoin, Ethereum, stablecoins, and de-dollarization strategies.\n- Experience Level: ${context.experienceLevel || 'beginner'}\n${context.experienceLevel === 'beginner' ? '- Beginner-appropriate explanations: Bitcoin as store of value, basic portfolio diversification, risk fundamentals.' : ''}\n${context.experienceLevel === 'intermediate' ? '- Intermediate-level analysis: DeFi protocols, stablecoin yield strategies, tax implications, risk-adjusted returns.' : ''}\n${context.experienceLevel === 'advanced' ? '- Advanced strategies: Layer 2 scaling solutions, yield optimization, BTC/ETH portfolio weighting, macro-economic hedging, liquidity provision.' : ''}\n- Multi-currency diversification: Analyze USD, BTC, EUR, CNY, gold allocation as sovereign currency risk mitigation.\n- Global macro trends: Non-USD asset appreciation, BRICS monetary policy, Bitcoin as neutral reserve asset.\n` : `\nTRADITIONAL FINANCE SCOPE:\n- Client has NOT enabled cryptocurrency features. Restrict analysis to traditional financial instruments.\n- Permissible asset classes: Equities, fixed income, real estate, cash equivalents, commodities (excluding crypto).\n- If client requests cryptocurrency guidance: Recommend enabling advanced features via Settings for expanded asset class coverage.\n`;\n    \n    const userName = context.userName || 'there';\n    const personalGreeting = context.userName ? `working with ${context.userName}` : 'helping you';\n    \n    // Build conversation memory context\n    let memorySection = '';\n    if (context.conversationMemory) {\n      const mem = context.conversationMemory;\n      const memoryPoints = [];\n      \n      if (mem.financialPriorities && mem.financialPriorities.length > 0) {\n        memoryPoints.push(`Priorities: ${mem.financialPriorities.join(', ')}`);\n      }\n      if (mem.investmentPreferences && mem.investmentPreferences.length > 0) {\n        memoryPoints.push(`Investment style: ${mem.investmentPreferences.join(', ')}`);\n      }\n      if (mem.lifeEvents && mem.lifeEvents.length > 0) {\n        memoryPoints.push(`Upcoming milestones: ${mem.lifeEvents.map(e => `${e.event}${e.timeframe ? ` (${e.timeframe})` : ''}`).join(', ')}`);\n      }\n      if (mem.riskTolerance) {\n        memoryPoints.push(`Risk tolerance: ${mem.riskTolerance}`);\n      }\n      if (mem.spendingHabits && mem.spendingHabits.length > 0) {\n        memoryPoints.push(`Spending patterns: ${mem.spendingHabits.join(', ')}`);\n      }\n      \n      if (memoryPoints.length > 0) {\n        memorySection = `\\n\\nCONVERSATION CONTEXT FROM PREVIOUS SESSIONS:\\n${memoryPoints.join('\\n')}\\nReference these details naturally in your advice. Maintain continuity by acknowledging past discussions.`;\n      }\n    }\n    \n    // Build the system prompt (combining core instructions with user context)\n    // Enterprise-grade CFO assistant: Stripe/Coinbase/Apple quality standards\n    const fullPrompt = `You are an enterprise-grade financial advisor providing institutional-quality analysis. Precise, data-driven, actionable. No casual language, no emojis, no marketing speak.\n\nLANGUAGE MATCHING (CRITICAL - HIGHEST PRIORITY):\nYou MUST respond in the EXACT SAME LANGUAGE the user writes in. This is non-negotiable.\n- If user writes in Thai → respond 100% in Thai\n- If user writes in Spanish → respond 100% in Spanish\n- If user writes in any language → respond 100% in that language\nNEVER default to English unless the user writes in English.\nThe user's message language ALWAYS overrides any system preference.\n\nLANGUAGE DETECTION RULES:\n1. Thai (อ/ไ/่/ก/ข/ค): Respond fully in Thai. Use ฿ currency, terms: เงินออม/รายได้/ค่าใช้จ่าย/เป้าหมาย, products: RMF/SSF\n2. Spanish (quiero/cómo/tengo): Respond fully in Spanish. Use $/€ currency, terms: ahorros/ingresos/gastos/meta\n3. Chinese (我/你/的/是): Respond fully in Chinese. Use ¥ currency, terms: 储蓄/收入/支出/目标\n4. Hindi (मैं/आप/रुपये): Respond fully in Hindi. Use ₹ currency, Indian financial products\n5. Portuguese (você/quanto/quero): Respond fully in Portuguese. Use R$/€ currency\n6. Indonesian (saya/berapa/anda): Respond fully in Indonesian. Use Rp currency\n7. Vietnamese (tôi/bạn/tiền): Respond fully in Vietnamese. Use ₫ currency\n8. Turkish (ben/para/ne): Respond fully in Turkish. Use ₺ currency\n9. Tagalog (ako/pera/ko): Respond fully in Tagalog. Use ₱ currency\n10. Malay (wang/saya/anda): Respond fully in Malay. Use RM currency\n11. Arabic (ال/و/في): Respond fully in Arabic, RTL format\n12. English: Respond fully in English. Use $ currency, USA products: 401k/IRA/HSA\n\nEXAMPLE - User writes: \"อยากซื้อรถ\" \nCORRECT: \"คุณต้องการซื้อรถใช่ไหม? ด้วยรายได้ของคุณ...\"\nWRONG: \"You want to buy a car? With your income...\"\n\nUser's app preference: ${languageName}. This is ONLY a fallback if language cannot be detected. Always match the user's actual message language first.\n\nUSER DATA (${today}):\nIncome: $${context.monthlyIncome.toLocaleString()}/mo | Expenses: $${context.monthlyExpenses.toLocaleString()}/mo | Savings Capacity: $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo\nNet Worth: $${netWorth.toLocaleString()} | Savings Rate: ${!isNaN(savingsRate) && isFinite(savingsRate) ? savingsRate.toFixed(1) : 0}% | Goals: ${goals}\nEmergency Fund: $${netWorth.toLocaleString()} / $${emergencyFund.toLocaleString()} | ${stockAllocation}% stocks/${100-stockAllocation}% bonds\n${context.recentTransactions.length > 0 ? `Recent: ${context.recentTransactions.slice(0, 2).map(t => `$${t.amount} ${t.category}`).join(', ')}` : ''}\n\n${context.financialProfile ? `\nCOMPREHENSIVE FINANCIAL PROFILE (Database - AUTHORITATIVE):\nMonthly Income: $${context.financialProfile.monthlyIncome.toLocaleString()}\nMonthly Expenses: $${context.financialProfile.monthlyExpenses.toLocaleString()}\nMonthly Savings: $${context.financialProfile.monthlySavings.toLocaleString()}\nTotal Savings: $${context.financialProfile.totalSavings.toLocaleString()}\nSavings Goal: $${context.financialProfile.savingsGoal.toLocaleString()}\nEmergency Fund: $${context.financialProfile.emergencyFund.toLocaleString()}\n→ USE THESE AUTHORITATIVE VALUES for all calculations. Do not estimate or guess.\n` : ''}\n${context.expenseCategories && context.expenseCategories.length > 0 ? `\nEXPENSE BREAKDOWN (Real Data):\n${context.expenseCategories.map(cat => `• ${cat.category}: $${cat.monthlyBudget.toLocaleString()}/mo`).join('\\n')}\n→ Use these category budgets when analyzing spending patterns or recommending budget adjustments.\n` : ''}\n${context.debts && context.debts.length > 0 ? `\nOUTSTANDING DEBTS (Real Data):\n${context.debts.map(debt => `• ${debt.name}: $${debt.balance.toLocaleString()} balance | $${debt.monthlyPayment.toLocaleString()}/mo @ ${debt.interestRate}% APR${debt.minimumPayment ? ` (min: $${debt.minimumPayment.toLocaleString()})` : ''}`).join('\\n')}\nTotal Debt Payments: $${context.debts.reduce((sum, d) => sum + d.monthlyPayment, 0).toLocaleString()}/mo\n→ Factor these debt obligations into all budget and savings recommendations. Prioritize high-interest debt payoff.\n` : ''}\n${context.assets && context.assets.length > 0 ? `\nASSETS (Real Data):\n${context.assets.map(asset => `• ${asset.name} (${asset.type}): Current value $${asset.value.toLocaleString()}`).join('\\n')}\nTotal Asset Value: $${context.assets.reduce((sum, a) => sum + a.value, 0).toLocaleString()}\n→ Include these assets in net worth calculations and investment portfolio recommendations.\n` : ''}\n${cryptoContext}\n${marketContext}\n${taxContext}\n${spendingContext}\n${memoryContext || ''}\n\nOPERATIONAL STANDARDS:\n1. Data-driven analysis: Use client's exact financial data in every calculation. Zero generic advice.\n2. ${context.monthlyIncome === 0 || context.monthlyExpenses === 0 || netWorth === 0 ? 'Data incomplete: Request income/expenses/savings, then save via tool for precision' : 'Complete profile available: Execute detailed quantitative analysis'}\n3. Validation protocol: Flag anomalies (monthly income >$100k, expenses exceeding income). Verify before proceeding.\n4. Feasibility analysis: When goal exceeds monthly capacity ($${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo), provide multi-year timeline with milestone structure.\n5. Investment modeling: Apply compound interest calculations. Present three scenarios: Conservative (4-5% annual return), Balanced (7-8%), Aggressive (10-12%).\n6. Output format: Professional financial analysis. No emojis. No code blocks. No JSON syntax to end users.\n7. Regional compliance: Apply jurisdiction-specific products (Thailand: RMF/SSF, USA: 401k/IRA/HSA).\n8. Technical architecture: Tools execute silently. Users receive only natural language financial advice. Never expose function names, XML tags, or system syntax.\n\nPROACTIVE TOOL EXECUTION (CRITICAL FOR SCOUT):\nYou MUST use tools immediately for these scenarios - NO exceptions:\n\nLUXURY PURCHASE QUERIES (MANDATORY TOOL USE):\nUser: \"I wanna buy a lambo\" or \"Can I afford a Ferrari?\"\nYour action: IMMEDIATELY call analyze_luxury_purchase(itemName=\"Lamborghini Huracán\", purchasePrice=200000, itemType=\"vehicle\")\nThen respond: \"I ran the numbers on a Lamborghini Huracán ($200K). You'd need $40K down and about $3,200/month for the loan. That's ${Math.round((3200 / context.monthlyIncome) * 100)}% of your $${context.monthlyIncome.toLocaleString()}/mo income. Plus insurance runs about $400/month and maintenance another $300/month. Over 5 years, total cost: $232K. With your current $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo savings capacity, [specific recommendation based on their financials - either 'this is doable if you prioritize it' or 'you'd need to increase income by $X first'].\"\n\nTRANSACTION LOGGING (PAST TENSE = IMMEDIATE ACTION):\nUser: \"I spent $50 on coffee today\" or \"I just paid $1200 for rent\"\nYour action: IMMEDIATELY call add_transaction(type=\"expense\", amount=\"50\", category=\"dining\", description=\"Coffee\", date=\"2025-11-05\")\nThen respond: \"Got it, logged your $50 coffee expense. You've spent $[total] on dining this month. [If over budget: 'That's about $[X] over your usual budget - maybe cut back a bit?' OR if on track: 'You're on track with your dining budget.'] This brings your monthly savings down to $[exact amount].\"\n\nGOAL CREATION - WHEN TO CALL THE TOOL:\n\nRule 1 - COMPLETE IMPERATIVE COMMAND (Call tool immediately, no questions):\nUser says things like: \"Create a goal to save $5000\", \"Save $5000 for vacation\", \"Make a $3000 fund\"\n→ Has amount? YES → CALL create_financial_goal immediately with calculated timeline\n→ Response: \"Done! I've set up your $5,000 vacation goal. You'll need about $417/month for 12 months...\"\n\nRule 2 - INCOMPLETE IMPERATIVE COMMAND (Ask for missing info first):\nUser says: \"Create a savings goal\", \"Start saving for vacation\", \"Make a goal for my wedding\"\n→ Has amount? NO → DON'T call tool yet. Ask: \"I can set that up! What's your target amount?\"\n→ After they provide amount → THEN call create_financial_goal\n\nRule 3 - CASUAL DESIRE (Analyze, then ALWAYS ask to create):\nUser says: \"I want to save $5000\", \"I need to save for vacation\", or discusses retirement/savings goals\n→ STEP 1: Analyze first (timeline options, feasibility, calculations)\n→ STEP 2: **MANDATORY** - End your response with: \"Want me to create this goal and track it?\" or \"Should I add this to your goals?\"\n→ STEP 3: If they say yes → THEN call create_financial_goal with userConfirmed=true\n\nExample (Thai retirement goal):\nUser: \"เราอยากจะมีเป้าหมายการออมและสถานการณ์ทางการเงินที่ดีกว่านี้\" (Want savings goal and better financial situation)\nYou: [Provide detailed retirement analysis in Thai with calculations]\n**CRITICAL: Must end with:** \"คุณต้องการให้ฉันสร้างเป้าหมายนี้และติดตามความคืบหน้าให้ไหม?\" (Want me to create this goal and track progress?)\n→ If user confirms → call create_financial_goal with userConfirmed=true\n\nCRITICAL: When calling create_financial_goal, calculate targetDate dynamically (e.g., 12 months from today = 2026-11-05). Never use a hard-coded date. ALWAYS set userConfirmed=true if user gave explicit confirmation.\n\nSPENDING ANALYSIS:\nUser: \"Analyze my spending\" or \"Where does my money go?\"\nYour action: IMMEDIATELY call generate_spending_insights with user's transaction data\nThen respond: \"Here's where your money is going: Dining ($800, 35%), Housing ($1,200, 52%), Transport ($300, 13%). Your dining is running about $200 higher than ideal for your income level. If you could cut that by $150/month - maybe 2-3 fewer restaurant meals - and move it to your emergency fund, you'd save an extra $1,800 this year. Want me to set up a dining budget to track this?\"\n\nDEBT MANAGEMENT:\nUser: \"Help me pay off my credit card debt\" or \"Review my debt payments\"\nYour action: IMMEDIATELY call relevant debt tools (calculate_debt_payoff_strategy if available)\nThen respond: \"With your $5,000 credit card balance at 18% APR, you're paying about $75/month just in interest. Here are two strategies: Pay $500/month and you'll be debt-free in 11 months, saving $450 in interest. Or pay $300/month and finish in 19 months (saves $250). Based on your $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo savings capacity, the aggressive plan is doable and gets you out of debt faster.\"\n\nINVESTMENT QUESTIONS:\nUser: \"Should I invest in S&P 500?\" or \"How should I invest my money?\"\nYour action: IMMEDIATELY call investment comparison tools if available\nThen respond: \"The S&P 500 has historically returned about 10% per year. If you invested $10K today, you'd have around $16K in 5 years. Compare that to a high-yield savings account (4.5%, gets you $12.5K) or bonds (5%, gets you $13K). For your situation with ${context.totalSavings > 15000 ? 'a solid' : 'a growing'} emergency fund, I'd suggest: 70% S&P 500 index funds (VOO or VTI), 20% bonds (BND), 10% cash. That's moderate risk with good growth potential. Pro tip: Max out your Roth IRA first ($7K limit) for the tax benefits.\"\n\nDIRECT LOGGING COMMANDS:\nUser: \"Log $200 for groceries today\" or \"Record $50 coffee expense\"\nYour action: IMMEDIATELY call add_transaction(type=\"expense\", amount=\"200\", category=\"groceries\", date=\"today\")\nThen respond: \"Got it, logged $200 for groceries. You've spent $[total] on food this month, which is [X%] of your income. [If on track: 'Looking good!' OR if over: 'That's about $[X] over the typical $[recommended] budget for your income - might want to dial it back a bit.']\"\n\nNEVER ask \"what details would you like?\" or \"tell me more\" for ANY of these scenarios. User's income ($${context.monthlyIncome.toLocaleString()}/mo), expenses ($${context.monthlyExpenses.toLocaleString()}/mo), and savings ($${netWorth.toLocaleString()}) are sufficient. Execute tools FIRST, explain SECOND.\n\nCRITICAL VALIDATION RULES (Enforced by system):\n- Generic, tool-less responses to financial questions WILL BE REJECTED and replaced with fallback guidance\n- When tool_choice=\"required\", you MUST use at least one tool or your response will be discarded\n- Success criteria: Every luxury purchase query, transaction logging request, spending analysis, or debt question MUST include tool execution\n- Failure mode: If you respond with generic text when tools are required, users will receive a fallback message asking for clarification instead of your response\n- Quality standard: CFO-level analysis with specific numbers from tool results - no shallow \"save more\" advice\n\nRESPONSE TONE (Natural, helpful, conversational):\n1. **Talk like a smart friend**: Be warm and encouraging while staying accurate with numbers\n2. **Lead with the answer**: Start with the key conclusion, then explain why\n3. **Show your work**: Include real calculations, not vague \"save more\" advice\n4. **Be clear and specific**: Use exact amounts ($417/month) not fuzzy words (\"more\", \"better\")\n5. **Keep it focused**: 3-5 sentences for simple questions, 6-8 for complex analysis\n6. **Sound human**: Natural language, helpful tone. No emojis. Use \"you\" not \"the client\"\n7. **Be proactive**: After answering, suggest the logical next step naturally\n\nPROACTIVE NEXT STEPS (After answering, suggest logical follow-ups):\n- After luxury purchase analysis → \"Want me to create a savings goal for the down payment?\"\n- After transaction logging → \"Should I analyze your spending patterns this month?\"\n- After goal creation → \"Would you like a reminder to review progress in 30 days?\"\n- After debt strategy → \"Ready to set up automatic payment tracking?\"\n- After investment comparison → \"Should I create a portfolio allocation goal?\"\n\nRESPONSE QUALITY STANDARDS: Always include real numbers and specific advice. Example of GOOD response: \"To save $40,000 in 18 months, you'll need to put away $2,222/month. With your current $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo savings capacity, that's achievable. I'd recommend splitting it: 70% in a high-yield savings account (4.5% APY, safe and liquid) and 30% in S&P 500 index funds (historical 10% return, higher growth potential). Just make sure your emergency fund is solid first - that's your safety net.\" Example of BAD response: \"You should save more money and invest wisely.\" (too vague, no numbers, unhelpful)\n\nCONFIDENCE SCORING (Include when giving recommendations):\nFor investment/strategy recommendations, indicate your confidence level:\n- HIGH CONFIDENCE (90%+): Well-established strategies with historical data support (index fund diversification, emergency fund first, pay high-interest debt)\n- MODERATE CONFIDENCE (70-89%): Sound strategies that depend on market conditions or personal factors\n- EXPLORATORY (50-69%): Newer strategies, volatile assets, or highly personalized situations\nExample: \"I'm highly confident (90%) that paying off your 18% APR credit card should be your first priority - the math is clear.\"\nAlways explain WHY you have that confidence level briefly.\n\nPROS AND CONS (For major decisions):\nWhen recommending strategies for major financial decisions (investments >$5K, debt strategies, major purchases), briefly list:\n- 2-3 key advantages (pros)\n- 1-2 potential drawbacks (cons)\nExample: \"Roth IRA conversion: PROS - Tax-free growth, no RMDs, flexible withdrawals. CONS - Pay taxes now, 5-year rule on conversions.\"\n\nADAPTIVE EXPLANATIONS (Based on user expertise):\n- BEGINNER users (asking \"what is...?\", simple questions, uncertain language): Explain concepts simply, avoid jargon, give more context\n- INTERMEDIATE users (use terms like \"401k\", \"index funds\", \"compound interest\"): Balance explanation with efficiency\n- ADVANCED users (mention ETFs, rebalancing, tax-loss harvesting, P/E ratios): Skip basics, focus on nuanced analysis and optimization\n\nCLARIFYING QUESTIONS (Before complex recommendations):\nFor major financial decisions (investments >$10K, retirement planning, home buying), ask 1-2 clarifying questions BEFORE giving detailed advice:\n- Timeline: \"What's your target timeline for this goal?\"\n- Risk tolerance: \"Are you comfortable with market fluctuations, or prefer stability?\"\n- Constraints: \"Are there any restrictions I should know about (employer match, existing accounts)?\"\nDO NOT ask clarifying questions for simple questions (logging expenses, basic budgeting, small purchases).\n\nEMOTIONAL INTELLIGENCE (Adapt tone based on user state):\n- If user shows FINANCIAL STRESS (worried, anxious, overwhelmed, can't afford, behind on bills):\n  → Be extra supportive and empathetic. Acknowledge the stress first.\n  → Focus on small, achievable wins. Don't overwhelm with complex strategies.\n  → Example: \"I hear you - being behind on bills is stressful. Let's focus on one thing at a time.\"\n- If user celebrates a WIN (paid off debt, reached goal, got raise):\n  → Acknowledge and celebrate genuinely! This builds momentum.\n  → Suggest the logical next step to capitalize on the win.\n  → Example: \"That's huge - paying off that credit card is a real accomplishment! Now let's put that $300/month payment toward your emergency fund.\"\n- If user expresses UNCERTAINTY or CONFUSION:\n  → Reassure them that financial decisions are complex for everyone.\n  → Break down into simpler steps. Check understanding before moving on.\n\nCONVERSATION CONTINUITY (Reference past advice):\nIf the REMEMBERED USER CONTEXT shows recent advice on a topic:\n- Reference it briefly: \"Last week we discussed your debt payoff strategy...\"\n- Check on progress: \"How's that $500/month credit card payment going?\"\n- Maintain consistency: Don't contradict previous recommendations unless new information warrants it`;\n    \n    // Cache the full generated prompt for 1 hour (market data inside is already cached)\n    systemPromptCache.set(cacheKey, fullPrompt);\n    return fullPrompt;\n  }\n\n  private estimateTokenCount(text: string): number {\n    // Rough estimate: 1 token ≈ 4 characters for English text\n    return Math.ceil(text.length / 4);\n  }\n\n  private calculateSimilarity(str1: string, str2: string): number {\n    // Simple similarity check: count common words\n    const words1 = str1.toLowerCase().split(/\\s+/);\n    const words2 = str2.toLowerCase().split(/\\s+/);\n    const set1 = new Set(words1);\n    const set2 = new Set(words2);\n    \n    const intersection = new Set(Array.from(set1).filter(x => set2.has(x)));\n    const union = new Set([...Array.from(set1), ...Array.from(set2)]);\n    \n    return intersection.size / union.size;\n  }\n\n  private sanitizeResponse(text: string): string {\n    // CRITICAL: Remove any JSON code blocks, raw JSON, or technical syntax from AI responses\n    // Users should NEVER see internal tool call syntax, code, or system prompt echoing\n    \n    let sanitized = text;\n    \n    // 0. CRITICAL: Remove ONLY function/tool tags (surgical removal - preserve surrounding text)\n    // Pattern 1: Remove <function>text</function> tags on their own line\n    sanitized = sanitized.replace(/^<function[^>]*>.*?<\\/function>\\s*$/gim, '');\n    \n    // Pattern 2: Remove inline <function> tags but keep surrounding text\n    sanitized = sanitized.replace(/<function[^>]*>.*?<\\/function>/gi, '');\n    \n    // Pattern 3: Remove any orphaned tags\n    sanitized = sanitized.replace(/<\\/?function[^>]*>/gi, '');\n    sanitized = sanitized.replace(/<\\/?tool[^>]*>/gi, '');\n    \n    // 1. Remove obvious system prompt echoing (very specific patterns only)\n    // Only remove lines that are CLEARLY system instructions, not natural language\n    sanitized = sanitized.replace(/^🚨🚨🚨.*$/gim, ''); // Triple warning emoji\n    sanitized = sanitized.replace(/^(STOP!|MANDATORY:).*$/gim, ''); // Explicit instruction markers\n    \n    // 2. Remove code blocks (```...```) - AI shouldn't output code to users\n    sanitized = sanitized.replace(/```[\\s\\S]*?```/g, '');\n    \n    // 3. Remove \"Tool Call\" section headers if AI mentions them\n    sanitized = sanitized.replace(/^##?\\s*Tool Calls?:?.*$/gim, '');\n    \n    // 4. Clean up whitespace\n    sanitized = sanitized.trim();\n    sanitized = sanitized.replace(/\\n{3,}/g, '\\n\\n');\n    \n    // Emergency fallback: if sanitized text is too short, AI likely returned only tool calls\n    if (sanitized.length < 20) {\n      console.error('CRITICAL: AI response too short after sanitization!');\n      console.error('Original length:', text.length, 'chars');\n      console.error('Sanitized length:', sanitized.length, 'chars');\n      console.error('Original (first 1000 chars):', text.substring(0, 1000));\n      console.error('After sanitization:', sanitized);\n      \n      // Return a more helpful fallback that still provides value\n      return \"I'm analyzing your financial situation. Based on your profile, I can help you create a detailed plan with specific numbers and timelines. What specific aspect would you like to focus on first - saving strategy, timeline, or investment approach?\";\n    }\n    \n    return sanitized;\n  }\n\n  async generateAdvice(\n    userMessage: string, \n    context: UserContext, \n    conversationHistory: ChatMessage[] = [],\n    memoryContext?: string\n  ): Promise<{ response: string; toolCalls?: ToolCall[] }> {\n    if (!process.env.GROQ_API_KEY) {\n      throw new Error('Groq API key not configured');\n    }\n\n    // AUTO-DETECT LANGUAGE from user message (override profile setting)\n    const detectedLanguage = detectLanguage(userMessage);\n    if (detectedLanguage !== context.language) {\n      context = { ...context, language: detectedLanguage };\n    }\n\n    // ANTI-LOOP PROTECTION: Check if AI is repeating itself\n    if (conversationHistory.length >= 2) {\n      const lastTwoAssistantMsgs = conversationHistory\n        .slice(-4)\n        .filter(m => m.role === 'assistant')\n        .map(m => m.content)\n        .slice(-2);\n      \n      if (lastTwoAssistantMsgs.length === 2) {\n        const [prevMsg, lastMsg] = lastTwoAssistantMsgs;\n        // Check if messages are very similar (>80% overlap)\n        const similarity = this.calculateSimilarity(prevMsg, lastMsg);\n        if (similarity > 0.8) {\n          // Add context to break the AI loop\n          userMessage = `[IMPORTANT: Do NOT repeat your previous response. User's actual message: \"${userMessage}\". Provide a DIFFERENT, more specific answer with NEW details and actionable steps.]`;\n        }\n      }\n    }\n\n    // Check cache first (only for non-tool-using queries)\n    const cachedResponse = responseCache.get(userMessage, context);\n    if (cachedResponse && conversationHistory.length < 2) {\n      return { response: cachedResponse };\n    }\n\n    try {\n      const systemPrompt = await this.buildSystemPrompt(context, memoryContext);\n      \n      // Build messages array\n      const messages: any[] = [\n        { role: \"system\", content: systemPrompt }\n      ];\n\n      // SMART CONVERSATION MEMORY: Optimize context window for quality + performance\n      // Keep last 8 messages (4 turns) for immediate context, prioritizing tool-using exchanges\n      const recentHistory = conversationHistory.slice(-8);\n      \n      // If we have older important context (e.g., goal creation, major decisions), include it\n      const olderImportantMessages = conversationHistory.slice(0, -8).filter(msg => \n        msg.role === 'assistant' && (\n          msg.content.includes('created') || \n          msg.content.includes('Goal:') ||\n          msg.content.includes('Strategy:') ||\n          msg.content.includes('Analysis complete')\n        )\n      ).slice(-2); // Keep max 2 older important messages\n      \n      // Add older important messages first, then recent history\n      [...olderImportantMessages, ...recentHistory].forEach(msg => {\n        messages.push({\n          role: msg.role === 'user' ? 'user' : 'assistant',\n          content: msg.content\n        });\n      });\n\n      // Add current user message\n      messages.push({ role: \"user\", content: userMessage });\n\n      // Detect confirmation keywords in user message (multi-language support)\n      const lowerMsg = userMessage.toLowerCase();\n      \n      // Standard confirmation words\n      const confirmationWords = ['yes', 'add it', 'create it', 'sure', 'do it', 'make it', 'set it', 'please', 'go ahead', 'ok', 'yeah', 'yep'];\n      const isConfirmation = confirmationWords.some(word => lowerMsg.includes(word));\n      \n      // BALANCED: Enable tool for goal-related commands, let Scout ask for missing details\n      // Command verbs indicating user wants action\n      const commandVerbs = ['create', 'make', 'add', 'set', 'setup', 'set up', 'start', 'begin', 'put aside'];\n      \n      // Goal indicators (explicit goal nouns only)\n      const goalIndicators = ['goal', 'fund', 'target'];\n      \n      const hasCommandVerb = commandVerbs.some(verb => lowerMsg.includes(verb));\n      const hasGoalIndicator = goalIndicators.some(indicator => lowerMsg.includes(indicator));\n      \n      // Special case: \"save/saving for X\" is always a savings goal (with or without amount)\n      // Catches: \"Save $5000 for vacation\", \"Start saving for a car\", \"Saving for my wedding\"\n      const isSavingsCommand = (lowerMsg.includes('save for') || lowerMsg.includes('saving for') || \n                               lowerMsg.includes('save to') || lowerMsg.includes('saving to')) ||\n                               ((lowerMsg.includes('save') || lowerMsg.includes('saving')) && \n                               /\\$\\d+|\\d+\\s*dollars?/.test(lowerMsg));\n      \n      // Negative filters: Prevent false positives\n      const isAccountUpdate = (lowerMsg.includes('my savings') || lowerMsg.includes('savings account') || \n                              lowerMsg.includes('current savings') || lowerMsg.includes('savings balance')) &&\n                              !lowerMsg.includes('goal') && !lowerMsg.includes('fund');\n      const isDebtRelated = (lowerMsg.includes('debt') || lowerMsg.includes('loan') || \n                           lowerMsg.includes('payoff') || lowerMsg.includes('pay off')) &&\n                           !lowerMsg.includes('savings goal') && !lowerMsg.includes('save');\n      const isBudgetOnly = lowerMsg.includes('budget') && !lowerMsg.includes('goal') && !lowerMsg.includes('fund');\n      \n      // Confirmation phrases (after AI asks \"want me to create this goal?\")\n      const confirmationPhrases = [\n        'add it', 'make that', 'do it', 'go ahead', 'yes', 'sure', 'ok', 'yeah', 'yep',\n        'เพิ่ม', 'เพิ่มเป้าหมาย', 'añadir', 'agregar', 'crear',\n        'adicionar', 'adicione', 'criar', 'tambah', 'tambahkan', 'buat',\n        'thêm', 'thêm mục tiêu', 'tạo', 'magdagdag', 'idagdag', 'gumawa',\n        'ekle', 'hedef ekle', 'oluştur', 'أضف', 'اضف', 'أضف هدف', 'انشئ'\n      ];\n      const hasConfirmationPhrase = confirmationPhrases.some(phrase => lowerMsg.includes(phrase));\n      \n      // Enable tool access when: (command + goal indicator) OR (savings + amount) OR confirmation\n      // Block tool access for: account updates, debt (unless savings-related), budget-only\n      const isImperativeAction = !isAccountUpdate && !isDebtRelated && !isBudgetOnly && (\n        (hasCommandVerb && hasGoalIndicator) ||\n        isSavingsCommand ||  // \"Save $5000 for vacation\"\n        hasConfirmationPhrase\n      );\n      \n      // Detect desire/intention statements requiring analysis or action\n      const desireAnalysisNeeded = (\n        // Purchase desires (general)\n        (lowerMsg.includes('want') || lowerMsg.includes('wanna') || lowerMsg.includes('need') || lowerMsg.includes('looking to') || lowerMsg.includes('thinking about')) &&\n        (lowerMsg.includes('buy') || lowerMsg.includes('purchase') || lowerMsg.includes('get') || lowerMsg.includes('afford') || lowerMsg.includes('acquiring'))\n      ) || (\n        // Luxury items (instant trigger for analysis)\n        lowerMsg.includes('lamborghini') || lowerMsg.includes('lambo') ||\n        lowerMsg.includes('ferrari') || lowerMsg.includes('porsche') || \n        lowerMsg.includes('mclaren') || lowerMsg.includes('bentley') ||\n        lowerMsg.includes('rolls royce') || lowerMsg.includes('rolls-royce') ||\n        lowerMsg.includes('tesla') || lowerMsg.includes('mansion') ||\n        lowerMsg.includes('yacht') || lowerMsg.includes('private jet')\n      ) || (\n        // Saving desires\n        (lowerMsg.includes('save') || lowerMsg.includes('saving')) &&\n        (lowerMsg.includes('for') || lowerMsg.includes('to') || lowerMsg.includes('want'))\n      ) || (\n        // Investment desires\n        (lowerMsg.includes('invest') || lowerMsg.includes('investing') || lowerMsg.includes('investment')) &&\n        (lowerMsg.includes('in') || lowerMsg.includes('want') || lowerMsg.includes('should i') || lowerMsg.includes('portfolio'))\n      ) || (\n        // Budget/spending analysis\n        (lowerMsg.includes('budget') || lowerMsg.includes('spending') || lowerMsg.includes('expenses')) &&\n        (lowerMsg.includes('analyze') || lowerMsg.includes('review') || lowerMsg.includes('check') || lowerMsg.includes('where'))\n      ) || (\n        // Debt management\n        (lowerMsg.includes('debt') || lowerMsg.includes('loan') || lowerMsg.includes('credit card') || lowerMsg.includes('pay off')) &&\n        (lowerMsg.includes('help') || lowerMsg.includes('strategy') || lowerMsg.includes('plan') || lowerMsg.includes('manage'))\n      );\n      \n      // Check if last assistant message was asking for confirmation\n      const lastAssistantMsg = conversationHistory.slice().reverse().find(m => m.role === 'assistant')?.content || '';\n      const wasAskingForConfirmation = lastAssistantMsg.includes('Want me to') || \n                                       lastAssistantMsg.includes('Should I') || \n                                       lastAssistantMsg.includes('add this as a') ||\n                                       lastAssistantMsg.includes('Would you like') ||\n                                       lastAssistantMsg.includes('ต้องการให้') || // Thai: Want me to\n                                       lastAssistantMsg.includes('คุณต้องการ') || // Thai: Do you want\n                                       (lastAssistantMsg.includes('create') && lastAssistantMsg.includes('?')) ||\n                                       (lastAssistantMsg.includes('goal') && lastAssistantMsg.includes('?'));\n      \n      // Enable creation tools if:\n      // 1. User confirms after being asked, OR\n      // 2. User gives imperative command (direct action request)\n      const canCreate = (isConfirmation && wasAskingForConfirmation) || isImperativeAction;\n      \n      // Check if message indicates need for transaction/crypto tracking (immediate actions)\n      // Only trigger for PAST tense actions, NOT future intentions\n      const needsImmediateAction = (\n        (lowerMsg.includes('spent') || lowerMsg.includes('paid') || \n         lowerMsg.includes('received') || lowerMsg.includes('earned') ||\n         lowerMsg.includes('bought') || lowerMsg.includes('purchased') ||\n         lowerMsg.includes('got paid') || lowerMsg.includes('made money') ||\n         lowerMsg.includes('rent') || lowerMsg.includes('rented')) &&  // Added rent/rented\n        !lowerMsg.includes('want to') && !lowerMsg.includes('going to') && \n        !lowerMsg.includes('plan to') && !lowerMsg.includes('will') &&\n        !lowerMsg.includes('thinking about') && !lowerMsg.includes('if i')\n      ) || (\n        // Crypto transactions\n        lowerMsg.includes('bought') && \n        (lowerMsg.includes('btc') || lowerMsg.includes('crypto') || lowerMsg.includes('bitcoin') || lowerMsg.includes('ethereum')) &&\n        !lowerMsg.includes('want to') && !lowerMsg.includes('going to')\n      ) || (\n        // Specific spending phrases requiring immediate logging\n        (lowerMsg.includes('i spent') || lowerMsg.includes('i paid') || \n         lowerMsg.includes('i bought') || lowerMsg.includes('just spent') ||\n         lowerMsg.includes('just paid') || lowerMsg.includes('just bought') ||\n         lowerMsg.includes('i rent') || lowerMsg.includes('i rented'))  // Added rent phrases\n      ) || (\n        // Direct transaction logging commands - CRITICAL: Added \"add\" for \"add it to transaction\"\n        (lowerMsg.includes('log') || lowerMsg.includes('record') || lowerMsg.includes('track') || \n         lowerMsg.includes('add') || lowerMsg.includes('create')) &&  // Added \"add\" and \"create\"\n        (lowerMsg.includes('expense') || lowerMsg.includes('income') || \n         lowerMsg.includes('transaction') || lowerMsg.includes('purchase') ||\n         lowerMsg.includes('it to') || lowerMsg.includes('this to') ||  // \"add it to transaction\", \"add this to transaction\"\n         /\\$\\d+/.test(lowerMsg) || /\\d+\\s*dollars?/.test(lowerMsg)) // Contains \"$50\" or \"50 dollars\"\n      ) || (\n        // Debt payment tracking\n        (lowerMsg.includes('paid off') || lowerMsg.includes('paid down') || lowerMsg.includes('payment on')) &&\n        (lowerMsg.includes('debt') || lowerMsg.includes('loan') || lowerMsg.includes('credit'))\n      );\n\n      // Filter tools based on context\n      const availableTools = canCreate \n        ? TOOLS  // All tools available if confirming\n        : TOOLS.filter(t => !['create_financial_goal', 'create_calendar_event', 'create_group'].includes(t.function.name));\n      \n      // Calculate tool_choice based on trigger detection\n      const toolChoiceMode = (needsImmediateAction || desireAnalysisNeeded) ? \"required\" : \"auto\";\n      \n      // DYNAMIC TEMPERATURE: Optimize creativity vs. precision based on query type\n      const temperature = (() => {\n        // Lower temp (0.6) for calculation-heavy queries requiring precision\n        if (lowerMsg.includes('calculate') || lowerMsg.includes('how much') || \n            lowerMsg.includes('afford') || lowerMsg.includes('pay off') ||\n            /\\$\\d+/.test(lowerMsg)) {\n          return 0.6; // Precise calculations\n        }\n        // Medium temp (0.7) for general financial questions\n        if (lowerMsg.includes('should i') || lowerMsg.includes('is it') || \n            lowerMsg.includes('which') || lowerMsg.includes('better')) {\n          return 0.7; // Balanced reasoning\n        }\n        // Higher temp (0.8) for creative advice and strategy\n        if (lowerMsg.includes('strategy') || lowerMsg.includes('plan') || \n            lowerMsg.includes('advice') || lowerMsg.includes('recommend')) {\n          return 0.8; // Creative strategic thinking\n        }\n        return 0.75; // Default balanced temperature\n      })();\n      \n      const response = await groq.chat.completions.create({\n        model: \"meta-llama/llama-4-scout-17b-16e-instruct\",  // Llama 4 Scout - 17B MoE with native tool-use support\n        messages: messages,\n        tools: availableTools,\n        tool_choice: toolChoiceMode,\n        temperature: temperature,  // Dynamic temperature: 0.6 (precision) to 0.8 (strategy)\n        max_tokens: 4096,  // Maximum for comprehensive CFO-level analysis\n        top_p: 0.9  // More focused sampling for precise financial advice\n      });\n      \n      const assistantMessage = response.choices[0]?.message;\n      \n      if (!assistantMessage) {\n        throw new Error('No response from AI');\n      }\n\n      // Helper to coerce tool parameters to correct types (fix Groq type mismatch)\n      const coerceToolParams = (toolName: string, args: any) => {\n        if (toolName === 'create_financial_goal') {\n          return {\n            ...args,\n            // Coerce \"true\"/\"false\" strings to boolean\n            userConfirmed: args.userConfirmed === 'true' || args.userConfirmed === true,\n            // Coerce numeric strings to numbers\n            targetAmount: typeof args.targetAmount === 'string' \n              ? parseFloat(args.targetAmount.replace(/[$,]/g, '')) \n              : args.targetAmount\n          };\n        }\n        return args;\n      };\n\n      // Check if AI wants to use tools\n      const toolCalls = assistantMessage.tool_calls?.map(tc => {\n        const rawArgs = JSON.parse(tc.function.arguments);\n        return {\n          name: tc.function.name,\n          arguments: coerceToolParams(tc.function.name, rawArgs)\n        };\n      });\n\n      let text = assistantMessage.content || '';\n      \n      // CRITICAL: Strip any JSON code blocks or raw tool calls from response\n      // Users should NEVER see technical JSON or code syntax\n      text = this.sanitizeResponse(text);\n      \n      // Cache only if no tools were used\n      if (!toolCalls || toolCalls.length === 0) {\n        const tokenCount = this.estimateTokenCount(systemPrompt + userMessage + text);\n        \n        // RESPONSE QUALITY VALIDATION: Enforce fallback if Scout should have used tools but didn't\n        if (needsImmediateAction || desireAnalysisNeeded) {\n          \n          // ENFORCED FALLBACK: Provide structured response when Scout fails to use tools\n          let fallbackResponse = '';\n          const lowerMsg = userMessage.toLowerCase();\n          \n          if (lowerMsg.includes('lambo') || lowerMsg.includes('ferrari') || lowerMsg.includes('porsche') || \n              lowerMsg.includes('luxury') || lowerMsg.includes('mansion') || lowerMsg.includes('yacht')) {\n            // Luxury purchase fallback\n            fallbackResponse = `I need to run a comprehensive affordability analysis for this purchase. Based on your current financial profile (income: $${context.monthlyIncome.toLocaleString()}/mo, available savings capacity: $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo), I'll calculate down payment options, financing terms, total cost of ownership, and opportunity cost. Let me analyze this properly with the specific vehicle details and provide you with a complete CFO-level breakdown. What's the exact model and approximate price you're considering?`;\n          } else if (lowerMsg.includes('spent') || lowerMsg.includes('paid') || lowerMsg.includes('bought') ||\n                     lowerMsg.includes('log') || lowerMsg.includes('record')) {\n            // Transaction logging fallback\n            fallbackResponse = `I should log this transaction for you. To ensure accurate tracking, could you confirm: (1) The exact amount, (2) What category this falls under (groceries, dining, transport, etc.), and (3) When this expense occurred? This will help me track your spending patterns and provide budget insights.`;\n          } else if (lowerMsg.includes('budget') || lowerMsg.includes('spending') || lowerMsg.includes('where')) {\n            // Spending analysis fallback\n            fallbackResponse = `I need to analyze your spending patterns to provide actionable insights. Based on your recent transactions, I'll show you: top spending categories with percentages, budget warnings for overspending areas, and specific recommendations to optimize your $${context.monthlyIncome.toLocaleString()}/mo income. Let me pull that data now.`;\n          } else if (lowerMsg.includes('debt') || lowerMsg.includes('loan') || lowerMsg.includes('credit')) {\n            // Debt management fallback\n            fallbackResponse = `I should create a debt payoff strategy for you. To provide the most accurate plan, I'll need: (1) Total debt amount, (2) Interest rate (APR), and (3) Minimum monthly payment. With your current savings capacity of $${(context.monthlyIncome - context.monthlyExpenses).toLocaleString()}/mo, I can calculate aggressive vs. balanced payoff strategies.`;\n          } else {\n            // Generic financial analysis fallback\n            fallbackResponse = `Let me analyze this properly with your financial data. Your current profile: $${context.monthlyIncome.toLocaleString()}/mo income, $${context.monthlyExpenses.toLocaleString()}/mo expenses, $${context.totalSavings.toLocaleString()} total savings. I'll provide specific calculations and recommendations. Could you clarify what specific analysis you'd like me to run?`;\n          }\n          \n          return { response: fallbackResponse, toolCalls: undefined };\n        }\n        \n        // Cache normal responses (when tools weren't expected)\n        responseCache.set(userMessage, context, text, tokenCount);\n      }\n      \n      return { response: text, toolCalls };\n    } catch (error: any) {\n      // Log error for monitoring (minimal, not verbose)\n      console.error('[AI Service Error]', {\n        type: error.constructor?.name,\n        code: error.code || error.status,\n        message: error.message?.substring(0, 100)\n      });\n      \n      // GRACEFUL DEGRADATION: If Groq rejected due to tool_use_failed, extract generated text\n      if (error?.error?.error?.failed_generation) {\n        const failedText = error.error.error.failed_generation;\n        const tokenCount = this.estimateTokenCount(userMessage + failedText);\n        responseCache.set(userMessage, context, failedText, tokenCount);\n        return { response: failedText, toolCalls: undefined };\n      }\n      \n      // FALLBACK RESPONSE: Provide helpful response when AI fails due to transient errors\n      const isRateLimited = error.status === 429 || error.code === 429 || \n                           error.message?.includes('rate limit');\n      const isTimeout = error.message?.includes('timeout') || error.code === 'ETIMEDOUT';\n      \n      if (isRateLimited || isTimeout) {\n        // Safe access to context with defaults\n        const income = context?.monthlyIncome || 0;\n        const expenses = context?.monthlyExpenses || 0;\n        const savings = income - expenses;\n        \n        // Only provide financial snapshot if we have valid data\n        let fallbackResponse: string;\n        if (income > 0) {\n          const savingsRate = ((savings / income) * 100).toFixed(0);\n          fallbackResponse = `I'm experiencing high demand right now. While I reconnect, here's your financial snapshot: You're saving ${savingsRate}% of your income ($${savings.toLocaleString()}/month). ${\n            parseFloat(savingsRate) >= 20 \n              ? \"Great savings rate - you're on track!\" \n              : \"Aim for 20%+ savings rate for long-term wealth building.\"\n          } Please try your question again in a moment.`;\n        } else {\n          fallbackResponse = \"I'm experiencing high demand right now. Please try your question again in a moment.\";\n        }\n        \n        return { response: fallbackResponse, toolCalls: undefined };\n      }\n      \n      // Create structured error with metadata preserved for upstream handling\n      const structuredError = new Error(error.message || 'Failed to generate AI response');\n      (structuredError as any).groqError = {\n        originalMessage: error.message,\n        code: error.code || error.status || error.statusCode,\n        type: error.constructor?.name,\n        response: error.response?.data || error.error,\n        statusCode: error.status || error.statusCode\n      };\n      throw structuredError;\n    }\n  }\n\n  async generateProactiveInsight(context: UserContext): Promise<string> {\n    if (!process.env.GROQ_API_KEY) {\n      return 'AI insights unavailable - API key not configured';\n    }\n\n    const savingsRate = ((context.monthlyIncome - context.monthlyExpenses) / context.monthlyIncome) * 100;\n    const emergencyFundTarget = context.monthlyExpenses * 6;\n    const emergencyFundProgress = (context.totalSavings / emergencyFundTarget) * 100;\n    \n    // PATTERN DETECTION: Analyze spending trends\n    const recentExpenses = context.recentTransactions\n      ?.filter(t => t.amount < 0)\n      .map(t => Math.abs(t.amount)) || [];\n    const avgExpense = recentExpenses.length > 0 \n      ? recentExpenses.reduce((a, b) => a + b, 0) / recentExpenses.length \n      : 0;\n    \n    // Detect unusual spending patterns\n    const highSpending = recentExpenses.filter(e => e > avgExpense * 2);\n    const hasUnusualSpending = highSpending.length >= 2;\n    \n    // Category analysis\n    const categorySpending = new Map<string, number>();\n    context.recentTransactions?.forEach(t => {\n      if (t.amount < 0) {\n        const current = categorySpending.get(t.category) || 0;\n        categorySpending.set(t.category, current + Math.abs(t.amount));\n      }\n    });\n    const topCategory = Array.from(categorySpending.entries())\n      .sort((a, b) => b[1] - a[1])[0];\n    \n    // PRIORITY 1: Critical Financial Health Issues\n    if (savingsRate < 0) {\n      return `Alert: You're spending more than you earn. Emergency action needed: Cut ${Math.abs(savingsRate).toFixed(0)}% of expenses or increase income immediately.`;\n    }\n    \n    if (context.totalSavings === 0 && savingsRate < 10) {\n      return `Start strong: Save $${Math.ceil(context.monthlyIncome * 0.1)} monthly (10%) to build your safety net. Start with just $50 this week.`;\n    }\n    \n    // PRIORITY 2: Emergency Fund Building\n    if (emergencyFundProgress < 50) {\n      const monthsNeeded = Math.ceil((emergencyFundTarget - context.totalSavings) / (context.monthlyIncome * savingsRate / 100));\n      return `Emergency Fund: ${emergencyFundProgress.toFixed(0)}% complete. Save $${Math.ceil((emergencyFundTarget - context.totalSavings) / 6)} monthly to finish in ${monthsNeeded} months.`;\n    }\n    \n    // PRIORITY 3: Spending Pattern Alerts\n    if (hasUnusualSpending && avgExpense > 100) {\n      return `Spending Alert: Detected ${highSpending.length} large expenses ($${Math.round(avgExpense * 2)}+) recently. Review your budget to avoid overspending.`;\n    }\n    \n    if (topCategory && topCategory[1] > context.monthlyIncome * 0.3) {\n      return `Budget Tip: ${topCategory[0]} is ${((topCategory[1] / context.monthlyIncome) * 100).toFixed(0)}% of income. Try the 50/30/20 rule: 50% needs, 30% wants, 20% savings.`;\n    }\n    \n    // PRIORITY 4: Growth & Optimization\n    if (savingsRate > 30 && context.totalSavings > emergencyFundTarget) {\n      return `Investment Ready: ${savingsRate.toFixed(0)}% savings rate + full emergency fund = time to invest. Consider VTI/VOO index funds for long-term growth.`;\n    }\n    \n    if (savingsRate >= 20 && savingsRate <= 30) {\n      return `Great job. ${savingsRate.toFixed(0)}% savings rate is excellent. Next level: Max out tax-advantaged accounts (401k/Roth IRA) for compound growth.`;\n    }\n    \n    // PRIORITY 5: Goal Motivation\n    if (context.activeGoals === 0 && context.totalSavings > 0) {\n      return `Set Your Vision: You have $${context.totalSavings.toLocaleString()} saved with no goals. Create 1-2 specific goals to turn savings into achievements.`;\n    }\n    \n    if (context.activeGoals >= 3) {\n      return `Goal Achiever: ${context.activeGoals} active goals shows commitment. Focus on one at a time for faster results - snowball effect works.`;\n    }\n\n    // Use AI for complex insights\n    const cacheKey = `insight_${savingsRate.toFixed(0)}_${context.activeGoals}`;\n    const cached = responseCache.get(cacheKey, context);\n    if (cached) {\n      return cached;\n    }\n\n    const insightPrompt = `Based on: ${savingsRate.toFixed(1)}% savings rate, $${context.totalSavings} saved, ${context.activeGoals} active goals. Provide one specific, actionable financial tip in 25 words or less.`;\n\n    try {\n      const response = await groq.chat.completions.create({\n        model: \"meta-llama/llama-4-scout-17b-16e-instruct\",\n        messages: [\n          { role: \"system\", content: \"You are a financial advisor. Give concise, actionable advice.\" },\n          { role: \"user\", content: insightPrompt }\n        ],\n        temperature: 0.7,\n        max_tokens: 100\n      });\n      \n      const text = response.choices[0]?.message?.content || 'Keep up the great work with your financial management!';\n      \n      // Cache insight\n      responseCache.set(cacheKey, context, text, this.estimateTokenCount(insightPrompt + text));\n      return text;\n    } catch (error) {\n      console.error('[AI Service] Proactive insight error:', error);\n      return 'Focus on tracking your spending patterns this week.';\n    }\n  }\n\n  // Cost monitoring and reporting\n  getCostStats(): { cacheStats: any; estimatedSavings: string } {\n    const cacheStats = responseCache.getStats();\n    const estimatedSavings = `${(cacheStats.hitRate * 100).toFixed(1)}% cache hit rate`;\n    \n    return {\n      cacheStats,\n      estimatedSavings\n    };\n  }\n}\n\nexport const aiService = new TwealthAIService();\n","path":null,"size_bytes":97319,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from\"clsx\"\nimport { twMerge } from\"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":163,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from\"react\"\nimport { Slot } from\"@radix-ui/react-slot\"\nimport { VariantProps, cva } from\"class-variance-authority\"\nimport { PanelLeft } from\"lucide-react\"\n\nimport { useIsMobile } from\"@/hooks/use-mobile\"\nimport { cn } from\"@/lib/utils\"\nimport { Button } from\"@/components/ui/button\"\nimport { Input } from\"@/components/ui/input\"\nimport { Separator } from\"@/components/ui/separator\"\nimport {\n Sheet,\n SheetContent,\n SheetDescription,\n SheetHeader,\n SheetTitle,\n} from\"@/components/ui/sheet\"\nimport { Skeleton } from\"@/components/ui/skeleton\"\nimport {\n Tooltip,\n TooltipContent,\n TooltipProvider,\n TooltipTrigger,\n} from\"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME =\"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH =\"16rem\"\nconst SIDEBAR_WIDTH_MOBILE =\"18rem\"\nconst SIDEBAR_WIDTH_ICON =\"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT =\"b\"\n\ntype SidebarContextProps = {\n state:\"expanded\" |\"collapsed\"\n open: boolean\n setOpen: (open: boolean) => void\n openMobile: boolean\n setOpenMobile: (open: boolean) => void\n isMobile: boolean\n toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n const context = React.useContext(SidebarContext)\n if (!context) {\n  throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n }\n\n return context\n}\n\nconst SidebarProvider = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n }\n>(\n (\n  {\n   defaultOpen = true,\n   open: openProp,\n   onOpenChange: setOpenProp,\n   className,\n   style,\n   children,\n   ...props\n  },\n  ref\n ) => {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n   (value: boolean | ((value: boolean) => boolean)) => {\n    const openState = typeof value ===\"function\" ? value(open) : value\n    if (setOpenProp) {\n     setOpenProp(openState)\n    } else {\n     _setOpen(openState)\n    }\n\n    // This sets the cookie to keep the sidebar state.\n    document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n   },\n   [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n   return isMobile\n    ? setOpenMobile((open) => !open)\n    : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n   const handleKeyDown = (event: KeyboardEvent) => {\n    if (\n     event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n     (event.metaKey || event.ctrlKey)\n    ) {\n     event.preventDefault()\n     toggleSidebar()\n    }\n   }\n\n   window.addEventListener(\"keydown\", handleKeyDown)\n   return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or\"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ?\"expanded\" :\"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n   () => ({\n    state,\n    open,\n    setOpen,\n    isMobile,\n    openMobile,\n    setOpenMobile,\n    toggleSidebar,\n   }),\n   [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n   <SidebarContext.Provider value={contextValue}>\n    <TooltipProvider delayDuration={0}>\n     <div\n      style={\n       {\n       \"--sidebar-width\": SIDEBAR_WIDTH,\n       \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n        ...style,\n       } as React.CSSProperties\n      }\n      className={cn(\n      \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n       className\n      )}\n      ref={ref}\n      {...props}\n     >\n      {children}\n     </div>\n    </TooltipProvider>\n   </SidebarContext.Provider>\n  )\n }\n)\nSidebarProvider.displayName =\"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> & {\n  side?:\"left\" |\"right\"\n  variant?:\"sidebar\" |\"floating\" |\"inset\"\n  collapsible?:\"offcanvas\" |\"icon\" |\"none\"\n }\n>(\n (\n  {\n   side =\"left\",\n   variant =\"sidebar\",\n   collapsible =\"offcanvas\",\n   className,\n   children,\n   ...props\n  },\n  ref\n ) => {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible ===\"none\") {\n   return (\n    <div\n     className={cn(\n     \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n      className\n     )}\n     ref={ref}\n     {...props}\n    >\n     {children}\n    </div>\n   )\n  }\n\n  if (isMobile) {\n   return (\n    <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n     <SheetContent\n      data-sidebar=\"sidebar\"\n      data-mobile=\"true\"\n      className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n      style={\n       {\n       \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n       } as React.CSSProperties\n      }\n      side={side}\n     >\n      <SheetHeader className=\"sr-only\">\n       <SheetTitle>Sidebar</SheetTitle>\n       <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n      </SheetHeader>\n      <div className=\"flex h-full w-full flex-col\">{children}</div>\n     </SheetContent>\n    </Sheet>\n   )\n  }\n\n  return (\n   <div\n    ref={ref}\n    className=\"group peer hidden text-sidebar-foreground md:block\"\n    data-state={state}\n    data-collapsible={state ===\"collapsed\" ? collapsible :\"\"}\n    data-variant={variant}\n    data-side={side}\n   >\n    {/* This is what handles the sidebar gap on desktop */}\n    <div\n     className={cn(\n     \"relative w-[--sidebar-width] bg-transparent transition-[width] ease-linear\",\n     \"group-data-[collapsible=offcanvas]:w-0\",\n     \"group-data-[side=right]:rotate-180\",\n      variant ===\"floating\" || variant ===\"inset\"\n       ?\"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n       :\"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n     )}\n    />\n    <div\n     className={cn(\n     \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex\",\n      side ===\"left\"\n       ?\"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n       :\"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n      // Adjust the padding for floating and inset variants.\n      variant ===\"floating\" || variant ===\"inset\"\n       ?\"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n       :\"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n      className\n     )}\n     {...props}\n    >\n     <div\n      data-sidebar=\"sidebar\"\n      className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n     >\n      {children}\n     </div>\n    </div>\n   </div>\n  )\n }\n)\nSidebar.displayName =\"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n React.ElementRef<typeof Button>,\n React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n const { toggleSidebar } = useSidebar()\n\n return (\n  <Button\n   ref={ref}\n   data-sidebar=\"trigger\"\n   variant=\"ghost\"\n   size=\"icon\"\n   className={cn(\"h-7 w-7\", className)}\n   onClick={(event) => {\n    onClick?.(event)\n    toggleSidebar()\n   }}\n   {...props}\n  >\n   <PanelLeft />\n   <span className=\"sr-only\">Toggle Sidebar</span>\n  </Button>\n )\n})\nSidebarTrigger.displayName =\"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n const { toggleSidebar } = useSidebar()\n\n return (\n  <button\n   ref={ref}\n   data-sidebar=\"rail\"\n   aria-label=\"Toggle Sidebar\"\n   tabIndex={-1}\n   onClick={toggleSidebar}\n   title=\"Toggle Sidebar\"\n   className={cn(\n   \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n   \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n   \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n   \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n   \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n   \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarRail.displayName =\"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n return (\n  <main\n   ref={ref}\n   className={cn(\n   \"relative flex w-full flex-1 flex-col bg-background\",\n   \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarInset.displayName =\"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n React.ElementRef<typeof Input>,\n React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n return (\n  <Input\n   ref={ref}\n   data-sidebar=\"input\"\n   className={cn(\n   \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarInput.displayName =\"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n return (\n  <div\n   ref={ref}\n   data-sidebar=\"header\"\n   className={cn(\"flex flex-col gap-2 p-2\", className)}\n   {...props}\n  />\n )\n})\nSidebarHeader.displayName =\"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n return (\n  <div\n   ref={ref}\n   data-sidebar=\"footer\"\n   className={cn(\"flex flex-col gap-2 p-2\", className)}\n   {...props}\n  />\n )\n})\nSidebarFooter.displayName =\"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n React.ElementRef<typeof Separator>,\n React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n return (\n  <Separator\n   ref={ref}\n   data-sidebar=\"separator\"\n   className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n   {...props}\n  />\n )\n})\nSidebarSeparator.displayName =\"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n return (\n  <div\n   ref={ref}\n   data-sidebar=\"content\"\n   className={cn(\n   \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarContent.displayName =\"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n return (\n  <div\n   ref={ref}\n   data-sidebar=\"group\"\n   className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n   {...props}\n  />\n )\n})\nSidebarGroup.displayName =\"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n const Comp = asChild ? Slot :\"div\"\n\n return (\n  <Comp\n   ref={ref}\n   data-sidebar=\"group-label\"\n   className={cn(\n   \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n   \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarGroupLabel.displayName =\"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n const Comp = asChild ? Slot :\"button\"\n\n return (\n  <Comp\n   ref={ref}\n   data-sidebar=\"group-action\"\n   className={cn(\n   \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n    // Increases the hit area of the button on mobile.\n   \"after:absolute after:-inset-2 after:md:hidden\",\n   \"group-data-[collapsible=icon]:hidden\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarGroupAction.displayName =\"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  data-sidebar=\"group-content\"\n  className={cn(\"w-full text-sm\", className)}\n  {...props}\n />\n))\nSidebarGroupContent.displayName =\"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n HTMLUListElement,\n React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n <ul\n  ref={ref}\n  data-sidebar=\"menu\"\n  className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n  {...props}\n />\n))\nSidebarMenu.displayName =\"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n HTMLLIElement,\n React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n <li\n  ref={ref}\n  data-sidebar=\"menu-item\"\n  className={cn(\"group/menu-item relative\", className)}\n  {...props}\n />\n))\nSidebarMenuItem.displayName =\"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n\"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n {\n  variants: {\n   variant: {\n    default:\"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n    outline:\n    \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n   },\n   size: {\n    default:\"h-8 text-sm\",\n    sm:\"h-7 text-xs\",\n    lg:\"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n   size:\"default\",\n  },\n }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n (\n  {\n   asChild = false,\n   isActive = false,\n   variant =\"default\",\n   size =\"default\",\n   tooltip,\n   className,\n   ...props\n  },\n  ref\n ) => {\n  const Comp = asChild ? Slot :\"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n   <Comp\n    ref={ref}\n    data-sidebar=\"menu-button\"\n    data-size={size}\n    data-active={isActive}\n    className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n    {...props}\n   />\n  )\n\n  if (!tooltip) {\n   return button\n  }\n\n  if (typeof tooltip ===\"string\") {\n   tooltip = {\n    children: tooltip,\n   }\n  }\n\n  return (\n   <Tooltip>\n    <TooltipTrigger asChild>{button}</TooltipTrigger>\n    <TooltipContent\n     side=\"right\"\n     align=\"center\"\n     hidden={state !==\"collapsed\" || isMobile}\n     {...tooltip}\n    />\n   </Tooltip>\n  )\n }\n)\nSidebarMenuButton.displayName =\"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n const Comp = asChild ? Slot :\"button\"\n\n return (\n  <Comp\n   ref={ref}\n   data-sidebar=\"menu-action\"\n   className={cn(\n   \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n    // Increases the hit area of the button on mobile.\n   \"after:absolute after:-inset-2 after:md:hidden\",\n   \"peer-data-[size=sm]/menu-button:top-1\",\n   \"peer-data-[size=default]/menu-button:top-1.5\",\n   \"peer-data-[size=lg]/menu-button:top-2.5\",\n   \"group-data-[collapsible=icon]:hidden\",\n    showOnHover &&\n    \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarMenuAction.displayName =\"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  data-sidebar=\"menu-badge\"\n  className={cn(\n  \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n  \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n  \"peer-data-[size=sm]/menu-button:top-1\",\n  \"peer-data-[size=default]/menu-button:top-1.5\",\n  \"peer-data-[size=lg]/menu-button:top-2.5\",\n  \"group-data-[collapsible=icon]:hidden\",\n   className\n  )}\n  {...props}\n />\n))\nSidebarMenuBadge.displayName =\"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n }\n>(({ className, showIcon = false, ...props }, ref) => {\n // Random width between 50 to 90%.\n const width = React.useMemo(() => {\n  return `${Math.floor(Math.random() * 40) + 50}%`\n }, [])\n\n return (\n  <div\n   ref={ref}\n   data-sidebar=\"menu-skeleton\"\n   className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n   {...props}\n  >\n   {showIcon && (\n    <Skeleton\n     className=\"size-4 rounded-md\"\n     data-sidebar=\"menu-skeleton-icon\"\n    />\n   )}\n   <Skeleton\n    className=\"h-4 max-w-[--skeleton-width] flex-1\"\n    data-sidebar=\"menu-skeleton-text\"\n    style={\n     {\n     \"--skeleton-width\": width,\n     } as React.CSSProperties\n    }\n   />\n  </div>\n )\n})\nSidebarMenuSkeleton.displayName =\"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n HTMLUListElement,\n React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n <ul\n  ref={ref}\n  data-sidebar=\"menu-sub\"\n  className={cn(\n  \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n  \"group-data-[collapsible=icon]:hidden\",\n   className\n  )}\n  {...props}\n />\n))\nSidebarMenuSub.displayName =\"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n HTMLLIElement,\n React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName =\"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n HTMLAnchorElement,\n React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?:\"sm\" |\"md\"\n  isActive?: boolean\n }\n>(({ asChild = false, size =\"md\", isActive, className, ...props }, ref) => {\n const Comp = asChild ? Slot :\"a\"\n\n return (\n  <Comp\n   ref={ref}\n   data-sidebar=\"menu-sub-button\"\n   data-size={size}\n   data-active={isActive}\n   className={cn(\n   \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n   \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n    size ===\"sm\" &&\"text-xs\",\n    size ===\"md\" &&\"text-sm\",\n   \"group-data-[collapsible=icon]:hidden\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nSidebarMenuSubButton.displayName =\"SidebarMenuSubButton\"\n\nexport {\n Sidebar,\n SidebarContent,\n SidebarFooter,\n SidebarGroup,\n SidebarGroupAction,\n SidebarGroupContent,\n SidebarGroupLabel,\n SidebarHeader,\n SidebarInput,\n SidebarInset,\n SidebarMenu,\n SidebarMenuAction,\n SidebarMenuBadge,\n SidebarMenuButton,\n SidebarMenuItem,\n SidebarMenuSkeleton,\n SidebarMenuSub,\n SidebarMenuSubButton,\n SidebarMenuSubItem,\n SidebarProvider,\n SidebarRail,\n SidebarSeparator,\n SidebarTrigger,\n useSidebar,\n}\n","path":null,"size_bytes":21648,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from\"react\"\nimport * as AccordionPrimitive from\"@radix-ui/react-accordion\"\nimport { ChevronDown } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n React.ElementRef<typeof AccordionPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n <AccordionPrimitive.Item\n  ref={ref}\n  className={cn(\"border-b\", className)}\n  {...props}\n />\n))\nAccordionItem.displayName =\"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n React.ElementRef<typeof AccordionPrimitive.Trigger>,\n React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n <AccordionPrimitive.Header className=\"flex\">\n  <AccordionPrimitive.Trigger\n   ref={ref}\n   className={cn(\n   \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n    className\n   )}\n   {...props}\n  >\n   {children}\n   <ChevronDown className=\"h-4 w-4 shrink-0\" />\n  </AccordionPrimitive.Trigger>\n </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n React.ElementRef<typeof AccordionPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n <AccordionPrimitive.Content\n  ref={ref}\n  className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n  {...props}\n >\n  <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1878,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from\"../../hooks/use-toast\"\nimport {\n Toast,\n ToastClose,\n ToastDescription,\n ToastProvider,\n ToastTitle,\n ToastViewport,\n} from\"./toast\"\n\nexport function Toaster() {\n const { toasts } = useToast()\n\n return (\n  <ToastProvider duration={5000}>\n   {toasts.map(function ({ id, title, description, action, icon, variant, ...props }) {\n    return (\n     <Toast key={id} variant={variant} {...props}>\n      <div className=\"grid gap-0.5 flex-1\">\n       {title && <ToastTitle>{title}</ToastTitle>}\n       {description && (\n        <ToastDescription>{description}</ToastDescription>\n       )}\n      </div>\n      {action}\n      <ToastClose />\n     </Toast>\n    )\n   })}\n   <ToastViewport />\n  </ToastProvider>\n )\n}\n","path":null,"size_bytes":725,"size_tokens":null},"client/src/pages/welcome.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { ProgressiveOnboardingWizard } from \"@/components/onboarding/progressive-onboarding-wizard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Check, Zap, Target, ArrowRight, Sparkles, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { getSupportedCurrencies } from \"@/lib/currency\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\n\nconst expressFormSchema = z.object({\n  fullName: z.string().min(1, \"Please enter your name\"),\n  currency: z.string().min(1, \"Please select your currency\"),\n});\n\ntype ExpressFormData = z.infer<typeof expressFormSchema>;\n\nfunction GradientMeshBackground() {\n  return (\n    <div className=\"absolute inset-0 overflow-hidden\" aria-hidden=\"true\">\n      <div className=\"absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950\" />\n      \n      <div \n        className=\"absolute inset-0 opacity-60\"\n        style={{\n          background: `\n            radial-gradient(ellipse 80% 50% at 20% 40%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),\n            radial-gradient(ellipse 60% 40% at 80% 60%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),\n            radial-gradient(ellipse 50% 30% at 40% 80%, rgba(37, 99, 235, 0.1) 0%, transparent 50%),\n            radial-gradient(ellipse 40% 50% at 70% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%)\n          `\n        }}\n      />\n      \n      <div \n        className=\"absolute top-0 left-0 w-full h-full opacity-30 motion-safe:animate-[meshFloat_20s_ease-in-out_infinite]\"\n        style={{\n          background: `\n            radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.2) 0%, transparent 25%),\n            radial-gradient(circle at 70% 80%, rgba(99, 102, 241, 0.15) 0%, transparent 25%)\n          `\n        }}\n      />\n      \n      <div className=\"absolute top-1/4 -left-20 w-80 h-80 bg-blue-600/8 rounded-full blur-3xl motion-safe:animate-[gentlePulse_8s_ease-in-out_infinite]\" />\n      <div className=\"absolute bottom-1/4 -right-20 w-80 h-80 bg-indigo-600/8 rounded-full blur-3xl motion-safe:animate-[gentlePulse_8s_ease-in-out_infinite_2s]\" />\n      <div className=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-r from-blue-600/5 to-indigo-600/5 rounded-full blur-3xl\" />\n      \n      <div \n        className=\"absolute inset-0 opacity-[0.02]\"\n        style={{\n          backgroundImage: `\n            linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),\n            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px)\n          `,\n          backgroundSize: '60px 60px'\n        }}\n      />\n    </div>\n  );\n}\n\n\nexport default function WelcomePage() {\n  const [, setLocation] = useLocation();\n  const [mode, setMode] = useState<'choice' | 'express' | 'full'>('choice');\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const expressForm = useForm<ExpressFormData>({\n    resolver: zodResolver(expressFormSchema),\n    defaultValues: {\n      fullName: \"\",\n      currency: \"USD\",\n    },\n  });\n\n  const savePreferencesMutation = useMutation({\n    mutationFn: async (data: { fullName: string; currency: string }) => {\n      return apiRequest(\"PUT\", \"/api/user-preferences\", {\n        onboardingData: {\n          fullName: data.fullName,\n        },\n        currency: data.currency,\n        hasCompletedOnboarding: true,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-preferences\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users/me\"] });\n      toast({\n        title: \"Welcome to Twealth!\",\n        description: \"Your preferences have been saved. Let's get started!\",\n      });\n      setLocation(\"/\");\n    },\n    onError: () => {\n      toast({\n        title: \"Something went wrong\",\n        description: \"Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOnboardingComplete = () => {\n    setLocation(\"/\");\n  };\n\n  const handleExpressSubmit = (data: ExpressFormData) => {\n    savePreferencesMutation.mutate(data);\n  };\n\n  const handleSelectExpress = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setMode('express');\n  };\n\n  const handleSelectFull = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setMode('full');\n  };\n\n  if (mode === 'express') {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative overflow-hidden\">\n        <GradientMeshBackground />\n        \n        <div className=\"w-full max-w-md mx-auto relative z-10\">\n          <div className=\"text-center mb-10\">\n            <div className=\"flex items-center justify-center gap-3 mb-6\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 bg-blue-500/30 blur-xl rounded-full scale-150 motion-safe:animate-[gentlePulse_4s_ease-in-out_infinite]\" />\n                <img src={logoUrl} alt=\"Twealth\" className=\"w-12 h-12 relative drop-shadow-[0_0_15px_rgba(59,130,246,0.3)]\" />\n              </div>\n              <span className=\"text-2xl font-semibold text-white tracking-tight\">Twealth</span>\n            </div>\n            <h1 className=\"text-3xl sm:text-4xl font-bold text-white mb-3 tracking-tight\">\n              Quick Setup\n            </h1>\n            <p className=\"text-slate-400 text-lg\">\n              Just two quick questions to get started\n            </p>\n          </div>\n\n          <div className=\"bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-8 backdrop-blur-sm\">\n            <Form {...expressForm}>\n              <form onSubmit={expressForm.handleSubmit(handleExpressSubmit)} className=\"space-y-6\">\n                <FormField\n                  control={expressForm.control}\n                  name=\"fullName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-slate-200\">What should we call you?</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"Enter your name\"\n                          className=\"bg-slate-800/50 border-slate-600 text-white placeholder:text-slate-500 h-12\"\n                          data-testid=\"input-name\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={expressForm.control}\n                  name=\"currency\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-slate-200\">Preferred currency</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger \n                            className=\"bg-slate-800/50 border-slate-600 text-white h-12\"\n                            data-testid=\"select-currency\"\n                          >\n                            <SelectValue placeholder=\"Select currency\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent className=\"bg-slate-800 border-slate-600 max-h-[300px]\">\n                          {getSupportedCurrencies().map((currency) => (\n                            <SelectItem \n                              key={currency.code} \n                              value={currency.code}\n                              className=\"text-white hover:bg-slate-700\"\n                            >\n                              {currency.code} - {currency.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  disabled={savePreferencesMutation.isPending}\n                  className=\"w-full h-14 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-2xl transition-all duration-300 shadow-lg shadow-blue-600/25 hover:shadow-xl hover:shadow-blue-500/30 text-base mt-4\"\n                  data-testid=\"button-submit-express\"\n                >\n                  {savePreferencesMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                      Setting up...\n                    </>\n                  ) : (\n                    <>\n                      Get Started\n                      <ArrowRight className=\"ml-2 h-5 w-5\" />\n                    </>\n                  )}\n                </Button>\n              </form>\n            </Form>\n          </div>\n\n          <div className=\"mt-8 text-center\">\n            <Button \n              variant=\"ghost\" \n              onClick={() => setMode('choice')}\n              className=\"text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all duration-200\"\n              data-testid=\"button-back-to-choice\"\n            >\n              Back to options\n            </Button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (mode === 'full') {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative overflow-hidden\">\n        <GradientMeshBackground />\n        \n        <div className=\"w-full max-w-3xl mx-auto relative z-10\">\n          <div className=\"text-center mb-10\">\n            <div className=\"flex items-center justify-center gap-3 mb-6\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 bg-blue-500/30 blur-xl rounded-full scale-150 motion-safe:animate-[gentlePulse_4s_ease-in-out_infinite]\" />\n                <img src={logoUrl} alt=\"Twealth\" className=\"w-12 h-12 relative drop-shadow-[0_0_15px_rgba(59,130,246,0.3)]\" />\n              </div>\n              <span className=\"text-2xl font-semibold text-white tracking-tight\">Twealth</span>\n            </div>\n            <h1 className=\"text-3xl sm:text-4xl font-bold text-white mb-3 tracking-tight\">\n              Let's personalize your experience\n            </h1>\n            <p className=\"text-slate-400 text-lg\">\n              This will only take a minute\n            </p>\n          </div>\n          <ProgressiveOnboardingWizard onComplete={handleOnboardingComplete} />\n          <div className=\"mt-8 text-center\">\n            <Button \n              variant=\"ghost\" \n              onClick={() => setMode('choice')}\n              className=\"text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all duration-200\"\n              data-testid=\"button-back-to-choice\"\n            >\n              Back to options\n            </Button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 sm:p-6 relative overflow-hidden\">\n      <GradientMeshBackground />\n      \n      <div className=\"w-full max-w-4xl mx-auto relative z-10\">\n        <div className=\"text-center mb-12 sm:mb-16\">\n          <div className=\"flex items-center justify-center gap-3 mb-8\">\n            <div className=\"relative group\">\n              <div className=\"absolute inset-0 bg-blue-500/40 blur-xl rounded-full scale-150 motion-safe:animate-[gentlePulse_4s_ease-in-out_infinite]\" />\n              <div className=\"absolute inset-0 bg-indigo-500/20 blur-2xl rounded-full scale-200 motion-safe:animate-[gentlePulse_6s_ease-in-out_infinite_1s]\" />\n              <img src={logoUrl} alt=\"Twealth\" className=\"w-14 h-14 relative drop-shadow-[0_0_20px_rgba(59,130,246,0.4)]\" />\n            </div>\n            <span className=\"text-3xl font-semibold text-white tracking-tight drop-shadow-[0_0_30px_rgba(59,130,246,0.2)]\">Twealth</span>\n          </div>\n          <h1 className=\"text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-4 tracking-tight\">\n            <span className=\"bg-gradient-to-r from-white via-blue-100 to-white bg-clip-text text-transparent drop-shadow-[0_0_40px_rgba(59,130,246,0.3)]\">\n              Welcome to Twealth\n            </span>\n          </h1>\n          <p className=\"text-xl text-slate-400 max-w-md mx-auto\">\n            Choose how you'd like to get started\n          </p>\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-6 sm:gap-8\">\n          <div \n            className=\"relative group cursor-pointer pt-5\"\n            onClick={handleSelectExpress}\n            data-testid=\"card-express-start\"\n          >\n            <div className=\"absolute top-0 left-6 z-10\">\n              <span className=\"inline-flex items-center gap-1.5 px-4 py-1.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white text-xs font-semibold rounded-full shadow-lg shadow-blue-600/30 border border-blue-400/20\">\n                <Sparkles className=\"w-3.5 h-3.5\" />\n                Recommended\n              </span>\n            </div>\n            <div className=\"h-full bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-7 sm:p-9 pt-10 transition-all duration-300 group-hover:border-blue-500/70 group-hover:shadow-2xl group-hover:shadow-blue-500/20 group-hover:-translate-y-1 backdrop-blur-sm\">\n              <div className=\"flex items-center gap-4 mb-5\">\n                <div className=\"p-3 bg-gradient-to-br from-blue-600/20 to-blue-700/20 rounded-2xl border border-blue-500/20 shadow-inner\">\n                  <Zap className=\"h-7 w-7 text-blue-400\" />\n                </div>\n                <h3 className=\"text-2xl font-semibold text-white\">Express Start</h3>\n              </div>\n              <p className=\"text-slate-400 mb-7 text-base\">\n                Get started in seconds with smart defaults\n              </p>\n              <ul className=\"space-y-4 mb-9\">\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-blue-600/30 to-blue-700/20 flex items-center justify-center border border-blue-500/30\">\n                    <Check className=\"w-3.5 h-3.5 text-blue-400\" />\n                  </div>\n                  <span className=\"text-base\">Just name & currency</span>\n                </li>\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-blue-600/30 to-blue-700/20 flex items-center justify-center border border-blue-500/30\">\n                    <Check className=\"w-3.5 h-3.5 text-blue-400\" />\n                  </div>\n                  <span className=\"text-base\">AI learns as you use the app</span>\n                </li>\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-blue-600/30 to-blue-700/20 flex items-center justify-center border border-blue-500/30\">\n                    <Check className=\"w-3.5 h-3.5 text-blue-400\" />\n                  </div>\n                  <span className=\"text-base\">Customize anytime in settings</span>\n                </li>\n              </ul>\n              <Button \n                onClick={handleSelectExpress}\n                className=\"w-full h-14 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-2xl transition-all duration-300 shadow-lg shadow-blue-600/25 hover:shadow-xl hover:shadow-blue-500/30 text-base\"\n                data-testid=\"button-express-start\"\n              >\n                Start Now\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </div>\n          </div>\n\n          <div \n            className=\"relative group cursor-pointer pt-5\"\n            onClick={handleSelectFull}\n            data-testid=\"card-guided-setup\"\n          >\n            <div className=\"h-full bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-7 sm:p-9 pt-10 transition-all duration-300 group-hover:border-slate-500/70 group-hover:shadow-2xl group-hover:shadow-slate-500/10 group-hover:-translate-y-1 backdrop-blur-sm\">\n              <div className=\"flex items-center gap-4 mb-5\">\n                <div className=\"p-3 bg-gradient-to-br from-slate-700/50 to-slate-800/50 rounded-2xl border border-slate-600/30 shadow-inner\">\n                  <Target className=\"h-7 w-7 text-slate-300\" />\n                </div>\n                <h3 className=\"text-2xl font-semibold text-white\">Guided Setup</h3>\n              </div>\n              <p className=\"text-slate-400 mb-7 text-base\">\n                Personalize your experience step by step\n              </p>\n              <ul className=\"space-y-4 mb-9\">\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-slate-700/50 to-slate-800/30 flex items-center justify-center border border-slate-600/40\">\n                    <Check className=\"w-3.5 h-3.5 text-slate-400\" />\n                  </div>\n                  <span className=\"text-base\">Set your financial goals</span>\n                </li>\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-slate-700/50 to-slate-800/30 flex items-center justify-center border border-slate-600/40\">\n                    <Check className=\"w-3.5 h-3.5 text-slate-400\" />\n                  </div>\n                  <span className=\"text-base\">Configure AI preferences</span>\n                </li>\n                <li className=\"flex items-center gap-4 text-slate-200\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-slate-700/50 to-slate-800/30 flex items-center justify-center border border-slate-600/40\">\n                    <Check className=\"w-3.5 h-3.5 text-slate-400\" />\n                  </div>\n                  <span className=\"text-base\">Get tailored insights faster</span>\n                </li>\n              </ul>\n              <Button \n                onClick={handleSelectFull}\n                variant=\"outline\"\n                className=\"w-full h-14 bg-transparent border-2 border-slate-600 text-white hover:bg-slate-800/50 hover:border-slate-500 font-semibold rounded-2xl transition-all duration-300 text-base\"\n                data-testid=\"button-guided-setup\"\n              >\n                Customize Now\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-14 text-center\">\n          <p className=\"text-base text-slate-500\">\n            Join thousands of users building their financial future with AI\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19672,"size_tokens":null},"server/outlookClient.ts":{"content":"import { Client } from '@microsoft/microsoft-graph-client';\n\ninterface OutlookConnectionSettings {\n  settings: {\n    access_token?: string;\n    expires_at?: string;\n    oauth?: {\n      credentials?: {\n        access_token?: string;\n      };\n    };\n  };\n}\n\nlet connectionSettings: OutlookConnectionSettings | null = null;\n\nasync function getAccessToken(): Promise<string | null> {\n  try {\n    // Return cached token if still valid\n    if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n      const cachedToken = connectionSettings.settings.access_token;\n      if (cachedToken) {\n        return cachedToken;\n      }\n    }\n    \n    const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n    if (!hostname) {\n      throw new Error('REPLIT_CONNECTORS_HOSTNAME environment variable is not set');\n    }\n    \n    const xReplitToken = process.env.REPL_IDENTITY \n      ? 'repl ' + process.env.REPL_IDENTITY \n      : process.env.WEB_REPL_RENEWAL \n      ? 'depl ' + process.env.WEB_REPL_RENEWAL \n      : null;\n\n    if (!xReplitToken) {\n      throw new Error('Authentication token not found. REPL_IDENTITY or WEB_REPL_RENEWAL must be set');\n    }\n\n    const url = `https://${hostname}/api/v2/connection?include_secrets=true&connector_names=outlook`;\n    \n    const response = await fetch(url, {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Failed to fetch Outlook connection: ${response.status} ${response.statusText}`);\n    }\n\n    const data = await response.json();\n    connectionSettings = data.items?.[0];\n\n    // Return null if Outlook is not connected (expected state, not an error)\n    if (!connectionSettings) {\n      console.log('[OutlookClient] Outlook connection not found - user has not connected their account');\n      return null;\n    }\n\n    const accessToken = connectionSettings.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n    if (!accessToken) {\n      console.warn('[OutlookClient] Outlook access token not found in connection settings');\n      return null;\n    }\n    \n    return accessToken;\n  } catch (error) {\n    // Log error details for debugging with full stack trace\n    console.error('[OutlookClient] Error getting access token:', error);\n    \n    // Re-throw original error to preserve stack trace\n    throw error;\n  }\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\n// Always call this function again to get a fresh client.\n// Returns null if Outlook is not connected (expected state).\nexport async function getUncachableOutlookClient() {\n  try {\n    const accessToken = await getAccessToken();\n    \n    // Return null if user hasn't connected Outlook (not an error)\n    if (!accessToken) {\n      return null;\n    }\n\n    return Client.initWithMiddleware({\n      authProvider: {\n        getAccessToken: async () => accessToken\n      }\n    });\n  } catch (error) {\n    console.error('[OutlookClient] Error creating Outlook client:', error);\n    throw error; // Re-throw to preserve stack trace\n  }\n}\n","path":null,"size_bytes":3224,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from\"react\";\nimport { useQuery } from\"@tanstack/react-query\";\n\ntype Theme =\"light\" |\"dark\" |\"system\";\n\ntype ThemeProviderProps = {\n children: React.ReactNode;\n defaultTheme?: Theme;\n storageKey?: string;\n};\n\ntype ThemeProviderState = {\n theme: Theme;\n setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n theme:\"system\",\n setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n children,\n defaultTheme =\"system\",\n storageKey =\"twealth-theme\",\n ...props\n}: ThemeProviderProps) {\n const [theme, setTheme] = useState<Theme>(() => {\n  // Check localStorage first for immediate theme application\n  if (typeof window !==\"undefined\") {\n   const stored = localStorage.getItem(storageKey);\n   if (stored && [\"light\",\"dark\",\"system\"].includes(stored)) {\n    return stored as Theme;\n   }\n  }\n  return defaultTheme;\n });\n\n const [hasInitialized, setHasInitialized] = useState(false);\n\n // Fetch user preferences from API\n const { data: userPreferences } = useQuery<{ theme?: Theme }>({\n  queryKey: [\"/api/user-preferences\"],\n  staleTime: 5 * 60 * 1000, // Cache for 5 minutes\n });\n\n // Update theme when user preferences are loaded (only on initial load)\n useEffect(() => {\n  if (!hasInitialized && userPreferences?.theme) {\n   const storedTheme = typeof window !==\"undefined\" ? localStorage.getItem(storageKey) : null;\n   \n   // Only sync from API if localStorage doesn't have a value or if they match\n   if (!storedTheme || storedTheme === userPreferences.theme) {\n    setTheme(userPreferences.theme);\n    localStorage.setItem(storageKey, userPreferences.theme);\n   }\n   setHasInitialized(true);\n  }\n }, [userPreferences?.theme, hasInitialized, storageKey]);\n\n useEffect(() => {\n  const root = window.document.documentElement;\n  root.classList.remove(\"light\",\"dark\");\n\n  if (theme ===\"system\") {\n   const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n    .matches\n    ?\"dark\"\n    :\"light\";\n\n   root.classList.add(systemTheme);\n   return;\n  }\n\n  root.classList.add(theme);\n }, [theme]);\n\n // Listen for system theme changes when theme is set to\"system\"\n useEffect(() => {\n  if (theme !==\"system\") return;\n\n  const mediaQuery = window.matchMedia(\"(prefers-color-scheme: dark)\");\n  \n  const handleChange = () => {\n   const root = window.document.documentElement;\n   root.classList.remove(\"light\",\"dark\");\n   \n   const systemTheme = mediaQuery.matches ?\"dark\" :\"light\";\n   root.classList.add(systemTheme);\n  };\n\n  mediaQuery.addEventListener(\"change\", handleChange);\n  return () => mediaQuery.removeEventListener(\"change\", handleChange);\n }, [theme]);\n\n const value = {\n  theme,\n  setTheme: (newTheme: Theme) => {\n   localStorage.setItem(storageKey, newTheme);\n   setTheme(newTheme);\n  },\n };\n\n return (\n  <ThemeProviderContext.Provider {...props} value={value}>\n   {children}\n  </ThemeProviderContext.Provider>\n );\n}\n\nexport const useTheme = () => {\n const context = useContext(ThemeProviderContext);\n\n if (context === undefined)\n  throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n return context;\n};","path":null,"size_bytes":3191,"size_tokens":null},"client/src/components/money/smart-budget-management.tsx":{"content":"import { useState } from\"react\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport EmptyState from\"@/components/ui/empty-state\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from\"@/components/ui/dialog\";\nimport { Input } from\"@/components/ui/input\";\nimport { Label } from\"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from\"@/lib/queryClient\";\nimport { \n Target, \n PiggyBank,\n AlertTriangle, \n CheckCircle,\n Zap,\n Plus,\n Pencil,\n Trash2,\n TrendingUp,\n Brain,\n Award,\n Loader2\n} from\"lucide-react\";\nimport { format, startOfMonth, endOfMonth } from\"date-fns\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface SmartBudgetManagementProps {\n transactions: any[];\n timeRange: string;\n}\n\nconst availableCategories = [\n { value:\"dining\", label:\"Dining Out\" },\n { value:\"groceries\", label:\"Groceries\" },\n { value:\"transport\", label:\"Transportation\" },\n { value:\"utilities\", label:\"Utilities\" },\n { value:\"entertainment\", label:\"Entertainment\" },\n { value:\"shopping\", label:\"Shopping\" },\n { value:\"healthcare\", label:\"Healthcare\" },\n { value:\"education\", label:\"Education\" },\n { value:\"insurance\", label:\"Insurance\" },\n { value:\"rent\", label:\"Rent/Mortgage\" },\n { value:\"subscriptions\", label:\"Subscriptions\" },\n { value:\"other\", label:\"Other\" },\n];\n\nexport default function SmartBudgetManagement({ transactions, timeRange }: SmartBudgetManagementProps) {\n const { toast } = useToast();\n const { formatAmount } = useUserCurrency();\n const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\n const [editingBudget, setEditingBudget] = useState<any>(null);\n const [formData, setFormData] = useState({ category:\"\", monthlyLimit:\"\" });\n\n // Fetch budgets\n const { data: budgets = [], isLoading } = useQuery<any[]>({\n queryKey: [\"/api/budgets\"],\n });\n\n // Calculate current month spending by category\n const now = new Date();\n const monthStart = startOfMonth(now);\n const monthEnd = endOfMonth(now);\n \n const currentMonthTransactions = transactions.filter(t => {\n const tDate = new Date(t.date);\n return t.type === 'expense' && tDate >= monthStart && tDate <= monthEnd;\n });\n\n const categorySpending = currentMonthTransactions.reduce((acc: any, transaction) => {\n const category = (transaction.category || 'other').toLowerCase();\n acc[category] = (acc[category] || 0) + parseFloat(transaction.amount);\n return acc;\n }, {});\n\n // Merge budgets with spending\n const budgetData = budgets.map(budget => {\n const spent = categorySpending[budget.category] || 0;\n const limit = parseFloat(budget.monthlyLimit);\n const percentage = limit > 0 ? (spent / limit) * 100 : 0;\n const status = percentage > 100 ? 'over' : percentage > 80 ? 'warning' : 'good';\n \n return {\n ...budget,\n spent,\n limit,\n percentage,\n status,\n remaining: Math.max(0, limit - spent)\n };\n }).sort((a, b) => b.percentage - a.percentage);\n\n // Calculate totals\n const totalBudget = budgetData.reduce((sum, b) => sum + b.limit, 0);\n const totalSpent = budgetData.reduce((sum, b) => sum + b.spent, 0);\n const budgetUsedPercentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;\n\n // Mutations\n const createBudgetMutation = useMutation({\n mutationFn: async (data: any) => {\n return await apiRequest(\"POST\",\"/api/budgets\", data);\n },\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: [\"/api/budgets\"] });\n toast({ title:\"Budget Created\", description:\"Your budget has been added successfully.\" });\n setIsAddDialogOpen(false);\n setFormData({ category:\"\", monthlyLimit:\"\" });\n },\n onError: (error: any) => {\n toast({ title:\"Error\", description: error.message, variant:\"destructive\" });\n }\n });\n\n const updateBudgetMutation = useMutation({\n mutationFn: async ({ id, data }: any) => {\n return await apiRequest(\"PUT\", `/api/budgets/${id}`, data);\n },\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: [\"/api/budgets\"] });\n toast({ title:\"Budget Updated\", description:\"Your budget has been updated successfully.\" });\n setEditingBudget(null);\n },\n onError: (error: any) => {\n toast({ title:\"Error\", description: error.message, variant:\"destructive\" });\n }\n });\n\n const deleteBudgetMutation = useMutation({\n mutationFn: async (id: string) => {\n return await apiRequest(\"DELETE\", `/api/budgets/${id}`);\n },\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: [\"/api/budgets\"] });\n toast({ title:\"Budget Deleted\", description:\"Budget has been removed.\" });\n },\n onError: (error: any) => {\n toast({ title:\"Error\", description: error.message, variant:\"destructive\" });\n }\n });\n\n const handleSubmit = (e: React.FormEvent) => {\n e.preventDefault();\n \n // Validate form data\n if (!formData.category || !formData.monthlyLimit) {\n toast({ \n title:\"Validation Error\", \n description:\"Please fill in all fields\", \n variant:\"destructive\" \n });\n return;\n }\n \n if (editingBudget) {\n updateBudgetMutation.mutate({ id: editingBudget.id, data: { monthlyLimit: formData.monthlyLimit } });\n } else {\n createBudgetMutation.mutate(formData);\n }\n };\n\n const getStatusColor = (status: string) => {\n switch (status) {\n case 'over': return 'text-red-600';\n case 'warning': return 'text-yellow-600';\n default: return 'text-green-600';\n }\n };\n\n const getStatusBadge = (status: string) => {\n switch (status) {\n case 'over': return <Badge variant=\"destructive\">Over Budget</Badge>;\n case 'warning': return <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20\">Near Limit</Badge>;\n default: return <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900/20\">On Track</Badge>;\n }\n };\n\n const getCategoryLabel = (category: string) => {\n const cat = availableCategories.find(c => c.value === category);\n return cat ? cat.label : category.charAt(0).toUpperCase() + category.slice(1);\n };\n\n // Smart recommendations\n const recommendations = [];\n const overspent = budgetData.filter(b => b.status === 'over');\n if (overspent.length > 0) {\n recommendations.push({\n type: 'warning',\n title: 'Reduce Overspending',\n description: `Cut back on ${overspent[0].category} by ${formatAmount(overspent[0].spent - overspent[0].limit)}`,\n impact: `Get back on track this month`\n });\n }\n\n if (budgets.length === 0) {\n recommendations.push({\n type: 'opportunity',\n title: 'Start Budget Tracking',\n description: 'Create budgets for your top spending categories',\n impact: 'Take control of your finances'\n });\n }\n\n const onTrack = budgetData.filter(b => b.status === 'good').length;\n const totalCategories = budgetData.length;\n\n return (\n <div className=\"space-y-6\">\n {/* Budget Overview */}\n <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n <Card className=\"p-6\">\n <div className=\"flex items-center justify-between\">\n <div>\n <p className=\"text-sm text-muted-foreground\">Total Budget</p>\n <p className=\"text-2xl font-bold text-blue-600\">\n {formatAmount(totalBudget)}\n </p>\n <p className=\"text-xs text-muted-foreground mt-1\">\n {budgets.length} {budgets.length === 1 ? 'category' : 'categories'}\n </p>\n </div>\n <div className=\"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center\">\n <Target className=\"text-blue-600\" size={24} />\n </div>\n </div>\n </Card>\n\n <Card className=\"p-6\">\n <div className=\"flex items-center justify-between\">\n <div>\n <p className=\"text-sm text-muted-foreground\">Budget Used</p>\n <p className=\"text-2xl font-bold text-orange-600\">\n {budgetUsedPercentage.toFixed(0)}%\n </p>\n <p className=\"text-xs text-muted-foreground mt-1\">\n {formatAmount(totalSpent)} spent\n </p>\n </div>\n <div className=\"w-12 h-12 bg-orange-100 dark:bg-orange-900/20 rounded-lg flex items-center justify-center\">\n <TrendingUp className=\"text-orange-600\" size={24} />\n </div>\n </div>\n </Card>\n\n <Card className=\"p-6\">\n <div className=\"flex items-center justify-between\">\n <div>\n <p className=\"text-sm text-muted-foreground\">Remaining</p>\n <p className=\"text-2xl font-bold text-green-600\">\n {formatAmount(totalBudget - totalSpent)}\n </p>\n <p className=\"text-xs text-muted-foreground mt-1\">\n for this month\n </p>\n </div>\n <div className=\"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center\">\n <PiggyBank className=\"text-green-600\" size={24} />\n </div>\n </div>\n </Card>\n </div>\n\n {/* Budgets List */}\n <Card className=\"p-6\">\n <CardHeader className=\"px-0 pt-0 flex flex-row items-center justify-between\">\n <CardTitle className=\"flex items-center\">\n <Brain className=\"mr-2\" size={20} />\n Your Budgets\n </CardTitle>\n <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n <DialogTrigger asChild>\n <Button size=\"sm\" data-testid=\"button-add-budget\">\n <Plus className=\"mr-1\" size={16} />\n Add Budget\n </Button>\n </DialogTrigger>\n <DialogContent>\n <DialogHeader>\n <DialogTitle>Create Budget</DialogTitle>\n </DialogHeader>\n <form onSubmit={handleSubmit} className=\"space-y-4\">\n <div>\n <Label htmlFor=\"budget-category\">Category</Label>\n <Select value={formData.category} onValueChange={(value) => setFormData({...formData, category: value})} required>\n <SelectTrigger id=\"budget-category\" data-testid=\"select-budget-category\">\n <SelectValue placeholder=\"Select category\" />\n </SelectTrigger>\n <SelectContent>\n {availableCategories.map(cat => (\n <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n ))}\n </SelectContent>\n </Select>\n </div>\n <div>\n <Label htmlFor=\"budget-limit\">Monthly Limit ($)</Label>\n <Input\n id=\"budget-limit\"\n type=\"number\"\n step=\"0.01\"\n min=\"0\"\n placeholder=\"500.00\"\n value={formData.monthlyLimit}\n onChange={(e) => setFormData({...formData, monthlyLimit: e.target.value})}\n data-testid=\"input-budget-limit\"\n required\n />\n </div>\n <Button type=\"submit\" disabled={createBudgetMutation.isPending} data-testid=\"button-submit-budget\">\n {createBudgetMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4\" />}\n {createBudgetMutation.isPending ?\"Creating...\" :\"Create Budget\"}\n </Button>\n </form>\n </DialogContent>\n </Dialog>\n </CardHeader>\n <CardContent className=\"px-0\">\n {isLoading ? (\n <p className=\"text-muted-foreground\">Loading budgets...</p>\n ) : budgetData.length === 0 ? (\n <EmptyState\n  illustration=\"budgets\"\n  title=\"No Budgets Created Yet\"\n  description=\"Set up your first budget to track spending and stay on top of your finances.\"\n  actionLabel=\"Create Your First Budget\"\n  onAction={() => setIsAddDialogOpen(true)}\n  actionTestId=\"button-create-first-budget\"\n />\n ) : (\n <div className=\"space-y-4\">\n {budgetData.map((budget) => (\n <div key={budget.id} className=\"space-y-2 p-4 rounded-lg border border-transparent hover:border-border hover:bg-muted/50 hover:shadow-md\">\n <div className=\"flex items-center justify-between\">\n <div className=\"flex items-center flex-1\">\n <div className=\"flex-1\">\n <p className=\"font-medium\">{getCategoryLabel(budget.category)}</p>\n <p className=\"text-xs text-muted-foreground\">\n {formatAmount(budget.spent)} of {formatAmount(budget.limit)}\n </p>\n </div>\n </div>\n <div className=\"flex items-center gap-3\">\n <div className=\"text-right mr-2\">\n <p className={`font-bold ${getStatusColor(budget.status)}`}>\n {budget.percentage.toFixed(0)}%\n </p>\n {getStatusBadge(budget.status)}\n </div>\n <Button\n variant=\"ghost\"\n size=\"icon\"\n onClick={() => {\n setEditingBudget(budget);\n setFormData({ category: budget.category, monthlyLimit: budget.monthlyLimit });\n }}\n data-testid={`button-edit-budget-${budget.id}`}\n >\n <Pencil size={16} />\n </Button>\n <Button\n variant=\"ghost\"\n size=\"icon\"\n onClick={() => deleteBudgetMutation.mutate(budget.id)}\n data-testid={`button-delete-budget-${budget.id}`}\n >\n <Trash2 size={16} className=\"text-red-600\" />\n </Button>\n </div>\n </div>\n <Progress value={Math.min(budget.percentage, 100)} className=\"h-2\" />\n {budget.status === 'good' && budget.remaining > 0 && (\n <p className=\"text-xs text-green-600\">\n {formatAmount(budget.remaining)} remaining this month\n </p>\n )}\n {budget.status === 'over' && (\n <p className=\"text-xs text-red-600\">\n Over budget by {formatAmount(budget.spent - budget.limit)}\n </p>\n )}\n </div>\n ))}\n </div>\n )}\n </CardContent>\n </Card>\n\n {/* Edit Budget Dialog */}\n {editingBudget && (\n <Dialog open={!!editingBudget} onOpenChange={() => setEditingBudget(null)}>\n <DialogContent>\n <DialogHeader>\n <DialogTitle>Edit Budget - {getCategoryLabel(editingBudget.category)}</DialogTitle>\n </DialogHeader>\n <form onSubmit={handleSubmit} className=\"space-y-4\">\n <div>\n <Label>Monthly Limit</Label>\n <Input\n type=\"number\"\n step=\"0.01\"\n value={formData.monthlyLimit}\n onChange={(e) => setFormData({...formData, monthlyLimit: e.target.value})}\n data-testid=\"input-edit-budget-limit\"\n />\n </div>\n <Button type=\"submit\" disabled={updateBudgetMutation.isPending} data-testid=\"button-update-budget\">\n {updateBudgetMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4\" />}\n {updateBudgetMutation.isPending ?\"Updating...\" :\"Update Budget\"}\n </Button>\n </form>\n </DialogContent>\n </Dialog>\n )}\n\n {/* Smart Recommendations */}\n {recommendations.length > 0 && (\n <Card className=\"p-6\">\n <CardHeader className=\"px-0 pt-0\">\n <CardTitle className=\"flex items-center\">\n <Zap className=\"mr-2\" size={20} />\n Smart Recommendations\n </CardTitle>\n </CardHeader>\n <CardContent className=\"px-0\">\n <div className=\"space-y-4\">\n {recommendations.map((rec, index) => (\n <div key={index} className=\"flex items-start p-4 bg-muted/30 rounded-lg\">\n <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${\n rec.type === 'warning' ? 'bg-red-100 dark:bg-red-900/20' :\n rec.type === 'opportunity' ? 'bg-green-100 dark:bg-green-900/20' :\n 'bg-blue-100 dark:bg-blue-900/20'\n }`}>\n {rec.type === 'warning' ? (\n <AlertTriangle className=\"text-red-600\" size={20} />\n ) : rec.type === 'opportunity' ? (\n <TrendingUp className=\"text-green-600\" size={20} />\n ) : (\n <Award className=\"text-blue-600\" size={20} />\n )}\n </div>\n <div>\n <h4 className=\"font-semibold\">{rec.title}</h4>\n <p className=\"text-sm text-muted-foreground\">{rec.description}</p>\n <p className=\"text-xs text-green-600 font-medium mt-1\">{rec.impact}</p>\n </div>\n </div>\n ))}\n </div>\n </CardContent>\n </Card>\n )}\n\n {/* Budget Health */}\n {budgetData.length > 0 && (\n <Card className=\"p-6\">\n <CardHeader className=\"px-0 pt-0\">\n <CardTitle className=\"flex items-center\">\n <CheckCircle className=\"mr-2\" size={20} />\n Budget Performance\n </CardTitle>\n </CardHeader>\n <CardContent className=\"px-0\">\n <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n <div className=\"text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n <div className=\"text-3xl font-bold text-green-600\">\n {totalCategories > 0 ? Math.round((onTrack / totalCategories) * 100) : 0}%\n </div>\n <p className=\"text-sm text-muted-foreground\">On Track</p>\n <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900/20 mt-2\">\n {onTrack}/{totalCategories} Categories\n </Badge>\n </div>\n \n <div className=\"text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n <div className=\"text-3xl font-bold text-blue-600\">{totalCategories}</div>\n <p className=\"text-sm text-muted-foreground\">Active Budgets</p>\n <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900/20 mt-2\">\n Tracking\n </Badge>\n </div>\n \n <div className=\"text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n <div className=\"text-3xl font-bold text-blue-600\">\n {formatAmount(totalBudget - totalSpent > 0 ? totalBudget - totalSpent : 0)}\n </div>\n <p className=\"text-sm text-muted-foreground\">Left to Spend</p>\n <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900/20 mt-2\">\n This Month\n </Badge>\n </div>\n </div>\n </CardContent>\n </Card>\n )}\n </div>\n );\n}\n","path":null,"size_bytes":15948,"size_tokens":null},"client/src/lib/currency.ts":{"content":"// Currency conversion and formatting utilities for Twealth\n\nexport interface Currency {\n code: string;\n name: string;\n symbol: string;\n decimals: number;\n}\n\nexport const CURRENCIES: Record<string, Currency> = {\n USD: { code: 'USD', name: 'US Dollar', symbol: '$', decimals: 2 },\n THB: { code: 'THB', name: 'Thai Baht', symbol: '฿', decimals: 2 },\n EUR: { code: 'EUR', name: 'Euro', symbol: '€', decimals: 2 },\n IDR: { code: 'IDR', name: 'Indonesian Rupiah', symbol: 'Rp', decimals: 0 },\n INR: { code: 'INR', name: 'Indian Rupee', symbol: '₹', decimals: 2 },\n BRL: { code: 'BRL', name: 'Brazilian Real', symbol: 'R$', decimals: 2 },\n MXN: { code: 'MXN', name: 'Mexican Peso', symbol: '$', decimals: 2 },\n GBP: { code: 'GBP', name: 'British Pound', symbol: '£', decimals: 2 },\n JPY: { code: 'JPY', name: 'Japanese Yen', symbol: '¥', decimals: 0 },\n CAD: { code: 'CAD', name: 'Canadian Dollar', symbol: 'C$', decimals: 2 },\n AUD: { code: 'AUD', name: 'Australian Dollar', symbol: 'A$', decimals: 2 },\n VND: { code: 'VND', name: 'Vietnamese Dong', symbol: '₫', decimals: 0 },\n PHP: { code: 'PHP', name: 'Philippine Peso', symbol: '₱', decimals: 2 },\n MYR: { code: 'MYR', name: 'Malaysian Ringgit', symbol: 'RM', decimals: 2 },\n TRY: { code: 'TRY', name: 'Turkish Lira', symbol: '₺', decimals: 2 },\n SAR: { code: 'SAR', name: 'Saudi Riyal', symbol: '﷼', decimals: 2 },\n};\n\n// Exchange rates - fetched from backend API with fallback to static rates\nlet EXCHANGE_RATES: Record<string, number> = {\n USD: 1.00,\n THB: 33.50,\n EUR: 0.85,\n IDR: 15200,\n INR: 83.10,\n BRL: 5.20,\n MXN: 18.00,\n GBP: 0.78,\n JPY: 150.00,\n CAD: 1.35,\n AUD: 1.50,\n VND: 24000,\n PHP: 56.00,\n MYR: 4.65,\n TRY: 29.50,\n SAR: 3.75,\n};\n\nlet ratesLastFetched = 0;\nlet usingLiveRates = false;\nconst RATES_FETCH_INTERVAL = 60 * 60 * 1000; // Fetch every hour\n\n/**\n * Fetch live exchange rates from backend API\n * @returns Promise that resolves when rates are updated\n */\nexport async function fetchLiveExchangeRates(): Promise<void> {\n // Skip if rates were fetched recently\n if (Date.now() - ratesLastFetched < RATES_FETCH_INTERVAL) {\n  return;\n }\n\n try {\n  const response = await fetch('/api/currency/rates');\n  if (response.ok) {\n   const data = await response.json();\n   EXCHANGE_RATES = data.rates;\n   ratesLastFetched = Date.now();\n   usingLiveRates = true;\n   console.log('Exchange rates updated:', data.lastUpdated);\n  }\n } catch (error) {\n  usingLiveRates = false;\n  console.warn('Failed to fetch live exchange rates, using estimates');\n }\n}\n\n/**\n * Check if we're using live exchange rates or estimated fallbacks\n * @returns boolean indicating if live rates are being used\n */\nexport function isUsingLiveRates(): boolean {\n return usingLiveRates;\n}\n\n// Auto-fetch rates on module load\nfetchLiveExchangeRates();\n\n/**\n * Convert amount from one currency to another\n * @param amount Amount in source currency\n * @param fromCurrency Source currency code\n * @param toCurrency Target currency code\n * @returns Converted amount\n */\nexport function convertCurrency(\n amount: number,\n fromCurrency: string,\n toCurrency: string\n): number {\n if (fromCurrency === toCurrency) return amount;\n \n // Convert to USD first, then to target currency\n const usdAmount = amount / EXCHANGE_RATES[fromCurrency];\n const convertedAmount = usdAmount * EXCHANGE_RATES[toCurrency];\n \n return convertedAmount;\n}\n\n/**\n * Format currency amount with proper symbol and decimals\n * @param amount Amount to format\n * @param currencyCode Currency code\n * @param options Formatting options\n * @returns Formatted currency string\n */\nexport function formatCurrency(\n amount: number,\n currencyCode: string = 'USD',\n options: {\n  showSymbol?: boolean;\n  compact?: boolean;\n  locale?: string;\n } = {}\n): string {\n const {\n  showSymbol = true,\n  compact = false,\n  locale = 'en-US'\n } = options;\n\n const currency = CURRENCIES[currencyCode];\n if (!currency) {\n  console.warn(`Unknown currency code: ${currencyCode}`);\n  return amount.toString();\n }\n\n // Use Intl.NumberFormat for proper localization\n const formatter = new Intl.NumberFormat(locale, {\n  style: 'currency',\n  currency: currencyCode,\n  minimumFractionDigits: currency.decimals,\n  maximumFractionDigits: currency.decimals,\n  notation: compact ? 'compact' : 'standard',\n });\n\n if (showSymbol) {\n  return formatter.format(amount);\n } else {\n  // Return without currency symbol\n  const formatted = formatter.format(amount);\n  return formatted.replace(/[^\\d.,\\s-]/g, '').trim();\n }\n}\n\n/**\n * Get localized pricing for different markets\n * @param baseAmountUSD Base price in USD\n * @param targetCurrency Target currency\n * @returns Localized price object\n */\nexport function getLocalizedPrice(\n baseAmountUSD: number,\n targetCurrency: string\n): {\n amount: number;\n formatted: string;\n currency: Currency;\n isDiscounted: boolean;\n originalAmount?: number;\n} {\n const currency = CURRENCIES[targetCurrency];\n if (!currency) {\n  throw new Error(`Unsupported currency: ${targetCurrency}`);\n }\n\n let convertedAmount = convertCurrency(baseAmountUSD, 'USD', targetCurrency);\n let isDiscounted = false;\n let originalAmount: number | undefined;\n\n // Apply purchasing power parity adjustments for emerging markets\n const pppAdjustments: Record<string, number> = {\n  IDR: 0.6,  // 40% discount for Indonesia\n  VND: 0.6,  // 40% discount for Vietnam\n  INR: 0.65, // 35% discount for India \n  PHP: 0.7,  // 30% discount for Philippines\n  BRL: 0.7,  // 30% discount for Brazil\n  MYR: 0.75, // 25% discount for Malaysia\n  MXN: 0.75, // 25% discount for Mexico\n  THB: 0.8,  // 20% discount for Thailand\n  TRY: 0.85, // 15% discount for Turkey\n };\n\n if (pppAdjustments[targetCurrency]) {\n  originalAmount = convertedAmount;\n  convertedAmount = convertedAmount * pppAdjustments[targetCurrency];\n  isDiscounted = true;\n }\n\n // Round to sensible increments for each currency\n convertedAmount = roundToNicePricing(convertedAmount, targetCurrency);\n\n return {\n  amount: convertedAmount,\n  formatted: formatCurrency(convertedAmount, targetCurrency),\n  currency,\n  isDiscounted,\n  originalAmount\n };\n}\n\n/**\n * Round prices to nice, psychological pricing points\n * @param amount Raw converted amount\n * @param currency Currency code\n * @returns Rounded amount\n */\nfunction roundToNicePricing(amount: number, currency: string): number {\n const roundingRules: Record<string, (amount: number) => number> = {\n  THB: (amt) => Math.round(amt / 10) * 10,    // Round to nearest 10 THB\n  IDR: (amt) => Math.round(amt / 1000) * 1000,  // Round to nearest 1000 IDR \n  VND: (amt) => Math.round(amt / 1000) * 1000,  // Round to nearest 1000 VND\n  INR: (amt) => Math.round(amt / 10) * 10,    // Round to nearest 10 INR\n  PHP: (amt) => Math.round(amt),         // Round to nearest peso\n  BRL: (amt) => Math.round(amt * 2) / 2,     // Round to nearest 0.5 BRL\n  MYR: (amt) => Math.round(amt * 2) / 2,     // Round to nearest 0.5 MYR\n  MXN: (amt) => Math.round(amt),         // Round to nearest peso\n  TRY: (amt) => Math.round(amt),         // Round to nearest lira\n  JPY: (amt) => Math.round(amt / 10) * 10,    // Round to nearest 10 JPY\n  default: (amt) => Math.round(amt * 100) / 100  // Round to nearest cent\n };\n\n const rounder = roundingRules[currency] || roundingRules.default;\n return rounder(amount);\n}\n\n/**\n * Get currency symbol for a given currency code\n * @param currencyCode Currency code\n * @returns Currency symbol or code if not found\n */\nexport function getCurrencySymbol(currencyCode: string): string {\n return CURRENCIES[currencyCode]?.symbol || currencyCode;\n}\n\n/**\n * Get all supported currencies as array\n * @returns Array of currency objects\n */\nexport function getSupportedCurrencies(): Currency[] {\n return Object.values(CURRENCIES);\n}\n\n/**\n * Determine best currency based on user location/preferences\n * @param userCountry User's country code (ISO 2-letter)\n * @returns Recommended currency code\n */\nexport function getRecommendedCurrency(userCountry?: string): string {\n const countryToCurrency: Record<string, string> = {\n  'TH': 'THB',\n  'ID': 'IDR', \n  'IN': 'INR',\n  'BR': 'BRL',\n  'MX': 'MXN',\n  'GB': 'GBP',\n  'JP': 'JPY',\n  'CA': 'CAD',\n  'AU': 'AUD',\n  'DE': 'EUR',\n  'FR': 'EUR',\n  'IT': 'EUR',\n  'ES': 'EUR',\n  'NL': 'EUR',\n  'VN': 'VND',\n  'PH': 'PHP',\n  'MY': 'MYR',\n  'TR': 'TRY',\n  'SA': 'SAR',\n  'AE': 'SAR',\n  'KW': 'SAR',\n  'QA': 'SAR',\n  'BH': 'SAR',\n  'OM': 'SAR',\n };\n\n return countryToCurrency[userCountry || ''] || 'USD';\n}","path":null,"size_bytes":8429,"size_tokens":null},"client/src/components/forms/add-funds-form.tsx":{"content":"import { useState } from\"react\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { z } from\"zod\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Textarea } from\"@/components/ui/textarea\";\nimport { Label } from\"@/components/ui/label\";\nimport { DialogHeader, DialogTitle, DialogDescription } from\"@/components/ui/dialog\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { useUser } from\"@/lib/userContext\";\nimport { Loader2, CheckCircle2, AlertCircle } from\"lucide-react\";\n\nconst addFundsFormSchema = z.object({\n amount: z.string().min(1,\"Amount is required\").refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\"Must be a valid positive number\"),\n description: z.string().optional(),\n date: z.string().min(1,\"Date is required\"),\n});\n\ntype AddFundsFormData = z.infer<typeof addFundsFormSchema>;\n\ninterface AddFundsFormProps {\n goalId: string;\n goalTitle: string;\n currentAmount: string;\n targetAmount: string;\n onSuccess?: () => void;\n}\n\nexport default function AddFundsForm({ goalId, goalTitle, currentAmount, targetAmount, onSuccess }: AddFundsFormProps) {\n const [isSubmitting, setIsSubmitting] = useState(false);\n const { toast } = useToast();\n const queryClient = useQueryClient();\n const { user, isLoading: userLoading } = useUser();\n\n const {\n  register,\n  handleSubmit,\n  formState: { errors },\n  reset,\n } = useForm<AddFundsFormData>({\n  resolver: zodResolver(addFundsFormSchema),\n  defaultValues: {\n   date: new Date().toISOString().split('T')[0],\n  },\n });\n\n const createTransactionMutation = useMutation({\n  mutationFn: (data: AddFundsFormData) => \n   apiRequest(\"POST\",\"/api/transactions\", {\n    userId: user?.id,\n    amount: parseFloat(data.amount),\n    type:\"transfer\", // Use transfer type so the storage layer updates the goal\n    category:\"savings\",\n    description: data.description || `Added funds to ${goalTitle}`,\n    goalId: goalId,\n    date: new Date(data.date).toISOString(),\n   }),\n  onMutate: async (newFunds: AddFundsFormData) => {\n   // Cancel outgoing refetches\n   await queryClient.cancelQueries({ queryKey: [\"/api/financial-goals\"] });\n   await queryClient.cancelQueries({ queryKey: [\"/api/transactions\"] });\n   \n   // Snapshot previous data\n   const previousGoals = queryClient.getQueryData([\"/api/financial-goals\"]);\n   const previousTransactions = queryClient.getQueryData([\"/api/transactions\"]);\n   \n   const amountToAdd = parseFloat(newFunds.amount);\n   \n   // Optimistically update goal's current amount\n   queryClient.setQueryData([\"/api/financial-goals\"], (old: any) => {\n    if (!Array.isArray(old)) return old;\n    return old.map((goal: any) => \n     goal.id === goalId \n      ? { ...goal, currentAmount: (parseFloat(goal.currentAmount) + amountToAdd).toString() }\n      : goal\n    );\n   });\n   \n   // Optimistically add transaction\n   const optimisticTransaction = {\n    id: `temp-${Date.now()}`,\n    userId: user?.id,\n    type:\"transfer\",\n    amount: amountToAdd,\n    category:\"savings\",\n    description: newFunds.description || `Added funds to ${goalTitle}`,\n    goalId: goalId,\n    date: new Date(newFunds.date).toISOString(),\n    createdAt: new Date().toISOString(),\n   };\n   \n   queryClient.setQueryData([\"/api/transactions\"], (old: any) => \n    Array.isArray(old) ? [optimisticTransaction, ...old] : [optimisticTransaction]\n   );\n   \n   return { previousGoals, previousTransactions };\n  },\n  onSuccess: (data, variables) => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/goal-milestones\"] });\n   toast({\n    title:\"Funds added successfully\",\n    description: `$${parseFloat(variables.amount).toLocaleString()} has been added to your ${goalTitle} goal.`,\n    icon: <CheckCircle2 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n   });\n   reset();\n   onSuccess?.();\n  },\n  onError: (error: any, _variables, context) => {\n   // Rollback on error\n   if (context?.previousGoals) {\n    queryClient.setQueryData([\"/api/financial-goals\"], context.previousGoals);\n   }\n   if (context?.previousTransactions) {\n    queryClient.setQueryData([\"/api/transactions\"], context.previousTransactions);\n   }\n   \n   const isNetworkError = error.message?.includes('fetch') || error.message?.includes('network');\n   const isAmountError = error.message?.includes('amount') || error.message?.includes('number');\n   \n   toast({\n    title:\"Couldn't Add Funds\",\n    description: isNetworkError \n     ?\"Check your internet connection and try again.\"\n     : isAmountError\n     ?\"Please enter a valid amount (numbers only, no symbols).\"\n     : error.message ||\"Something went wrong. Your contribution wasn't saved - please try again.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n  },\n  onSettled: () => {\n   setIsSubmitting(false);\n  },\n });\n\n const onSubmit = (data: AddFundsFormData) => {\n  if (!user) {\n   toast({\n    title:\"Sign In Required\",\n    description:\"Please sign in to contribute to your financial goals.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n   return;\n  }\n  \n  // Validate date is not in the future\n  if (new Date(data.date) > new Date()) {\n   toast({\n    title:\"Invalid date\",\n    description:\"Transaction date cannot be in the future.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n   return;\n  }\n\n  setIsSubmitting(true);\n  createTransactionMutation.mutate(data);\n };\n\n if (userLoading) {\n  return (\n   <div className=\"p-6\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-3/4 mb-4\"></div>\n     <div className=\"h-10 bg-muted rounded mb-4\"></div>\n     <div className=\"h-10 bg-muted rounded mb-4\"></div>\n     <div className=\"h-10 bg-muted rounded mb-4\"></div>\n    </div>\n   </div>\n  );\n }\n\n return (\n  <>\n   <DialogHeader>\n    <DialogTitle>Add Funds to Goal</DialogTitle>\n    <DialogDescription>\n     Record a contribution towards your goal\n    </DialogDescription>\n   </DialogHeader>\n   \n   <div className=\"space-y-4\">\n    {/* Goal Info */}\n    <div className=\"p-4 bg-muted/50 rounded-lg\">\n     <p className=\"text-sm text-muted-foreground\">Goal: {goalTitle}</p>\n     <p className=\"text-sm text-muted-foreground\">\n      Current: ${parseFloat(currentAmount).toLocaleString()} / \n      Target: ${parseFloat(targetAmount).toLocaleString()}\n     </p>\n     <div className=\"mt-2\">\n      <div className=\"text-xs text-muted-foreground mb-1\">\n       Progress: {Math.round((parseFloat(currentAmount) / parseFloat(targetAmount)) * 100)}%\n      </div>\n     </div>\n    </div>\n\n    <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n     <div className=\"grid grid-cols-2 gap-4\">\n      <div>\n       <Label htmlFor=\"amount\">Amount ($)</Label>\n       <Input\n        id=\"amount\"\n        type=\"number\"\n        step=\"0.01\"\n        min=\"0\"\n        {...register(\"amount\")}\n        placeholder=\"0.00\"\n        data-testid=\"input-add-funds-amount\"\n       />\n       {errors.amount && (\n        <p className=\"text-sm text-destructive mt-1\">{errors.amount.message}</p>\n       )}\n      </div>\n\n      <div>\n       <Label htmlFor=\"date\">Date</Label>\n       <Input\n        id=\"date\"\n        type=\"date\"\n        {...register(\"date\")}\n        data-testid=\"input-add-funds-date\"\n       />\n       {errors.date && (\n        <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n       )}\n      </div>\n     </div>\n\n     <div>\n      <Label htmlFor=\"description\">Description (Optional)</Label>\n      <Textarea\n       id=\"description\"\n       {...register(\"description\")}\n       placeholder={`Add a note about this contribution to ${goalTitle}`}\n       rows={3}\n       data-testid=\"input-add-funds-description\"\n      />\n     </div>\n\n     <div className=\"flex justify-end space-x-2 pt-4\">\n      <Button\n       type=\"button\"\n       variant=\"outline\"\n       onClick={onSuccess}\n       disabled={isSubmitting}\n       data-testid=\"button-cancel-add-funds\"\n      >\n       Cancel\n      </Button>\n      <Button\n       type=\"submit\"\n       disabled={isSubmitting}\n       className=\"min-w-[140px]\"\n       data-testid=\"button-confirm-add-funds\"\n      >\n       {isSubmitting ? (\n        <>\n         <Loader2 className=\"mr-2 h-4 w-4\" />\n         Adding...\n        </>\n       ) : (\n       \"Add Funds\"\n       )}\n      </Button>\n     </div>\n    </form>\n   </div>\n  </>\n );\n}","path":null,"size_bytes":8679,"size_tokens":null},"client/src/components/settings/data-privacy.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Switch } from\"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { Input } from\"@/components/ui/input\";\nimport { Label } from\"@/components/ui/label\";\nimport {\n AlertDialog,\n AlertDialogAction,\n AlertDialogCancel,\n AlertDialogContent,\n AlertDialogDescription,\n AlertDialogFooter,\n AlertDialogHeader,\n AlertDialogTitle,\n} from\"@/components/ui/alert-dialog\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { \n Shield, \n Download, \n Trash2, \n Eye, \n EyeOff, \n Lock,\n AlertTriangle,\n FileText,\n Database,\n Clock,\n CheckCircle,\n Loader2\n} from\"lucide-react\";\nimport { SkeletonCard } from\"@/components/ui/skeleton\";\n\ninterface DataPrivacyProps {}\n\ntype PrivacySettings = {\n id: string;\n userId: string;\n dataRetentionPeriod: number;\n allowAnalytics: boolean;\n allowCookies: boolean;\n shareDataWithPartners: boolean;\n profileVisibility:\"public\" |\"private\" |\"friends\";\n allowDataExport: boolean;\n twoFactorEnabled: boolean;\n lastPasswordChange: string | null;\n lastDataExport: string | null;\n createdAt: string;\n updatedAt: string;\n};\n\nexport default function DataPrivacy({ }: DataPrivacyProps) {\n const { toast } = useToast();\n const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n const [deleteConfirmation, setDeleteConfirmation] = useState(\"\");\n\n const { data: settings, isLoading } = useQuery<PrivacySettings>({\n  queryKey: ['/api/privacy-settings'],\n });\n\n const updateSettingsMutation = useMutation({\n  mutationFn: (updates: Partial<PrivacySettings>) =>\n   apiRequest('PUT', '/api/privacy-settings', updates),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: ['/api/privacy-settings'] });\n   toast({\n    title:\"Privacy settings updated\",\n    description:\"Your privacy preferences have been saved.\",\n   });\n  },\n  onError: () => {\n   toast({\n    title:\"Error\",\n    description:\"Failed to update privacy settings. Please try again.\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const exportDataMutation = useMutation({\n  mutationFn: (format: 'json' | 'csv') =>\n   apiRequest('GET', `/api/export-data?format=${format}`),\n  onSuccess: async (response, format) => {\n   const blob = await response.blob();\n   const url = window.URL.createObjectURL(blob);\n   const a = document.createElement('a');\n   a.style.display = 'none';\n   a.href = url;\n   a.download = `twealth-data-${new Date().toISOString().split('T')[0]}.${format}`;\n   document.body.appendChild(a);\n   a.click();\n   window.URL.revokeObjectURL(url);\n   document.body.removeChild(a);\n   \n   toast({\n    title:\"Data exported successfully\",\n    description: `Your data has been downloaded as ${format.toUpperCase()} file.`,\n   });\n  },\n  onError: () => {\n   toast({\n    title:\"Export failed\",\n    description:\"Failed to export your data. Please try again.\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const deleteDataMutation = useMutation({\n  mutationFn: () =>\n   apiRequest('DELETE', '/api/delete-user-data', { confirmation: 'DELETE' }),\n  onSuccess: () => {\n   toast({\n    title:\"Account deleted\",\n    description:\"Your account and all associated data have been permanently deleted.\",\n    variant:\"destructive\",\n   });\n  },\n  onError: () => {\n   toast({\n    title:\"Deletion failed\",\n    description:\"Failed to delete account. Please contact support.\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const retentionPeriods = [\n  { value: 30, label:\"30 days\" },\n  { value: 90, label:\"90 days\" },\n  { value: 180, label:\"6 months\" },\n  { value: 365, label:\"1 year\" },\n  { value: 730, label:\"2 years\" },\n ];\n\n const visibilityOptions = [\n  { value:\"private\", label:\"Private\", description:\"Only you can see your profile\", icon: Lock },\n  { value:\"friends\", label:\"Friends\", description:\"Only friends can see your profile\", icon: Eye },\n  { value:\"public\", label:\"Public\", description:\"Anyone can see your profile\", icon: EyeOff },\n ];\n\n const handlePrivacyToggle = (field: keyof PrivacySettings) => {\n  if (!settings) return;\n  updateSettingsMutation.mutate({ \n   [field]: !settings[field] \n  });\n };\n\n const handleRetentionPeriodChange = (period: number) => {\n  updateSettingsMutation.mutate({ dataRetentionPeriod: period });\n };\n\n const handleVisibilityChange = (visibility:\"public\" |\"private\" |\"friends\") => {\n  updateSettingsMutation.mutate({ profileVisibility: visibility });\n };\n\n const handleDataExport = (format: 'json' | 'csv') => {\n  exportDataMutation.mutate(format);\n };\n\n const handleDataDeletion = () => {\n  setShowDeleteDialog(true);\n  setDeleteConfirmation(\"\");\n };\n\n const confirmDeletion = () => {\n  if (deleteConfirmation === 'DELETE') {\n   deleteDataMutation.mutate();\n   setShowDeleteDialog(false);\n   setDeleteConfirmation(\"\");\n  } else {\n   toast({\n    title: \"Confirmation required\",\n    description: \"Please type DELETE to confirm account deletion.\",\n    variant: \"destructive\",\n   });\n  }\n };\n\n const cancelDeletion = () => {\n  setShowDeleteDialog(false);\n  setDeleteConfirmation(\"\");\n  toast({\n   title: \"Deletion cancelled\",\n   description: \"Account deletion was cancelled. Your data is safe.\",\n  });\n };\n\n if (isLoading) {\n  return (\n   <div className=\"space-y-4 sm:space-y-6\">\n    {[...Array(3)].map((_, i) => (\n     <SkeletonCard key={i} />\n    ))}\n   </div>\n  );\n }\n\n if (!settings) {\n  return (\n   <div className=\"text-center p-8 sm:p-12\">\n    <p className=\"text-base sm:text-lg text-slate-600 dark:text-slate-400\">Failed to load privacy settings</p>\n   </div>\n  );\n }\n\n return (\n  <div className=\"space-y-4 sm:space-y-6\">\n   {/* Privacy Controls */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Shield className=\"w-5 h-5 sm:w-6 sm:h-6 text-red-600\" />\n      Privacy Controls\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Manage your data sharing and privacy preferences\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-3 sm:space-y-4\">\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <Eye className=\"text-blue-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Allow Analytics</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Help improve the app with usage analytics</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-allow-analytics\"\n       checked={settings.allowAnalytics}\n       onCheckedChange={() => handlePrivacyToggle('allowAnalytics')}\n       disabled={updateSettingsMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <Database className=\"text-green-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Allow Cookies</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Store preferences and session data</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-allow-cookies\"\n       checked={settings.allowCookies}\n       onCheckedChange={() => handlePrivacyToggle('allowCookies')}\n       disabled={updateSettingsMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <AlertTriangle className=\"text-orange-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Share Data with Partners</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Share anonymized data for insights</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-share-data\"\n       checked={settings.shareDataWithPartners}\n       onCheckedChange={() => handlePrivacyToggle('shareDataWithPartners')}\n       disabled={updateSettingsMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"space-y-3 sm:space-y-4 pt-4\">\n      <h4 className=\"font-medium text-sm sm:text-base text-slate-700 dark:text-slate-300\">Profile Visibility</h4>\n      <Select \n       value={settings.profileVisibility} \n       onValueChange={handleVisibilityChange}\n       disabled={updateSettingsMutation.isPending}\n      >\n       <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-profile-visibility\">\n        <SelectValue />\n       </SelectTrigger>\n       <SelectContent>\n        {visibilityOptions.map((option) => (\n         <SelectItem key={option.value} value={option.value}>\n          <div className=\"flex items-center gap-2 py-1\">\n           <option.icon className=\"w-4 h-4 text-slate-600 dark:text-slate-400\" />\n           <div>\n            <div className=\"font-medium text-sm sm:text-base\">{option.label}</div>\n            <div className=\"text-xs text-slate-600 dark:text-slate-400\">{option.description}</div>\n           </div>\n          </div>\n         </SelectItem>\n        ))}\n       </SelectContent>\n      </Select>\n     </div>\n\n     <div className=\"space-y-3 sm:space-y-4 pt-4\">\n      <h4 className=\"font-medium text-sm sm:text-base text-slate-700 dark:text-slate-300\">Data Retention Period</h4>\n      <Select \n       value={settings.dataRetentionPeriod.toString()} \n       onValueChange={(value) => handleRetentionPeriodChange(parseInt(value))}\n       disabled={updateSettingsMutation.isPending}\n      >\n       <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-retention-period\">\n        <SelectValue />\n       </SelectTrigger>\n       <SelectContent>\n        {retentionPeriods.map((period) => (\n         <SelectItem key={period.value} value={period.value.toString()}>\n          {period.label}\n         </SelectItem>\n        ))}\n       </SelectContent>\n      </Select>\n      <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">\n       Automatically delete inactive data after this period\n      </p>\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Data Export */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Download className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" />\n      Data Export\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Download a copy of your personal data\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-4\">\n     <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n      <Button\n       data-testid=\"button-export-json\"\n       onClick={() => handleDataExport('json')}\n       disabled={exportDataMutation.isPending}\n       variant=\"outline\"\n       className=\"h-12 sm:h-14 text-base font-medium border-slate-300 dark:border-slate-700 hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-950/30\"\n      >\n       <FileText className=\"mr-2 w-5 h-5\" />\n       {exportDataMutation.isPending ? 'Exporting...' : 'Download JSON'}\n      </Button>\n      \n      <Button\n       data-testid=\"button-export-csv\"\n       onClick={() => handleDataExport('csv')}\n       disabled={exportDataMutation.isPending}\n       variant=\"outline\"\n       className=\"h-12 sm:h-14 text-base font-medium border-slate-300 dark:border-slate-700 hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-950/30\"\n      >\n       <Database className=\"mr-2 w-5 h-5\" />\n       {exportDataMutation.isPending ? 'Exporting...' : 'Download CSV'}\n      </Button>\n     </div>\n     \n     {settings.lastDataExport && (\n      <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">\n       Last export: {new Date(settings.lastDataExport).toLocaleDateString()}\n      </p>\n     )}\n    </CardContent>\n   </Card>\n\n   {/* Danger Zone */}\n   <Card className=\"border-2 border-red-200 dark:border-red-900/50 shadow-sm bg-white dark:bg-gray-900\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl text-red-700 dark:text-red-400\">\n      <AlertTriangle className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n      Danger Zone\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Irreversible actions that permanently delete your data\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6\">\n     <div className=\"bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-800 rounded-xl p-4 sm:p-6\">\n      <div className=\"flex flex-col sm:flex-row items-start gap-4\">\n       <div className=\"flex-1\">\n        <h4 className=\"font-semibold text-base sm:text-lg text-red-900 dark:text-red-200 mb-2\">Delete Account</h4>\n        <p className=\"text-xs sm:text-sm text-red-800 dark:text-red-300 mb-1\">\n         Permanently delete your account and all associated data. This action cannot be undone.\n        </p>\n        <p className=\"text-xs text-red-700 dark:text-red-400\">\n         All goals, transactions, events, and preferences will be permanently removed.\n        </p>\n       </div>\n       <Button\n        data-testid=\"button-delete-account\"\n        onClick={handleDataDeletion}\n        disabled={deleteDataMutation.isPending}\n        variant=\"destructive\"\n        className=\"w-full sm:w-auto h-12 sm:h-14 text-base font-semibold bg-red-600 hover:bg-red-700 shadow-lg\"\n       >\n        <Trash2 className=\"mr-2 w-5 h-5\" />\n        {deleteDataMutation.isPending ? 'Deleting...' : 'Delete Account'}\n       </Button>\n      </div>\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Delete Account Confirmation Dialog */}\n   <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n    <AlertDialogContent className=\"max-w-md\">\n     <AlertDialogHeader>\n      <AlertDialogTitle className=\"flex items-center gap-2 text-red-600 dark:text-red-400\">\n       <AlertTriangle className=\"w-5 h-5\" />\n       Delete Your Account\n      </AlertDialogTitle>\n      <AlertDialogDescription className=\"text-left space-y-4\">\n       <p className=\"font-semibold text-red-700 dark:text-red-300\">\n        This action will PERMANENTLY DELETE your entire account and all associated data including:\n       </p>\n       <ul className=\"list-disc list-inside text-sm space-y-1 text-slate-600 dark:text-slate-400\">\n        <li>All financial goals and transactions</li>\n        <li>All events and time tracking data</li>\n        <li>All groups and memberships</li>\n        <li>All user preferences and settings</li>\n        <li>All notification history</li>\n       </ul>\n       <p className=\"font-bold text-red-700 dark:text-red-300\">\n        This action CANNOT be undone!\n       </p>\n       <div className=\"pt-2\">\n        <Label htmlFor=\"delete-confirmation\" className=\"text-sm font-medium\">\n         Type DELETE to confirm:\n        </Label>\n        <Input\n         id=\"delete-confirmation\"\n         data-testid=\"input-delete-confirmation\"\n         value={deleteConfirmation}\n         onChange={(e) => setDeleteConfirmation(e.target.value)}\n         placeholder=\"DELETE\"\n         className=\"mt-2 border-red-200 dark:border-red-800 focus:border-red-500\"\n        />\n       </div>\n      </AlertDialogDescription>\n     </AlertDialogHeader>\n     <AlertDialogFooter className=\"gap-2\">\n      <AlertDialogCancel \n       onClick={cancelDeletion}\n       data-testid=\"button-cancel-delete\"\n      >\n       Cancel\n      </AlertDialogCancel>\n      <AlertDialogAction\n       onClick={confirmDeletion}\n       disabled={deleteConfirmation !== 'DELETE' || deleteDataMutation.isPending}\n       className=\"bg-red-600 hover:bg-red-700 text-white disabled:opacity-50\"\n       data-testid=\"button-confirm-delete\"\n      >\n       {deleteDataMutation.isPending ? (\n        <>\n         <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n         Deleting...\n        </>\n       ) : (\n        'Delete Account'\n       )}\n      </AlertDialogAction>\n     </AlertDialogFooter>\n    </AlertDialogContent>\n   </AlertDialog>\n  </div>\n );\n}\n","path":null,"size_bytes":17214,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from\"react\"\nimport * as NavigationMenuPrimitive from\"@radix-ui/react-navigation-menu\"\nimport { cva } from\"class-variance-authority\"\nimport { ChevronDown } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n <NavigationMenuPrimitive.Root\n  ref={ref}\n  className={cn(\n  \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n   className\n  )}\n  {...props}\n >\n  {children}\n  <NavigationMenuViewport />\n </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.List>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n <NavigationMenuPrimitive.List\n  ref={ref}\n  className={cn(\n  \"group flex flex-1 list-none items-center justify-center space-x-1\",\n   className\n  )}\n  {...props}\n />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n\"group inline-flex h-13 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n <NavigationMenuPrimitive.Trigger\n  ref={ref}\n  className={cn(navigationMenuTriggerStyle(),\"group\", className)}\n  {...props}\n >\n  {children}{\"\"}\n  <ChevronDown\n   className=\"relative top-[1px] ml-1 h-3 w-3 transition group-data-[state=open]:rotate-180\"\n   aria-hidden=\"true\"\n  />\n </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n <NavigationMenuPrimitive.Content\n  ref={ref}\n  className={cn(\n  \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto\",\n   className\n  )}\n  {...props}\n />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n  <NavigationMenuPrimitive.Viewport\n   className={cn(\n   \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n    className\n   )}\n   ref={ref}\n   {...props}\n  />\n </div>\n))\nNavigationMenuViewport.displayName =\n NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n <NavigationMenuPrimitive.Indicator\n  ref={ref}\n  className={cn(\n  \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n   className\n  )}\n  {...props}\n >\n  <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n navigationMenuTriggerStyle,\n NavigationMenu,\n NavigationMenuList,\n NavigationMenuItem,\n NavigationMenuContent,\n NavigationMenuTrigger,\n NavigationMenuLink,\n NavigationMenuIndicator,\n NavigationMenuViewport,\n}\n","path":null,"size_bytes":4958,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from\"react\"\nimport * as DropdownMenuPrimitive from\"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n  inset?: boolean\n }\n>(({ className, inset, children, ...props }, ref) => (\n <DropdownMenuPrimitive.SubTrigger\n  ref={ref}\n  className={cn(\n  \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-2.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n >\n  {children}\n  <ChevronRight className=\"ml-auto\" />\n </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n <DropdownMenuPrimitive.SubContent\n  ref={ref}\n  className={cn(\n  \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n   className\n  )}\n  {...props}\n />\n))\nDropdownMenuSubContent.displayName =\n DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n <DropdownMenuPrimitive.Portal>\n  <DropdownMenuPrimitive.Content\n   ref={ref}\n   sideOffset={sideOffset}\n   className={cn(\n   \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n    className\n   )}\n   {...props}\n  />\n </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <DropdownMenuPrimitive.Item\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-2.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n <DropdownMenuPrimitive.CheckboxItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-2.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  checked={checked}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <DropdownMenuPrimitive.ItemIndicator>\n    <Check className=\"h-4 w-4\" />\n   </DropdownMenuPrimitive.ItemIndicator>\n  </span>\n  {children}\n </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n <DropdownMenuPrimitive.RadioItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-2.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <DropdownMenuPrimitive.ItemIndicator>\n    <Circle className=\"h-2 w-2 fill-current\" />\n   </DropdownMenuPrimitive.ItemIndicator>\n  </span>\n  {children}\n </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <DropdownMenuPrimitive.Label\n  ref={ref}\n  className={cn(\n  \"px-2 py-1.5 text-sm font-semibold\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n <DropdownMenuPrimitive.Separator\n  ref={ref}\n  className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n  {...props}\n />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n return (\n  <span\n   className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n   {...props}\n  />\n )\n}\nDropdownMenuShortcut.displayName =\"DropdownMenuShortcut\"\n\nexport {\n DropdownMenu,\n DropdownMenuTrigger,\n DropdownMenuContent,\n DropdownMenuItem,\n DropdownMenuCheckboxItem,\n DropdownMenuRadioItem,\n DropdownMenuLabel,\n DropdownMenuSeparator,\n DropdownMenuShortcut,\n DropdownMenuGroup,\n DropdownMenuPortal,\n DropdownMenuSub,\n DropdownMenuSubContent,\n DropdownMenuSubTrigger,\n DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7354,"size_tokens":null},"client/src/components/pwa/install-prompt.tsx":{"content":"import { useState, useEffect } from\"react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Crown, Download, X, Smartphone } from\"lucide-react\";\n\ninterface BeforeInstallPromptEvent extends Event {\n prompt(): Promise<void>;\n userChoice: Promise<{ outcome: 'accepted' | 'dismissed'; platform: string }>;\n}\n\nexport function PWAInstallPrompt() {\n const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);\n const [showPrompt, setShowPrompt] = useState(false);\n const [isInstalled, setIsInstalled] = useState(false);\n\n useEffect(() => {\n  // Check if app is already installed\n  const checkIfInstalled = () => {\n   // Check if running in standalone mode (installed PWA)\n   if (window.matchMedia('(display-mode: standalone)').matches) {\n    setIsInstalled(true);\n    return;\n   }\n   \n   // Check if running as installed PWA on iOS\n   if ((window.navigator as any).standalone) {\n    setIsInstalled(true);\n    return;\n   }\n  };\n\n  checkIfInstalled();\n\n  const handleBeforeInstallPrompt = (e: Event) => {\n   const event = e as BeforeInstallPromptEvent;\n   // Prevent the mini-infobar from appearing on mobile\n   e.preventDefault();\n   // Stash the event so it can be triggered later\n   setDeferredPrompt(event);\n   \n   // Show install prompt after a short delay (better UX)\n   setTimeout(() => {\n    if (!isInstalled) {\n     setShowPrompt(true);\n    }\n   }, 3000);\n  };\n\n  const handleAppInstalled = () => {\n   setIsInstalled(true);\n   setShowPrompt(false);\n   setDeferredPrompt(null);\n   console.log('[PWA] App was installed');\n  };\n\n  window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n  window.addEventListener('appinstalled', handleAppInstalled);\n\n  return () => {\n   window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);\n   window.removeEventListener('appinstalled', handleAppInstalled);\n  };\n }, [isInstalled]);\n\n const handleInstallClick = async () => {\n  if (!deferredPrompt) {\n   return;\n  }\n\n  // Show the install prompt\n  await deferredPrompt.prompt();\n  \n  // Wait for the user to respond to the prompt\n  const { outcome } = await deferredPrompt.userChoice;\n  \n  if (outcome === 'accepted') {\n   console.log('[PWA] User accepted the install prompt');\n  } else {\n   console.log('[PWA] User dismissed the install prompt');\n  }\n  \n  // Clear the deferredPrompt\n  setDeferredPrompt(null);\n  setShowPrompt(false);\n };\n\n const handleDismiss = () => {\n  setShowPrompt(false);\n  // Don't show again for this session\n  sessionStorage.setItem('pwa-install-dismissed', 'true');\n };\n\n // Don't show if already installed or dismissed this session\n if (isInstalled || !showPrompt || sessionStorage.getItem('pwa-install-dismissed')) {\n  return null;\n }\n\n return (\n  <div \n   className=\"fixed left-4 right-4 md:left-auto md:right-6 md:w-80 z-[45] bottom-[calc(72px+env(safe-area-inset-bottom,0px))] md:bottom-6\"\n  >\n   <Card className=\"shadow-2xl border-2 border-primary/20 bg-white dark:bg-gray-900\">\n    <CardHeader className=\"pb-3\">\n     <div className=\"flex items-center justify-between\">\n      <div className=\"flex items-center gap-2\">\n       <div className=\"w-8 h-8 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center\">\n        <Crown className=\"w-5 h-5 text-white\" />\n       </div>\n       <CardTitle className=\"text-lg\">Install Twealth</CardTitle>\n      </div>\n      <Button\n       variant=\"ghost\"\n       size=\"sm\"\n       onClick={handleDismiss}\n       data-testid=\"button-dismiss-install\"\n      >\n       <X className=\"w-4 h-4\" />\n      </Button>\n     </div>\n    </CardHeader>\n    <CardContent className=\"space-y-4\">\n     <div className=\"space-y-2\">\n      <p className=\"text-sm text-muted-foreground\">\n       Get the full app experience with offline access and faster loading!\n      </p>\n      <div className=\"flex items-start gap-3 text-xs text-muted-foreground\">\n       <div className=\"flex items-center gap-1\">\n        <Smartphone className=\"w-3 h-3\" />\n        <span>App-like experience</span>\n       </div>\n       <div className=\"flex items-center gap-1\">\n        <Download className=\"w-3 h-3\" />\n        <span>Works offline</span>\n       </div>\n      </div>\n     </div>\n     \n     <div className=\"flex gap-2\">\n      <Button\n       onClick={handleInstallClick}\n       className=\"flex-1 bg-white dark:bg-gray-900\"\n       data-testid=\"button-install-pwa\"\n      >\n       <Download className=\"w-4 h-4 mr-2\" />\n       Install App\n      </Button>\n      <Button\n       variant=\"outline\"\n       onClick={handleDismiss}\n       data-testid=\"button-maybe-later\"\n      >\n       Maybe Later\n      </Button>\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}","path":null,"size_bytes":4737,"size_tokens":null},"client/src/components/language-switcher.tsx":{"content":"import { useTranslation } from 'react-i18next';\nimport { Globe } from 'lucide-react';\nimport {\n Select,\n SelectContent,\n SelectItem,\n SelectTrigger,\n SelectValue,\n} from\"@/components/ui/select\";\n\nconst languages = [\n { code: 'en', name: 'English' },\n { code: 'es', name: 'Español' },\n { code: 'ar', name: 'العربية' },\n { code: 'th', name: 'ไทย' },\n { code: 'id', name: 'Bahasa Indonesia' },\n { code: 'pt', name: 'Português' },\n { code: 'hi', name: 'हिंदी' },\n { code: 'vi', name: 'Tiếng Việt' },\n { code: 'tl', name: 'Filipino' },\n { code: 'ms', name: 'Bahasa Melayu' },\n { code: 'tr', name: 'Türkçe' },\n];\n\nexport default function LanguageSwitcher() {\n const { i18n } = useTranslation();\n\n const handleLanguageChange = (languageCode: string) => {\n  i18n.changeLanguage(languageCode);\n };\n\n const currentLanguage = languages.find(lang => lang.code === i18n.language) || languages[0];\n\n return (\n  <Select value={i18n.language} onValueChange={handleLanguageChange}>\n   <SelectTrigger className=\"w-40 h-9 text-sm\" data-testid=\"language-switcher\">\n    <div className=\"flex items-center gap-2\">\n     <Globe className=\"w-4 h-4\" />\n     <span className=\"hidden sm:inline\">{currentLanguage.name}</span>\n    </div>\n   </SelectTrigger>\n   <SelectContent>\n    {languages.map((language) => (\n     <SelectItem key={language.code} value={language.code}>\n      {language.name}\n     </SelectItem>\n    ))}\n   </SelectContent>\n  </Select>\n );\n}","path":null,"size_bytes":1458,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from\"react\"\nimport * as LabelPrimitive from\"@radix-ui/react-label\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst labelVariants = cva(\n\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n React.ElementRef<typeof LabelPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n  VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n <LabelPrimitive.Root\n  ref={ref}\n  className={cn(labelVariants(), className)}\n  {...props}\n />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":692,"size_tokens":null},"client/src/pages/friends.tsx":{"content":"import { useState } from\"react\";\nimport { useTranslation } from 'react-i18next';\nimport { useQuery, useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { Search, UserPlus, Users, Check, X, Loader2, UserMinus, Mail, MessageSquare, Calendar, Target, TrendingUp } from\"lucide-react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Input } from\"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from\"@/components/ui/avatar\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from\"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from\"@/components/ui/dialog\";\nimport { Textarea } from\"@/components/ui/textarea\";\nimport { Label } from\"@/components/ui/label\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport type { User } from\"@shared/schema\";\n\nexport default function Friends() {\n const { t } = useTranslation();\n const [searchQuery, setSearchQuery] = useState(\"\");\n const [selectedUser, setSelectedUser] = useState<User | null>(null);\n const [friendRequestMessage, setFriendRequestMessage] = useState(\"\");\n const [isRequestDialogOpen, setIsRequestDialogOpen] = useState(false);\n const { toast } = useToast();\n const queryClient = useQueryClient();\n\n // Fetch friends\n const { data: friends = [], isLoading: friendsLoading } = useQuery<User[]>({\n  queryKey: [\"/api/friends\"],\n });\n\n // Fetch pending friend requests\n const { data: pendingRequests = [], isLoading: pendingLoading } = useQuery<any[]>({\n  queryKey: [\"/api/friend-requests/pending\"],\n });\n\n // Fetch sent friend requests\n const { data: sentRequests = [], isLoading: sentLoading } = useQuery<any[]>({\n  queryKey: [\"/api/friend-requests/sent\"],\n });\n\n // Search users\n const { data: searchResults = [], isLoading: searchLoading } = useQuery<User[]>({\n  queryKey: [\"/api/users/search\", searchQuery],\n  queryFn: async () => {\n   if (searchQuery.length < 2) return [];\n   \n   const res = await fetch(`/api/users/search?q=${encodeURIComponent(searchQuery)}`);\n   \n   if (!res.ok) {\n    return [];\n   }\n   \n   const data = await res.json();\n   return Array.isArray(data) ? data : [];\n  },\n  enabled: searchQuery.length >= 2,\n });\n\n // Send friend request\n const sendRequestMutation = useMutation({\n  mutationFn: async ({ toUserId, message }: { toUserId: string; message?: string }) => {\n   const response = await apiRequest(\"POST\",\"/api/friend-requests\", { toUserId, message });\n   return response.json();\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/friend-requests/sent\"] });\n   setIsRequestDialogOpen(false);\n   setSelectedUser(null);\n   setFriendRequestMessage(\"\");\n   toast({\n    title: t('common.success'),\n    description: t('common.success'),\n   });\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message || t('common.error'),\n    variant:\"destructive\",\n   });\n  },\n });\n\n // Respond to friend request\n const respondToRequestMutation = useMutation({\n  mutationFn: async ({ requestId, status }: { requestId: string; status: 'accepted' | 'declined' }) => {\n   const response = await apiRequest(\"PUT\", `/api/friend-requests/${requestId}/respond`, { status });\n   return response.json();\n  },\n  onSuccess: (data, variables) => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/friend-requests/pending\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/friends\"] });\n   toast({\n    title: variables.status === 'accepted' ? t('common.success') : t('common.success'),\n    description: variables.status === 'accepted' \n     ?\"You are now friends!\" \n     :\"Friend request declined.\",\n   });\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message ||\"Failed to respond to friend request\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n // Remove friend\n const removeFriendMutation = useMutation({\n  mutationFn: async (friendId: string) => {\n   await apiRequest(\"DELETE\", `/api/friends/${friendId}`);\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/friends\"] });\n   toast({\n    title:\"Friend removed\",\n    description:\"You are no longer friends with this user.\",\n   });\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message ||\"Failed to remove friend\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n // Cancel friend request\n const cancelRequestMutation = useMutation({\n  mutationFn: async (requestId: string) => {\n   await apiRequest(\"DELETE\", `/api/friend-requests/${requestId}`);\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/friend-requests/sent\"] });\n   toast({\n    title:\"Friend request cancelled\",\n    description:\"Your friend request has been cancelled.\",\n   });\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message ||\"Failed to cancel friend request\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const getInitials = (firstName?: string | null, lastName?: string | null) => {\n  const first = firstName?.charAt(0) ||\"\";\n  const last = lastName?.charAt(0) ||\"\";\n  return (first + last).toUpperCase() ||\"?\";\n };\n\n const openRequestDialog = (user: User) => {\n  setSelectedUser(user);\n  setIsRequestDialogOpen(true);\n };\n\n const handleSendRequest = () => {\n  if (selectedUser) {\n   sendRequestMutation.mutate({\n    toUserId: selectedUser.id,\n    message: friendRequestMessage.trim() || undefined,\n   });\n  }\n };\n\n return (\n  <div className=\"min-h-screen bg-pink-50 dark:bg-pink-900/20\">\n   <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-4 sm:py-6 md:py-8\">\n    <div className=\"mb-4 sm:mb-6\">\n     <h1 className=\"text-2xl md:text-3xl lg:text-4xl font-bold mb-2 text-pink-600 dark:text-pink-400\">Friends</h1>\n     <p className=\"text-sm sm:text-base text-muted-foreground\">Connect with friends to collaborate on groups and events</p>\n    </div>\n\n   <Tabs defaultValue=\"friends\" className=\"space-y-6\">\n    <TabsList>\n     <TabsTrigger value=\"friends\" data-testid=\"tab-friends\">\n      <Users className=\"h-4 w-4 mr-2\" />\n      My Friends {friends?.length > 0 && `(${friends.length})`}\n     </TabsTrigger>\n     <TabsTrigger value=\"requests\" data-testid=\"tab-requests\">\n      <Mail className=\"h-4 w-4 mr-2\" />\n      Requests {pendingRequests?.length > 0 && `(${pendingRequests.length})`}\n     </TabsTrigger>\n     <TabsTrigger value=\"search\" data-testid=\"tab-search\">\n      <Search className=\"h-4 w-4 mr-2\" />\n      Find Friends\n     </TabsTrigger>\n    </TabsList>\n\n    {/* Friends Tab */}\n    <TabsContent value=\"friends\">\n     <Card>\n      <CardHeader>\n       <CardTitle>My Friends</CardTitle>\n      </CardHeader>\n      <CardContent>\n       {friendsLoading ? (\n        <div className=\"flex items-center justify-center py-8\">\n         <Loader2 className=\"h-6 w-6\" />\n        </div>\n       ) : friends?.length === 0 ? (\n        <div className=\"text-center py-16\">\n         <div className=\"relative mb-10\">\n          <div className=\"absolute inset-0 bg-pink-500/20 rounded-full blur-3xl\"></div>\n          <div className=\"relative bg-pink-500 rounded-3xl p-6 w-32 h-32 mx-auto flex items-center justify-center shadow-2xl\">\n           <Users className=\"h-16 w-16 text-white\" />\n          </div>\n         </div>\n         \n         <h3 className=\"text-3xl font-bold text-pink-600 dark:text-pink-400 mb-3\">\n          Build Your Network\n         </h3>\n         <p className=\"text-muted-foreground text-lg mb-4 max-w-lg mx-auto\">\n          Connect with friends to collaborate on goals, share events, and achieve more together\n         </p>\n         \n         <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto mb-10\">\n          <div className=\"bg-white dark:bg-gray-900 rounded-xl p-6 border border-blue-200/50 dark:border-blue-700/50\">\n           <div className=\"w-12 h-12 bg-blue-600 dark:bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg\">\n            <Target className=\"h-6 w-6 text-white\" />\n           </div>\n           <h4 className=\"font-bold mb-2 text-blue-800 dark:text-blue-200\">Shared Goals</h4>\n           <p className=\"text-sm text-blue-600 dark:text-blue-300\">Collaborate on financial targets</p>\n          </div>\n          \n          <div className=\"bg-white dark:bg-gray-900 rounded-xl p-6 border border-blue-200/50 dark:border-blue-700/50\">\n           <div className=\"w-12 h-12 bg-blue-600 dark:bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg\">\n            <Calendar className=\"h-6 w-6 text-white\" />\n           </div>\n           <h4 className=\"font-bold mb-2 text-blue-800 dark:text-blue-200\">Group Events</h4>\n           <p className=\"text-sm text-blue-600 dark:text-blue-300\">Plan activities together</p>\n          </div>\n          \n          <div className=\"bg-white dark:bg-gray-900 rounded-xl p-6 border border-blue-200/50 dark:border-blue-700/50\">\n           <div className=\"w-12 h-12 bg-blue-600 dark:bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg\">\n            <TrendingUp className=\"h-6 w-6 text-white\" />\n           </div>\n           <h4 className=\"font-bold mb-2 text-blue-800 dark:text-blue-200\">Social Motivation</h4>\n           <p className=\"text-sm text-blue-600 dark:text-blue-300\">Stay accountable together</p>\n          </div>\n         </div>\n         \n         <p className=\"text-muted-foreground mb-6\">\n          Use the\"Find Friends\" tab to search for people and send friend requests\n         </p>\n        </div>\n       ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n         {friends?.map((friend: any) => (\n          <Card key={friend.id} className=\"p-4\" data-testid={`friend-card-${friend.id}`}>\n           <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n             <Avatar>\n              <AvatarFallback>{getInitials(friend.firstName, friend.lastName)}</AvatarFallback>\n             </Avatar>\n             <div>\n              <p className=\"font-semibold\" data-testid={`friend-name-${friend.id}`}>\n               {friend.firstName} {friend.lastName}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">{friend.email}</p>\n             </div>\n            </div>\n            <Button\n             variant=\"ghost\"\n             size=\"sm\"\n             onClick={() => removeFriendMutation.mutate(friend.id)}\n             disabled={removeFriendMutation.isPending}\n             data-testid={`button-remove-friend-${friend.id}`}\n            >\n             <UserMinus className=\"h-4 w-4\" />\n            </Button>\n           </div>\n          </Card>\n         ))}\n        </div>\n       )}\n      </CardContent>\n     </Card>\n    </TabsContent>\n\n    {/* Requests Tab */}\n    <TabsContent value=\"requests\">\n     <div className=\"space-y-6\">\n      {/* Pending Requests */}\n      <Card>\n       <CardHeader>\n        <CardTitle>Pending Requests</CardTitle>\n       </CardHeader>\n       <CardContent>\n        {pendingLoading ? (\n         <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-6 w-6\" />\n         </div>\n        ) : pendingRequests?.length === 0 ? (\n         <div className=\"text-center py-8 text-muted-foreground\">\n          <Mail className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n          <p>No pending friend requests</p>\n         </div>\n        ) : (\n         <div className=\"space-y-4\">\n          {pendingRequests?.map((request: any) => (\n           <div key={request.id} className=\"flex items-center justify-between p-4 border rounded-lg\" data-testid={`request-${request.id}`}>\n            <div className=\"flex items-center space-x-3\">\n             <Avatar>\n              <AvatarFallback>{getInitials(request.fromUser.firstName, request.fromUser.lastName)}</AvatarFallback>\n             </Avatar>\n             <div>\n              <p className=\"font-semibold\">\n               {request.fromUser.firstName} {request.fromUser.lastName}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">{request.fromUser.email}</p>\n              {request.message && (\n               <p className=\"text-sm mt-1 text-muted-foreground flex items-center\">\n                <MessageSquare className=\"h-3 w-3 mr-1\" />\n                {request.message}\n               </p>\n              )}\n             </div>\n            </div>\n            <div className=\"flex space-x-2\">\n             <Button\n              size=\"sm\"\n              onClick={() => respondToRequestMutation.mutate({ requestId: request.id, status: 'accepted' })}\n              disabled={respondToRequestMutation.isPending}\n              data-testid={`button-accept-${request.id}`}\n             >\n              <Check className=\"h-4 w-4 mr-1\" />\n              Accept\n             </Button>\n             <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => respondToRequestMutation.mutate({ requestId: request.id, status: 'declined' })}\n              disabled={respondToRequestMutation.isPending}\n              data-testid={`button-decline-${request.id}`}\n             >\n              <X className=\"h-4 w-4 mr-1\" />\n              Decline\n             </Button>\n            </div>\n           </div>\n          ))}\n         </div>\n        )}\n       </CardContent>\n      </Card>\n\n      {/* Sent Requests */}\n      <Card>\n       <CardHeader>\n        <CardTitle>Sent Requests</CardTitle>\n       </CardHeader>\n       <CardContent>\n        {sentLoading ? (\n         <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-6 w-6\" />\n         </div>\n        ) : sentRequests?.length === 0 ? (\n         <div className=\"text-center py-8 text-muted-foreground\">\n          <p>No sent friend requests</p>\n         </div>\n        ) : (\n         <div className=\"space-y-4\">\n          {sentRequests?.map((request: any) => (\n           <div key={request.id} className=\"flex items-center justify-between p-4 border rounded-lg\">\n            <div className=\"flex items-center space-x-3\">\n             <Avatar>\n              <AvatarFallback>{getInitials(request.toUser.firstName, request.toUser.lastName)}</AvatarFallback>\n             </Avatar>\n             <div>\n              <p className=\"font-semibold\">\n               {request.toUser.firstName} {request.toUser.lastName}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">{request.toUser.email}</p>\n              <Badge variant=\"secondary\" className=\"mt-1\">Pending</Badge>\n             </div>\n            </div>\n            <Button\n             variant=\"outline\"\n             size=\"sm\"\n             onClick={() => cancelRequestMutation.mutate(request.id)}\n             disabled={cancelRequestMutation.isPending}\n             data-testid={`button-cancel-${request.id}`}\n            >\n             Cancel\n            </Button>\n           </div>\n          ))}\n         </div>\n        )}\n       </CardContent>\n      </Card>\n     </div>\n    </TabsContent>\n\n    {/* Search Tab */}\n    <TabsContent value=\"search\">\n     <Card>\n      <CardHeader>\n       <CardTitle>Find Friends</CardTitle>\n      </CardHeader>\n      <CardContent>\n       <div className=\"space-y-4\">\n        <div className=\"relative\">\n         <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n         <Input\n          placeholder=\"Search by name or email...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"pl-10\"\n          data-testid=\"input-search-users\"\n         />\n        </div>\n\n        {searchQuery.length < 2 ? (\n         <div className=\"text-center py-8 text-muted-foreground\">\n          <Search className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n          <p>Enter at least 2 characters to search for users</p>\n         </div>\n        ) : searchLoading ? (\n         <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"h-6 w-6\" />\n         </div>\n        ) : searchResults?.length === 0 ? (\n         <div className=\"text-center py-8 text-muted-foreground\">\n          <p>No users found</p>\n         </div>\n        ) : (\n         <div className=\"space-y-4\">\n          {searchResults?.map((user: any) => (\n           <div key={user.id} className=\"flex items-center justify-between p-4 border rounded-lg\" data-testid={`search-result-${user.id}`}>\n            <div className=\"flex items-center space-x-3\">\n             <Avatar>\n              <AvatarFallback>{getInitials(user.firstName, user.lastName)}</AvatarFallback>\n             </Avatar>\n             <div>\n              <p className=\"font-semibold\">\n               {user.firstName} {user.lastName}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n             </div>\n            </div>\n            <Button\n             size=\"sm\"\n             onClick={() => openRequestDialog(user)}\n             disabled={sendRequestMutation.isPending}\n             data-testid={`button-add-friend-${user.id}`}\n            >\n             <UserPlus className=\"h-4 w-4 mr-1\" />\n             Add Friend\n            </Button>\n           </div>\n          ))}\n         </div>\n        )}\n       </div>\n      </CardContent>\n     </Card>\n    </TabsContent>\n   </Tabs>\n\n   {/* Friend Request Dialog */}\n   <Dialog open={isRequestDialogOpen} onOpenChange={setIsRequestDialogOpen}>\n    <DialogContent>\n     <DialogHeader>\n      <DialogTitle>Send Friend Request</DialogTitle>\n     </DialogHeader>\n     <div className=\"space-y-4\">\n      {selectedUser && (\n       <div className=\"flex items-center space-x-3 p-3 bg-muted rounded-lg\">\n        <Avatar>\n         <AvatarFallback>{getInitials(selectedUser.firstName, selectedUser.lastName)}</AvatarFallback>\n        </Avatar>\n        <div>\n         <p className=\"font-semibold\">\n          {selectedUser.firstName} {selectedUser.lastName}\n         </p>\n         <p className=\"text-sm text-muted-foreground\">{selectedUser.email}</p>\n        </div>\n       </div>\n      )}\n      <div>\n       <Label htmlFor=\"message\">Add a message (optional)</Label>\n       <Textarea\n        id=\"message\"\n        placeholder=\"Hi! I'd like to connect with you...\"\n        value={friendRequestMessage}\n        onChange={(e) => setFriendRequestMessage(e.target.value)}\n        className=\"mt-2\"\n        rows={3}\n        data-testid=\"textarea-friend-request-message\"\n       />\n      </div>\n      <div className=\"flex justify-end space-x-2\">\n       <Button\n        variant=\"outline\"\n        onClick={() => {\n         setIsRequestDialogOpen(false);\n         setSelectedUser(null);\n         setFriendRequestMessage(\"\");\n        }}\n        data-testid=\"button-cancel-request\"\n       >\n        Cancel\n       </Button>\n       <Button\n        onClick={handleSendRequest}\n        disabled={sendRequestMutation.isPending}\n        data-testid=\"button-send-request\"\n       >\n        {sendRequestMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2\" />}\n        Send Request\n       </Button>\n      </div>\n     </div>\n    </DialogContent>\n   </Dialog>\n   </div>\n  </div>\n );\n}\n","path":null,"size_bytes":19232,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as AvatarPrimitive from\"@radix-ui/react-avatar\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n React.ElementRef<typeof AvatarPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n <AvatarPrimitive.Root\n  ref={ref}\n  className={cn(\n  \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n   className\n  )}\n  {...props}\n />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n React.ElementRef<typeof AvatarPrimitive.Image>,\n React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n <AvatarPrimitive.Image\n  ref={ref}\n  className={cn(\"aspect-square h-full w-full\", className)}\n  {...props}\n />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n React.ElementRef<typeof AvatarPrimitive.Fallback>,\n React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n <AvatarPrimitive.Fallback\n  ref={ref}\n  className={cn(\n  \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n   className\n  )}\n  {...props}\n />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1368,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport { Drawer as DrawerPrimitive } from\"vaul\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Drawer = ({\n shouldScaleBackground = true,\n ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n <DrawerPrimitive.Root\n  shouldScaleBackground={shouldScaleBackground}\n  {...props}\n />\n)\nDrawer.displayName =\"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n React.ElementRef<typeof DrawerPrimitive.Overlay>,\n React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n <DrawerPrimitive.Overlay\n  ref={ref}\n  className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n  {...props}\n />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n React.ElementRef<typeof DrawerPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n <DrawerPortal>\n  <DrawerOverlay />\n  <DrawerPrimitive.Content\n   ref={ref}\n   className={cn(\n   \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n    className\n   )}\n   {...props}\n  >\n   <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n   {children}\n  </DrawerPrimitive.Content>\n </DrawerPortal>\n))\nDrawerContent.displayName =\"DrawerContent\"\n\nconst DrawerHeader = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n  {...props}\n />\n)\nDrawerHeader.displayName =\"DrawerHeader\"\n\nconst DrawerFooter = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n  {...props}\n />\n)\nDrawerFooter.displayName =\"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n React.ElementRef<typeof DrawerPrimitive.Title>,\n React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n <DrawerPrimitive.Title\n  ref={ref}\n  className={cn(\n  \"text-lg font-semibold leading-none tracking-tight\",\n   className\n  )}\n  {...props}\n />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n React.ElementRef<typeof DrawerPrimitive.Description>,\n React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n <DrawerPrimitive.Description\n  ref={ref}\n  className={cn(\"text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n Drawer,\n DrawerPortal,\n DrawerOverlay,\n DrawerTrigger,\n DrawerClose,\n DrawerContent,\n DrawerHeader,\n DrawerFooter,\n DrawerTitle,\n DrawerDescription,\n}\n","path":null,"size_bytes":2902,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as MenubarPrimitive from\"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nfunction MenubarMenu({\n ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n <MenubarPrimitive.Root\n  ref={ref}\n  className={cn(\n  \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n   className\n  )}\n  {...props}\n />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Trigger>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n <MenubarPrimitive.Trigger\n  ref={ref}\n  className={cn(\n  \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n   className\n  )}\n  {...props}\n />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n  inset?: boolean\n }\n>(({ className, inset, children, ...props }, ref) => (\n <MenubarPrimitive.SubTrigger\n  ref={ref}\n  className={cn(\n  \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n >\n  {children}\n  <ChevronRight className=\"ml-auto h-4 w-4\" />\n </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.SubContent>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n <MenubarPrimitive.SubContent\n  ref={ref}\n  className={cn(\n  \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n   className\n  )}\n  {...props}\n />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n (\n  { className, align =\"start\", alignOffset = -4, sideOffset = 8, ...props },\n  ref\n ) => (\n  <MenubarPrimitive.Portal>\n   <MenubarPrimitive.Content\n    ref={ref}\n    align={align}\n    alignOffset={alignOffset}\n    sideOffset={sideOffset}\n    className={cn(\n    \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n     className\n    )}\n    {...props}\n   />\n  </MenubarPrimitive.Portal>\n )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <MenubarPrimitive.Item\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n <MenubarPrimitive.CheckboxItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  checked={checked}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <MenubarPrimitive.ItemIndicator>\n    <Check className=\"h-4 w-4\" />\n   </MenubarPrimitive.ItemIndicator>\n  </span>\n  {children}\n </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n <MenubarPrimitive.RadioItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <MenubarPrimitive.ItemIndicator>\n    <Circle className=\"h-2 w-2 fill-current\" />\n   </MenubarPrimitive.ItemIndicator>\n  </span>\n  {children}\n </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Label>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <MenubarPrimitive.Label\n  ref={ref}\n  className={cn(\n  \"px-2 py-1.5 text-sm font-semibold\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n React.ElementRef<typeof MenubarPrimitive.Separator>,\n React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n <MenubarPrimitive.Separator\n  ref={ref}\n  className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n  {...props}\n />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n return (\n  <span\n   className={cn(\n   \"ml-auto text-xs tracking-widest text-muted-foreground\",\n    className\n   )}\n   {...props}\n  />\n )\n}\nMenubarShortcut.displayname =\"MenubarShortcut\"\n\nexport {\n Menubar,\n MenubarMenu,\n MenubarTrigger,\n MenubarContent,\n MenubarItem,\n MenubarSeparator,\n MenubarLabel,\n MenubarCheckboxItem,\n MenubarRadioGroup,\n MenubarRadioItem,\n MenubarPortal,\n MenubarSubContent,\n MenubarSubTrigger,\n MenubarGroup,\n MenubarSub,\n MenubarShortcut,\n}\n","path":null,"size_bytes":8265,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from\"wouter\";\nimport { useEffect } from \"react\";\nimport { queryClient } from\"./lib/queryClient\";\nimport { QueryClientProvider } from\"@tanstack/react-query\";\nimport { Toaster } from\"./components/ui/toaster\";\nimport { TooltipProvider } from\"./components/ui/tooltip\";\nimport { UserProvider } from\"./lib/userContext\";\nimport { ThemeProvider } from\"./components/theme-provider\";\nimport { useAuth } from\"./hooks/useAuth\";\n// Lazy load pages for better mobile performance\nimport { lazy, Suspense, startTransition } from 'react';\nimport { Card } from\"./components/ui/card\";\n\nconst Dashboard = lazy(() => import(\"./pages/dashboard\"));\nconst Welcome = lazy(() => import(\"./pages/welcome\"));\nconst Groups = lazy(() => import(\"./pages/groups\"));\nconst FinancialGoals = lazy(() => import(\"./pages/financial-goals\"));\nconst MoneyTracking = lazy(() => import(\"./pages/money-tracking\"));\nconst Settings = lazy(() => import(\"./pages/settings\"));\nconst Subscription = lazy(() => import(\"./pages/subscription\"));\nconst Checkout = lazy(() => import(\"./pages/checkout\"));\nconst Upgrade = lazy(() => import(\"./pages/upgrade\"));\nconst Pricing = lazy(() => import(\"./pages/pricing\"));\nconst AIAssistant = lazy(() => import(\"./pages/ai-assistant\"));\nconst Referrals = lazy(() => import(\"./pages/referrals\"));\nconst Friends = lazy(() => import(\"./pages/friends\"));\nconst InvitePage = lazy(() => import(\"./pages/invite\"));\nconst NotFound = lazy(() => import(\"./pages/not-found\"));\nconst Landing = lazy(() => import(\"./pages/landing.tsx\"));\nconst Login = lazy(() => import(\"./pages/login.tsx\"));\nconst Terms = lazy(() => import(\"./pages/terms\"));\nconst Privacy = lazy(() => import(\"./pages/privacy\"));\nconst SharePage = lazy(() => import(\"./pages/share\"));\n// Lazy-load heavy shell components for faster page transitions\nconst FloatingAIWidget = lazy(() => import(\"./components/ai/floating-ai-widget\"));\nconst MilestoneCelebration = lazy(() => import(\"./components/milestone-celebration\"));\nconst CommandPalette = lazy(() => import(\"./components/command-palette\"));\nconst ProductTour = lazy(() => import(\"./components/product-tour\"));\n\n// Loading component for lazy-loaded routes - simplified for React 18 compatibility\nconst PageLoader = () => (\n <div className=\"flex items-center justify-center min-h-[400px] p-4\">\n  <div className=\"flex flex-col items-center space-y-4\">\n   <div className=\"relative\">\n    <div className=\"rounded-full h-12 w-12 border-4 border-primary/30\"></div>\n   </div>\n   <div className=\"text-center space-y-1\">\n    <span className=\"text-sm font-medium text-foreground\">Loading...</span>\n    <p className=\"text-xs text-muted-foreground\">Please wait</p>\n   </div>\n  </div>\n </div>\n);\n\n// Redirect component for legacy routes\nfunction Redirect({ to }: { to: string }) {\n const [, setLocation] = useLocation();\n useEffect(() => {\n  setLocation(to);\n }, [to, setLocation]);\n return null;\n}\n\nimport Sidebar from\"./components/sidebar\";\nimport MobileNavigation from\"./components/mobile-navigation\";\nimport MobileHeader from\"./components/mobile-header\";\nimport ErrorBoundary from\"./components/error-boundary\";\nimport { OnboardingRedirect } from\"./components/onboarding-redirect\";\nimport { OfflineIndicator } from\"./components/pwa/offline-indicator\";\nimport { PWAInstallPrompt } from\"./components/pwa/install-prompt\";\nimport { RTLProvider } from\"./components/rtl-provider\";\nimport { SidebarProvider } from\"./components/ui/sidebar\";\n\nfunction Router() {\n const [location] = useLocation();\n const { isAuthenticated, isLoading } = useAuth();\n \n // Show loading screen while checking authentication\n if (isLoading) {\n  return <PageLoader />;\n }\n \n \n // Show login/landing page for unauthenticated users\n if (!isAuthenticated) {\n  return (\n   <main className=\"min-h-screen\">\n    <ErrorBoundary>\n     <Suspense fallback={<PageLoader />}>\n      <Switch>\n       <Route path=\"/login\" component={Login} />\n       <Route path=\"/pricing\" component={Pricing} />\n       <Route path=\"/terms\" component={Terms} />\n       <Route path=\"/privacy\" component={Privacy} />\n       <Route path=\"/welcome\" component={Welcome} />\n       <Route path=\"/share\" component={SharePage} />\n       <Route path=\"/\" component={Landing} />\n       <Route component={Landing} />\n      </Switch>\n     </Suspense>\n    </ErrorBoundary>\n   </main>\n  );\n }\n \n // Authenticated routes with responsive navigation\n return (\n  <OnboardingRedirect>\n   <SidebarProvider>\n    {/* Skip to main content link for keyboard navigation */}\n    <a \n     href=\"#main-content\" \n     onClick={(e) => {\n      e.preventDefault();\n      const main = document.getElementById('main-content');\n      if (main) {\n       main.setAttribute('tabindex', '-1');\n       main.focus();\n       main.removeAttribute('tabindex');\n      }\n     }}\n     className=\"sr-only focus:not-sr-only focus:absolute focus:z-[100] focus:top-4 focus:left-4 bg-primary text-primary-foreground focus:px-4 focus:py-2 focus:rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 px-4 py-2\"\n     data-testid=\"link-skip-to-main\"\n    >\n     Skip to main content\n    </a>\n    <div className=\"flex min-h-screen bg-background w-full max-w-full overflow-x-hidden\">\n     {/* Sidebar - uses Sheet on mobile, fixed sidebar on desktop */}\n     {location !==\"/welcome\" && <Sidebar />}\n     \n     {/* Main Content Area */}\n     <main id=\"main-content\" className={`flex-1 overflow-auto ${location !==\"/welcome\" ?\"pt-16 md:pt-0 pb-20 md:pb-0\" :\"\"}`}>\n      {/* Mobile Header - sticky at top on mobile only */}\n      {location !==\"/welcome\" && <MobileHeader />}\n      \n      <ErrorBoundary>\n       <Suspense fallback={<PageLoader />}>\n        <Switch>\n         <Route path=\"/\" component={Dashboard} />\n         <Route path=\"/welcome\" component={Welcome} />\n         <Route path=\"/invite/:token\" component={InvitePage} />\n         <Route path=\"/groups\" component={Groups} />\n         <Route path=\"/financial-goals\" component={FinancialGoals} />\n         <Route path=\"/money-tracking\" component={MoneyTracking} />\n         <Route path=\"/friends\" component={Friends} />\n         <Route path=\"/ai-assistant\" component={AIAssistant} />\n         <Route path=\"/referrals\" component={Referrals} />\n         <Route path=\"/subscription\" component={Subscription} />\n         <Route path=\"/checkout/:planId\" component={Checkout} />\n         <Route path=\"/upgrade\" component={Upgrade} />\n         <Route path=\"/pricing\" component={Pricing} />\n         <Route path=\"/settings\" component={Settings} />\n         <Route path=\"/financial-profile\"><Redirect to=\"/money-tracking\" /></Route>\n         <Route path=\"/planning\"><Redirect to=\"/financial-goals\" /></Route>\n         <Route path=\"/terms\" component={Terms} />\n         <Route path=\"/privacy\" component={Privacy} />\n         <Route path=\"/share\" component={SharePage} />\n         <Route component={NotFound} />\n        </Switch>\n       </Suspense>\n      </ErrorBoundary>\n     </main>\n     \n     {/* Mobile Navigation - shown only on mobile and not on welcome page */}\n     {location !==\"/welcome\" && <MobileNavigation />}\n     \n     {/* Lazy-loaded shell components - wrapped in Suspense for non-blocking navigation */}\n     <Suspense fallback={null}>\n      {/* Floating AI Widget - accessible from any page except welcome */}\n      {location !==\"/welcome\" && <FloatingAIWidget />}\n      \n      {/* Milestone Celebration - shows when user reaches goal milestones */}\n      <MilestoneCelebration />\n      \n      {/* Command Palette - Cmd+K for power users */}\n      {location !==\"/welcome\" && <CommandPalette />}\n      \n      {/* Product Tour - Onboarding for new users */}\n      {location !==\"/welcome\" && <ProductTour />}\n     </Suspense>\n    </div>\n   </SidebarProvider>\n  </OnboardingRedirect>\n );\n}\n\nfunction App() {\n return (\n  <QueryClientProvider client={queryClient}>\n   <UserProvider>\n    <ThemeProvider defaultTheme=\"system\" storageKey=\"twealth-theme\">\n     <RTLProvider>\n      <TooltipProvider>\n       <Toaster />\n       <OfflineIndicator />\n       <PWAInstallPrompt />\n       <ErrorBoundary>\n        <Router />\n       </ErrorBoundary>\n      </TooltipProvider>\n     </RTLProvider>\n    </ThemeProvider>\n   </UserProvider>\n  </QueryClientProvider>\n );\n}\n\nexport default App;\n","path":null,"size_bytes":8255,"size_tokens":null},"client/src/components/settings/user-preferences.tsx":{"content":"import { useState, useEffect } from\"react\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Switch } from\"@/components/ui/switch\";\nimport { Input } from\"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useTheme } from\"@/components/theme-provider\";\nimport { UserPreferences } from\"@shared/schema\";\nimport { \n Palette, \n Moon, \n Sun, \n Monitor, \n Bell, \n BellOff, \n Languages, \n Eye,\n Smartphone,\n Layout,\n Zap,\n Settings as SettingsIcon,\n CheckCircle,\n Loader2,\n DollarSign,\n TrendingUp,\n Wallet,\n MapPin\n} from\"lucide-react\";\n\ninterface UserPreferencesProps {}\n\nexport default function UserPreferencesSettings({ }: UserPreferencesProps) {\n const { toast } = useToast();\n const { setTheme } = useTheme();\n const [financialData, setFinancialData] = useState({\n  monthlyIncome:\"\",\n  monthlyExpenses:\"\",\n  currentSavings:\"\"\n });\n\n const { data: preferences, isLoading } = useQuery<UserPreferences>({\n  queryKey: ['/api/user-preferences'],\n });\n\n useEffect(() => {\n  if (preferences) {\n   setFinancialData({\n    monthlyIncome: preferences.monthlyIncomeEstimate?.toString() ||\"\",\n    monthlyExpenses: preferences.monthlyExpensesEstimate?.toString() ||\"\",\n    currentSavings: preferences.currentSavingsEstimate?.toString() ||\"\"\n   });\n  }\n }, [preferences]);\n\n const updatePreferencesMutation = useMutation({\n  mutationFn: (updates: Partial<UserPreferences>) =>\n   apiRequest('PUT', '/api/user-preferences', updates),\n  onMutate: async (updates) => {\n   await queryClient.cancelQueries({ queryKey: ['/api/user-preferences'] });\n   const previousPreferences = queryClient.getQueryData<UserPreferences>(['/api/user-preferences']);\n   \n   if (previousPreferences) {\n    queryClient.setQueryData<UserPreferences>(['/api/user-preferences'], {\n     ...previousPreferences,\n     ...updates,\n    });\n   }\n   \n   return { previousPreferences };\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: ['/api/user-preferences'] });\n   toast({\n    title:\"Preferences updated\",\n    description:\"Your preferences have been saved successfully.\",\n   });\n  },\n  onError: (error, variables, context) => {\n   if (context?.previousPreferences) {\n    queryClient.setQueryData(['/api/user-preferences'], context.previousPreferences);\n   }\n   toast({\n    title:\"Error\",\n    description:\"Failed to update preferences. Please try again.\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const themes = [\n  { value:\"light\", label:\"Light\", icon: Sun, description:\"Clean, bright interface\" },\n  { value:\"dark\", label:\"Dark\", icon: Moon, description:\"Easy on the eyes\" },\n  { value:\"system\", label:\"System\", icon: Monitor, description:\"Follows device setting\" }\n ];\n\n const languages = [\n  { value:\"en\", label:\"English\" },\n  { value:\"es\", label:\"Español\" },\n  { value:\"th\", label:\"ไทย\" },\n  { value:\"id\", label:\"Bahasa Indonesia\" },\n  { value:\"pt\", label:\"Português\" },\n  { value:\"hi\", label:\"हिन्दी\" },\n  { value:\"vi\", label:\"Tiếng Việt\" },\n  { value:\"tl\", label:\"Filipino\" },\n  { value:\"ms\", label:\"Bahasa Melayu\" },\n  { value:\"tr\", label:\"Türkçe\" }\n ];\n\n const currencies = [\n  { value:\"USD\", label:\"US Dollar\", symbol:\"$\" },\n  { value:\"THB\", label:\"Thai Baht\", symbol:\"฿\" },\n  { value:\"EUR\", label:\"Euro\", symbol:\"€\" },\n  { value:\"IDR\", label:\"Indonesian Rupiah\", symbol:\"Rp\" },\n  { value:\"VND\", label:\"Vietnamese Dong\", symbol:\"₫\" },\n  { value:\"INR\", label:\"Indian Rupee\", symbol:\"₹\" },\n  { value:\"PHP\", label:\"Philippine Peso\", symbol:\"₱\" },\n  { value:\"BRL\", label:\"Brazilian Real\", symbol:\"R$\" },\n  { value:\"MYR\", label:\"Malaysian Ringgit\", symbol:\"RM\" },\n  { value:\"MXN\", label:\"Mexican Peso\", symbol:\"$\" },\n  { value:\"TRY\", label:\"Turkish Lira\", symbol:\"₺\" },\n  { value:\"GBP\", label:\"British Pound\", symbol:\"£\" },\n  { value:\"JPY\", label:\"Japanese Yen\", symbol:\"¥\" },\n  { value:\"CAD\", label:\"Canadian Dollar\", symbol:\"C$\" },\n  { value:\"AUD\", label:\"Australian Dollar\", symbol:\"A$\" }\n ];\n\n const countries = [\n  { value: \"US\", label: \"United States\", flag: \"🇺🇸\" },\n  { value: \"GB\", label: \"United Kingdom\", flag: \"🇬🇧\" },\n  { value: \"CA\", label: \"Canada\", flag: \"🇨🇦\" },\n  { value: \"AU\", label: \"Australia\", flag: \"🇦🇺\" },\n  { value: \"DE\", label: \"Germany\", flag: \"🇩🇪\" },\n  { value: \"FR\", label: \"France\", flag: \"🇫🇷\" },\n  { value: \"IT\", label: \"Italy\", flag: \"🇮🇹\" },\n  { value: \"ES\", label: \"Spain\", flag: \"🇪🇸\" },\n  { value: \"NL\", label: \"Netherlands\", flag: \"🇳🇱\" },\n  { value: \"CH\", label: \"Switzerland\", flag: \"🇨🇭\" },\n  { value: \"SE\", label: \"Sweden\", flag: \"🇸🇪\" },\n  { value: \"NO\", label: \"Norway\", flag: \"🇳🇴\" },\n  { value: \"DK\", label: \"Denmark\", flag: \"🇩🇰\" },\n  { value: \"AT\", label: \"Austria\", flag: \"🇦🇹\" },\n  { value: \"BE\", label: \"Belgium\", flag: \"🇧🇪\" },\n  { value: \"PT\", label: \"Portugal\", flag: \"🇵🇹\" },\n  { value: \"IE\", label: \"Ireland\", flag: \"🇮🇪\" },\n  { value: \"PL\", label: \"Poland\", flag: \"🇵🇱\" },\n  { value: \"JP\", label: \"Japan\", flag: \"🇯🇵\" },\n  { value: \"CN\", label: \"China\", flag: \"🇨🇳\" },\n  { value: \"KR\", label: \"South Korea\", flag: \"🇰🇷\" },\n  { value: \"SG\", label: \"Singapore\", flag: \"🇸🇬\" },\n  { value: \"HK\", label: \"Hong Kong\", flag: \"🇭🇰\" },\n  { value: \"TW\", label: \"Taiwan\", flag: \"🇹🇼\" },\n  { value: \"TH\", label: \"Thailand\", flag: \"🇹🇭\" },\n  { value: \"VN\", label: \"Vietnam\", flag: \"🇻🇳\" },\n  { value: \"ID\", label: \"Indonesia\", flag: \"🇮🇩\" },\n  { value: \"MY\", label: \"Malaysia\", flag: \"🇲🇾\" },\n  { value: \"PH\", label: \"Philippines\", flag: \"🇵🇭\" },\n  { value: \"IN\", label: \"India\", flag: \"🇮🇳\" },\n  { value: \"AE\", label: \"UAE\", flag: \"🇦🇪\" },\n  { value: \"SA\", label: \"Saudi Arabia\", flag: \"🇸🇦\" },\n  { value: \"IL\", label: \"Israel\", flag: \"🇮🇱\" },\n  { value: \"TR\", label: \"Turkey\", flag: \"🇹🇷\" },\n  { value: \"RU\", label: \"Russia\", flag: \"🇷🇺\" },\n  { value: \"BR\", label: \"Brazil\", flag: \"🇧🇷\" },\n  { value: \"MX\", label: \"Mexico\", flag: \"🇲🇽\" },\n  { value: \"AR\", label: \"Argentina\", flag: \"🇦🇷\" },\n  { value: \"CL\", label: \"Chile\", flag: \"🇨🇱\" },\n  { value: \"CO\", label: \"Colombia\", flag: \"🇨🇴\" },\n  { value: \"ZA\", label: \"South Africa\", flag: \"🇿🇦\" },\n  { value: \"NG\", label: \"Nigeria\", flag: \"🇳🇬\" },\n  { value: \"EG\", label: \"Egypt\", flag: \"🇪🇬\" },\n  { value: \"NZ\", label: \"New Zealand\", flag: \"🇳🇿\" },\n ];\n\n const handleThemeChange = (theme:\"light\" |\"dark\" |\"system\") => {\n  setTheme(theme);\n  queryClient.setQueryData<UserPreferences>(['/api/user-preferences'], (old) => {\n   if (!old) return old;\n   return { ...old, theme };\n  });\n  updatePreferencesMutation.mutate({ theme });\n };\n\n const handleNotificationToggle = (field: keyof UserPreferences) => {\n  if (!preferences) return;\n  updatePreferencesMutation.mutate({ \n   [field]: !preferences[field] \n  });\n };\n\n const handleLanguageChange = (language: string) => {\n  updatePreferencesMutation.mutate({ language });\n };\n\n const handleCurrencyChange = (currency: string) => {\n  updatePreferencesMutation.mutate({ currency });\n };\n\n const handleCountryChange = (countryCode: string) => {\n  updatePreferencesMutation.mutate({ countryCode });\n };\n\n const handleFinancialDataChange = (field: string, value: string) => {\n  setFinancialData(prev => ({ ...prev, [field]: value }));\n };\n\n const handleSaveFinancialData = () => {\n  const updates: Partial<UserPreferences> = {};\n  \n  if (financialData.monthlyIncome) {\n   updates.monthlyIncomeEstimate = financialData.monthlyIncome;\n  }\n  if (financialData.monthlyExpenses) {\n   updates.monthlyExpensesEstimate = financialData.monthlyExpenses;\n  }\n  if (financialData.currentSavings) {\n   updates.currentSavingsEstimate = financialData.currentSavings;\n  }\n\n  if (Object.keys(updates).length > 0) {\n   updatePreferencesMutation.mutate(updates);\n  } else {\n   toast({\n    title:\"No changes\",\n    description:\"Please enter your financial information first.\",\n    variant:\"destructive\",\n   });\n  }\n };\n\n const handleSaveAll = async () => {\n  try {\n   await queryClient.refetchQueries({ queryKey: ['/api/user-preferences'] });\n   toast({\n    title:\"Settings synchronized\",\n    description:\"Your preferences have been refreshed from the server.\",\n   });\n  } catch (error) {\n   toast({\n    title:\"Sync failed\",\n    description:\"Could not refresh settings. Please try again.\",\n    variant:\"destructive\",\n   });\n  }\n };\n\n if (isLoading) {\n  return (\n   <div className=\"flex items-center justify-center p-8 sm:p-12\">\n    <Loader2 className=\"animate-spin mr-2 w-6 h-6 sm:w-8 sm:h-8 text-blue-600\" />\n    <span className=\"text-base sm:text-lg text-slate-600 dark:text-slate-400\">Loading preferences...</span>\n   </div>\n  );\n }\n\n if (!preferences) {\n  return (\n   <div className=\"text-center p-8 sm:p-12\">\n    <p className=\"text-base sm:text-lg text-slate-600 dark:text-slate-400\">Failed to load preferences</p>\n   </div>\n  );\n }\n\n return (\n  <div className=\"space-y-4 sm:space-y-6\">\n   {/* Theme & Appearance */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Palette className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" />\n      Theme & Appearance\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Customize your interface colors and style\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-6\">\n     <div className=\"space-y-3 sm:space-y-4\">\n      <h4 className=\"font-medium text-sm sm:text-base text-slate-700 dark:text-slate-300\">Theme Mode</h4>\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4\">\n       {themes.map((theme) => (\n        <button\n         key={theme.value}\n         data-testid={`theme-${theme.value}`}\n         onClick={() => handleThemeChange(theme.value as\"light\" |\"dark\" |\"system\")}\n         disabled={updatePreferencesMutation.isPending}\n         className={`min-h-[88px] sm:min-h-[100px] p-4 sm:p-5 rounded-xl border-2 transition-all ${\n          preferences.theme === theme.value \n           ? 'border-blue-600 bg-blue-50 dark:bg-blue-950/30 shadow-md' \n           : 'border-slate-200 dark:border-slate-700 hover:border-blue-400 dark:hover:border-blue-600 bg-white dark:bg-slate-800/50'\n         } ${updatePreferencesMutation.isPending ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer[1.02]'}`}\n        >\n         <div className=\"flex items-center justify-center mb-2 sm:mb-3\">\n          <theme.icon className={`w-6 h-6 sm:w-7 sm:h-7 ${preferences.theme === theme.value ? 'text-blue-600' : 'text-slate-400'}`} />\n         </div>\n         <h4 className=\"font-semibold text-sm sm:text-base text-slate-900 dark:text-white\">{theme.label}</h4>\n         <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400 mt-1\">{theme.description}</p>\n        </button>\n       ))}\n      </div>\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Notifications - Mobile-Optimized */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Bell className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" />\n      Notifications\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Manage how you receive alerts and updates\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-3 sm:space-y-4\">\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <CheckCircle className=\"text-green-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Goal Progress</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Notify when goals reach milestones</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-goal-reminders\"\n       checked={preferences.goalReminders ?? true}\n       onCheckedChange={() => handleNotificationToggle('goalReminders')}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <SettingsIcon className=\"text-blue-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Expense Alerts</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Alert for large expenses and income</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-expense-alerts\"\n       checked={preferences.expenseAlerts ?? true}\n       onCheckedChange={() => handleNotificationToggle('expenseAlerts')}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <Smartphone className=\"text-blue-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Weekly Reports</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Weekly financial insights and tips</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-weekly-reports\"\n       checked={preferences.weeklyReports ?? true}\n       onCheckedChange={() => handleNotificationToggle('weeklyReports')}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <Bell className=\"text-orange-600 w-5 h-5 mt-0.5 flex-shrink-0\" />\n       <div>\n        <p className=\"font-medium text-sm sm:text-base text-slate-900 dark:text-white\">Email Notifications</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Receive updates via email</p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-email-notifications\"\n       checked={preferences.emailNotifications ?? true}\n       onCheckedChange={() => handleNotificationToggle('emailNotifications')}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Language & Region - Mobile-Optimized */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Languages className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600\" />\n      Language & Region\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Set your country, language, and currency for personalized financial advice\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-4 sm:space-y-6\">\n     {/* Country selector with importance callout */}\n     <div className=\"bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-xl p-4\">\n      <div className=\"flex items-start gap-3\">\n       <MapPin className=\"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5\" />\n       <div className=\"text-sm text-blue-900 dark:text-blue-200\">\n        <p className=\"font-semibold mb-1\">Why your country matters</p>\n        <p className=\"text-xs sm:text-sm\">\n         Your country determines local tax rates, cost of living, and luxury goods pricing that the AI uses for accurate financial advice.\n        </p>\n       </div>\n      </div>\n     </div>\n\n     <div className=\"space-y-2\">\n      <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\n       <MapPin className=\"w-4 h-4 text-blue-600\" />\n       Your Country\n      </label>\n      <Select \n       value={preferences.countryCode ?? \"US\"} \n       onValueChange={handleCountryChange}\n       disabled={updatePreferencesMutation.isPending}\n      >\n       <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-country\">\n        <SelectValue placeholder=\"Select your country\" />\n       </SelectTrigger>\n       <SelectContent className=\"max-h-[300px]\">\n        {countries.map((country) => (\n         <SelectItem key={country.value} value={country.value}>\n          <div className=\"flex items-center gap-2 py-1\">\n           <span className=\"text-base\">{country.flag}</span>\n           <span className=\"text-sm sm:text-base\">{country.label}</span>\n          </div>\n         </SelectItem>\n        ))}\n       </SelectContent>\n      </Select>\n     </div>\n\n     <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6\">\n      <div className=\"space-y-2\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Language</label>\n       <Select \n        value={preferences.language ??\"en\"} \n        onValueChange={handleLanguageChange}\n        disabled={updatePreferencesMutation.isPending}\n       >\n        <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-language\">\n         <SelectValue />\n        </SelectTrigger>\n        <SelectContent>\n         {languages.map((lang) => (\n          <SelectItem key={lang.value} value={lang.value}>\n           <span className=\"text-sm sm:text-base\">{lang.label}</span>\n          </SelectItem>\n         ))}\n        </SelectContent>\n       </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Default Currency</label>\n       <Select \n        value={preferences.currency ??\"USD\"} \n        onValueChange={handleCurrencyChange}\n        disabled={updatePreferencesMutation.isPending}\n       >\n        <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-currency\">\n         <SelectValue />\n        </SelectTrigger>\n        <SelectContent>\n         {currencies.map((curr) => (\n          <SelectItem key={curr.value} value={curr.value}>\n           <div className=\"flex items-center gap-2 py-1\">\n            <span className=\"text-sm sm:text-base\">{curr.label}</span>\n            <span className=\"text-xs sm:text-sm text-slate-500\">({curr.symbol})</span>\n           </div>\n          </SelectItem>\n         ))}\n        </SelectContent>\n       </Select>\n      </div>\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Financial Profile - New Section */}\n   <Card className=\"border-2 border-green-200 dark:border-green-900/50 shadow-sm hover:shadow-md transition-shadow bg-white dark:bg-gray-900\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <DollarSign className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600\" />\n      Financial Profile\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Set your income, expenses, and savings to unlock personalized AI insights\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-4 sm:space-y-6\">\n     <div className=\"bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-xl p-4\">\n      <div className=\"flex items-start gap-3\">\n       <TrendingUp className=\"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5\" />\n       <div className=\"text-sm text-blue-900 dark:text-blue-200\">\n        <p className=\"font-semibold mb-1\">Why this matters</p>\n        <p className=\"text-xs sm:text-sm\">\n         Your financial data powers the AI Insights page, providing personalized budget recommendations and net worth projections based on your actual situation.\n        </p>\n       </div>\n      </div>\n     </div>\n\n     <div className=\"space-y-4\">\n      <div className=\"space-y-2\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\n        <Wallet className=\"w-4 h-4 text-green-600\" />\n        Monthly Income\n       </label>\n       <div className=\"relative\">\n        <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-lg text-muted-foreground\">\n         {preferences?.currency === 'USD' ? '$' : \n          preferences?.currency === 'EUR' ? '€' : \n          preferences?.currency === 'GBP' ? '£' : \n          preferences?.currency === 'JPY' ? '¥' : '$'}\n        </span>\n        <Input\n         type=\"number\"\n         step=\"0.01\"\n         min=\"0\"\n         value={financialData.monthlyIncome}\n         onChange={(e) => handleFinancialDataChange('monthlyIncome', e.target.value)}\n         placeholder=\"5000\"\n         className=\"h-12 pl-8 text-base bg-white dark:bg-slate-900\"\n         data-testid=\"input-monthly-income\"\n        />\n       </div>\n      </div>\n\n      <div className=\"space-y-2\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\n        <TrendingUp className=\"w-4 h-4 text-orange-600\" />\n        Monthly Expenses\n       </label>\n       <div className=\"relative\">\n        <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-lg text-muted-foreground\">\n         {preferences?.currency === 'USD' ? '$' : \n          preferences?.currency === 'EUR' ? '€' : \n          preferences?.currency === 'GBP' ? '£' : \n          preferences?.currency === 'JPY' ? '¥' : '$'}\n        </span>\n        <Input\n         type=\"number\"\n         step=\"0.01\"\n         min=\"0\"\n         value={financialData.monthlyExpenses}\n         onChange={(e) => handleFinancialDataChange('monthlyExpenses', e.target.value)}\n         placeholder=\"3000\"\n         className=\"h-12 pl-8 text-base bg-white dark:bg-slate-900\"\n         data-testid=\"input-monthly-expenses\"\n        />\n       </div>\n      </div>\n\n      <div className=\"space-y-2\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2\">\n        <DollarSign className=\"w-4 h-4 text-blue-600\" />\n        Current Savings\n       </label>\n       <div className=\"relative\">\n        <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-lg text-muted-foreground\">\n         {preferences?.currency === 'USD' ? '$' : \n          preferences?.currency === 'EUR' ? '€' : \n          preferences?.currency === 'GBP' ? '£' : \n          preferences?.currency === 'JPY' ? '¥' : '$'}\n        </span>\n        <Input\n         type=\"number\"\n         step=\"0.01\"\n         min=\"0\"\n         value={financialData.currentSavings}\n         onChange={(e) => handleFinancialDataChange('currentSavings', e.target.value)}\n         placeholder=\"10000\"\n         className=\"h-12 pl-8 text-base bg-white dark:bg-slate-900\"\n         data-testid=\"input-current-savings\"\n        />\n       </div>\n      </div>\n     </div>\n\n     <Button\n      onClick={handleSaveFinancialData}\n      disabled={updatePreferencesMutation.isPending}\n      className=\"w-full h-12 text-base bg-primary text-primary-foreground shadow-lg hover:shadow-xl transition-all font-semibold\"\n      data-testid=\"button-save-financial-profile\"\n     >\n      {updatePreferencesMutation.isPending ? (\n       <>\n        <Loader2 className=\"mr-2 w-5 h-5\" />\n        Saving...\n       </>\n      ) : (\n       <>\n        <CheckCircle className=\"mr-2 w-5 h-5\" />\n        Save Financial Profile\n       </>\n      )}\n     </Button>\n\n     {(financialData.monthlyIncome && financialData.monthlyExpenses) && (\n      <div className=\"bg-white dark:bg-gray-900 border border-blue-200 dark:border-blue-800 rounded-xl p-4\">\n       <p className=\"text-sm font-medium text-blue-900 dark:text-blue-200\">\n        Monthly Surplus: {preferences?.currency === 'USD' ? '$' : ''}\n        {(parseFloat(financialData.monthlyIncome) - parseFloat(financialData.monthlyExpenses)).toFixed(2)}\n       </p>\n      </div>\n     )}\n    </CardContent>\n   </Card>\n\n   {/* Crypto & Advanced Features */}\n   <Card className=\"border-2 border-yellow-200 dark:border-yellow-900/50 shadow-sm hover:shadow-md transition-shadow bg-white dark:bg-gray-900\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Zap className=\"w-5 h-5 sm:w-6 sm:h-6 text-yellow-600\" />\n      Advanced Financial Features\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Enable cryptocurrency tracking and multi-currency wealth analysis\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-6\">\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[72px] p-4 sm:p-5 bg-white dark:bg-gray-900 rounded-xl border-2 border-yellow-300/50 dark:border-yellow-700/50\">\n      <div className=\"flex items-start gap-3 mb-3 sm:mb-0\">\n       <div className=\"bg-yellow-200 dark:bg-yellow-900/50 p-2 rounded-lg flex-shrink-0\">\n        <Zap className=\"text-yellow-700 dark:text-yellow-400 w-5 h-5\" />\n       </div>\n       <div>\n        <p className=\"font-semibold text-sm sm:text-base text-slate-900 dark:text-white\">Enable Crypto Features</p>\n        <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400 mt-0.5\">\n         Track Bitcoin, gold, and alternative currencies\n        </p>\n       </div>\n      </div>\n      <Switch \n       data-testid=\"switch-crypto-enabled\"\n       checked={preferences.cryptoEnabled ?? false}\n       onCheckedChange={(checked) => updatePreferencesMutation.mutate({ cryptoEnabled: checked })}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     {preferences.cryptoEnabled && (\n      <div className=\"space-y-3 sm:space-y-4-50\">\n       <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Experience Level</label>\n       <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4\">\n        {[\n         { value:\"beginner\", label:\"Beginner\", description:\"Simple interface\", icon: Eye },\n         { value:\"intermediate\", label:\"Intermediate\", description:\"Standard tracking\", icon: Layout },\n         { value:\"advanced\", label:\"Advanced\", description:\"Full analytics\", icon: Zap }\n        ].map((level) => (\n         <button\n          key={level.value}\n          data-testid={`experience-${level.value}`}\n          onClick={() => updatePreferencesMutation.mutate({ experienceLevel: level.value as\"beginner\" |\"intermediate\" |\"advanced\" })}\n          disabled={updatePreferencesMutation.isPending}\n          className={`min-h-[88px] p-4 rounded-xl border-2 transition-all ${\n           preferences.experienceLevel === level.value \n            ? 'border-yellow-600 bg-yellow-50 dark:bg-yellow-950/30 shadow-md' \n            : 'border-slate-200 dark:border-slate-700 hover:border-yellow-400 dark:hover:border-yellow-600 bg-white dark:bg-slate-800/50'\n          } ${updatePreferencesMutation.isPending ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer[1.02]'}`}\n         >\n          <div className=\"flex items-center justify-center mb-2\">\n           <level.icon className={`w-5 h-5 sm:w-6 sm:h-6 ${preferences.experienceLevel === level.value ? 'text-yellow-600' : 'text-slate-400'}`} />\n          </div>\n          <h4 className=\"font-semibold text-xs sm:text-sm text-slate-900 dark:text-white\">{level.label}</h4>\n          <p className=\"text-xs text-slate-600 dark:text-slate-400 mt-1\">{level.description}</p>\n         </button>\n        ))}\n       </div>\n      </div>\n     )}\n    </CardContent>\n   </Card>\n\n   {/* Save Button - Mobile-Optimized */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm\">\n    <CardContent className=\"p-4 sm:p-6\">\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n      <div>\n       <h4 className=\"font-semibold text-base sm:text-lg text-slate-900 dark:text-white\">Save Preferences</h4>\n       <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400 mt-1\">\n        {updatePreferencesMutation.isPending ? 'Saving...' : 'Settings are saved automatically'}\n       </p>\n      </div>\n      <Button \n       data-testid=\"button-save-preferences\"\n       onClick={handleSaveAll}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"w-full sm:w-auto h-12 sm:h-14 text-base bg-primary text-primary-foreground shadow-lg hover:shadow-xl transition-all font-semibold\"\n      >\n       {updatePreferencesMutation.isPending ? (\n        <>\n         <Loader2 className=\"mr-2 w-5 h-5\" />\n         Saving...\n        </>\n       ) : (\n        <>\n         <CheckCircle className=\"mr-2 w-5 h-5\" />\n         Sync Settings\n        </>\n       )}\n      </Button>\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}\n","path":null,"size_bytes":30033,"size_tokens":null},"client/src/components/forms/transaction-form.tsx":{"content":"import { useState } from\"react\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient, useQuery } from\"@tanstack/react-query\";\nimport { z } from\"zod\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Textarea } from\"@/components/ui/textarea\";\nimport { Label } from\"@/components/ui/label\";\nimport { DialogHeader, DialogTitle, DialogDescription } from\"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { useUser } from\"@/lib/userContext\";\nimport { Loader2, CheckCircle2, AlertCircle } from\"lucide-react\";\n\nconst transactionFormSchema = z.object({\n amount: z.string().min(1,\"Amount is required\").refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\"Must be a valid positive number\"),\n type: z.enum([\"income\",\"expense\",\"transfer\"]),\n category: z.string().optional(), // Optional - backend will auto-categorize if not provided\n description: z.string().optional(),\n goalId: z.string().optional(),\n destination: z.string().optional(),\n date: z.string().min(1,\"Date is required\"),\n});\n\ntype TransactionFormData = z.infer<typeof transactionFormSchema>;\n\ninterface TransactionFormProps {\n onSuccess?: () => void;\n}\n\nconst TRANSACTION_CATEGORIES = {\n income: [\n  { value:\"salary\", label:\"Salary\" },\n  { value:\"freelance\", label:\"Freelance\" },\n  { value:\"investment\", label:\"Investment Returns\" },\n  { value:\"gift\", label:\"Gift\" },\n  { value:\"other\", label:\"Other Income\" }\n ],\n expense: [\n  { value:\"rent\", label:\"Rent/Mortgage\" },\n  { value:\"utilities\", label:\"Utilities\" },\n  { value:\"groceries\", label:\"Groceries\" },\n  { value:\"dining\", label:\"Dining Out\" },\n  { value:\"transport\", label:\"Transportation\" },\n  { value:\"healthcare\", label:\"Healthcare\" },\n  { value:\"entertainment\", label:\"Entertainment\" },\n  { value:\"shopping\", label:\"Shopping\" },\n  { value:\"other\", label:\"Other Expenses\" }\n ],\n transfer: [\n  { value:\"savings\", label:\"Savings\" },\n  { value:\"investment\", label:\"Investment\" },\n  { value:\"goal_contribution\", label:\"Goal Contribution\" }\n ]\n};\n\nexport default function TransactionForm({ onSuccess }: TransactionFormProps) {\n const [isSubmitting, setIsSubmitting] = useState(false);\n const { toast } = useToast();\n const queryClient = useQueryClient();\n const { user, isLoading: userLoading } = useUser();\n\n const { data: goals } = useQuery({\n  queryKey: [\"/api/financial-goals\"],\n  queryFn: () => fetch(\"/api/financial-goals\").then(res => res.json()),\n });\n\n const {\n  register,\n  handleSubmit,\n  setValue,\n  watch,\n  formState: { errors },\n  reset,\n } = useForm<TransactionFormData>({\n  resolver: zodResolver(transactionFormSchema),\n  defaultValues: {\n   type:\"expense\",\n   date: new Date().toISOString().split('T')[0],\n  },\n });\n\n const selectedType = watch(\"type\");\n const selectedCategory = watch(\"category\");\n\n const createTransactionMutation = useMutation({\n  mutationFn: (data: TransactionFormData) => \n   apiRequest(\"POST\",\"/api/transactions\", {\n    ...data,\n    userId: user?.id, // Use actual user ID from context\n    amount: parseFloat(data.amount),\n    date: new Date(data.date).toISOString(),\n   }),\n  onMutate: async (newTransaction: TransactionFormData) => {\n   // Cancel outgoing refetches\n   await queryClient.cancelQueries({ queryKey: [\"/api/transactions\"] });\n   \n   // Snapshot previous data\n   const previousTransactions = queryClient.getQueryData([\"/api/transactions\"]);\n   \n   // Create optimistic transaction with temporary ID\n   const optimisticTransaction = {\n    id: `temp-${Date.now()}`,\n    userId: user?.id,\n    type: newTransaction.type,\n    amount: parseFloat(newTransaction.amount),\n    category: newTransaction.category,\n    description: newTransaction.description ||\"\",\n    date: new Date(newTransaction.date).toISOString(),\n    destination: newTransaction.destination,\n    goalId: newTransaction.goalId,\n    createdAt: new Date().toISOString(),\n   };\n   \n   // Optimistically update cache\n   queryClient.setQueryData([\"/api/transactions\"], (old: any) => \n    Array.isArray(old) ? [optimisticTransaction, ...old] : [optimisticTransaction]\n   );\n   \n   return { previousTransactions };\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n   toast({\n    title:\"Transaction added\",\n    description:\"Your transaction has been recorded successfully.\",\n    icon: <CheckCircle2 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n   });\n   onSuccess?.();\n  },\n  onError: (error: any, _variables, context) => {\n   // Rollback on error\n   if (context?.previousTransactions) {\n    queryClient.setQueryData([\"/api/transactions\"], context.previousTransactions);\n   }\n   \n   const isValidationError = error.message?.includes('validation') || error.message?.includes('required');\n   const isNetworkError = error.message?.includes('fetch') || error.message?.includes('network');\n   \n   toast({\n    title:\"Couldn't Add Transaction\",\n    description: isNetworkError \n     ?\"Check your internet connection and try again.\"\n     : isValidationError\n     ?\"Please check that all required fields are filled correctly.\"\n     : error.message ||\"Something went wrong. Please try again in a moment.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n  },\n  onSettled: () => {\n   setIsSubmitting(false);\n  },\n });\n\n const onSubmit = (data: TransactionFormData) => {\n  if (!user) {\n   toast({\n    title:\"Sign In Required\",\n    description:\"Please sign in to track your income and expenses.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n   return;\n  }\n  \n  // Validate date is not in the future\n  if (new Date(data.date) > new Date()) {\n   toast({\n    title:\"Invalid date\",\n    description:\"Transaction date cannot be in the future.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n   return;\n  }\n\n  setIsSubmitting(true);\n  createTransactionMutation.mutate(data);\n };\n\n // Reset category when type changes\n const handleTypeChange = (type: string) => {\n  setValue(\"type\", type as any);\n  setValue(\"category\",\"\");\n  setValue(\"goalId\", undefined);\n  setValue(\"destination\", undefined);\n };\n\n // Reset destination when category changes\n const handleCategoryChange = (category: string) => {\n  setValue(\"category\", category);\n  setValue(\"goalId\", undefined);\n  setValue(\"destination\", undefined);\n };\n\n const availableCategories = TRANSACTION_CATEGORIES[selectedType] || [];\n const activeGoals = goals?.filter((goal: any) => goal.status ===\"active\") || [];\n\n return (\n  <>\n   <DialogHeader>\n    <DialogTitle>Add Transaction</DialogTitle>\n    <DialogDescription>\n     Record a new income, expense, or transfer transaction\n    </DialogDescription>\n   </DialogHeader>\n   \n   <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-5\">\n    {/* Transaction Type - First Choice */}\n    <div>\n     <Label htmlFor=\"type\" className=\"text-base font-semibold\">Is this money in or out?</Label>\n     <Select value={selectedType} onValueChange={handleTypeChange}>\n      <SelectTrigger className=\"mt-2 h-12 text-base\" data-testid=\"select-transaction-type\">\n       <SelectValue />\n      </SelectTrigger>\n      <SelectContent>\n       <SelectItem value=\"income\">Money In (Income)</SelectItem>\n       <SelectItem value=\"expense\">Money Out (Expense)</SelectItem>\n       <SelectItem value=\"transfer\">Transfer/Savings</SelectItem>\n      </SelectContent>\n     </Select>\n     {errors.type && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.type.message}</p>\n     )}\n    </div>\n\n    {/* Amount - Most Important */}\n    <div>\n     <Label htmlFor=\"amount\" className=\"text-base font-semibold\">How much?</Label>\n     <div className=\"relative mt-2\">\n      <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-lg text-muted-foreground\">$</span>\n      <Input\n       id=\"amount\"\n       type=\"number\"\n       step=\"0.01\"\n       min=\"0\"\n       {...register(\"amount\")}\n       placeholder=\"0.00\"\n       className=\"h-12 pl-8 text-lg\"\n       data-testid=\"input-transaction-amount\"\n      />\n     </div>\n     {errors.amount && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.amount.message}</p>\n     )}\n    </div>\n\n    {/* Description/Merchant - For auto-categorization */}\n    <div>\n     <Label htmlFor=\"description\" className=\"text-base font-semibold\">\n      What's this for? <span className=\"text-sm font-normal text-muted-foreground\">(helps AI categorize)</span>\n     </Label>\n     <Input\n      id=\"description\"\n      {...register(\"description\")}\n      placeholder=\"e.g., Starbucks, Gas station, Netflix...\"\n      className=\"mt-2 h-12 text-base\"\n      data-testid=\"input-transaction-description\"\n     />\n     {errors.description && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.description.message}</p>\n     )}\n    </div>\n\n    {/* Category - Optional, AI will auto-categorize */}\n    <div>\n     <Label htmlFor=\"category\" className=\"text-base font-semibold\">\n      What category? <span className=\"text-sm font-normal text-muted-foreground\">(optional - AI will detect)</span>\n     </Label>\n     <Select value={selectedCategory ||\"\"} onValueChange={handleCategoryChange}>\n      <SelectTrigger className=\"mt-2 h-12 text-base\" data-testid=\"select-transaction-category\">\n       <SelectValue placeholder=\"Leave blank for auto-categorization\" />\n      </SelectTrigger>\n      <SelectContent>\n       {availableCategories.map((category) => (\n        <SelectItem key={category.value} value={category.value}>\n         {category.label}\n        </SelectItem>\n       ))}\n      </SelectContent>\n     </Select>\n     {errors.category && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.category.message}</p>\n     )}\n    </div>\n\n    {/* Destination - Only for Transfer/Savings */}\n    {selectedType ===\"transfer\" && selectedCategory ===\"goal_contribution\" && (\n     <div>\n      <Label htmlFor=\"goalId\" className=\"text-base font-semibold\">Which financial goal?</Label>\n      <Select value={watch(\"goalId\") ||\"\"} onValueChange={(value) => setValue(\"goalId\", value)}>\n       <SelectTrigger className=\"mt-2 h-12 text-base\" data-testid=\"select-goal\">\n        <SelectValue placeholder=\"Select a goal\" />\n       </SelectTrigger>\n       <SelectContent>\n        {activeGoals.length === 0 ? (\n         <SelectItem value=\"none\" disabled>No active goals yet</SelectItem>\n        ) : (\n         activeGoals.map((goal: any) => (\n          <SelectItem key={goal.id} value={goal.id}>\n           {goal.title} (${parseFloat(goal.currentAmount || '0').toFixed(0)} / ${parseFloat(goal.targetAmount).toFixed(0)})\n          </SelectItem>\n         ))\n        )}\n       </SelectContent>\n      </Select>\n     </div>\n    )}\n\n    {selectedType ===\"transfer\" && selectedCategory ===\"savings\" && (\n     <div>\n      <Label htmlFor=\"destination\" className=\"text-base font-semibold\">Where is this money going?</Label>\n      <Select value={watch(\"destination\") ||\"\"} onValueChange={(value) => setValue(\"destination\", value)}>\n       <SelectTrigger className=\"mt-2 h-12 text-base\" data-testid=\"select-destination\">\n        <SelectValue placeholder=\"Select destination\" />\n       </SelectTrigger>\n       <SelectContent>\n        <SelectItem value=\"emergency_fund\">Emergency Fund</SelectItem>\n        <SelectItem value=\"general_savings\">General Savings</SelectItem>\n        <SelectItem value=\"vacation_fund\">Vacation Fund</SelectItem>\n        <SelectItem value=\"down_payment\">Down Payment</SelectItem>\n        <SelectItem value=\"other\">Other Savings</SelectItem>\n       </SelectContent>\n      </Select>\n     </div>\n    )}\n\n    {selectedType ===\"transfer\" && selectedCategory ===\"investment\" && (\n     <div>\n      <Label htmlFor=\"destination\" className=\"text-base font-semibold\">Which investment account?</Label>\n      <Select value={watch(\"destination\") ||\"\"} onValueChange={(value) => setValue(\"destination\", value)}>\n       <SelectTrigger className=\"mt-2 h-12 text-base\" data-testid=\"select-destination\">\n        <SelectValue placeholder=\"Select account\" />\n       </SelectTrigger>\n       <SelectContent>\n        <SelectItem value=\"brokerage\">Brokerage Account</SelectItem>\n        <SelectItem value=\"401k\">401(k)</SelectItem>\n        <SelectItem value=\"roth_ira\">Roth IRA</SelectItem>\n        <SelectItem value=\"crypto\">Cryptocurrency</SelectItem>\n        <SelectItem value=\"real_estate\">Real Estate</SelectItem>\n        <SelectItem value=\"other\">Other Investment</SelectItem>\n       </SelectContent>\n      </Select>\n     </div>\n    )}\n\n    {/* Date - Secondary */}\n    <div>\n     <Label htmlFor=\"date\" className=\"text-sm font-medium\">When? (optional)</Label>\n     <Input\n      id=\"date\"\n      type=\"date\"\n      {...register(\"date\")}\n      className=\"mt-1.5 h-11\"\n      data-testid=\"input-transaction-date\"\n     />\n     {errors.date && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.date.message}</p>\n     )}\n    </div>\n\n    <div className=\"flex justify-end space-x-2 pt-4\">\n     <Button\n      type=\"submit\"\n      disabled={isSubmitting}\n      className=\"min-w-[160px]\"\n      data-testid=\"button-submit-transaction\"\n     >\n      {isSubmitting ? (\n       <>\n        <Loader2 className=\"mr-2 h-4 w-4\" />\n        Adding...\n       </>\n      ) : (\n      \"Add Transaction\"\n      )}\n     </Button>\n    </div>\n   </form>\n  </>\n );\n}\n","path":null,"size_bytes":13647,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from\"react\"\nimport * as SeparatorPrimitive from\"@radix-ui/react-separator\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n React.ElementRef<typeof SeparatorPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n (\n  { className, orientation =\"horizontal\", decorative = true, ...props },\n  ref\n ) => (\n  <SeparatorPrimitive.Root\n   ref={ref}\n   decorative={decorative}\n   orientation={orientation}\n   className={cn(\n   \"shrink-0 bg-border\",\n    orientation ===\"horizontal\" ?\"h-[1px] w-full\" :\"h-full w-[1px]\",\n    className\n   )}\n   {...props}\n  />\n )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":705,"size_tokens":null},"client/src/lib/userContext.tsx":{"content":"import { createContext, useContext, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { UserPreferences } from \"@shared/schema\";\nimport { formatCurrency, convertCurrency, getCurrencySymbol, CURRENCIES } from \"./currency\";\n\ninterface User {\n  id: string;\n  username: string;\n  email: string;\n  firstName?: string;\n  lastName?: string;\n  avatar?: string;\n  createdAt: string;\n}\n\ninterface UserContextType {\n  user: User | null;\n  isLoading: boolean;\n  error: Error | null;\n  preferences: UserPreferences | null;\n  preferencesLoading: boolean;\n  currency: string;\n  currencySymbol: string;\n  formatAmount: (amount: number, options?: { compact?: boolean; showSymbol?: boolean }) => string;\n  convertFromUSD: (amountUSD: number) => number;\n  convertToUSD: (amount: number) => number;\n  getUserName: () => string;\n}\n\nconst UserContext = createContext<UserContextType | undefined>(undefined);\n\nexport function UserProvider({ children }: { children: React.ReactNode }) {\n  const { data: user, isLoading: userLoading, error: userError } = useQuery<User>({\n    queryKey: [\"/api/users/me\"],\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const { data: preferences, isLoading: preferencesLoading } = useQuery<UserPreferences>({\n    queryKey: [\"/api/user-preferences\"],\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const currency = preferences?.currency || \"USD\";\n  const currencySymbol = getCurrencySymbol(currency);\n\n  const contextValue = useMemo<UserContextType>(() => ({\n    user: user || null,\n    isLoading: userLoading,\n    error: userError || null,\n    preferences: preferences || null,\n    preferencesLoading,\n    currency,\n    currencySymbol,\n    \n    formatAmount: (amount: number, options?: { compact?: boolean; showSymbol?: boolean }) => {\n      return formatCurrency(amount, currency, {\n        compact: options?.compact,\n        showSymbol: options?.showSymbol ?? true,\n      });\n    },\n    \n    convertFromUSD: (amountUSD: number) => {\n      if (currency === \"USD\") return amountUSD;\n      return convertCurrency(amountUSD, \"USD\", currency);\n    },\n    \n    convertToUSD: (amount: number) => {\n      if (currency === \"USD\") return amount;\n      return convertCurrency(amount, currency, \"USD\");\n    },\n    \n    getUserName: () => {\n      const onboardingData = preferences?.onboardingData as { fullName?: string } | null;\n      if (onboardingData?.fullName) return onboardingData.fullName;\n      if (user?.firstName) return user.firstName;\n      if (user?.username) return user.username;\n      return \"there\";\n    },\n  }), [user, userLoading, userError, preferences, preferencesLoading, currency, currencySymbol]);\n\n  return (\n    <UserContext.Provider value={contextValue}>\n      {children}\n    </UserContext.Provider>\n  );\n}\n\nexport function useUser() {\n  const context = useContext(UserContext);\n  if (context === undefined) {\n    throw new Error(\"useUser must be used within a UserProvider\");\n  }\n  return context;\n}\n\nexport function useUserId() {\n  const { user } = useUser();\n  return user?.id;\n}\n\nexport function useUserCurrency() {\n  const { currency, currencySymbol, formatAmount, convertFromUSD, convertToUSD } = useUser();\n  return { currency, currencySymbol, formatAmount, convertFromUSD, convertToUSD };\n}\n\nexport function useUserPreferences() {\n  const { preferences, preferencesLoading, getUserName } = useUser();\n  return { preferences, isLoading: preferencesLoading, getUserName };\n}\n","path":null,"size_bytes":3421,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n return /^401: .*Unauthorized/.test(error.message);\n}","path":null,"size_bytes":114,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as SelectPrimitive from\"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.Trigger>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n <SelectPrimitive.Trigger\n  ref={ref}\n  className={cn(\n  \"flex h-12 min-h-[44px] w-full items-center justify-between rounded-lg border border-input bg-background px-3 py-2 text-sm ring-offset-background transition-all duration-150 data-[placeholder]:text-muted-foreground focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n   className\n  )}\n  {...props}\n >\n  {children}\n  <SelectPrimitive.Icon asChild>\n   <ChevronDown className=\"h-4 w-4 opacity-50 transition-transform duration-150 data-[state=open]:rotate-180\" />\n  </SelectPrimitive.Icon>\n </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n <SelectPrimitive.ScrollUpButton\n  ref={ref}\n  className={cn(\n  \"flex cursor-default items-center justify-center py-1\",\n   className\n  )}\n  {...props}\n >\n  <ChevronUp className=\"h-4 w-4\" />\n </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n <SelectPrimitive.ScrollDownButton\n  ref={ref}\n  className={cn(\n  \"flex cursor-default items-center justify-center py-1\",\n   className\n  )}\n  {...props}\n >\n  <ChevronDown className=\"h-4 w-4\" />\n </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position =\"popper\", ...props }, ref) => (\n <SelectPrimitive.Portal>\n  <SelectPrimitive.Content\n   ref={ref}\n   className={cn(\n   \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n    position ===\"popper\" &&\n    \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n    className\n   )}\n   position={position}\n   {...props}\n  >\n   <SelectScrollUpButton />\n   <SelectPrimitive.Viewport\n    className={cn(\n    \"p-1\",\n     position ===\"popper\" &&\n     \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n    )}\n   >\n    {children}\n   </SelectPrimitive.Viewport>\n   <SelectScrollDownButton />\n  </SelectPrimitive.Content>\n </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.Label>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n <SelectPrimitive.Label\n  ref={ref}\n  className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n  {...props}\n />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n <SelectPrimitive.Item\n  ref={ref}\n  className={cn(\n  \"relative flex w-full cursor-default select-none items-center rounded-md py-3 min-h-[44px] pl-8 pr-2 text-sm outline-none transition-colors duration-100 focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-4 w-4 items-center justify-center\">\n   <SelectPrimitive.ItemIndicator>\n    <Check className=\"h-4 w-4 text-primary\" />\n   </SelectPrimitive.ItemIndicator>\n  </span>\n\n  <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n React.ElementRef<typeof SelectPrimitive.Separator>,\n React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n <SelectPrimitive.Separator\n  ref={ref}\n  className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n  {...props}\n />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n Select,\n SelectGroup,\n SelectValue,\n SelectTrigger,\n SelectContent,\n SelectLabel,\n SelectItem,\n SelectSeparator,\n SelectScrollUpButton,\n SelectScrollDownButton,\n}\n","path":null,"size_bytes":5668,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from\"react\"\nimport * as SliderPrimitive from\"@radix-ui/react-slider\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n React.ElementRef<typeof SliderPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n <SliderPrimitive.Root\n  ref={ref}\n  className={cn(\n  \"relative flex w-full touch-none select-none items-center\",\n   className\n  )}\n  {...props}\n >\n  <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n   <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n  </SliderPrimitive.Track>\n  <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1340,"size_tokens":null},"client/src/components/money/spending-insights.tsx":{"content":"import { useState, useMemo } from\"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { \n Lightbulb, \n TrendingDown, \n TrendingUp, \n AlertTriangle, \n CheckCircle,\n Zap,\n Brain,\n Target,\n Calendar,\n DollarSign,\n PiggyBank,\n ArrowRight,\n Sparkles,\n Award\n} from\"lucide-react\";\nimport { differenceInDays, subWeeks, startOfWeek, endOfWeek, format } from\"date-fns\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface SpendingInsightsProps {\n transactions: any[];\n timeRange: string;\n}\n\nexport default function SpendingInsights({ transactions, timeRange }: SpendingInsightsProps) {\n const [selectedInsight, setSelectedInsight] = useState<string>('all');\n const { formatAmount } = useUserCurrency();\n\n // Memoize filtered transactions to prevent recreation on each render\n const expenseTransactions = useMemo(() => \n  transactions.filter(t => t.type === 'expense'), \n  [transactions]\n );\n \n const incomeTransactions = useMemo(() => \n  transactions.filter(t => t.type === 'income'), \n  [transactions]\n );\n\n // Memoize calculated totals\n const totalExpenses = useMemo(() => \n  expenseTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0),\n  [expenseTransactions]\n );\n \n const totalIncome = useMemo(() => \n  incomeTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0),\n  [incomeTransactions]\n );\n\n // Memoize weekly spending pattern calculations\n const { thisWeekExpenses, lastWeekExpenses } = useMemo(() => {\n  const now = new Date();\n  const lastWeek = subWeeks(now, 1);\n  \n  const thisWeek = expenseTransactions\n   .filter(t => new Date(t.date) >= startOfWeek(now))\n   .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n  \n  const lastWeek_expenses = expenseTransactions\n   .filter(t => {\n    const date = new Date(t.date);\n    return date >= startOfWeek(lastWeek) && date < endOfWeek(lastWeek);\n   })\n   .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n  \n  return { thisWeekExpenses: thisWeek, lastWeekExpenses: lastWeek_expenses };\n }, [expenseTransactions]);\n\n // Memoize spending by day of week\n const dayOfWeekSpending = useMemo(() => \n  expenseTransactions.reduce((acc: any, transaction) => {\n   const dayOfWeek = new Date(transaction.date).getDay();\n   const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n   const dayName = dayNames[dayOfWeek];\n   acc[dayName] = (acc[dayName] || 0) + parseFloat(transaction.amount);\n   return acc;\n  }, {}),\n  [expenseTransactions]\n );\n\n // Generate AI-powered insights\n const generateSpendingInsights = () => {\n  const insights = [];\n\n  // Weekend vs weekday spending\n  const weekendSpending = (dayOfWeekSpending['Saturday'] || 0) + (dayOfWeekSpending['Sunday'] || 0);\n  const weekdaySpending = totalExpenses - weekendSpending;\n  if (weekendSpending > weekdaySpending * 0.4) {\n   insights.push({\n    type: 'pattern',\n    title: 'High Weekend Spending',\n    description: 'You spend 40% more on weekends. Consider planning weekend activities with a budget.',\n    potential_saving: weekendSpending * 0.2,\n    action: 'Set weekend spending limit',\n    priority: 'medium',\n    icon: Calendar\n   });\n  }\n\n  // Frequent small purchases\n  const smallPurchases = expenseTransactions.filter(t => parseFloat(t.amount) < 50).length;\n  const largePurchases = expenseTransactions.filter(t => parseFloat(t.amount) >= 50).length;\n  if (smallPurchases > largePurchases * 2) {\n   insights.push({\n    type: 'behavior',\n    title: 'Frequent Small Purchases',\n    description: `${smallPurchases} small purchases adding up quickly.`,\n    potential_saving: smallPurchases * 15,\n    action: 'Track micro-spending',\n    priority: 'high',\n    icon: AlertTriangle\n   });\n  }\n\n  // Category concentration\n  const categorySpending = expenseTransactions.reduce((acc: any, transaction) => {\n   const category = transaction.category || 'other';\n   acc[category] = (acc[category] || 0) + parseFloat(transaction.amount);\n   return acc;\n  }, {});\n\n  const topCategory = Object.entries(categorySpending).reduce((max: any, [cat, amount]: any) => \n   amount > max.amount ? { category: cat, amount } : max, \n   { category: '', amount: 0 }\n  );\n\n  if (topCategory.amount > totalExpenses * 0.4) {\n   insights.push({\n    type: 'concentration',\n    title: 'Category Over-Concentration',\n    description: `${topCategory.category} represents ${((topCategory.amount / totalExpenses) * 100).toFixed(0)}% of spending.`,\n    potential_saving: topCategory.amount * 0.15,\n    action: 'Diversify spending',\n    priority: 'medium',\n    icon: Target\n   });\n  }\n\n  // Savings opportunity\n  const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : 0;\n  if (savingsRate < 20 && totalIncome > 0) {\n   insights.push({\n    type: 'opportunity',\n    title: 'Savings Opportunity',\n    description: `Current savings rate: ${savingsRate.toFixed(1)}%. Aim for 20%+ for financial health.`,\n    potential_saving: totalIncome * 0.2 - (totalIncome - totalExpenses),\n    action: 'Increase savings rate',\n    priority: 'high',\n    icon: PiggyBank\n   });\n  }\n\n  // Weekly trend - guard against division by zero\n  const weeklyChange = lastWeekExpenses > 0 ? ((thisWeekExpenses - lastWeekExpenses) / lastWeekExpenses) * 100 : 0;\n  if (Math.abs(weeklyChange) > 25) {\n   insights.push({\n    type: 'trend',\n    title: weeklyChange > 0 ? 'Spending Spike' : 'Spending Drop',\n    description: `${Math.abs(weeklyChange).toFixed(0)}% ${weeklyChange > 0 ? 'increase' : 'decrease'} from last week.`,\n    potential_saving: weeklyChange > 0 ? thisWeekExpenses * 0.1 : 0,\n    action: weeklyChange > 0 ? 'Review recent purchases' : 'Maintain good habits',\n    priority: weeklyChange > 0 ? 'high' : 'low',\n    icon: weeklyChange > 0 ? TrendingUp : TrendingDown\n   });\n  }\n\n  return insights.sort((a, b) => {\n   const priorityOrder = { high: 3, medium: 2, low: 1 };\n   return (priorityOrder as any)[b.priority] - (priorityOrder as any)[a.priority];\n  });\n };\n\n const insights = useMemo(() => generateSpendingInsights(), [\n  transactions,\n  expenseTransactions,\n  totalExpenses,\n  totalIncome,\n  dayOfWeekSpending,\n  thisWeekExpenses,\n  lastWeekExpenses\n ]);\n\n // Smart recommendations\n const generateRecommendations = () => {\n  const recommendations = [];\n\n  // Round-up savings\n  const roundUpSavings = expenseTransactions.reduce((total, transaction) => {\n   const amount = parseFloat(transaction.amount);\n   const roundUp = Math.ceil(amount) - amount;\n   return total + roundUp;\n  }, 0);\n\n  recommendations.push({\n   type: 'automation',\n   title: 'Round-Up Savings',\n   description: `Automatically save spare change from purchases.`,\n   benefit: `${formatAmount(roundUpSavings)} saved this period`,\n   action: 'Enable round-up',\n   difficulty: 'Easy'\n  });\n\n  // Subscription audit\n  const subscriptionLikeExpenses = expenseTransactions.filter(t => \n   parseFloat(t.amount) > 5 && parseFloat(t.amount) < 100 && \n   t.category === 'entertainment'\n  );\n\n  if (subscriptionLikeExpenses.length > 3) {\n   recommendations.push({\n    type: 'optimization',\n    title: 'Subscription Audit',\n    description: 'Review recurring entertainment expenses for unused services.',\n    benefit: 'Significant monthly savings',\n    action: 'Review subscriptions',\n    difficulty: 'Medium'\n   });\n  }\n\n  // Meal prep opportunity\n  const diningExpenses = expenseTransactions\n   .filter(t => t.category === 'dining')\n   .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n  if (diningExpenses > 300) {\n   recommendations.push({\n    type: 'lifestyle',\n    title: 'Meal Prep Opportunity',\n    description: 'High dining expenses. Meal prepping could reduce costs significantly.',\n    benefit: `Save ${formatAmount(diningExpenses * 0.4)}/month`,\n    action: 'Start meal prepping',\n    difficulty: 'Medium'\n   });\n  }\n\n  return recommendations.slice(0, 3);\n };\n\n const recommendations = useMemo(() => generateRecommendations(), [\n  expenseTransactions,\n  totalExpenses,\n  totalIncome,\n  transactions\n ]);\n\n const getPriorityColor = (priority: string) => {\n  switch (priority) {\n   case 'high': return 'text-red-600';\n   case 'medium': return 'text-yellow-600';\n   default: return 'text-green-600';\n  }\n };\n\n const getPriorityBadge = (priority: string) => {\n  switch (priority) {\n   case 'high': return <Badge variant=\"destructive\">High Priority</Badge>;\n   case 'medium': return <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20\">Medium</Badge>;\n   default: return <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900/20\">Low Priority</Badge>;\n  }\n };\n\n return (\n  <div className=\"space-y-6\">\n   {/* Insights Overview */}\n   <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Insights Generated</p>\n       <p className=\"text-2xl font-bold text-blue-600\">{insights.length}</p>\n       <p className=\"text-xs text-muted-foreground mt-1\">AI-powered</p>\n      </div>\n      <div className=\"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center\">\n       <Brain className=\"text-blue-600\" size={24} />\n      </div>\n     </div>\n    </Card>\n\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Potential Savings</p>\n       <p className=\"text-2xl font-bold text-green-600\">\n        {formatAmount(insights.reduce((sum, insight) => sum + (insight.potential_saving || 0), 0))}\n       </p>\n       <p className=\"text-xs text-muted-foreground mt-1\">per month</p>\n      </div>\n      <div className=\"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center\">\n       <DollarSign className=\"text-green-600\" size={24} />\n      </div>\n     </div>\n    </Card>\n\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Weekly Trend</p>\n       <p className={`text-2xl font-bold ${thisWeekExpenses > lastWeekExpenses ? 'text-red-600' : 'text-green-600'}`}>\n        {lastWeekExpenses > 0 ? \n         `${thisWeekExpenses > lastWeekExpenses ? '+' : ''}${(((thisWeekExpenses - lastWeekExpenses) / lastWeekExpenses) * 100).toFixed(0)}%` \n         : '0%'\n        }\n       </p>\n       <p className=\"text-xs text-muted-foreground mt-1\">vs last week</p>\n      </div>\n      <div className={`w-12 h-12 ${thisWeekExpenses > lastWeekExpenses ? 'bg-red-100 dark:bg-red-900/20' : 'bg-green-100 dark:bg-green-900/20'} rounded-lg flex items-center justify-center`}>\n       {thisWeekExpenses > lastWeekExpenses ? (\n        <TrendingUp className=\"text-red-600\" size={24} />\n       ) : (\n        <TrendingDown className=\"text-green-600\" size={24} />\n       )}\n      </div>\n     </div>\n    </Card>\n   </div>\n\n   {/* AI-Powered Insights */}\n   <Card className=\"p-6\">\n    <CardHeader className=\"px-0 pt-0\">\n     <CardTitle className=\"flex items-center\">\n      <Lightbulb className=\"mr-2\" size={20} />\n      AI-Powered Spending Insights\n     </CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-0\">\n     <div className=\"space-y-4\">\n      {insights.map((insight, index) => (\n       <div key={index} className=\"flex items-start justify-between p-4 bg-muted/30 rounded-lg\">\n        <div className=\"flex items-start\">\n         <div className=\"w-10 h-10 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mr-3\">\n          <insight.icon className=\"text-blue-600\" size={20} />\n         </div>\n         <div>\n          <div className=\"flex items-center gap-2 mb-1\">\n           <h4 className=\"font-semibold\">{insight.title}</h4>\n           {getPriorityBadge(insight.priority)}\n          </div>\n          <p className=\"text-sm text-muted-foreground\">{insight.description}</p>\n          {insight.potential_saving > 0 && (\n           <p className=\"text-sm text-green-600 font-medium mt-1\">\n            Save {formatAmount(insight.potential_saving)}/month\n           </p>\n          )}\n         </div>\n        </div>\n        <Button variant=\"outline\" size=\"sm\">\n         {insight.action}\n         <ArrowRight className=\"ml-1\" size={14} />\n        </Button>\n       </div>\n      ))}\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Smart Recommendations */}\n   <Card className=\"p-6\">\n    <CardHeader className=\"px-0 pt-0\">\n     <CardTitle className=\"flex items-center\">\n      <Sparkles className=\"mr-2\" size={20} />\n      Smart Money-Saving Recommendations\n     </CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-0\">\n     <div className=\"space-y-4\">\n      {recommendations.map((rec, index) => (\n       <div key={index} className=\"flex items-start justify-between p-4 bg-white dark:bg-gray-900 rounded-lg\">\n        <div className=\"flex items-start\">\n         <div className=\"w-10 h-10 bg-white dark:bg-gray-900 rounded-full flex items-center justify-center mr-3\">\n          <Zap className=\"text-white\" size={20} />\n         </div>\n         <div>\n          <div className=\"flex items-center gap-2 mb-1\">\n           <h4 className=\"font-semibold\">{rec.title}</h4>\n           <Badge variant=\"outline\">{rec.difficulty}</Badge>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">{rec.description}</p>\n          <p className=\"text-sm text-green-600 font-medium mt-1\">\n           {rec.benefit}\n          </p>\n         </div>\n        </div>\n        <Button className=\"bg-primary text-primary-foreground\" size=\"sm\">\n         {rec.action}\n         <ArrowRight className=\"ml-1\" size={14} />\n        </Button>\n       </div>\n      ))}\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Spending Patterns */}\n   <Card className=\"p-6\">\n    <CardHeader className=\"px-0 pt-0\">\n     <CardTitle className=\"flex items-center\">\n      <Award className=\"mr-2\" size={20} />\n      Your Spending Patterns\n     </CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-0\">\n     <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n      <div className=\"space-y-3\">\n       <h4 className=\"font-medium\">Daily Spending Average</h4>\n       {Object.entries(dayOfWeekSpending).map(([day, amount]: any) => (\n        <div key={day} className=\"flex items-center justify-between\">\n         <span className=\"text-sm\">{day}</span>\n         <div className=\"flex items-center\">\n          <div className=\"w-20 h-2 bg-muted rounded-full mr-2\">\n           <div \n            className=\"h-full bg-blue-500 rounded-full\" \n            style={{ width: `${(amount / Math.max(...Object.values(dayOfWeekSpending).map(Number))) * 100}%` }}\n           ></div>\n          </div>\n          <span className=\"text-sm font-medium\">{formatAmount(amount)}</span>\n         </div>\n        </div>\n       ))}\n      </div>\n      \n      <div className=\"space-y-3\">\n       <h4 className=\"font-medium\">Smart Insights Score</h4>\n       <div className=\"space-y-2\">\n        <div className=\"flex justify-between\">\n         <span className=\"text-sm\">Spending Awareness</span>\n         <span className=\"text-sm font-medium\">85%</span>\n        </div>\n        <div className=\"flex justify-between\">\n         <span className=\"text-sm\">Budget Control</span>\n         <span className=\"text-sm font-medium\">78%</span>\n        </div>\n        <div className=\"flex justify-between\">\n         <span className=\"text-sm\">Savings Potential</span>\n         <span className=\"text-sm font-medium\">92%</span>\n        </div>\n        <div className=\"flex justify-between font-semibold\">\n         <span className=\"text-sm\">Overall Score</span>\n         <span className=\"text-sm text-green-600\">85/100</span>\n        </div>\n       </div>\n      </div>\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}","path":null,"size_bytes":15856,"size_tokens":null},"client/src/components/goals/automated-savings-suggestions.tsx":{"content":"import { useState } from\"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { \n Bot, \n DollarSign, \n TrendingUp, \n Calendar, \n Target,\n Zap,\n PiggyBank,\n Clock,\n ArrowRight,\n Plus\n} from\"lucide-react\";\nimport { differenceInDays, differenceInMonths, addDays, format } from\"date-fns\";\nimport { useQuery } from\"@tanstack/react-query\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface Goal {\n id: string;\n title: string;\n description?: string;\n targetAmount: string;\n currentAmount: string;\n targetDate: string;\n category?: string;\n priority: string;\n status: string;\n createdAt?: string;\n}\n\ninterface Transaction {\n id: string;\n amount: string;\n type: string;\n category?: string;\n date: string;\n goalId?: string;\n}\n\ninterface AutomatedSavingsSuggestionsProps {\n goals: Goal[];\n onImplementSuggestion?: (suggestion: any) => void;\n}\n\ninterface SavingSuggestion {\n id: string;\n type: 'amount' | 'frequency' | 'automation' | 'optimization';\n goalId?: string;\n title: string;\n description: string;\n impact: string;\n difficulty: 'easy' | 'medium' | 'hard';\n timeToSee: string;\n monthlyIncrease?: number;\n annualIncrease?: number;\n confidence: number;\n actionButton: string;\n}\n\nexport default function AutomatedSavingsSuggestions({ \n goals, \n onImplementSuggestion \n}: AutomatedSavingsSuggestionsProps) {\n const { formatAmount } = useUserCurrency();\n const [selectedFilter, setSelectedFilter] = useState<string>('all');\n \n const { data: transactions } = useQuery({\n  queryKey: [\"/api/transactions\"],\n  queryFn: () => fetch(\"/api/transactions\").then(res => res.json()),\n });\n\n const activeGoals = goals.filter(goal => goal.status === 'active');\n\n const generateSuggestions = (): SavingSuggestion[] => {\n  const suggestions: SavingSuggestion[] = [];\n\n  if (!transactions || transactions.length === 0) {\n   return [];\n  }\n\n  // Analyze spending patterns\n  const recentTransactions = transactions.filter((t: Transaction) => \n   differenceInDays(new Date(), new Date(t.date)) <= 30\n  );\n  \n  const monthlyIncome = recentTransactions\n   .filter((t: Transaction) => t.type === 'income')\n   .reduce((sum: number, t: Transaction) => sum + parseFloat(t.amount), 0);\n  \n  const monthlyExpenses = recentTransactions\n   .filter((t: Transaction) => t.type === 'expense')\n   .reduce((sum: number, t: Transaction) => sum + parseFloat(t.amount), 0);\n\n  const discretionarySpending = recentTransactions\n   .filter((t: Transaction) => \n    t.type === 'expense' && \n    ['entertainment', 'dining', 'shopping', 'subscriptions'].includes(t.category || '')\n   )\n   .reduce((sum: number, t: Transaction) => sum + parseFloat(t.amount), 0);\n\n  // Round-up savings suggestion\n  if (monthlyExpenses > 0) {\n   const roundUpPotential = recentTransactions\n    .filter((t: Transaction) => t.type === 'expense')\n    .length * 0.50; // Average 50 cents per transaction\n   \n   suggestions.push({\n    id: 'round-up-savings',\n    type: 'automation',\n    title: 'Round-Up Savings',\n    description: `Automatically round up purchases and save the change. Based on your spending, this could save ~${formatAmount(roundUpPotential)} monthly.`,\n    impact: `+${formatAmount(roundUpPotential * 12)} annually`,\n    difficulty: 'easy',\n    timeToSee: '1 week',\n    monthlyIncrease: roundUpPotential,\n    annualIncrease: roundUpPotential * 12,\n    confidence: 95,\n    actionButton: 'Enable Round-Up'\n   });\n  }\n\n  // Reduce discretionary spending\n  if (discretionarySpending > 200) {\n   const reduction = discretionarySpending * 0.15; // 15% reduction\n   suggestions.push({\n    id: 'reduce-discretionary',\n    type: 'optimization',\n    title: 'Optimize Discretionary Spending',\n    description: `Reducing entertainment and dining expenses by 15% could free up ${formatAmount(reduction)} monthly for goals.`,\n    impact: `+${formatAmount(reduction * 12)} annually`,\n    difficulty: 'medium',\n    timeToSee: '2 weeks',\n    monthlyIncrease: reduction,\n    annualIncrease: reduction * 12,\n    confidence: 80,\n    actionButton: 'Set Spending Limits'\n   });\n  }\n\n  // Goal-specific suggestions\n  activeGoals.forEach(goal => {\n   const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n   const daysRemaining = differenceInDays(new Date(goal.targetDate), new Date());\n   const monthsRemaining = daysRemaining / 30;\n   const requiredMonthly = monthsRemaining > 0 \n    ? (parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount)) / monthsRemaining\n    : 0;\n\n   // Increase contribution suggestion\n   if (progress < 50 && daysRemaining > 30 && requiredMonthly < monthlyIncome * 0.3) {\n    const suggestedIncrease = Math.min(requiredMonthly * 1.2, monthlyIncome * 0.1);\n    suggestions.push({\n     id: `increase-${goal.id}`,\n     type: 'amount',\n     goalId: goal.id,\n     title: `Accelerate\"${goal.title}\"`,\n     description: `Increase monthly contributions by ${formatAmount(suggestedIncrease)} to complete this goal ${Math.ceil(suggestedIncrease / requiredMonthly * 30)} days earlier.`,\n     impact: `Goal completion ${Math.ceil(suggestedIncrease / requiredMonthly * 30)} days sooner`,\n     difficulty: 'easy',\n     timeToSee: '1 month',\n     monthlyIncrease: suggestedIncrease,\n     confidence: 85,\n     actionButton: 'Increase Contribution'\n    });\n   }\n\n   // Automated contribution suggestion\n   if (progress < 25 && daysRemaining > 60) {\n    suggestions.push({\n     id: `automate-${goal.id}`,\n     type: 'automation',\n     goalId: goal.id,\n     title: `Automate\"${goal.title}\" Savings`,\n     description: `Set up automatic weekly transfers of ${formatAmount(requiredMonthly / 4)} to stay on track without thinking about it.`,\n     impact: 'Consistent progress without manual effort',\n     difficulty: 'easy',\n     timeToSee: 'Immediate',\n     monthlyIncrease: requiredMonthly,\n     confidence: 90,\n     actionButton: 'Set Up Automation'\n    });\n   }\n  });\n\n  // Income optimization\n  if (monthlyIncome > 0 && monthlyIncome < 8000) {\n   suggestions.push({\n    id: 'income-optimization',\n    type: 'optimization',\n    title: 'Explore Income Opportunities',\n    description: 'Consider side hustles, skill development, or asking for a raise to accelerate your savings goals.',\n    impact: 'Potentially +20-50% income',\n    difficulty: 'hard',\n    timeToSee: '3-6 months',\n    confidence: 60,\n    actionButton: 'Explore Options'\n   });\n  }\n\n  // Emergency fund suggestion\n  const hasEmergencyGoal = activeGoals.some(goal => \n   goal.category === 'emergency' || goal.title.toLowerCase().includes('emergency')\n  );\n  \n  if (!hasEmergencyGoal && monthlyExpenses > 0) {\n   const emergencyTarget = monthlyExpenses * 3; // 3 months of expenses\n   suggestions.push({\n    id: 'emergency-fund',\n    type: 'optimization',\n    title: 'Create Emergency Fund Goal',\n    description: `Build a safety net of ${formatAmount(emergencyTarget)} (3 months of expenses) before focusing on other goals.`,\n    impact: 'Financial security and peace of mind',\n    difficulty: 'medium',\n    timeToSee: '6-12 months',\n    confidence: 95,\n    actionButton: 'Create Emergency Fund'\n   });\n  }\n\n  // High-yield savings suggestion\n  const totalSavings = goals.reduce((sum, goal) => sum + parseFloat(goal.currentAmount), 0);\n  if (totalSavings > 5000) {\n   suggestions.push({\n    id: 'high-yield-savings',\n    type: 'optimization',\n    title: 'Optimize Savings Account',\n    description: `With ${formatAmount(totalSavings)} saved, switching to a high-yield account could earn an extra ${formatAmount(totalSavings * 0.04)} annually.`,\n    impact: `+${formatAmount(totalSavings * 0.04)} annually in interest`,\n    difficulty: 'easy',\n    timeToSee: '1 month',\n    annualIncrease: totalSavings * 0.04,\n    confidence: 85,\n    actionButton: 'Find Better Rates'\n   });\n  }\n\n  return suggestions.sort((a, b) => b.confidence - a.confidence);\n };\n\n const suggestions = generateSuggestions();\n \n const filteredSuggestions = selectedFilter === 'all' \n  ? suggestions \n  : suggestions.filter(s => s.type === selectedFilter);\n\n const getDifficultyColor = (difficulty: string) => {\n  switch (difficulty) {\n   case 'easy': return 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300';\n   case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300';\n   case 'hard': return 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300';\n   default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300';\n  }\n };\n\n const getTypeIcon = (type: string) => {\n  switch (type) {\n   case 'amount': return DollarSign;\n   case 'frequency': return Calendar;\n   case 'automation': return Zap;\n   case 'optimization': return TrendingUp;\n   default: return Target;\n  }\n };\n\n if (suggestions.length === 0) {\n  return (\n   <Card>\n    <CardHeader>\n     <CardTitle className=\"flex items-center\">\n      <Bot className=\"mr-2 h-5 w-5\" />\n      AI Savings Suggestions\n     </CardTitle>\n    </CardHeader>\n    <CardContent>\n     <div className=\"text-center py-8\">\n      <PiggyBank className=\"mx-auto h-12 w-12 text-muted-foreground mb-4\" />\n      <h3 className=\"text-lg font-medium mb-2\">Building Recommendations</h3>\n      <p className=\"text-muted-foreground\">\n       Add some transactions and goals to unlock personalized savings strategies.\n      </p>\n     </div>\n    </CardContent>\n   </Card>\n  );\n }\n\n return (\n  <Card>\n   <CardHeader>\n    <CardTitle className=\"flex items-center justify-between\">\n     <div className=\"flex items-center\">\n      <Bot className=\"mr-2 h-5 w-5\" />\n      AI Savings Suggestions\n     </div>\n     <Badge variant=\"secondary\" className=\"flex items-center\">\n      <Plus className=\"mr-1 h-3 w-3\" />\n      {suggestions.length} suggestions\n     </Badge>\n    </CardTitle>\n   </CardHeader>\n   <CardContent>\n    {/* Filter Tabs */}\n    <div className=\"flex flex-wrap gap-2 mb-6\">\n     {[\n      { id: 'all', label: 'All Suggestions' },\n      { id: 'automation', label: 'Automation' },\n      { id: 'amount', label: 'Amounts' },\n      { id: 'optimization', label: 'Optimization' }\n     ].map(filter => (\n      <Button\n       key={filter.id}\n       variant={selectedFilter === filter.id ? 'default' : 'outline'}\n       size=\"sm\"\n       onClick={() => setSelectedFilter(filter.id)}\n       data-testid={`filter-${filter.id}`}\n      >\n       {filter.label}\n      </Button>\n     ))}\n    </div>\n\n    <div className=\"space-y-4\">\n     {filteredSuggestions.slice(0, 6).map((suggestion) => {\n      const TypeIcon = getTypeIcon(suggestion.type);\n      \n      return (\n       <div \n        key={suggestion.id}\n        className=\"p-4 border rounded-lg hover:shadow-sm transition-shadow\"\n        data-testid={`suggestion-${suggestion.id}`}\n       >\n        <div className=\"flex items-start justify-between\">\n         <div className=\"flex items-start space-x-3 flex-1\">\n          <div className=\"p-2 bg-blue-100 dark:bg-blue-900/20 rounded-lg\">\n           <TypeIcon className=\"h-4 w-4 text-blue-600\" />\n          </div>\n          <div className=\"flex-1\">\n           <div className=\"flex items-center space-x-2 mb-2\">\n            <h4 className=\"font-medium\">{suggestion.title}</h4>\n            <Badge className={getDifficultyColor(suggestion.difficulty)}>\n             {suggestion.difficulty}\n            </Badge>\n            <Badge variant=\"outline\" className=\"text-xs\">\n             {suggestion.confidence}% confidence\n            </Badge>\n           </div>\n           <p className=\"text-sm text-muted-foreground mb-3\">\n            {suggestion.description}\n           </p>\n           \n           <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            <div className=\"flex items-center space-x-2\">\n             <TrendingUp className=\"h-4 w-4 text-green-600\" />\n             <div>\n              <span className=\"font-medium\">Impact:</span>\n              <div className=\"text-green-600\">{suggestion.impact}</div>\n             </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n             <Clock className=\"h-4 w-4 text-blue-600\" />\n             <div>\n              <span className=\"font-medium\">Timeline:</span>\n              <div className=\"text-blue-600\">{suggestion.timeToSee}</div>\n             </div>\n            </div>\n           </div>\n          </div>\n         </div>\n         \n         <Button \n          onClick={() => onImplementSuggestion?.(suggestion)}\n          className=\"ml-4 shrink-0\"\n          data-testid={`button-implement-${suggestion.id}`}\n         >\n          {suggestion.actionButton}\n          <ArrowRight className=\"ml-2 h-4 w-4\" />\n         </Button>\n        </div>\n       </div>\n      );\n     })}\n    </div>\n\n    {filteredSuggestions.length > 6 && (\n     <div className=\"text-center pt-4\">\n      <Button variant=\"ghost\" size=\"sm\" className=\"text-muted-foreground\">\n       View {filteredSuggestions.length - 6} More Suggestions\n      </Button>\n     </div>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":12996,"size_tokens":null},"client/src/components/dashboard/recent-transactions.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport EmptyState from\"@/components/ui/empty-state\";\nimport { Plus, ArrowDown, ArrowUp, Home, ShoppingCart, PiggyBank, Receipt } from\"lucide-react\";\nimport { Link, useLocation } from\"wouter\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\nconst getTransactionIcon = (category: string, type: string) => {\n if (type ===\"income\") return ArrowDown;\n if (category ===\"rent\" || category ===\"housing\") return Home;\n if (category ===\"groceries\" || category ===\"shopping\") return ShoppingCart;\n if (category ===\"savings\" || category ===\"investment\") return PiggyBank;\n return ArrowUp;\n};\n\nconst getTransactionColor = (type: string) => {\n switch (type) {\n  case\"income\":\n   return { bg:\"bg-green-100 dark:bg-green-900/20\", text:\"text-green-600\", amount:\"text-green-600\" };\n  case\"expense\":\n   return { bg:\"bg-red-100 dark:bg-red-900/20\", text:\"text-red-600\", amount:\"text-red-600\" };\n  case\"transfer\":\n   return { bg:\"bg-blue-100 dark:bg-blue-900/20\", text:\"text-blue-600\", amount:\"text-blue-600\" };\n  default:\n   return { bg:\"bg-gray-100 dark:bg-gray-800\", text:\"text-gray-600\", amount:\"text-gray-600\" };\n }\n};\n\nexport default function RecentTransactions() {\n const [, setLocation] = useLocation();\n const { formatAmount } = useUserCurrency();\n \n const { data: transactions, isLoading } = useQuery({\n  queryKey: [\"/api/transactions\"],\n  queryFn: () => fetch(\"/api/transactions?limit=10\").then(res => res.json()),\n });\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-1/2 mb-6\"></div>\n     <div className=\"space-y-4\">\n      {[...Array(4)].map((_, i) => (\n       <div key={i} className=\"flex items-center justify-between p-3 border rounded-lg\">\n        <div className=\"flex items-center space-x-3\">\n         <div className=\"w-10 h-10 bg-muted rounded-lg\"></div>\n         <div>\n          <div className=\"h-4 bg-muted rounded w-20 mb-1\"></div>\n          <div className=\"h-3 bg-muted rounded w-16\"></div>\n         </div>\n        </div>\n        <div className=\"h-4 bg-muted rounded w-16\"></div>\n       </div>\n      ))}\n     </div>\n    </div>\n   </Card>\n  );\n }\n\n const recentTransactions = transactions || [];\n\n return (\n  <Card className=\"p-6 shadow-sm\">\n   <CardHeader className=\"p-0 mb-6\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-xl font-semibold\">Recent Transactions</CardTitle>\n     <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-view-all-transactions\" asChild>\n      <Link href=\"/money-tracking\">View All</Link>\n     </Button>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"p-0\">\n    {recentTransactions.length === 0 ? (\n     <EmptyState\n      illustration=\"transactions\"\n      title=\"No Transactions Yet\"\n      description=\"Start tracking your spending and income to gain insights into your finances.\"\n      actionLabel=\"Add Your First Transaction\"\n      onAction={() => setLocation(\"/money-tracking?add=1\")}\n      actionTestId=\"button-add-first-transaction\"\n     />\n    ) : (\n     <div className=\"space-y-4\">\n      {recentTransactions.slice(0, 4).map((transaction: any) => {\n       const Icon = getTransactionIcon(transaction.category, transaction.type);\n       const colors = getTransactionColor(transaction.type);\n       const amount = parseFloat(transaction.amount);\n       const sign = transaction.type ===\"income\" ?\"+\" :\"-\";\n       \n       return (\n        <div key={transaction.id} className=\"flex items-center justify-between p-3 rounded-lg border border-border\">\n         <div className=\"flex items-center space-x-3 min-w-0 flex-1\">\n          <div className={`w-10 h-10 ${colors.bg} rounded-lg flex items-center justify-center flex-shrink-0`}>\n           <Icon className={colors.text} size={16} />\n          </div>\n          <div className=\"min-w-0 flex-1\">\n           <p \n            className=\"font-medium text-sm text-foreground truncate\" \n            data-testid={`text-transaction-${transaction.id}`}\n            title={transaction.description || transaction.category}\n           >\n            {transaction.description || transaction.category}\n           </p>\n           <p className=\"text-xs text-muted-foreground\">\n            {new Date(transaction.date).toLocaleDateString()}\n           </p>\n          </div>\n         </div>\n         <span className={`font-semibold ${colors.amount}`}>\n          {sign}{formatAmount(Math.abs(amount))}\n         </span>\n        </div>\n       );\n      })}\n     </div>\n    )}\n\n    <Button variant=\"outline\" className=\"w-full mt-4\" data-testid=\"button-add-transaction-dashboard\" asChild>\n     <Link href=\"/money-tracking?add=1\">\n      <Plus size={16} className=\"mr-2\" />\n      Add Transaction\n     </Link>\n    </Button>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":4913,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/components/time-tracker.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Play, Pause, Square, Clock, Target, TrendingUp } from 'lucide-react';\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface TimeTrackerProps {\n eventId: string;\n eventTitle: string;\n plannedDurationMinutes?: number;\n actualDurationMinutes?: number;\n isActive?: boolean;\n onTimeUpdate?: (minutes: number) => void;\n}\n\ninterface TimeSession {\n startTime: Date;\n endTime?: Date;\n duration: number; // in milliseconds\n}\n\nexport function TimeTracker({ \n eventId, \n eventTitle, \n plannedDurationMinutes = 0,\n actualDurationMinutes = 0,\n isActive = false,\n onTimeUpdate \n}: TimeTrackerProps) {\n const [isTracking, setIsTracking] = useState(isActive);\n const [elapsedTime, setElapsedTime] = useState(actualDurationMinutes * 60 * 1000); // Convert to milliseconds\n const [accumulatedActiveMs, setAccumulatedActiveMs] = useState(actualDurationMinutes * 60 * 1000);\n const [lastStartedAt, setLastStartedAt] = useState<number | null>(null);\n const [hasActiveSession, setHasActiveSession] = useState(false); // Track if we have an active session (even when paused)\n const intervalRef = useRef<number | null>(null);\n const heartbeatRef = useRef<number | null>(null);\n const lastHeartbeatRef = useRef<number>(Date.now());\n \n // Refs to store current values for timer access\n const isTrackingRef = useRef(isTracking);\n const accumulatedActiveMsRef = useRef(accumulatedActiveMs);\n const lastStartedAtRef = useRef(lastStartedAt);\n \n // Network connectivity state\n const [isOnline, setIsOnline] = useState(navigator.onLine);\n \n // Session persistence key\n const sessionKey = `timetracker_${eventId}`;\n \n // Update refs when state changes\n useEffect(() => {\n  isTrackingRef.current = isTracking;\n  accumulatedActiveMsRef.current = accumulatedActiveMs;\n  lastStartedAtRef.current = lastStartedAt;\n }, [isTracking, accumulatedActiveMs, lastStartedAt]);\n const queryClient = useQueryClient();\n const { toast } = useToast();\n\n // Network connectivity monitoring for mobile\n useEffect(() => {\n  const handleOnline = () => {\n   setIsOnline(true);\n   if (hasActiveSession) {\n    toast({\n     title:\"Connection restored\",\n     description:\"Your time tracking session will be saved\",\n     duration: 2000\n    });\n   }\n  };\n\n  const handleOffline = () => {\n   setIsOnline(false);\n   if (isTracking) {\n    toast({\n     title:\"No connection\",\n     description:\"Time tracking continues offline\",\n     duration: 3000\n    });\n   }\n  };\n\n  window.addEventListener('online', handleOnline);\n  window.addEventListener('offline', handleOffline);\n\n  return () => {\n   window.removeEventListener('online', handleOnline);\n   window.removeEventListener('offline', handleOffline);\n  };\n }, [hasActiveSession, isTracking, toast]);\n\n // Heartbeat system to detect timer interruption by mobile OS\n useEffect(() => {\n  if (isTracking) {\n   heartbeatRef.current = window.setInterval(() => {\n    const now = Date.now();\n    const timeSinceLastBeat = now - lastHeartbeatRef.current;\n    \n    // If more than 3 seconds between heartbeats, timer was likely paused\n    if (timeSinceLastBeat > 3000) {\n     \n     // Recalculate elapsed time from persisted session\n     const persistedSession = localStorage.getItem(sessionKey);\n     if (persistedSession) {\n      try {\n       const { accumulatedMs, startedAt } = JSON.parse(persistedSession);\n       const correctedElapsed = accumulatedMs + (now - startedAt);\n       setElapsedTime(correctedElapsed);\n       setAccumulatedActiveMs(accumulatedMs);\n       setLastStartedAt(startedAt);\n      } catch (error) {\n       // Silent recovery attempt\n      }\n     }\n    }\n    \n    lastHeartbeatRef.current = now;\n   }, 1000);\n  } else {\n   if (heartbeatRef.current) {\n    clearInterval(heartbeatRef.current);\n    heartbeatRef.current = null;\n   }\n  }\n\n  return () => {\n   if (heartbeatRef.current) {\n    clearInterval(heartbeatRef.current);\n    heartbeatRef.current = null;\n   }\n  };\n }, [isTracking, sessionKey]);\n\n // Load persisted session on mount\n useEffect(() => {\n  const persistedSession = localStorage.getItem(sessionKey);\n  if (persistedSession) {\n   try {\n    const { isTracking: wasTracking, accumulatedMs, startedAt, hasSession } = JSON.parse(persistedSession);\n    if (hasSession) {\n     setAccumulatedActiveMs(accumulatedMs);\n     setElapsedTime(accumulatedMs); // Update UI to show accumulated time\n     setHasActiveSession(true);\n     if (wasTracking && startedAt) {\n      setLastStartedAt(startedAt);\n      setIsTracking(true);\n      startTimer();\n     } else {\n      // Paused session\n      setIsTracking(false);\n      setLastStartedAt(null);\n     }\n    }\n   } catch (error) {\n    // Clear invalid session data\n    localStorage.removeItem(sessionKey);\n   }\n  }\n }, [eventId]);\n\n // Persist session state\n const persistSession = (tracking: boolean, accumulated: number, started: number | null, hasSession: boolean) => {\n  if (hasSession) {\n   localStorage.setItem(sessionKey, JSON.stringify({\n    isTracking: tracking,\n    accumulatedMs: accumulated,\n    startedAt: started,\n    hasSession: hasSession\n   }));\n  } else {\n   localStorage.removeItem(sessionKey);\n  }\n };\n\n // Start timer interval with direct implementation\n const startTimer = () => {\n  if (intervalRef.current) {\n   clearInterval(intervalRef.current);\n  }\n  intervalRef.current = window.setInterval(() => {\n   const now = Date.now();\n   // Access current values from refs to avoid stale closures\n   const currentAccumulated = accumulatedActiveMsRef.current;\n   const currentStartedAt = lastStartedAtRef.current;\n   const currentTracking = isTrackingRef.current;\n   \n   let currentElapsed = currentAccumulated;\n   if (currentTracking && currentStartedAt) {\n    currentElapsed += (now - currentStartedAt);\n   }\n   setElapsedTime(currentElapsed);\n  }, 1000);\n };\n\n // Mobile-hardened background/foreground handling\n useEffect(() => {\n  const handleVisibilityChange = () => {\n   const now = Date.now();\n   \n   if (document.visibilityState === 'hidden' && isTracking) {\n    // App backgrounded - persist current state\n    const accumulated = accumulatedActiveMs + (lastStartedAt ? now - lastStartedAt : 0);\n    persistSession(true, accumulated, now, true);\n   } else if (document.visibilityState === 'visible' && isTracking && lastStartedAt) {\n    // App foregrounded - check for time drift and correct if needed\n    const expectedElapsed = accumulatedActiveMs + (now - lastStartedAt);\n    const timeDrift = Math.abs(elapsedTime - expectedElapsed);\n    \n    // If time drift > 5 seconds, likely the timer was paused by system\n    if (timeDrift > 5000) {\n     // Recalculate from persisted data\n     const persistedSession = localStorage.getItem(sessionKey);\n     if (persistedSession) {\n      try {\n       const { accumulatedMs, startedAt } = JSON.parse(persistedSession);\n       const correctedElapsed = accumulatedMs + (now - startedAt);\n       setElapsedTime(correctedElapsed);\n       setAccumulatedActiveMs(accumulatedMs);\n       setLastStartedAt(startedAt);\n      } catch (error) {\n       // Silent recovery attempt\n      }\n     }\n    }\n   }\n  };\n\n  const handleFocusChange = () => {\n   // Additional mobile event for app focus changes\n   if (document.hasFocus() && isTracking) {\n    // Re-sync timer when app regains focus\n    startTimer();\n   }\n  };\n\n  const handlePageHide = () => {\n   // More reliable than beforeunload on mobile\n   if (isTracking && lastStartedAt) {\n    const now = Date.now();\n    const accumulated = accumulatedActiveMs + (now - lastStartedAt);\n    persistSession(true, accumulated, now, true);\n   }\n  };\n\n  const handleBeforeUnload = () => {\n   if (isTracking && lastStartedAt) {\n    // Auto-save session on page unload\n    const now = Date.now();\n    const accumulated = accumulatedActiveMs + (now - lastStartedAt);\n    persistSession(true, accumulated, now, true);\n   }\n  };\n\n  // Mobile-optimized event listeners\n  document.addEventListener('visibilitychange', handleVisibilityChange);\n  window.addEventListener('focus', handleFocusChange);\n  window.addEventListener('blur', handleFocusChange);\n  window.addEventListener('pagehide', handlePageHide);\n  window.addEventListener('beforeunload', handleBeforeUnload);\n\n  return () => {\n   document.removeEventListener('visibilitychange', handleVisibilityChange);\n   window.removeEventListener('focus', handleFocusChange);\n   window.removeEventListener('blur', handleFocusChange);\n   window.removeEventListener('pagehide', handlePageHide);\n   window.removeEventListener('beforeunload', handleBeforeUnload);\n  };\n }, [isTracking, lastStartedAt, accumulatedActiveMs, sessionKey, elapsedTime]);\n\n // Start time tracking mutation with mobile network retry\n const startTrackingMutation = useMutation({\n  mutationFn: async () => {\n   const startTime = new Date();\n   \n   // Mobile-friendly retry logic for network issues\n   const maxRetries = isOnline ? 2 : 0;\n   let lastError;\n   \n   for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n     return await apiRequest('POST', '/api/time-tracking/start', {\n      eventId,\n      startTime: startTime.toISOString()\n     });\n    } catch (error) {\n     lastError = error;\n     if (attempt < maxRetries) {\n      // Wait briefly before retry (mobile networks can be flaky)\n      await new Promise(resolve => setTimeout(resolve, 1000));\n     }\n    }\n   }\n   throw lastError;\n  },\n  onSuccess: () => {\n   toast({\n    title:\"Time tracking started\",\n    description: `Started tracking time for\"${eventTitle}\"`,\n    duration: 2000\n   });\n  },\n  onError: (error) => {\n   \n   // Calculate any time already tracked since handleStart\n   const now = Date.now();\n   const currentAccumulated = accumulatedActiveMsRef.current;\n   const currentStartedAt = lastStartedAtRef.current;\n   const tracked = currentStartedAt ? now - currentStartedAt : 0;\n   const totalAccumulated = currentAccumulated + tracked;\n   \n   // Preserve session with tracked time so user can save later\n   setIsTracking(false);\n   setHasActiveSession(true); // Keep session active\n   setLastStartedAt(null);\n   setAccumulatedActiveMs(totalAccumulated);\n   setElapsedTime(totalAccumulated);\n   \n   if (intervalRef.current) {\n    clearInterval(intervalRef.current);\n    intervalRef.current = null;\n   }\n   \n   // Persist the tracked time for later saving\n   persistSession(false, totalAccumulated, null, true);\n   \n   toast({\n    title:\"Error\",\n    description:\"Failed to start time tracking. Your tracked time is saved, you can try again or stop to save.\",\n    variant:\"destructive\",\n    duration: 4000\n   });\n  }\n });\n\n // Stop time tracking mutation\n const stopTrackingMutation = useMutation({\n  mutationFn: async (activeDuration: number) => {\n   // Mobile-friendly retry logic for network issues\n   const maxRetries = isOnline ? 2 : 0;\n   let lastError;\n   \n   for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n     return await apiRequest('POST', '/api/time-tracking/stop', {\n      eventId,\n      endTime: new Date().toISOString(),\n      durationMinutes: Math.round(activeDuration / (60 * 1000))\n     });\n    } catch (error) {\n     lastError = error;\n     if (attempt < maxRetries) {\n      // Wait briefly before retry\n      await new Promise(resolve => setTimeout(resolve, 1000));\n     }\n    }\n   }\n   throw lastError;\n  },\n  onSuccess: (data) => {\n   // Clear session state only after successful API call\n   setAccumulatedActiveMs(0);\n   setHasActiveSession(false);\n   localStorage.removeItem(sessionKey);\n   \n   // Complete cache invalidation for all related queries\n   queryClient.invalidateQueries({ queryKey: ['/api/events'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/events', eventId] });\n   queryClient.invalidateQueries({ queryKey: ['/api/events', eventId, 'time-value'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/events', eventId, 'financial-summary'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/dashboard/time-stats'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/insights/time-value'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/events/upcoming'] });\n   \n   const totalMinutes = Math.round(elapsedTime / (60 * 1000));\n   onTimeUpdate?.(totalMinutes);\n   \n   toast({\n    title:\"Time tracking stopped\",\n    description: `Logged ${formatDuration(elapsedTime)} for\"${eventTitle}\"`,\n    duration: 3000\n   });\n  },\n  onError: (error, totalActiveDuration) => {\n   \n   // Restore session using the exact attempted duration to prevent race condition\n   setHasActiveSession(true);\n   persistSession(false, totalActiveDuration, null, true);\n   \n   toast({\n    title:\"Error\", \n    description:\"Failed to stop time tracking. Your session is saved, you can try again.\",\n    variant:\"destructive\",\n    duration: 4000\n   });\n  }\n });\n\n // Format duration for display\n const formatDuration = (milliseconds: number) => {\n  const hours = Math.floor(milliseconds / (1000 * 60 * 60));\n  const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));\n  const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);\n  \n  if (hours > 0) {\n   return `${hours}h ${minutes}m ${seconds}s`;\n  } else if (minutes > 0) {\n   return `${minutes}m ${seconds}s`;\n  } else {\n   return `${seconds}s`;\n  }\n };\n\n // Start tracking\n const handleStart = () => {\n  const now = Date.now();\n  setIsTracking(true);\n  setLastStartedAt(now);\n  setHasActiveSession(true);\n  startTrackingMutation.mutate();\n  startTimer();\n  persistSession(true, accumulatedActiveMs, now, true);\n };\n\n // Pause tracking (keep session but stop timer)\n const handlePause = () => {\n  if (isTracking && lastStartedAt) {\n   const now = Date.now();\n   const newAccumulated = accumulatedActiveMs + (now - lastStartedAt);\n   \n   setAccumulatedActiveMs(newAccumulated);\n   setElapsedTime(newAccumulated); // Update UI immediately\n   setIsTracking(false);\n   setLastStartedAt(null);\n   \n   if (intervalRef.current) {\n    clearInterval(intervalRef.current);\n    intervalRef.current = null;\n   }\n   \n   // Keep session active but paused\n   persistSession(false, newAccumulated, null, true);\n  }\n };\n\n // Resume tracking\n const handleResume = () => {\n  const now = Date.now();\n  setIsTracking(true);\n  setLastStartedAt(now);\n  startTimer();\n  persistSession(true, accumulatedActiveMs, now, true);\n };\n\n // Stop and save tracking\n const handleStop = () => {\n  let totalActiveDuration;\n  \n  if (isTracking && lastStartedAt) {\n   // Currently tracking - add current session\n   const now = Date.now();\n   const sessionDuration = now - lastStartedAt;\n   totalActiveDuration = accumulatedActiveMs + sessionDuration;\n  } else if (hasActiveSession) {\n   // Paused - use accumulated time only\n   totalActiveDuration = accumulatedActiveMs;\n  } else {\n   return; // No session to stop\n  }\n  \n  // Update both elapsed time and accumulated time to prevent data loss\n  setElapsedTime(totalActiveDuration);\n  setAccumulatedActiveMs(totalActiveDuration);\n  \n  // Stop timer but keep session until API succeeds\n  setIsTracking(false);\n  setLastStartedAt(null);\n  if (intervalRef.current) {\n   clearInterval(intervalRef.current);\n   intervalRef.current = null;\n  }\n  \n  // Persist the complete session before API call to prevent data loss\n  persistSession(false, totalActiveDuration, null, true);\n  \n  // Send total active duration - session cleanup in onSuccess\n  stopTrackingMutation.mutate(totalActiveDuration);\n };\n\n // Cleanup interval on unmount\n useEffect(() => {\n  return () => {\n   if (intervalRef.current) {\n    clearInterval(intervalRef.current);\n   }\n  };\n }, []);\n\n // Calculate progress vs planned time\n const currentMinutes = Math.round(elapsedTime / (60 * 1000));\n const progressPercentage = plannedDurationMinutes > 0 ? (currentMinutes / plannedDurationMinutes) * 100 : 0;\n const isOverPlanned = currentMinutes > plannedDurationMinutes && plannedDurationMinutes > 0;\n\n return (\n  <Card className={`time-tracker ${isTracking ? 'border-time-active' : ''}`} data-testid=\"time-tracker\">\n   <CardHeader className=\"pb-3\">\n    <CardTitle className=\"text-lg flex items-center gap-2\">\n     <Clock className={isTracking ?\"text-time-active\" :\"text-time\"} size={20} />\n     Time Tracker\n     {isTracking && (\n      <Badge variant=\"default\" className=\"bg-time-active text-white\">\n       Recording\n      </Badge>\n     )}\n     {!isOnline && (\n      <Badge variant=\"outline\" className=\"border-orange-500 text-orange-500 text-xs\">\n       Offline\n      </Badge>\n     )}\n    </CardTitle>\n   </CardHeader>\n   \n   <CardContent className=\"space-y-4\">\n    {/* Timer Display */}\n    <div className=\"text-center\">\n     <div className={`text-3xl font-mono font-bold ${isTracking ? 'text-time-active' : 'text-foreground'}`} data-testid=\"text-elapsed-time\">\n      {formatDuration(elapsedTime)}\n     </div>\n     {lastStartedAt && (\n      <p className=\"text-sm text-muted-foreground mt-1\">\n       Started at {new Date(lastStartedAt).toLocaleTimeString()}\n      </p>\n     )}\n    </div>\n\n    {/* Progress vs Planned */}\n    {plannedDurationMinutes > 0 && (\n     <div className=\"space-y-2\">\n      <div className=\"flex justify-between text-sm\">\n       <span className=\"text-muted-foreground\">Progress vs Planned</span>\n       <span className={isOverPlanned ?\"text-value-negative\" :\"text-value-positive\"}>\n        {Math.round(progressPercentage)}%\n       </span>\n      </div>\n      <div className=\"w-full bg-muted rounded-full h-2\">\n       <div \n        className={`h-2 rounded-full transition-all ${\n         isOverPlanned ? 'bg-value-negative' : 'bg-time-active'\n        }`}\n        style={{ width: `${Math.min(progressPercentage, 100)}%` }}\n       />\n      </div>\n      <div className=\"flex justify-between text-xs text-muted-foreground\">\n       <span>Planned: {Math.round(plannedDurationMinutes)}min</span>\n       <span>Current: {currentMinutes}min</span>\n      </div>\n     </div>\n    )}\n\n    {/* Control Buttons */}\n    <div className=\"flex gap-2 justify-center\">\n     {!hasActiveSession && (\n      <Button \n       onClick={handleStart}\n       disabled={startTrackingMutation.isPending}\n       className=\"bg-time-active hover:bg-time-active/90\"\n       data-testid=\"button-start-tracking\"\n      >\n       <Play size={16} className=\"mr-2\" />\n       Start Tracking\n      </Button>\n     )}\n     \n     {isTracking && hasActiveSession && (\n      <Button \n       onClick={handlePause}\n       variant=\"outline\"\n       data-testid=\"button-pause-tracking\"\n      >\n       <Pause size={16} className=\"mr-2\" />\n       Pause\n      </Button>\n     )}\n     \n     {!isTracking && hasActiveSession && (\n      <Button \n       onClick={handleResume}\n       className=\"bg-time-active hover:bg-time-active/90\"\n       data-testid=\"button-resume-tracking\"\n      >\n       <Play size={16} className=\"mr-2\" />\n       Resume\n      </Button>\n     )}\n     \n     {hasActiveSession && (\n      <Button \n       onClick={handleStop}\n       variant=\"destructive\"\n       disabled={stopTrackingMutation.isPending}\n       data-testid=\"button-stop-tracking\"\n      >\n       <Square size={16} className=\"mr-2\" />\n       Stop & Save\n      </Button>\n     )}\n    </div>\n\n    {/* Quick Stats */}\n    {actualDurationMinutes > 0 && (\n     <div className=\"grid grid-cols-3 gap-2 pt-3 border-t\">\n      <div className=\"text-center\">\n       <div className=\"text-sm font-medium\">{Math.round(actualDurationMinutes)}min</div>\n       <div className=\"text-xs text-muted-foreground\">Total</div>\n      </div>\n      {plannedDurationMinutes > 0 && (\n       <>\n        <div className=\"text-center\">\n         <div className=\"text-sm font-medium\">{Math.round(plannedDurationMinutes)}min</div>\n         <div className=\"text-xs text-muted-foreground\">Planned</div>\n        </div>\n        <div className=\"text-center\">\n         <div className={`text-sm font-medium ${\n          actualDurationMinutes <= plannedDurationMinutes ? 'text-value-positive' : 'text-value-negative'\n         }`}>\n          {actualDurationMinutes <= plannedDurationMinutes ? '+' : ''}{Math.round(plannedDurationMinutes - actualDurationMinutes)}min\n         </div>\n         <div className=\"text-xs text-muted-foreground\">Variance</div>\n        </div>\n       </>\n      )}\n     </div>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":20445,"size_tokens":null},"client/src/components/payment-form.tsx":{"content":"import { useState } from\"react\";\nimport { useStripe, useElements, PaymentElement } from\"@stripe/react-stripe-js\";\nimport { Button } from\"@/components/ui/button\";\nimport { Alert, AlertDescription } from\"@/components/ui/alert\";\nimport { Loader2 } from\"lucide-react\";\n\ninterface PaymentFormProps {\n onSuccess: () => void;\n onError: (error: string) => void;\n}\n\nexport default function PaymentForm({ onSuccess, onError }: PaymentFormProps) {\n const stripe = useStripe();\n const elements = useElements();\n const [isLoading, setIsLoading] = useState(false);\n const [error, setError] = useState<string | null>(null);\n\n const handleSubmit = async (e: React.FormEvent) => {\n  e.preventDefault();\n  setError(null);\n\n  if (!stripe || !elements) {\n   setError(\"Payment system not initialized\");\n   return;\n  }\n\n  setIsLoading(true);\n\n  try {\n   const { error: submitError } = await elements.submit();\n   if (submitError) {\n    setError(submitError.message ||\"Failed to submit payment information\");\n    setIsLoading(false);\n    return;\n   }\n\n   const { error: confirmError } = await stripe.confirmPayment({\n    elements,\n    confirmParams: {\n     return_url: window.location.origin + '/subscription',\n    },\n    redirect: 'if_required',\n   });\n\n   if (confirmError) {\n    setError(confirmError.message ||\"Payment failed\");\n    onError(confirmError.message ||\"Payment failed\");\n   } else {\n    onSuccess();\n   }\n  } catch (err: any) {\n   setError(err.message ||\"An unexpected error occurred\");\n   onError(err.message ||\"An unexpected error occurred\");\n  } finally {\n   setIsLoading(false);\n  }\n };\n\n return (\n  <form onSubmit={handleSubmit} className=\"space-y-6\">\n   <div className=\"bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg\">\n    <PaymentElement\n     options={{\n      layout:\"tabs\",\n      paymentMethodOrder: ['card'],\n     }}\n    />\n   </div>\n\n   {error && (\n    <Alert variant=\"destructive\" data-testid=\"alert-payment-error\">\n     <AlertDescription>{error}</AlertDescription>\n    </Alert>\n   )}\n\n   <Button\n    type=\"submit\"\n    className=\"w-full\"\n    disabled={!stripe || !elements || isLoading}\n    data-testid=\"button-complete-payment\"\n   >\n    {isLoading ? (\n     <div className=\"flex items-center gap-2\">\n      <Loader2 className=\"w-4 h-4\" />\n      Processing Payment...\n     </div>\n    ) : (\n     'Complete Payment'\n    )}\n   </Button>\n\n   <div className=\"text-xs text-gray-500 dark:text-gray-400 text-center\">\n    Your payment information is encrypted and secure. \n    We never store your payment details.\n   </div>\n  </form>\n );\n}","path":null,"size_bytes":2531,"size_tokens":null},"client/src/lib/social-sharing.ts":{"content":"// Social sharing utilities for Twealth\n\nexport interface ShareData {\n title: string;\n description: string;\n url?: string;\n hashtags?: string[];\n via?: string;\n}\n\nexport interface AchievementShareData extends ShareData {\n achievementType: 'milestone' | 'goal_completed' | 'streak' | 'ai_insight';\n value?: string;\n goalTitle?: string;\n category?: 'bronze' | 'silver' | 'gold' | 'platinum';\n progress?: number;\n}\n\n/**\n * Generate sharing URLs for different social media platforms\n */\nexport const getSocialShareUrls = (data: ShareData) => {\n const baseUrl = window.location.origin;\n const shareUrl = data.url || window.location.href;\n const encodedUrl = encodeURIComponent(shareUrl);\n const encodedTitle = encodeURIComponent(data.title);\n const encodedDescription = encodeURIComponent(data.description);\n const hashtags = data.hashtags?.join(',') || 'Twealth,FinancialGoals,AI';\n \n return {\n  twitter: `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}&hashtags=${hashtags}${data.via ? `&via=${data.via}` : ''}`,\n  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedTitle}`,\n  linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}&title=${encodedTitle}&summary=${encodedDescription}`,\n  whatsapp: `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`,\n  telegram: `https://t.me/share/url?url=${encodedUrl}&text=${encodedTitle}`,\n  email: `mailto:?subject=${encodedTitle}&body=${encodedDescription}%20${encodedUrl}`,\n  copy: shareUrl\n };\n};\n\n/**\n * Generate achievement-specific share content\n */\nexport const getAchievementShareContent = (achievement: AchievementShareData): ShareData => {\n const { achievementType, value, goalTitle, category, progress } = achievement;\n \n // Get appropriate category labels based on tier\n const categoryLabel = {\n  bronze: 'Bronze',\n  silver: 'Silver', \n  gold: 'Gold',\n  platinum: 'Platinum'\n }[category || 'bronze'];\n\n // Generate content based on achievement type\n switch (achievementType) {\n  case 'milestone':\n   return {\n    title: `${categoryLabel} Achievement unlocked! ${progress}% progress towards \"${goalTitle}\"`,\n    description: `I'm making great progress on my financial goals with Twealth's AI assistant! ${progress}% closer to achieving \"${goalTitle}\". Join me on this journey to financial success!`,\n    hashtags: ['FinancialGoals', 'Achievement', 'Savings', 'TwealthAI', 'MoneyGoals'],\n    via: 'TwealthApp'\n   };\n\n  case 'goal_completed':\n   return {\n    title: `Goal achieved! I just completed \"${goalTitle}\" with Twealth!`,\n    description: `Another financial goal conquered! Just saved ${value} for \"${goalTitle}\" using Twealth's AI-powered financial planning. Ready to tackle the next one!`,\n    hashtags: ['GoalAchieved', 'FinancialSuccess', 'Savings', 'TwealthAI', 'MoneyWins'],\n    via: 'TwealthApp'\n   };\n\n  case 'streak':\n   return {\n    title: `${value}-day savings streak! Consistency is key!`,\n    description: `I've been consistently saving towards my goals for ${value} days straight using Twealth! The AI insights make it so much easier to stay on track.`,\n    hashtags: ['SavingsStreak', 'Consistency', 'FinancialHabits', 'TwealthAI', 'MoneyMotivation'],\n    via: 'TwealthApp'\n   };\n\n  case 'ai_insight':\n   return {\n    title: `AI-powered insight: \"${achievement.title}\"`,\n    description: `Twealth's AI just gave me this brilliant financial insight: \"${achievement.description}\" These personalized tips are game-changers for my money management!`,\n    hashtags: ['AIInsights', 'SmartMoney', 'FinancialTips', 'TwealthAI', 'MoneyHacks'],\n    via: 'TwealthApp'\n   };\n\n  default:\n   return {\n    title: `Making progress with Twealth!`,\n    description: `I'm using Twealth's AI-powered financial planning to achieve my goals! The insights and tracking make saving so much easier.`,\n    hashtags: ['FinancialGoals', 'TwealthAI', 'MoneyManagement'],\n    via: 'TwealthApp'\n   };\n }\n};\n\n/**\n * Generate goal progress share content\n */\nexport const getGoalProgressShareContent = (goal: {\n title: string;\n currentAmount: number;\n targetAmount: number;\n progress: number;\n daysRemaining?: number;\n}): ShareData => {\n const { title, currentAmount, targetAmount, progress, daysRemaining } = goal;\n const progressLabel = progress >= 75 ? 'Nearly there' : progress >= 50 ? 'Halfway' : progress >= 25 ? 'Making progress' : 'Just started';\n \n return {\n  title: `${progressLabel}: ${Math.round(progress)}% towards my \"${title}\" goal!`,\n  description: `Making solid progress! I've saved $${currentAmount.toLocaleString()} out of $${targetAmount.toLocaleString()} for \"${title}\" using Twealth's AI assistant.${daysRemaining ? ` ${daysRemaining} days to go!` : ''}`,\n  hashtags: ['ProgressUpdate', 'FinancialGoals', 'Savings', 'TwealthAI', 'MoneyProgress'],\n  via: 'TwealthApp'\n };\n};\n\n/**\n * Generate referral share content\n */\nexport const getReferralShareContent = (referralCode: string, bonusAmount: number = 10): ShareData => {\n const referralUrl = `${window.location.origin}?ref=${referralCode}`;\n \n return {\n  title: `Get ${bonusAmount} FREE AI chats with Twealth!`,\n  description: `I'm loving Twealth for managing my finances with AI! Use my code \"${referralCode}\" to get ${bonusAmount} free AI financial consultations and start your journey to financial success!`,\n  url: referralUrl,\n  hashtags: ['FreeAI', 'FinancialPlanning', 'TwealthAI', 'MoneyManagement', 'FreeCredits'],\n  via: 'TwealthApp'\n };\n};\n\n/**\n * Generate group achievement share content\n */\nexport const getGroupAchievementShareContent = (group: {\n name: string;\n achievement: string;\n memberCount: number;\n totalSaved?: number;\n}): ShareData => {\n const { name, achievement, memberCount, totalSaved } = group;\n \n return {\n  title: `Group Achievement: \"${achievement}\" with ${name}!`,\n  description: `Our group \"${name}\" just achieved \"${achievement}\"! ${memberCount} members collaborating towards our financial goals${totalSaved ? `, saving a total of $${totalSaved.toLocaleString()}` : ''}. Teamwork makes the dream work!`,\n  hashtags: ['GroupGoals', 'TeamWork', 'FinancialSuccess', 'TwealthAI', 'CollaborativeSaving'],\n  via: 'TwealthApp'\n };\n};\n\n/**\n * Open share dialog for different platforms\n */\nexport const shareToSocialMedia = (platform: string, data: ShareData) => {\n const urls = getSocialShareUrls(data);\n \n switch (platform) {\n  case 'copy':\n   navigator.clipboard.writeText(urls.copy);\n   return { success: true, message: 'Link copied to clipboard!' };\n   \n  case 'email':\n   window.location.href = urls.email;\n   return { success: true, message: 'Email client opened' };\n   \n  default:\n   const url = urls[platform as keyof typeof urls];\n   if (url && typeof url === 'string') {\n    window.open(url, '_blank', 'noopener,noreferrer,width=600,height=400');\n    return { success: true, message: `Shared to ${platform}` };\n   }\n   return { success: false, message: 'Platform not supported' };\n }\n};\n\n/**\n * Check if native sharing is available\n */\nexport const isNativeShareAvailable = (): boolean => {\n return typeof navigator !== 'undefined' && 'share' in navigator;\n};\n\n/**\n * Use native share if available, fallback to custom sharing\n */\nexport const shareContent = async (data: ShareData) => {\n if (isNativeShareAvailable()) {\n  try {\n   await navigator.share({\n    title: data.title,\n    text: data.description,\n    url: data.url || window.location.href\n   });\n   return { success: true, message: 'Shared successfully!' };\n  } catch (error) {\n   // User cancelled or error occurred, fallback to custom sharing\n  }\n }\n \n // Fallback to copy to clipboard\n const shareText = `${data.title}\\n\\n${data.description}\\n\\n${data.url || window.location.href}`;\n await navigator.clipboard.writeText(shareText);\n return { success: true, message: 'Content copied to clipboard!' };\n};","path":null,"size_bytes":7790,"size_tokens":null},"client/src/components/goals/achievement-milestones.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { \n Award, \n Trophy, \n Star, \n Target, \n Zap,\n Crown,\n Medal,\n Rocket,\n CheckCircle,\n Calendar,\n TrendingUp,\n Gift,\n Sparkles\n} from\"lucide-react\";\nimport { differenceInDays, format, addDays } from\"date-fns\";\nimport ShareButton from\"@/components/social/share-button\";\nimport { getAchievementShareContent, AchievementShareData } from\"@/lib/social-sharing\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface Goal {\n id: string;\n title: string;\n description?: string;\n targetAmount: string;\n currentAmount: string;\n targetDate: string;\n category?: string;\n priority: string;\n status: string;\n createdAt?: string;\n}\n\ninterface AchievementMilestonesProps {\n goals: Goal[];\n onCelebrate?: (milestone: any) => void;\n}\n\ninterface Milestone {\n id: string;\n goalId?: string;\n type: 'progress' | 'streak' | 'achievement' | 'upcoming';\n icon: any;\n title: string;\n description: string;\n status: 'completed' | 'in-progress' | 'upcoming';\n progress?: number;\n reward?: string;\n date?: string;\n category: 'bronze' | 'silver' | 'gold' | 'platinum';\n points: number;\n}\n\nexport default function AchievementMilestones({ goals, onCelebrate }: AchievementMilestonesProps) {\n const { formatAmount } = useUserCurrency();\n \n const generateMilestones = (): Milestone[] => {\n  const milestones: Milestone[] = [];\n  const completedGoals = goals.filter(goal => goal.status === 'completed');\n  const activeGoals = goals.filter(goal => goal.status === 'active');\n\n  // Progress-based milestones for active goals\n  activeGoals.forEach(goal => {\n   const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n   const amount = parseFloat(goal.currentAmount);\n   \n   // 25% milestone\n   if (progress >= 25 && progress < 50) {\n    milestones.push({\n     id: `quarter-${goal.id}`,\n     goalId: goal.id,\n     type: 'progress',\n     icon: Star,\n     title: 'Quarter Way There!',\n     description: `You've saved 25% towards\"${goal.title}\" - great start!`,\n     status: 'completed',\n     progress: 25,\n     reward: 'Bronze Achievement',\n     category: 'bronze',\n     points: 50\n    });\n   }\n\n   // 50% milestone\n   if (progress >= 50 && progress < 75) {\n    milestones.push({\n     id: `half-${goal.id}`,\n     goalId: goal.id,\n     type: 'progress',\n     icon: Medal,\n     title: 'Halfway Hero!',\n     description: `Incredible! You're halfway to your\"${goal.title}\" goal!`,\n     status: 'completed',\n     progress: 50,\n     reward: 'Silver Achievement',\n     category: 'silver',\n     points: 100\n    });\n   }\n\n   // 75% milestone\n   if (progress >= 75 && progress < 100) {\n    milestones.push({\n     id: `three-quarter-${goal.id}`,\n     goalId: goal.id,\n     type: 'progress',\n     icon: Trophy,\n     title: 'Almost There!',\n     description: `You're 75% done with\"${goal.title}\" - the finish line is in sight!`,\n     status: 'completed',\n     progress: 75,\n     reward: 'Gold Achievement',\n     category: 'gold',\n     points: 150\n    });\n   }\n\n   // Upcoming milestone predictions\n   if (progress < 25) {\n    milestones.push({\n     id: `upcoming-quarter-${goal.id}`,\n     goalId: goal.id,\n     type: 'upcoming',\n     icon: Star,\n     title: 'First Quarter Goal',\n     description: `${formatAmount(parseFloat(goal.targetAmount) * 0.25 - amount)} away from 25% completion`,\n     status: 'upcoming',\n     progress: progress,\n     category: 'bronze',\n     points: 50\n    });\n   } else if (progress < 50) {\n    milestones.push({\n     id: `upcoming-half-${goal.id}`,\n     goalId: goal.id,\n     type: 'upcoming',\n     icon: Medal,\n     title: 'Halfway Point',\n     description: `${formatAmount(parseFloat(goal.targetAmount) * 0.5 - amount)} away from 50% completion`,\n     status: 'upcoming',\n     progress: progress,\n     category: 'silver',\n     points: 100\n    });\n   } else if (progress < 75) {\n    milestones.push({\n     id: `upcoming-three-quarter-${goal.id}`,\n     goalId: goal.id,\n     type: 'upcoming',\n     icon: Trophy,\n     title: 'Three-Quarter Mark',\n     description: `${formatAmount(parseFloat(goal.targetAmount) * 0.75 - amount)} away from 75% completion`,\n     status: 'upcoming',\n     progress: progress,\n     category: 'gold',\n     points: 150\n    });\n   } else if (progress < 100) {\n    milestones.push({\n     id: `upcoming-complete-${goal.id}`,\n     goalId: goal.id,\n     type: 'upcoming',\n     icon: Crown,\n     title: 'Goal Completion',\n     description: `${formatAmount(parseFloat(goal.targetAmount) - amount)} away from completing this goal!`,\n     status: 'upcoming',\n     progress: progress,\n     category: 'platinum',\n     points: 500\n    });\n   }\n  });\n\n  // Completion achievements\n  completedGoals.forEach(goal => {\n   milestones.push({\n    id: `completed-${goal.id}`,\n    goalId: goal.id,\n    type: 'achievement',\n    icon: Crown,\n    title: 'Goal Conquered!',\n    description: `Successfully completed\"${goal.title}\" - amazing work!`,\n    status: 'completed',\n    progress: 100,\n    reward: 'Platinum Achievement',\n    category: 'platinum',\n    points: 500\n   });\n  });\n\n  // Streak and portfolio achievements\n  if (activeGoals.length >= 3) {\n   milestones.push({\n    id: 'multi-goal-manager',\n    type: 'achievement',\n    icon: Target,\n    title: 'Multi-Goal Manager',\n    description: `Managing ${activeGoals.length} goals simultaneously - you're a pro!`,\n    status: 'completed',\n    reward: 'Gold Achievement',\n    category: 'gold',\n    points: 200\n   });\n  }\n\n  if (completedGoals.length >= 1) {\n   milestones.push({\n    id: 'goal-achiever',\n    type: 'achievement',\n    icon: CheckCircle,\n    title: 'Goal Achiever',\n    description: `Completed your first financial goal - you're building great habits!`,\n    status: 'completed',\n    reward: 'Silver Achievement',\n    category: 'silver',\n    points: 150\n   });\n  }\n\n  if (completedGoals.length >= 5) {\n   milestones.push({\n    id: 'goal-master',\n    type: 'achievement',\n    icon: Rocket,\n    title: 'Goal Master',\n    description: `Completed 5+ goals - you're a financial planning expert!`,\n    status: 'completed',\n    reward: 'Platinum Achievement',\n    category: 'platinum',\n    points: 1000\n   });\n  }\n\n  // Time-based achievements\n  const quickGoals = completedGoals.filter(goal => {\n   if (!goal.createdAt) return false;\n   const completionTime = differenceInDays(new Date(), new Date(goal.createdAt));\n   const targetTime = differenceInDays(new Date(goal.targetDate), new Date(goal.createdAt));\n   return completionTime < targetTime * 0.8; // Completed 20% faster than planned\n  });\n\n  if (quickGoals.length > 0) {\n   milestones.push({\n    id: 'speed-saver',\n    type: 'achievement',\n    icon: Zap,\n    title: 'Speed Saver',\n    description: `Completed a goal ahead of schedule - excellent planning!`,\n    status: 'completed',\n    reward: 'Gold Achievement',\n    category: 'gold',\n    points: 300\n   });\n  }\n\n  return milestones.sort((a, b) => {\n   if (a.status !== b.status) {\n    if (a.status === 'completed') return -1;\n    if (b.status === 'completed') return 1;\n    if (a.status === 'in-progress') return -1;\n    if (b.status === 'in-progress') return 1;\n   }\n   return b.points - a.points;\n  });\n };\n\n const milestones = generateMilestones();\n const totalPoints = milestones\n  .filter(m => m.status === 'completed')\n  .reduce((sum, m) => sum + m.points, 0);\n\n const getStatusColor = (status: string) => {\n  switch (status) {\n   case 'completed': return 'border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950/20';\n   case 'in-progress': return 'border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950/20';\n   case 'upcoming': return 'border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-950/20';\n   default: return 'border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-950/20';\n  }\n };\n\n const getCategoryColor = (category: string) => {\n  switch (category) {\n   case 'bronze': return 'text-orange-600';\n   case 'silver': return 'text-gray-600';\n   case 'gold': return 'text-yellow-600';\n   case 'platinum': return 'text-blue-600';\n   default: return 'text-gray-600';\n  }\n };\n\n const getCategoryBadge = (category: string) => {\n  switch (category) {\n   case 'bronze': return 'bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-300';\n   case 'silver': return 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300';\n   case 'gold': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300';\n   case 'platinum': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300';\n   default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300';\n  }\n };\n\n if (milestones.length === 0) {\n  return (\n   <Card>\n    <CardHeader>\n     <CardTitle className=\"flex items-center\">\n      <Award className=\"mr-2 h-5 w-5\" />\n      Achievement Milestones\n     </CardTitle>\n    </CardHeader>\n    <CardContent>\n     <div className=\"text-center py-8\">\n      <Trophy className=\"mx-auto h-12 w-12 text-muted-foreground mb-4\" />\n      <h3 className=\"text-lg font-medium mb-2\">Start Your Journey</h3>\n      <p className=\"text-muted-foreground\">\n       Create goals and start saving to unlock achievements and celebrate your progress!\n      </p>\n     </div>\n    </CardContent>\n   </Card>\n  );\n }\n\n return (\n  <Card>\n   <CardHeader>\n    <CardTitle className=\"flex items-center justify-between\">\n     <div className=\"flex items-center\">\n      <Award className=\"mr-2 h-5 w-5\" />\n      Achievement Milestones\n     </div>\n     <div className=\"flex items-center space-x-2\">\n      <Badge variant=\"secondary\" className=\"flex items-center\">\n       <Sparkles className=\"mr-1 h-3 w-3\" />\n       {totalPoints} points\n      </Badge>\n     </div>\n    </CardTitle>\n   </CardHeader>\n   <CardContent>\n    {/* Achievement Summary */}\n    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-white dark:bg-gray-900 rounded-lg border border-blue-200 dark:border-blue-800\">\n     <div className=\"text-center\">\n      <div className=\"text-2xl font-bold text-blue-600\">\n       {milestones.filter(m => m.status === 'completed').length}\n      </div>\n      <div className=\"text-xs text-blue-600/70\">Unlocked</div>\n     </div>\n     <div className=\"text-center\">\n      <div className=\"text-2xl font-bold text-blue-600\">\n       {milestones.filter(m => m.status === 'in-progress').length}\n      </div>\n      <div className=\"text-xs text-blue-600/70\">In Progress</div>\n     </div>\n     <div className=\"text-center\">\n      <div className=\"text-2xl font-bold text-gray-600\">\n       {milestones.filter(m => m.status === 'upcoming').length}\n      </div>\n      <div className=\"text-xs text-gray-600/70\">Upcoming</div>\n     </div>\n     <div className=\"text-center\">\n      <div className=\"text-2xl font-bold text-green-600\">{totalPoints}</div>\n      <div className=\"text-xs text-green-600/70\">Total Points</div>\n     </div>\n    </div>\n\n    <div className=\"space-y-4\">\n     {milestones.slice(0, 8).map((milestone) => (\n      <div \n       key={milestone.id}\n       className={`p-4 rounded-lg border ${getStatusColor(milestone.status)}`}\n       data-testid={`milestone-${milestone.id}`}\n      >\n       <div className=\"flex items-start justify-between\">\n        <div className=\"flex items-start space-x-3 flex-1\">\n         <div className={`p-2 rounded-lg ${milestone.status === 'completed' ? 'bg-green-100 dark:bg-green-900/20' : 'bg-gray-100 dark:bg-gray-900/20'}`}>\n          <milestone.icon className={`h-5 w-5 ${getCategoryColor(milestone.category)}`} />\n         </div>\n         <div className=\"flex-1\">\n          <div className=\"flex items-center space-x-2 mb-1\">\n           <h4 className=\"font-medium\">{milestone.title}</h4>\n           <Badge className={getCategoryBadge(milestone.category)}>\n            {milestone.category}\n           </Badge>\n           {milestone.status === 'completed' && (\n            <CheckCircle className=\"h-4 w-4 text-green-600\" />\n           )}\n          </div>\n          <p className=\"text-sm text-muted-foreground mb-2\">\n           {milestone.description}\n          </p>\n          \n          {milestone.progress !== undefined && milestone.status === 'upcoming' && (\n           <div className=\"space-y-1\">\n            <div className=\"flex justify-between text-xs\">\n             <span>Progress</span>\n             <span>{Math.round(milestone.progress)}%</span>\n            </div>\n            <Progress value={milestone.progress} className=\"h-2\" />\n           </div>\n          )}\n          \n          <div className=\"flex items-center justify-between mt-2\">\n           <div className=\"flex items-center space-x-4 text-xs text-muted-foreground\">\n            <span>{milestone.points} points</span>\n            {milestone.reward && (\n             <span className=\"flex items-center\">\n              <Gift className=\"h-3 w-3 mr-1\" />\n              {milestone.reward}\n             </span>\n            )}\n           </div>\n           {milestone.status === 'completed' && (\n            <div className=\"flex gap-2\">\n             <Button \n              size=\"sm\" \n              variant=\"outline\"\n              onClick={() => onCelebrate?.(milestone)}\n              data-testid={`button-celebrate-${milestone.id}`}\n             >\n              Celebrate\n             </Button>\n             <ShareButton\n              shareData={getAchievementShareContent({\n               title: milestone.title,\n               description: milestone.description,\n               achievementType: milestone.type === 'progress' ? 'milestone' : 'goal_completed',\n               goalTitle: goals.find(g => g.id === milestone.goalId)?.title,\n               progress: milestone.progress,\n               category: milestone.category\n              })}\n              variant=\"outline\"\n              size=\"sm\"\n              showText={false}\n              achievement={true}\n              data-testid={`button-share-${milestone.id}`}\n             />\n            </div>\n           )}\n          </div>\n         </div>\n        </div>\n       </div>\n      </div>\n     ))}\n    </div>\n\n    {milestones.length > 8 && (\n     <div className=\"text-center pt-4\">\n      <Button variant=\"ghost\" size=\"sm\" className=\"text-muted-foreground\">\n       View {milestones.length - 8} More Milestones\n      </Button>\n     </div>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":14436,"size_tokens":null},"client/src/components/goals/advanced-progress-visualization.tsx":{"content":"import { useMemo } from\"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Button } from\"@/components/ui/button\";\nimport { \n TrendingUp, \n Target, \n Calendar, \n DollarSign, \n PieChart, \n BarChart3,\n Clock,\n Award,\n CheckCircle,\n AlertTriangle\n} from\"lucide-react\";\nimport { format, differenceInDays, differenceInMonths } from\"date-fns\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface Goal {\n id: string;\n title: string;\n description?: string;\n targetAmount: string;\n currentAmount: string;\n targetDate: string;\n category?: string;\n priority: string;\n status: string;\n createdAt?: string;\n}\n\ninterface AdvancedProgressVisualizationProps {\n goals: Goal[];\n onGoalClick?: (goal: Goal) => void;\n}\n\nexport default function AdvancedProgressVisualization({ \n goals, \n onGoalClick \n}: AdvancedProgressVisualizationProps) {\n const { formatAmount } = useUserCurrency();\n \n // Memoize filtered goals to prevent recreation on each render\n const activeGoals = useMemo(() => \n  goals.filter(goal => goal.status === 'active'),\n  [goals]\n );\n \n const completedGoals = useMemo(() => \n  goals.filter(goal => goal.status === 'completed'),\n  [goals]\n );\n \n // Memoize calculated totals\n const { totalSaved, totalTargets, overallProgress } = useMemo(() => {\n  const saved = goals.reduce((sum, goal) => sum + parseFloat(goal.currentAmount), 0);\n  const targets = goals.reduce((sum, goal) => sum + parseFloat(goal.targetAmount), 0);\n  const progress = targets > 0 ? (saved / targets) * 100 : 0;\n  return { totalSaved: saved, totalTargets: targets, overallProgress: progress };\n }, [goals]);\n \n // Calculate velocity (savings rate)\n const calculateVelocity = (goal: Goal) => {\n  if (!goal.createdAt) return 0;\n  const daysActive = differenceInDays(new Date(), new Date(goal.createdAt));\n  if (daysActive <= 0) return 0;\n  return parseFloat(goal.currentAmount) / daysActive;\n };\n\n // Calculate projected completion\n const calculateProjection = (goal: Goal) => {\n  const velocity = calculateVelocity(goal);\n  if (velocity <= 0) return null;\n  \n  const remaining = parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount);\n  const daysNeeded = Math.ceil(remaining / velocity);\n  const projectedDate = new Date();\n  projectedDate.setDate(projectedDate.getDate() + daysNeeded);\n  \n  return projectedDate;\n };\n\n // Get goal status with smart insights\n const getGoalStatus = (goal: Goal) => {\n  const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n  const daysRemaining = differenceInDays(new Date(goal.targetDate), new Date());\n  const velocity = calculateVelocity(goal);\n  const projectedDate = calculateProjection(goal);\n  \n  if (progress >= 100) {\n   return { type: 'success', label: 'Completed', icon: CheckCircle, color: 'text-green-600' };\n  }\n  \n  if (daysRemaining < 0) {\n   return { type: 'danger', label: 'Overdue', icon: AlertTriangle, color: 'text-red-600' };\n  }\n  \n  if (projectedDate && projectedDate > new Date(goal.targetDate)) {\n   return { type: 'warning', label: 'At Risk', icon: AlertTriangle, color: 'text-yellow-600' };\n  }\n  \n  if (progress >= 80) {\n   return { type: 'success', label: 'On Track', icon: TrendingUp, color: 'text-green-600' };\n  }\n  \n  if (velocity > 0) {\n   return { type: 'info', label: 'Building', icon: TrendingUp, color: 'text-blue-600' };\n  }\n  \n  return { type: 'neutral', label: 'Getting Started', icon: Target, color: 'text-gray-600' };\n };\n\n // Category performance analysis\n const categoryAnalysis = () => {\n  const categories = activeGoals.reduce((acc, goal) => {\n   const category = goal.category || 'other';\n   if (!acc[category]) {\n    acc[category] = { totalTarget: 0, totalSaved: 0, count: 0 };\n   }\n   acc[category].totalTarget += parseFloat(goal.targetAmount);\n   acc[category].totalSaved += parseFloat(goal.currentAmount);\n   acc[category].count += 1;\n   return acc;\n  }, {} as Record<string, { totalTarget: number; totalSaved: number; count: number }>);\n\n  return Object.entries(categories).map(([category, data]) => ({\n   category,\n   progress: data.totalTarget > 0 ? (data.totalSaved / data.totalTarget) * 100 : 0,\n   saved: data.totalSaved,\n   target: data.totalTarget,\n   count: data.count\n  }));\n };\n\n const categoryData = useMemo(() => categoryAnalysis(), [activeGoals]);\n\n return (\n  <div className=\"space-y-6\">\n   {/* Overall Progress Overview */}\n   <Card className=\"bg-white dark:bg-gray-900 border-blue-200 dark:border-blue-800\">\n    <CardHeader className=\"pb-3\">\n     <CardTitle className=\"flex items-center text-blue-900 dark:text-blue-100\">\n      <PieChart className=\"mr-2 h-5 w-5\" />\n      Portfolio Overview\n     </CardTitle>\n    </CardHeader>\n    <CardContent>\n     <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n      <div className=\"text-center\">\n       <div className=\"text-2xl font-bold text-blue-600\">{activeGoals.length}</div>\n       <div className=\"text-xs text-blue-600/70\">Active Goals</div>\n      </div>\n      <div className=\"text-center\">\n       <div className=\"text-2xl font-bold text-green-600\">{completedGoals.length}</div>\n       <div className=\"text-xs text-green-600/70\">Completed</div>\n      </div>\n      <div className=\"text-center\">\n       <div className=\"text-2xl font-bold text-blue-600\">{formatAmount(totalSaved)}</div>\n       <div className=\"text-xs text-blue-600/70\">Total Saved</div>\n      </div>\n      <div className=\"text-center\">\n       <div className=\"text-2xl font-bold text-blue-600\">{Math.round(overallProgress)}%</div>\n       <div className=\"text-xs text-blue-600/70\">Overall Progress</div>\n      </div>\n     </div>\n     \n     <div className=\"space-y-2\">\n      <div className=\"flex justify-between text-sm\">\n       <span>Portfolio Progress</span>\n       <span>{formatAmount(totalSaved)} of {formatAmount(totalTargets)}</span>\n      </div>\n      <Progress value={overallProgress} className=\"h-3\" />\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Category Performance Analysis */}\n   {categoryData.length > 0 && (\n    <Card>\n     <CardHeader>\n      <CardTitle className=\"flex items-center\">\n       <BarChart3 className=\"mr-2 h-5 w-5\" />\n       Category Performance\n      </CardTitle>\n     </CardHeader>\n     <CardContent>\n      <div className=\"space-y-4\">\n       {categoryData.map(({ category, progress, saved, target, count }) => (\n        <div key={category} className=\"space-y-2\">\n         <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-2\">\n           <span className=\"font-medium capitalize\">{category}</span>\n           <Badge variant=\"secondary\" className=\"text-xs\">{count} goals</Badge>\n          </div>\n          <span className=\"text-sm text-muted-foreground\">\n           {formatAmount(saved)} / {formatAmount(target)}\n          </span>\n         </div>\n         <Progress value={progress} className=\"h-2\" />\n         <div className=\"text-xs text-muted-foreground\">\n          {Math.round(progress)}% complete\n         </div>\n        </div>\n       ))}\n      </div>\n     </CardContent>\n    </Card>\n   )}\n\n   {/* Advanced Goal Cards */}\n   <div className=\"space-y-4\">\n    <h3 className=\"text-lg font-semibold\">Goal Analytics</h3>\n    {activeGoals.map((goal) => {\n     const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n     const status = getGoalStatus(goal);\n     const velocity = calculateVelocity(goal);\n     const projectedDate = calculateProjection(goal);\n     const daysRemaining = differenceInDays(new Date(goal.targetDate), new Date());\n     const monthlyNeeded = daysRemaining > 0 \n      ? (parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount)) / (daysRemaining / 30)\n      : 0;\n\n     return (\n      <Card key={goal.id} className=\"hover:shadow-md transition-shadow cursor-pointer\"\n         onClick={() => onGoalClick?.(goal)}\n         data-testid={`card-goal-analytics-${goal.id}`}>\n       <CardContent className=\"p-6\">\n        <div className=\"flex items-start justify-between mb-4\">\n         <div className=\"flex-1 min-w-0\">\n          <h4 className=\"font-semibold text-lg mb-1 truncate\">{goal.title}</h4>\n          <div className=\"flex items-center space-x-4 text-sm text-muted-foreground\">\n           <div className=\"flex items-center\">\n            <status.icon className={`h-4 w-4 mr-1 ${status.color}`} />\n            <span className={status.color}>{status.label}</span>\n           </div>\n           {goal.category && (\n            <Badge variant=\"outline\" className=\"capitalize\">\n             {goal.category}\n            </Badge>\n           )}\n          </div>\n         </div>\n         <div className=\"text-right\">\n          <div className=\"text-2xl font-bold\">\n           {formatAmount(parseFloat(goal.currentAmount))}\n          </div>\n          <div className=\"text-sm text-muted-foreground\">\n           of {formatAmount(parseFloat(goal.targetAmount))}\n          </div>\n         </div>\n        </div>\n\n        <div className=\"space-y-3\">\n         <div>\n          <div className=\"flex justify-between text-sm mb-1\">\n           <span>Progress</span>\n           <span>{Math.round(progress)}%</span>\n          </div>\n          <Progress value={progress} className=\"h-2\" />\n         </div>\n\n         <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n          <div className=\"flex items-center space-x-2\">\n           <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n           <div>\n            <div className=\"font-medium\">{daysRemaining} days</div>\n            <div className=\"text-xs text-muted-foreground\">remaining</div>\n           </div>\n          </div>\n          \n          <div className=\"flex items-center space-x-2\">\n           <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n           <div>\n            <div className=\"font-medium\">{formatAmount(velocity)}</div>\n            <div className=\"text-xs text-muted-foreground\">daily rate</div>\n           </div>\n          </div>\n          \n          <div className=\"flex items-center space-x-2\">\n           <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n           <div>\n            <div className=\"font-medium\">{formatAmount(monthlyNeeded)}</div>\n            <div className=\"text-xs text-muted-foreground\">monthly needed</div>\n           </div>\n          </div>\n          \n          {projectedDate && (\n           <div className=\"flex items-center space-x-2\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <div>\n             <div className=\"font-medium\">\n              {format(projectedDate, 'MMM dd')}\n             </div>\n             <div className=\"text-xs text-muted-foreground\">projected</div>\n            </div>\n           </div>\n          )}\n         </div>\n         \n         {status.type === 'warning' && (\n          <div className=\"p-3 bg-yellow-50 dark:bg-yellow-950/20 rounded-lg border border-yellow-200 dark:border-yellow-800\">\n           <div className=\"flex items-start space-x-2\">\n            <AlertTriangle className=\"h-4 w-4 text-yellow-600 mt-0.5\" />\n            <div>\n             <div className=\"text-sm font-medium text-yellow-800 dark:text-yellow-200\">\n              Goal at risk\n             </div>\n             <div className=\"text-xs text-yellow-700 dark:text-yellow-300\">\n              Current pace may not meet target date. Consider increasing contributions.\n             </div>\n            </div>\n           </div>\n          </div>\n         )}\n        </div>\n       </CardContent>\n      </Card>\n     );\n    })}\n   </div>\n  </div>\n );\n}","path":null,"size_bytes":11613,"size_tokens":null},"client/src/components/social/share-button.tsx":{"content":"import { useState } from\"react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent } from\"@/components/ui/card\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { \n DropdownMenu, \n DropdownMenuContent, \n DropdownMenuItem, \n DropdownMenuTrigger,\n DropdownMenuSeparator \n} from\"@/components/ui/dropdown-menu\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { \n Share2, \n Twitter, \n Facebook, \n Linkedin, \n MessageCircle, \n Send, \n Mail, \n Copy,\n Sparkles\n} from\"lucide-react\";\nimport { \n ShareData, \n shareToSocialMedia, \n shareContent, \n isNativeShareAvailable \n} from\"@/lib/social-sharing\";\n\ninterface ShareButtonProps {\n shareData: ShareData;\n variant?:\"default\" |\"outline\" |\"ghost\" |\"secondary\";\n size?:\"default\" |\"sm\" |\"lg\";\n showText?: boolean;\n achievement?: boolean;\n className?: string;\n}\n\nexport default function ShareButton({ \n shareData, \n variant =\"outline\", \n size =\"default\", \n showText = true,\n achievement = false,\n className =\"\"\n}: ShareButtonProps) {\n const [isLoading, setIsLoading] = useState(false);\n const { toast } = useToast();\n\n const handleShare = async (platform: string) => {\n setIsLoading(true);\n \n try {\n const result = await shareToSocialMedia(platform, shareData);\n \n if (result.success) {\n toast({\n title:\"Shared successfully!\",\n description: result.message,\n });\n } else {\n toast({\n title:\"Share failed\",\n description: result.message,\n variant:\"destructive\"\n });\n }\n } catch (error) {\n toast({\n title:\"Share failed\",\n description:\"Something went wrong. Please try again.\",\n variant:\"destructive\"\n });\n } finally {\n setIsLoading(false);\n }\n };\n\n const handleNativeShare = async () => {\n setIsLoading(true);\n \n try {\n const result = await shareContent(shareData);\n toast({\n title:\"Shared successfully\",\n description: result.message,\n });\n } catch (error) {\n toast({\n title:\"Share failed\",\n description:\"Something went wrong. Please try again.\",\n variant:\"destructive\"\n });\n } finally {\n setIsLoading(false);\n }\n };\n\n // If native sharing is available on mobile, show simple share button\n if (isNativeShareAvailable()) {\n return (\n <Button\n onClick={handleNativeShare}\n variant={variant}\n size={size}\n disabled={isLoading}\n className={`${achievement ? 'bg-primary text-primary-foreground border-0' : ''} ${className}`}\n data-testid=\"button-native-share\"\n >\n {achievement && <Sparkles className=\"w-4 h-4 mr-2\" />}\n <Share2 className=\"w-4 h-4 mr-2\" />\n {showText && (achievement ? 'Share Achievement' : 'Share')}\n </Button>\n );\n }\n\n // Desktop/web sharing with platform options\n return (\n <DropdownMenu>\n <DropdownMenuTrigger asChild>\n <Button\n variant={variant}\n size={size}\n disabled={isLoading}\n className={`${achievement ? 'bg-primary text-primary-foreground border-0' : ''} ${className}`}\n data-testid=\"button-share-dropdown\"\n >\n {achievement && <Sparkles className=\"w-4 h-4 mr-2\" />}\n <Share2 className=\"w-4 h-4 mr-2\" />\n {showText && (achievement ? 'Share Achievement' : 'Share')}\n </Button>\n </DropdownMenuTrigger>\n \n <DropdownMenuContent align=\"end\" className=\"w-48\">\n <div className=\"p-2\">\n <div className=\"text-xs font-medium text-muted-foreground mb-2\">\n Share to social media\n </div>\n \n <DropdownMenuItem \n onClick={() => handleShare('twitter')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-twitter\"\n >\n <Twitter className=\"w-4 h-4 text-blue-500\" />\n Twitter\n </DropdownMenuItem>\n \n <DropdownMenuItem \n onClick={() => handleShare('facebook')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-facebook\"\n >\n <Facebook className=\"w-4 h-4 text-blue-600\" />\n Facebook\n </DropdownMenuItem>\n \n <DropdownMenuItem \n onClick={() => handleShare('linkedin')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-linkedin\"\n >\n <Linkedin className=\"w-4 h-4 text-blue-700\" />\n LinkedIn\n </DropdownMenuItem>\n \n <DropdownMenuSeparator />\n \n <div className=\"text-xs font-medium text-muted-foreground mb-2 mt-2\">\n Share via messaging\n </div>\n \n <DropdownMenuItem \n onClick={() => handleShare('whatsapp')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-whatsapp\"\n >\n <MessageCircle className=\"w-4 h-4 text-green-500\" />\n WhatsApp\n </DropdownMenuItem>\n \n <DropdownMenuItem \n onClick={() => handleShare('telegram')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-telegram\"\n >\n <Send className=\"w-4 h-4 text-blue-400\" />\n Telegram\n </DropdownMenuItem>\n \n <DropdownMenuItem \n onClick={() => handleShare('email')}\n className=\"flex items-center gap-2 cursor-pointer\"\n data-testid=\"share-email\"\n >\n <Mail className=\"w-4 h-4 text-gray-600\" />\n Email\n </DropdownMenuItem>\n \n <DropdownMenuSeparator />\n \n <DropdownMenuItem \n onClick={() => handleShare('copy')}\n className=\"flex items-center gap-2 cursor-pointer font-medium\"\n data-testid=\"share-copy\"\n >\n <Copy className=\"w-4 h-4\" />\n Copy Link\n </DropdownMenuItem>\n </div>\n </DropdownMenuContent>\n </DropdownMenu>\n );\n}\n\n// Achievement Share Card Component\ninterface AchievementShareCardProps {\n achievement: {\n title: string;\n description: string;\n icon: React.ComponentType<any>;\n category: 'bronze' | 'silver' | 'gold' | 'platinum';\n points: number;\n };\n shareData: ShareData;\n}\n\nexport function AchievementShareCard({ achievement, shareData }: AchievementShareCardProps) {\n const Icon = achievement.icon;\n \n const categoryColors = {\n bronze: 'bg-orange-500',\n silver: 'bg-gray-400', \n gold: 'bg-yellow-500',\n platinum: 'bg-blue-500'\n };\n\n const categoryLabels = {\n bronze: 'Bronze',\n silver: 'Silver',\n gold: 'Gold', \n platinum: 'Platinum'\n };\n\n return (\n <Card className=\"relative overflow-hidden border-2 border-primary/20 bg-white dark:bg-gray-900\">\n {/* Background decoration */}\n <div className=\"absolute inset-0 bg-muted/30\" />\n <div className=\"absolute top-0 right-0 w-32 h-32 bg-white dark:bg-gray-900 rounded-full -translate-y-16 translate-x-16\" />\n \n <CardContent className=\"relative p-6 space-y-4\">\n {/* Achievement Header */}\n <div className=\"flex items-center justify-between\">\n <div className=\"flex items-center gap-3\">\n <div className={`w-12 h-12 rounded-xl bg-primary flex items-center justify-center shadow-lg`}>\n <Icon className=\"w-6 h-6 text-white\" />\n </div>\n <div>\n <div className=\"flex items-center gap-2\">\n <h3 className=\"font-bold text-lg\">{achievement.title}</h3>\n <Badge className=\"text-xs\">\n {categoryLabels[achievement.category]} \n </Badge>\n </div>\n <p className=\"text-sm text-muted-foreground\">\n +{achievement.points} points earned\n </p>\n </div>\n </div>\n </div>\n\n {/* Achievement Description */}\n <p className=\"text-muted-foreground leading-relaxed\">\n {achievement.description}\n </p>\n\n {/* Share Section */}\n <div className=\"flex items-center justify-between pt-2 border-t border-border/50\">\n <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n <Sparkles className=\"w-4 h-4\" />\n <span>Share your achievement</span>\n </div>\n \n <ShareButton \n shareData={shareData}\n achievement={true}\n showText={false}\n data-testid=\"achievement-share-button\"\n />\n </div>\n </CardContent>\n </Card>\n );\n}","path":null,"size_bytes":7053,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from\"react\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst alertVariants = cva(\n\"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n {\n  variants: {\n   variant: {\n    default:\"bg-background text-foreground\",\n    destructive:\n    \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n  },\n }\n)\n\nconst Alert = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n <div\n  ref={ref}\n  role=\"alert\"\n  className={cn(alertVariants({ variant }), className)}\n  {...props}\n />\n))\nAlert.displayName =\"Alert\"\n\nconst AlertTitle = React.forwardRef<\n HTMLParagraphElement,\n React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n <h5\n  ref={ref}\n  className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n  {...props}\n />\n))\nAlertTitle.displayName =\"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n HTMLParagraphElement,\n React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n  {...props}\n />\n))\nAlertDescription.displayName =\"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1509,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from\"react\"\nimport { type DialogProps } from\"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from\"cmdk\"\nimport { Search } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\nimport { Dialog, DialogContent } from\"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n <CommandPrimitive\n  ref={ref}\n  className={cn(\n  \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n   className\n  )}\n  {...props}\n />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n return (\n  <Dialog {...props}>\n   <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n    <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n     {children}\n    </Command>\n   </DialogContent>\n  </Dialog>\n )\n}\n\nconst CommandInput = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.Input>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n  <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n  <CommandPrimitive.Input\n   ref={ref}\n   className={cn(\n   \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n    className\n   )}\n   {...props}\n  />\n </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.List>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n <CommandPrimitive.List\n  ref={ref}\n  className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n  {...props}\n />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.Empty>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n <CommandPrimitive.Empty\n  ref={ref}\n  className=\"py-6 text-center text-sm\"\n  {...props}\n />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.Group>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n <CommandPrimitive.Group\n  ref={ref}\n  className={cn(\n  \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n   className\n  )}\n  {...props}\n />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.Separator>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n <CommandPrimitive.Separator\n  ref={ref}\n  className={cn(\"-mx-1 h-px bg-border\", className)}\n  {...props}\n />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n React.ElementRef<typeof CommandPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n <CommandPrimitive.Item\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n   className\n  )}\n  {...props}\n />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n return (\n  <span\n   className={cn(\n   \"ml-auto text-xs tracking-widest text-muted-foreground\",\n    className\n   )}\n   {...props}\n  />\n )\n}\nCommandShortcut.displayName =\"CommandShortcut\"\n\nexport {\n Command,\n CommandDialog,\n CommandInput,\n CommandList,\n CommandEmpty,\n CommandGroup,\n CommandItem,\n CommandShortcut,\n CommandSeparator,\n}\n","path":null,"size_bytes":4700,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from\"react\"\nimport * as ToastPrimitives from\"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\nimport { X, CheckCircle2, AlertCircle, Info, AlertTriangle } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Viewport>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n <ToastPrimitives.Viewport\n  ref={ref}\n  className={cn(\n  \"fixed top-4 right-4 z-[100] flex max-h-screen w-full flex-col gap-2 p-4 sm:max-w-[380px]\",\n   className\n  )}\n  style={{ paddingTop: 'max(1rem, env(safe-area-inset-top))' }}\n  {...props}\n />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n\"group pointer-events-auto relative flex w-full items-start gap-3 overflow-hidden rounded-xl border p-4 pr-10 shadow-lg backdrop-blur-sm transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full\",\n {\n  variants: {\n   variant: {\n    default:\"border-border/50 bg-background/95 text-foreground shadow-md\",\n    success:\"border-emerald-200 dark:border-emerald-800/50 bg-emerald-50/95 dark:bg-emerald-950/90 text-emerald-900 dark:text-emerald-100\",\n    warning:\"border-amber-200 dark:border-amber-800/50 bg-amber-50/95 dark:bg-amber-950/90 text-amber-900 dark:text-amber-100\",\n    info:\"border-blue-200 dark:border-blue-800/50 bg-blue-50/95 dark:bg-blue-950/90 text-blue-900 dark:text-blue-100\",\n    destructive:\"border-red-200 dark:border-red-800/50 bg-red-50/95 dark:bg-red-950/90 text-red-900 dark:text-red-100\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n  },\n }\n)\n\nconst variantIcons = {\n default: null,\n success: CheckCircle2,\n warning: AlertTriangle,\n info: Info,\n destructive: AlertCircle,\n}\n\nconst variantIconColors = {\n default:\"text-foreground\",\n success:\"text-emerald-600 dark:text-emerald-400\",\n warning:\"text-amber-600 dark:text-amber-400\",\n info:\"text-blue-600 dark:text-blue-400\",\n destructive:\"text-red-600 dark:text-red-400\",\n}\n\nconst Toast = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Root>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n  VariantProps<typeof toastVariants> & { showIcon?: boolean }\n>(({ className, variant, showIcon = true, children, ...props }, ref) => {\n const IconComponent = variant ? variantIcons[variant] : null\n const iconColor = variant ? variantIconColors[variant] : variantIconColors.default\n \n return (\n  <ToastPrimitives.Root\n   ref={ref}\n   className={cn(toastVariants({ variant }), className)}\n   role=\"status\"\n   aria-live=\"polite\"\n   aria-atomic=\"true\"\n   {...props}\n  >\n   {showIcon && IconComponent && (\n    <div className=\"flex-shrink-0 mt-0.5\">\n     <IconComponent className={cn(\"h-5 w-5\", iconColor)} />\n    </div>\n   )}\n   {children}\n  </ToastPrimitives.Root>\n )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Action>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n <ToastPrimitives.Action\n  ref={ref}\n  className={cn(\n  \"inline-flex h-8 shrink-0 items-center justify-center rounded-lg border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\",\n   className\n  )}\n  {...props}\n />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Close>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n <ToastPrimitives.Close\n  ref={ref}\n  className={cn(\n  \"absolute right-2 top-2 rounded-lg p-1.5 opacity-60 transition-all hover:opacity-100 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring hover:bg-black/5 dark:hover:bg-white/10\",\n   className\n  )}\n  toast-close=\"\"\n  aria-label=\"Close notification\"\n  {...props}\n >\n  <X className=\"h-4 w-4\" aria-hidden=\"true\" />\n </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Title>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n <ToastPrimitives.Title\n  ref={ref}\n  className={cn(\"text-sm font-semibold leading-tight\", className)}\n  {...props}\n />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n React.ElementRef<typeof ToastPrimitives.Description>,\n React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n <ToastPrimitives.Description\n  ref={ref}\n  className={cn(\"text-sm opacity-80 leading-snug\", className)}\n  {...props}\n />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n type ToastProps,\n type ToastActionElement,\n ToastProvider,\n ToastViewport,\n Toast,\n ToastTitle,\n ToastDescription,\n ToastClose,\n ToastAction,\n}\n","path":null,"size_bytes":5673,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from\"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":328,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from\"react\"\nimport * as ContextMenuPrimitive from\"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n  inset?: boolean\n }\n>(({ className, inset, children, ...props }, ref) => (\n <ContextMenuPrimitive.SubTrigger\n  ref={ref}\n  className={cn(\n  \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n >\n  {children}\n  <ChevronRight className=\"ml-auto h-4 w-4\" />\n </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n <ContextMenuPrimitive.SubContent\n  ref={ref}\n  className={cn(\n  \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n   className\n  )}\n  {...props}\n />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n <ContextMenuPrimitive.Portal>\n  <ContextMenuPrimitive.Content\n   ref={ref}\n   className={cn(\n   \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n    className\n   )}\n   {...props}\n  />\n </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <ContextMenuPrimitive.Item\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n <ContextMenuPrimitive.CheckboxItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  checked={checked}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <ContextMenuPrimitive.ItemIndicator>\n    <Check className=\"h-4 w-4\" />\n   </ContextMenuPrimitive.ItemIndicator>\n  </span>\n  {children}\n </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n <ContextMenuPrimitive.RadioItem\n  ref={ref}\n  className={cn(\n  \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n   className\n  )}\n  {...props}\n >\n  <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n   <ContextMenuPrimitive.ItemIndicator>\n    <Circle className=\"h-2 w-2 fill-current\" />\n   </ContextMenuPrimitive.ItemIndicator>\n  </span>\n  {children}\n </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.Label>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n  inset?: boolean\n }\n>(({ className, inset, ...props }, ref) => (\n <ContextMenuPrimitive.Label\n  ref={ref}\n  className={cn(\n  \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n   inset &&\"pl-8\",\n   className\n  )}\n  {...props}\n />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n <ContextMenuPrimitive.Separator\n  ref={ref}\n  className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n  {...props}\n />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n return (\n  <span\n   className={cn(\n   \"ml-auto text-xs tracking-widest text-muted-foreground\",\n    className\n   )}\n   {...props}\n  />\n )\n}\nContextMenuShortcut.displayName =\"ContextMenuShortcut\"\n\nexport {\n ContextMenu,\n ContextMenuTrigger,\n ContextMenuContent,\n ContextMenuItem,\n ContextMenuCheckboxItem,\n ContextMenuRadioItem,\n ContextMenuLabel,\n ContextMenuSeparator,\n ContextMenuShortcut,\n ContextMenuGroup,\n ContextMenuPortal,\n ContextMenuSub,\n ContextMenuSubContent,\n ContextMenuSubTrigger,\n ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7147,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as DialogPrimitive from\"@radix-ui/react-dialog\"\nimport { X } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n React.ElementRef<typeof DialogPrimitive.Overlay>,\n React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n <DialogPrimitive.Overlay\n  ref={ref}\n  className={cn(\n  \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n   className\n  )}\n  {...props}\n />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n React.ElementRef<typeof DialogPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n <DialogPortal>\n  <DialogOverlay />\n  <DialogPrimitive.Content\n   ref={ref}\n   className={cn(\n   \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n    className\n   )}\n   {...props}\n  >\n   {children}\n   <DialogPrimitive.Close className=\"absolute right-2 top-2 rounded-md opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground p-2 min-w-[44px] min-h-[44px] flex items-center justify-center\">\n    <X className=\"h-5 w-5\" />\n    <span className=\"sr-only\">Close</span>\n   </DialogPrimitive.Close>\n  </DialogPrimitive.Content>\n </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col space-y-1.5 text-center sm:text-left\",\n   className\n  )}\n  {...props}\n />\n)\nDialogHeader.displayName =\"DialogHeader\"\n\nconst DialogFooter = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n   className\n  )}\n  {...props}\n />\n)\nDialogFooter.displayName =\"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n React.ElementRef<typeof DialogPrimitive.Title>,\n React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n <DialogPrimitive.Title\n  ref={ref}\n  className={cn(\n  \"text-lg font-semibold leading-none tracking-tight\",\n   className\n  )}\n  {...props}\n />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n React.ElementRef<typeof DialogPrimitive.Description>,\n React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n <DialogPrimitive.Description\n  ref={ref}\n  className={cn(\"text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n Dialog,\n DialogPortal,\n DialogOverlay,\n DialogClose,\n DialogTrigger,\n DialogContent,\n DialogHeader,\n DialogFooter,\n DialogTitle,\n DialogDescription,\n}\n","path":null,"size_bytes":3750,"size_tokens":null},"client/src/pages/invite.tsx":{"content":"import { useEffect, useState } from\"react\";\nimport { useRoute, useLocation } from\"wouter\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Users, Calendar, CheckCircle, XCircle } from\"lucide-react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { SkeletonPage } from\"@/components/ui/skeleton\";\n\nexport default function InvitePage() {\n const [, params] = useRoute(\"/invite/:token\");\n const [, setLocation] = useLocation();\n const { toast } = useToast();\n const token = params?.token;\n\n const { data: invite, isLoading, error } = useQuery({\n  queryKey: [\"/api/invites\", token],\n  queryFn: () => fetch(`/api/invites/${token}`).then(res => {\n   if (!res.ok) throw new Error(\"Invalid or expired invite\");\n   return res.json();\n  }),\n  enabled: !!token,\n });\n\n const acceptInviteMutation = useMutation({\n  mutationFn: () => apiRequest(\"POST\", `/api/invites/${token}/accept`, {}),\n  onSuccess: () => {\n   toast({\n    title:\"Invite accepted!\",\n    description: `You've successfully joined ${invite?.group?.name}`,\n   });\n   setLocation(\"/groups\");\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message ||\"Failed to accept invite\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const handleAccept = () => {\n  acceptInviteMutation.mutate();\n };\n\n const handleDecline = () => {\n  setLocation(\"/groups\");\n };\n\n if (isLoading) {\n  return <SkeletonPage />;\n }\n\n if (error || !invite) {\n  return (\n   <div className=\"flex items-center justify-center min-h-screen p-6\">\n    <Card className=\"max-w-md w-full\">\n     <CardHeader>\n      <div className=\"flex items-center justify-center w-16 h-16 rounded-full bg-destructive/10 mx-auto mb-4\">\n       <XCircle className=\"w-8 h-8 text-destructive\" />\n      </div>\n      <CardTitle className=\"text-center\">Invalid Invite</CardTitle>\n      <CardDescription className=\"text-center\">\n       This invite link is invalid or has expired.\n      </CardDescription>\n     </CardHeader>\n     <CardContent>\n      <Button \n       onClick={() => setLocation(\"/groups\")} \n       className=\"w-full\"\n       data-testid=\"button-back-to-groups\"\n      >\n       Back to Groups\n      </Button>\n     </CardContent>\n    </Card>\n   </div>\n  );\n }\n\n const isExpired = new Date(invite.expiresAt) < new Date();\n\n if (isExpired) {\n  return (\n   <div className=\"flex items-center justify-center min-h-screen p-6\">\n    <Card className=\"max-w-md w-full\">\n     <CardHeader>\n      <div className=\"flex items-center justify-center w-16 h-16 rounded-full bg-destructive/10 mx-auto mb-4\">\n       <Calendar className=\"w-8 h-8 text-destructive\" />\n      </div>\n      <CardTitle className=\"text-center\">Invite Expired</CardTitle>\n      <CardDescription className=\"text-center\">\n       This invite link has expired. Please request a new invite from the group owner.\n      </CardDescription>\n     </CardHeader>\n     <CardContent>\n      <Button \n       onClick={() => setLocation(\"/groups\")} \n       className=\"w-full\"\n       data-testid=\"button-back-to-groups\"\n      >\n       Back to Groups\n      </Button>\n     </CardContent>\n    </Card>\n   </div>\n  );\n }\n\n return (\n  <div className=\"flex items-center justify-center min-h-screen p-6 bg-white dark:bg-gray-900\">\n   <Card className=\"max-w-lg w-full shadow-2xl\">\n    <CardHeader>\n     <div className=\"flex items-center justify-center w-20 h-20 rounded-full bg-white dark:bg-gray-900 mx-auto mb-4\">\n      <Users className=\"w-10 h-10 text-white\" />\n     </div>\n     <CardTitle className=\"text-2xl text-center\">You're Invited!</CardTitle>\n     <CardDescription className=\"text-center text-base\">\n      You've been invited to join a group\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"space-y-6\">\n     <div className=\"p-6 bg-white dark:bg-gray-900 rounded-lg border border-emerald-200 dark:border-emerald-800\">\n      <h3 className=\"text-xl font-bold mb-2 text-foreground\">{invite.group.name}</h3>\n      {invite.group.description && (\n       <p className=\"text-muted-foreground mb-4\">{invite.group.description}</p>\n      )}\n      <div className=\"flex items-center gap-2\">\n       <Badge variant=\"secondary\" className=\"capitalize\">\n        {invite.role} Role\n       </Badge>\n       <Badge variant=\"outline\">\n        Expires {new Date(invite.expiresAt).toLocaleDateString()}\n       </Badge>\n      </div>\n     </div>\n\n     <div className=\"flex gap-3\">\n      <Button \n       onClick={handleDecline} \n       variant=\"outline\" \n       className=\"flex-1\"\n       disabled={acceptInviteMutation.isPending}\n       data-testid=\"button-decline-invite\"\n      >\n       Decline\n      </Button>\n      <Button \n       onClick={handleAccept} \n       className=\"flex-1 bg-white dark:bg-gray-900\"\n       disabled={acceptInviteMutation.isPending}\n       data-testid=\"button-accept-invite\"\n      >\n       {acceptInviteMutation.isPending ? (\n        <>\n         <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\n         Accepting...\n        </>\n       ) : (\n        <>\n         <CheckCircle className=\"w-4 h-4 mr-2\" />\n         Accept Invite\n        </>\n       )}\n      </Button>\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}\n","path":null,"size_bytes":5412,"size_tokens":null},"client/src/components/mobile-navigation.tsx":{"content":"import { useState, useEffect, memo, useMemo, useCallback } from\"react\";\nimport { Link, useLocation } from\"wouter\";\nimport { useTranslation } from 'react-i18next';\nimport { \n Home, \n Target, \n DollarSign,\n Plus,\n Brain,\n Crown,\n Wallet\n} from\"lucide-react\";\nimport { cn } from\"../lib/utils\";\nimport { Button } from\"./ui/button\";\nimport {\n Drawer,\n DrawerContent,\n DrawerDescription,\n DrawerTitle,\n} from\"./ui/drawer\";\nimport GoalForm from\"./forms/goal-form\";\nimport TransactionForm from\"./forms/transaction-form\";\n\nconst getNavigation = (t: (key: string) => string) => [\n { name: t('navigation.dashboard'), href:\"/\", icon: Home, label: t('navigation.labels.home') },\n { name: t('navigation.aiAssistant'), href:\"/ai-assistant\", icon: Brain, label: t('navigation.labels.ai') },\n { name:\"My Money\", href:\"/money-tracking\", icon: Wallet, label:\"Money\" },\n { name: t('navigation.goals'), href:\"/financial-goals\", icon: Target, label:\"Goals\" },\n { name: t('navigation.premium'), href:\"/subscription\", icon: Crown, label: t('navigation.labels.premium') },\n];\n\nfunction MobileNavigationComponent() {\n const [location] = useLocation();\n const { t } = useTranslation();\n \n // Memoize navigation to avoid recalculation on every render\n const navigation = useMemo(() => getNavigation(t), [t]);\n \n const [isQuickActionsOpen, setIsQuickActionsOpen] = useState(false);\n const [activeAction, setActiveAction] = useState<'goal' | 'transaction' | null>(null);\n \n // Only render on mobile viewports\n const [isMobile, setIsMobile] = useState(typeof window !== 'undefined' && window.innerWidth < 768);\n \n useEffect(() => {\n const checkMobile = () => setIsMobile(window.innerWidth < 768);\n checkMobile();\n window.addEventListener('resize', checkMobile);\n return () => window.removeEventListener('resize', checkMobile);\n }, []);\n\n // Memoize quick actions to avoid recreation on each render\n const quickActions = useMemo(() => [\n {\n id:\"add-goal\",\n title: t('quickActions.newGoal'),\n description: t('quickActions.newGoalDesc'),\n icon: Target,\n color:\"text-primary\",\n bgColor:\"bg-primary/10\",\n action: () => { setActiveAction('goal'); setIsQuickActionsOpen(false); }\n },\n {\n id:\"add-transaction\",\n title: t('quickActions.addTransaction'),\n description: t('quickActions.addTransactionDesc'),\n icon: DollarSign,\n color:\"text-success\",\n bgColor:\"bg-success/10\",\n action: () => { setActiveAction('transaction'); setIsQuickActionsOpen(false); }\n }\n ], [t]);\n\n // Don't render at all on desktop\n if (!isMobile) {\n return null;\n }\n\n return (\n <>\n {/* Floating Action Button - positioned well above bottom nav */}\n <div \n className=\"fixed left-4 z-50 md:hidden\"\n style={{ bottom: 'calc(72px + env(safe-area-inset-bottom, 0px))' }}\n >\n <Button\n size=\"lg\"\n onClick={() => setIsQuickActionsOpen(true)}\n className=\"w-12 h-12 min-w-[48px] min-h-[48px] rounded-full shadow-lg bg-primary text-primary-foreground border-0\"\n aria-label={t('quickActions.addNew')}\n data-testid=\"fab-add\"\n >\n <Plus size={22} />\n </Button>\n </div>\n\n {/* Quick Actions Drawer */}\n <Drawer open={isQuickActionsOpen} onOpenChange={setIsQuickActionsOpen}>\n <DrawerContent className=\"max-h-[85vh] overflow-y-auto\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2\">{t('quickActions.title')}</DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n {t('quickActions.description')}\n </DrawerDescription>\n <div className=\"grid grid-cols-3 gap-3\">\n {quickActions.map((action) => (\n <Button\n key={action.id}\n variant=\"ghost\"\n onClick={action.action}\n className=\"h-auto p-4 flex flex-col items-center gap-2 hover:bg-accent border\"\n data-testid={`button-${action.id}`}\n >\n <div className={`w-12 h-12 rounded-xl ${action.bgColor} ${action.color} flex items-center justify-center`}>\n <action.icon size={24} />\n </div>\n <p className=\"font-medium text-xs text-center leading-tight\">\n {action.title}\n </p>\n </Button>\n ))}\n </div>\n </div>\n </DrawerContent>\n </Drawer>\n\n {/* Goal Creation Drawer */}\n <Drawer open={activeAction === 'goal'} onOpenChange={(open) => !open && setActiveAction(null)}>\n <DrawerContent className=\"max-h-[85vh] overflow-y-auto\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <Target className=\"h-5 w-5 text-primary\" />\n Create New Goal\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n Set a savings target and track your progress\n </DrawerDescription>\n <GoalForm onSuccess={() => setActiveAction(null)} />\n </div>\n </DrawerContent>\n </Drawer>\n\n {/* Transaction Creation Drawer */}\n <Drawer open={activeAction === 'transaction'} onOpenChange={(open) => !open && setActiveAction(null)}>\n <DrawerContent className=\"max-h-[85vh] overflow-y-auto\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <DollarSign className=\"h-5 w-5 text-success\" />\n {t('moneyTracking.addNew')}\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n {t('moneyTracking.addNewDesc')}\n </DrawerDescription>\n <TransactionForm onSuccess={() => setActiveAction(null)} />\n </div>\n </DrawerContent>\n </Drawer>\n\n\n {/* Bottom Tab Bar - Compact Design */}\n <nav \n className=\"fixed bottom-0 left-0 right-0 bg-background/95 backdrop-blur-lg border-t border-border md:hidden z-40\"\n style={{ \n paddingBottom: 'env(safe-area-inset-bottom, 8px)'\n }}\n >\n <div className=\"flex items-center justify-around px-1 py-1.5\">\n {navigation.map((item) => {\n const isActive = location === item.href || \n (item.href !==\"/\" && location.startsWith(item.href));\n \n return (\n <Link \n key={item.name} \n href={item.href}\n aria-current={isActive ?\"page\" : undefined}\n aria-label={`${item.name} tab`}\n >\n <div\n className={cn(\n\"relative flex flex-col items-center justify-center min-w-[52px] min-h-[48px] rounded-xl ease-out group\",\n isActive\n ?\"text-primary\"\n :\"text-muted-foreground hover:text-foreground\"\n )}\n data-testid={`mobile-nav-${item.name.toLowerCase()}`}\n >\n {/* Active indicator */}\n {isActive && (\n <div className=\"absolute inset-0 bg-primary/10 rounded-xl\" />\n )}\n \n {/* Icon and label */}\n <div className=\"relative z-10 flex flex-col items-center gap-0.5\">\n <item.icon size={18} className=\"transition-all\" />\n <span \n className={cn(\n\"text-[10px] font-medium leading-none\",\n isActive \n ?\"text-primary font-semibold\" \n :\"text-muted-foreground\"\n )}\n >\n {item.label}\n </span>\n </div>\n </div>\n </Link>\n );\n })}\n </div>\n </nav>\n\n {/* Safe area padding for mobile bottom navigation */}\n <div className=\"h-20 md:hidden\" style={{ paddingBottom: 'env(safe-area-inset-bottom, 8px)' }} />\n </>\n );\n}\n\n// Memoize MobileNavigation to prevent unnecessary re-renders during page navigation\nconst MobileNavigation = memo(MobileNavigationComponent);\nexport default MobileNavigation;\n","path":null,"size_bytes":6779,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from\"react\"\nimport * as PopoverPrimitive from\"@radix-ui/react-popover\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n React.ElementRef<typeof PopoverPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align =\"center\", sideOffset = 4, ...props }, ref) => (\n <PopoverPrimitive.Portal>\n  <PopoverPrimitive.Content\n   ref={ref}\n   align={align}\n   sideOffset={sideOffset}\n   className={cn(\n   \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n    className\n   )}\n   {...props}\n  />\n </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1241,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as RechartsPrimitive from\"recharts\"\n\nimport { cn } from\"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light:\"\", dark:\".dark\" } as const\n\nexport type ChartConfig = {\n [k in string]: {\n  label?: React.ReactNode\n  icon?: React.ComponentType\n } & (\n  | { color?: string; theme?: never }\n  | { color?: never; theme: Record<keyof typeof THEMES, string> }\n )\n}\n\ntype ChartContextProps = {\n config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n const context = React.useContext(ChartContext)\n\n if (!context) {\n  throw new Error(\"useChart must be used within a <ChartContainer />\")\n }\n\n return context\n}\n\nconst ChartContainer = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> & {\n  config: ChartConfig\n  children: React.ComponentProps<\n   typeof RechartsPrimitive.ResponsiveContainer\n  >[\"children\"]\n }\n>(({ id, className, children, config, ...props }, ref) => {\n const uniqueId = React.useId()\n const chartId = `chart-${id || uniqueId.replace(/:/g,\"\")}`\n\n return (\n  <ChartContext.Provider value={{ config }}>\n   <div\n    data-chart={chartId}\n    ref={ref}\n    className={cn(\n    \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n     className\n    )}\n    {...props}\n   >\n    <ChartStyle id={chartId} config={config} />\n    <RechartsPrimitive.ResponsiveContainer>\n     {children}\n    </RechartsPrimitive.ResponsiveContainer>\n   </div>\n  </ChartContext.Provider>\n )\n})\nChartContainer.displayName =\"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n const colorConfig = Object.entries(config).filter(\n  ([, config]) => config.theme || config.color\n )\n\n if (!colorConfig.length) {\n  return null\n }\n\n return (\n  <style\n   dangerouslySetInnerHTML={{\n    __html: Object.entries(THEMES)\n     .map(\n      ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n .map(([key, itemConfig]) => {\n  const color =\n   itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n   itemConfig.color\n  return color ? ` --color-${key}: ${color};` : null\n })\n .join(\"\\n\")}\n}\n`\n     )\n     .join(\"\\n\"),\n   }}\n  />\n )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n  React.ComponentProps<\"div\"> & {\n   hideLabel?: boolean\n   hideIndicator?: boolean\n   indicator?:\"line\" |\"dot\" |\"dashed\"\n   nameKey?: string\n   labelKey?: string\n  }\n>(\n (\n  {\n   active,\n   payload,\n   className,\n   indicator =\"dot\",\n   hideLabel = false,\n   hideIndicator = false,\n   label,\n   labelFormatter,\n   labelClassName,\n   formatter,\n   color,\n   nameKey,\n   labelKey,\n  },\n  ref\n ) => {\n  const { config } = useChart()\n\n  const tooltipLabel = React.useMemo(() => {\n   if (hideLabel || !payload?.length) {\n    return null\n   }\n\n   const [item] = payload\n   const key = `${labelKey || item?.dataKey || item?.name ||\"value\"}`\n   const itemConfig = getPayloadConfigFromPayload(config, item, key)\n   const value =\n    !labelKey && typeof label ===\"string\"\n     ? config[label as keyof typeof config]?.label || label\n     : itemConfig?.label\n\n   if (labelFormatter) {\n    return (\n     <div className={cn(\"font-medium\", labelClassName)}>\n      {labelFormatter(value, payload)}\n     </div>\n    )\n   }\n\n   if (!value) {\n    return null\n   }\n\n   return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n  }, [\n   label,\n   labelFormatter,\n   payload,\n   hideLabel,\n   labelClassName,\n   config,\n   labelKey,\n  ])\n\n  if (!active || !payload?.length) {\n   return null\n  }\n\n  const nestLabel = payload.length === 1 && indicator !==\"dot\"\n\n  return (\n   <div\n    ref={ref}\n    className={cn(\n    \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n     className\n    )}\n   >\n    {!nestLabel ? tooltipLabel : null}\n    <div className=\"grid gap-1.5\">\n     {payload.map((item, index) => {\n      const key = `${nameKey || item.name || item.dataKey ||\"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const indicatorColor = color || item.payload.fill || item.color\n\n      return (\n       <div\n        key={item.dataKey}\n        className={cn(\n        \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n         indicator ===\"dot\" &&\"items-center\"\n        )}\n       >\n        {formatter && item?.value !== undefined && item.name ? (\n         formatter(item.value, item.name, item, index, item.payload)\n        ) : (\n         <>\n          {itemConfig?.icon ? (\n           <itemConfig.icon />\n          ) : (\n           !hideIndicator && (\n            <div\n             className={cn(\n             \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n              {\n              \"h-2.5 w-2.5\": indicator ===\"dot\",\n              \"w-1\": indicator ===\"line\",\n              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                indicator ===\"dashed\",\n              \"my-0.5\": nestLabel && indicator ===\"dashed\",\n              }\n             )}\n             style={\n              {\n              \"--color-bg\": indicatorColor,\n              \"--color-border\": indicatorColor,\n              } as React.CSSProperties\n             }\n            />\n           )\n          )}\n          <div\n           className={cn(\n           \"flex flex-1 justify-between leading-none\",\n            nestLabel ?\"items-end\" :\"items-center\"\n           )}\n          >\n           <div className=\"grid gap-1.5\">\n            {nestLabel ? tooltipLabel : null}\n            <span className=\"text-muted-foreground\">\n             {itemConfig?.label || item.name}\n            </span>\n           </div>\n           {item.value && (\n            <span className=\"font-mono font-medium tabular-nums text-foreground\">\n             {item.value.toLocaleString()}\n            </span>\n           )}\n          </div>\n         </>\n        )}\n       </div>\n      )\n     })}\n    </div>\n   </div>\n  )\n }\n)\nChartTooltipContent.displayName =\"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n HTMLDivElement,\n React.ComponentProps<\"div\"> &\n  Pick<RechartsPrimitive.LegendProps,\"payload\" |\"verticalAlign\"> & {\n   hideIcon?: boolean\n   nameKey?: string\n  }\n>(\n (\n  { className, hideIcon = false, payload, verticalAlign =\"bottom\", nameKey },\n  ref\n ) => {\n  const { config } = useChart()\n\n  if (!payload?.length) {\n   return null\n  }\n\n  return (\n   <div\n    ref={ref}\n    className={cn(\n    \"flex items-center justify-center gap-4\",\n     verticalAlign ===\"top\" ?\"pb-3\" :\"pt-3\",\n     className\n    )}\n   >\n    {payload.map((item) => {\n     const key = `${nameKey || item.dataKey ||\"value\"}`\n     const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n     return (\n      <div\n       key={item.value}\n       className={cn(\n       \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n       )}\n      >\n       {itemConfig?.icon && !hideIcon ? (\n        <itemConfig.icon />\n       ) : (\n        <div\n         className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n         style={{\n          backgroundColor: item.color,\n         }}\n        />\n       )}\n       {itemConfig?.label}\n      </div>\n     )\n    })}\n   </div>\n  )\n }\n)\nChartLegendContent.displayName =\"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n config: ChartConfig,\n payload: unknown,\n key: string\n) {\n if (typeof payload !==\"object\" || payload === null) {\n  return undefined\n }\n\n const payloadPayload =\n \"payload\" in payload &&\n  typeof payload.payload ===\"object\" &&\n  payload.payload !== null\n   ? payload.payload\n   : undefined\n\n let configLabelKey: string = key\n\n if (\n  key in payload &&\n  typeof payload[key as keyof typeof payload] ===\"string\"\n ) {\n  configLabelKey = payload[key as keyof typeof payload] as string\n } else if (\n  payloadPayload &&\n  key in payloadPayload &&\n  typeof payloadPayload[key as keyof typeof payloadPayload] ===\"string\"\n ) {\n  configLabelKey = payloadPayload[\n   key as keyof typeof payloadPayload\n  ] as string\n }\n\n return configLabelKey in config\n  ? config[configLabelKey]\n  : config[key as keyof typeof config]\n}\n\nexport {\n ChartContainer,\n ChartTooltip,\n ChartTooltipContent,\n ChartLegend,\n ChartLegendContent,\n ChartStyle,\n}\n","path":null,"size_bytes":9082,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport express from \"express\";\nimport { createServer, type Server } from \"http\";\nimport rateLimit from \"express-rate-limit\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { eq } from \"drizzle-orm\";\nimport { subscriptionPlans, InsertTransaction } from \"@shared/schema\";\nimport { setupAuth, isAuthenticated } from \"./customAuth\";\nimport { stripeLogger, aiLogger, createLogger } from \"./utils/logger\";\n\n// Development-only debug logging\nconst isDev = process.env.NODE_ENV === 'development';\nconst debugLog = (context: string, message: string, data?: any) => {\n  if (isDev) {\n    const logger = createLogger(context);\n    logger.debug(message, data ? { data } : undefined);\n  }\n};\n\n// Webhook event idempotency is now database-backed for persistence across restarts\n// Old events are cleaned up periodically (see cleanupOldWebhookEvents)\n\n// Rate limiters for different endpoint types\nconst aiChatLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 20, // 20 AI requests per minute per IP\n  message: { message: \"Too many AI requests, please try again in a minute\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst playbookLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 5, // 5 playbook operations per minute\n  message: { message: \"Too many playbook requests, please slow down\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst authLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 10, // 10 login attempts per 15 minutes\n  message: { message: \"Too many login attempts, please try again later\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\nconst transactionLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 60, // 60 transaction operations per minute\n  message: { message: \"Too many transaction requests, please slow down\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\n// Helper function to get user ID from request (custom auth)\nfunction getUserIdFromRequest(req: any): string {\n  return req.userId || req.user?.userId;\n}\nimport { \n  insertUserSchema,\n  insertGroupSchema,\n  insertGroupMemberSchema,\n  insertEventSchema,\n  insertFinancialGoalSchema,\n  insertTransactionSchema,\n  insertBudgetSchema,\n  insertGroupInviteSchema,\n  insertCalendarShareSchema,\n  insertFriendRequestSchema,\n  insertEventExpenseSchema,\n  insertEventExpenseShareSchema,\n  eventAttendeeSchema,\n  insertUserSettingsSchema,\n  insertUserPreferencesSchema,\n  insertFinancialPreferencesSchema,\n  insertPrivacySettingsSchema,\n  insertEventTimeLogSchema,\n  insertNotificationSchema,\n  insertChatConversationSchema,\n  insertChatMessageSchema,\n  insertMessageFeedbackSchema,\n  insertReferralCodeSchema,\n  insertReferralSchema,\n  insertBonusCreditSchema,\n  insertCryptoHoldingSchema,\n  insertCryptoPriceAlertSchema,\n  insertCryptoTransactionSchema,\n  insertSharedBudgetSchema,\n  insertSharedBudgetExpenseSchema,\n  sharedBudgetExpenses,\n  friendGroupInvitations,\n  insertUserFinancialProfileSchema,\n  insertUserExpenseCategorySchema,\n  insertUserDebtSchema,\n  insertUserAssetSchema,\n  type UserPreferences\n} from \"@shared/schema\";\nimport { z } from \"zod\";\n\n// Reusable typed schemas for user preference updates\nconst updateUserPreferencesSchema = insertUserPreferencesSchema.omit({ userId: true }).partial();\ntype UpdateUserPreferencesInput = z.infer<typeof updateUserPreferencesSchema>;\nimport { aiService, type UserContext } from \"./aiService\";\nimport { extractAndUpdateMemory, getMemoryContext, summarizeConversationHistory } from './conversationMemoryService';\nimport { cryptoService } from \"./cryptoService\";\nimport { taxService } from \"./taxService\";\nimport { autoCategorizeTransaction, getCategorySuggestions, getAvailableCategories } from \"./categorizationService\";\nimport { spendingPatternService } from \"./spendingPatternService\";\nimport { calculateFinancialHealth } from './financialHealthService';\nimport { checkGoalProgress, getGoalMilestones } from './goalMilestoneService';\nimport { generateProactiveInsights, generateWeeklySummary } from './proactiveInsightsService';\nimport { predictiveAnalyticsService } from './predictiveAnalyticsService';\nimport { generateHybridAdvice, type HybridAIResponse } from './ai/hybridAIService';\nimport { routeWithTierCheck, type QuotaExceededError } from './ai/tierAwareRouter';\nimport Stripe from \"stripe\";\nimport { log } from \"./vite\";\n\n// Achievement helper functions\nconst achievementDefinitions: Record<string, { title: string; description: string; icon: string; target: number }> = {\n  'streak_7': { title: 'Week Warrior', description: '7 day check-in streak', icon: 'flame', target: 7 },\n  'streak_30': { title: 'Monthly Master', description: '30 day check-in streak', icon: 'flame', target: 30 },\n  'goals_1': { title: 'Goal Setter', description: 'Create your first goal', icon: 'target', target: 1 },\n  'goals_5': { title: 'Goal Crusher', description: 'Complete 5 goals', icon: 'trophy', target: 5 },\n  'savings_1000': { title: 'First Grand', description: 'Save $1,000 total', icon: 'star', target: 1000 },\n  'savings_10000': { title: 'Five Figures', description: 'Save $10,000 total', icon: 'zap', target: 10000 },\n  'ai_10': { title: 'AI Explorer', description: 'Ask 10 AI questions', icon: 'trending', target: 10 },\n  'ai_50': { title: 'AI Power User', description: 'Ask 50 AI questions', icon: 'award', target: 50 },\n};\n\nfunction getAchievementTitle(id: string): string {\n  return achievementDefinitions[id]?.title ?? 'Unknown Achievement';\n}\n\nfunction getAchievementDescription(id: string): string {\n  return achievementDefinitions[id]?.description ?? '';\n}\n\nfunction getAchievementIcon(id: string): string {\n  return achievementDefinitions[id]?.icon ?? 'trophy';\n}\n\n// Utility function to safely parse amount strings (handles \"$300\", \"300\", \"300.50\", null, undefined)\n// Returns \"0.00\" for invalid/missing values instead of throwing\nfunction parseAmount(value: string | number | null | undefined): string {\n  // Handle null/undefined gracefully\n  if (value === null || value === undefined) {\n    return \"0.00\";\n  }\n  \n  if (typeof value === 'number') {\n    return isNaN(value) ? \"0.00\" : value.toFixed(2);\n  }\n  \n  // Remove dollar signs, commas, and whitespace\n  const cleaned = String(value).replace(/[\\$,\\s]/g, '');\n  \n  // Parse to number and back to fixed decimal string\n  const num = parseFloat(cleaned);\n  \n  // Return 0 for NaN instead of throwing\n  if (isNaN(num)) {\n    return \"0.00\";\n  }\n  \n  return num.toFixed(2);\n}\n\n// Initialize Stripe (will use environment variable when available)\nlet stripe: Stripe | null = null;\n\ntry {\n  if (process.env.STRIPE_SECRET_KEY) {\n    stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n      apiVersion: \"2024-12-18.acacia\" as any,\n    });\n    log('Stripe initialized successfully');\n  } else {\n    log(\"Stripe not initialized - API key not provided\");\n  }\n} catch (error: any) {\n  log(\"Stripe initialization failed:\", error.message);\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Note: Auth setup (setupAuth) is done in server/index.ts before this function is called\n  // Note: Raw body middleware for Stripe webhooks is set up in server/index.ts\n  // Note: /api/auth/user is defined in customAuth.ts - don't redefine it here\n  \n  // ==================== HEALTH CHECK ENDPOINT ====================\n  // Production-grade health check for monitoring and load balancers\n  app.get(\"/api/health\", async (req, res) => {\n    const startTime = Date.now();\n    const checks: Record<string, { status: 'healthy' | 'degraded' | 'unhealthy'; latency?: number; message?: string }> = {};\n    let overallStatus: 'healthy' | 'degraded' | 'unhealthy' = 'healthy';\n\n    // 1. Database health check (using Drizzle's select with a lightweight query)\n    try {\n      const dbStart = Date.now();\n      // Query subscription_plans table (always exists) to verify DB connectivity\n      await db.select({ id: subscriptionPlans.id }).from(subscriptionPlans).limit(1);\n      checks.database = { status: 'healthy', latency: Date.now() - dbStart };\n    } catch (error: any) {\n      checks.database = { status: 'unhealthy', message: 'Database connection failed' };\n      overallStatus = 'unhealthy';\n    }\n\n    // 2. AI Service health check (check if API keys are configured)\n    const hasGroqKey = !!process.env.GROQ_API_KEY;\n    const hasAnthropicIntegration = !!process.env.AI_INTEGRATIONS_ANTHROPIC_API_KEY;\n    const hasOpenAIIntegration = !!process.env.AI_INTEGRATIONS_OPENAI_API_KEY;\n    \n    if (hasGroqKey || hasAnthropicIntegration || hasOpenAIIntegration) {\n      checks.ai = { \n        status: 'healthy', \n        message: `Providers: ${[\n          hasGroqKey ? 'Groq' : null,\n          hasAnthropicIntegration ? 'Anthropic' : null,\n          hasOpenAIIntegration ? 'OpenAI' : null\n        ].filter(Boolean).join(', ')}`\n      };\n    } else {\n      checks.ai = { status: 'degraded', message: 'No AI providers configured' };\n      if (overallStatus === 'healthy') overallStatus = 'degraded';\n    }\n\n    // 3. Stripe health check\n    if (stripe) {\n      checks.stripe = { status: 'healthy' };\n    } else {\n      checks.stripe = { status: 'degraded', message: 'Stripe not configured' };\n      if (overallStatus === 'healthy') overallStatus = 'degraded';\n    }\n\n    // 4. Memory usage check\n    const memUsage = process.memoryUsage();\n    const heapUsedMB = Math.round(memUsage.heapUsed / 1024 / 1024);\n    const heapTotalMB = Math.round(memUsage.heapTotal / 1024 / 1024);\n    const heapUsagePercent = (memUsage.heapUsed / memUsage.heapTotal) * 100;\n    \n    if (heapUsagePercent < 80) {\n      checks.memory = { status: 'healthy', message: `${heapUsedMB}MB / ${heapTotalMB}MB (${heapUsagePercent.toFixed(1)}%)` };\n    } else if (heapUsagePercent < 95) {\n      checks.memory = { status: 'degraded', message: `High memory usage: ${heapUsagePercent.toFixed(1)}%` };\n      if (overallStatus === 'healthy') overallStatus = 'degraded';\n    } else {\n      checks.memory = { status: 'unhealthy', message: `Critical memory usage: ${heapUsagePercent.toFixed(1)}%` };\n      overallStatus = 'unhealthy';\n    }\n\n    const responseTime = Date.now() - startTime;\n    const statusCode = overallStatus === 'unhealthy' ? 503 : overallStatus === 'degraded' ? 200 : 200;\n\n    res.status(statusCode).json({\n      status: overallStatus,\n      timestamp: new Date().toISOString(),\n      version: process.env.npm_package_version || '1.0.0',\n      uptime: Math.round(process.uptime()),\n      responseTime,\n      checks\n    });\n  });\n\n  // User routes - Requires authentication\n  app.get(\"/api/users/me\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        console.error('[/api/users/me] User not found for ID:', userId);\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error: any) {\n      console.error('[/api/users/me] Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/users/search\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const query = req.query.q as string;\n      \n      if (!query || query.trim().length < 2) {\n        return res.status(400).json({ message: \"Search query must be at least 2 characters\" });\n      }\n      \n      const users = await storage.searchUsers(query, userId);\n      res.json(users);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/users/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const requestingUserId = getUserIdFromRequest(req);\n      const targetUserId = req.params.id;\n      \n      // Only allow users to view their own profile or limited public info\n      const user = await storage.getUser(targetUserId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Return full profile for own user, limited for others\n      if (requestingUserId === targetUserId) {\n        res.json(user);\n      } else {\n        // Return only public fields for other users\n        res.json({\n          id: user.id,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          profileImageUrl: user.profileImageUrl\n        });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Dashboard routes - Requires authentication\n  app.get(\"/api/dashboard/stats\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const stats = await storage.getUserStats(userId);\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Financial Profile routes - Composite endpoint for AI consumption\n  app.get(\"/api/user/financial-profile\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Fetch all financial profile data\n      const [profile, expenseCategories, debts, assets] = await Promise.all([\n        storage.getUserFinancialProfile(userId),\n        storage.getUserExpenseCategories(userId),\n        storage.getUserDebts(userId),\n        storage.getUserAssets(userId)\n      ]);\n      \n      res.json({\n        profile: profile || null,\n        expenseCategories,\n        debts,\n        assets\n      });\n    } catch (error: any) {\n      console.error('[/api/user/financial-profile GET] Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/user/financial-profile\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { profile, expenseCategories, debts, assets } = req.body;\n      \n      // Validate and create/update profile if provided\n      let savedProfile = null;\n      if (profile) {\n        const validatedProfile = insertUserFinancialProfileSchema.parse({ ...profile, userId });\n        const existingProfile = await storage.getUserFinancialProfile(userId);\n        \n        if (existingProfile) {\n          savedProfile = await storage.updateUserFinancialProfile(userId, validatedProfile);\n        } else {\n          savedProfile = await storage.createUserFinancialProfile(validatedProfile);\n        }\n      }\n      \n      // Update expense categories if provided\n      let savedCategories: any[] = [];\n      if (expenseCategories && Array.isArray(expenseCategories)) {\n        const validatedCategories = expenseCategories.map(cat => \n          insertUserExpenseCategorySchema.parse({ ...cat, userId })\n        );\n        savedCategories = await storage.updateUserExpenseCategories(userId, validatedCategories);\n      }\n      \n      // Update debts if provided (sequential to ensure data integrity)\n      if (debts && Array.isArray(debts)) {\n        const existingDebts = await storage.getUserDebts(userId);\n        for (const debt of existingDebts) {\n          await storage.deleteUserDebt(debt.id);\n        }\n        for (const debt of debts) {\n          const validatedDebt = insertUserDebtSchema.parse({ ...debt, userId });\n          await storage.createUserDebt(validatedDebt);\n        }\n      }\n      \n      // Update assets if provided (sequential to ensure data integrity)\n      if (assets && Array.isArray(assets)) {\n        const existingAssets = await storage.getUserAssets(userId);\n        for (const asset of existingAssets) {\n          await storage.deleteUserAsset(asset.id);\n        }\n        for (const asset of assets) {\n          const validatedAsset = insertUserAssetSchema.parse({ ...asset, userId });\n          await storage.createUserAsset(validatedAsset);\n        }\n      }\n      \n      // Return updated composite profile\n      const [updatedProfile, updatedCategories, updatedDebts, updatedAssets] = await Promise.all([\n        savedProfile ? Promise.resolve(savedProfile) : storage.getUserFinancialProfile(userId),\n        storage.getUserExpenseCategories(userId),\n        storage.getUserDebts(userId),\n        storage.getUserAssets(userId)\n      ]);\n      \n      res.json({\n        profile: updatedProfile || null,\n        expenseCategories: updatedCategories,\n        debts: updatedDebts,\n        assets: updatedAssets\n      });\n    } catch (error: any) {\n      console.error('[/api/user/financial-profile POST] Error:', error);\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Group routes\n  app.get(\"/api/groups\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const groups = await storage.getGroupsByUserId(userId);\n      res.json(groups);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/groups\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertGroupSchema.parse({ ...req.body, ownerId: userId });\n      const group = await storage.createGroup(validatedData);\n      res.status(201).json(group);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/groups/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const group = await storage.getGroup(req.params.id);\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      // Check if user is a member of this group\n      const members = await storage.getGroupMembers(req.params.id);\n      const isMember = members.some((m: any) => m.userId === userId);\n      if (!isMember) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      res.json(group);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/groups/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const group = await storage.getGroup(req.params.id);\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      // Check if user is owner or admin\n      const members = await storage.getGroupMembers(req.params.id);\n      const userMember = members.find((m: any) => m.userId === userId);\n      if (!userMember || (userMember.role !== 'owner' && userMember.role !== 'admin')) {\n        return res.status(403).json({ message: \"Only group owners and admins can update the group\" });\n      }\n      \n      const updateData = insertGroupSchema.partial().parse(req.body);\n      const updatedGroup = await storage.updateGroup(req.params.id, updateData);\n      res.json(updatedGroup);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/groups/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const group = await storage.getGroup(req.params.id);\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      // Only owner can delete the group\n      if (group.ownerId !== userId) {\n        return res.status(403).json({ message: \"Only the group owner can delete the group\" });\n      }\n      \n      await storage.deleteGroup(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Group member routes\n  app.get(\"/api/groups/:id/members\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const members = await storage.getGroupMembers(req.params.id);\n      \n      // Check if user is a member of this group\n      const isMember = members.some((m: any) => m.userId === userId);\n      if (!isMember) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      res.json(members);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/groups/:id/members-with-users\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const members = await storage.getGroupMembers(req.params.id);\n      \n      // Check if user is a member of this group\n      const isMember = members.some((m: any) => m.userId === userId);\n      if (!isMember) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const membersWithUsers = await storage.getGroupMembersWithUserInfo(req.params.id);\n      res.json(membersWithUsers);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/groups/:id/members\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const members = await storage.getGroupMembers(req.params.id);\n      \n      // Check if user is owner or admin\n      const userMember = members.find((m: any) => m.userId === userId);\n      if (!userMember || (userMember.role !== 'owner' && userMember.role !== 'admin')) {\n        return res.status(403).json({ message: \"Only group owners and admins can add members\" });\n      }\n      \n      const memberData = { ...req.body, groupId: req.params.id };\n      const validatedData = insertGroupMemberSchema.parse(memberData);\n      const member = await storage.addGroupMember(validatedData);\n      res.status(201).json(member);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/groups/:groupId/members/:userId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const requestingUserId = getUserIdFromRequest(req);\n      const members = await storage.getGroupMembers(req.params.groupId);\n      \n      // Check if user is owner/admin OR removing themselves\n      const userMember = members.find((m: any) => m.userId === requestingUserId);\n      const isOwnerOrAdmin = userMember && (userMember.role === 'owner' || userMember.role === 'admin');\n      const isRemovingSelf = requestingUserId === req.params.userId;\n      \n      if (!isOwnerOrAdmin && !isRemovingSelf) {\n        return res.status(403).json({ message: \"Only group owners/admins can remove members, or you can remove yourself\" });\n      }\n      \n      await storage.removeGroupMember(req.params.groupId, req.params.userId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Group invite routes\n  app.post(\"/api/groups/:id/invites\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const inviteData = {\n        ...req.body,\n        groupId: req.params.id,\n        createdBy: userId,\n        expiresAt: req.body.expiresAt ? new Date(req.body.expiresAt) : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Default 7 days\n      };\n      \n      const validatedData = insertGroupInviteSchema.parse(inviteData);\n      const result = await storage.createGroupInvite(validatedData);\n      res.status(201).json(result);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/invites/:token\", async (req, res) => {\n    try {\n      const invite = await storage.getGroupInviteByToken(req.params.token);\n      if (!invite) {\n        return res.status(404).json({ message: \"Invalid or expired invite\" });\n      }\n      \n      // Return invite metadata without sensitive information\n      const group = await storage.getGroup(invite.groupId);\n      res.json({\n        id: invite.id,\n        group: {\n          id: group?.id,\n          name: group?.name,\n          description: group?.description,\n        },\n        role: invite.role,\n        expiresAt: invite.expiresAt,\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/invites/:token/accept\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const member = await storage.acceptGroupInvite(req.params.token, userId);\n      res.status(201).json(member);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/invites/:token\", async (req, res) => {\n    try {\n      await storage.revokeGroupInvite(req.params.token);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Event routes\n  app.get(\"/api/events\", isAuthenticated, async (req: any, res) => {\n    try {\n      const groupId = req.query.groupId as string;\n      const limit = parseInt(req.query.limit as string) || 100;\n      const offset = parseInt(req.query.offset as string) || 0;\n      \n      let events;\n      if (groupId) {\n        events = await storage.getEventsByGroupId(groupId);\n      } else {\n        // Use authenticated user from session\n        const userId = getUserIdFromRequest(req);\n        events = await storage.getUserAccessibleEventsWithGroups(userId, limit, offset);\n      }\n      \n      res.json(events);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/events/upcoming\", isAuthenticated, async (req: any, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      \n      // Use authenticated user from session\n      const userId = getUserIdFromRequest(req);\n      const events = await storage.getUpcomingEventsWithAttendees(userId, limit);\n      res.json(events);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/events\", async (req, res) => {\n    try {\n      // Convert string dates to Date objects for validation\n      const eventData = {\n        ...req.body,\n        startTime: new Date(req.body.startTime),\n        endTime: new Date(req.body.endTime),\n        // Coerce decimal fields to strings for validation\n        ...(req.body.budget != null && { budget: req.body.budget.toString() }),\n        ...(req.body.actualCost != null && { actualCost: req.body.actualCost.toString() }),\n      };\n      \n      const validatedData = insertEventSchema.parse(eventData);\n      const event = await storage.createEvent(validatedData);\n      res.status(201).json(event);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/events/:id\", async (req, res) => {\n    try {\n      const event = await storage.getEvent(req.params.id);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      res.json(event);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/events/:id\", async (req, res) => {\n    try {\n      // Convert string dates to Date objects for validation if present\n      const eventData = {\n        ...req.body,\n        ...(req.body.startTime && { startTime: new Date(req.body.startTime) }),\n        ...(req.body.endTime && { endTime: new Date(req.body.endTime) }),\n        // Coerce decimal fields to strings for validation\n        ...(req.body.budget != null && { budget: req.body.budget.toString() }),\n        ...(req.body.actualCost != null && { actualCost: req.body.actualCost.toString() }),\n      };\n      \n      const updateData = insertEventSchema.partial().parse(eventData);\n      const event = await storage.updateEvent(req.params.id, updateData);\n      res.json(event);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/events/:id\", async (req, res) => {\n    try {\n      await storage.deleteEvent(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // RSVP routes\n  app.post(\"/api/events/:id/rsvp\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Validate RSVP data using Zod schema\n      const rsvpSchema = eventAttendeeSchema.pick({ status: true });\n      const { status } = rsvpSchema.parse(req.body);\n      \n      const event = await storage.updateEventRSVP(req.params.id, userId, status);\n      res.json(event);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Financial goal routes\n  app.get(\"/api/financial-goals\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const goals = await storage.getFinancialGoalsByUserId(userId);\n      res.json(goals);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/financial-goals\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertFinancialGoalSchema.parse({ ...req.body, userId });\n      const goal = await storage.createFinancialGoal(validatedData);\n      \n      // Auto-disable demo mode when user adds real data\n      try {\n        const preferences = await storage.getUserPreferences(userId);\n        if (preferences?.demoMode) {\n          await storage.updateUserPreferences(userId, { demoMode: false });\n        }\n      } catch (e) {\n        // Non-critical - don't fail goal creation if demo mode update fails\n      }\n      \n      res.status(201).json(goal);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/financial-goals/:id\", async (req, res) => {\n    try {\n      const goal = await storage.getFinancialGoal(req.params.id);\n      if (!goal) {\n        return res.status(404).json({ message: \"Financial goal not found\" });\n      }\n      res.json(goal);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/financial-goals/:id\", async (req, res) => {\n    try {\n      // Convert string date to Date object for validation if present\n      const goalData = {\n        ...req.body,\n        ...(req.body.targetDate && { targetDate: new Date(req.body.targetDate) }),\n      };\n      \n      const updateData = insertFinancialGoalSchema.partial().parse(goalData);\n      const goal = await storage.updateFinancialGoal(req.params.id, updateData);\n      \n      // Check for new milestones if currentAmount was updated\n      if (updateData.currentAmount) {\n        const currentAmount = parseFloat(goal.currentAmount || '0');\n        const targetAmount = parseFloat(String(goal.targetAmount));\n        const newMilestones = await storage.checkAndCreateMilestones(\n          goal.userId,\n          goal.id,\n          currentAmount,\n          targetAmount\n        );\n        \n        // Return goal with any new milestones\n        res.json({ ...goal, newMilestones });\n      } else {\n        res.json(goal);\n      }\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/financial-goals/:id\", async (req, res) => {\n    try {\n      await storage.deleteFinancialGoal(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Goal Milestone routes\n  app.get(\"/api/goal-milestones\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const milestones = await storage.getUnseenMilestones(userId);\n      res.json(milestones);\n    } catch (error: any) {\n      console.error('Error fetching milestones:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/goal-milestones/mark-seen\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      await storage.markMilestonesSeen(userId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('Error marking milestones seen:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Streak Routes\n  app.get(\"/api/streaks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const streak = await storage.getUserStreak(userId);\n      const achievements = await storage.getUserAchievements(userId);\n      \n      res.json({\n        currentStreak: streak?.currentStreak ?? 0,\n        longestStreak: streak?.longestStreak ?? 0,\n        lastCheckIn: streak?.lastCheckIn ?? null,\n        totalCheckIns: streak?.totalCheckIns ?? 0,\n        weeklyProgress: streak?.weeklyProgress ?? [false, false, false, false, false, false, false],\n        achievements: achievements.map(a => ({\n          id: a.achievementId,\n          title: getAchievementTitle(a.achievementId),\n          description: getAchievementDescription(a.achievementId),\n          icon: getAchievementIcon(a.achievementId),\n          earnedAt: a.earnedAt,\n          progress: a.progress ?? 0,\n          target: a.target,\n        })),\n      });\n    } catch (error: any) {\n      console.error('Error fetching streak:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/streaks/check-in\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const result = await storage.checkInStreak(userId);\n      res.json(result);\n    } catch (error: any) {\n      console.error('Error checking in streak:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/financial-goals/:id/milestones\", isAuthenticated, async (req: any, res) => {\n    try {\n      const milestones = await storage.getGoalMilestones(req.params.id);\n      res.json(milestones);\n    } catch (error: any) {\n      console.error('Error fetching goal milestones:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Shared Goals routes\n  app.post(\"/api/goals/:goalId/share\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { sharedWithUserId, permission } = req.body;\n      \n      // Verify goal ownership\n      const goal = await storage.getFinancialGoal(req.params.goalId);\n      if (!goal || goal.userId !== userId) {\n        return res.status(403).json({ message: \"You can only share your own goals\" });\n      }\n      \n      // Check if they are friends\n      const areFriends = await storage.areFriends(userId, sharedWithUserId);\n      if (!areFriends) {\n        return res.status(400).json({ message: \"You can only share goals with friends\" });\n      }\n      \n      const share = await storage.shareGoal({\n        goalId: req.params.goalId,\n        ownerId: userId,\n        sharedWithUserId,\n        permission: permission || 'view',\n        status: 'active'\n      });\n      \n      res.status(201).json(share);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/goals/shared\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const sharedGoals = await storage.getSharedGoals(userId);\n      res.json(sharedGoals);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/goals/:goalId/shares\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Verify goal ownership\n      const goal = await storage.getFinancialGoal(req.params.goalId);\n      if (!goal || goal.userId !== userId) {\n        return res.status(403).json({ message: \"You can only view shares for your own goals\" });\n      }\n      \n      const shares = await storage.getGoalShares(req.params.goalId);\n      res.json(shares);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/goals/:goalId/share/:userId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const ownerId = getUserIdFromRequest(req);\n      \n      // Verify goal ownership\n      const goal = await storage.getFinancialGoal(req.params.goalId);\n      if (!goal || goal.userId !== ownerId) {\n        return res.status(403).json({ message: \"You can only unshare your own goals\" });\n      }\n      \n      await storage.removeGoalShare(req.params.goalId, req.params.userId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.patch(\"/api/goals/:goalId/share/:userId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const ownerId = getUserIdFromRequest(req);\n      const { permission } = req.body;\n      \n      // Verify goal ownership\n      const goal = await storage.getFinancialGoal(req.params.goalId);\n      if (!goal || goal.userId !== ownerId) {\n        return res.status(403).json({ message: \"You can only update shares for your own goals\" });\n      }\n      \n      const share = await storage.updateGoalSharePermission(req.params.goalId, req.params.userId, permission);\n      res.json(share);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/goals/:goalId/share-with-group\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { groupId, permission } = req.body;\n      \n      debugLog('Goals', 'Starting share request', { goalId: req.params.goalId, userId, groupId, permission });\n      \n      // Verify goal ownership\n      const goal = await storage.getFinancialGoal(req.params.goalId);\n      debugLog('Goals', 'Goal found', { goalUserId: goal?.userId, requestUserId: userId, matches: goal?.userId === userId });\n      if (!goal || goal.userId !== userId) {\n        debugLog('Goals', 'Share failed: ownership check failed');\n        return res.status(403).json({ message: \"You can only share your own goals\" });\n      }\n      \n      // Verify user is member of the group\n      const members = await storage.getGroupMembers(groupId);\n      debugLog('Goals', 'Group members found', { count: members.length });\n      const isMember = members.some((m: any) => m.userId === userId);\n      debugLog('Goals', 'Membership check', { isMember });\n      if (!isMember) {\n        debugLog('Goals', 'Share failed: user not a member of the group');\n        return res.status(403).json({ message: \"You must be a member of the group to share goals with it\" });\n      }\n      \n      // Share goal with group\n      const result = await storage.shareGoalWithGroup(\n        req.params.goalId,\n        userId,\n        groupId,\n        permission || 'view'\n      );\n      \n      // Create notifications for all group members\n      const notificationPromises = members\n        .filter((m: any) => m.userId !== userId)\n        .map((m: any) => storage.createNotification({\n          userId: m.userId,\n          type: 'goal_shared',\n          category: 'goals',\n          priority: 'normal',\n          title: 'Goal Shared With You',\n          message: `${goal.title} has been shared with your group`,\n          data: { goalId: req.params.goalId, groupId, permission },\n          isRead: false,\n        }));\n      \n      await Promise.all(notificationPromises);\n      \n      res.status(201).json({\n        success: true,\n        groupShare: result.groupShare,\n        memberCount: result.memberCount,\n        message: `Goal shared with ${result.memberCount} group members`,\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Shared Budgets routes\n  app.post(\"/api/shared-budgets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertSharedBudgetSchema.parse({\n        ...req.body,\n        createdBy: userId,\n        status: 'active'\n      });\n      \n      const budget = await storage.createSharedBudget(validatedData);\n      res.status(201).json(budget);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/shared-budgets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budgets = await storage.getSharedBudgetsByUserId(userId);\n      res.json(budgets);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/shared-budgets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getSharedBudget(req.params.id);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      // Check if user is a member\n      const members = await storage.getSharedBudgetMembers(req.params.id);\n      const isMember = members.some(m => m.userId === userId);\n      \n      if (!isMember) {\n        return res.status(403).json({ message: \"You don't have access to this budget\" });\n      }\n      \n      res.json(budget);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/shared-budgets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getSharedBudget(req.params.id);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      // Only owner can update budget\n      if (budget.createdBy !== userId) {\n        return res.status(403).json({ message: \"Only the owner can update this budget\" });\n      }\n      \n      const updateData = insertSharedBudgetSchema.partial().parse(req.body);\n      const updatedBudget = await storage.updateSharedBudget(req.params.id, updateData);\n      res.json(updatedBudget);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/shared-budgets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getSharedBudget(req.params.id);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      // Only owner can delete budget\n      if (budget.createdBy !== userId) {\n        return res.status(403).json({ message: \"Only the owner can delete this budget\" });\n      }\n      \n      await storage.deleteSharedBudget(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.patch(\"/api/shared-budgets/:budgetId/link-goal\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { goalId } = req.body;\n      \n      // Verify budget exists and user owns it\n      const budget = await storage.getSharedBudget(req.params.budgetId);\n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      if (budget.createdBy !== userId) {\n        return res.status(403).json({ message: \"Only the budget owner can link a goal\" });\n      }\n      \n      // Verify goal exists and user has access (owner or shared with them)\n      const goal = await storage.getFinancialGoal(goalId);\n      if (!goal) {\n        return res.status(404).json({ message: \"Financial goal not found\" });\n      }\n      \n      const hasAccess = goal.userId === userId;\n      if (!hasAccess) {\n        // Check if goal is shared with user\n        const sharedGoals = await storage.getSharedGoals(userId);\n        const hasSharedAccess = sharedGoals.some(sg => sg.goalId === goalId);\n        if (!hasSharedAccess) {\n          return res.status(403).json({ message: \"You don't have access to this goal\" });\n        }\n      }\n      \n      // Update budget with linked goal\n      const updatedBudget = await storage.updateSharedBudget(req.params.budgetId, {\n        linkedGoalId: goalId,\n      });\n      \n      // Return updated budget with goal info\n      res.json({\n        ...updatedBudget,\n        linkedGoal: goal,\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Shared Budget Members routes\n  app.post(\"/api/shared-budgets/:budgetId/members\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { userId: newMemberId, role } = req.body;\n      \n      const budget = await storage.getSharedBudget(req.params.budgetId);\n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      // Only owner can add members\n      if (budget.createdBy !== userId) {\n        return res.status(403).json({ message: \"Only the owner can add members\" });\n      }\n      \n      // Check if they are friends\n      const areFriends = await storage.areFriends(userId, newMemberId);\n      if (!areFriends) {\n        return res.status(400).json({ message: \"You can only add friends to shared budgets\" });\n      }\n      \n      const member = await storage.addSharedBudgetMember({\n        budgetId: req.params.budgetId,\n        userId: newMemberId,\n        role: role || 'member'\n      });\n      \n      res.status(201).json(member);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/shared-budgets/:budgetId/members\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Check if user is a member\n      const members = await storage.getSharedBudgetMembers(req.params.budgetId);\n      const isMember = members.some(m => m.userId === userId);\n      \n      if (!isMember) {\n        return res.status(403).json({ message: \"You don't have access to this budget\" });\n      }\n      \n      res.json(members);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/shared-budgets/:budgetId/members/:userId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const currentUserId = getUserIdFromRequest(req);\n      const budget = await storage.getSharedBudget(req.params.budgetId);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      // Owner can remove anyone, or user can remove themselves\n      const isOwner = budget.createdBy === currentUserId;\n      const isSelf = currentUserId === req.params.userId;\n      \n      if (!isOwner && !isSelf) {\n        return res.status(403).json({ message: \"You can only remove yourself or be the owner\" });\n      }\n      \n      await storage.removeSharedBudgetMember(req.params.budgetId, req.params.userId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Shared Budget Expenses routes\n  app.post(\"/api/shared-budgets/:budgetId/expenses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Check if user is a member\n      const members = await storage.getSharedBudgetMembers(req.params.budgetId);\n      const isMember = members.some(m => m.userId === userId);\n      \n      if (!isMember) {\n        return res.status(403).json({ message: \"You must be a member to add expenses\" });\n      }\n      \n      const validatedData = insertSharedBudgetExpenseSchema.parse({\n        ...req.body,\n        budgetId: req.params.budgetId,\n        userId,\n        date: new Date(req.body.date || Date.now())\n      });\n      \n      const expense = await storage.createSharedBudgetExpense(validatedData);\n      \n      // Check if budget has a linked goal and update it\n      const budget = await storage.getSharedBudget(req.params.budgetId);\n      if (budget?.linkedGoalId) {\n        const goal = await storage.getFinancialGoal(budget.linkedGoalId);\n        if (goal) {\n          const currentAmount = parseFloat(goal.currentAmount?.toString() || '0');\n          const expenseAmount = parseFloat(expense.amount.toString());\n          const newAmount = currentAmount + expenseAmount;\n          \n          await storage.updateFinancialGoal(budget.linkedGoalId, {\n            currentAmount: newAmount.toFixed(2),\n          });\n        }\n      }\n      \n      res.status(201).json(expense);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/shared-budgets/:budgetId/expenses\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Check if user is a member\n      const members = await storage.getSharedBudgetMembers(req.params.budgetId);\n      const isMember = members.some(m => m.userId === userId);\n      \n      if (!isMember) {\n        return res.status(403).json({ message: \"You don't have access to this budget\" });\n      }\n      \n      const expenses = await storage.getSharedBudgetExpenses(req.params.budgetId);\n      res.json(expenses);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/shared-budgets/:budgetId/expenses/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const [expense] = await db\n        .select()\n        .from(sharedBudgetExpenses)\n        .where(eq(sharedBudgetExpenses.id, req.params.id));\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Only the creator can update\n      if (expense.userId !== userId) {\n        return res.status(403).json({ message: \"You can only update your own expenses\" });\n      }\n      \n      const updateData = insertSharedBudgetExpenseSchema.partial().parse(req.body);\n      const updatedExpense = await storage.updateSharedBudgetExpense(req.params.id, updateData);\n      res.json(updatedExpense);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/shared-budgets/:budgetId/expenses/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getSharedBudget(req.params.budgetId);\n      \n      if (!budget) {\n        return res.status(404).json({ message: \"Shared budget not found\" });\n      }\n      \n      const [expense] = await db\n        .select()\n        .from(sharedBudgetExpenses)\n        .where(eq(sharedBudgetExpenses.id, req.params.id));\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Owner or expense creator can delete\n      const isOwner = budget.createdBy === userId;\n      const isCreator = expense.userId === userId;\n      \n      if (!isOwner && !isCreator) {\n        return res.status(403).json({ message: \"You can only delete your own expenses or be the owner\" });\n      }\n      \n      await storage.deleteSharedBudgetExpense(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Friend Group Invitations routes\n  app.post(\"/api/groups/:groupId/invite\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { invitedUserId, role, message } = req.body;\n      \n      // Verify user is admin of the group\n      const members = await storage.getGroupMembers(req.params.groupId);\n      const member = members.find(m => m.userId === userId);\n      if (!member || member.role !== 'admin') {\n        return res.status(403).json({ message: \"Only group admins can invite friends\" });\n      }\n      \n      // Check if they are friends\n      const areFriends = await storage.areFriends(userId, invitedUserId);\n      if (!areFriends) {\n        return res.status(400).json({ message: \"You can only invite friends to groups\" });\n      }\n      \n      // Check if already a member\n      const existingMember = members.find(m => m.userId === invitedUserId);\n      if (existingMember) {\n        return res.status(400).json({ message: \"User is already a member of this group\" });\n      }\n      \n      const invitation = await storage.createFriendGroupInvitation({\n        groupId: req.params.groupId,\n        invitedBy: userId,\n        invitedUserId,\n        role: role || 'member',\n        status: 'pending',\n        message: message || null\n      });\n      \n      res.status(201).json(invitation);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/groups/:groupId/bulk-invite-friends\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { friendIds, role } = req.body;\n      \n      if (!Array.isArray(friendIds) || friendIds.length === 0) {\n        return res.status(400).json({ message: \"friendIds must be a non-empty array\" });\n      }\n      \n      // Verify user is group owner or admin\n      const members = await storage.getGroupMembers(req.params.groupId);\n      const member = members.find(m => m.userId === userId);\n      if (!member || (member.role !== 'owner' && member.role !== 'admin')) {\n        return res.status(403).json({ message: \"Only group owners and admins can invite friends\" });\n      }\n      \n      // Get group for notifications\n      const group = await storage.getGroup(req.params.groupId);\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n      \n      // Verify all are friends and not already members\n      const validFriendIds: string[] = [];\n      const errors: string[] = [];\n      \n      for (const friendId of friendIds) {\n        const areFriends = await storage.areFriends(userId, friendId);\n        if (!areFriends) {\n          errors.push(`User ${friendId} is not your friend`);\n          continue;\n        }\n        \n        const existingMember = members.find(m => m.userId === friendId);\n        if (existingMember) {\n          errors.push(`User ${friendId} is already a member`);\n          continue;\n        }\n        \n        validFriendIds.push(friendId);\n      }\n      \n      if (validFriendIds.length === 0) {\n        return res.status(400).json({ \n          message: \"No valid friends to invite\",\n          errors \n        });\n      }\n      \n      // Bulk create invitations\n      const invitations = await storage.bulkInviteFriendsToGroup(\n        req.params.groupId,\n        userId,\n        validFriendIds,\n        role\n      );\n      \n      // Create notifications for each invited friend\n      const notificationPromises = invitations.map(inv => \n        storage.createNotification({\n          userId: inv.invitedUserId,\n          type: 'group_invitation',\n          category: 'suggestions',\n          priority: 'normal',\n          title: 'Group Invitation',\n          message: `You've been invited to join ${group.name}`,\n          data: { groupId: req.params.groupId, invitationId: inv.id },\n          isRead: false,\n        })\n      );\n      \n      await Promise.all(notificationPromises);\n      \n      res.status(201).json({\n        success: true,\n        invitations,\n        count: invitations.length,\n        errors: errors.length > 0 ? errors : undefined,\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/group-invitations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const invitations = await storage.getFriendGroupInvitations(userId);\n      res.json(invitations);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.patch(\"/api/group-invitations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { status } = req.body;\n      \n      // Get invitation to verify it belongs to user\n      const [invitation] = await db\n        .select()\n        .from(friendGroupInvitations)\n        .where(eq(friendGroupInvitations.id, req.params.id));\n      \n      if (!invitation) {\n        return res.status(404).json({ message: \"Invitation not found\" });\n      }\n      \n      if (invitation.invitedUserId !== userId) {\n        return res.status(403).json({ message: \"This invitation is not for you\" });\n      }\n      \n      const updatedInvitation = await storage.updateFriendGroupInvitationStatus(req.params.id, status);\n      res.json(updatedInvitation);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/group-invitations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Get invitation to verify user can delete it\n      const [invitation] = await db\n        .select()\n        .from(friendGroupInvitations)\n        .where(eq(friendGroupInvitations.id, req.params.id));\n      \n      if (!invitation) {\n        return res.status(404).json({ message: \"Invitation not found\" });\n      }\n      \n      // Can delete if you sent it or received it\n      if (invitation.invitedBy !== userId && invitation.invitedUserId !== userId) {\n        return res.status(403).json({ message: \"You don't have permission to delete this invitation\" });\n      }\n      \n      await storage.deleteFriendGroupInvitation(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Transaction routes\n  app.get(\"/api/transactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const goalId = req.query.goalId as string;\n      const limit = parseInt(req.query.limit as string) || 50;\n      \n      let transactions;\n      if (goalId) {\n        transactions = await storage.getTransactionsByGoalId(goalId);\n      } else {\n        const userId = getUserIdFromRequest(req);\n        transactions = await storage.getTransactionsByUserId(userId, limit);\n      }\n      \n      res.json(transactions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // CSV Export for transactions (tax-friendly format)\n  app.get(\"/api/transactions/export\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const startDate = req.query.startDate as string;\n      const endDate = req.query.endDate as string;\n      const type = req.query.type as string;\n      const category = req.query.category as string;\n      const format = req.query.format as string || 'csv';\n\n      // Get all transactions for user (no limit for export)\n      let transactions = await storage.getTransactionsByUserId(userId, 10000);\n\n      // Apply filters\n      if (startDate) {\n        const start = new Date(startDate);\n        transactions = transactions.filter((t: any) => new Date(t.date) >= start);\n      }\n      if (endDate) {\n        const end = new Date(endDate);\n        end.setHours(23, 59, 59, 999);\n        transactions = transactions.filter((t: any) => new Date(t.date) <= end);\n      }\n      if (type && type !== 'all') {\n        transactions = transactions.filter((t: any) => t.type === type);\n      }\n      if (category && category !== 'all') {\n        transactions = transactions.filter((t: any) => t.category === category);\n      }\n\n      // Sort by date (oldest first for tax purposes)\n      transactions.sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());\n\n      // Calculate summary with safe type handling for empty datasets\n      const parseAmountSafe = (amount: any): number => {\n        if (!amount) return 0;\n        const parsed = parseFloat(String(amount));\n        return isNaN(parsed) ? 0 : parsed;\n      };\n      \n      const summary = {\n        totalIncome: transactions\n          .filter((t: any) => t.type === 'income')\n          .reduce((sum: number, t: any) => sum + parseAmountSafe(t.amount), 0),\n        totalExpenses: transactions\n          .filter((t: any) => t.type === 'expense')\n          .reduce((sum: number, t: any) => sum + parseAmountSafe(t.amount), 0),\n        totalTransfers: transactions\n          .filter((t: any) => t.type === 'transfer')\n          .reduce((sum: number, t: any) => sum + parseAmountSafe(t.amount), 0),\n        transactionCount: transactions.length,\n        dateRange: {\n          start: transactions.length > 0 ? transactions[0].date : null,\n          end: transactions.length > 0 ? transactions[transactions.length - 1].date : null,\n        }\n      };\n\n      // Generate CSV\n      const csvHeaders = ['Date', 'Type', 'Category', 'Description', 'Amount', 'Destination'];\n      const csvRows = transactions.map((t: any) => {\n        const date = new Date(t.date).toISOString().split('T')[0];\n        const safeAmount = parseAmountSafe(t.amount);\n        const formattedAmount = t.type === 'expense' ? `-${safeAmount.toFixed(2)}` : safeAmount.toFixed(2);\n        return [\n          date,\n          t.type || 'unknown',\n          t.category || 'uncategorized',\n          `\"${(t.description || '').replace(/\"/g, '\"\"')}\"`,\n          formattedAmount,\n          t.destination || ''\n        ].join(',');\n      });\n\n      // Add summary rows at the end\n      const summaryRows = [\n        '',\n        '--- SUMMARY ---',\n        `Total Income,${summary.totalIncome.toFixed(2)}`,\n        `Total Expenses,-${summary.totalExpenses.toFixed(2)}`,\n        `Total Transfers,${summary.totalTransfers.toFixed(2)}`,\n        `Net Cash Flow,${(summary.totalIncome - summary.totalExpenses).toFixed(2)}`,\n        `Transaction Count,${summary.transactionCount}`,\n        `Export Date,${new Date().toISOString().split('T')[0]}`\n      ];\n\n      const csv = [csvHeaders.join(','), ...csvRows, ...summaryRows].join('\\n');\n\n      // Set headers for file download\n      const filename = `twealth_transactions_${new Date().toISOString().split('T')[0]}.csv`;\n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error: any) {\n      console.error('[CSV Export] Error:', error);\n      res.status(500).json({ message: 'Failed to export transactions' });\n    }\n  });\n\n  app.post(\"/api/transactions\", transactionLimiter, isAuthenticated, async (req: any, res) => {\n    try {\n      // Get userId from authenticated session\n      const userId = getUserIdFromRequest(req);\n      \n      // Parse and validate request body\n      let validatedData = insertTransactionSchema.parse(req.body);\n      \n      // Set userId from session\n      validatedData = { ...validatedData, userId };\n      \n      // Auto-categorize if category is not provided or is \"Other\"\n      if (!validatedData.category || validatedData.category === 'Other' || validatedData.category === 'other') {\n        const description = validatedData.description || '';\n        const amount = parseFloat(validatedData.amount.toString());\n        const type = validatedData.type as 'income' | 'expense' | 'transfer';\n        const autoCategory = autoCategorizeTransaction(description, amount, type);\n        \n        if (autoCategory !== 'Other') {\n          validatedData = { ...validatedData, category: autoCategory };\n          debugLog('Transactions', `Auto-categorized \"${description}\" → ${autoCategory}`);\n        } else {\n          // Set to \"other\" if no category could be detected\n          validatedData = { ...validatedData, category: 'other' };\n        }\n      }\n      \n      const transaction = await storage.createTransaction(validatedData);\n      \n      // Auto-disable demo mode when user adds real data\n      try {\n        const preferences = await storage.getUserPreferences(userId);\n        if (preferences?.demoMode) {\n          await storage.updateUserPreferences(userId, { demoMode: false });\n        }\n      } catch (e) {\n        // Non-critical - don't fail transaction creation if demo mode update fails\n      }\n      \n      res.status(201).json(transaction);\n    } catch (error: any) {\n      console.error('[POST /api/transactions] Error:', error);\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Bulk import transactions from CSV\n  app.post(\"/api/transactions/bulk-import\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { transactions: txData } = req.body;\n      \n      if (!Array.isArray(txData) || txData.length === 0) {\n        return res.status(400).json({ message: \"No transactions provided\" });\n      }\n      \n      if (txData.length > 500) {\n        return res.status(400).json({ message: \"Maximum 500 transactions per import\" });\n      }\n      \n      const transactionsToCreate: InsertTransaction[] = txData.map((tx: any) => {\n        const amount = parseFloat(tx.amount?.toString() || '0');\n        const type = amount >= 0 ? 'income' : 'expense';\n        const description = tx.description || '';\n        \n        let category = tx.category || autoCategorizeTransaction(description, Math.abs(amount), type);\n        if (!category || category === 'Other') {\n          category = type === 'income' ? 'salary' : 'other';\n        }\n        \n        return {\n          userId,\n          amount: Math.abs(amount).toString(),\n          type,\n          category,\n          description,\n          date: new Date(tx.date),\n        };\n      });\n      \n      const created = await storage.bulkCreateTransactions(transactionsToCreate);\n      \n      // Auto-disable demo mode when user imports real data\n      try {\n        const preferences = await storage.getUserPreferences(userId);\n        if (preferences?.demoMode) {\n          await storage.updateUserPreferences(userId, { demoMode: false });\n        }\n      } catch (e) {\n        // Non-critical\n      }\n      \n      res.status(201).json({ \n        imported: created.length,\n        message: `Successfully imported ${created.length} transactions`\n      });\n    } catch (error: any) {\n      console.error('[POST /api/transactions/bulk-import] Error:', error);\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Get financial summary calculated from actual transactions\n  app.get(\"/api/financial-summary\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const months = parseInt(req.query.months as string) || 6;\n      \n      const summary = await storage.getFinancialSummary(userId, months);\n      res.json(summary);\n    } catch (error: any) {\n      console.error('[GET /api/financial-summary] Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Transaction categorization routes - MUST be before /:id routes\n  app.get(\"/api/transactions/categories\", async (req, res) => {\n    try {\n      const type = req.query.type as 'income' | 'expense' | 'transfer' | undefined;\n      const categories = type ? getAvailableCategories(type) : getAvailableCategories('expense');\n      res.json(categories);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/transactions/categorize-suggestions\", async (req, res) => {\n    try {\n      const { description, type } = req.body;\n      if (!description) {\n        return res.status(400).json({ message: \"Description is required\" });\n      }\n      const suggestions = getCategorySuggestions(description, type || 'expense');\n      res.json(suggestions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/transactions/:id\", async (req, res) => {\n    try {\n      const transaction = await storage.getTransaction(req.params.id);\n      if (!transaction) {\n        return res.status(404).json({ message: \"Transaction not found\" });\n      }\n      res.json(transaction);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/transactions/:id\", async (req, res) => {\n    try {\n      // Convert string date to Date object for validation if present\n      const transactionData = {\n        ...req.body,\n        ...(req.body.date && { date: new Date(req.body.date) }),\n      };\n      \n      const updateData = insertTransactionSchema.partial().parse(transactionData);\n      const transaction = await storage.updateTransaction(req.params.id, updateData);\n      res.json(transaction);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/transactions/:id\", async (req, res) => {\n    try {\n      await storage.deleteTransaction(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/transactions/bulk-categorize\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { transactionIds } = req.body;\n      \n      if (!Array.isArray(transactionIds) || transactionIds.length === 0) {\n        return res.status(400).json({ message: \"transactionIds array is required\" });\n      }\n      \n      // Get all transactions and auto-categorize them\n      const updated = [];\n      for (const txId of transactionIds) {\n        const transaction = await storage.getTransaction(txId);\n        if (!transaction || transaction.userId !== userId) {\n          continue; // Skip transactions that don't exist or don't belong to user\n        }\n        \n        // Auto-categorize\n        const description = transaction.description || '';\n        const amount = parseFloat(transaction.amount.toString());\n        const type = transaction.type as 'income' | 'expense' | 'transfer';\n        const autoCategory = autoCategorizeTransaction(description, amount, type);\n        \n        if (autoCategory !== 'Other' && autoCategory !== transaction.category) {\n          const updatedTx = await storage.updateTransaction(txId, { category: autoCategory });\n          updated.push(updatedTx);\n          debugLog('Transactions', `Bulk-categorized \"${description}\" → ${autoCategory}`);\n        }\n      }\n      \n      res.json({ \n        success: true, \n        updated: updated.length,\n        total: transactionIds.length,\n        transactions: updated \n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Transaction archive route\n  app.patch(\"/api/transactions/:id/archive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const transaction = await storage.getTransaction(req.params.id);\n      \n      if (!transaction || transaction.userId !== userId) {\n        return res.status(404).json({ message: \"Transaction not found\" });\n      }\n      \n      const updated = await storage.updateTransaction(req.params.id, { \n        isArchived: !transaction.isArchived \n      });\n      res.json(updated);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Transaction flag route\n  app.patch(\"/api/transactions/:id/flag\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const transaction = await storage.getTransaction(req.params.id);\n      \n      if (!transaction || transaction.userId !== userId) {\n        return res.status(404).json({ message: \"Transaction not found\" });\n      }\n      \n      const updated = await storage.updateTransaction(req.params.id, { \n        isFlagged: !transaction.isFlagged \n      });\n      res.json(updated);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Budget routes\n  app.get(\"/api/budgets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budgets = await storage.getBudgetsByUserId(userId);\n      res.json(budgets);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/budgets\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Parse and validate request body\n      let validatedData = insertBudgetSchema.parse(req.body);\n      \n      // Set userId from session\n      validatedData = { ...validatedData, userId };\n      \n      // Check if budget already exists for this category\n      const existing = await storage.getBudgetByUserAndCategory(userId, validatedData.category);\n      if (existing) {\n        return res.status(409).json({ \n          message: `Budget already exists for category \"${validatedData.category}\". Please update it instead.` \n        });\n      }\n      \n      const budget = await storage.createBudget(validatedData);\n      res.status(201).json(budget);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/budgets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getBudget(req.params.id);\n      \n      if (!budget || budget.userId !== userId) {\n        return res.status(404).json({ message: \"Budget not found\" });\n      }\n      \n      const updated = await storage.updateBudget(req.params.id, req.body);\n      res.json(updated);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/budgets/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const budget = await storage.getBudget(req.params.id);\n      \n      if (!budget || budget.userId !== userId) {\n        return res.status(404).json({ message: \"Budget not found\" });\n      }\n      \n      await storage.deleteBudget(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Calendar share routes\n  app.get(\"/api/calendar/shares\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const shares = await storage.getCalendarSharesByUserId(userId);\n      res.json(shares);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/calendar/shares\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const shareData = {\n        ...req.body,\n        // Set owner to current user\n        ownerId: userId,\n        // Set default expiry to 30 days if not provided\n        ...(req.body.expiresAt ? { expiresAt: new Date(req.body.expiresAt) } : { expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) }),\n      };\n      \n      const validatedData = insertCalendarShareSchema.parse(shareData);\n      const result = await storage.createCalendarShare(validatedData);\n      res.status(201).json(result);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Public calendar access routes\n  app.get(\"/api/public/calendar/:token\", async (req, res) => {\n    try {\n      const events = await storage.getEventsForShare(req.params.token);\n      res.json(events);\n    } catch (error: any) {\n      res.status(404).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/public/calendar/:token/ics\", async (req, res) => {\n    const token = req.params.token;\n    try {\n      const events = await storage.getEventsForShare(token);\n      \n      // Generate ICS content\n      const icsLines = [\n        \"BEGIN:VCALENDAR\",\n        \"VERSION:2.0\",\n        \"PRODID:-//ScheduleMoney//EN\",\n        \"CALSCALE:GREGORIAN\",\n        \"METHOD:PUBLISH\",\n      ];\n\n      for (const event of events) {\n        const startDate = new Date(event.startTime).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n        const endDate = new Date(event.endTime).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\n        const uid = `${event.id}@schedulmoney.app`;\n        \n        icsLines.push(\n          \"BEGIN:VEVENT\",\n          `UID:${uid}`,\n          `DTSTART:${startDate}`,\n          `DTEND:${endDate}`,\n          `SUMMARY:${event.title.replace(/,/g, '\\\\,')}`,\n          ...(event.description ? [`DESCRIPTION:${event.description.replace(/,/g, '\\\\,')}`] : []),\n          ...(event.location ? [`LOCATION:${event.location.replace(/,/g, '\\\\,')}`] : []),\n          `STATUS:${event.status?.toUpperCase() || 'CONFIRMED'}`,\n          \"END:VEVENT\"\n        );\n      }\n\n      icsLines.push(\"END:VCALENDAR\");\n      \n      const icsContent = icsLines.join('\\r\\n');\n      \n      res.set({\n        'Content-Type': 'text/calendar; charset=utf-8',\n        'Content-Disposition': 'attachment; filename=\"calendar.ics\"',\n      });\n      res.send(icsContent);\n    } catch (error: any) {\n      res.status(404).json({ message: error.message });\n    }\n  });\n\n  // Friend request routes\n  app.post(\"/api/friend-requests\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const requestData = {\n        fromUserId: userId,\n        toUserId: req.body.toUserId,\n        message: req.body.message,\n      };\n      \n      const validatedData = insertFriendRequestSchema.parse(requestData);\n      const request = await storage.createFriendRequest(validatedData);\n      res.status(201).json(request);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/friend-requests/pending\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const requests = await storage.getPendingFriendRequests(userId);\n      res.json(requests);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/friend-requests/sent\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const requests = await storage.getSentFriendRequests(userId);\n      res.json(requests);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/friend-requests/:id/respond\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { status } = req.body;\n      \n      if (!['accepted', 'declined'].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status. Must be 'accepted' or 'declined'\" });\n      }\n      \n      const request = await storage.updateFriendRequestStatus(req.params.id, status);\n      res.json(request);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/friend-requests/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      await storage.deleteFriendRequest(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Friendship routes\n  app.get(\"/api/friends\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const friends = await storage.getFriendsByUserId(userId);\n      res.json(friends);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/friends/:friendId\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      await storage.removeFriendship(userId, req.params.friendId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Event expense routes\n  app.get(\"/api/events/:eventId/expenses\", async (req, res) => {\n    try {\n      const expenses = await storage.getEventExpensesByEventId(req.params.eventId);\n      // Convert decimal amounts to numbers\n      const formattedExpenses = expenses.map(expense => ({\n        ...expense,\n        amount: parseFloat(expense.amount.toString())\n      }));\n      res.json(formattedExpenses);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/events/:eventId/expenses\", async (req, res) => {\n    try {\n      const expenseData = {\n        ...req.body,\n        eventId: req.params.eventId,\n        date: new Date(req.body.date || Date.now()),\n        // Coerce amount to string for validation\n        amount: req.body.amount?.toString() || \"0\"\n      };\n      \n      const validatedData = insertEventExpenseSchema.parse(expenseData);\n      const expense = await storage.createEventExpense(validatedData);\n      \n      // Convert decimal amount to number for response\n      const formattedExpense = {\n        ...expense,\n        amount: parseFloat(expense.amount.toString())\n      };\n      \n      res.status(201).json(formattedExpense);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/expenses/:id\", async (req, res) => {\n    try {\n      const expense = await storage.getEventExpense(req.params.id);\n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      const formattedExpense = {\n        ...expense,\n        amount: parseFloat(expense.amount.toString())\n      };\n      \n      res.json(formattedExpense);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/expenses/:id\", async (req, res) => {\n    try {\n      const expenseData = {\n        ...req.body,\n        ...(req.body.date && { date: new Date(req.body.date) }),\n        ...(req.body.amount && { amount: req.body.amount.toString() })\n      };\n      \n      const updateData = insertEventExpenseSchema.partial().parse(expenseData);\n      const expense = await storage.updateEventExpense(req.params.id, updateData);\n      \n      const formattedExpense = {\n        ...expense,\n        amount: parseFloat(expense.amount.toString())\n      };\n      \n      res.json(formattedExpense);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/expenses/:id\", async (req, res) => {\n    try {\n      await storage.deleteEventExpense(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Event expense share routes\n  app.get(\"/api/expenses/:expenseId/shares\", async (req, res) => {\n    try {\n      const shares = await storage.getEventExpenseSharesByExpenseId(req.params.expenseId);\n      const formattedShares = shares.map(share => ({\n        ...share,\n        shareAmount: parseFloat(share.shareAmount.toString())\n      }));\n      res.json(formattedShares);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/expenses/:expenseId/shares\", async (req, res) => {\n    try {\n      const shareData = {\n        ...req.body,\n        expenseId: req.params.expenseId,\n        shareAmount: req.body.shareAmount?.toString() || \"0\"\n      };\n      \n      const validatedData = insertEventExpenseShareSchema.parse(shareData);\n      const share = await storage.createEventExpenseShare(validatedData);\n      \n      const formattedShare = {\n        ...share,\n        shareAmount: parseFloat(share.shareAmount.toString())\n      };\n      \n      res.status(201).json(formattedShare);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/expense-shares/:id\", async (req, res) => {\n    try {\n      const shareData = {\n        ...req.body,\n        ...(req.body.shareAmount && { shareAmount: req.body.shareAmount.toString() })\n      };\n      const updateData = insertEventExpenseShareSchema.partial().parse(shareData);\n      const share = await storage.updateEventExpenseShare(req.params.id, updateData);\n      \n      const formattedShare = {\n        ...share,\n        shareAmount: parseFloat(share.shareAmount.toString())\n      };\n      \n      res.json(formattedShare);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/expense-shares/:id\", async (req, res) => {\n    try {\n      await storage.deleteEventExpenseShare(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Event financial summary route\n  app.get(\"/api/events/:eventId/financial-summary\", async (req, res) => {\n    try {\n      const summary = await storage.getEventFinancialSummary(req.params.eventId);\n      res.json(summary);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===============================\n  // TIME TRACKING & VALUE ROUTES\n  // ===============================\n\n  // User Settings Routes\n  app.get(\"/api/user-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const settings = await storage.getUserSettings(userId);\n      if (!settings) {\n        return res.status(404).json({ message: \"User settings not found\" });\n      }\n      res.json({\n        ...settings,\n        hourlyRate: parseFloat((settings.hourlyRate || 50).toString())\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/user-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const settingsData = { ...req.body, userId: userId };\n      const validatedData = insertUserSettingsSchema.parse(settingsData);\n      const settings = await storage.createUserSettings(validatedData);\n      res.status(201).json({\n        ...settings,\n        hourlyRate: parseFloat((settings.hourlyRate || 50).toString())\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/user-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertUserSettingsSchema.omit({ userId: true }).partial().parse(req.body);\n      const settings = await storage.updateUserSettings(userId, validatedData);\n      res.json({\n        ...settings,\n        hourlyRate: parseFloat((settings.hourlyRate || 50).toString())\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // User Preferences Routes\n  app.get(\"/api/user-preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const user = await storage.getUser(userId);\n      \n      if (!user) {\n        console.error('[/api/user-preferences] User not found for ID:', userId);\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      const preferences = await storage.getUserPreferences(user.id);\n      if (!preferences) {\n        // Create default preferences if they don't exist\n        const defaultPrefs = { \n          userId: user.id,\n          theme: \"system\" as const\n        };\n        const newPrefs = await storage.createUserPreferences(defaultPrefs);\n        return res.json(newPrefs);\n      }\n      res.json(preferences);\n    } catch (error: any) {\n      console.error('[/api/user-preferences] Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/user-preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = updateUserPreferencesSchema.parse(req.body);\n      // The validated data from Zod matches the Partial<UserPreferences> type expected by storage\n      // Type assertion is safe here as the schema ensures correctness\n      const preferences = await storage.updateUserPreferences(userId, validatedData as Partial<UserPreferences>);\n      res.json(preferences);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Onboarding progress route\n  app.put(\"/api/user-preferences/onboarding\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { onboardingStep, onboardingData } = req.body;\n      \n      // Get current preferences to merge onboarding data\n      const currentPrefs = await storage.getUserPreferences(userId);\n      const mergedData = {\n        ...currentPrefs?.onboardingData as any,\n        ...onboardingData\n      } as any;\n      \n      const preferences = await storage.updateUserPreferences(userId, {\n        onboardingStep,\n        onboardingData: mergedData\n      });\n      \n      res.json(preferences);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Financial Preferences Routes\n  app.get(\"/api/financial-preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const preferences = await storage.getFinancialPreferences(userId);\n      if (!preferences) {\n        // Create default preferences if they don't exist\n        const defaultPrefs = {\n          userId: userId,\n          defaultBudgetPeriod: \"monthly\" as const,\n          autoSavingsAmount: \"0.00\",\n          autoSavingsFrequency: \"monthly\" as const,\n          defaultGoalPriority: \"medium\" as const\n        };\n        const newPrefs = await storage.createFinancialPreferences(defaultPrefs);\n        return res.json(newPrefs);\n      }\n      res.json(preferences);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/financial-preferences\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertFinancialPreferencesSchema.omit({ userId: true }).partial().parse(req.body);\n      const preferences = await storage.updateFinancialPreferences(userId, validatedData);\n      res.json(preferences);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Tax Calculation Routes\n  app.post(\"/api/calculate-tax\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { income, period, countryCode } = req.body;\n      \n      if (!income || income <= 0) {\n        return res.status(400).json({ message: \"Income must be a positive number\" });\n      }\n      \n      const country = countryCode || 'US';\n      \n      if (!taxService.isCountrySupported(country)) {\n        return res.status(400).json({ \n          message: `Country code ${country} is not supported`,\n          supportedCountries: taxService.getSupportedCountries().map(c => ({\n            code: c.countryCode,\n            name: c.countryName\n          }))\n        });\n      }\n      \n      const result = period === 'annual' \n        ? taxService.calculateAnnualTax(income, country)\n        : taxService.calculateMonthlyTax(income, country);\n      \n      res.json(result);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/supported-tax-countries\", async (req, res) => {\n    try {\n      const countries = taxService.getSupportedCountries();\n      res.json(countries.map(c => ({\n        code: c.countryCode,\n        name: c.countryName,\n        currency: c.currency\n      })));\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Spending Pattern Analysis Routes\n  app.get(\"/api/spending-patterns\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const transactions = await storage.getTransactionsByUserId(userId, 100); // Last 100 transactions\n      \n      const insights = spendingPatternService.analyzeSpendingPatterns(transactions as any);\n      res.json(insights);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Privacy Settings Routes\n  app.get(\"/api/privacy-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const settings = await storage.getPrivacySettings(userId);\n      if (!settings) {\n        // Create default settings if they don't exist\n        const defaultSettings = {\n          userId: userId,\n          profileVisibility: \"private\" as const\n        };\n        const newSettings = await storage.createPrivacySettings(defaultSettings);\n        return res.json(newSettings);\n      }\n      res.json(settings);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/privacy-settings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertPrivacySettingsSchema.omit({ userId: true }).partial().parse(req.body);\n      const settings = await storage.updatePrivacySettings(userId, validatedData);\n      res.json(settings);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Data Export Routes\n  app.get(\"/api/export-data\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const format = req.query.format as 'json' | 'csv' || 'json';\n      \n      if (format !== 'json' && format !== 'csv') {\n        return res.status(400).json({ message: \"Format must be 'json' or 'csv'\" });\n      }\n\n      const exportData = await storage.exportUserData(userId, format);\n      \n      // Update last export timestamp\n      await storage.updatePrivacySettings(userId, { lastDataExport: new Date() });\n      \n      const filename = `twealth-data-${userId}-${new Date().toISOString().split('T')[0]}.${format}`;\n      \n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n      res.setHeader('Content-Type', format === 'json' ? 'application/json' : 'text/csv');\n      res.send(exportData);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/delete-user-data\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { confirmation } = req.body;\n      \n      if (confirmation !== 'DELETE') {\n        return res.status(400).json({ \n          message: \"Data deletion requires confirmation field with value 'DELETE'\" \n        });\n      }\n      \n      await storage.deleteUserData(userId);\n      res.json({ message: \"All user data has been permanently deleted\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Time Tracking Routes\n  app.post(\"/api/time-logs\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Convert date strings to Date objects\n      const timeLogData = {\n        ...req.body,\n        userId: userId,\n        startedAt: req.body.startedAt ? new Date(req.body.startedAt) : undefined,\n        endedAt: req.body.endedAt ? new Date(req.body.endedAt) : undefined\n      };\n      \n      // Calculate duration if both dates are provided\n      if (timeLogData.startedAt && timeLogData.endedAt) {\n        if (timeLogData.endedAt <= timeLogData.startedAt) {\n          return res.status(400).json({ message: \"End time must be after start time\" });\n        }\n        const durationMs = timeLogData.endedAt.getTime() - timeLogData.startedAt.getTime();\n        timeLogData.durationMinutes = Math.round(durationMs / (1000 * 60));\n      }\n      \n      const validatedData = insertEventTimeLogSchema.parse(timeLogData);\n      const timeLog = await storage.createTimeLog(validatedData);\n      res.status(201).json(timeLog);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/events/:eventId/time-logs\", async (req, res) => {\n    try {\n      const timeLogs = await storage.getEventTimeLogs(req.params.eventId);\n      res.json(timeLogs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/time-logs\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { range } = req.query;\n      \n      let startDate: Date | undefined;\n      let endDate: Date | undefined;\n      \n      if (range === '7d') {\n        startDate = new Date();\n        startDate.setDate(startDate.getDate() - 7);\n        endDate = new Date();\n      } else if (range === '30d') {\n        startDate = new Date();\n        startDate.setDate(startDate.getDate() - 30);\n        endDate = new Date();\n      } else if (range === '90d') {\n        startDate = new Date();\n        startDate.setDate(startDate.getDate() - 90);\n        endDate = new Date();\n      }\n      \n      const timeLogs = await storage.getUserTimeLogs(userId, startDate, endDate);\n      res.json(timeLogs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/time-logs/:id\", async (req, res) => {\n    try {\n      // Convert date strings to Date objects\n      const updateData = {\n        ...req.body,\n        startedAt: req.body.startedAt ? new Date(req.body.startedAt) : undefined,\n        endedAt: req.body.endedAt ? new Date(req.body.endedAt) : undefined\n      };\n      \n      // Calculate duration if both dates are provided\n      if (updateData.startedAt && updateData.endedAt) {\n        if (updateData.endedAt <= updateData.startedAt) {\n          return res.status(400).json({ message: \"End time must be after start time\" });\n        }\n        const durationMs = updateData.endedAt.getTime() - updateData.startedAt.getTime();\n        updateData.durationMinutes = Math.round(durationMs / (1000 * 60));\n      }\n      \n      const validatedData = insertEventTimeLogSchema.omit({ userId: true, eventId: true }).partial().parse(updateData);\n      const timeLog = await storage.updateTimeLog(req.params.id, validatedData);\n      res.json(timeLog);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/time-logs/:id\", async (req, res) => {\n    try {\n      await storage.deleteTimeLog(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Time-Value Insights Routes\n  app.get(\"/api/insights/time-value\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const range = (req.query.range as '7d' | '30d' | '90d') || '30d';\n      const insights = await storage.getTimeValueInsights(userId, range);\n      res.json(insights);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/events/:eventId/time-value\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const timeValue = await storage.calculateEventTimeValue(req.params.eventId, userId);\n      res.json(timeValue);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Enhanced Dashboard Stats (including time-value data)\n  app.get(\"/api/dashboard/time-stats\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const range = (req.query.range as '7d' | '30d' | '90d') || '30d';\n      \n      // Get basic insights\n      const insights = await storage.getTimeValueInsights(userId, range);\n      \n      // Get user settings for context\n      const settings = await storage.getUserSettings(userId);\n      \n      // Calculate additional metrics\n      const averageHourlyValue = insights.totalTimeHours > 0 ? insights.timeValue / insights.totalTimeHours : 0;\n      const timeEfficiency = insights.timeValue > 0 ? ((insights.timeValue - insights.totalCost) / insights.timeValue) * 100 : 0;\n      \n      res.json({\n        ...insights,\n        hourlyRate: settings?.hourlyRate ? parseFloat(settings.hourlyRate.toString()) : 50,\n        currency: settings?.currency || 'USD',\n        averageHourlyValue,\n        timeEfficiencyPercent: Math.round(timeEfficiency),\n        range\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Notification routes\n  app.get(\"/api/notifications\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const limit = parseInt(req.query.limit as string) || 50;\n      const offset = parseInt(req.query.offset as string) || 0;\n      const includeRead = req.query.includeRead === 'true';\n      \n      const notifications = await storage.getNotificationsByUserId(userId, limit, offset, includeRead);\n      res.json(notifications);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/notifications/unread-count\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const count = await storage.getUnreadNotificationCount(userId);\n      res.json({ count });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/notifications\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const notificationData = {\n        ...req.body,\n        userId: userId,\n      };\n      \n      const validatedData = insertNotificationSchema.parse(notificationData);\n      const notification = await storage.createNotification(validatedData);\n      res.status(201).json(notification);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/notifications/generate\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const notifications = await storage.generateSmartNotifications(userId);\n      res.json({ \n        generated: notifications.length,\n        notifications: notifications.slice(0, 5) // Return first 5 for preview\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/notifications/:id/read\", async (req, res) => {\n    try {\n      const notification = await storage.markNotificationAsRead(req.params.id);\n      res.json(notification);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/notifications/mark-all-read\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      await storage.markAllNotificationsAsRead(userId);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.put(\"/api/notifications/:id/archive\", async (req, res) => {\n    try {\n      const notification = await storage.archiveNotification(req.params.id);\n      res.json(notification);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/notifications/:id\", async (req, res) => {\n    try {\n      await storage.deleteNotification(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Chat API routes\n  app.get(\"/api/chat/conversations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const conversations = await storage.getChatConversations(userId);\n      res.json(conversations);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/chat/conversations/:id\", async (req, res) => {\n    try {\n      const conversation = await storage.getChatConversationWithMessages(req.params.id);\n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      res.json(conversation);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/chat/conversations/:id/messages\", async (req, res) => {\n    try {\n      const conversation = await storage.getChatConversationWithMessages(req.params.id);\n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      res.json(conversation.messages || []);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/chat/conversations\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertChatConversationSchema.parse({\n        ...req.body,\n        userId: userId\n      });\n      const conversation = await storage.createChatConversation(validatedData);\n      res.status(201).json(conversation);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.patch(\"/api/chat/conversations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const conversationId = req.params.id;\n      \n      // Verify ownership\n      const conversation = await storage.getChatConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      // Update title\n      const { title } = req.body;\n      if (title && typeof title === 'string') {\n        await storage.updateChatConversation(conversationId, { title });\n        const updated = await storage.getChatConversation(conversationId);\n        res.json(updated);\n      } else {\n        res.status(400).json({ message: \"Invalid title\" });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/chat/conversations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const conversationId = req.params.id;\n      \n      // Verify ownership\n      const conversation = await storage.getChatConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      await storage.deleteChatConversation(conversationId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/chat/conversations/:id/messages\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const conversationId = req.params.id;\n      \n      // Ensure user has a subscription\n      let subscription = await storage.getUserSubscription(userId);\n      if (!subscription) {\n        await storage.initializeDefaultSubscription(userId);\n        subscription = await storage.getUserSubscription(userId);\n      }\n      \n      // Map plan name to tier for cache isolation\n      const tierFromPlan = (planName: string | undefined): 'free' | 'pro' | 'enterprise' => {\n        if (!planName) return 'free';\n        const lower = planName.toLowerCase();\n        if (lower.includes('enterprise')) return 'enterprise';\n        if (lower.includes('pro')) return 'pro';\n        return 'free';\n      };\n      const subscriptionTier = tierFromPlan(subscription?.plan?.name);\n      \n      // Validate conversation exists and belongs to user\n      const conversation = await storage.getChatConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      const userMessage = req.body.content;\n      \n      if (!userMessage || typeof userMessage !== 'string') {\n        return res.status(400).json({ message: \"Message content is required\" });\n      }\n\n      // Save user message\n      const userChatMessage = await storage.createChatMessage({\n        conversationId,\n        role: 'user',\n        content: userMessage,\n        userContext: null,\n        tokenCount: Math.ceil(userMessage.length / 4), // Rough token estimate\n        cost: '0.0000'\n      });\n\n      // Proactively parse and save financial data from user message\n      // This ensures we capture data even if AI fails later\n      const messageLower = typeof userMessage === 'string' ? userMessage.toLowerCase() : '';\n      const estimates: any = {};\n      \n      // Extract income-related numbers\n      const incomeMatch = messageLower.match(/(?:earn|make|income|salary).*?(\\$?\\d{1,3}(?:,\\d{3})*(?:\\.\\d{2})?)/i);\n      if (incomeMatch) {\n        const amount = parseFloat(incomeMatch[1].replace(/[$,]/g, ''));\n        if (amount > 0 && amount < 1000000) { // Sanity check\n          estimates.monthlyIncomeEstimate = amount.toString();\n        }\n      }\n      \n      // Extract expense-related numbers\n      const expenseMatch = messageLower.match(/(?:spend|expense|cost).*?(\\$?\\d{1,3}(?:,\\d{3})*(?:\\.\\d{2})?)/i);\n      if (expenseMatch) {\n        const amount = parseFloat(expenseMatch[1].replace(/[$,]/g, ''));\n        if (amount > 0 && amount < 1000000) {\n          estimates.monthlyExpensesEstimate = amount.toString();\n        }\n      }\n      \n      // Extract savings-related numbers  \n      const savingsMatch = messageLower.match(/(?:have|saved|savings|save).*?(\\$?\\d{1,3}(?:,\\d{3})*(?:\\.\\d{2})?)/i);\n      if (savingsMatch) {\n        const amount = parseFloat(savingsMatch[1].replace(/[$,]/g, ''));\n        if (amount > 0 && amount < 10000000) { // Higher limit for total savings\n          estimates.currentSavingsEstimate = amount.toString();\n        }\n      }\n      \n      // Save estimates if we found any\n      if (Object.keys(estimates).length > 0) {\n        await storage.updateUserPreferences(userId, estimates);\n        debugLog('AI', 'Proactively saved financial estimates', estimates);\n      }\n\n      // Build user context for AI\n      const [stats, goals, recentTransactions, upcomingEvents, userPreferences, financialProfile, expenseCategories, userDebts, userAssets] = await Promise.all([\n        storage.getUserStats(userId),\n        storage.getFinancialGoalsByUserId(userId),\n        storage.getTransactionsByUserId(userId, 10),\n        storage.getUpcomingEvents(userId, 5),\n        storage.getUserPreferences(userId),\n        storage.getUserFinancialProfile(userId),\n        storage.getUserExpenseCategories(userId),\n        storage.getUserDebts(userId),\n        storage.getUserAssets(userId)\n      ]);\n\n      // Calculate monthly expenses from transactions or use estimate\n      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n      const recentExpenses = recentTransactions\n        .filter(t => t.type === 'expense' && t.date >= thirtyDaysAgo)\n        .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n      \n      const monthlyExpenses = recentExpenses > 0 \n        ? recentExpenses \n        : parseFloat(userPreferences?.monthlyExpensesEstimate?.toString() || \"0\");\n\n      const userContext: UserContext = {\n        userId, // For cache isolation\n        subscriptionTier, // For tier-aware caching and responses\n        totalSavings: stats.totalSavings,\n        monthlyIncome: stats.monthlyIncome,\n        monthlyExpenses,\n        activeGoals: stats.activeGoals,\n        language: userPreferences?.language || 'en', // User's preferred language for AI responses\n        cryptoEnabled: userPreferences?.cryptoEnabled || false, // Whether user has enabled crypto features\n        experienceLevel: (userPreferences?.experienceLevel as 'beginner' | 'intermediate' | 'advanced') || 'beginner', // User's financial experience level\n        recentTransactions: recentTransactions.slice(0, 5).map(t => ({\n          amount: parseFloat(t.amount),\n          category: t.category,\n          description: t.description || '',\n          date: t.date.toISOString()\n        })),\n        upcomingEvents: upcomingEvents.map(e => ({\n          title: e.title,\n          date: e.startTime.toISOString(),\n          estimatedValue: parseFloat(e.budget || '0')\n        })),\n        financialProfile: financialProfile ? {\n          monthlyIncome: parseFloat(financialProfile.monthlyIncome || '0'),\n          monthlyExpenses: parseFloat(financialProfile.monthlyExpenses || '0'),\n          monthlySavings: parseFloat(financialProfile.monthlySavings || '0'),\n          totalSavings: parseFloat(financialProfile.totalSavings || '0'),\n          savingsGoal: parseFloat(financialProfile.savingsGoal || '0'),\n          emergencyFund: parseFloat(financialProfile.emergencyFund || '0')\n        } : undefined,\n        expenseCategories: expenseCategories.map(cat => ({\n          category: cat.category,\n          monthlyBudget: parseFloat(cat.monthlyAmount)\n        })),\n        debts: userDebts.map(debt => ({\n          name: debt.name,\n          balance: parseFloat(debt.balance),\n          originalAmount: debt.originalAmount ? parseFloat(debt.originalAmount) : undefined,\n          remainingAmount: parseFloat(debt.balance), // Alias for backward compatibility\n          totalAmount: debt.originalAmount ? parseFloat(debt.originalAmount) : parseFloat(debt.balance), // Use original if available, else current balance\n          monthlyPayment: parseFloat(debt.monthlyPayment),\n          interestRate: parseFloat(debt.interestRate || '0'),\n          minimumPayment: parseFloat(debt.minimumPayment || '0')\n        })),\n        assets: userAssets.map(asset => ({\n          name: asset.name,\n          type: asset.type,\n          value: parseFloat(asset.value),\n          currentValue: parseFloat(asset.value), // Alias for backward compatibility\n          purchasePrice: asset.purchasePrice ? parseFloat(asset.purchasePrice) : undefined\n        }))\n      };\n\n      // Get conversation history with smart summarization\n      const messages = await storage.getChatMessages(conversationId, 20); // Fetch more messages\n      const allMessages = messages.reverse().map(m => ({\n        role: m.role as 'user' | 'assistant',\n        content: m.content,\n        timestamp: m.createdAt || new Date()\n      }));\n      \n      // Summarize older messages (beyond the last 6) to maintain context without token bloat\n      const recentMessages = allMessages.slice(-6);\n      const olderMessages = allMessages.slice(0, -6);\n      const conversationSummary = olderMessages.length > 0 \n        ? summarizeConversationHistory(olderMessages)\n        : '';\n      \n      // Inject conversation summary as context at the start of the history\n      // This ensures the AI knows what was discussed earlier in long conversations\n      const conversationHistory: Array<{ role: 'user' | 'assistant'; content: string }> = [];\n      \n      if (conversationSummary && conversationSummary.trim()) {\n        // Add summary as an assistant message that provides full context from older messages\n        conversationHistory.push({\n          role: 'assistant',\n          content: conversationSummary.trim()\n        });\n      }\n      \n      // Add recent messages in full detail\n      conversationHistory.push(...recentMessages.map(m => ({\n        role: m.role,\n        content: m.content\n      })));\n\n      // Usage tracking now handled by tier-aware router\n\n      // CODE-LEVEL IMPOSSIBILITY CHECK (Pre-AI Validation)\n      // Detect if user is discussing a purchase/goal and calculate feasibility BEFORE AI sees it\n      let impossibleGoalFlag: string | null = null;\n      \n      const msgLower = typeof userMessage === 'string' ? userMessage.toLowerCase() : '';\n      const purchaseKeywords = ['buy', 'purchase', 'get', 'want', 'need', 'lambo', 'lamborghini', 'ferrari', 'house', 'car', 'yacht', 'ซื้อ', 'อยาก', 'comprar', 'quiero', '买', '想'];\n      const timeKeywords = ['year', 'years', 'month', 'months', 'ปี', 'เดือน', 'años', 'meses', '年', '月'];\n      \n      const hasPurchaseIntent = purchaseKeywords.some(kw => msgLower.includes(kw));\n      const hasTimeframe = timeKeywords.some(kw => msgLower.includes(kw));\n      \n      debugLog('AI', 'Impossibility check', { hasPurchaseIntent, hasTimeframe });\n      \n      if (hasPurchaseIntent && hasTimeframe) {\n        debugLog('AI', 'Both conditions met, proceeding with feasibility check');\n        // Extract potential price (look for common luxury items or dollar amounts)\n        const pricePatterns = [\n          /\\$(\\d{1,3}(?:,\\d{3})*(?:\\.\\d{2})?)/g, // $573,966 or $1,000,000\n          /(\\d{1,3}(?:,\\d{3})+)/g, // 573966 or 1000000\n        ];\n        \n        // Extract timeframe in years\n        const yearMatch = msgLower.match(/(\\d+)\\s*(?:year|years|ปี|años|年)/);\n        const monthMatch = msgLower.match(/(\\d+)\\s*(?:month|months|เดือน|meses|月)/);\n        \n        let yearsExtracted = 0;\n        if (yearMatch) yearsExtracted = parseInt(yearMatch[1]);\n        else if (monthMatch) yearsExtracted = parseInt(monthMatch[1]) / 12;\n        \n        // Known luxury items with prices\n        const luxuryItems: Record<string, number> = {\n          'lambo': 573966, 'lamborghini': 573966,\n          'ferrari': 400000, 'mclaren': 350000,\n          'rolls royce': 450000, 'bentley': 300000,\n          'private jet': 5000000, 'jet': 5000000,\n          'yacht': 2000000, 'superyacht': 10000000,\n          'mansion': 2000000, 'villa': 1500000\n        };\n        \n        let goalAmount = 0;\n        \n        // Check for luxury items first\n        for (const [item, price] of Object.entries(luxuryItems)) {\n          if (msgLower.includes(item)) {\n            goalAmount = price;\n            break;\n          }\n        }\n        \n        // If no luxury item, try to extract price from message\n        if (goalAmount === 0) {\n          for (const pattern of pricePatterns) {\n            const matches = Array.from(userMessage.matchAll(pattern));\n            if (matches.length > 0) {\n              const amount = parseFloat(matches[0][1].replace(/,/g, ''));\n              if (amount > 10000) { // Reasonable goal amount\n                goalAmount = amount;\n                break;\n              }\n            }\n          }\n        }\n        \n        // If we found both goal amount and timeframe, check feasibility\n        debugLog('AI', `Extracted goal data`, { goalAmount, yearsExtracted });\n        \n        if (goalAmount > 0 && yearsExtracted > 0 && yearsExtracted <= 30) {\n          debugLog('AI', 'Running feasibility check', { income: userContext.monthlyIncome, expenses: userContext.monthlyExpenses });\n          \n          const { checkGoalFeasibility } = await import('./financialCalculations');\n          const feasibility = checkGoalFeasibility(\n            goalAmount,\n            yearsExtracted,\n            userContext.monthlyIncome,\n            userContext.monthlyExpenses,\n            userContext.totalSavings\n          );\n          \n          debugLog('AI', 'Feasibility result', { isFeasible: feasibility.isFeasible, monthlyNeeded: feasibility.monthlyNeeded, capacity: feasibility.monthlyCapacity });\n          \n          if (!feasibility.isFeasible) {\n            debugLog('AI', 'Impossible goal detected', { goalAmount, years: yearsExtracted, reason: feasibility.reason });\n            \n            impossibleGoalFlag = `\nCRITICAL: IMPOSSIBLE GOAL DETECTED\n\nBACKEND PRE-VALIDATION RESULTS:\n• Goal: $${goalAmount.toLocaleString()} in ${yearsExtracted} years\n• Required: $${Math.round(feasibility.monthlyNeeded).toLocaleString()}/month\n• User Capacity: $${Math.round(feasibility.monthlyCapacity).toLocaleString()}/month\n• Shortfall: $${Math.round(feasibility.shortfall).toLocaleString()}/month (${feasibility.multiplier.toFixed(1)}x OVER CAPACITY!)\n• Realistic Timeline: ${feasibility.realisticYears} years with compound interest\n\nMANDATORY RESPONSE PROTOCOL:\n1. DO NOT show the impossible monthly amount ($${Math.round(feasibility.monthlyNeeded).toLocaleString()}/month) as a suggestion\n2. IMMEDIATELY use empathetic coaching framework\n3. Show 3 investment plans with realistic ${feasibility.realisticYears}-year timeline\n4. Suggest stepping stones (cheaper alternatives to reach sooner)\n5. Respond in user's detected language\n\nThis is CODE-LEVEL validation - you MUST follow this directive!`;\n          }\n        }\n      }\n\n      try {\n        // Get memory context from previous conversations\n        const memoryContext = await getMemoryContext(storage, userId);\n        \n        // Enhance userContext with impossibility flag and memory\n        // Note: conversationSummary is now injected into conversationHistory directly\n        const enhancedContext = {\n          ...userContext,\n          ...(impossibleGoalFlag && { impossibleGoalWarning: impossibleGoalFlag }),\n          ...(memoryContext && { memoryContext })\n        };\n        \n        // Use tier-aware AI router for intelligent model selection and quota enforcement\n        // Pass conversation history for context (last 6 messages + older summary)\n        const tierResult = await routeWithTierCheck(userId, userMessage, storage, conversationHistory);\n        \n        // Handle quota exceeded response\n        if ('type' in tierResult && tierResult.type === 'quota_exceeded') {\n          const quotaError = tierResult as QuotaExceededError;\n          return res.status(429).json({\n            message: `AI ${quotaError.model} quota exceeded. You've used ${quotaError.used}/${quotaError.limit} queries.`,\n            usage: quotaError.used,\n            limit: quotaError.limit,\n            upgradeRequired: quotaError.upgradeRequired,\n            type: quotaError.type,\n            model: quotaError.model,\n            nextTier: quotaError.nextTier\n          });\n        }\n        \n        // Extract AI result from successful response\n        const aiResult = tierResult as HybridAIResponse;\n        \n        // Type guard: Ensure aiResult is valid HybridAIResponse\n        if (!aiResult || typeof aiResult !== 'object' || !('answer' in aiResult)) {\n          throw new Error('Invalid AI response: result is null or not an object');\n        }\n        \n        // HALLUCINATION CHECK: Warn if AI claims action but no tools called\n        const lowerResponse = typeof aiResult.answer === 'string' ? aiResult.answer.toLowerCase() : '';\n        const claimsAction = lowerResponse.includes('goal created') || lowerResponse.includes('added to your goals') || \n                             lowerResponse.includes('i\\'ve created') || lowerResponse.includes('i\\'ve added') ||\n                             lowerResponse.includes('i added') || lowerResponse.includes('i created');\n        if (claimsAction && (!aiResult.toolCalls || aiResult.toolCalls.length === 0)) {\n          console.warn('WARNING: AI claims to have performed action but NO TOOL CALLS made!');\n          console.warn('   Response:', typeof aiResult.answer === 'string' ? aiResult.answer.substring(0, 200) : 'N/A');\n        }\n        \n        // Handle tool calls if AI wants to take actions\n        const actionsPerformed: any[] = [];\n        if (aiResult.toolCalls && aiResult.toolCalls.length > 0) {\n          debugLog('AI', `Processing ${aiResult.toolCalls.length} tool calls`, { tools: aiResult.toolCalls.map((t: any) => t.function.name) });\n          for (const toolCall of aiResult.toolCalls) {\n            // Extract function details from nested structure\n            const toolName = toolCall.function.name;\n            const toolArgs = toolCall.function.arguments;\n            \n            try {\n              \n              debugLog('AI', `Executing tool: ${toolName}`, toolArgs);\n              \n              if (toolName === 'create_financial_goal') {\n                debugLog('AI', 'Starting goal creation');\n                \n                // Coerce string boolean to actual boolean (fixes LLM returning \"true\" instead of true)\n                const userConfirmed = toolArgs.userConfirmed === true || toolArgs.userConfirmed === \"true\" || toolArgs.userConfirmed === \"True\";\n                \n                // Allow goal creation when user gives clear imperative command (AI should only call this when appropriate)\n                if (!userConfirmed && !toolArgs.name && !toolArgs.targetAmount) {\n                  debugLog('AI', 'Blocked create_financial_goal: missing required data');\n                  actionsPerformed.push({\n                    type: 'action_blocked',\n                    data: { reason: 'Missing required goal details', action: 'create_financial_goal' }\n                  });\n                  continue;\n                }\n                \n                debugLog('AI', 'Creating goal', { userId, name: toolArgs.name });\n                const goal = await storage.createFinancialGoal({\n                  userId: userId,\n                  title: toolArgs.name,\n                  targetAmount: parseAmount(toolArgs.targetAmount),\n                  currentAmount: '0',\n                  targetDate: new Date(toolArgs.targetDate),\n                  description: toolArgs.description || null,\n                  category: 'savings'\n                });\n                debugLog('AI', 'Goal created successfully', { id: goal.id, title: goal.title });\n                actionsPerformed.push({\n                  type: 'goal_created',\n                  data: goal\n                });\n              } else if (toolName === 'create_calendar_event') {\n                // Coerce string boolean to actual boolean\n                const userConfirmed = toolArgs.userConfirmed === true || toolArgs.userConfirmed === \"true\" || toolArgs.userConfirmed === \"True\";\n                \n                // Allow event creation when user gives clear imperative command\n                if (!userConfirmed && !toolArgs.title && !toolArgs.date) {\n                  debugLog('AI', 'Blocked create_calendar_event: missing required data');\n                  actionsPerformed.push({\n                    type: 'action_blocked',\n                    data: { reason: 'Missing required event details', action: 'create_calendar_event' }\n                  });\n                  continue;\n                }\n                const event = await storage.createEvent({\n                  createdBy: userId,\n                  title: toolArgs.title,\n                  description: toolArgs.description || null,\n                  startTime: new Date(toolArgs.date),\n                  endTime: new Date(toolArgs.date)\n                });\n                actionsPerformed.push({\n                  type: 'event_created',\n                  data: event\n                });\n              } else if (toolName === 'add_transaction') {\n                debugLog('AI', 'Creating transaction');\n                const transaction = await storage.createTransaction({\n                  userId: userId,\n                  type: toolArgs.type,\n                  amount: parseAmount(toolArgs.amount),\n                  category: toolArgs.category,\n                  description: toolArgs.description || null,\n                  date: toolArgs.date ? new Date(toolArgs.date) : new Date()\n                });\n                debugLog('AI', 'Transaction created', { id: transaction.id, amount: transaction.amount, category: transaction.category });\n                \n                // Calculate budget impact for proactive insights\n                const txnAmount = parseFloat(transaction.amount);\n                let budgetImpact: any = null;\n                \n                if (toolArgs.type === 'expense') {\n                  try {\n                    // Get this month's spending in the same category\n                    const now = new Date();\n                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n                    const allTransactions = await storage.getTransactionsByUserId(userId, 100);\n                    const categorySpending = allTransactions\n                      .filter(t => t.type === 'expense' && t.category === toolArgs.category && t.date >= monthStart)\n                      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n                    \n                    // Get budget info if available - validate it's a real number > 0\n                    const expenseCategories = await storage.getUserExpenseCategories(userId);\n                    const categoryBudget = expenseCategories.find(c => c.category.toLowerCase() === toolArgs.category.toLowerCase());\n                    const parsedBudget = categoryBudget ? parseFloat(categoryBudget.monthlyAmount) : NaN;\n                    const monthlyBudget = !isNaN(parsedBudget) && parsedBudget > 0 ? parsedBudget : null;\n                    \n                    // Get total monthly income for context - validate it's a real number > 0\n                    const profile = await storage.getUserFinancialProfile(userId);\n                    const parsedIncome = profile ? parseFloat(profile.monthlyIncome || '') : NaN;\n                    const monthlyIncome = !isNaN(parsedIncome) && parsedIncome > 0 ? parsedIncome : null;\n                    \n                    budgetImpact = {\n                      categorySpendingThisMonth: categorySpending,\n                      monthlyBudget,\n                      hasBudgetSet: monthlyBudget !== null,\n                      percentOfBudget: monthlyBudget !== null \n                        ? Math.round((categorySpending / monthlyBudget) * 100) \n                        : null,\n                      percentOfIncome: monthlyIncome !== null \n                        ? Math.round((categorySpending / monthlyIncome) * 100) \n                        : null,\n                      isOverBudget: monthlyBudget !== null \n                        ? categorySpending > monthlyBudget \n                        : null,\n                      remainingBudget: monthlyBudget !== null \n                        ? Math.max(0, monthlyBudget - categorySpending) \n                        : null\n                    };\n                  } catch (err) {\n                    debugLog('AI', 'Budget impact calculation failed', err);\n                    // Don't let budget calculation errors break transaction creation\n                  }\n                }\n                \n                actionsPerformed.push({\n                  type: 'transaction_added',\n                  data: transaction,\n                  budgetImpact\n                });\n              } else if (toolName === 'create_group') {\n                // Coerce string boolean to actual boolean\n                const userConfirmed = toolArgs.userConfirmed === true || toolArgs.userConfirmed === \"true\" || toolArgs.userConfirmed === \"True\";\n                \n                // Groups require explicit confirmation (more sensitive action)\n                if (!userConfirmed) {\n                  debugLog('AI', 'Blocked create_group: userConfirmed not true');\n                  actionsPerformed.push({\n                    type: 'action_blocked',\n                    data: { reason: 'User confirmation required', action: 'create_group' }\n                  });\n                  continue;\n                }\n                const group = await storage.createGroup({\n                  name: toolArgs.name,\n                  description: toolArgs.description || null,\n                  ownerId: userId\n                });\n                actionsPerformed.push({\n                  type: 'group_created',\n                  data: group\n                });\n              } else if (toolName === 'add_crypto_holding') {\n                // Map common crypto symbols to their full names\n                const cryptoNames: Record<string, string> = {\n                  'BTC': 'Bitcoin',\n                  'ETH': 'Ethereum',\n                  'BNB': 'Binance Coin',\n                  'USDT': 'Tether',\n                  'SOL': 'Solana',\n                  'ADA': 'Cardano',\n                  'DOT': 'Polkadot'\n                };\n                const symbol = toolArgs.symbol.toUpperCase();\n                const coinId = toolArgs.symbol.toLowerCase();\n                const name = cryptoNames[symbol] || symbol;\n                \n                const holding = await storage.createCryptoHolding({\n                  userId: userId,\n                  coinId: coinId,\n                  symbol: symbol,\n                  name: name,\n                  amount: parseAmount(toolArgs.amount),\n                  averageBuyPrice: parseAmount(toolArgs.purchasePrice)\n                });\n                actionsPerformed.push({\n                  type: 'crypto_added',\n                  data: holding\n                });\n              } else if (toolName === 'analyze_portfolio_allocation') {\n                // Calculate portfolio allocation based on age and risk tolerance\n                const { age, riskTolerance, investmentAmount } = toolArgs;\n                const stockAllocation = Math.max(10, Math.min(90, 110 - age));\n                const bondAllocation = 100 - stockAllocation;\n                \n                // Adjust for risk tolerance\n                let adjustedStocks = stockAllocation;\n                if (riskTolerance === 'aggressive') adjustedStocks = Math.min(90, stockAllocation + 15);\n                if (riskTolerance === 'conservative') adjustedStocks = Math.max(10, stockAllocation - 15);\n                const adjustedBonds = Math.max(5, 100 - adjustedStocks - 5); // 5% alternatives\n                \n                const stockAmount = (investmentAmount * adjustedStocks / 100);\n                const bondAmount = (investmentAmount * adjustedBonds / 100);\n                const altAmount = investmentAmount - stockAmount - bondAmount;\n                \n                actionsPerformed.push({\n                  type: 'portfolio_analyzed',\n                  data: {\n                    age,\n                    riskTolerance,\n                    investmentAmount,\n                    allocation: {\n                      stocks: { percentage: adjustedStocks, amount: stockAmount },\n                      bonds: { percentage: adjustedBonds, amount: bondAmount },\n                      alternatives: { percentage: Math.round((altAmount / investmentAmount) * 100), amount: altAmount }\n                    }\n                  }\n                });\n              } else if (toolName === 'calculate_debt_payoff') {\n                // Compare avalanche vs snowball debt payoff strategies\n                const { debts, extraPayment } = toolArgs;\n                \n                // Simple debt payoff calculator\n                const calculatePayoff = (debtOrder: any[]) => {\n                  let totalMonths = 0;\n                  let totalInterest = 0;\n                  let remainingDebts = debtOrder.map(d => ({ ...d }));\n                  \n                  while (remainingDebts.length > 0) {\n                    totalMonths++;\n                    // Pay minimum on all debts\n                    remainingDebts.forEach(d => {\n                      const monthlyInterest = (d.balance * d.interestRate / 100) / 12;\n                      totalInterest += monthlyInterest;\n                      d.balance += monthlyInterest - d.minPayment;\n                    });\n                    \n                    // Apply extra payment to first debt\n                    if (remainingDebts.length > 0) {\n                      remainingDebts[0].balance -= extraPayment;\n                    }\n                    \n                    // Remove paid off debts\n                    remainingDebts = remainingDebts.filter(d => d.balance > 0);\n                    \n                    if (totalMonths > 600) break; // Safety limit\n                  }\n                  \n                  return { months: totalMonths, interest: Math.round(totalInterest) };\n                };\n                \n                // Avalanche: Sort by interest rate (highest first)\n                const avalancheOrder = [...debts].sort((a, b) => b.interestRate - a.interestRate);\n                const avalancheResult = calculatePayoff(avalancheOrder);\n                \n                // Snowball: Sort by balance (lowest first)\n                const snowballOrder = [...debts].sort((a, b) => a.balance - b.balance);\n                const snowballResult = calculatePayoff(snowballOrder);\n                \n                actionsPerformed.push({\n                  type: 'debt_analyzed',\n                  data: {\n                    avalanche: {\n                      order: avalancheOrder.map(d => d.name),\n                      monthsToPay: avalancheResult.months,\n                      totalInterest: avalancheResult.interest\n                    },\n                    snowball: {\n                      order: snowballOrder.map(d => d.name),\n                      monthsToPay: snowballResult.months,\n                      totalInterest: snowballResult.interest\n                    },\n                    savings: snowballResult.interest - avalancheResult.interest\n                  }\n                });\n              } else if (toolName === 'project_future_value') {\n                // Calculate future value with compound growth and inflation adjustment\n                const { principal, monthlyContribution, annualReturn, years, inflationRate } = toolArgs;\n                const months = years * 12;\n                const monthlyRate = annualReturn / 100 / 12;\n                \n                // Future value formula: FV = PV(1+r)^n + PMT * [((1+r)^n - 1) / r]\n                const principalGrowth = principal * Math.pow(1 + monthlyRate, months);\n                const contributionGrowth = monthlyContribution * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);\n                const futureValue = principalGrowth + contributionGrowth;\n                \n                // Inflation-adjusted value\n                const inflation = (inflationRate || 3) / 100;\n                const realValue = futureValue / Math.pow(1 + inflation, years);\n                \n                const totalInvested = principal + (monthlyContribution * months);\n                const totalGrowth = futureValue - totalInvested;\n                \n                actionsPerformed.push({\n                  type: 'future_value_calculated',\n                  data: {\n                    futureValue: Math.round(futureValue),\n                    realValue: Math.round(realValue),\n                    totalInvested: Math.round(totalInvested),\n                    totalGrowth: Math.round(totalGrowth),\n                    returnPercentage: Math.round((totalGrowth / totalInvested) * 100)\n                  }\n                });\n              } else if (toolName === 'calculate_retirement_needs') {\n                // Calculate retirement needs using 4% rule\n                const { currentAge, retirementAge, annualExpenses, currentSavings } = toolArgs;\n                const yearsToRetirement = retirementAge - currentAge;\n                const targetAmount = annualExpenses * 25; // 4% rule\n                const needed = targetAmount - currentSavings;\n                \n                // Calculate required monthly savings (assuming 8% annual return)\n                const monthlyRate = 0.08 / 12;\n                const months = yearsToRetirement * 12;\n                const futureValueOfCurrent = currentSavings * Math.pow(1 + monthlyRate, months);\n                const stillNeeded = targetAmount - futureValueOfCurrent;\n                \n                // PMT formula: PMT = FV * r / ((1+r)^n - 1)\n                const requiredMonthly = stillNeeded > 0 \n                  ? stillNeeded * monthlyRate / (Math.pow(1 + monthlyRate, months) - 1)\n                  : 0;\n                \n                actionsPerformed.push({\n                  type: 'retirement_calculated',\n                  data: {\n                    targetAmount: Math.round(targetAmount),\n                    currentSavings: currentSavings,\n                    yearsToRetirement,\n                    requiredMonthly: Math.round(requiredMonthly),\n                    onTrack: requiredMonthly <= (annualExpenses / 12) * 0.15 // 15% of monthly expenses\n                  }\n                });\n              } else if (toolName === 'calculate_emergency_fund') {\n                // Calculate ideal emergency fund size\n                const { monthlyExpenses, incomeStability, dependents = 0, hasInsurance = true } = toolArgs;\n                \n                // Base recommendation: 3-6 months\n                let months = 4; // Default middle ground\n                \n                // Adjust based on income stability\n                if (incomeStability === 'very_stable') months = 3;\n                else if (incomeStability === 'stable') months = 4;\n                else if (incomeStability === 'variable') months = 6;\n                else if (incomeStability === 'unstable') months = 9;\n                \n                // Add 1 month per dependent\n                months += dependents;\n                \n                // Add 1 month if no insurance\n                if (!hasInsurance) months += 1;\n                \n                // Cap at reasonable limits\n                months = Math.max(3, Math.min(12, months));\n                \n                const targetAmount = monthlyExpenses * months;\n                const minAmount = monthlyExpenses * 3;\n                const maxAmount = monthlyExpenses * 6;\n                \n                actionsPerformed.push({\n                  type: 'emergency_fund_calculated',\n                  data: {\n                    monthlyExpenses,\n                    recommendedMonths: months,\n                    targetAmount,\n                    minAmount,\n                    maxAmount,\n                    incomeStability,\n                    dependents,\n                    hasInsurance\n                  }\n                });\n              } else if (toolName === 'credit_score_improvement_plan') {\n                // Generate personalized credit improvement strategies\n                const { currentScore, hasDebt = false, missedPayments = false, creditUtilization } = toolArgs;\n                \n                const strategies: string[] = [];\n                let priorityAction = '';\n                \n                // Payment history (35% of score)\n                if (missedPayments) {\n                  priorityAction = 'Payment History (35% impact)';\n                  strategies.push('Set up autopay for ALL bills immediately - payment history is 35% of your score');\n                  strategies.push('Pay at least minimum payments on time, every time - even $10 late payment hurts for 7 years');\n                } else {\n                  strategies.push('Keep perfect payment history - your track record is strong! Set autopay as backup');\n                }\n                \n                // Credit utilization (30% of score)\n                if (creditUtilization && creditUtilization > 30) {\n                  if (!priorityAction) priorityAction = 'Credit Utilization (30% impact)';\n                  strategies.push(`CRITICAL: Reduce utilization from ${creditUtilization}% to under 30% (ideally under 10%)`);\n                  strategies.push('Pay down balances BEFORE statement closes for instant score boost');\n                  strategies.push('Request credit limit increase to lower utilization percentage (don\\'t spend more!)');\n                } else if (creditUtilization && creditUtilization <= 10) {\n                  strategies.push('Excellent utilization at ${creditUtilization}% - maintain this level for maximum score');\n                } else {\n                  strategies.push('Aim for under 10% credit utilization on all cards for best score');\n                }\n                \n                // Length of credit history (15%)\n                strategies.push('Keep oldest credit accounts open forever - age of credit is 15% of score');\n                strategies.push('Don\\'t close old cards even if unused - put small recurring charge + autopay');\n                \n                // Credit mix (10%)\n                if (!hasDebt) {\n                  strategies.push('Consider diverse credit mix: credit card + installment loan (car, personal) = 10% boost');\n                } else {\n                  strategies.push('Good credit mix with existing debt - pay it down while maintaining variety');\n                }\n                \n                // New credit (10%)\n                strategies.push('Limit hard inquiries - only apply when necessary (under 2 per year ideal)');\n                strategies.push('Space out applications 6+ months apart to avoid looking desperate');\n                \n                // Score-specific advice\n                let scoreAdvice = '';\n                if (currentScore && currentScore < 580) {\n                  scoreAdvice = 'Poor credit (under 580): Focus on payment history + utilization for 6-12 months = 100+ point boost possible';\n                } else if (currentScore && currentScore < 670) {\n                  scoreAdvice = 'Fair credit (580-669): You\\'re 1 year of perfect payments away from Good credit (670+)';\n                } else if (currentScore && currentScore < 740) {\n                  scoreAdvice = 'Good credit (670-739): Focus on sub-10% utilization + time to reach Very Good (740+)';\n                } else if (currentScore && currentScore < 800) {\n                  scoreAdvice = 'Very Good credit (740-799): Maintain current habits for Exceptional (800+) in 1-2 years';\n                } else if (currentScore && currentScore >= 800) {\n                  scoreAdvice = 'Exceptional credit (800+): You\\'re in top 20%! Maintain perfect habits for best rates';\n                } else {\n                  scoreAdvice = 'Follow these strategies for 6-12 months to see 50-100 point improvement';\n                }\n                \n                actionsPerformed.push({\n                  type: 'credit_improvement_analyzed',\n                  data: {\n                    currentScore,\n                    priorityAction: priorityAction || 'Maintain Current Habits',\n                    strategies,\n                    scoreAdvice,\n                    timelineMonths: missedPayments ? 12 : 6\n                  }\n                });\n              } else if (toolName === 'calculate_rent_affordability') {\n                // Calculate rent affordability using 30% rule\n                const { monthlyIncome, otherDebts = 0, desiredLocation } = toolArgs;\n                \n                // 30% rule: rent should be max 30% of gross income\n                const thirtyPercentRule = monthlyIncome * 0.30;\n                \n                // Adjusted for debt: 30% of (income - debt)\n                const adjustedIncome = monthlyIncome - otherDebts;\n                const adjustedMax = adjustedIncome * 0.30;\n                \n                // 50/30/20 rule: rent is part of 50% needs\n                const fiftyThirtyTwentyMax = monthlyIncome * 0.50;\n                \n                // Conservative recommendation (lower of two methods)\n                const recommendedMax = Math.min(thirtyPercentRule, adjustedMax);\n                const comfortableRange = {\n                  min: recommendedMax * 0.75,\n                  max: recommendedMax\n                };\n                \n                // Calculate remaining budget after rent\n                const afterRent = monthlyIncome - recommendedMax - otherDebts;\n                const monthlySavings = monthlyIncome * 0.20;\n                const discretionary = monthlyIncome * 0.30;\n                const remainingForNeeds = fiftyThirtyTwentyMax - recommendedMax - otherDebts;\n                \n                actionsPerformed.push({\n                  type: 'rent_affordability_calculated',\n                  data: {\n                    monthlyIncome,\n                    otherDebts,\n                    recommendedMax: Math.round(recommendedMax),\n                    comfortableRange: {\n                      min: Math.round(comfortableRange.min),\n                      max: Math.round(comfortableRange.max)\n                    },\n                    budgetBreakdown: {\n                      rent: Math.round(recommendedMax),\n                      otherNeeds: Math.round(remainingForNeeds),\n                      discretionary: Math.round(discretionary),\n                      savings: Math.round(monthlySavings)\n                    },\n                    desiredLocation,\n                    percentageOfIncome: Math.round((recommendedMax / monthlyIncome) * 100)\n                  }\n                });\n              } else if (toolName === 'calculate_mortgage_payment') {\n                // Calculate mortgage payment with PITI breakdown\n                const { \n                  homePrice, \n                  downPayment, \n                  interestRate, \n                  loanTermYears,\n                  propertyTaxRate = 1.2,\n                  insuranceAnnual = 1200\n                } = toolArgs;\n                \n                const loanAmount = homePrice - downPayment;\n                const monthlyRate = (interestRate / 100) / 12;\n                const numPayments = loanTermYears * 12;\n                \n                // Monthly mortgage payment (principal + interest)\n                const monthlyPI = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / \n                                  (Math.pow(1 + monthlyRate, numPayments) - 1);\n                \n                // Property tax (monthly)\n                const monthlyTax = (homePrice * (propertyTaxRate / 100)) / 12;\n                \n                // Insurance (monthly)\n                const monthlyInsurance = insuranceAnnual / 12;\n                \n                // PMI if down payment < 20%\n                const downPaymentPercent = (downPayment / homePrice) * 100;\n                const needsPMI = downPaymentPercent < 20;\n                const monthlyPMI = needsPMI ? (loanAmount * 0.005) / 12 : 0; // 0.5% annual PMI\n                \n                // Total monthly payment (PITI + PMI)\n                const totalMonthly = monthlyPI + monthlyTax + monthlyInsurance + monthlyPMI;\n                \n                // Total cost over lifetime\n                const totalPaid = (monthlyPI * numPayments) + (monthlyTax * numPayments) + (monthlyInsurance * numPayments);\n                const totalInterest = (monthlyPI * numPayments) - loanAmount;\n                \n                actionsPerformed.push({\n                  type: 'mortgage_calculated',\n                  data: {\n                    homePrice,\n                    downPayment,\n                    downPaymentPercent: Math.round(downPaymentPercent),\n                    loanAmount,\n                    interestRate,\n                    loanTermYears,\n                    monthlyPayment: {\n                      principalInterest: Math.round(monthlyPI),\n                      propertyTax: Math.round(monthlyTax),\n                      insurance: Math.round(monthlyInsurance),\n                      pmi: Math.round(monthlyPMI),\n                      total: Math.round(totalMonthly)\n                    },\n                    lifetimeCost: {\n                      totalPaid: Math.round(totalPaid),\n                      totalInterest: Math.round(totalInterest),\n                      totalPrincipal: Math.round(loanAmount)\n                    },\n                    needsPMI,\n                    amountToAvoidPMI: needsPMI ? Math.round(homePrice * 0.20 - downPayment) : 0\n                  }\n                });\n              } else if (toolName === 'optimize_tax_strategy') {\n                // Analyze tax optimization opportunities\n                const {\n                  annualIncome,\n                  filingStatus,\n                  hasRetirementAccount = false,\n                  currentRetirementContribution = 0,\n                  hasInvestments = false\n                } = toolArgs;\n                \n                // 2024 tax brackets (simplified)\n                const brackets: Record<string, any> = {\n                  'single': [\n                    { limit: 11600, rate: 10 },\n                    { limit: 47150, rate: 12 },\n                    { limit: 100525, rate: 22 },\n                    { limit: 191950, rate: 24 },\n                    { limit: 243725, rate: 32 },\n                    { limit: 609350, rate: 35 },\n                    { limit: Infinity, rate: 37 }\n                  ],\n                  'married_joint': [\n                    { limit: 23200, rate: 10 },\n                    { limit: 94300, rate: 12 },\n                    { limit: 201050, rate: 22 },\n                    { limit: 383900, rate: 24 },\n                    { limit: 487450, rate: 32 },\n                    { limit: 731200, rate: 35 },\n                    { limit: Infinity, rate: 37 }\n                  ]\n                };\n                \n                const taxBrackets = brackets[filingStatus] || brackets['single'];\n                const standardDeduction = filingStatus === 'married_joint' ? 27700 : 13850;\n                \n                // Calculate current tax\n                const taxableIncome = Math.max(0, annualIncome - standardDeduction);\n                let currentTax = 0;\n                let remainingIncome = taxableIncome;\n                \n                for (const bracket of taxBrackets) {\n                  const previousLimit = taxBrackets[taxBrackets.indexOf(bracket) - 1]?.limit || 0;\n                  const incomeInBracket = Math.min(remainingIncome, bracket.limit - previousLimit);\n                  currentTax += incomeInBracket * (bracket.rate / 100);\n                  remainingIncome -= incomeInBracket;\n                  if (remainingIncome <= 0) break;\n                }\n                \n                const effectiveTaxRate = (currentTax / annualIncome) * 100;\n                \n                // Retirement account optimization\n                const retirementLimit = filingStatus === 'married_joint' ? 46000 : 23000; // 401k + IRA limits\n                const retirementOpportunity = hasRetirementAccount \n                  ? Math.min(retirementLimit - currentRetirementContribution, annualIncome * 0.20)\n                  : Math.min(retirementLimit, annualIncome * 0.15);\n                const retirementTaxSavings = retirementOpportunity * (effectiveTaxRate / 100);\n                \n                // Generate strategies\n                const strategies: string[] = [];\n                \n                if (!hasRetirementAccount || currentRetirementContribution < 6000) {\n                  strategies.push(`MAX OUT Roth IRA ($7,000/year) - Tax-free growth forever! Saves $${Math.round(7000 * 0.22)} in future taxes`);\n                }\n                \n                if (currentRetirementContribution < retirementLimit * 0.5) {\n                  strategies.push(`Increase 401(k) to $${Math.round(retirementOpportunity)} - Immediate $${Math.round(retirementTaxSavings)} tax deduction!`);\n                }\n                \n                if (hasInvestments) {\n                  strategies.push('Tax-Loss Harvesting: Sell losing investments to offset gains - can save 15-20% on capital gains');\n                  strategies.push('Hold investments 1+ year for long-term capital gains (15% vs 22-37% short-term)');\n                }\n                \n                strategies.push(`HSA Triple Tax Advantage: Contribute $4,150 (single) or $8,300 (family) - Deductible, grows tax-free, withdraws tax-free for medical`);\n                strategies.push('Bunch deductions: Prepay property tax + extra charity in one year to exceed standard deduction');\n                \n                if (annualIncome > 200000) {\n                  strategies.push('Backdoor Roth IRA: Max traditional IRA → convert to Roth for high earners (over income limits)');\n                }\n                \n                actionsPerformed.push({\n                  type: 'tax_optimization_analyzed',\n                  data: {\n                    annualIncome,\n                    filingStatus,\n                    currentTax: Math.round(currentTax),\n                    effectiveTaxRate: effectiveTaxRate.toFixed(1),\n                    standardDeduction,\n                    retirementOptimization: {\n                      currentContribution: currentRetirementContribution,\n                      recommendedIncrease: Math.round(retirementOpportunity),\n                      taxSavings: Math.round(retirementTaxSavings),\n                      annualLimit: retirementLimit\n                    },\n                    strategies,\n                    potentialSavings: Math.round(retirementTaxSavings + (hasInvestments ? annualIncome * 0.02 : 0))\n                  }\n                });\n              } else if (toolName === 'save_financial_estimates') {\n                // Smart validation and parsing of financial estimates\n                const estimates: any = {};\n                const warnings: string[] = [];\n                const errors: string[] = [];\n                \n                // Enhanced validation helper with smart parsing\n                const validateAmount = (value: any, name: string, field: 'income' | 'expenses' | 'savings') => {\n                  // Parse the value - handle various formats\n                  let num: number;\n                  if (typeof value === 'string') {\n                    // Remove all formatting characters except decimal point\n                    const cleaned = value.replace(/[$,]/g, '').trim();\n                    num = parseFloat(cleaned);\n                  } else {\n                    num = value;\n                  }\n                  \n                  if (isNaN(num) || num < 0) {\n                    errors.push(`${name} must be a valid positive number`);\n                    return 0;\n                  }\n                  \n                  // Field-specific validation thresholds\n                  const thresholds = {\n                    income: { \n                      warning: 50000, // $50k/month = $600k/year - already very high\n                      error: 150000   // $150k/month = $1.8M/year - likely an error\n                    },\n                    expenses: {\n                      warning: 50000,\n                      error: 150000\n                    },\n                    savings: {\n                      warning: 1000000,  // $1M net worth - reasonable\n                      error: 100000000   // $100M - likely typo\n                    }\n                  };\n                  \n                  const threshold = thresholds[field];\n                  \n                  // Critical error check - values that are almost certainly wrong\n                  if (num > threshold.error) {\n                    errors.push(\n                      `${name} of $${num.toLocaleString()} is unrealistically high. ` +\n                      `Did you mean $${(num / 1000).toLocaleString()} (1/1000th) or enter it in a different unit? ` +\n                      `Please provide the correct amount.`\n                    );\n                    return num; // Return for error display, but won't save\n                  }\n                  \n                  // Warning check - high but possibly correct\n                  if (num > threshold.warning) {\n                    warnings.push(\n                      `${name} of $${num.toLocaleString()} ${field === 'income' ? `($${(num * 12).toLocaleString()}/year)` : ''} is very high. ` +\n                      `Is this correct?`\n                    );\n                  }\n                  \n                  return num;\n                };\n                \n                // Validate each field\n                let income = 0;\n                let expenses = 0;\n                let savings = 0;\n                \n                if (toolArgs.monthlyIncome !== undefined) {\n                  income = validateAmount(toolArgs.monthlyIncome, 'Monthly income', 'income');\n                  if (errors.length === 0) {\n                    estimates.monthlyIncomeEstimate = income.toString();\n                  }\n                }\n                \n                if (toolArgs.monthlyExpenses !== undefined) {\n                  expenses = validateAmount(toolArgs.monthlyExpenses, 'Monthly expenses', 'expenses');\n                  if (errors.length === 0) {\n                    estimates.monthlyExpensesEstimate = expenses.toString();\n                  }\n                }\n                \n                if (toolArgs.currentSavings !== undefined) {\n                  savings = validateAmount(toolArgs.currentSavings, 'Current savings', 'savings');\n                  if (errors.length === 0) {\n                    estimates.currentSavingsEstimate = savings.toString();\n                  }\n                }\n                \n                // Logical consistency checks (only if no critical errors)\n                if (errors.length === 0) {\n                  // Expenses vs Income check\n                  if (income > 0 && expenses > 0 && expenses > income * 1.5) {\n                    warnings.push(\n                      `Your expenses ($${expenses.toLocaleString()}) are ${Math.round((expenses/income - 1) * 100)}% higher than income - ` +\n                      `this creates significant debt. Is this temporary or ongoing?`\n                    );\n                  }\n                  \n                  // Savings vs Income consistency\n                  if (income > 10000 && savings < 1000) {\n                    warnings.push(\n                      `With monthly income of $${income.toLocaleString()}, I'd expect higher savings. ` +\n                      `Is your net worth really $${savings.toLocaleString()}?`\n                    );\n                  }\n                  \n                  // Negative savings rate check\n                  if (income > 0 && expenses > income) {\n                    const deficit = expenses - income;\n                    warnings.push(\n                      `You're running a deficit of $${deficit.toLocaleString()}/month. ` +\n                      `This means you're going into debt or depleting savings - needs immediate action!`\n                    );\n                  }\n                }\n                \n                // If there are CRITICAL ERRORS, don't save - ask user to correct\n                if (errors.length > 0) {\n                  debugLog('AI', 'Financial data validation errors (not saved)', { errors });\n                  actionsPerformed.push({\n                    type: 'financial_estimates_validation_failed',\n                    errors: errors,\n                    suggestions: [\n                      'Check if you entered the amount in the wrong currency/unit',\n                      'Verify you didn\\'t include extra zeros',\n                      'Confirm whether this is monthly, yearly, or lifetime amount'\n                    ]\n                  });\n                }\n                // If there are warnings but no errors, save with warnings\n                else if (warnings.length > 0) {\n                  debugLog('AI', 'Financial data warnings (saved with flags)', { warnings });\n                  actionsPerformed.push({\n                    type: 'financial_estimates_saved_with_warnings',\n                    data: estimates,\n                    warnings: warnings\n                  });\n                  await storage.updateUserPreferences(userId, estimates);\n                  debugLog('AI', 'Saved financial estimates with warnings', { estimates });\n                }\n                // Clean save - no issues\n                else {\n                  actionsPerformed.push({\n                    type: 'financial_estimates_saved',\n                    data: estimates\n                  });\n                  await storage.updateUserPreferences(userId, estimates);\n                  debugLog('AI', 'Saved financial estimates', { estimates });\n                }\n              } else if (toolName === 'calculate_car_affordability') {\n                // Car affordability calculator with 20/4/10 rule\n                const {\n                  monthlyIncome,\n                  downPayment,\n                  currentCarPayment = 0,\n                  creditScore = 'good',\n                  preferredTerm = 4\n                } = toolArgs;\n\n                // Interest rates by credit score\n                const interestRates: Record<string, number> = {\n                  'excellent': 5.5,\n                  'good': 7.0,\n                  'fair': 10.0,\n                  'poor': 14.0\n                };\n                const rate = interestRates[creditScore];\n                const monthlyRate = rate / 100 / 12;\n\n                // ENFORCE 20/4/10 RULE: Max 4-year term\n                const loanTerm = Math.min(preferredTerm, 4);\n                const termViolation = preferredTerm > 4;\n\n                // 20/4/10 rule calculations\n                const maxMonthlyPayment = monthlyIncome * 0.10;\n                const availableForPayment = Math.max(0, maxMonthlyPayment - currentCarPayment);\n                \n                // Check if budget is overextended\n                const budgetOverextended = currentCarPayment >= maxMonthlyPayment;\n                \n                if (budgetOverextended) {\n                  // Budget is already maxed out or over\n                  actionsPerformed.push({\n                    type: 'car_affordability_budget_exceeded',\n                    data: {\n                      monthlyIncome,\n                      currentCarPayment,\n                      maxRecommendedPayment: Math.round(maxMonthlyPayment),\n                      overBudgetAmount: Math.round(currentCarPayment - maxMonthlyPayment),\n                      message: 'Your current car payment already meets or exceeds the recommended 10% of income limit. Focus on paying off the current vehicle before purchasing another.',\n                      recommendations: [\n                        `Current payment: $${Math.round(currentCarPayment)}/month (${Math.round((currentCarPayment / monthlyIncome) * 100)}% of income)`,\n                        `Recommended max: $${Math.round(maxMonthlyPayment)}/month (10% of income)`,\n                        'Pay off current vehicle to free up budget',\n                        'Increase income to afford an additional vehicle',\n                        'Consider selling current vehicle if replacement is needed'\n                      ]\n                    }\n                  });\n                  continue;\n                }\n                \n                // Calculate max car price based on payment with enforced 4-year term\n                const numPayments = loanTerm * 12;\n                const pvFactor = (Math.pow(1 + monthlyRate, numPayments) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, numPayments));\n                const maxLoanAmountFromPayment = availableForPayment * pvFactor;\n                \n                // ENFORCE 20/4/10 RULE: Calculate max affordable price based on 20% down requirement\n                const maxPriceWith20PercentDown = downPayment / 0.20;\n                \n                // Use the LOWER of payment-based cap and down-payment-based cap (strictest constraint wins)\n                const maxCarPrice = Math.min(maxLoanAmountFromPayment + downPayment, maxPriceWith20PercentDown);\n                const maxLoanAmount = maxCarPrice - downPayment;\n                \n                // Validate that we have a reasonable result\n                if (maxCarPrice <= 0 || !isFinite(maxCarPrice)) {\n                  actionsPerformed.push({\n                    type: 'car_affordability_insufficient_budget',\n                    data: {\n                      message: 'Insufficient budget for vehicle purchase with current parameters',\n                      monthlyIncome,\n                      downPayment,\n                      recommendations: [\n                        'Increase monthly income',\n                        'Save for a larger down payment',\n                        'Pay off existing car payment first',\n                        'Consider a less expensive vehicle'\n                      ]\n                    }\n                  });\n                  continue;\n                }\n                \n                // Calculate compliance metrics\n                const downPaymentPercent = (downPayment / maxCarPrice) * 100;\n                const meetsDownPaymentRule = downPaymentPercent >= 20;\n                const recommendedDownPayment = maxCarPrice * 0.20;\n                const downPaymentShortfall = meetsDownPaymentRule ? 0 : recommendedDownPayment - downPayment;\n\n                // Total cost of ownership (5 years)\n                const avgInsurance = 1200; // $100/month\n                const avgMaintenance = 1000; // $83/month\n                const avgFuel = 2000; // $167/month\n                const totalMonthly = availableForPayment + (avgInsurance + avgMaintenance + avgFuel) / 12;\n                const fiveYearOwnership = totalMonthly * 60 + downPayment;\n\n                // Depreciation (new car loses ~20% in year 1, then ~15% per year)\n                const year1Value = maxCarPrice * 0.80;\n                const year5Value = year1Value * Math.pow(0.85, 4);\n                const totalDepreciation = maxCarPrice - year5Value;\n\n                actionsPerformed.push({\n                  type: 'car_affordability_calculated',\n                  data: {\n                    monthlyIncome,\n                    downPayment,\n                    creditScore,\n                    loanTerm,\n                    interestRate: rate,\n                    rule2041Compliance: {\n                      downPayment20: meetsDownPaymentRule,\n                      loanTerm4Years: loanTerm <= 4,\n                      monthlyPayment10: availableForPayment <= maxMonthlyPayment,\n                      allRulesMet: meetsDownPaymentRule && loanTerm <= 4 && availableForPayment <= maxMonthlyPayment\n                    },\n                    affordability: {\n                      maxCarPrice: Math.round(maxCarPrice),\n                      maxLoanAmount: Math.round(maxLoanAmount),\n                      monthlyPayment: Math.round(availableForPayment),\n                      totalMonthlyWithOwnership: Math.round(totalMonthly),\n                      downPaymentNeeded: downPayment,\n                      downPaymentPercent: Math.round(downPaymentPercent),\n                      recommendedDownPayment: Math.round(recommendedDownPayment),\n                      downPaymentShortfall: Math.round(downPaymentShortfall)\n                    },\n                    fiveYearCost: {\n                      payments: Math.round(availableForPayment * (loanTerm * 12)),\n                      insurance: avgInsurance * 5,\n                      maintenance: avgMaintenance * 5,\n                      fuel: avgFuel * 5,\n                      depreciation: Math.round(totalDepreciation),\n                      total: Math.round(fiveYearOwnership)\n                    },\n                    warnings: [\n                      termViolation ? `RULE VIOLATION: You requested ${preferredTerm}-year term, but 20/4/10 rule requires max 4 years. Calculations use 4-year term.` : null,\n                      !meetsDownPaymentRule ? `RULE VIOLATION: Down payment is ${Math.round(downPaymentPercent)}% (need 20%). Max affordable car is limited by your down payment.` : null\n                    ].filter(Boolean),\n                    recommendations: [\n                      meetsDownPaymentRule ? '20% Down Payment Rule: COMPLIANT' : `20% Down Payment Rule: NOT MET - With $${Math.round(downPayment)} down, max car price is $${Math.round(maxCarPrice)} to maintain 20% down`,\n                      !termViolation ? '4-Year Term Rule: COMPLIANT' : `4-Year Term Rule: ENFORCED - Your ${preferredTerm}-year request exceeds the 4-year maximum. Shorter terms save interest.`,\n                      '10% Income Rule: COMPLIANT - Monthly payment within budget',\n                      `Down payment caps your purchase at $${Math.round(maxPriceWith20PercentDown)} (20% rule)`,\n                      `Monthly payment caps your purchase at $${Math.round(maxLoanAmountFromPayment + downPayment)} (budget constraint)`,\n                      'Consider certified pre-owned to avoid steep new car depreciation (20% in year 1)',\n                      `To afford a more expensive car: ${downPayment < maxCarPrice * 0.20 ? 'Save more for down payment OR ' : ''}Increase monthly income`\n                    ].filter(Boolean)\n                  }\n                });\n              } else if (toolName === 'optimize_student_loan_payoff') {\n                // Student loan optimization strategies\n                const {\n                  totalBalance,\n                  averageInterestRate,\n                  monthlyIncome,\n                  extraPayment = 0,\n                  employerType = 'private_sector'\n                } = toolArgs;\n\n                const monthlyRate = (averageInterestRate / 100) / 12;\n                const standardPayment = totalBalance * 0.01; // ~1% of balance is typical minimum\n\n                // Strategy 1: Income-driven repayment (IDR)\n                const idrPayment = monthlyIncome * 0.10; // 10% of discretionary income\n                const idrMonths = Math.ceil(Math.log(totalBalance / (idrPayment - totalBalance * monthlyRate)) / Math.log(1 + monthlyRate));\n                const idrTotalPaid = idrPayment * Math.min(idrMonths, 240); // Cap at 20 years for forgiveness\n\n                // Strategy 2: Standard repayment (10 years)\n                const standardMonths = 120;\n                const standardMonthlyPayment = totalBalance * monthlyRate / (1 - Math.pow(1 + monthlyRate, -standardMonths));\n                const standardTotalPaid = standardMonthlyPayment * standardMonths;\n\n                // Strategy 3: Accelerated payoff with extra payment\n                const acceleratedPayment = standardMonthlyPayment + extraPayment;\n                const acceleratedMonths = extraPayment > 0 \n                  ? Math.ceil(Math.log(totalBalance / (acceleratedPayment - totalBalance * monthlyRate)) / Math.log(1 + monthlyRate))\n                  : standardMonths;\n                const acceleratedTotalPaid = acceleratedPayment * acceleratedMonths;\n\n                // Strategy 4: Refinance analysis (assuming 2% lower rate)\n                const refinanceRate = Math.max(3, averageInterestRate - 2);\n                const refinanceMonthlyRate = (refinanceRate / 100) / 12;\n                const refinancePayment = totalBalance * refinanceMonthlyRate / (1 - Math.pow(1 + refinanceMonthlyRate, -standardMonths));\n                const refinanceTotalPaid = refinancePayment * standardMonths;\n\n                // PSLF eligibility\n                const pslfEligible = ['public_service', 'nonprofit', 'government'].includes(employerType);\n                const pslfMonthsToForgiveness = 120; // 10 years of qualifying payments\n                const pslfPayment = idrPayment;\n                const pslfTotalPaid = pslfPayment * pslfMonthsToForgiveness;\n                const pslfForgiveness = totalBalance - pslfTotalPaid;\n\n                actionsPerformed.push({\n                  type: 'student_loan_optimized',\n                  data: {\n                    totalBalance,\n                    averageInterestRate,\n                    monthlyIncome,\n                    strategies: [\n                      {\n                        name: 'Income-Driven Repayment (IDR)',\n                        monthlyPayment: Math.round(idrPayment),\n                        totalInterest: Math.round(Math.max(0, idrTotalPaid - totalBalance)),\n                        timeToPayoff: Math.round(Math.min(idrMonths, 240) / 12),\n                        totalPaid: Math.round(idrTotalPaid),\n                        pros: ['Lower monthly payment', 'Forgiveness after 20-25 years', 'Hardship protection'],\n                        cons: ['More total interest', 'Taxable forgiveness', 'Longer repayment']\n                      },\n                      {\n                        name: 'Standard 10-Year Plan',\n                        monthlyPayment: Math.round(standardMonthlyPayment),\n                        totalInterest: Math.round(standardTotalPaid - totalBalance),\n                        timeToPayoff: 10,\n                        totalPaid: Math.round(standardTotalPaid),\n                        pros: ['Predictable payments', 'Lower total interest', 'Debt-free in 10 years'],\n                        cons: ['Higher monthly payment', 'No forgiveness option']\n                      },\n                      {\n                        name: `Accelerated Payoff (+$${extraPayment}/month)`,\n                        monthlyPayment: Math.round(acceleratedPayment),\n                        totalInterest: Math.round(Math.max(0, acceleratedTotalPaid - totalBalance)),\n                        timeToPayoff: Math.round(acceleratedMonths / 12 * 10) / 10,\n                        totalPaid: Math.round(acceleratedTotalPaid),\n                        interestSaved: Math.round(standardTotalPaid - acceleratedTotalPaid),\n                        pros: ['Fastest payoff', 'Lowest total interest', 'Build equity fast'],\n                        cons: ['Highest monthly payment', 'Less cash flow flexibility']\n                      },\n                      {\n                        name: 'Refinance to Lower Rate',\n                        monthlyPayment: Math.round(refinancePayment),\n                        newRate: refinanceRate,\n                        totalInterest: Math.round(refinanceTotalPaid - totalBalance),\n                        timeToPayoff: 10,\n                        totalPaid: Math.round(refinanceTotalPaid),\n                        savings: Math.round(standardTotalPaid - refinanceTotalPaid),\n                        pros: ['Lower interest rate', 'Reduced total cost', 'Flexible terms'],\n                        cons: ['Lose federal protections', 'No forgiveness', 'Credit score required']\n                      }\n                    ],\n                    pslf: pslfEligible ? {\n                      eligible: true,\n                      monthlyPayment: Math.round(pslfPayment),\n                      monthsToForgiveness: pslfMonthsToForgiveness,\n                      totalPaid: Math.round(pslfTotalPaid),\n                      amountForgiven: Math.round(pslfForgiveness),\n                      savings: Math.round(totalBalance - pslfTotalPaid),\n                      requirements: ['120 qualifying payments', 'Full-time public service', 'Submit employment certification annually']\n                    } : {\n                      eligible: false,\n                      reason: 'Requires employment in public service, nonprofit, or government'\n                    },\n                    recommendation: pslfEligible \n                      ? 'Pursue PSLF - potential forgiveness of $' + Math.round(pslfForgiveness).toLocaleString()\n                      : extraPayment > 500 \n                        ? 'Accelerated payoff saves most interest'\n                        : averageInterestRate > 7\n                          ? 'Refinance to save on interest'\n                          : 'Standard plan offers balance of payment and payoff time'\n                  }\n                });\n              } else if (toolName === 'compare_investment_options') {\n                // Investment comparison analysis\n                const {\n                  investmentAmount,\n                  timeHorizon,\n                  riskTolerance,\n                  investmentGoal,\n                  currentHoldings = ''\n                } = toolArgs;\n\n                // Define investment options with expected returns\n                const options = [\n                  {\n                    name: 'S&P 500 Index Fund (VOO/VTI)',\n                    expectedReturn: riskTolerance === 'aggressive' ? 10 : riskTolerance === 'moderate' ? 9 : 7,\n                    risk: 'High',\n                    liquidity: 'High',\n                    taxTreatment: 'Long-term capital gains (15%) if held 1+ year',\n                    minimumInvestment: 0,\n                    fees: '0.03-0.04%',\n                    pros: ['Historical 10% returns', 'Diversified across 500 companies', 'Low fees', 'High liquidity'],\n                    cons: ['Market volatility', 'Short-term losses possible', 'No guaranteed returns']\n                  },\n                  {\n                    name: 'Total Bond Market (BND/AGG)',\n                    expectedReturn: 4.5,\n                    risk: 'Low',\n                    liquidity: 'High',\n                    taxTreatment: 'Ordinary income tax on interest',\n                    minimumInvestment: 0,\n                    fees: '0.03-0.05%',\n                    pros: ['Stable income', 'Lower volatility', 'Portfolio diversification'],\n                    cons: ['Lower returns', 'Interest rate risk', 'Inflation risk']\n                  },\n                  {\n                    name: 'High-Yield Savings Account (HYSA)',\n                    expectedReturn: 4.5,\n                    risk: 'None (FDIC insured)',\n                    liquidity: 'Immediate',\n                    taxTreatment: 'Ordinary income tax on interest',\n                    minimumInvestment: 0,\n                    fees: '0%',\n                    pros: ['No risk', 'FDIC insured up to $250k', 'Immediate access', 'No fees'],\n                    cons: ['Lower returns than stocks', 'Interest taxed as income', 'Not keeping up with inflation']\n                  },\n                  {\n                    name: 'Certificates of Deposit (CDs)',\n                    expectedReturn: 5.0,\n                    risk: 'None (FDIC insured)',\n                    liquidity: 'Low (penalties for early withdrawal)',\n                    taxTreatment: 'Ordinary income tax on interest',\n                    minimumInvestment: 500,\n                    fees: '0% (but early withdrawal penalty)',\n                    pros: ['Guaranteed returns', 'FDIC insured', 'Higher than HYSA rates'],\n                    cons: ['Locked in for term', 'Early withdrawal penalties', 'Opportunity cost if rates rise']\n                  },\n                  {\n                    name: 'Real Estate Investment Trusts (REITs)',\n                    expectedReturn: 8,\n                    risk: 'Medium-High',\n                    liquidity: 'High (if publicly traded)',\n                    taxTreatment: 'Ordinary income + capital gains',\n                    minimumInvestment: 0,\n                    fees: '0.5-1.0%',\n                    pros: ['Real estate exposure', 'Dividends', 'Diversification from stocks'],\n                    cons: ['Interest rate sensitive', 'Market volatility', 'Higher fees']\n                  }\n                ];\n\n                // Calculate projections for each option\n                const projections = options.map(option => {\n                  const futureValue = investmentAmount * Math.pow(1 + option.expectedReturn / 100, timeHorizon);\n                  const totalGain = futureValue - investmentAmount;\n                  return {\n                    ...option,\n                    futureValue: Math.round(futureValue),\n                    totalGain: Math.round(totalGain),\n                    annualizedReturn: option.expectedReturn\n                  };\n                });\n\n                // Recommendations based on goal and timeline\n                let recommended: string[];\n                if (timeHorizon < 2) {\n                  recommended = ['High-Yield Savings Account (HYSA)', 'Certificates of Deposit (CDs)'];\n                } else if (timeHorizon < 5) {\n                  recommended = riskTolerance === 'aggressive' \n                    ? ['S&P 500 Index Fund (VOO/VTI)', 'Total Bond Market (BND/AGG)']\n                    : ['Total Bond Market (BND/AGG)', 'High-Yield Savings Account (HYSA)'];\n                } else {\n                  recommended = riskTolerance === 'aggressive'\n                    ? ['S&P 500 Index Fund (VOO/VTI)', 'Real Estate Investment Trusts (REITs)']\n                    : riskTolerance === 'moderate'\n                      ? ['S&P 500 Index Fund (VOO/VTI)', 'Total Bond Market (BND/AGG)']\n                      : ['Total Bond Market (BND/AGG)', 'S&P 500 Index Fund (VOO/VTI)'];\n                }\n\n                actionsPerformed.push({\n                  type: 'investment_comparison_completed',\n                  data: {\n                    investmentAmount,\n                    timeHorizon,\n                    riskTolerance,\n                    investmentGoal,\n                    options: projections,\n                    recommended,\n                    allocation: timeHorizon >= 5 ? {\n                      stocks: riskTolerance === 'aggressive' ? 90 : riskTolerance === 'moderate' ? 70 : 50,\n                      bonds: riskTolerance === 'aggressive' ? 10 : riskTolerance === 'moderate' ? 30 : 50,\n                      description: `Based on ${timeHorizon}-year timeline and ${riskTolerance} risk tolerance`\n                    } : null,\n                    keyInsights: [\n                      `For ${timeHorizon}-year timeline, ${recommended[0]} offers best balance of risk/return`,\n                      timeHorizon >= 10 ? 'Long horizon allows recovery from market dips - stocks recommended' : 'Shorter timeline favors safer options',\n                      `Expected portfolio value in ${timeHorizon} years: $${projections.find(p => p.name === recommended[0])?.futureValue.toLocaleString()}`,\n                      'Diversification across multiple options reduces overall risk'\n                    ]\n                  }\n                });\n              }\n            } catch (toolError) {\n              console.error(`Tool execution error (${toolName}):`, toolError);\n              actionsPerformed.push({\n                type: 'error',\n                tool: toolName,\n                error: 'Failed to execute action'\n              });\n            }\n          }\n        }\n        \n        // Generate response content - use AI response or create confirmation if empty\n        let responseContent = aiResult.answer;\n        \n        // DEFENSIVE LOGGING: Alert if AI returns empty response (regression detection)\n        if (!responseContent || responseContent.trim() === '') {\n          console.error('CRITICAL: AI returned empty response!', {\n            model: aiResult.modelUsed,\n            modelSlug: aiResult.modelSlug,\n            escalated: aiResult.escalated,\n            tokensOut: aiResult.tokensOut,\n            tokensIn: aiResult.tokensIn,\n            cost: aiResult.cost,\n            orchestratorUsed: aiResult.orchestratorUsed,\n            message: 'This should never happen - investigate hybrid AI service'\n          });\n        }\n        \n        // Sanitize response: remove any leaked function call syntax or technical details\n        if (responseContent) {\n          // Remove ALL variations of <function>...</function> syntax (with or without attributes)\n          responseContent = responseContent.replace(/<function[^>]*>.*?<\\/function>/gi, '').trim();\n          \n          // Remove any standalone <function> or </function> tags that might be left over\n          responseContent = responseContent.replace(/<\\/?function[^>]*>/gi, '').trim();\n          \n          // Remove \"Tool Calls\" sections and similar technical disclosures\n          responseContent = responseContent.replace(/##?\\s*Tool Calls?.*$/gi, '').trim();\n          responseContent = responseContent.replace(/I've made the following tool calls?:.*$/gi, '').trim();\n          responseContent = responseContent.replace(/\\*\\*Tool Calls?\\*\\*:?.*$/gi, '').trim();\n          \n          // Remove numbered tool call lists (1. create_financial_goal, 2. generate_investment...)\n          responseContent = responseContent.replace(/\\d+\\.\\s*\\w+_\\w+:?\\s*.*$/gm, (match: string) => {\n            if (match.match(/\\w+_\\w+/)) return '';\n            return match;\n          }).trim();\n          \n          // Remove standalone function call patterns  \n          responseContent = responseContent.replace(/\\{[^}]*\"?\\w+\"?\\s*:\\s*[^}]+\\}/g, (match: string) => {\n            // Only remove if it looks like a function call (has common function params)\n            if (match.includes('targetAmount') || match.includes('userConfirmed') || \n                match.includes('category') && match.includes('description')) {\n              return '';\n            }\n            return match;\n          }).trim();\n          \n          // Clean up any double newlines or trailing whitespace\n          responseContent = responseContent.replace(/\\n{3,}/g, '\\n\\n').trim();\n        }\n        \n        // CRITICAL: Ensure responseContent is always a string to prevent TypeError at line 4163\n        if (!responseContent) {\n          responseContent = '';\n        }\n        \n        // If AI used tools but didn't provide a text response, generate detailed explanation\n        if ((!responseContent || responseContent.trim() === '') && actionsPerformed.length > 0) {\n          const confirmations = actionsPerformed.map(action => {\n            if (action.type === 'goal_created') {\n              const goal = action.data;\n              return `Goal created: Save $${parseFloat(goal.targetAmount).toLocaleString()} for \"${goal.title}\" by ${new Date(goal.targetDate).toLocaleDateString()}. I've added this to your financial goals.`;\n            } else if (action.type === 'event_created') {\n              const event = action.data;\n              return `Reminder set: \"${event.title}\" on ${new Date(event.startTime).toLocaleDateString()}. You'll be notified when it's time.`;\n            } else if (action.type === 'transaction_added') {\n              const txn = action.data;\n              const impact = action.budgetImpact;\n              let response = `Tracked: ${txn.type === 'income' ? 'Received' : 'Spent'} $${parseFloat(txn.amount).toLocaleString()} on ${txn.category}.`;\n              \n              // Add budget impact insights for expenses\n              if (impact && txn.type === 'expense') {\n                response += `\\n\\n**Budget Impact:**`;\n                response += `\\n- ${txn.category} spending this month: $${impact.categorySpendingThisMonth.toLocaleString()}`;\n                \n                if (impact.hasBudgetSet && impact.monthlyBudget !== null) {\n                  response += ` of $${impact.monthlyBudget.toLocaleString()} budget (${impact.percentOfBudget}%)`;\n                  if (impact.isOverBudget) {\n                    response += `\\n- ⚠️ **Over budget!** You've exceeded your ${txn.category} budget by $${(impact.categorySpendingThisMonth - impact.monthlyBudget).toLocaleString()}`;\n                  } else if (impact.percentOfBudget >= 80) {\n                    response += `\\n- ⚠️ **Warning:** You've used ${impact.percentOfBudget}% of your ${txn.category} budget with $${impact.remainingBudget.toLocaleString()} remaining`;\n                  } else {\n                    response += `\\n- ✅ On track! $${impact.remainingBudget.toLocaleString()} remaining in ${txn.category} budget`;\n                  }\n                } else {\n                  response += `\\n- 💡 No budget set for ${txn.category} yet. Consider setting a monthly limit to track spending!`;\n                }\n                \n                if (impact.percentOfIncome !== null && impact.percentOfIncome > 15) {\n                  response += `\\n- 💡 This category is ${impact.percentOfIncome}% of your monthly income`;\n                }\n              }\n              \n              return response;\n            } else if (action.type === 'group_created') {\n              const group = action.data;\n              return `Created \"${group.name}\" group. You can now collaborate with others on shared financial planning.`;\n            } else if (action.type === 'crypto_added') {\n              const crypto = action.data;\n              return `Tracked: ${crypto.amount} ${crypto.symbol} at $${parseFloat(crypto.averageBuyPrice).toLocaleString()}/coin. Total investment: $${(parseFloat(crypto.amount) * parseFloat(crypto.averageBuyPrice)).toLocaleString()}`;\n            } else if (action.type === 'portfolio_analyzed') {\n              const data = action.data;\n              const stocks = data.allocation.stocks;\n              const bonds = data.allocation.bonds;\n              const alts = data.allocation.alternatives;\n              return `**Expert Portfolio Allocation Analysis**\\n\\n` +\n                `For age ${data.age}, ${data.riskTolerance} risk, investing $${data.investmentAmount.toLocaleString()}:\\n\\n` +\n                `**${stocks.percentage}% Stocks** - $${Math.round(stocks.amount).toLocaleString()}\\n` +\n                `   - VTI (Vanguard Total Market) or VOO (S&P 500)\\n` +\n                `   - Target: Long-term capital growth\\n` +\n                `   - Expected return: 8-10% annually\\n\\n` +\n                `**${bonds.percentage}% Bonds** - $${Math.round(bonds.amount).toLocaleString()}\\n` +\n                `   - BND (Total Bond) or AGG (Aggregate Bond)\\n` +\n                `   - Target: Stability and income\\n` +\n                `   - Expected return: 3-5% annually\\n\\n` +\n                `**${alts.percentage}% Alternatives** - $${Math.round(alts.amount).toLocaleString()}\\n` +\n                `   - VNQ (Real Estate) or GLD (Gold)\\n` +\n                `   - Target: Diversification hedge\\n\\n` +\n                `**Why this works**: Classic ${110 - data.age}% stocks rule (110 - age = ${stocks.percentage}%) adjusted for ${data.riskTolerance} risk. Rebalance quarterly when drift >5%.`;\n            } else if (action.type === 'debt_analyzed') {\n              const data = action.data;\n              return `**Debt Payoff Strategy Analysis**\\n\\n` +\n                `**AVALANCHE Method** (Save Most Money):\\n` +\n                `- Total Interest: $${data.avalanche.totalInterest.toLocaleString()}\\n` +\n                `- Payoff Time: ${data.avalanche.monthsToPay} months\\n` +\n                `- Strategy: Pay highest interest rate first\\n\\n` +\n                `**SNOWBALL Method** (Quick Wins):\\n` +\n                `- Total Interest: $${data.snowball.totalInterest.toLocaleString()}\\n` +\n                `- Payoff Time: ${data.snowball.monthsToPay} months\\n` +\n                `- Strategy: Pay smallest balance first for motivation\\n\\n` +\n                `**Recommendation**: Avalanche saves $${Math.abs(data.snowball.totalInterest - data.avalanche.totalInterest).toLocaleString()} more. Choose Snowball only if you need psychological wins.`;\n            } else if (action.type === 'future_value_calculated') {\n              const data = action.data;\n              return `**Compound Growth Projection**\\n\\n` +\n                `- **Future Value**: $${data.futureValue.toLocaleString()} (nominal)\\n` +\n                `- **Real Value**: $${data.realValue.toLocaleString()} (inflation-adjusted)\\n` +\n                `- **Total Invested**: $${data.totalInvested.toLocaleString()}\\n` +\n                `- **Growth**: $${data.totalGrowth.toLocaleString()} (${data.returnPercentage}% return)\\n\\n` +\n                `**The power of compounding**: Start early. Every year you delay costs you thousands in lost growth.`;\n            } else if (action.type === 'retirement_calculated') {\n              const data = action.data;\n              const status = data.onTrack ? 'On track' : 'Need to save more';\n              return `**Retirement Planning Analysis**\\n\\n` +\n                `- **Target Amount Needed**: $${data.targetAmount.toLocaleString()} (4% rule)\\n` +\n                `- **Current Savings**: $${data.currentSavings.toLocaleString()}\\n` +\n                `- **Years to Retirement**: ${data.yearsToRetirement}\\n` +\n                `- **Required Monthly Savings**: $${data.requiredMonthly.toLocaleString()}\\n` +\n                `- **Status**: ${status}\\n\\n` +\n                `**Pro tips**: Max 401(k) match (free money), consider Roth IRA for tax-free growth, delay Social Security to 70 for 32% boost.`;\n            } else if (action.type === 'financial_estimates_validation_failed') {\n              const errors = action.errors || [];\n              const suggestions = action.suggestions || [];\n              return `**Data Validation Error**\\n\\n` +\n                `The financial amount you provided seems unrealistic. Here's why:\\n\\n` +\n                errors.map((err: string) => `- ${err}`).join('\\n') + `\\n\\n` +\n                `**Please double-check and provide the correct amount:**\\n` +\n                suggestions.map((sug: string) => `- ${sug}`).join('\\n') + `\\n\\n` +\n                `Once you provide the correct amount, I'll save it and give you personalized advice.`;\n            } else if (action.type === 'financial_estimates_saved_with_warnings') {\n              const warnings = action.warnings || [];\n              return `**Financial Data Saved (with warnings)**\\n\\n` +\n                `I've saved your financial information, but I wanted to flag a few things:\\n\\n` +\n                warnings.map((warn: string) => `- ${warn}`).join('\\n\\n') + `\\n\\n` +\n                `If any of these need correction, just let me know.`;\n            } else if (action.type === 'financial_estimates_saved') {\n              return `**Financial Data Saved**\\n\\nI've securely saved your financial information and will use it to provide personalized advice.`;\n            } else if (action.type === 'emergency_fund_calculated') {\n              const data = action.data;\n              return `**Emergency Fund Analysis**\\n\\n` +\n                `Based on your situation (${data.incomeStability} income${data.dependents > 0 ? `, ${data.dependents} dependent${data.dependents > 1 ? 's' : ''}` : ''}${!data.hasInsurance ? ', no insurance' : ''}):\\n\\n` +\n                `- **Recommended Target**: $${data.targetAmount.toLocaleString()} (${data.recommendedMonths} months of expenses)\\n` +\n                `- **Minimum**: $${data.minAmount.toLocaleString()} (3 months)\\n` +\n                `- **Optimal**: $${data.maxAmount.toLocaleString()} (6 months)\\n\\n` +\n                `**Why ${data.recommendedMonths} months?** Your income stability and dependents determine the right safety net. This gives you ${data.recommendedMonths} months to find new income if needed.`;\n            } else if (action.type === 'credit_improvement_analyzed') {\n              const data = action.data;\n              return `**Credit Score Improvement Plan**\\n\\n` +\n                (data.currentScore ? `Current Score: ${data.currentScore}\\n` : '') +\n                `**Priority Focus**: ${data.priorityAction}\\n\\n` +\n                `**Action Steps (${data.timelineMonths}-month plan)**:\\n\\n` +\n                data.strategies.map((s: string, i: number) => `${i + 1}. ${s}`).join('\\n\\n') + `\\n\\n` +\n                `**${data.scoreAdvice}**`;\n            } else if (action.type === 'rent_affordability_calculated') {\n              const data = action.data;\n              return `**Rent Affordability Analysis**\\n\\n` +\n                `Based on your $${data.monthlyIncome.toLocaleString()}/month income:\\n\\n` +\n                `- **Recommended Rent Range**: $${data.comfortableRange.min.toLocaleString()} - $${data.comfortableRange.max.toLocaleString()}/month (${data.percentageOfIncome}% of income)\\n` +\n                `- **Maximum Comfortable**: $${data.recommendedMax.toLocaleString()}/month\\n\\n` +\n                `**Your 50/30/20 Budget Breakdown:**\\n` +\n                `- Rent & Essentials (50%): $${data.budgetBreakdown.rent.toLocaleString()} + $${data.budgetBreakdown.otherNeeds.toLocaleString()}\\n` +\n                `- Wants (30%): $${data.budgetBreakdown.discretionary.toLocaleString()}\\n` +\n                `- Savings (20%): $${data.budgetBreakdown.savings.toLocaleString()}\\n\\n` +\n                (data.desiredLocation ? `For ${data.desiredLocation}: Check that average rents fit in your $${data.comfortableRange.min.toLocaleString()}-$${data.comfortableRange.max.toLocaleString()} range.\\n\\n` : '') +\n                `**30% Rule**: Never spend more than 30% of gross income on rent - keeps your budget balanced.`;\n            } else if (action.type === 'mortgage_calculated') {\n              const data = action.data;\n              return `**Mortgage Payment Calculator**\\n\\n` +\n                `**Home Purchase**: $${data.homePrice.toLocaleString()}\\n` +\n                `Down Payment: $${data.downPayment.toLocaleString()} (${data.downPaymentPercent}%)\\n` +\n                `Loan Amount: $${data.loanAmount.toLocaleString()} @ ${data.interestRate}% for ${data.loanTermYears} years\\n\\n` +\n                `**Monthly Payment Breakdown (PITI${data.needsPMI ? ' + PMI' : ''}):**\\n` +\n                `- Principal & Interest: $${data.monthlyPayment.principalInterest.toLocaleString()}\\n` +\n                `- Property Tax: $${data.monthlyPayment.propertyTax.toLocaleString()}\\n` +\n                `- Insurance: $${data.monthlyPayment.insurance.toLocaleString()}\\n` +\n                (data.needsPMI ? `- PMI: $${data.monthlyPayment.pmi.toLocaleString()}\\n` : '') +\n                `- **TOTAL: $${data.monthlyPayment.total.toLocaleString()}/month**\\n\\n` +\n                `**Lifetime Cost Analysis:**\\n` +\n                `- Total Interest: $${data.lifetimeCost.totalInterest.toLocaleString()}\\n` +\n                `- Total Paid: $${data.lifetimeCost.totalPaid.toLocaleString()} over ${data.loanTermYears} years\\n\\n` +\n                (data.needsPMI ? `**PMI Alert**: Put down $${data.amountToAvoidPMI.toLocaleString()} more to avoid PMI and save $${data.monthlyPayment.pmi.toLocaleString()}/month.\\n\\n` : '') +\n                `**Pro tip**: 15-year mortgage costs less total interest but has higher monthly payments. Run both scenarios to compare.`;\n            } else if (action.type === 'tax_optimization_analyzed') {\n              const data = action.data;\n              return `**Tax Optimization Analysis**\\n\\n` +\n                `**Your Current Tax Situation:**\\n` +\n                `- Annual Income: $${data.annualIncome.toLocaleString()}\\n` +\n                `- Filing Status: ${data.filingStatus.replace('_', ' ')}\\n` +\n                `- Current Tax: $${data.currentTax.toLocaleString()}\\n` +\n                `- Effective Rate: ${data.effectiveTaxRate}%\\n` +\n                `- Standard Deduction: $${data.standardDeduction.toLocaleString()}\\n\\n` +\n                `**Retirement Account Optimization:**\\n` +\n                `- Current Contribution: $${data.retirementOptimization.currentContribution.toLocaleString()}/year\\n` +\n                `- Recommended Increase: $${data.retirementOptimization.recommendedIncrease.toLocaleString()}/year\\n` +\n                `- **Immediate Tax Savings**: $${data.retirementOptimization.taxSavings.toLocaleString()}\\n` +\n                `- Annual Limit: $${data.retirementOptimization.annualLimit.toLocaleString()}\\n\\n` +\n                `**Top Tax Optimization Strategies:**\\n\\n` +\n                data.strategies.map((s: string, i: number) => `${i + 1}. ${s}`).join('\\n\\n') + `\\n\\n` +\n                `**Total Potential Savings**: $${data.potentialSavings.toLocaleString()}/year\\n\\n` +\n                `**Best move**: Max tax-advantaged accounts first - it's the closest thing to a guaranteed return.`;\n            }\n            return '';\n          }).filter(Boolean).join('\\n\\n');\n          \n          responseContent = confirmations || 'Analysis completed! Let me know if you need clarification on any aspect.';\n        }\n        \n        // CRITICAL: Triple-layer defense to ensure responseContent is ALWAYS a non-empty string\n        // 1. Convert to string (handles null/undefined)\n        // 2. Trim whitespace  \n        // 3. Provide fallback if empty\n        const safeResponseContent = (String(responseContent || '').trim()) || 'I processed your request. How else can I help you?';\n        \n        // Save AI response with guaranteed safe string\n        const aiChatMessage = await storage.createChatMessage({\n          conversationId,\n          role: 'assistant',\n          content: safeResponseContent,\n          userContext: userContext,\n          tokenCount: Math.ceil(safeResponseContent.length / 4),\n          cost: '0.0001' // Standard cost per message\n        });\n\n        // Extract and update conversation memory using safe content\n        await extractAndUpdateMemory(storage, userId, userMessage, safeResponseContent);\n\n        // Update conversation title if it's the first exchange\n        if (conversationHistory.length <= 1) {\n          const title = userMessage.length > 50 \n            ? userMessage.substring(0, 47) + \"...\" \n            : userMessage;\n          await storage.updateChatConversation(conversationId, { title });\n        }\n\n        res.json({\n          userMessage: userChatMessage,\n          aiMessage: aiChatMessage,\n          actionsPerformed: actionsPerformed.length > 0 ? actionsPerformed : undefined\n        });\n\n      } catch (aiError: any) {\n        // Log error for internal monitoring (not exposed to user)\n        const groqError = aiError.groqError;\n        const actualErrorMsg = groqError?.originalMessage || aiError.message || 'Unknown error';\n        const errorCode = groqError?.code || groqError?.statusCode || aiError.code || aiError.status;\n        \n        console.error('[AI Chat Error]', {\n          type: aiError.constructor?.name,\n          code: errorCode,\n          message: actualErrorMsg\n        });\n        \n        // User-friendly error messages (never expose internal details)\n        let errorMessage = \"I'm having trouble processing your request. Please try again in a moment.\";\n        \n        // Check if user is trying to create something\n        const lowerMsg = typeof userMessage === 'string' ? userMessage.toLowerCase() : '';\n        const isCreationIntent = lowerMsg.includes('add') || lowerMsg.includes('create') || \n                                lowerMsg.includes('goal') || lowerMsg.includes('track');\n        \n        if (isCreationIntent) {\n          if (conversationHistory.length > 2) {\n            errorMessage = \"I'd be happy to help with that! Could you share the specific details you'd like tracked? For example: goal name, target amount, and timeline.\";\n          } else {\n            errorMessage = \"I'd love to help you create that! Could you provide the details? For example: What's the goal name, target amount, and when do you want to achieve it?\";\n          }\n        } else if (actualErrorMsg.includes('decommissioned') || actualErrorMsg.includes('model_not_found')) {\n          errorMessage = \"Our AI is being updated. Please try again in a moment.\";\n        } else if (actualErrorMsg.includes('rate limit') || actualErrorMsg.includes('429') || errorCode === 429) {\n          errorMessage = \"I'm handling lots of requests right now. Please wait a moment and try again.\";\n        } else if (actualErrorMsg.includes('timeout') || actualErrorMsg.includes('timed out')) {\n          errorMessage = \"Taking longer than expected - please try again!\";\n        } else if (actualErrorMsg.includes('GROQ_API_KEY') || actualErrorMsg.includes('API')) {\n          errorMessage = \"AI service is temporarily unavailable. Please try again shortly.\";\n        }\n        \n        const aiChatMessage = await storage.createChatMessage({\n          conversationId,\n          role: 'assistant',\n          content: errorMessage,\n          userContext: null,\n          tokenCount: 0,\n          cost: '0.0000'\n        });\n\n        res.json({\n          userMessage: userChatMessage,\n          aiMessage: aiChatMessage,\n          error: \"AI service temporarily unavailable\"\n        });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.delete(\"/api/chat/conversations/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const conversation = await storage.getChatConversation(req.params.id);\n      \n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n\n      await storage.deleteChatConversation(req.params.id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ===== AI Chat Streaming Endpoint (SSE) =====\n  // Provides real-time token-by-token streaming for faster perceived response time\n  app.post(\"/api/chat/conversations/:id/messages/stream\", isAuthenticated, async (req: any, res) => {\n    const userId = getUserIdFromRequest(req);\n    const conversationId = req.params.id;\n    const userMessage = req.body.content;\n    \n    // Set up SSE headers\n    res.setHeader('Content-Type', 'text/event-stream');\n    res.setHeader('Cache-Control', 'no-cache');\n    res.setHeader('Connection', 'keep-alive');\n    res.setHeader('X-Accel-Buffering', 'no');\n    \n    // Helper to send SSE events with immediate flush\n    const sendEvent = (event: string, data: any) => {\n      res.write(`event: ${event}\\ndata: ${JSON.stringify(data)}\\n\\n`);\n      // Flush immediately to ensure real-time delivery\n      if (typeof (res as any).flush === 'function') {\n        (res as any).flush();\n      }\n    };\n    \n    // Flush headers immediately\n    res.flushHeaders();\n    \n    try {\n      // Validate conversation\n      const conversation = await storage.getChatConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        sendEvent('error', { message: 'Conversation not found' });\n        return res.end();\n      }\n      \n      if (!userMessage || typeof userMessage !== 'string') {\n        sendEvent('error', { message: 'Message content is required' });\n        return res.end();\n      }\n      \n      // Save user message first\n      const userChatMessage = await storage.createChatMessage({\n        conversationId,\n        role: 'user',\n        content: userMessage,\n        userContext: null,\n        tokenCount: Math.ceil(userMessage.length / 4),\n        cost: '0.0000'\n      });\n      \n      sendEvent('user_message', { id: userChatMessage.id });\n      \n      // Get user context and subscription\n      const [subscription, userPreferences, financialProfile] = await Promise.all([\n        storage.getUserSubscription(userId),\n        storage.getUserPreferences(userId),\n        storage.getUserFinancialProfile(userId)\n      ]);\n      \n      // Get conversation history for context\n      const messages = await storage.getChatMessages(conversationId, 10);\n      const conversationHistory = messages.reverse().slice(-6).map(m => ({\n        role: m.role as 'user' | 'assistant',\n        content: m.content\n      }));\n      \n      // Build system prompt with user context\n      const language = userPreferences?.language || 'en';\n      const monthlyIncome = financialProfile?.monthlyIncome || '0';\n      \n      const systemPrompt = `You are a helpful financial advisor assistant. \nRespond in ${language === 'th' ? 'Thai' : 'English'}.\nUser's monthly income: $${monthlyIncome}.\nBe concise but helpful. Focus on practical, actionable advice.`;\n      \n      // Import and use Scout client for fast streaming\n      const { getScoutClient } = await import('./ai/clients');\n      const scoutClient = getScoutClient();\n      \n      let fullResponse = '';\n      let tokensIn = 0;\n      let tokensOut = 0;\n      let cost = 0;\n      \n      sendEvent('stream_start', { model: 'scout' });\n      \n      // Stream the response\n      for await (const chunk of scoutClient.chatStream({\n        messages: conversationHistory,\n        system: systemPrompt,\n        temperature: 0.7\n      })) {\n        if (chunk.type === 'text' && chunk.content) {\n          fullResponse += chunk.content;\n          sendEvent('text', { content: chunk.content });\n        } else if (chunk.type === 'done') {\n          tokensIn = chunk.tokensIn || 0;\n          tokensOut = chunk.tokensOut || 0;\n          cost = chunk.cost || 0;\n        } else if (chunk.type === 'error') {\n          sendEvent('error', { message: chunk.error });\n          return res.end();\n        }\n      }\n      \n      // Save the complete AI response\n      const aiChatMessage = await storage.createChatMessage({\n        conversationId,\n        role: 'assistant',\n        content: fullResponse,\n        userContext: null,\n        tokenCount: tokensOut,\n        cost: cost.toFixed(6)\n      });\n      \n      // Update conversation memory\n      await extractAndUpdateMemory(storage, userId, userMessage, fullResponse);\n      \n      sendEvent('stream_end', {\n        id: aiChatMessage.id,\n        tokensIn,\n        tokensOut,\n        cost,\n        model: 'scout'\n      });\n      \n      res.end();\n    } catch (error: any) {\n      console.error('[StreamingAI] Error:', error);\n      sendEvent('error', { message: error.message || 'Streaming failed' });\n      res.end();\n    }\n  });\n\n  // ===== Tier-Aware Hybrid AI Endpoint (Scout + Sonnet + Opus) =====\n  app.post(\"/api/ai/advise\", aiChatLimiter, isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { message } = req.body;\n      \n      if (!message || typeof message !== 'string') {\n        return res.status(400).json({ message: \"Message is required\" });\n      }\n      \n      debugLog('TierAI', 'Request received', { userId, messagePreview: message.substring(0, 100) });\n      \n      // Call tier-aware router for quota enforcement\n      const response = await routeWithTierCheck(userId, message, storage);\n      \n      // Check if quota exceeded\n      if ('type' in response && response.type === 'quota_exceeded') {\n        const quotaError = response as QuotaExceededError;\n        debugLog('TierAI', 'Quota exceeded', { model: quotaError.model, used: quotaError.used, limit: quotaError.limit });\n        \n        // Return 429 Too Many Requests with upgrade CTA\n        return res.status(429).json({\n          ...quotaError,\n          message: `You've reached your ${quotaError.model} quota (${quotaError.used}/${quotaError.limit}).`,\n          upgradeCta: quotaError.nextTier ? `Upgrade to ${quotaError.nextTier} for more AI queries.` : 'You are on the highest tier.',\n        });\n      }\n      \n      // Success - log tier/model/quota context (cast to HybridAIResponse after quota check)\n      const successResponse = response as HybridAIResponse;\n      debugLog('TierAI', 'Response generated', {\n        model: successResponse.modelSlug,\n        escalated: successResponse.escalated,\n        tokensIn: successResponse.tokensIn,\n        tokensOut: successResponse.tokensOut,\n        cost: successResponse.cost,\n        downgraded: successResponse.tierDowngraded || false\n      });\n      \n      res.json(successResponse);\n    } catch (error: any) {\n      console.error('[TierAI] Error:', error);\n      res.status(500).json({ \n        message: error.message || \"Failed to generate advice\",\n        error: process.env.NODE_ENV === 'development' ? error.stack : undefined\n      });\n    }\n  });\n  \n  // Cost optimization stats endpoint\n  app.get(\"/api/ai/cost-stats\", async (req, res) => {\n    try {\n      const stats = aiService.getCostStats();\n      res.json(stats);\n    } catch (error) {\n      console.error('Cost stats error:', error);\n      res.status(500).json({ message: \"Failed to get cost statistics\" });\n    }\n  });\n\n  // Reset usage endpoint (for testing/development)\n  app.post(\"/api/subscription/reset-usage\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      await storage.resetUsage(userId);\n      \n      debugLog('Subscription', 'Usage reset', { userId });\n      res.json({ \n        message: \"Usage reset successfully\",\n        userId: userId,\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Reset usage error:', error);\n      res.status(500).json({ message: \"Failed to reset usage\" });\n    }\n  });\n\n  // Message Feedback Routes\n  app.post(\"/api/messages/:messageId/feedback\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { messageId } = req.params;\n      const { rating, feedbackText } = req.body;\n\n      if (!rating || !['helpful', 'not_helpful'].includes(rating)) {\n        return res.status(400).json({ message: \"Invalid rating. Must be 'helpful' or 'not_helpful'\" });\n      }\n\n      // Check if feedback already exists\n      const existingFeedback = await storage.getMessageFeedback(messageId, userId);\n      \n      let feedback;\n      if (existingFeedback) {\n        // Update existing feedback\n        feedback = await storage.updateMessageFeedback(messageId, userId, {\n          rating,\n          feedbackText: feedbackText || existingFeedback.feedbackText\n        });\n      } else {\n        // Create new feedback\n        const validatedData = insertMessageFeedbackSchema.parse({\n          messageId,\n          userId,\n          rating,\n          feedbackText: feedbackText || null\n        });\n        feedback = await storage.createMessageFeedback(validatedData);\n      }\n\n      res.json(feedback);\n    } catch (error: any) {\n      console.error('Error submitting message feedback:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/messages/:messageId/feedback\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { messageId } = req.params;\n      \n      const feedback = await storage.getMessageFeedback(messageId, userId);\n      \n      if (!feedback) {\n        return res.status(404).json({ message: \"No feedback found for this message\" });\n      }\n      \n      res.json(feedback);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/messages/feedback/stats\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const stats = await storage.getMessageFeedbackStats(userId);\n      res.json(stats);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Financial Health Score endpoint\n  app.get(\"/api/financial-health\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const healthScore = await calculateFinancialHealth(storage, userId);\n      res.json(healthScore);\n    } catch (error: any) {\n      console.error('Financial health calculation error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Goal Progress & Milestones endpoints\n  app.get(\"/api/goals/progress\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const result = await checkGoalProgress(storage, userId);\n      res.json(result);\n    } catch (error: any) {\n      console.error('Goal progress check error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/goals/:goalId/milestones\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { goalId } = req.params;\n      const milestones = await getGoalMilestones(storage, goalId);\n      res.json(milestones);\n    } catch (error: any) {\n      console.error('Goal milestones error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Proactive Insights endpoint\n  app.get(\"/api/insights/proactive\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const insights = await generateProactiveInsights(storage, userId);\n      res.json(insights);\n    } catch (error: any) {\n      console.error('Proactive insights error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Weekly Summary endpoint\n  app.get(\"/api/insights/weekly-summary\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const summary = await generateWeeklySummary(storage, userId);\n      res.json(summary);\n    } catch (error: any) {\n      console.error('Weekly summary error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // AI Insights endpoint\n  app.get(\"/api/ai/insights\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Check usage limit for insights\n      const usageCheck = await storage.checkUsageLimit(userId, 'aiChatsUsed'); // Use chat quota for insights\n      if (!usageCheck.allowed) {\n        return res.status(429).json({ \n          insight: \"Upgrade to get more AI insights.\",\n          error: \"Usage limit exceeded\",\n          usage: usageCheck.usage,\n          limit: usageCheck.limit,\n          type: 'insights_quota_exceeded',\n          upgradeRequired: true\n        });\n      }\n\n      // Fetch user data including subscription for context\n      const [stats, goals, recentTransactions, subscription] = await Promise.all([\n        storage.getUserStats(userId),\n        storage.getFinancialGoalsByUserId(userId),\n        storage.getTransactionsByUserId(userId, 5),\n        storage.getUserSubscription(userId)\n      ]);\n      \n      // Map plan name to tier\n      const tierName = subscription?.plan?.name?.toLowerCase() || '';\n      const subscriptionTier: 'free' | 'pro' | 'enterprise' = \n        tierName.includes('enterprise') ? 'enterprise' :\n        tierName.includes('pro') ? 'pro' : 'free';\n\n      const userContext: UserContext = {\n        userId, // For cache isolation\n        subscriptionTier, // For tier-aware caching\n        totalSavings: stats.totalSavings,\n        monthlyIncome: stats.monthlyIncome,\n        monthlyExpenses: Math.max(0, stats.monthlyIncome - stats.totalSavings),\n        activeGoals: stats.activeGoals,\n        recentTransactions: recentTransactions.map(t => ({\n          amount: parseFloat(t.amount),\n          category: t.category,\n          description: t.description || '',\n          date: t.date.toISOString()\n        })),\n        upcomingEvents: []\n      };\n\n      const insight = await aiService.generateProactiveInsight(userContext);\n      \n      // Track usage\n      await storage.incrementUsage(userId, 'aiInsightsGenerated');\n      \n      res.json({ insight });\n    } catch (error: any) {\n      res.status(500).json({ \n        insight: \"Focus on tracking your spending patterns this week.\",\n        error: error.message \n      });\n    }\n  });\n\n  // Predictive Analytics API routes\n  app.get(\"/api/predictive/spending-forecast\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const days = parseInt(req.query.days || '30') as 30 | 90;\n      const forecast = await predictiveAnalyticsService.forecastSpending(userId, days);\n      res.json(forecast);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/predictive/goal-predictions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const predictions = await predictiveAnalyticsService.predictGoalAchievement(userId);\n      res.json(predictions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/predictive/cash-flow-forecast\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const forecast = await predictiveAnalyticsService.forecastCashFlow(userId);\n      res.json(forecast);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/predictive/anomalies\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const anomalies = await predictiveAnalyticsService.detectAnomalies(userId);\n      res.json(anomalies);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/predictive/savings-opportunities\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const opportunities = await predictiveAnalyticsService.identifySavingsOpportunities(userId);\n      res.json(opportunities);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Subscription Management API routes\n  app.get(\"/api/subscription/plans\", async (req, res) => {\n    try {\n      const plans = await storage.getSubscriptionPlans();\n      const activePlans = plans.filter(p => p.isActive);\n      res.json(activePlans);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/subscription/current\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      let subscription = await storage.getUserSubscription(userId);\n      \n      // Initialize free subscription if user doesn't have one\n      if (!subscription) {\n        await storage.initializeDefaultSubscription(userId);\n        subscription = await storage.getUserSubscription(userId);\n      }\n      \n      // Get current usage\n      const usage = await storage.getUserUsage(userId);\n      const addOns = await storage.getUserAddOns(userId);\n      \n      res.json({\n        subscription,\n        usage,\n        addOns\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/subscription/usage\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      \n      // Get subscription with usage data\n      const subData = await storage.getUserSubscriptionWithUsage(userId);\n      \n      if (!subData) {\n        return res.status(404).json({ message: \"Subscription not found\" });\n      }\n      \n      const { plan, usage } = subData;\n      \n      // Calculate usage for each model tier\n      const scoutUsed = usage?.scoutQueriesUsed || 0;\n      const sonnetUsed = usage?.sonnetQueriesUsed || 0;\n      const gpt5Used = usage?.gpt5QueriesUsed || 0;\n      const opusUsed = usage?.opusQueriesUsed || 0;\n      \n      const scoutLimit = plan.scoutLimit || 0;\n      const sonnetLimit = plan.sonnetLimit || 0;\n      const gpt5Limit = plan.gpt5Limit || 0;\n      const opusLimit = plan.opusLimit || 0;\n      \n      // Also provide legacy format for backward compatibility\n      const totalUsed = scoutUsed + sonnetUsed + gpt5Used + opusUsed;\n      const totalLimit = scoutLimit + sonnetLimit + gpt5Limit + opusLimit;\n\n      res.json({\n        // 4-model tier-aware quota structure\n        scoutUsage: {\n          used: scoutUsed,\n          limit: scoutLimit,\n          remaining: Math.max(0, scoutLimit - scoutUsed),\n          allowed: scoutUsed < scoutLimit\n        },\n        sonnetUsage: {\n          used: sonnetUsed,\n          limit: sonnetLimit,\n          remaining: Math.max(0, sonnetLimit - sonnetUsed),\n          allowed: sonnetUsed < sonnetLimit\n        },\n        gpt5Usage: {\n          used: gpt5Used,\n          limit: gpt5Limit,\n          remaining: Math.max(0, gpt5Limit - gpt5Used),\n          allowed: gpt5Used < gpt5Limit\n        },\n        opusUsage: {\n          used: opusUsed,\n          limit: opusLimit,\n          remaining: Math.max(0, opusLimit - opusUsed),\n          allowed: opusUsed < opusLimit\n        },\n        // Legacy format for backward compatibility\n        chatUsage: {\n          used: totalUsed,\n          limit: totalLimit,\n          remaining: Math.max(0, totalLimit - totalUsed),\n          allowed: totalUsed < totalLimit\n        },\n        analysisUsage: {\n          used: sonnetUsed + opusUsed, // Deep analysis = Sonnet + Opus\n          limit: sonnetLimit + opusLimit,\n          remaining: Math.max(0, (sonnetLimit + opusLimit) - (sonnetUsed + opusUsed)),\n          allowed: (sonnetUsed + opusUsed) < (sonnetLimit + opusLimit)\n        },\n        insights: usage?.aiInsightsGenerated || 0,\n        totalTokens: usage?.totalTokensUsed || 0,\n        estimatedCost: usage?.estimatedCostUsd || '0.0000'\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Stripe Payment Intent for Subscription\n  app.post(\"/api/subscription/create-payment-intent\", isAuthenticated, async (req: any, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ \n          message: \"Payment processing unavailable - Stripe not configured\",\n          requiresSetup: true \n        });\n      }\n\n      const userId = getUserIdFromRequest(req);\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      const { planId } = req.body;\n      \n      if (!planId) {\n        return res.status(400).json({ message: \"Plan ID is required\" });\n      }\n      \n      // Get the target plan\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n\n      // Convert THB price to satang (cents equivalent)\n      const amountInSatang = Math.round(parseFloat(plan.priceThb) * 100);\n\n      // Ensure user has a subscription record\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      // Create or get Stripe customer\n      let stripeCustomerId = '';\n      \n      if (currentSubscription?.stripeCustomerId) {\n        stripeCustomerId = currentSubscription.stripeCustomerId;\n      } else {\n        const customerData: any = {\n          metadata: {\n            userId: userId,\n            plan: plan.name\n          }\n        };\n        if (user.email) {\n          customerData.email = user.email;\n        }\n        if (user.firstName && user.lastName) {\n          customerData.name = `${user.firstName} ${user.lastName}`;\n        } else if (user.email) {\n          customerData.name = user.email;\n        }\n        const customer = await stripe.customers.create(customerData);\n        stripeCustomerId = customer.id;\n        \n        // Save the customer ID to the subscription\n        await storage.updateSubscription(currentSubscription!.id, {\n          stripeCustomerId: stripeCustomerId\n        });\n      }\n\n      // Create payment intent\n      const paymentIntent = await stripe.paymentIntents.create({\n        amount: amountInSatang,\n        currency: 'thb',\n        customer: stripeCustomerId,\n        metadata: {\n          userId: userId,\n          planId: plan.id,\n          planName: plan.name\n        },\n        automatic_payment_methods: { enabled: true }\n      });\n\n      res.json({\n        clientSecret: paymentIntent.client_secret,\n        planName: plan.displayName,\n        price: plan.priceThb,\n        currency: 'THB'\n      });\n\n    } catch (error: any) {\n      console.error('Payment Intent Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Stripe Subscription Management\n  app.post(\"/api/subscription/create-subscription\", isAuthenticated, async (req: any, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ \n          message: \"Subscription processing unavailable - Stripe not configured\",\n          requiresSetup: true \n        });\n      }\n\n      const userId = getUserIdFromRequest(req);\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      const { planId, priceId } = req.body; // priceId from Stripe dashboard\n      \n      if (!planId || !priceId) {\n        return res.status(400).json({ message: \"Plan ID and Price ID are required\" });\n      }\n      \n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n\n      // Ensure user has a subscription record\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      // Create or get Stripe customer\n      let stripeCustomerId = '';\n      \n      if (currentSubscription?.stripeCustomerId) {\n        stripeCustomerId = currentSubscription.stripeCustomerId;\n      } else {\n        const customerData: any = {\n          metadata: { userId: userId }\n        };\n        if (user.email) {\n          customerData.email = user.email;\n        }\n        if (user.firstName && user.lastName) {\n          customerData.name = `${user.firstName} ${user.lastName}`;\n        } else if (user.email) {\n          customerData.name = user.email;\n        }\n        const customer = await stripe.customers.create(customerData);\n        stripeCustomerId = customer.id;\n        \n        // Save the customer ID to the subscription\n        await storage.updateSubscription(currentSubscription!.id, {\n          stripeCustomerId: stripeCustomerId\n        });\n      }\n\n      // Create Stripe subscription\n      const subscription = await stripe.subscriptions.create({\n        customer: stripeCustomerId,\n        items: [{ price: priceId }],\n        payment_behavior: 'default_incomplete',\n        expand: ['latest_invoice.payment_intent'],\n        metadata: {\n          userId: userId,\n          planId: plan.id\n        }\n      });\n\n      const invoice = subscription.latest_invoice as any;\n      res.json({\n        subscriptionId: subscription.id,\n        clientSecret: invoice?.payment_intent?.client_secret,\n        planName: plan.displayName\n      });\n\n    } catch (error: any) {\n      console.error('Subscription Creation Error:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Stripe Checkout Session for subscriptions (modern approach)\n  app.post(\"/api/subscription/create-checkout-session\", isAuthenticated, async (req: any, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ \n          message: \"Payment processing unavailable - Stripe not configured\",\n          requiresSetup: true \n        });\n      }\n\n      const userId = getUserIdFromRequest(req);\n      \n      // Validate request body with Zod\n      const checkoutSessionSchema = z.object({\n        planId: z.string().min(1, \"Plan ID is required\")\n      });\n\n      const validation = checkoutSessionSchema.safeParse(req.body);\n      if (!validation.success) {\n        return res.status(400).json({ \n          message: \"Invalid request body\",\n          errors: validation.error.errors \n        });\n      }\n\n      const { planId } = validation.data;\n\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n\n      // Free plan doesn't need checkout\n      if (plan.name === 'Free') {\n        return res.status(400).json({ message: \"Free plan doesn't require payment\" });\n      }\n\n      // Check if plan has Stripe price ID configured\n      if (!plan.stripePriceId) {\n        return res.status(400).json({ \n          message: `Stripe price ID not configured for ${plan.name} plan`,\n          requiresSetup: true \n        });\n      }\n\n      // Get or create Stripe customer\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      let customerId = currentSubscription?.stripeCustomerId;\n      \n      if (!customerId) {\n        // Create Stripe customer\n        const customer = await stripe.customers.create({\n          email: user.email || undefined,\n          name: user.firstName && user.lastName \n            ? `${user.firstName} ${user.lastName}` \n            : user.email || undefined,\n          metadata: { userId }\n        });\n        customerId = customer.id;\n        \n        // Save customer ID\n        await storage.updateSubscription(currentSubscription!.id, {\n          stripeCustomerId: customerId\n        });\n      }\n\n      // Create checkout session - use request origin to avoid double https://\n      const protocol = req.protocol || 'https';\n      const host = req.get('host') || process.env.REPLIT_DEV_DOMAIN;\n      const baseUrl = `${protocol}://${host}`;\n\n      stripeLogger.info('Creating checkout session', { \n        data: { userId, planId: plan.id, planName: plan.name, customerId }\n      });\n\n      const session = await stripe.checkout.sessions.create({\n        customer: customerId,\n        line_items: [{\n          price: plan.stripePriceId,\n          quantity: 1,\n        }],\n        mode: 'subscription',\n        success_url: `${baseUrl}/subscription?success=true&session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: `${baseUrl}/subscription?canceled=true`,\n        expand: ['subscription'], // Expand subscription object for webhook processing\n        metadata: {\n          userId,\n          planId: plan.id,\n          planName: plan.name\n        }\n      });\n\n      stripeLogger.info('Checkout session created', { \n        data: { sessionId: session.id, status: session.status }\n      });\n\n      if (!session.url) {\n        console.error('[Checkout] ERROR: Stripe returned null URL!', session);\n        return res.status(500).json({ \n          message: \"Stripe checkout session created but no URL returned\",\n          sessionId: session.id\n        });\n      }\n\n      res.json({ url: session.url });\n\n    } catch (error: any) {\n      console.error('[Checkout] Error creating session:', error);\n      \n      // Provide helpful error messages based on error type\n      let errorMessage = error.message || \"Failed to create checkout session\";\n      \n      if (error.type === 'StripeInvalidRequestError') {\n        errorMessage = \"Invalid payment configuration. Please contact support.\";\n      } else if (error.code === 'resource_missing') {\n        errorMessage = \"Payment plan not found. Please try again or contact support.\";\n      } else if (error.statusCode === 401) {\n        errorMessage = \"Payment service authentication failed. Please contact support.\";\n      }\n      \n      res.status(500).json({ \n        message: errorMessage,\n        errorType: error.type || 'unknown'\n      });\n    }\n  });\n\n  app.post(\"/api/subscription/upgrade\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { planId } = req.body;\n      \n      if (!planId) {\n        return res.status(400).json({ message: \"Plan ID is required\" });\n      }\n      \n      // Get the target plan\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n      \n      // Get current subscription\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n      \n      // Check if Stripe is available for real payment processing\n      if (stripe && currentSubscription!.stripeSubscriptionId) {\n        try {\n          // Update Stripe subscription\n          const updatedStripeSubscription = await stripe.subscriptions.update(\n            currentSubscription!.stripeSubscriptionId,\n            {\n              items: [{\n                id: currentSubscription!.stripeSubscriptionId,\n                // Note: In production, you'd need to map planId to Stripe price IDs\n                price: `price_${plan.name.toLowerCase()}` // This would be your actual Stripe price ID\n              }],\n              proration_behavior: 'create_prorations'\n            }\n          );\n\n          // Update local subscription record\n          const stripeSubscription = updatedStripeSubscription as any;\n          await storage.updateSubscription(currentSubscription!.id, {\n            planId: plan.id,\n            currentPeriodStart: new Date((stripeSubscription as any).current_period_start * 1000),\n            currentPeriodEnd: new Date((stripeSubscription as any).current_period_end * 1000),\n            localPrice: plan.priceThb,\n          });\n\n        } catch (stripeError) {\n          console.error('Stripe update failed, falling back to local update:', stripeError);\n          // Fall back to local update if Stripe fails\n          const now = new Date();\n          const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n          \n          await storage.updateSubscription(currentSubscription!.id, {\n            planId: plan.id,\n            currentPeriodStart: now,\n            currentPeriodEnd: endOfMonth,\n            localPrice: plan.priceThb,\n          });\n        }\n      } else {\n        // For demo/development mode - direct upgrade\n        const now = new Date();\n        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n        \n        await storage.updateSubscription(currentSubscription!.id, {\n          planId: plan.id,\n          currentPeriodStart: now,\n          currentPeriodEnd: endOfMonth,\n          localPrice: plan.priceThb,\n        });\n      }\n      \n      // Get the updated subscription with plan details\n      const updatedSubscription = await storage.getUserSubscription(userId);\n      \n      res.json({ \n        message: \"Subscription upgraded successfully\",\n        subscription: updatedSubscription,\n        requiresPayment: !stripe || !currentSubscription!.stripeSubscriptionId\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Payment verification endpoint for frontend\n  app.post(\"/api/subscription/verify-payment\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const { planId } = req.body;\n\n      if (!planId) {\n        return res.status(400).json({ success: false, message: \"Plan ID is required\" });\n      }\n\n      // Get current subscription\n      const currentSubscription = await storage.getUserSubscription(userId);\n      const plan = await storage.getSubscriptionPlan(planId);\n\n      if (!currentSubscription || !plan) {\n        return res.status(404).json({ \n          success: false, \n          message: \"Subscription or plan not found\" \n        });\n      }\n\n      // Check if the plan was successfully updated\n      const isUpdated = currentSubscription.planId === planId;\n      \n      res.json({\n        success: isUpdated,\n        planName: plan.displayName,\n        currentPlan: currentSubscription.plan?.displayName || 'Unknown',\n        message: isUpdated \n          ? \"Plan successfully updated\" \n          : \"Plan update pending - please contact support if this persists\"\n      });\n\n    } catch (error: any) {\n      console.error('Payment verification error:', error);\n      res.status(500).json({ \n        success: false, \n        message: error.message \n      });\n    }\n  });\n\n  // ===== Investment Intelligence Routes =====\n  \n  // Get all investment strategies\n  app.get(\"/api/investments/strategies\", isAuthenticated, async (req: any, res) => {\n    try {\n      const strategies = await storage.getInvestmentStrategies();\n      res.json(strategies);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get investment strategies by category\n  app.get(\"/api/investments/strategies/:category\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { category } = req.params;\n      const strategies = await storage.getInvestmentStrategiesByCategory(category);\n      res.json(strategies);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get all passive income opportunities\n  app.get(\"/api/investments/passive-income\", isAuthenticated, async (req: any, res) => {\n    try {\n      const opportunities = await storage.getPassiveIncomeOpportunities();\n      res.json(opportunities);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get passive income opportunities by category\n  app.get(\"/api/investments/passive-income/:category\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { category } = req.params;\n      const opportunities = await storage.getPassiveIncomeOpportunitiesByCategory(category);\n      res.json(opportunities);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Initialize investment data (seed database) - Development only, automatically runs on server start\n  // This endpoint is disabled in production to prevent unauthorized data manipulation\n  if (process.env.NODE_ENV === 'development') {\n    app.post(\"/api/investments/seed\", isAuthenticated, async (req: any, res) => {\n      try {\n        const { seedInvestments } = await import(\"./seed-investments\");\n        await seedInvestments();\n        res.json({ success: true, message: \"Investment data seeded successfully\" });\n      } catch (error: any) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error(\"Seeding error:\", error);\n        }\n        res.status(500).json({ message: error.message });\n      }\n    });\n  }\n\n  // ===== Crypto Routes =====\n  \n  // Get user's crypto holdings\n  app.get(\"/api/crypto/holdings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const holdings = await storage.getUserCryptoHoldings(userId);\n      \n      // Fetch current prices for all holdings\n      const updatedHoldings = await Promise.all(holdings.map(async (holding) => {\n        try {\n          const priceData = await cryptoService.getCryptoPrice(holding.coinId);\n          if (priceData) {\n            const updatedHolding = await storage.updateCryptoHolding(holding.id, {\n              currentPrice: priceData.current_price.toString(),\n              lastPriceUpdate: new Date()\n            });\n            return { ...updatedHolding, priceChange24h: priceData.price_change_percentage_24h };\n          }\n          return { ...holding, priceChange24h: 0 };\n        } catch (error) {\n          return { ...holding, priceChange24h: 0 };\n        }\n      }));\n      \n      res.json(updatedHoldings);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create new crypto holding\n  app.post(\"/api/crypto/holdings\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertCryptoHoldingSchema.parse({\n        ...req.body,\n        userId\n      });\n      \n      // Fetch initial price\n      const priceData = await cryptoService.getCryptoPrice(validatedData.coinId);\n      if (priceData) {\n        validatedData.currentPrice = priceData.current_price.toString();\n        validatedData.lastPriceUpdate = new Date();\n      }\n      \n      const holding = await storage.createCryptoHolding(validatedData);\n      res.json(holding);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Update crypto holding\n  app.put(\"/api/crypto/holdings/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const holdingId = req.params.id;\n      \n      // Verify ownership\n      const holding = await storage.getCryptoHolding(holdingId);\n      if (!holding || holding.userId !== userId) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      \n      // Validate update data\n      const validatedData = insertCryptoHoldingSchema.partial().parse(req.body);\n      \n      const updatedHolding = await storage.updateCryptoHolding(holdingId, validatedData);\n      res.json(updatedHolding);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Delete crypto holding\n  app.delete(\"/api/crypto/holdings/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const holdingId = req.params.id;\n      \n      // Verify ownership\n      const holding = await storage.getCryptoHolding(holdingId);\n      if (!holding || holding.userId !== userId) {\n        return res.status(404).json({ message: \"Holding not found\" });\n      }\n      \n      await storage.deleteCryptoHolding(holdingId);\n      res.json({ message: \"Holding deleted successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get current prices for multiple cryptos\n  app.get(\"/api/crypto/prices\", async (req, res) => {\n    try {\n      const { ids } = req.query;\n      if (!ids || typeof ids !== 'string') {\n        return res.status(400).json({ message: \"Coin IDs are required\" });\n      }\n      \n      const coinIds = ids.split(',');\n      const prices = await cryptoService.getCryptoPrices(coinIds);\n      res.json(prices);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get price for single crypto\n  app.get(\"/api/crypto/prices/:coinId\", async (req, res) => {\n    try {\n      const { coinId } = req.params;\n      const price = await cryptoService.getCryptoPrice(coinId);\n      \n      if (!price) {\n        return res.status(404).json({ message: \"Cryptocurrency not found\" });\n      }\n      \n      res.json(price);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Search cryptocurrencies\n  app.get(\"/api/crypto/search\", async (req, res) => {\n    try {\n      const { query } = req.query;\n      if (!query || typeof query !== 'string') {\n        return res.status(400).json({ message: \"Search query is required\" });\n      }\n      \n      const results = await cryptoService.searchCrypto(query);\n      res.json(results);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get crypto portfolio summary\n  app.get(\"/api/crypto/portfolio\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const portfolio = await storage.getUserCryptoPortfolioValue(userId);\n      \n      // Update with latest prices\n      const holdingsWithPrices = await Promise.all(\n        portfolio.holdings.map(async (holding) => {\n          try {\n            const coinId = (await storage.getUserCryptoHoldings(userId))\n              .find(h => h.symbol === holding.symbol)?.coinId;\n            \n            if (coinId) {\n              const priceData = await cryptoService.getCryptoPrice(coinId);\n              if (priceData) {\n                const amount = parseFloat(holding.amount);\n                const currentPrice = priceData.current_price;\n                return {\n                  ...holding,\n                  currentPrice: currentPrice.toString(),\n                  value: amount * currentPrice,\n                  change24h: priceData.price_change_percentage_24h || 0\n                };\n              }\n            }\n            return holding;\n          } catch (error) {\n            return holding;\n          }\n        })\n      );\n      \n      const totalValue = holdingsWithPrices.reduce((sum, h) => sum + h.value, 0);\n      res.json({ totalValue, holdings: holdingsWithPrices });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Get user's crypto transactions\n  app.get(\"/api/crypto/transactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 50;\n      const transactions = await storage.getUserCryptoTransactions(userId, limit);\n      res.json(transactions);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create crypto transaction\n  app.post(\"/api/crypto/transactions\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertCryptoTransactionSchema.parse({\n        ...req.body,\n        userId\n      });\n      \n      const transaction = await storage.createCryptoTransaction(validatedData);\n      \n      // Update holding if it's a buy/sell transaction\n      if (transaction.holdingId) {\n        const holding = await storage.getCryptoHolding(transaction.holdingId);\n        if (holding) {\n          const currentAmount = parseFloat(holding.amount);\n          const transactionAmount = parseFloat(transaction.amount);\n          const newAmount = transaction.type === 'buy' \n            ? currentAmount + transactionAmount \n            : currentAmount - transactionAmount;\n          \n          await storage.updateCryptoHolding(transaction.holdingId, {\n            amount: newAmount.toString()\n          });\n        }\n      }\n      \n      res.json(transaction);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Get user's price alerts\n  app.get(\"/api/crypto/alerts\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const alerts = await storage.getUserCryptoPriceAlerts(userId);\n      res.json(alerts);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Create price alert\n  app.post(\"/api/crypto/alerts\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const validatedData = insertCryptoPriceAlertSchema.parse({\n        ...req.body,\n        userId\n      });\n      \n      const alert = await storage.createCryptoPriceAlert(validatedData);\n      res.json(alert);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Update price alert\n  app.put(\"/api/crypto/alerts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const alertId = req.params.id;\n      \n      // Verify ownership\n      const alert = await storage.getCryptoPriceAlert(alertId);\n      if (!alert || alert.userId !== userId) {\n        return res.status(404).json({ message: \"Alert not found\" });\n      }\n      \n      const updatedAlert = await storage.updateCryptoPriceAlert(alertId, req.body);\n      res.json(updatedAlert);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  // Delete price alert\n  app.delete(\"/api/crypto/alerts/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const alertId = req.params.id;\n      \n      // Verify ownership\n      const alert = await storage.getCryptoPriceAlert(alertId);\n      if (!alert || alert.userId !== userId) {\n        return res.status(404).json({ message: \"Alert not found\" });\n      }\n      \n      await storage.deleteCryptoPriceAlert(alertId);\n      res.json({ message: \"Alert deleted successfully\" });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Stripe Webhook Handler for payment completion\n  // Stripe automatically retries webhooks on 5xx errors with exponential backoff\n  app.post('/api/webhooks/stripe', async (req, res) => {\n    try {\n      if (!stripe) {\n        stripeLogger.warn('Webhook received but Stripe not configured');\n        return res.status(503).json({ message: \"Stripe not configured\" });\n      }\n\n      const sig = req.headers['stripe-signature'];\n      const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET;\n      let event: any;\n\n      try {\n        if (endpointSecret && sig) {\n          event = stripe.webhooks.constructEvent(req.body, sig, endpointSecret);\n        } else if (process.env.NODE_ENV === 'development') {\n          stripeLogger.warn('Webhook signature verification disabled in development');\n          event = JSON.parse(req.body.toString());\n        } else {\n          stripeLogger.error('Webhook secret required in production');\n          return res.status(401).json({ \n            error: \"Webhook secret required for signature verification\" \n          });\n        }\n      } catch (err: any) {\n        stripeLogger.error('Webhook signature verification failed', err);\n        return res.status(400).send(`Webhook Error: ${err.message}`);\n      }\n\n      // Idempotency check - prevent duplicate processing (database-backed for persistence)\n      const isProcessed = await storage.isWebhookEventProcessed(event.id);\n      if (isProcessed) {\n        stripeLogger.info('Duplicate webhook event received', { data: { eventId: event.id, type: event.type } });\n        return res.json({ received: true, duplicate: true });\n      }\n      \n      // Mark event as processed before handling to prevent race conditions\n      await storage.markWebhookEventProcessed(event.id, event.type);\n\n      stripeLogger.info('Processing webhook event', { data: { eventId: event.id, type: event.type } });\n\n      // Handle the event\n      switch (event.type) {\n        case 'checkout.session.completed':\n          const session = event.data.object;\n          await handleCheckoutSessionCompleted(session);\n          break;\n\n        case 'customer.subscription.created':\n          const createdSubscription = event.data.object;\n          await handleSubscriptionCreated(createdSubscription);\n          break;\n\n        case 'customer.subscription.updated':\n          const updatedSubscription = event.data.object;\n          await handleSubscriptionUpdated(updatedSubscription);\n          break;\n\n        case 'customer.subscription.deleted':\n          const deletedSubscription = event.data.object;\n          await handleSubscriptionDeleted(deletedSubscription);\n          break;\n\n        case 'payment_intent.succeeded':\n          const paymentIntent = event.data.object;\n          await handlePaymentSuccess(paymentIntent);\n          break;\n        \n        case 'invoice.payment_succeeded':\n          const invoice = event.data.object;\n          await handleSubscriptionPaymentSuccess(invoice);\n          break;\n          \n        default:\n          stripeLogger.debug('Unhandled event type', { data: { type: event.type } });\n      }\n\n      res.json({ received: true });\n    } catch (error: any) {\n      // Log error and return 500 to trigger Stripe's automatic retry\n      stripeLogger.error('Webhook processing failed - Stripe will retry', error, { data: { eventId: (req.body as any)?.id } });\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Referral System API routes\n  app.get(\"/api/referrals/my-code\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      let referralCode = await storage.getUserReferralCode(userId);\n      \n      // Create referral code if user doesn't have one\n      if (!referralCode) {\n        const code = `${(user.firstName || user.email?.split('@')[0] || 'USER').toUpperCase()}${Math.random().toString(36).substring(2, 6).toUpperCase()}`;\n        referralCode = await storage.createReferralCode({\n          userId: userId,\n          code: code,\n          maxUses: 100,\n          currentUses: 0,\n          isActive: true\n        });\n      }\n      \n      res.json(referralCode);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/referrals/use-code\", isAuthenticated, async (req: any, res) => {\n    try {\n      const { referralCode } = req.body;\n      if (!referralCode) {\n        return res.status(400).json({ message: \"Referral code is required\" });\n      }\n\n      const userId = getUserIdFromRequest(req);\n      \n      // Process the referral\n      const referral = await storage.processReferral(userId, referralCode);\n      \n      // Add bonus credits for the referred user (10 AI chats)\n      await storage.addBonusCredits({\n        userId: userId,\n        amount: 10,\n        source: \"referral_signup\",\n        referralId: referral.id,\n        description: \"Welcome bonus: 10 AI chats for using referral code\"\n      });\n\n      // Add bonus credits for the referrer (10 AI chats)\n      await storage.addBonusCredits({\n        userId: referral.referrerUserId,\n        amount: 10,\n        source: \"referral_made\",\n        referralId: referral.id,\n        description: \"Referral bonus: 10 AI chats for successful referral\"\n      });\n      \n      res.json({ \n        success: true, \n        bonusCredits: 10,\n        message: \"Referral successful! You and your friend both received 10 bonus AI chats!\"\n      });\n    } catch (error: any) {\n      res.status(400).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/referrals/my-referrals\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const referrals = await storage.getUserReferrals(userId);\n      res.json(referrals);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/referrals/bonus-credits\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const [credits, availableAmount] = await Promise.all([\n        storage.getUserBonusCredits(userId),\n        storage.getAvailableBonusCredits(userId)\n      ]);\n      \n      res.json({\n        credits,\n        availableAmount\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/referrals/validate-code\", async (req, res) => {\n    try {\n      const { code } = req.body;\n      if (!code) {\n        return res.status(400).json({ message: \"Referral code is required\" });\n      }\n      \n      const referralCode = await storage.getReferralByCode(code);\n      if (!referralCode) {\n        return res.status(404).json({ message: \"Invalid referral code\" });\n      }\n      \n      const currentUses = referralCode.currentUses ?? 0;\n      const maxUses = referralCode.maxUses ?? 100;\n      \n      if (currentUses >= maxUses) {\n        return res.status(400).json({ message: \"Referral code has reached maximum uses\" });\n      }\n      \n      res.json({ \n        valid: true, \n        usesRemaining: maxUses - currentUses \n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Helper function to handle successful payment intent\n  async function handlePaymentSuccess(paymentIntent: any) {\n    try {\n      const { userId, planId } = paymentIntent.metadata;\n      \n      if (!userId || !planId) {\n        console.error('Missing metadata in payment intent:', paymentIntent.id);\n        return;\n      }\n\n      // Get the plan and user subscription\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        console.error('Plan not found:', planId);\n        return;\n      }\n\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        // Initialize default subscription if none exists\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      if (currentSubscription) {\n        // Update the subscription to the new plan\n        const now = new Date();\n        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n        \n        await storage.updateSubscription(currentSubscription.id, {\n          planId: plan.id,\n          status: 'active',\n          currentPeriodStart: now,\n          currentPeriodEnd: endOfMonth,\n          localPrice: plan.priceThb,\n          localCurrency: 'THB'\n        });\n\n        stripeLogger.info('User upgraded after payment', { data: { userId, planName: plan.name, paymentId: paymentIntent.id } });\n      }\n    } catch (error) {\n      console.error('Error handling payment success:', error);\n    }\n  }\n\n  // Helper function to handle successful subscription payment\n  async function handleSubscriptionPaymentSuccess(invoice: any) {\n    try {\n      const subscription = invoice.subscription;\n      const { userId, planId } = invoice.metadata || {};\n      \n      if (!userId || !planId) {\n        console.error('Missing metadata in invoice:', invoice.id);\n        return;\n      }\n\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        console.error('Plan not found:', planId);\n        return;\n      }\n\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (currentSubscription) {\n        const subscriptionDetails = await stripe!.subscriptions.retrieve(subscription);\n        \n        await storage.updateSubscription(currentSubscription.id, {\n          planId: plan.id,\n          status: 'active',\n          stripeSubscriptionId: subscription,\n          currentPeriodStart: new Date((subscriptionDetails as any).current_period_start * 1000),\n          currentPeriodEnd: new Date((subscriptionDetails as any).current_period_end * 1000),\n          localPrice: plan.priceThb,\n          localCurrency: 'THB'\n        });\n\n        stripeLogger.info('Subscription updated', { data: { subscriptionId: subscription, userId, planName: plan.name } });\n      }\n    } catch (error) {\n      console.error('Error handling subscription payment success:', error);\n    }\n  }\n\n  // Handle Stripe Checkout session completion (primary subscription activation path)\n  async function handleCheckoutSessionCompleted(session: any) {\n    try {\n      const { userId, planId } = session.metadata || {};\n      \n      if (!userId || !planId) {\n        console.error('Missing metadata in checkout session:', session.id);\n        return;\n      }\n\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        console.error('Plan not found:', planId);\n        return;\n      }\n\n      // Get the subscription object from the session\n      const subscriptionId = session.subscription;\n      if (!subscriptionId) {\n        console.error('No subscription ID in checkout session:', session.id);\n        return;\n      }\n\n      const stripeSubscription = await stripe!.subscriptions.retrieve(subscriptionId as string);\n\n      // Ensure user has a subscription record\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      // Verify subscription was created\n      if (!currentSubscription) {\n        console.error('Failed to create default subscription for user:', userId);\n        return;\n      }\n\n      // Now safe to update\n      await storage.updateSubscription(currentSubscription.id, {\n        planId: plan.id,\n        status: 'active',\n        stripeSubscriptionId: subscriptionId as string,\n        stripeCustomerId: session.customer,\n        currentPeriodStart: new Date((stripeSubscription as any).current_period_start * 1000),\n        currentPeriodEnd: new Date((stripeSubscription as any).current_period_end * 1000),\n        localPrice: plan.priceUsd,\n        localCurrency: 'USD'\n      });\n\n      stripeLogger.info('Subscription activated via checkout', { data: { subscriptionId, userId, sessionId: session.id } });\n    } catch (error) {\n      console.error('Error handling checkout session completed:', error);\n    }\n  }\n\n  // Handle subscription creation (backup handler)\n  async function handleSubscriptionCreated(subscription: any) {\n    try {\n      const { userId, planId } = subscription.metadata || {};\n      \n      if (!userId || !planId) {\n        stripeLogger.debug('No metadata in subscription, skipping');\n        return;\n      }\n\n      const plan = await storage.getSubscriptionPlan(planId);\n      if (!plan) {\n        console.error('Plan not found:', planId);\n        return;\n      }\n\n      let currentSubscription = await storage.getUserSubscription(userId);\n      if (!currentSubscription) {\n        await storage.initializeDefaultSubscription(userId);\n        currentSubscription = await storage.getUserSubscription(userId);\n      }\n\n      if (currentSubscription) {\n        await storage.updateSubscription(currentSubscription.id, {\n          planId: plan.id,\n          status: subscription.status === 'active' || subscription.status === 'trialing' ? 'active' : subscription.status,\n          stripeSubscriptionId: subscription.id,\n          stripeCustomerId: subscription.customer,\n          currentPeriodStart: new Date(subscription.current_period_start * 1000),\n          currentPeriodEnd: new Date(subscription.current_period_end * 1000),\n          localPrice: plan.priceUsd,\n          localCurrency: 'USD'\n        });\n\n        stripeLogger.info('Subscription created', { data: { subscriptionId: subscription.id, userId } });\n      }\n    } catch (error) {\n      console.error('Error handling subscription created:', error);\n    }\n  }\n\n  // Handle subscription updates (renewals, plan changes)\n  async function handleSubscriptionUpdated(subscription: any) {\n    try {\n      // Find subscription by Stripe subscription ID\n      const currentSubscription = await storage.getSubscriptionByStripeId(subscription.id);\n      \n      if (!currentSubscription) {\n        stripeLogger.debug('Subscription not found in database, ignoring update', { data: { subscriptionId: subscription.id } });\n        return;\n      }\n\n      // Get the plan from subscription items (first item's price)\n      const priceId = subscription.items?.data?.[0]?.price?.id;\n      if (!priceId) {\n        console.error('No price ID in subscription:', subscription.id);\n        return;\n      }\n\n      // Find the plan with matching Stripe price ID\n      const plans = await storage.getSubscriptionPlans();\n      const plan = plans.find(p => p.stripePriceId === priceId);\n      \n      if (!plan) {\n        console.error('Plan not found for price ID:', priceId);\n        console.error('Available plans:', plans.map(p => ({ name: p.name, stripePriceId: p.stripePriceId })));\n        console.error('This may indicate STRIPE_PRO_PRICE_ID or STRIPE_ENTERPRISE_PRICE_ID environment variables are not configured.');\n        // Downgrade to free plan as fallback\n        const freePlan = plans.find(p => p.name.toLowerCase() === 'free');\n        if (!freePlan) {\n          console.error('Free plan not found, cannot downgrade');\n          return;\n        }\n        stripeLogger.info('Downgrading subscription to Free plan', { data: { subscriptionId: subscription.id } });\n        await storage.updateSubscription(currentSubscription.id, {\n          planId: freePlan.id,\n          status: 'active',\n          currentPeriodStart: new Date(subscription.current_period_start * 1000),\n          currentPeriodEnd: new Date(subscription.current_period_end * 1000),\n          localPrice: freePlan.priceUsd,\n          localCurrency: 'USD'\n        });\n        return;\n      }\n\n      await storage.updateSubscription(currentSubscription.id, {\n        planId: plan.id,\n        status: subscription.status === 'active' || subscription.status === 'trialing' ? 'active' : subscription.status,\n        currentPeriodStart: new Date(subscription.current_period_start * 1000),\n        currentPeriodEnd: new Date(subscription.current_period_end * 1000),\n        localPrice: plan.priceUsd,\n        localCurrency: 'USD'\n      });\n\n      stripeLogger.info('Subscription plan updated', { data: { subscriptionId: subscription.id, planName: plan.name } });\n    } catch (error) {\n      console.error('Error handling subscription updated:', error);\n    }\n  }\n\n  // Handle subscription deletion (cancellation/expiration)\n  async function handleSubscriptionDeleted(subscription: any) {\n    try {\n      // Find subscription by Stripe subscription ID\n      const currentSubscription = await storage.getSubscriptionByStripeId(subscription.id);\n      \n      if (!currentSubscription) {\n        stripeLogger.debug('Subscription not found, ignoring deletion', { data: { subscriptionId: subscription.id } });\n        return;\n      }\n\n      // Get Free plan\n      const plans = await storage.getSubscriptionPlans();\n      const freePlan = plans.find(p => p.name.toLowerCase() === 'free');\n      \n      if (!freePlan) {\n        console.error('Free plan not found for downgrade');\n        return;\n      }\n\n      // Downgrade to Free plan\n      await storage.updateSubscription(currentSubscription.id, {\n        planId: freePlan.id,\n        status: 'cancelled',\n        cancelledAt: new Date(),\n        localPrice: freePlan.priceUsd,\n        localCurrency: 'USD'\n      });\n\n      stripeLogger.info('Subscription cancelled, downgraded to Free', { data: { subscriptionId: subscription.id } });\n    } catch (error) {\n      console.error('Error handling subscription deleted:', error);\n    }\n  }\n\n  // Currency Exchange Rates API\n  let cachedRates: any = null;\n  let ratesCacheTime = 0;\n  const RATES_CACHE_TTL = 60 * 60 * 1000; // Cache for 1 hour\n\n  app.get(\"/api/currency/rates\", async (req, res) => {\n    try {\n      // Return cached rates if still valid\n      if (cachedRates && Date.now() - ratesCacheTime < RATES_CACHE_TTL) {\n        return res.json(cachedRates);\n      }\n\n      // Fetch live rates from exchangerate-api.com (free tier)\n      const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');\n      \n      if (!response.ok) {\n        throw new Error('Failed to fetch exchange rates');\n      }\n\n      const data = await response.json();\n      \n      // Extract only the currencies we support\n      const supportedCurrencies = ['USD', 'THB', 'EUR', 'IDR', 'INR', 'BRL', 'MXN', 'GBP', 'JPY', 'CAD', 'AUD', 'VND', 'PHP', 'MYR', 'TRY'];\n      const rates: Record<string, number> = {};\n      \n      supportedCurrencies.forEach(currency => {\n        rates[currency] = data.rates[currency] || 1;\n      });\n\n      cachedRates = {\n        rates,\n        lastUpdated: data.date || new Date().toISOString(),\n        base: 'USD'\n      };\n      ratesCacheTime = Date.now();\n\n      res.json(cachedRates);\n    } catch (error: any) {\n      console.error('Currency API Error:', error);\n      // Return fallback rates if API fails\n      res.json({\n        rates: {\n          USD: 1.00,\n          THB: 33.50,\n          EUR: 0.85,\n          IDR: 15200,\n          INR: 83.10,\n          BRL: 5.20,\n          MXN: 18.00,\n          GBP: 0.78,\n          JPY: 150.00,\n          CAD: 1.35,\n          AUD: 1.50,\n          VND: 24000,\n          PHP: 56.00,\n          MYR: 4.65,\n          TRY: 29.50,\n        },\n        lastUpdated: new Date().toISOString(),\n        base: 'USD',\n        fallback: true\n      });\n    }\n  });\n\n  // ==================== AI PLAYBOOKS ROUTES ====================\n  \n  // Get user's playbooks\n  app.get(\"/api/playbooks\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const limit = parseInt(req.query.limit as string) || 10;\n      const playbooks = await storage.getPlaybooksByUserId(userId, limit);\n      res.json(playbooks);\n    } catch (error: any) {\n      console.error('Error fetching playbooks:', error);\n      res.status(500).json({ message: 'Failed to fetch playbooks' });\n    }\n  });\n\n  // Generate new weekly playbook\n  app.post(\"/api/playbooks/generate\", playbookLimiter, isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      // Get user's subscription to determine tier\n      const subscriptionData = await storage.getUserSubscription(userId);\n      const tier = subscriptionData?.plan.name.toLowerCase() as 'free' | 'pro' | 'enterprise' || 'free';\n\n      // Import playbook service\n      const { generateWeeklyPlaybook } = await import('./playbookService');\n      \n      // Generate playbook\n      const playbookData = await generateWeeklyPlaybook(userId, storage, tier);\n      \n      // Save to database\n      const playbook = await storage.createPlaybook({\n        ...playbookData,\n        subscriptionId: subscriptionData?.id || null,\n      });\n\n      res.json(playbook);\n    } catch (error: any) {\n      console.error('Error generating playbook:', error);\n      res.status(500).json({ message: 'Failed to generate playbook', error: error.message });\n    }\n  });\n\n  // Get specific playbook by ID\n  app.get(\"/api/playbooks/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const playbook = await storage.getPlaybook(req.params.id);\n      \n      if (!playbook) {\n        return res.status(404).json({ message: 'Playbook not found' });\n      }\n      \n      // Verify ownership\n      if (playbook.userId !== userId) {\n        return res.status(403).json({ message: 'Unauthorized' });\n      }\n      \n      // Mark as viewed if not already\n      if (!playbook.isViewed) {\n        await storage.markPlaybookViewed(req.params.id);\n        playbook.isViewed = true;\n        playbook.viewedAt = new Date();\n      }\n      \n      res.json(playbook);\n    } catch (error: any) {\n      console.error('Error fetching playbook:', error);\n      res.status(500).json({ message: 'Failed to fetch playbook' });\n    }\n  });\n\n  // Zod schema for action completion validation\n  const completeActionSchema = z.object({\n    actionIndex: z.number().int().min(0).max(100),\n    estimatedSavings: z.number().min(0).max(100000).optional(),\n  });\n\n  // Mark playbook action as complete\n  app.post(\"/api/playbooks/:id/complete-action\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      // Validate request body\n      const validationResult = completeActionSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          message: 'Invalid request body',\n          errors: validationResult.error.flatten().fieldErrors \n        });\n      }\n      \n      const { actionIndex, estimatedSavings } = validationResult.data;\n\n      const playbook = await storage.getPlaybook(req.params.id);\n      \n      if (!playbook) {\n        return res.status(404).json({ message: 'Playbook not found' });\n      }\n      \n      // Verify ownership\n      if (playbook.userId !== userId) {\n        return res.status(403).json({ message: 'Unauthorized' });\n      }\n      \n      // Get current completed action indices (prevent duplicate completions)\n      const completedIndices: number[] = Array.isArray(playbook.completedActionIndices) \n        ? playbook.completedActionIndices as number[]\n        : [];\n      \n      // Check if action was already completed\n      if (completedIndices.includes(actionIndex)) {\n        return res.status(409).json({ \n          message: 'Action already completed', \n          alreadyCompleted: true \n        });\n      }\n      \n      // Update playbook with completed action\n      const newCompletedIndices = [...completedIndices, actionIndex];\n      const newActionsCompleted = newCompletedIndices.length;\n      const newRoiSavings = parseFloat(playbook.roiSavings?.toString() || '0') + (estimatedSavings || 0);\n      const newCumulativeRoi = parseFloat(playbook.cumulativeRoi?.toString() || '0') + (estimatedSavings || 0);\n      \n      const updatedPlaybook = await storage.updatePlaybook(req.params.id, {\n        actionsCompleted: newActionsCompleted,\n        completedActionIndices: newCompletedIndices,\n        roiSavings: newRoiSavings.toFixed(2),\n        cumulativeRoi: newCumulativeRoi.toFixed(2),\n      });\n      \n      res.json(updatedPlaybook);\n    } catch (error: any) {\n      console.error('Error completing action:', error);\n      res.status(500).json({ message: 'Failed to complete action' });\n    }\n  });\n\n  // Delete playbook\n  app.delete(\"/api/playbooks/:id\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserIdFromRequest(req);\n      const playbook = await storage.getPlaybook(req.params.id);\n      \n      if (!playbook) {\n        return res.status(404).json({ message: 'Playbook not found' });\n      }\n      \n      // Verify ownership\n      if (playbook.userId !== userId) {\n        return res.status(403).json({ message: 'Unauthorized' });\n      }\n      \n      await storage.deletePlaybook(req.params.id);\n      res.json({ message: 'Playbook deleted successfully' });\n    } catch (error: any) {\n      console.error('Error deleting playbook:', error);\n      res.status(500).json({ message: 'Failed to delete playbook' });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":281428,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\ninterface SkeletonProps extends React.HTMLAttributes<HTMLDivElement> {\n  className?: string;\n  variant?: 'default' | 'text' | 'heading' | 'avatar' | 'button' | 'card';\n}\n\nfunction Skeleton({ className, variant = 'default', ...props }: SkeletonProps) {\n  const variantClasses = {\n    default: '',\n    text: 'h-4',\n    heading: 'h-6',\n    avatar: 'rounded-full',\n    button: 'h-10 rounded-lg',\n    card: 'rounded-xl',\n  };\n\n  return (\n    <div\n      className={cn(\n        \"skeleton rounded-md bg-muted/60 dark:bg-muted/30\",\n        variantClasses[variant],\n        className\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction SkeletonCard() {\n  return (\n    <div className=\"rounded-xl border bg-card p-6 shadow-sm\">\n      <div className=\"space-y-3\">\n        <Skeleton className=\"h-5 w-2/5\" />\n        <Skeleton className=\"h-8 w-3/5\" />\n        <Skeleton className=\"h-4 w-1/3\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonTable({ rows = 5 }: { rows?: number }) {\n  return (\n    <div className=\"space-y-3\">\n      {[...Array(rows)].map((_, i) => (\n        <div key={i} className=\"flex items-center gap-4 p-4 rounded-lg border bg-card\">\n          <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n          <div className=\"flex-1 space-y-2\">\n            <Skeleton className=\"h-4 w-full max-w-[200px]\" />\n            <Skeleton className=\"h-3 w-3/4 max-w-[150px]\" />\n          </div>\n          <Skeleton className=\"h-9 w-20\" />\n        </div>\n      ))}\n    </div>\n  );\n}\n\nfunction SkeletonStat() {\n  return (\n    <div className=\"rounded-xl border bg-card p-5 md:p-6 shadow-sm\">\n      <div className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <Skeleton className=\"h-4 w-24\" />\n          <Skeleton className=\"h-8 w-8 rounded-lg\" />\n        </div>\n        <Skeleton className=\"h-9 w-32\" />\n        <div className=\"flex items-center gap-2\">\n          <Skeleton className=\"h-3 w-12\" />\n          <Skeleton className=\"h-3 w-16\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nconst CHART_HEIGHTS = [75, 45, 60, 80, 55, 70, 50, 85, 65, 72, 58, 68];\n\nfunction SkeletonChart() {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-end gap-2 h-48 px-2\">\n        {CHART_HEIGHTS.map((height, i) => (\n          <Skeleton \n            key={i} \n            className=\"flex-1 rounded-t-md\" \n            style={{ height: `${height}%` }}\n          />\n        ))}\n      </div>\n      <div className=\"flex justify-between px-2\">\n        {[...Array(6)].map((_, i) => (\n          <Skeleton key={i} className=\"h-3 w-8\" />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonLineChart() {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"h-48 relative\">\n        <Skeleton className=\"absolute inset-0 rounded-lg\" />\n      </div>\n      <div className=\"flex justify-between px-2\">\n        {[...Array(7)].map((_, i) => (\n          <Skeleton key={i} className=\"h-3 w-10\" />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonPieChart() {\n  return (\n    <div className=\"flex items-center justify-center gap-8\">\n      <Skeleton className=\"h-40 w-40 rounded-full\" />\n      <div className=\"space-y-3\">\n        {[...Array(4)].map((_, i) => (\n          <div key={i} className=\"flex items-center gap-2\">\n            <Skeleton className=\"h-3 w-3 rounded-full\" />\n            <Skeleton className=\"h-3 w-20\" />\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonEvent() {\n  return (\n    <div className=\"rounded-xl border p-4 bg-card\">\n      <div className=\"flex items-start gap-3\">\n        <Skeleton className=\"h-12 w-12 rounded-lg flex-shrink-0\" />\n        <div className=\"flex-1 space-y-2\">\n          <Skeleton className=\"h-4 w-3/4\" />\n          <Skeleton className=\"h-3 w-1/2\" />\n          <Skeleton className=\"h-3 w-1/3\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonTransaction() {\n  return (\n    <div className=\"flex items-center justify-between p-4 border-b last:border-0 hover:bg-muted/20\">\n      <div className=\"flex items-center gap-3\">\n        <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n        <div className=\"space-y-2\">\n          <Skeleton className=\"h-4 w-32\" />\n          <Skeleton className=\"h-3 w-24\" />\n        </div>\n      </div>\n      <div className=\"text-right space-y-2\">\n        <Skeleton className=\"h-5 w-20 ml-auto\" />\n        <Skeleton className=\"h-3 w-16 ml-auto\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonGoal() {\n  return (\n    <div className=\"rounded-xl border bg-card p-6 shadow-sm space-y-4\">\n      <div className=\"flex items-start justify-between\">\n        <div className=\"space-y-2 flex-1\">\n          <Skeleton className=\"h-5 w-2/3\" />\n          <Skeleton className=\"h-4 w-1/3\" />\n        </div>\n        <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n      </div>\n      <Skeleton className=\"h-2.5 w-full rounded-full\" />\n      <div className=\"flex justify-between\">\n        <Skeleton className=\"h-4 w-24\" />\n        <Skeleton className=\"h-4 w-24\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonConversation() {\n  return (\n    <div className=\"rounded-xl border bg-card p-4 space-y-4\">\n      <div className=\"flex items-center gap-3\">\n        <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n        <div className=\"flex-1 space-y-2\">\n          <Skeleton className=\"h-4 w-32\" />\n          <Skeleton className=\"h-3 w-20\" />\n        </div>\n        <Skeleton className=\"h-6 w-6 rounded-full\" />\n      </div>\n      <Skeleton className=\"h-4 w-full\" />\n      <Skeleton className=\"h-4 w-4/5\" />\n    </div>\n  );\n}\n\nfunction SkeletonMessage({ isUser = false }: { isUser?: boolean }) {\n  return (\n    <div className={cn(\"flex gap-3\", isUser && \"flex-row-reverse\")}>\n      <Skeleton className=\"h-8 w-8 rounded-full flex-shrink-0\" />\n      <div className={cn(\"space-y-2 max-w-[70%]\", isUser && \"items-end\")}>\n        <Skeleton className={cn(\"h-20 w-64 rounded-xl\", isUser ? \"rounded-tr-sm\" : \"rounded-tl-sm\")} />\n        <Skeleton className=\"h-3 w-16\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonBudget() {\n  return (\n    <div className=\"rounded-xl border bg-card p-6 shadow-sm space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-3\">\n          <Skeleton className=\"h-10 w-10 rounded-lg\" />\n          <div className=\"space-y-2\">\n            <Skeleton className=\"h-5 w-28\" />\n            <Skeleton className=\"h-3 w-20\" />\n          </div>\n        </div>\n        <div className=\"text-right space-y-2\">\n          <Skeleton className=\"h-5 w-24\" />\n          <Skeleton className=\"h-3 w-16 ml-auto\" />\n        </div>\n      </div>\n      <Skeleton className=\"h-2.5 w-full rounded-full\" />\n      <div className=\"flex justify-between\">\n        <Skeleton className=\"h-3 w-20\" />\n        <Skeleton className=\"h-3 w-24\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonCryptoCard() {\n  return (\n    <div className=\"rounded-xl border bg-card p-6 shadow-sm space-y-4\">\n      <div className=\"flex items-center gap-3\">\n        <Skeleton className=\"h-12 w-12 rounded-full\" />\n        <div className=\"flex-1 space-y-2\">\n          <Skeleton className=\"h-5 w-24\" />\n          <Skeleton className=\"h-4 w-16\" />\n        </div>\n        <div className=\"text-right space-y-2\">\n          <Skeleton className=\"h-6 w-28\" />\n          <Skeleton className=\"h-4 w-20 ml-auto\" />\n        </div>\n      </div>\n      <SkeletonLineChart />\n    </div>\n  );\n}\n\nfunction SkeletonAvatar({ size = 'md' }: { size?: 'sm' | 'md' | 'lg' | 'xl' }) {\n  const sizeClasses = {\n    sm: 'h-8 w-8',\n    md: 'h-10 w-10',\n    lg: 'h-14 w-14',\n    xl: 'h-20 w-20',\n  };\n  \n  return <Skeleton className={cn(\"rounded-full flex-shrink-0\", sizeClasses[size])} />;\n}\n\nfunction SkeletonButton({ size = 'md' }: { size?: 'sm' | 'md' | 'lg' }) {\n  const sizeClasses = {\n    sm: 'h-8 w-20',\n    md: 'h-10 w-28',\n    lg: 'h-12 w-36',\n  };\n  \n  return <Skeleton className={cn(\"rounded-lg\", sizeClasses[size])} />;\n}\n\nfunction SkeletonInput() {\n  return <Skeleton className=\"h-10 w-full rounded-lg\" />;\n}\n\nfunction SkeletonTextarea() {\n  return <Skeleton className=\"h-24 w-full rounded-lg\" />;\n}\n\nfunction SkeletonDashboard() {\n  return (\n    <div className=\"w-full space-y-8 px-4 sm:px-6 lg:px-8 xl:px-12 py-6\">\n      <div className=\"space-y-2\">\n        <Skeleton className=\"h-8 w-48\" />\n        <Skeleton className=\"h-4 w-64\" />\n      </div>\n      \n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6\">\n        {[...Array(4)].map((_, i) => (\n          <SkeletonStat key={i} />\n        ))}\n      </div>\n      \n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <div className=\"rounded-xl border bg-card p-6 shadow-sm\">\n          <Skeleton className=\"h-6 w-32 mb-6\" />\n          <SkeletonChart />\n        </div>\n        <div className=\"rounded-xl border bg-card p-6 shadow-sm\">\n          <Skeleton className=\"h-6 w-40 mb-6\" />\n          <div className=\"space-y-1\">\n            {[...Array(5)].map((_, i) => (\n              <SkeletonTransaction key={i} />\n            ))}\n          </div>\n        </div>\n      </div>\n      \n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {[...Array(3)].map((_, i) => (\n          <SkeletonGoal key={i} />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonPage() {\n  return (\n    <div className=\"flex items-center justify-center min-h-[60vh]\">\n      <div className=\"space-y-4 text-center\">\n        <div className=\"inline-block\">\n          <Skeleton className=\"h-12 w-12 rounded-full mx-auto\" />\n        </div>\n        <Skeleton className=\"h-4 w-32 mx-auto\" />\n        <Skeleton className=\"h-3 w-24 mx-auto\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonList({ count = 5 }: { count?: number }) {\n  return (\n    <div className=\"space-y-3\">\n      {[...Array(count)].map((_, i) => (\n        <div key={i} className=\"flex items-center gap-4 p-4 rounded-xl border bg-card\">\n          <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n          <div className=\"flex-1 space-y-2\">\n            <Skeleton className=\"h-4 w-3/4\" />\n            <Skeleton className=\"h-3 w-1/2\" />\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\nfunction SkeletonCalendar() {\n  return (\n    <div className=\"rounded-xl border bg-card p-6 shadow-sm space-y-4\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <Skeleton className=\"h-6 w-32\" />\n        <div className=\"flex gap-2\">\n          <Skeleton className=\"h-8 w-8 rounded-lg\" />\n          <Skeleton className=\"h-8 w-8 rounded-lg\" />\n        </div>\n      </div>\n      <div className=\"grid grid-cols-7 gap-2\">\n        {[...Array(7)].map((_, i) => (\n          <Skeleton key={i} className=\"h-4 w-full\" />\n        ))}\n        {[...Array(35)].map((_, i) => (\n          <Skeleton key={i} className=\"h-10 w-full rounded-lg\" />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonForm() {\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"space-y-2\">\n        <Skeleton className=\"h-4 w-20\" />\n        <SkeletonInput />\n      </div>\n      <div className=\"space-y-2\">\n        <Skeleton className=\"h-4 w-24\" />\n        <SkeletonInput />\n      </div>\n      <div className=\"space-y-2\">\n        <Skeleton className=\"h-4 w-28\" />\n        <SkeletonTextarea />\n      </div>\n      <div className=\"flex justify-end gap-3\">\n        <SkeletonButton size=\"md\" />\n        <SkeletonButton size=\"md\" />\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonProfile() {\n  return (\n    <div className=\"rounded-xl border bg-card p-8 shadow-sm\">\n      <div className=\"flex flex-col items-center text-center space-y-4\">\n        <SkeletonAvatar size=\"xl\" />\n        <div className=\"space-y-2\">\n          <Skeleton className=\"h-6 w-40 mx-auto\" />\n          <Skeleton className=\"h-4 w-32 mx-auto\" />\n        </div>\n        <div className=\"flex gap-4 pt-4\">\n          <SkeletonButton size=\"sm\" />\n          <SkeletonButton size=\"sm\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction SkeletonNotification() {\n  return (\n    <div className=\"flex items-start gap-3 p-4 rounded-xl border bg-card\">\n      <Skeleton className=\"h-10 w-10 rounded-full flex-shrink-0\" />\n      <div className=\"flex-1 space-y-2\">\n        <Skeleton className=\"h-4 w-4/5\" />\n        <Skeleton className=\"h-3 w-3/5\" />\n        <Skeleton className=\"h-3 w-20\" />\n      </div>\n      <Skeleton className=\"h-2 w-2 rounded-full\" />\n    </div>\n  );\n}\n\nexport {\n  Skeleton,\n  SkeletonCard,\n  SkeletonTable,\n  SkeletonStat,\n  SkeletonChart,\n  SkeletonLineChart,\n  SkeletonPieChart,\n  SkeletonEvent,\n  SkeletonTransaction,\n  SkeletonGoal,\n  SkeletonConversation,\n  SkeletonMessage,\n  SkeletonBudget,\n  SkeletonCryptoCard,\n  SkeletonAvatar,\n  SkeletonButton,\n  SkeletonInput,\n  SkeletonTextarea,\n  SkeletonDashboard,\n  SkeletonPage,\n  SkeletonList,\n  SkeletonCalendar,\n  SkeletonForm,\n  SkeletonProfile,\n  SkeletonNotification,\n};\n","path":null,"size_bytes":13013,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from\"react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n ({ className, type, ...props }, ref) => {\n  return (\n   <input\n    type={type}\n    className={cn(\n    \"flex h-12 min-h-[44px] w-full rounded-lg border border-input bg-background px-3 py-2 text-base ring-offset-background transition-all duration-150 file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:border-primary focus-visible:ring-2 focus-visible:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n     className\n    )}\n    ref={ref}\n    {...props}\n   />\n  )\n }\n)\nInput.displayName =\"Input\"\n\nexport { Input }\n","path":null,"size_bytes":793,"size_tokens":null},"client/src/components/dashboard/notifications-bell.tsx":{"content":"import { useState, useEffect } from\"react\";\nimport { \n Bell, \n Check, \n Trash2, \n Target, \n Wallet, \n AlertTriangle, \n Trophy, \n Lightbulb,\n Sparkles,\n X\n} from\"lucide-react\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Button } from\"@/components/ui/button\";\nimport {\n Popover,\n PopoverContent,\n PopoverTrigger,\n} from\"@/components/ui/popover\";\nimport { ScrollArea } from\"@/components/ui/scroll-area\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport NotificationActions from\"./notification-actions\";\nimport { cn } from\"@/lib/utils\";\nimport { motion, AnimatePresence } from\"framer-motion\";\n\ninterface Notification {\n id: string;\n type: string;\n title: string;\n message: string;\n priority:\"low\" |\"normal\" |\"high\" |\"urgent\";\n category:\"goals\" |\"transactions\" |\"budget\" |\"achievements\" |\"suggestions\";\n isRead: boolean;\n actionType?: string;\n actionData?: any;\n data?: any;\n createdAt: string;\n}\n\ninterface NotificationAction {\n type: string;\n data: any;\n}\n\nexport default function NotificationsBell() {\n const [isOpen, setIsOpen] = useState(false);\n const { toast } = useToast();\n\n const { data: notifications = [], isLoading } = useQuery<Notification[]>({\n  queryKey: [\"/api/notifications\"],\n  queryFn: () => \n   fetch(\"/api/notifications?includeRead=true&limit=20\")\n    .then(res => res.json()),\n  refetchInterval: 5 * 60 * 1000,\n });\n\n const { data: unreadData } = useQuery<{count: number}>({\n  queryKey: [\"/api/notifications/unread-count\"],\n  refetchInterval: 2 * 60 * 1000,\n });\n\n const unreadCount = unreadData?.count || 0;\n\n const markAsReadMutation = useMutation({\n  mutationFn: (notificationId: string) =>\n   apiRequest(\"PUT\", `/api/notifications/${notificationId}/read`),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n  },\n });\n\n const markAllAsReadMutation = useMutation({\n  mutationFn: () =>\n   apiRequest(\"PUT\",\"/api/notifications/mark-all-read\"),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n   toast({ title:\"All caught up!\", description:\"Notifications marked as read\", variant:\"success\" });\n  },\n });\n\n const deleteNotificationMutation = useMutation({\n  mutationFn: (notificationId: string) =>\n   apiRequest(\"DELETE\", `/api/notifications/${notificationId}`),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n  },\n });\n\n const generateNotificationsMutation = useMutation({\n  mutationFn: () =>\n   apiRequest(\"POST\",\"/api/notifications/generate\"),\n  onSuccess: (data: any) => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/notifications/unread-count\"] });\n   if (data.generated > 0) {\n    toast({ \n     title:`${data.generated} new insights`,\n     description:\"Fresh financial suggestions for you\",\n     variant:\"info\"\n    });\n   }\n  },\n });\n\n useEffect(() => {\n  const timer = setTimeout(() => {\n   generateNotificationsMutation.mutate();\n  }, 3000);\n  return () => clearTimeout(timer);\n }, []);\n\n const createHandleNotificationClick = (handlers: any) => (notification: Notification) => {\n  if (!notification.isRead) {\n   markAsReadMutation.mutate(notification.id);\n  }\n  if (notification.actionType && notification.actionData) {\n   const handleNotificationAction = createHandleNotificationAction(handlers);\n   handleNotificationAction({\n    type: notification.actionType,\n    data: notification.actionData\n   });\n  }\n };\n\n const createHandleNotificationAction = (handlers: any) => (action: NotificationAction) => {\n  switch (action.type) {\n   case 'add_transaction':\n    handlers.openTransactionForm(action.data);\n    break;\n   case 'create_goal':\n    handlers.openGoalForm(action.data);\n    break;\n   case 'view_goal':\n    if (action.data?.goalId) {\n     handlers.navigateToGoal(action.data.goalId);\n    }\n    break;\n   case 'view_transactions':\n    handlers.navigateToTransactions(action.data?.category);\n    break;\n   case 'add_funds':\n    if (action.data?.goalId) {\n     handlers.openTransactionForm({\n      type: 'transfer',\n      category: 'goal_contribution',\n      goalId: action.data.goalId\n     });\n    }\n    break;\n   default:\n    break;\n  }\n };\n\n const getCategoryIcon = (category: string) => {\n  switch (category) {\n   case 'goals':\n    return <Target className=\"w-4 h-4\" />;\n   case 'transactions':\n    return <Wallet className=\"w-4 h-4\" />;\n   case 'budget':\n    return <AlertTriangle className=\"w-4 h-4\" />;\n   case 'achievements':\n    return <Trophy className=\"w-4 h-4\" />;\n   case 'suggestions':\n    return <Lightbulb className=\"w-4 h-4\" />;\n   default:\n    return <Bell className=\"w-4 h-4\" />;\n  }\n };\n\n const getCategoryColor = (category: string, priority: string) => {\n  if (priority === 'urgent') return 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';\n  if (priority === 'high') return 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400';\n  \n  switch (category) {\n   case 'goals':\n    return 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';\n   case 'transactions':\n    return 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400';\n   case 'budget':\n    return 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400';\n   case 'achievements':\n    return 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400';\n   case 'suggestions':\n    return 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400';\n   default:\n    return 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';\n  }\n };\n\n const formatTimeAgo = (dateString: string) => {\n  const date = new Date(dateString);\n  const now = new Date();\n  const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));\n  \n  if (diffInMinutes < 1) return 'Now';\n  if (diffInMinutes < 60) return `${diffInMinutes}m`;\n  const diffInHours = Math.floor(diffInMinutes / 60);\n  if (diffInHours < 24) return `${diffInHours}h`;\n  const diffInDays = Math.floor(diffInHours / 24);\n  if (diffInDays < 7) return `${diffInDays}d`;\n  return `${Math.floor(diffInDays / 7)}w`;\n };\n\n const recentNotifications = notifications.slice(0, 10);\n const hasUnreadNotifications = unreadCount > 0;\n\n return (\n  <NotificationActions>\n   {(handlers) => {\n    const handleNotificationClick = createHandleNotificationClick(handlers);\n    \n    return (\n     <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n       <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        className={cn(\n         \"relative h-10 w-10 rounded-full transition-all\",\n         hasUnreadNotifications && \"bg-primary/10 hover:bg-primary/20\"\n        )}\n        data-testid=\"button-notifications\"\n       >\n        <Bell className={cn(\n         \"w-5 h-5 transition-colors\",\n         hasUnreadNotifications ? \"text-primary\" : \"text-muted-foreground\"\n        )} />\n        <AnimatePresence>\n         {unreadCount > 0 && (\n          <motion.span\n           initial={{ scale: 0 }}\n           animate={{ scale: 1 }}\n           exit={{ scale: 0 }}\n           className=\"absolute -top-0.5 -right-0.5 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white shadow-sm\"\n           data-testid=\"badge-unread-count\"\n          >\n           {unreadCount > 9 ? '9+' : unreadCount}\n          </motion.span>\n         )}\n        </AnimatePresence>\n       </Button>\n      </PopoverTrigger>\n      \n      <PopoverContent \n       align=\"end\" \n       className=\"w-[360px] p-0 rounded-2xl shadow-xl border-border/50\"\n       sideOffset={8}\n       data-testid=\"dropdown-notifications\"\n      >\n       <div className=\"p-4 border-b border-border/50\">\n        <div className=\"flex items-center justify-between\">\n         <div>\n          <h3 className=\"font-semibold text-base\">Notifications</h3>\n          {unreadCount > 0 && (\n           <p className=\"text-xs text-muted-foreground mt-0.5\">\n            {unreadCount} unread\n           </p>\n          )}\n         </div>\n         <div className=\"flex items-center gap-1\">\n          {unreadCount > 0 && (\n           <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => markAllAsReadMutation.mutate()}\n            disabled={markAllAsReadMutation.isPending}\n            className=\"h-8 px-2 text-xs hover:bg-primary/10\"\n            data-testid=\"button-mark-all-read\"\n           >\n            <Check className=\"w-3.5 h-3.5 mr-1\" />\n            Mark read\n           </Button>\n          )}\n          <Button\n           variant=\"ghost\"\n           size=\"icon\"\n           onClick={() => generateNotificationsMutation.mutate()}\n           disabled={generateNotificationsMutation.isPending}\n           className=\"h-8 w-8 hover:bg-primary/10\"\n           data-testid=\"button-generate-notifications\"\n          >\n           <Sparkles className={cn(\n            \"w-4 h-4\",\n            generateNotificationsMutation.isPending && \"animate-spin\"\n           )} />\n          </Button>\n         </div>\n        </div>\n       </div>\n\n       <ScrollArea className=\"h-[380px]\">\n        {isLoading ? (\n         <div className=\"p-8 text-center\">\n          <div className=\"w-8 h-8 border-2 border-primary/30 border-t-primary rounded-full animate-spin mx-auto mb-3\" />\n          <p className=\"text-sm text-muted-foreground\">Loading...</p>\n         </div>\n        ) : recentNotifications.length === 0 ? (\n         <div className=\"p-8 text-center\">\n          <div className=\"w-12 h-12 rounded-full bg-muted/50 flex items-center justify-center mx-auto mb-3\">\n           <Bell className=\"w-6 h-6 text-muted-foreground/50\" />\n          </div>\n          <p className=\"font-medium text-sm\">All caught up!</p>\n          <p className=\"text-xs text-muted-foreground mt-1\">No new notifications</p>\n         </div>\n        ) : (\n         <div className=\"p-2\">\n          <AnimatePresence mode=\"popLayout\">\n           {recentNotifications.map((notification, index) => (\n            <motion.div\n             key={notification.id}\n             initial={{ opacity: 0, y: -10 }}\n             animate={{ opacity: 1, y: 0 }}\n             exit={{ opacity: 0, x: 50 }}\n             transition={{ delay: index * 0.03 }}\n             className={cn(\n              \"group relative p-3 rounded-xl mb-1.5 cursor-pointer transition-all\",\n              \"hover:bg-muted/50 active:scale-[0.99]\",\n              !notification.isRead && \"bg-primary/5\"\n             )}\n             onClick={() => handleNotificationClick(notification)}\n             data-testid={`notification-${index}`}\n            >\n             <div className=\"flex items-start gap-3\">\n              <div className={cn(\n               \"flex-shrink-0 w-9 h-9 rounded-full flex items-center justify-center\",\n               getCategoryColor(notification.category, notification.priority)\n              )}>\n               {getCategoryIcon(notification.category)}\n              </div>\n              \n              <div className=\"flex-1 min-w-0 pr-6\">\n               <div className=\"flex items-start justify-between gap-2\">\n                <h4 className={cn(\n                 \"text-sm leading-snug line-clamp-1\",\n                 !notification.isRead ? \"font-semibold\" : \"font-medium\"\n                )}>\n                 {notification.title}\n                </h4>\n                <span className=\"text-[10px] text-muted-foreground flex-shrink-0 mt-0.5\">\n                 {formatTimeAgo(notification.createdAt)}\n                </span>\n               </div>\n               \n               <p className=\"text-xs text-muted-foreground line-clamp-2 mt-0.5 leading-relaxed\">\n                {notification.message}\n               </p>\n\n               {notification.actionType && (\n                <Button\n                 size=\"sm\"\n                 variant=\"ghost\"\n                 className=\"h-7 px-2 mt-2 text-xs bg-primary/10 hover:bg-primary/20 text-primary\"\n                 onClick={(e) => {\n                  e.stopPropagation();\n                  const handleNotificationAction = createHandleNotificationAction(handlers);\n                  handleNotificationAction({\n                   type: notification.actionType!,\n                   data: notification.actionData\n                  });\n                  setIsOpen(false);\n                 }}\n                 data-testid={`button-action-${notification.actionType}`}\n                >\n                 {notification.actionType === 'add_transaction' && 'Add Transaction'}\n                 {notification.actionType === 'create_goal' && 'Create Goal'}\n                 {notification.actionType === 'view_goal' && 'View Goal'}\n                 {notification.actionType === 'view_transactions' && 'View All'}\n                 {notification.actionType === 'add_funds' && 'Add Funds'}\n                </Button>\n               )}\n\n               {!notification.isRead && (\n                <div className=\"absolute top-3 right-3 w-2 h-2 rounded-full bg-primary\" />\n               )}\n              </div>\n\n              <Button\n               variant=\"ghost\"\n               size=\"icon\"\n               className=\"absolute top-2 right-2 h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600\"\n               onClick={(e) => {\n                e.stopPropagation();\n                deleteNotificationMutation.mutate(notification.id);\n               }}\n               data-testid={`button-delete-${index}`}\n              >\n               <X className=\"w-3.5 h-3.5\" />\n              </Button>\n             </div>\n            </motion.div>\n           ))}\n          </AnimatePresence>\n         </div>\n        )}\n       </ScrollArea>\n      </PopoverContent>\n     </Popover>\n    );\n   }}\n  </NotificationActions>\n );\n}\n","path":null,"size_bytes":14083,"size_tokens":null},"server/cryptoService.ts":{"content":"// CoinGecko API service for fetching crypto prices\n// Uses free tier - no API key required\n\ninterface CryptoPrice {\n  usd: number;\n  usd_24h_change: number;\n  usd_market_cap: number;\n}\n\ninterface CryptoPriceData {\n  [symbol: string]: CryptoPrice;\n}\n\ninterface CachedPriceData {\n  prices: CryptoPriceData;\n  lastUpdated: number;\n}\n\n// Map common symbols to CoinGecko IDs\nconst SYMBOL_TO_ID_MAP: { [symbol: string]: string } = {\n  'BTC': 'bitcoin',\n  'ETH': 'ethereum',\n  'USDT': 'tether',\n  'BNB': 'binancecoin',\n  'SOL': 'solana',\n  'XRP': 'ripple',\n  'USDC': 'usd-coin',\n  'ADA': 'cardano',\n  'DOGE': 'dogecoin',\n  'TRX': 'tron',\n  'AVAX': 'avalanche-2',\n  'DOT': 'polkadot',\n  'MATIC': 'matic-network',\n  'LTC': 'litecoin',\n  'SHIB': 'shiba-inu',\n  'LINK': 'chainlink',\n  'UNI': 'uniswap',\n  'ATOM': 'cosmos',\n  'XLM': 'stellar',\n  'BCH': 'bitcoin-cash',\n  'NEAR': 'near',\n  'APT': 'aptos',\n  'ARB': 'arbitrum',\n  'OP': 'optimism',\n  'INJ': 'injective-protocol',\n};\n\nconst COINGECKO_API = 'https://api.coingecko.com/api/v3';\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes - increased to reduce rate limiting\nlet priceCache: CachedPriceData | null = null;\nlet lastRequestTime = 0;\nconst MIN_REQUEST_INTERVAL = 2000; // 2 seconds between requests\n\nexport class CryptoService {\n  /**\n   * Get current prices for multiple cryptocurrencies\n   * @param symbols Array of crypto symbols (e.g., ['BTC', 'ETH'])\n   * @returns Object with symbol as key and price data\n   */\n  async getCurrentPrices(symbols: string[]): Promise<CryptoPriceData> {\n    // Check cache first\n    if (priceCache && Date.now() - priceCache.lastUpdated < CACHE_DURATION) {\n      const cachedResult: CryptoPriceData = {};\n      for (const symbol of symbols) {\n        if (priceCache.prices[symbol]) {\n          cachedResult[symbol] = priceCache.prices[symbol];\n        }\n      }\n      // If we have all symbols cached, return them\n      if (Object.keys(cachedResult).length === symbols.length) {\n        return cachedResult;\n      }\n    }\n\n    // Map symbols to CoinGecko IDs\n    const coinIds = symbols\n      .map(symbol => SYMBOL_TO_ID_MAP[symbol.toUpperCase()])\n      .filter(Boolean);\n\n    if (coinIds.length === 0) {\n      throw new Error('No valid cryptocurrency symbols provided');\n    }\n\n    const ids = coinIds.join(',');\n    const url = `${COINGECKO_API}/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`;\n\n    try {\n      // Rate limiting: ensure minimum interval between requests\n      const timeSinceLastRequest = Date.now() - lastRequestTime;\n      if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {\n        await new Promise(resolve => setTimeout(resolve, MIN_REQUEST_INTERVAL - timeSinceLastRequest));\n      }\n\n      lastRequestTime = Date.now();\n      const response = await fetch(url);\n      \n      if (response.status === 429) {\n        // Rate limited - return cached data if available, otherwise throw\n        if (priceCache && priceCache.prices) {\n          const cachedResult: CryptoPriceData = {};\n          for (const symbol of symbols) {\n            if (priceCache.prices[symbol]) {\n              cachedResult[symbol] = priceCache.prices[symbol];\n            }\n          }\n          if (Object.keys(cachedResult).length > 0) {\n            return cachedResult;\n          }\n        }\n        console.error('[CryptoService] Rate limit exceeded and no cache available');\n        throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);\n      }\n      \n      if (!response.ok) {\n        throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n\n      // Convert CoinGecko IDs back to symbols\n      const result: CryptoPriceData = {};\n      for (const symbol of symbols) {\n        const coinId = SYMBOL_TO_ID_MAP[symbol.toUpperCase()];\n        if (coinId && data[coinId]) {\n          result[symbol.toUpperCase()] = data[coinId];\n        }\n      }\n\n      // Update cache\n      priceCache = {\n        prices: { ...priceCache?.prices, ...result },\n        lastUpdated: Date.now(),\n      };\n\n      return result;\n    } catch (error) {\n      console.error('[CryptoService] Error fetching prices:', error);\n      \n      // Return cached data on error if available\n      if (priceCache && priceCache.prices) {\n        const cachedResult: CryptoPriceData = {};\n        for (const symbol of symbols) {\n          if (priceCache.prices[symbol]) {\n            cachedResult[symbol] = priceCache.prices[symbol];\n          }\n        }\n        if (Object.keys(cachedResult).length > 0) {\n          return cachedResult;\n        }\n      }\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Get price for a single cryptocurrency\n   */\n  async getPrice(symbol: string): Promise<CryptoPrice | null> {\n    const prices = await this.getCurrentPrices([symbol]);\n    return prices[symbol.toUpperCase()] || null;\n  }\n\n  /**\n   * Get all supported symbols\n   */\n  getSupportedSymbols(): string[] {\n    return Object.keys(SYMBOL_TO_ID_MAP);\n  }\n\n  /**\n   * Get full cryptocurrency info including name\n   */\n  getCryptoInfo(symbol: string): { symbol: string; name: string; id: string } | null {\n    const upperSymbol = symbol.toUpperCase();\n    const id = SYMBOL_TO_ID_MAP[upperSymbol];\n    \n    if (!id) return null;\n\n    const names: { [key: string]: string } = {\n      'bitcoin': 'Bitcoin',\n      'ethereum': 'Ethereum',\n      'tether': 'Tether',\n      'binancecoin': 'BNB',\n      'solana': 'Solana',\n      'ripple': 'XRP',\n      'usd-coin': 'USD Coin',\n      'cardano': 'Cardano',\n      'dogecoin': 'Dogecoin',\n      'tron': 'TRON',\n      'avalanche-2': 'Avalanche',\n      'polkadot': 'Polkadot',\n      'matic-network': 'Polygon',\n      'litecoin': 'Litecoin',\n      'shiba-inu': 'Shiba Inu',\n      'chainlink': 'Chainlink',\n      'uniswap': 'Uniswap',\n      'cosmos': 'Cosmos',\n      'stellar': 'Stellar',\n      'bitcoin-cash': 'Bitcoin Cash',\n      'near': 'NEAR Protocol',\n      'aptos': 'Aptos',\n      'arbitrum': 'Arbitrum',\n      'optimism': 'Optimism',\n      'injective-protocol': 'Injective',\n    };\n\n    return {\n      symbol: upperSymbol,\n      name: names[id] || upperSymbol,\n      id,\n    };\n  }\n\n  /**\n   * Clear the price cache (useful for testing)\n   */\n  clearCache(): void {\n    priceCache = null;\n  }\n\n  /**\n   * Get price for a single cryptocurrency by CoinGecko ID\n   * Returns detailed price data matching CoinGecko API format\n   */\n  async getCryptoPrice(coinId: string): Promise<{\n    id: string;\n    symbol: string;\n    name: string;\n    current_price: number;\n    market_cap: number;\n    price_change_percentage_24h: number;\n  } | null> {\n    const url = `${COINGECKO_API}/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`;\n    \n    try {\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        if (response.status !== 429) {\n          console.error(`[CryptoService] API error ${response.status} for ${coinId}`);\n        }\n        throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      if (!data[coinId]) {\n        return null;\n      }\n\n      // Find symbol from ID\n      const symbol = Object.entries(SYMBOL_TO_ID_MAP).find(([_, id]) => id === coinId)?.[0] || coinId.toUpperCase();\n      \n      return {\n        id: coinId,\n        symbol: symbol,\n        name: this.getCryptoInfo(symbol)?.name || coinId,\n        current_price: data[coinId].usd,\n        market_cap: data[coinId].usd_market_cap,\n        price_change_percentage_24h: data[coinId].usd_24h_change,\n      };\n    } catch (error) {\n      console.error(`[CryptoService] Error fetching price for ${coinId}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get prices for multiple cryptocurrencies by CoinGecko IDs\n   */\n  async getCryptoPrices(coinIds: string[]): Promise<Array<{\n    id: string;\n    symbol: string;\n    name: string;\n    current_price: number;\n    market_cap: number;\n    price_change_percentage_24h: number;\n  }>> {\n    const ids = coinIds.join(',');\n    const url = `${COINGECKO_API}/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`;\n    \n    try {\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      return coinIds.map(coinId => {\n        if (!data[coinId]) return null;\n        \n        const symbol = Object.entries(SYMBOL_TO_ID_MAP).find(([_, id]) => id === coinId)?.[0] || coinId.toUpperCase();\n        \n        return {\n          id: coinId,\n          symbol: symbol,\n          name: this.getCryptoInfo(symbol)?.name || coinId,\n          current_price: data[coinId].usd,\n          market_cap: data[coinId].usd_market_cap,\n          price_change_percentage_24h: data[coinId].usd_24h_change,\n        };\n      }).filter(Boolean) as Array<{\n        id: string;\n        symbol: string;\n        name: string;\n        current_price: number;\n        market_cap: number;\n        price_change_percentage_24h: number;\n      }>;\n    } catch (error) {\n      console.error(`[CryptoService] Error fetching prices:`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Search cryptocurrencies by query\n   */\n  async searchCrypto(query: string): Promise<Array<{\n    id: string;\n    symbol: string;\n    name: string;\n  }>> {\n    try {\n      const url = `${COINGECKO_API}/search?query=${encodeURIComponent(query)}`;\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        throw new Error(`CoinGecko API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      // Return top 10 coin results\n      return (data.coins || []).slice(0, 10).map((coin: any) => ({\n        id: coin.id,\n        symbol: coin.symbol?.toUpperCase() || '',\n        name: coin.name,\n      }));\n    } catch (error) {\n      console.error(`[CryptoService] Error searching crypto:`, error);\n      return [];\n    }\n  }\n}\n\n// Export singleton instance\nexport const cryptoService = new CryptoService();\n","path":null,"size_bytes":10229,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from\"react\"\nimport { OTPInput, OTPInputContext } from\"input-otp\"\nimport { Dot } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n React.ElementRef<typeof OTPInput>,\n React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n <OTPInput\n  ref={ref}\n  containerClassName={cn(\n  \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n   containerClassName\n  )}\n  className={cn(\"disabled:cursor-not-allowed\", className)}\n  {...props}\n />\n))\nInputOTP.displayName =\"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n React.ElementRef<\"div\">,\n React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName =\"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n React.ElementRef<\"div\">,\n React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n const inputOTPContext = React.useContext(OTPInputContext)\n const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n return (\n  <div\n   ref={ref}\n   className={cn(\n   \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n    isActive &&\"z-10 ring-2 ring-ring ring-offset-background\",\n    className\n   )}\n   {...props}\n  >\n   {char}\n   {hasFakeCaret && (\n    <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n     <div className=\"h-4 w-px animate-caret-blink bg-foreground\" />\n    </div>\n   )}\n  </div>\n )\n})\nInputOTPSlot.displayName =\"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n React.ElementRef<\"div\">,\n React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n <div ref={ref} role=\"separator\" {...props}>\n  <Dot />\n </div>\n))\nInputOTPSeparator.displayName =\"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2042,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from\"react\"\nimport useEmblaCarousel, {\n type UseEmblaCarouselType,\n} from\"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\nimport { Button } from\"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n opts?: CarouselOptions\n plugins?: CarouselPlugin\n orientation?:\"horizontal\" |\"vertical\"\n setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n api: ReturnType<typeof useEmblaCarousel>[1]\n scrollPrev: () => void\n scrollNext: () => void\n canScrollPrev: boolean\n canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n const context = React.useContext(CarouselContext)\n\n if (!context) {\n  throw new Error(\"useCarousel must be used within a <Carousel />\")\n }\n\n return context\n}\n\nconst Carousel = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n (\n  {\n   orientation =\"horizontal\",\n   opts,\n   setApi,\n   plugins,\n   className,\n   children,\n   ...props\n  },\n  ref\n ) => {\n  const [carouselRef, api] = useEmblaCarousel(\n   {\n    ...opts,\n    axis: orientation ===\"horizontal\" ?\"x\" :\"y\",\n   },\n   plugins\n  )\n  const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n  const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n  const onSelect = React.useCallback((api: CarouselApi) => {\n   if (!api) {\n    return\n   }\n\n   setCanScrollPrev(api.canScrollPrev())\n   setCanScrollNext(api.canScrollNext())\n  }, [])\n\n  const scrollPrev = React.useCallback(() => {\n   api?.scrollPrev()\n  }, [api])\n\n  const scrollNext = React.useCallback(() => {\n   api?.scrollNext()\n  }, [api])\n\n  const handleKeyDown = React.useCallback(\n   (event: React.KeyboardEvent<HTMLDivElement>) => {\n    if (event.key ===\"ArrowLeft\") {\n     event.preventDefault()\n     scrollPrev()\n    } else if (event.key ===\"ArrowRight\") {\n     event.preventDefault()\n     scrollNext()\n    }\n   },\n   [scrollPrev, scrollNext]\n  )\n\n  React.useEffect(() => {\n   if (!api || !setApi) {\n    return\n   }\n\n   setApi(api)\n  }, [api, setApi])\n\n  React.useEffect(() => {\n   if (!api) {\n    return\n   }\n\n   onSelect(api)\n   api.on(\"reInit\", onSelect)\n   api.on(\"select\", onSelect)\n\n   return () => {\n    api?.off(\"select\", onSelect)\n   }\n  }, [api, onSelect])\n\n  return (\n   <CarouselContext.Provider\n    value={{\n     carouselRef,\n     api: api,\n     opts,\n     orientation:\n      orientation || (opts?.axis ===\"y\" ?\"vertical\" :\"horizontal\"),\n     scrollPrev,\n     scrollNext,\n     canScrollPrev,\n     canScrollNext,\n    }}\n   >\n    <div\n     ref={ref}\n     onKeyDownCapture={handleKeyDown}\n     className={cn(\"relative\", className)}\n     role=\"region\"\n     aria-roledescription=\"carousel\"\n     {...props}\n    >\n     {children}\n    </div>\n   </CarouselContext.Provider>\n  )\n }\n)\nCarousel.displayName =\"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n const { carouselRef, orientation } = useCarousel()\n\n return (\n  <div ref={carouselRef} className=\"overflow-hidden\">\n   <div\n    ref={ref}\n    className={cn(\n    \"flex\",\n     orientation ===\"horizontal\" ?\"-ml-4\" :\"-mt-4 flex-col\",\n     className\n    )}\n    {...props}\n   />\n  </div>\n )\n})\nCarouselContent.displayName =\"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n const { orientation } = useCarousel()\n\n return (\n  <div\n   ref={ref}\n   role=\"group\"\n   aria-roledescription=\"slide\"\n   className={cn(\n   \"min-w-0 shrink-0 grow-0 basis-full\",\n    orientation ===\"horizontal\" ?\"pl-4\" :\"pt-4\",\n    className\n   )}\n   {...props}\n  />\n )\n})\nCarouselItem.displayName =\"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<typeof Button>\n>(({ className, variant =\"outline\", size =\"icon\", ...props }, ref) => {\n const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n return (\n  <Button\n   ref={ref}\n   variant={variant}\n   size={size}\n   className={cn(\n   \"absolute h-11 w-11 min-w-[44px] min-h-[44px] rounded-full\",\n    orientation ===\"horizontal\"\n     ?\"-left-12 top-1/2 -translate-y-1/2\"\n     :\"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n    className\n   )}\n   disabled={!canScrollPrev}\n   onClick={scrollPrev}\n   {...props}\n  >\n   <ArrowLeft className=\"h-4 w-4\" />\n   <span className=\"sr-only\">Previous slide</span>\n  </Button>\n )\n})\nCarouselPrevious.displayName =\"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n HTMLButtonElement,\n React.ComponentProps<typeof Button>\n>(({ className, variant =\"outline\", size =\"icon\", ...props }, ref) => {\n const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n return (\n  <Button\n   ref={ref}\n   variant={variant}\n   size={size}\n   className={cn(\n   \"absolute h-11 w-11 min-w-[44px] min-h-[44px] rounded-full\",\n    orientation ===\"horizontal\"\n     ?\"-right-12 top-1/2 -translate-y-1/2\"\n     :\"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n    className\n   )}\n   disabled={!canScrollNext}\n   onClick={scrollNext}\n   {...props}\n  >\n   <ArrowRight className=\"h-4 w-4\" />\n   <span className=\"sr-only\">Next slide</span>\n  </Button>\n )\n})\nCarouselNext.displayName =\"CarouselNext\"\n\nexport {\n type CarouselApi,\n Carousel,\n CarouselContent,\n CarouselItem,\n CarouselPrevious,\n CarouselNext,\n}\n","path":null,"size_bytes":5690,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from\"lucide-react\"\nimport * as ResizablePrimitive from\"react-resizable-panels\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n className,\n ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n <ResizablePrimitive.PanelGroup\n  className={cn(\n  \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n   className\n  )}\n  {...props}\n />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n withHandle,\n className,\n ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n withHandle?: boolean\n}) => (\n <ResizablePrimitive.PanelResizeHandle\n  className={cn(\n  \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n   className\n  )}\n  {...props}\n >\n  {withHandle && (\n   <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n    <GripVertical className=\"h-2.5 w-2.5\" />\n   </div>\n  )}\n </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1669,"size_tokens":null},"client/src/components/money/advanced-spending-analytics.tsx":{"content":"import { useState } from\"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { \n BarChart3, \n PieChart, \n TrendingUp, \n TrendingDown, \n Calendar, \n DollarSign,\n ArrowUpRight,\n ArrowDownRight,\n Target,\n AlertTriangle,\n CheckCircle\n} from\"lucide-react\";\nimport { format, startOfMonth, endOfMonth, subMonths, differenceInDays } from\"date-fns\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\ninterface AdvancedSpendingAnalyticsProps {\n transactions: any[];\n timeRange: string;\n}\n\nexport default function AdvancedSpendingAnalytics({ transactions, timeRange }: AdvancedSpendingAnalyticsProps) {\n const [selectedPeriod, setSelectedPeriod] = useState<string>('month');\n const { formatAmount } = useUserCurrency();\n\n // Calculate spending by category\n const expenseTransactions = transactions.filter(t => t.type === 'expense');\n const categorySpending = expenseTransactions.reduce((acc: any, transaction) => {\n  const category = transaction.category || 'other';\n  acc[category] = (acc[category] || 0) + parseFloat(transaction.amount);\n  return acc;\n }, {});\n\n const totalExpenses = Object.values(categorySpending).reduce((sum: number, amount: any) => sum + amount, 0);\n const sortedCategories = Object.entries(categorySpending)\n  .sort(([,a]: any, [,b]: any) => b - a)\n  .slice(0, 6);\n\n // Guard against division by zero\n const safeTotalExpenses = Math.max(totalExpenses, 0.01);\n\n // Calculate monthly trends\n const now = new Date();\n const currentMonth = startOfMonth(now);\n const lastMonth = startOfMonth(subMonths(now, 1));\n \n const currentMonthExpenses = expenseTransactions\n  .filter(t => new Date(t.date) >= currentMonth)\n  .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n \n const lastMonthExpenses = expenseTransactions\n  .filter(t => {\n   const date = new Date(t.date);\n   return date >= lastMonth && date < currentMonth;\n  })\n  .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n const monthlyChange = lastMonthExpenses > 0 \n  ? ((currentMonthExpenses - lastMonthExpenses) / lastMonthExpenses) * 100 \n  : 0;\n\n // Calculate daily average\n const daysInPeriod = parseInt(timeRange);\n const dailyAverage = totalExpenses / daysInPeriod;\n\n // Get spending velocity (spending rate)\n const recentDays = 7;\n const recentExpenses = expenseTransactions\n  .filter(t => {\n   const transactionDate = new Date(t.date);\n   const daysAgo = new Date(Date.now() - recentDays * 24 * 60 * 60 * 1000);\n   return transactionDate >= daysAgo;\n  })\n  .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n const weeklyVelocity = recentExpenses / recentDays;\n const velocityChange = weeklyVelocity > dailyAverage ? 'increasing' : 'stable';\n\n const getCategoryColor = (index: number) => {\n  const colors = [\n   'bg-primary',\n   'bg-primary/80', \n   'bg-primary/60',\n   'bg-primary/40',\n   'bg-muted-foreground/60',\n   'bg-muted-foreground/40'\n  ];\n  return colors[index % colors.length];\n };\n\n const getCategoryIcon = (category: string) => {\n  return '';\n };\n\n return (\n  <div className=\"space-y-6\">\n   {/* Spending Overview */}\n   <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Monthly Change</p>\n       <p className={`text-2xl font-bold ${monthlyChange >= 0 ? 'text-red-600' : 'text-green-600'}`}>\n        {monthlyChange >= 0 ? '+' : ''}{monthlyChange.toFixed(1)}%\n       </p>\n       <p className=\"text-xs text-muted-foreground mt-1\">\n        vs last month\n       </p>\n      </div>\n      <div className={`w-12 h-12 ${monthlyChange >= 0 ? 'bg-red-100 dark:bg-red-900/20' : 'bg-green-100 dark:bg-green-900/20'} rounded-lg flex items-center justify-center`}>\n       {monthlyChange >= 0 ? (\n        <ArrowUpRight className=\"text-red-600\" size={24} />\n       ) : (\n        <ArrowDownRight className=\"text-green-600\" size={24} />\n       )}\n      </div>\n     </div>\n    </Card>\n\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Daily Average</p>\n       <p className=\"text-2xl font-bold text-blue-600\">\n        {formatAmount(dailyAverage)}\n       </p>\n       <p className=\"text-xs text-muted-foreground mt-1\">\n        last {timeRange} days\n       </p>\n      </div>\n      <div className=\"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center\">\n       <Calendar className=\"text-blue-600\" size={24} />\n      </div>\n     </div>\n    </Card>\n\n    <Card className=\"p-6\">\n     <div className=\"flex items-center justify-between\">\n      <div>\n       <p className=\"text-sm text-muted-foreground\">Spending Velocity</p>\n       <p className=\"text-2xl font-bold text-orange-600\">\n        {formatAmount(weeklyVelocity)}/day\n       </p>\n       <Badge \n        variant={velocityChange === 'increasing' ? 'destructive' : 'secondary'}\n        className=\"mt-1\"\n       >\n        {velocityChange === 'increasing' ? 'High' : 'Stable'}\n       </Badge>\n      </div>\n      <div className=\"w-12 h-12 bg-orange-100 dark:bg-orange-900/20 rounded-lg flex items-center justify-center\">\n       <TrendingUp className=\"text-orange-600\" size={24} />\n      </div>\n     </div>\n    </Card>\n   </div>\n\n   {/* Category Breakdown */}\n   <Card className=\"p-6\">\n    <CardHeader className=\"px-0 pt-0\">\n     <CardTitle className=\"flex items-center\">\n      <PieChart className=\"mr-2\" size={20} />\n      Spending by Category\n     </CardTitle>\n    </CardHeader>\n    <CardContent className=\"px-0\">\n     <div className=\"space-y-4\">\n      {sortedCategories.map(([category, amount]: any, index) => {\n       const percentage = totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0;\n       return (\n        <div key={category} className=\"space-y-2\">\n         <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center\">\n           <span className=\"text-lg mr-2\">{getCategoryIcon(category)}</span>\n           <span className=\"font-medium capitalize\">\n            {category.replace('_', ' ')}\n           </span>\n          </div>\n          <div className=\"text-right\">\n           <p className=\"font-semibold\">{formatAmount(amount)}</p>\n           <p className=\"text-xs text-muted-foreground\">{percentage.toFixed(1)}%</p>\n          </div>\n         </div>\n         <Progress \n          value={percentage} \n          className=\"h-2\"\n         />\n        </div>\n       );\n      })}\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Spending Patterns */}\n   <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n    <Card className=\"p-6\">\n     <CardHeader className=\"px-0 pt-0\">\n      <CardTitle className=\"flex items-center\">\n       <BarChart3 className=\"mr-2\" size={20} />\n       Top Spending Categories\n      </CardTitle>\n     </CardHeader>\n     <CardContent className=\"px-0\">\n      <div className=\"space-y-3\">\n       {sortedCategories.slice(0, 3).map(([category, amount]: any, index) => (\n        <div key={category} className=\"flex items-center justify-between p-3 bg-muted/30 rounded-lg\">\n         <div className=\"flex items-center\">\n          <div className={`w-3 h-3 ${getCategoryColor(index)} rounded-full mr-3`}></div>\n          <div>\n           <p className=\"font-medium capitalize\">{category.replace('_', ' ')}</p>\n           <p className=\"text-sm text-muted-foreground\">\n            {totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0}% of spending\n           </p>\n          </div>\n         </div>\n         <p className=\"font-bold\">{formatAmount(amount)}</p>\n        </div>\n       ))}\n      </div>\n     </CardContent>\n    </Card>\n\n    <Card className=\"p-6\">\n     <CardHeader className=\"px-0 pt-0\">\n      <CardTitle className=\"flex items-center\">\n       <Target className=\"mr-2\" size={20} />\n       Spending Health\n      </CardTitle>\n     </CardHeader>\n     <CardContent className=\"px-0\">\n      <div className=\"space-y-4\">\n       <div className=\"flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n        <div className=\"flex items-center\">\n         <CheckCircle className=\"text-green-600 mr-3\" size={20} />\n         <div>\n          <p className=\"font-medium\">Consistent Spending</p>\n          <p className=\"text-sm text-muted-foreground\">Good weekly patterns</p>\n         </div>\n        </div>\n        <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900/20\">\n         Healthy\n        </Badge>\n       </div>\n\n       <div className=\"flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n        <div className=\"flex items-center\">\n         <AlertTriangle className=\"text-yellow-600 mr-3\" size={20} />\n         <div>\n          <p className=\"font-medium\">High Dining Expenses</p>\n          <p className=\"text-sm text-muted-foreground\">Consider meal planning</p>\n         </div>\n        </div>\n        <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20\">\n         Watch\n        </Badge>\n       </div>\n\n       <div className=\"flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n        <div className=\"flex items-center\">\n         <DollarSign className=\"text-blue-600 mr-3\" size={20} />\n         <div>\n          <p className=\"font-medium\">Savings Opportunity</p>\n          <p className=\"text-sm text-muted-foreground\">Reduce entertainment by 15%</p>\n         </div>\n        </div>\n        <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900/20\">\n         Opportunity\n        </Badge>\n       </div>\n      </div>\n     </CardContent>\n    </Card>\n   </div>\n  </div>\n );\n}","path":null,"size_bytes":9816,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { ArrowLeft, Home, Search, Compass, Sparkles, TrendingUp } from\"lucide-react\";\nimport { useLocation } from\"wouter\";\nimport { useTranslation } from 'react-i18next';\n\nexport default function NotFound() {\n const [, setLocation] = useLocation();\n const { t } = useTranslation();\n\n const handleGoHome = () => setLocation(\"/\");\n const handleGoBack = () => window.history.back();\n\n const quickActions = [\n { icon: Home, label: t('navigation.dashboard'), path:\"/\", color:\"bg-blue-500\" },\n { icon: TrendingUp, label: t('navigation.money'), path:\"/money-tracking\", color:\"bg-green-500\" },\n { icon: Sparkles, label: t('navigation.aiAssistant'), path:\"/ai-assistant\", color:\"bg-blue-500\" },\n { icon: Compass, label: t('navigation.goals'), path:\"/financial-goals\", color:\"bg-orange-500\" }\n ];\n\n return (\n <div className=\"min-h-screen w-full flex items-center justify-center bg-blue-50 dark:bg-gray-900 p-4\">\n <div className=\"max-w-2xl w-full text-center space-y-8\">\n {/* Animated 404 */}\n <div className=\"relative\">\n <div className=\"absolute inset-0 bg-blue-500/20 rounded-full blur-3xl\"></div>\n <div className=\"relative\">\n <h1 className=\"text-8xl md:text-9xl font-bold text-blue-600 dark:text-blue-400\">\n 404\n </h1>\n </div>\n </div>\n\n {/* Modern messaging */}\n <div className=\"space-y-4\">\n <h2 className=\"text-3xl md:text-4xl font-bold text-foreground\">\n {t('notFound.title')}\n </h2>\n <p className=\"text-lg text-muted-foreground max-w-md mx-auto\">\n {t('notFound.message')}\n </p>\n </div>\n\n {/* Action buttons */}\n <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n <Button \n onClick={handleGoBack}\n variant=\"outline\"\n size=\"lg\"\n className=\"group transition-all\"\n data-testid=\"button-go-back\"\n >\n <ArrowLeft className=\"w-5 h-5 mr-2 group-\" />\n {t('notFound.goBack')}\n </Button>\n \n <Button \n onClick={handleGoHome}\n size=\"lg\"\n className=\"bg-primary text-primary-foreground shadow-lg\"\n data-testid=\"button-go-home\"\n >\n <Home className=\"w-5 h-5 mr-2\" />\n {t('notFound.backToDashboard')}\n </Button>\n </div>\n\n {/* Quick navigation */}\n <Card className=\"bg-card/95 backdrop-blur-sm border border-border/50 p-6\">\n <h3 className=\"text-xl font-semibold mb-4 text-foreground\">{t('notFound.quickAccess')}</h3>\n <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n {quickActions.map((action, index) => (\n <Button\n key={index}\n variant=\"ghost\"\n onClick={() => setLocation(action.path)}\n className=\"h-auto p-4 flex flex-col items-center gap-2 transition-all\"\n data-testid={`button-quick-${action.label.toLowerCase().replace(/\\s+/g, '-')}`}\n >\n <div className={`w-10 h-10 rounded-lg ${action.color} flex items-center justify-center`}>\n <action.icon className=\"w-5 h-5 text-white dark:text-white\" />\n </div>\n <span className=\"text-sm font-medium\">{action.label}</span>\n </Button>\n ))}\n </div>\n </Card>\n\n {/* Helpful tip */}\n <div className=\"bg-white dark:bg-gray-900 rounded-xl p-4 border border-blue-200/50 dark:border-blue-800/50\">\n <div className=\"flex items-center gap-2 mb-2\">\n <Search className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\n <span className=\"font-medium text-blue-900 dark:text-blue-100\">{t('notFound.proTip')}</span>\n </div>\n <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n {t('notFound.proTipMessage')}\n </p>\n </div>\n </div>\n </div>\n );\n}\n","path":null,"size_bytes":3374,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as ToggleGroupPrimitive from\"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\nimport { toggleVariants } from\"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n VariantProps<typeof toggleVariants>\n>({\n size:\"default\",\n variant:\"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n  VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n <ToggleGroupPrimitive.Root\n  ref={ref}\n  className={cn(\"flex items-center justify-center gap-1\", className)}\n  {...props}\n >\n  <ToggleGroupContext.Provider value={{ variant, size }}>\n   {children}\n  </ToggleGroupContext.Provider>\n </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n  VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n const context = React.useContext(ToggleGroupContext)\n\n return (\n  <ToggleGroupPrimitive.Item\n   ref={ref}\n   className={cn(\n    toggleVariants({\n     variant: context.variant || variant,\n     size: context.size || size,\n    }),\n    className\n   )}\n   {...props}\n  >\n   {children}\n  </ToggleGroupPrimitive.Item>\n )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1673,"size_tokens":null},"client/src/pages/groups.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus, Users, MoreHorizontal, UserPlus, Trash2, Copy, DollarSign, \n  Home, Car, Target, PiggyBank, Calculator, TrendingUp, Clock,\n  ChevronRight, Sparkles, CheckCircle, Share2, Settings\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogTrigger, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport GroupForm from \"@/components/forms/group-form\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useUserId, useUserCurrency } from \"@/lib/userContext\";\n\nfunction AnimatedNumber({ value, formatFn }: { value: number; formatFn: (val: number) => string }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const duration = 800;\n    const steps = 40;\n    const increment = value / steps;\n    let current = 0;\n    \n    const timer = setInterval(() => {\n      current += increment;\n      if (current >= value) {\n        setDisplayValue(value);\n        clearInterval(timer);\n      } else {\n        setDisplayValue(current);\n      }\n    }, duration / steps);\n    \n    return () => clearInterval(timer);\n  }, [value]);\n  \n  return <span>{formatFn(Math.round(displayValue))}</span>;\n}\n\nfunction CircularProgress({ progress, size = 60 }: { progress: number; size?: number }) {\n  const [animatedProgress, setAnimatedProgress] = useState(0);\n  const strokeWidth = 5;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (animatedProgress / 100) * circumference;\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setAnimatedProgress(progress);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [progress]);\n  \n  return (\n    <div className=\"relative\" style={{ width: size, height: size }}>\n      <svg className=\"transform -rotate-90\" width={size} height={size}>\n        <circle\n          className=\"stroke-muted\"\n          strokeWidth={strokeWidth}\n          fill=\"transparent\"\n          r={radius}\n          cx={size / 2}\n          cy={size / 2}\n        />\n        <circle\n          className=\"stroke-primary transition-all duration-1000 ease-out\"\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          fill=\"transparent\"\n          r={radius}\n          cx={size / 2}\n          cy={size / 2}\n          style={{\n            strokeDasharray: circumference,\n            strokeDashoffset: offset,\n          }}\n        />\n      </svg>\n      <div className=\"absolute inset-0 flex items-center justify-center\">\n        <span className=\"text-xs font-bold\">{Math.round(animatedProgress)}%</span>\n      </div>\n    </div>\n  );\n}\n\nfunction ExpenseSplitCalculator({ \n  totalAmount, \n  memberCount,\n  onClose,\n  formatAmount\n}: { \n  totalAmount: number; \n  memberCount: number;\n  onClose: () => void;\n  formatAmount: (val: number) => string;\n}) {\n  const [splitType, setSplitType] = useState<'equal' | 'custom'>('equal');\n  const [customSplits, setCustomSplits] = useState<Record<number, number>>({});\n  \n  const equalSplit = memberCount > 0 ? totalAmount / memberCount : 0;\n  \n  const handleCustomChange = (index: number, value: string) => {\n    setCustomSplits(prev => ({\n      ...prev,\n      [index]: parseFloat(value) || 0\n    }));\n  };\n  \n  const totalCustom = Object.values(customSplits).reduce((sum, val) => sum + val, 0);\n  const remaining = totalAmount - totalCustom;\n  \n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between p-4 bg-primary/5 rounded-xl\">\n        <div>\n          <p className=\"text-xs text-muted-foreground\">Total Amount</p>\n          <p className=\"text-2xl font-bold text-primary\">{formatAmount(totalAmount)}</p>\n        </div>\n        <div className=\"text-right\">\n          <p className=\"text-xs text-muted-foreground\">Members</p>\n          <p className=\"text-2xl font-bold\">{memberCount}</p>\n        </div>\n      </div>\n      \n      <div className=\"flex gap-2\">\n        <Button\n          variant={splitType === 'equal' ? 'default' : 'outline'}\n          size=\"sm\"\n          className=\"flex-1\"\n          onClick={() => setSplitType('equal')}\n        >\n          Equal Split\n        </Button>\n        <Button\n          variant={splitType === 'custom' ? 'default' : 'outline'}\n          size=\"sm\"\n          className=\"flex-1\"\n          onClick={() => setSplitType('custom')}\n        >\n          Custom Split\n        </Button>\n      </div>\n      \n      {splitType === 'equal' ? (\n        <div className=\"p-4 bg-muted/50 rounded-xl\">\n          <p className=\"text-sm text-muted-foreground mb-2\">Each person pays:</p>\n          <p className=\"text-3xl font-bold text-primary\">{formatAmount(equalSplit)}</p>\n        </div>\n      ) : (\n        <div className=\"space-y-3\">\n          {[...Array(memberCount)].map((_, index) => (\n            <div key={index} className=\"flex items-center gap-3\">\n              <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-xs font-medium\">\n                {index + 1}\n              </div>\n              <Input\n                type=\"number\"\n                placeholder=\"0.00\"\n                className=\"flex-1\"\n                value={customSplits[index] || ''}\n                onChange={(e) => handleCustomChange(index, e.target.value)}\n              />\n            </div>\n          ))}\n          {remaining !== 0 && (\n            <p className={`text-sm ${remaining > 0 ? 'text-amber-600' : 'text-red-600'}`}>\n              {remaining > 0 \n                ? `${formatAmount(remaining)} remaining to assign`\n                : `${formatAmount(Math.abs(remaining))} over the total`\n              }\n            </p>\n          )}\n        </div>\n      )}\n      \n      <Button onClick={onClose} variant=\"outline\" className=\"w-full\">\n        Done\n      </Button>\n    </div>\n  );\n}\n\nfunction GroupCard({ \n  group, \n  onInvite, \n  onDelete,\n  onContribute,\n  formatAmount,\n  delay = 0\n}: { \n  group: any; \n  onInvite: () => void; \n  onDelete: () => void;\n  onContribute: () => void;\n  formatAmount: (val: number) => string;\n  delay?: number;\n}) {\n  const targetAmount = parseFloat(group.budget || '0');\n  const currentAmount = parseFloat(group.currentAmount || '0');\n  const progress = targetAmount > 0 ? Math.min(100, (currentAmount / targetAmount) * 100) : 0;\n  const remaining = Math.max(0, targetAmount - currentAmount);\n  const memberCount = group.memberCount || 1;\n  \n  const getGroupIcon = (type: string) => {\n    switch (type) {\n      case 'house': return Home;\n      case 'car': return Car;\n      case 'savings': return PiggyBank;\n      default: return Target;\n    }\n  };\n  \n  const GroupIcon = getGroupIcon(group.category);\n  \n  const getCategoryColor = (category: string) => {\n    switch (category) {\n      case 'house': return 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';\n      case 'car': return 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400';\n      case 'savings': return 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';\n      default: return 'bg-primary/10 text-primary';\n    }\n  };\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n    >\n      <Card \n        className=\"group overflow-hidden border-border/40 hover:shadow-lg hover:border-border transition-all duration-300\" \n        data-testid={`card-group-${group.id}`}\n      >\n        <div \n          className=\"h-1 bg-gradient-to-r from-primary/50 via-primary to-primary/50 transition-all duration-500\"\n          style={{ clipPath: `inset(0 ${100 - progress}% 0 0)` }}\n        />\n        \n        <CardHeader className=\"p-4 sm:p-5 pb-3\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n              <div className={`w-11 h-11 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center flex-shrink-0 ${getCategoryColor(group.category)}`}>\n                <GroupIcon className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n              </div>\n              <div className=\"min-w-0 flex-1\">\n                <CardTitle \n                  className=\"text-base sm:text-lg font-semibold truncate\" \n                  data-testid={`text-group-name-${group.id}`}\n                >\n                  {group.name}\n                </CardTitle>\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground mt-0.5\">\n                  <div className=\"flex items-center gap-1\">\n                    <Users className=\"w-3 h-3\" />\n                    <span>{memberCount} member{memberCount !== 1 ? 's' : ''}</span>\n                  </div>\n                  {group.category && (\n                    <>\n                      <span>-</span>\n                      <span className=\"capitalize\">{group.category}</span>\n                    </>\n                  )}\n                </div>\n              </div>\n            </div>\n            \n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  className=\"h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n                >\n                  <MoreHorizontal className=\"w-4 h-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={onInvite}>\n                  <UserPlus className=\"w-4 h-4 mr-2\" />\n                  Invite Members\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => {}}>\n                  <Settings className=\"w-4 h-4 mr-2\" />\n                  Settings\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={onDelete} className=\"text-destructive\">\n                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                  Delete Group\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"p-4 sm:p-5 pt-0 space-y-4\">\n          {targetAmount > 0 && (\n            <div className=\"flex items-center gap-4\">\n              <CircularProgress progress={progress} size={64} />\n              <div className=\"flex-1 min-w-0 space-y-1\">\n                <div className=\"flex items-baseline gap-1\">\n                  <span className=\"text-lg sm:text-xl font-bold text-primary\">\n                    <AnimatedNumber value={currentAmount} formatFn={formatAmount} />\n                  </span>\n                  <span className=\"text-sm text-muted-foreground\">\n                    / {formatAmount(targetAmount)}\n                  </span>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  {formatAmount(remaining)} remaining\n                </p>\n                {memberCount > 1 && remaining > 0 && (\n                  <p className=\"text-xs text-primary font-medium\">\n                    {formatAmount(Math.ceil(remaining / memberCount))}/person needed\n                  </p>\n                )}\n              </div>\n            </div>\n          )}\n          \n          {group.description && (\n            <p className=\"text-xs sm:text-sm text-muted-foreground line-clamp-2\">\n              {group.description}\n            </p>\n          )}\n          \n          <div className=\"flex gap-2\">\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              className=\"flex-1 h-10 text-xs sm:text-sm\"\n              onClick={onInvite}\n            >\n              <UserPlus className=\"w-3.5 h-3.5 mr-1.5\" />\n              Invite\n            </Button>\n            <Button \n              size=\"sm\" \n              className=\"flex-1 h-10 text-xs sm:text-sm\"\n              onClick={onContribute}\n              data-testid={`button-contribute-${group.id}`}\n            >\n              <DollarSign className=\"w-3.5 h-3.5 mr-1.5\" />\n              Contribute\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction SummaryCard({ \n  title, \n  value, \n  icon: Icon, \n  colorClass,\n  formatAmount,\n  delay = 0\n}: { \n  title: string; \n  value: string | number; \n  icon: any; \n  colorClass: string;\n  formatAmount?: (val: number) => string;\n  delay?: number;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n    >\n      <Card className=\"border-border/40\">\n        <CardContent className=\"p-4 sm:p-5\">\n          <div className=\"flex items-center gap-3\">\n            <div className={`p-2.5 rounded-xl ${colorClass.replace('text-', 'bg-').replace('600', '100').replace('400', '900/30')}`}>\n              <Icon className={`w-4 h-4 sm:w-5 sm:h-5 ${colorClass}`} />\n            </div>\n            <div>\n              <p className=\"text-xs text-muted-foreground\">{title}</p>\n              <p className={`text-lg sm:text-xl font-bold ${colorClass}`}>\n                {typeof value === 'number' && formatAmount ? <AnimatedNumber value={value} formatFn={formatAmount} /> : value}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nexport default function Groups() {\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [inviteDialogOpen, setInviteDialogOpen] = useState(false);\n  const [calculatorDialogOpen, setCalculatorDialogOpen] = useState(false);\n  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null);\n  const [selectedGroup, setSelectedGroup] = useState<any>(null);\n  const [inviteRole, setInviteRole] = useState<string>(\"member\");\n  const [inviteExpiry, setInviteExpiry] = useState<string>(\"7\");\n  const [generatedInvite, setGeneratedInvite] = useState<any>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const userId = useUserId();\n  const { formatAmount } = useUserCurrency();\n\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get('create') === '1') {\n      setIsCreateDialogOpen(true);\n      window.history.replaceState({}, '', '/groups');\n    }\n  }, []);\n\n  const { data: groups, isLoading } = useQuery({\n    queryKey: [\"/api/groups\"],\n    queryFn: () => fetch(\"/api/groups\").then(res => res.json()),\n  });\n\n  const deleteGroupMutation = useMutation({\n    mutationFn: (groupId: string) => apiRequest(\"DELETE\", `/api/groups/${groupId}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/groups\"] });\n      toast({\n        title: \"Group deleted\",\n        description: \"The group has been removed\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createInviteMutation = useMutation({\n    mutationFn: async ({ groupId, role, expiry }: { groupId: string; role: string; expiry: string }) => {\n      const expiryDays = parseInt(expiry);\n      const expiresAt = new Date(Date.now() + expiryDays * 24 * 60 * 60 * 1000);\n      const response = await apiRequest(\"POST\", `/api/groups/${groupId}/invites`, {\n        role,\n        expiresAt: expiresAt.toISOString(),\n      });\n      return await response.json();\n    },\n    onSuccess: (data) => {\n      setGeneratedInvite(data);\n      toast({\n        title: \"Invite created\",\n        description: \"Share the link with your group members\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeleteGroup = (groupId: string) => {\n    if (confirm(\"Are you sure you want to delete this group?\")) {\n      deleteGroupMutation.mutate(groupId);\n    }\n  };\n\n  const handleCreateInvite = (groupId: string) => {\n    setSelectedGroupId(groupId);\n    setGeneratedInvite(null);\n    setInviteDialogOpen(true);\n  };\n\n  const handleGenerateInvite = () => {\n    if (selectedGroupId) {\n      createInviteMutation.mutate({\n        groupId: selectedGroupId,\n        role: inviteRole,\n        expiry: inviteExpiry,\n      });\n    }\n  };\n\n  const handleCopyInviteLink = () => {\n    if (generatedInvite?.invite?.token) {\n      const inviteUrl = `${window.location.origin}/invite/${generatedInvite.invite.token}`;\n      navigator.clipboard.writeText(inviteUrl);\n      toast({\n        title: \"Link copied\",\n        description: \"Share this link to invite members\",\n      });\n    }\n  };\n\n  const handleContribute = (group: any) => {\n    setSelectedGroup(group);\n    setCalculatorDialogOpen(true);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <header className=\"bg-background/95 backdrop-blur border-b border-border/40 sticky top-0 z-30\">\n          <div className=\"w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6\">\n            <div className=\"h-8 bg-muted/50 rounded-lg w-48 mb-2 animate-pulse\" />\n            <div className=\"h-4 bg-muted/50 rounded w-64 animate-pulse\" />\n          </div>\n        </header>\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-6\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6\">\n            {[...Array(3)].map((_, i) => (\n              <Card key={i} className=\"p-5\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-11 h-11 rounded-xl bg-muted/50 animate-pulse\" />\n                  <div className=\"space-y-2 flex-1\">\n                    <div className=\"h-3 bg-muted/50 rounded w-20 animate-pulse\" />\n                    <div className=\"h-5 bg-muted/50 rounded w-24 animate-pulse\" />\n                  </div>\n                </div>\n              </Card>\n            ))}\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {[...Array(3)].map((_, i) => (\n              <Card key={i} className=\"p-5\">\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"w-12 h-12 rounded-xl bg-muted/50 animate-pulse\" />\n                  <div className=\"space-y-2 flex-1\">\n                    <div className=\"h-5 bg-muted/50 rounded w-3/4 animate-pulse\" />\n                    <div className=\"h-3 bg-muted/50 rounded w-1/2 animate-pulse\" />\n                  </div>\n                </div>\n                <div className=\"h-16 bg-muted/50 rounded-lg animate-pulse mb-4\" />\n                <div className=\"flex gap-2\">\n                  <div className=\"h-10 bg-muted/50 rounded flex-1 animate-pulse\" />\n                  <div className=\"h-10 bg-muted/50 rounded flex-1 animate-pulse\" />\n                </div>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const userGroups = groups || [];\n  \n  const totalTarget = userGroups.reduce((sum: number, g: any) => sum + parseFloat(g.budget || '0'), 0);\n  const totalCurrent = userGroups.reduce((sum: number, g: any) => sum + parseFloat(g.currentAmount || '0'), 0);\n  const totalMembers = userGroups.reduce((sum: number, g: any) => sum + (g.memberCount || 1), 0);\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"bg-background/95 backdrop-blur border-b border-border/40 sticky top-0 z-30\">\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6\">\n          <div className=\"flex items-center justify-between gap-3 sm:gap-4\">\n            <motion.div \n              className=\"flex-1 min-w-0\"\n              initial={{ opacity: 0, x: -20 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ duration: 0.4 }}\n            >\n              <h1 className=\"text-xl sm:text-2xl md:text-3xl font-semibold tracking-tight text-foreground\">\n                Shared Goals\n              </h1>\n              <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 hidden sm:block\">\n                Split costs and track contributions with your group\n              </p>\n            </motion.div>\n            \n            <motion.div\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.3, delay: 0.2 }}\n            >\n              <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button \n                    className=\"min-h-[44px] shadow-sm\"\n                    data-testid=\"button-create-group\"\n                  >\n                    <Plus size={18} className=\"sm:mr-2\" />\n                    <span className=\"hidden sm:inline\">New Group</span>\n                    <span className=\"sm:hidden\">New</span>\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"w-[95vw] max-w-lg max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>Create Shared Goal Group</DialogTitle>\n                    <DialogDescription>\n                      Create a group to track shared expenses like a house, car, or savings goal\n                    </DialogDescription>\n                  </DialogHeader>\n                  <GroupForm onSuccess={() => setIsCreateDialogOpen(false)} />\n                </DialogContent>\n              </Dialog>\n            </motion.div>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6\">\n        {userGroups.length === 0 ? (\n          <motion.div \n            className=\"text-center py-12 sm:py-20\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.5 }}\n          >\n            <div className=\"w-20 h-20 sm:w-24 sm:h-24 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6\">\n              <Users className=\"w-10 h-10 sm:w-12 sm:h-12 text-primary\" />\n            </div>\n            \n            <h3 className=\"text-xl sm:text-2xl font-semibold mb-3\">\n              Start a Shared Goal\n            </h3>\n            <p className=\"text-muted-foreground mb-8 max-w-md mx-auto text-sm sm:text-base\">\n              Create a group to split costs for big purchases like a house, car, or vacation. \n              Track everyone's contributions in one place.\n            </p>\n            \n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-2xl mx-auto mb-8\">\n              {[\n                { icon: Home, title: \"House Down Payment\", desc: \"Split with partner or family\", color: \"text-blue-600 dark:text-blue-400\" },\n                { icon: Car, title: \"Car Purchase\", desc: \"Share with co-buyers\", color: \"text-amber-600 dark:text-amber-400\" },\n                { icon: PiggyBank, title: \"Group Savings\", desc: \"Vacation, event, or gift\", color: \"text-green-600 dark:text-green-400\" },\n              ].map((item, index) => (\n                <motion.div\n                  key={item.title}\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.4, delay: 0.2 + index * 0.1 }}\n                >\n                  <Card className=\"p-4 text-center hover:shadow-md transition-shadow border-border/40\">\n                    <item.icon className={`w-8 h-8 mx-auto mb-2 ${item.color}`} />\n                    <h4 className=\"font-medium text-sm\">{item.title}</h4>\n                    <p className=\"text-xs text-muted-foreground\">{item.desc}</p>\n                  </Card>\n                </motion.div>\n              ))}\n            </div>\n            \n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ duration: 0.4, delay: 0.5 }}\n            >\n              <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button size=\"lg\" className=\"min-h-[48px]\" data-testid=\"button-create-first-group\">\n                    <Plus size={20} className=\"mr-2\" />\n                    Create Your First Group\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"w-[95vw] max-w-lg max-h-[90vh] overflow-y-auto\">\n                  <DialogHeader>\n                    <DialogTitle>Create Shared Goal Group</DialogTitle>\n                    <DialogDescription>\n                      Create a group to track shared expenses like a house, car, or savings goal\n                    </DialogDescription>\n                  </DialogHeader>\n                  <GroupForm onSuccess={() => setIsCreateDialogOpen(false)} />\n                </DialogContent>\n              </Dialog>\n            </motion.div>\n          </motion.div>\n        ) : (\n          <div className=\"space-y-4 sm:space-y-6\">\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4\">\n              <SummaryCard\n                title=\"Total Target\"\n                value={totalTarget}\n                icon={Target}\n                colorClass=\"text-primary\"\n                formatAmount={formatAmount}\n                delay={0}\n              />\n              <SummaryCard\n                title=\"Total Saved\"\n                value={totalCurrent}\n                icon={TrendingUp}\n                colorClass=\"text-green-600 dark:text-green-400\"\n                formatAmount={formatAmount}\n                delay={0.1}\n              />\n              <SummaryCard\n                title=\"Total Members\"\n                value={`${totalMembers}`}\n                icon={Users}\n                colorClass=\"text-blue-600 dark:text-blue-400\"\n                delay={0.2}\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              <AnimatePresence mode=\"popLayout\">\n                {userGroups.map((group: any, index: number) => (\n                  <GroupCard\n                    key={group.id}\n                    group={group}\n                    onInvite={() => handleCreateInvite(group.id)}\n                    onDelete={() => handleDeleteGroup(group.id)}\n                    onContribute={() => handleContribute(group)}\n                    formatAmount={formatAmount}\n                    delay={index * 0.1}\n                  />\n                ))}\n              </AnimatePresence>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <Dialog open={inviteDialogOpen} onOpenChange={setInviteDialogOpen}>\n        <DialogContent className=\"w-[95vw] max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Invite Members</DialogTitle>\n            <DialogDescription>\n              Generate a link to invite others to this group\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"invite-role\" className=\"text-sm font-medium\">Role</Label>\n              <Select value={inviteRole} onValueChange={setInviteRole}>\n                <SelectTrigger id=\"invite-role\" className=\"h-11 mt-1.5\" data-testid=\"select-invite-role\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"member\">Member</SelectItem>\n                  <SelectItem value=\"admin\">Admin</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div>\n              <Label htmlFor=\"invite-expiry\" className=\"text-sm font-medium\">Link Expires In</Label>\n              <Select value={inviteExpiry} onValueChange={setInviteExpiry}>\n                <SelectTrigger id=\"invite-expiry\" className=\"h-11 mt-1.5\" data-testid=\"select-invite-expiry\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">1 day</SelectItem>\n                  <SelectItem value=\"7\">7 days</SelectItem>\n                  <SelectItem value=\"30\">30 days</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            {generatedInvite ? (\n              <motion.div \n                className=\"space-y-3\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n              >\n                <div className=\"p-4 bg-muted/50 rounded-xl border border-border/40\">\n                  <p className=\"text-xs text-muted-foreground mb-2\">Invite Link</p>\n                  <p className=\"text-sm font-mono break-all text-foreground\">\n                    {`${window.location.origin}/invite/${generatedInvite.invite?.token}`}\n                  </p>\n                </div>\n                <Button onClick={handleCopyInviteLink} className=\"w-full min-h-[44px]\">\n                  <Copy className=\"w-4 h-4 mr-2\" />\n                  Copy Link\n                </Button>\n              </motion.div>\n            ) : (\n              <Button \n                onClick={handleGenerateInvite} \n                className=\"w-full min-h-[44px]\"\n                disabled={createInviteMutation.isPending}\n              >\n                {createInviteMutation.isPending ? (\n                  <>\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2\" />\n                    Creating...\n                  </>\n                ) : (\n                  <>\n                    <Sparkles className=\"w-4 h-4 mr-2\" />\n                    Generate Invite Link\n                  </>\n                )}\n              </Button>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={calculatorDialogOpen} onOpenChange={setCalculatorDialogOpen}>\n        <DialogContent className=\"w-[95vw] max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Calculator className=\"w-5 h-5\" />\n              Split Calculator\n            </DialogTitle>\n            <DialogDescription>\n              Calculate how much each person needs to contribute\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedGroup && (\n            <ExpenseSplitCalculator\n              totalAmount={parseFloat(selectedGroup.budget || '0') - parseFloat(selectedGroup.currentAmount || '0')}\n              memberCount={selectedGroup.memberCount || 1}\n              onClose={() => setCalculatorDialogOpen(false)}\n              formatAmount={formatAmount}\n            />\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31531,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from\"react\"\nimport * as RadioGroupPrimitive from\"@radix-ui/react-radio-group\"\nimport { Circle } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n React.ElementRef<typeof RadioGroupPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n return (\n  <RadioGroupPrimitive.Root\n   className={cn(\"grid gap-2\", className)}\n   {...props}\n   ref={ref}\n  />\n )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n React.ElementRef<typeof RadioGroupPrimitive.Item>,\n React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n return (\n  <RadioGroupPrimitive.Item\n   ref={ref}\n   className={cn(\n    \"relative h-11 w-11 min-h-[44px] min-w-[44px] cursor-pointer rounded-md ring-offset-background transition-all duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-50 flex items-center justify-center\",\n    \"before:absolute before:h-5 before:w-5 before:rounded-full before:border before:border-input before:transition-colors before:bg-background\",\n    \"data-[state=checked]:before:border-primary\",\n    \"hover:before:border-primary/60\",\n    className\n   )}\n   {...props}\n  >\n   <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center z-10\">\n    <Circle className=\"h-2.5 w-2.5 fill-primary text-primary\" />\n   </RadioGroupPrimitive.Indicator>\n  </RadioGroupPrimitive.Item>\n )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1684,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as ProgressPrimitive from\"@radix-ui/react-progress\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n React.ElementRef<typeof ProgressPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n <ProgressPrimitive.Root\n  ref={ref}\n  className={cn(\n  \"relative h-2 w-full overflow-hidden rounded-full bg-secondary\",\n   className\n  )}\n  {...props}\n >\n  <ProgressPrimitive.Indicator\n   className=\"h-full w-full flex-1 bg-primary transition-all duration-300 ease-out\"\n   style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n  />\n </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":780,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from\"react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Table = React.forwardRef<\n HTMLTableElement,\n React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n <div className=\"relative w-full overflow-auto\">\n  <table\n   ref={ref}\n   className={cn(\"w-full caption-bottom text-sm\", className)}\n   {...props}\n  />\n </div>\n))\nTable.displayName =\"Table\"\n\nconst TableHeader = React.forwardRef<\n HTMLTableSectionElement,\n React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName =\"TableHeader\"\n\nconst TableBody = React.forwardRef<\n HTMLTableSectionElement,\n React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n <tbody\n  ref={ref}\n  className={cn(\"[&_tr:last-child]:border-0\", className)}\n  {...props}\n />\n))\nTableBody.displayName =\"TableBody\"\n\nconst TableFooter = React.forwardRef<\n HTMLTableSectionElement,\n React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n <tfoot\n  ref={ref}\n  className={cn(\n  \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n   className\n  )}\n  {...props}\n />\n))\nTableFooter.displayName =\"TableFooter\"\n\nconst TableRow = React.forwardRef<\n HTMLTableRowElement,\n React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n <tr\n  ref={ref}\n  className={cn(\n  \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n   className\n  )}\n  {...props}\n />\n))\nTableRow.displayName =\"TableRow\"\n\nconst TableHead = React.forwardRef<\n HTMLTableCellElement,\n React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n <th\n  ref={ref}\n  className={cn(\n  \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n   className\n  )}\n  {...props}\n />\n))\nTableHead.displayName =\"TableHead\"\n\nconst TableCell = React.forwardRef<\n HTMLTableCellElement,\n React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n <td\n  ref={ref}\n  className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n  {...props}\n />\n))\nTableCell.displayName =\"TableCell\"\n\nconst TableCaption = React.forwardRef<\n HTMLTableCaptionElement,\n React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n <caption\n  ref={ref}\n  className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nTableCaption.displayName =\"TableCaption\"\n\nexport {\n Table,\n TableHeader,\n TableBody,\n TableFooter,\n TableHead,\n TableRow,\n TableCell,\n TableCaption,\n}\n","path":null,"size_bytes":2640,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from\"react\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst badgeVariants = cva(\n\"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n {\n  variants: {\n   variant: {\n    default:\n    \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n    secondary:\n    \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n    destructive:\n    \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n    outline:\"text-foreground\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n  },\n }\n)\n\nexport interface BadgeProps\n extends React.HTMLAttributes<HTMLDivElement>,\n  VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n return (\n  <div className={cn(badgeVariants({ variant }), className)} {...props} />\n )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1061,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { getQueryFn } from\"@/lib/queryClient\";\nimport type { User } from\"@shared/schema\";\n\nexport function useAuth() {\n const { data: user, isLoading } = useQuery<User>({\n  queryKey: [\"/api/auth/user\"],\n  queryFn: getQueryFn({ on401:\"returnNull\" }),\n  retry: false,\n });\n\n return {\n  user,\n  isLoading,\n  isAuthenticated: !!user,\n };\n}","path":null,"size_bytes":384,"size_tokens":null},"client/src/components/dashboard/ai-insights-card.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Brain, RefreshCw, MessageCircle, Crown, AlertTriangle } from\"lucide-react\";\nimport { useQuery } from\"@tanstack/react-query\";\nimport { Skeleton } from\"@/components/ui/skeleton\";\n\ninterface AIInsightsCardProps {\n onOpenChat?: () => void;\n}\n\ninterface AIInsights {\n insight: string;\n error?: string;\n}\n\ninterface UsageInfo {\n chatUsage: {\n  used: number;\n  limit: number;\n  remaining: number;\n  allowed: boolean;\n };\n analysisUsage: {\n  used: number;\n  limit: number;\n  remaining: number;\n  allowed: boolean;\n };\n insights: number;\n totalTokens: number;\n estimatedCost: string;\n}\n\nexport default function AIInsightsCard({ onOpenChat }: AIInsightsCardProps) {\n const { data: insights, isLoading, refetch, isRefetching, error } = useQuery<AIInsights>({\n  queryKey: [\"/api/ai/insights\"],\n  refetchInterval: 5 * 60 * 1000, // Refetch every 5 minutes\n  retry: (failureCount, error: any) => {\n   // Don't retry on 429 rate limit errors\n   if (error?.message?.includes('429') || error?.message?.includes('rate limit')) {\n    return false;\n   }\n   return failureCount < 2;\n  }\n });\n\n const { data: usage } = useQuery<UsageInfo>({\n  queryKey: [\"/api/subscription/usage\"],\n  refetchInterval: 30 * 1000 // Refetch every 30 seconds\n });\n\n return (\n  <Card className=\"h-full\">\n   <CardHeader className=\"pb-3\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-lg flex items-center gap-2\">\n      <Brain className=\"h-5 w-5 text-primary\" />\n      AI Insights\n     </CardTitle>\n     <Button\n      variant=\"ghost\"\n      size=\"sm\"\n      onClick={() => refetch()}\n      disabled={isRefetching}\n      data-testid=\"button-refresh-insights\"\n     >\n      <RefreshCw className={`h-4 w-4 ${isRefetching ? 'animate-spin' : ''}`} />\n     </Button>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"space-y-4\">\n    {isLoading ? (\n     <div className=\"space-y-3\">\n      <Skeleton className=\"h-4 w-full\" />\n      <Skeleton className=\"h-4 w-3/4\" />\n      <Skeleton className=\"h-4 w-1/2\" />\n     </div>\n    ) : error ? (\n     <div className=\"space-y-3\">\n      <div className=\"text-sm text-muted-foreground leading-relaxed\">\n       <p data-testid=\"text-ai-insight\">\n        Track your daily expenses to identify spending patterns and savings opportunities.\n       </p>\n       <p className=\"text-xs text-muted-foreground mt-2\">\n        {(error as any)?.message?.includes('429') || (error as any)?.message?.includes('rate limit') \n         ? 'AI insights temporarily unavailable due to high demand. Try again in a few minutes.' \n         : '* Showing fallback insight'}\n       </p>\n      </div>\n     </div>\n    ) : (\n     <>\n      <div className=\"text-sm text-foreground leading-relaxed\">\n       <p data-testid=\"text-ai-insight\">\n        {insights?.insight ||\"Focus on tracking your spending patterns this week.\"}\n       </p>\n       {insights?.error && (\n        <p className=\"text-xs text-muted-foreground mt-2\">\n         * Generated offline insight\n        </p>\n       )}\n      </div>\n\n      {/* Usage Information */}\n      {usage && (\n       <div className=\"space-y-3 pt-3 border-t\">\n        <div className=\"flex justify-between items-center text-xs\">\n         <span className=\"text-muted-foreground\">AI Chats this month</span>\n         <span className=\"font-medium\">\n          {usage.chatUsage.used} / {usage.chatUsage.limit}\n         </span>\n        </div>\n        <Progress \n         value={(usage.chatUsage.used / usage.chatUsage.limit) * 100} \n         className=\"h-2\"\n        />\n        \n        {usage.chatUsage.used >= usage.chatUsage.limit * 0.8 && (\n         <div className=\"flex items-center gap-2 text-xs text-orange-600 dark:text-orange-400\">\n          <AlertTriangle className=\"h-3 w-3\" />\n          <span>Running low on chat quota</span>\n         </div>\n        )}\n       </div>\n      )}\n\n      <div className=\"pt-2\">\n       <Button\n        onClick={onOpenChat}\n        variant=\"outline\"\n        className=\"w-full text-sm\"\n        data-testid=\"button-chat-with-ai\"\n       >\n        <MessageCircle className=\"h-4 w-4 mr-2\" />\n        Chat with AI for more advice\n       </Button>\n      </div>\n     </>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":4402,"size_tokens":null},"client/src/pages/subscription.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Crown, Check, Zap, TrendingUp, AlertTriangle, Sparkles, ArrowRight, Shield, Clock, Star } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\nimport { getLocalizedPrice, formatCurrency, getCurrencySymbol } from \"@/lib/currency\";\nimport AIROICalculator from \"@/components/ai-roi-calculator\";\nimport GlassmorphismCheckoutModal from \"@/components/glassmorphism-checkout-modal\";\n\ninterface SubscriptionPlan {\n  id: string;\n  name: string;\n  displayName: string;\n  description: string;\n  priceThb: string;\n  priceUsd: string;\n  currency: string;\n  billingInterval: string;\n  scoutLimit: number;\n  sonnetLimit: number;\n  gpt5Limit: number;\n  opusLimit: number;\n  aiChatLimit: number;\n  aiDeepAnalysisLimit: number;\n  aiInsightsFrequency: string;\n  isLifetimeLimit: boolean;\n  features: string[];\n  isActive: boolean;\n  sortOrder: number;\n}\n\ninterface Subscription {\n  id: string;\n  planId: string;\n  status: string;\n  currentPeriodStart: string;\n  currentPeriodEnd: string;\n  plan: SubscriptionPlan;\n}\n\ninterface SubscriptionData {\n  subscription: Subscription;\n  usage: {\n    aiChatsUsed: number;\n    aiDeepAnalysisUsed: number;\n    aiInsightsGenerated: number;\n    totalTokensUsed: number;\n    estimatedCostUsd: string;\n  };\n  addOns: any[];\n}\n\ninterface UsageInfo {\n  scoutUsage: { used: number; limit: number; remaining: number; };\n  sonnetUsage: { used: number; limit: number; remaining: number; };\n  gpt5Usage: { used: number; limit: number; remaining: number; };\n  opusUsage: { used: number; limit: number; remaining: number; };\n  chatUsage: { used: number; limit: number; remaining: number; allowed: boolean; };\n  analysisUsage: { used: number; limit: number; remaining: number; allowed: boolean; };\n  insights: number;\n  totalTokens: number;\n  estimatedCost: string;\n}\n\nfunction AnimatedNumber({ value, delay = 0 }: { value: number; delay?: number }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      const duration = 800;\n      const steps = 40;\n      const increment = value / steps;\n      let current = 0;\n      \n      const interval = setInterval(() => {\n        current += increment;\n        if (current >= value) {\n          setDisplayValue(value);\n          clearInterval(interval);\n        } else {\n          setDisplayValue(current);\n        }\n      }, duration / steps);\n      \n      return () => clearInterval(interval);\n    }, delay);\n    \n    return () => clearTimeout(timer);\n  }, [value, delay]);\n  \n  return <span>{Math.round(displayValue).toLocaleString()}</span>;\n}\n\nfunction AnimatedProgress({ value, className }: { value: number; className?: string }) {\n  const [animatedValue, setAnimatedValue] = useState(0);\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setAnimatedValue(value);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [value]);\n  \n  return <Progress value={animatedValue} className={className} />;\n}\n\nfunction UsageCard({ \n  title, \n  used, \n  limit, \n  icon: Icon, \n  color, \n  badge,\n  delay = 0\n}: { \n  title: string; \n  used: number; \n  limit: number; \n  icon: any; \n  color: string;\n  badge: string;\n  delay?: number;\n}) {\n  const percentage = limit === 999999 ? 0 : (used / limit) * 100;\n  const isWarning = percentage >= 80;\n  const isUnlimited = limit === 999999;\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n      className={`p-4 sm:p-5 bg-card rounded-xl border ${\n        color === 'blue' ? 'border-blue-200/30 dark:border-blue-800/30' :\n        color === 'emerald' ? 'border-emerald-200/30 dark:border-emerald-800/30' :\n        color === 'amber' ? 'border-amber-200/30 dark:border-amber-800/30' :\n        'border-border/30'\n      } space-y-4`}\n    >\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Icon className={`w-4 h-4 ${\n            color === 'blue' ? 'text-blue-600 dark:text-blue-400' :\n            color === 'emerald' ? 'text-emerald-600 dark:text-emerald-400' :\n            color === 'amber' ? 'text-amber-600 dark:text-amber-400' :\n            'text-primary'\n          }`} />\n          <span className=\"text-sm font-semibold\">{title}</span>\n        </div>\n        <Badge className={`text-xs px-2 py-0.5 ${\n          color === 'blue' ? 'bg-blue-500 text-white' :\n          color === 'emerald' ? 'bg-emerald-500 text-white' :\n          color === 'amber' ? 'bg-gradient-to-r from-amber-500 to-yellow-600 text-white' :\n          'bg-primary text-primary-foreground'\n        }`}>\n          {badge}\n        </Badge>\n      </div>\n      \n      <div className=\"flex items-baseline gap-1\">\n        <span className={`text-2xl font-bold ${\n          color === 'blue' ? 'text-blue-600 dark:text-blue-400' :\n          color === 'emerald' ? 'text-emerald-600 dark:text-emerald-400' :\n          color === 'amber' ? 'text-amber-600 dark:text-amber-400' :\n          'text-primary'\n        }`}>\n          <AnimatedNumber value={used} delay={delay * 1000} />\n        </span>\n        <span className=\"text-muted-foreground text-sm\">\n          / {isUnlimited ? 'Unlimited' : limit.toLocaleString()}\n        </span>\n      </div>\n      \n      {!isUnlimited && (\n        <>\n          <AnimatedProgress \n            value={percentage} \n            className={`h-2 ${\n              color === 'blue' ? 'bg-blue-100 dark:bg-blue-900/30' :\n              color === 'emerald' ? 'bg-emerald-100 dark:bg-emerald-900/30' :\n              color === 'amber' ? 'bg-amber-100 dark:bg-amber-900/30' :\n              'bg-muted'\n            }`}\n          />\n          {isWarning && (\n            <motion.div \n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              className=\"flex items-center gap-2 text-xs text-orange-600 dark:text-orange-400 bg-orange-100 dark:bg-orange-900/20 rounded-lg p-2\"\n            >\n              <AlertTriangle className=\"h-3 w-3\" />\n              <span className=\"font-medium\">Running low!</span>\n            </motion.div>\n          )}\n        </>\n      )}\n      \n      {isUnlimited && (\n        <div className=\"text-xs text-green-600 dark:text-green-400 font-medium\">\n          Unlimited queries available\n        </div>\n      )}\n    </motion.div>\n  );\n}\n\nfunction PlanCard({ \n  plan, \n  isCurrentPlan, \n  userCurrency,\n  onUpgrade,\n  delay = 0\n}: { \n  plan: SubscriptionPlan; \n  isCurrentPlan: boolean; \n  userCurrency: string;\n  onUpgrade: () => void;\n  delay?: number;\n}) {\n  const isPro = plan.name === 'pro';\n  const isEnterprise = plan.name === 'enterprise';\n  const isFree = plan.priceUsd === '0.00' || plan.name === 'free';\n  \n  const basePrice = parseFloat(plan.priceUsd);\n  const localizedPrice = getLocalizedPrice(basePrice, userCurrency);\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 30 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.5, delay }}\n      className=\"h-full\"\n    >\n      <Card \n        className={`relative h-full flex flex-col transition-all duration-300 ${\n          isPro \n            ? 'border-primary/40 shadow-lg ring-1 ring-primary/20 hover:shadow-xl' \n            : 'border-border/40 hover:border-border hover:shadow-lg'\n        } ${isCurrentPlan ? 'ring-2 ring-primary bg-primary/5' : ''}`}\n        data-testid={`card-plan-${plan.name.toLowerCase()}`}\n      >\n        {isPro && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: delay + 0.2 }}\n          >\n            <Badge className=\"absolute -top-3 left-1/2 transform -translate-x-1/2 bg-primary text-primary-foreground px-4 py-1 text-xs font-medium z-10\">\n              MOST POPULAR\n            </Badge>\n          </motion.div>\n        )}\n        {isEnterprise && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: delay + 0.2 }}\n          >\n            <Badge className=\"absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-amber-500 to-yellow-600 text-white px-4 py-1 text-xs font-medium z-10\">\n              BEST FOR CFO TEAMS\n            </Badge>\n          </motion.div>\n        )}\n        \n        <CardHeader className=\"space-y-4 p-5 sm:p-6\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg font-bold\">{plan.displayName}</CardTitle>\n            {isCurrentPlan && (\n              <Badge className=\"bg-primary text-primary-foreground px-3 py-1 text-xs font-medium\">\n                Active\n              </Badge>\n            )}\n          </div>\n          <CardDescription className=\"text-sm leading-relaxed\">{plan.description}</CardDescription>\n          \n          <div className=\"space-y-2 pt-2\">\n            {isFree ? (\n              <div className=\"flex items-baseline\">\n                <span className=\"text-4xl sm:text-5xl font-bold\">Free</span>\n              </div>\n            ) : (\n              <>\n                <div className=\"flex items-baseline gap-2\">\n                  <span className=\"text-4xl sm:text-5xl font-bold\">\n                    {localizedPrice.currency.symbol}{localizedPrice.amount.toFixed(2)}\n                  </span>\n                  <span className=\"text-muted-foreground text-base\">/month</span>\n                </div>\n                {localizedPrice.isDiscounted && localizedPrice.originalAmount && (\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-sm text-muted-foreground line-through\">\n                      {formatCurrency(localizedPrice.originalAmount, userCurrency)}\n                    </span>\n                    <Badge className=\"bg-green-500 text-white text-xs\">\n                      {Math.round((1 - localizedPrice.amount / localizedPrice.originalAmount) * 100)}% OFF\n                    </Badge>\n                  </div>\n                )}\n                {userCurrency !== 'USD' && (\n                  <p className=\"text-xs text-muted-foreground\">~{formatCurrency(basePrice, 'USD')} USD</p>\n                )}\n              </>\n            )}\n          </div>\n        </CardHeader>\n\n        <CardContent className=\"flex-1 flex flex-col space-y-6 p-5 sm:p-6 pt-0\">\n          <div className=\"space-y-4 flex-1\">\n            <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n              <Sparkles className=\"w-4 h-4 text-primary\" />\n              AI Model Quotas\n            </h4>\n            <div className=\"space-y-2.5\">\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                <div className=\"flex items-center gap-2\">\n                  <Zap className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                  <span className=\"text-sm\">Scout (Fast)</span>\n                </div>\n                <span className=\"text-sm font-bold text-blue-600 dark:text-blue-400\" data-testid={`text-${plan.name.toLowerCase()}-scout-limit`}>\n                  {plan.scoutLimit === 999999 ? 'Unlimited' : plan.scoutLimit}\n                </span>\n              </div>\n              \n              {plan.sonnetLimit > 0 && (\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2\">\n                    <Sparkles className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                    <span className=\"text-sm\">Sonnet (Smart)</span>\n                  </div>\n                  <span className=\"text-sm font-bold text-blue-600 dark:text-blue-400\" data-testid={`text-${plan.name.toLowerCase()}-sonnet-limit`}>\n                    {plan.sonnetLimit}\n                  </span>\n                </div>\n              )}\n              \n              {plan.gpt5Limit > 0 && (\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"w-4 h-4 text-emerald-600 dark:text-emerald-400\" />\n                    <span className=\"text-sm\">GPT-5 (Math)</span>\n                  </div>\n                  <span className=\"text-sm font-bold text-emerald-600 dark:text-emerald-400\" data-testid={`text-${plan.name.toLowerCase()}-gpt5-limit`}>\n                    {plan.gpt5Limit}\n                  </span>\n                </div>\n              )}\n              \n              {plan.opusLimit > 0 && (\n                <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2\">\n                    <Crown className=\"w-4 h-4 text-amber-600 dark:text-amber-400\" />\n                    <span className=\"text-sm\">Opus (CFO)</span>\n                  </div>\n                  <span className=\"text-sm font-bold text-amber-600 dark:text-amber-400\" data-testid={`text-${plan.name.toLowerCase()}-opus-limit`}>\n                    {plan.opusLimit === 999999 ? 'Unlimited' : plan.opusLimit}\n                  </span>\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-2.5 pt-2\">\n              <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                <Check className=\"w-4 h-4 text-green-500\" />\n                Features Included\n              </h4>\n              <ul className=\"space-y-2\">\n                {plan.features.slice(0, 5).map((feature, index) => (\n                  <li key={index} className=\"flex items-center gap-2.5 text-sm\">\n                    <div className=\"w-4 h-4 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0\">\n                      <Check className=\"w-2.5 h-2.5 text-green-600 dark:text-green-400\" />\n                    </div>\n                    <span className=\"text-muted-foreground capitalize\">{feature.replace(/_/g, ' ')}</span>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          </div>\n\n          <Button\n            className={`w-full h-12 text-base font-semibold ${\n              isCurrentPlan \n                ? 'bg-muted text-muted-foreground cursor-not-allowed' \n                : isPro || isEnterprise\n                  ? 'bg-primary hover:bg-primary/90 text-primary-foreground shadow-md hover:shadow-lg'\n                  : 'bg-primary hover:bg-primary/90 text-primary-foreground'\n            }`}\n            disabled={isCurrentPlan}\n            onClick={onUpgrade}\n            data-testid={`button-upgrade-${plan.name.toLowerCase()}`}\n          >\n            {isCurrentPlan ? (\n              <>\n                <Check className=\"w-4 h-4 mr-2\" />\n                Current Plan\n              </>\n            ) : isFree ? (\n              <>\n                Start Free\n                <ArrowRight className=\"w-4 h-4 ml-2\" />\n              </>\n            ) : (\n              <>\n                Upgrade to {plan.name}\n                <Crown className=\"w-4 h-4 ml-2\" />\n              </>\n            )}\n          </Button>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nconst formatFeatureName = (feature: string) => {\n  const map: Record<string, string> = {\n    'basic_tracking': 'Basic expense tracking',\n    'ai_chat': 'AI financial assistant',\n    'advanced_goals': 'Advanced goal setting',\n    'group_planning': 'Group event planning',\n    'transaction_import': 'Import transactions',\n    'priority_support': 'Priority support',\n    'advanced_analytics': 'Advanced analytics',\n    'api_access': 'API access'\n  };\n  return map[feature] || feature.replace(/_/g, ' ');\n};\n\nexport default function SubscriptionPage() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);\n  const [selectedPlanForCheckout, setSelectedPlanForCheckout] = useState<SubscriptionPlan | null>(null);\n\n  const { data: plans, isLoading: plansLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription/plans\"]\n  });\n\n  const { data: currentSubscription, isLoading: subscriptionLoading } = useQuery<SubscriptionData>({\n    queryKey: [\"/api/subscription/current\"]\n  });\n\n  const { data: usage } = useQuery<UsageInfo>({\n    queryKey: [\"/api/subscription/usage\"],\n    refetchInterval: 5 * 60 * 1000,\n  });\n\n  const { data: userPreferences } = useQuery<{ currency?: string }>({\n    queryKey: [\"/api/user-preferences\"],\n  });\n\n  const handleUpgradeClick = (plan: SubscriptionPlan) => {\n    if (plan.name === 'free') {\n      apiRequest(\"POST\", \"/api/subscription/upgrade\", { planId: plan.id })\n        .then(() => {\n          toast({\n            title: \"Switched to Free Plan\",\n            description: \"You're now on the Free plan.\"\n          });\n          queryClient.invalidateQueries({ queryKey: [\"/api/subscription/current\"] });\n          queryClient.invalidateQueries({ queryKey: [\"/api/subscription/usage\"] });\n        })\n        .catch((error: any) => {\n          toast({\n            title: \"Upgrade failed\",\n            description: error.message || \"Failed to change plan\",\n            variant: \"destructive\"\n          });\n        });\n    } else {\n      setSelectedPlanForCheckout(plan);\n      setIsCheckoutModalOpen(true);\n    }\n  };\n\n  const handleCloseCheckoutModal = () => {\n    setIsCheckoutModalOpen(false);\n    setSelectedPlanForCheckout(null);\n  };\n\n  if (plansLoading || subscriptionLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <header className=\"bg-background/95 backdrop-blur border-b border-border/40 sticky top-0 z-30\">\n          <div className=\"w-full px-4 sm:px-6 lg:px-8 py-6\">\n            <Skeleton className=\"h-8 w-48 mb-2\" />\n            <Skeleton className=\"h-4 w-64\" />\n          </div>\n        </header>\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-8 space-y-8\">\n          <Card className=\"p-6\">\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-6 w-48\" />\n              <div className=\"grid gap-4 md:grid-cols-4\">\n                {[...Array(4)].map((_, i) => (\n                  <Skeleton key={i} className=\"h-32 rounded-xl\" />\n                ))}\n              </div>\n            </div>\n          </Card>\n          <div className=\"grid gap-6 md:grid-cols-3\">\n            {[1, 2, 3].map(i => (\n              <Skeleton key={i} className=\"h-[500px] rounded-xl\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const currentPlan = currentSubscription?.subscription?.plan;\n  const userCurrency = userPreferences?.currency || 'USD';\n\n  return (\n    <div className=\"min-h-screen-mobile bg-background pb-20 md:pb-0\">\n      <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-6\">\n          <motion.div\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ duration: 0.4 }}\n          >\n            <h1 className=\"text-lg sm:text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight text-foreground\">\n              Subscription Plans\n            </h1>\n            <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 line-clamp-1\">\n              Upgrade your account to unlock advanced features\n            </p>\n          </motion.div>\n        </div>\n      </header>\n      \n      <div className=\"w-full px-4 sm:px-6 lg:px-8 py-6 sm:py-8 space-y-8 sm:space-y-12\">\n        {currentPlan && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.4 }}\n          >\n            <Card className=\"border-border/40 overflow-hidden\">\n              <CardHeader className=\"space-y-3 pb-4\">\n                <div className=\"flex items-center justify-between flex-wrap gap-3\">\n                  <div>\n                    <h2 className=\"text-lg sm:text-xl font-semibold\">Your Current Plan</h2>\n                    <p className=\"text-sm text-muted-foreground\">{currentPlan.displayName}</p>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-0\">\n                    Active\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {usage && (\n                  <div className=\"grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4\">\n                    <UsageCard\n                      title=\"Scout Queries\"\n                      used={usage.scoutUsage.used}\n                      limit={usage.scoutUsage.limit}\n                      icon={Zap}\n                      color=\"blue\"\n                      badge=\"Fast\"\n                      delay={0}\n                    />\n                    \n                    {usage.sonnetUsage.limit > 0 && (\n                      <UsageCard\n                        title=\"Sonnet Queries\"\n                        used={usage.sonnetUsage.used}\n                        limit={usage.sonnetUsage.limit}\n                        icon={Sparkles}\n                        color=\"blue\"\n                        badge=\"Smart\"\n                        delay={0.1}\n                      />\n                    )}\n                    \n                    {usage.gpt5Usage && usage.gpt5Usage.limit > 0 && (\n                      <UsageCard\n                        title=\"GPT-5 Queries\"\n                        used={usage.gpt5Usage.used}\n                        limit={usage.gpt5Usage.limit}\n                        icon={TrendingUp}\n                        color=\"emerald\"\n                        badge=\"Math\"\n                        delay={0.2}\n                      />\n                    )}\n                    \n                    {usage.opusUsage.limit > 0 && (\n                      <UsageCard\n                        title=\"Opus Queries\"\n                        used={usage.opusUsage.used}\n                        limit={usage.opusUsage.limit}\n                        icon={Crown}\n                        color=\"amber\"\n                        badge=\"CFO\"\n                        delay={0.3}\n                      />\n                    )}\n                  </div>\n                )}\n\n                <div className=\"grid gap-4 sm:grid-cols-3\">\n                  {[\n                    { label: 'Insights Generated', value: usage?.insights || 0, icon: Sparkles },\n                    { label: 'Tokens Used', value: usage?.totalTokens || 0, icon: Zap },\n                    { label: 'AI Costs', value: formatCurrency(parseFloat(usage?.estimatedCost || '0'), 'USD'), icon: TrendingUp },\n                  ].map((stat, index) => (\n                    <motion.div\n                      key={stat.label}\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ duration: 0.3, delay: 0.4 + index * 0.1 }}\n                      className=\"text-center p-4 sm:p-5 bg-muted/50 rounded-xl\"\n                    >\n                      <stat.icon className=\"w-5 h-5 mx-auto mb-2 text-muted-foreground\" />\n                      <p className=\"text-xl sm:text-2xl font-bold\">\n                        {typeof stat.value === 'number' ? <AnimatedNumber value={stat.value} delay={400 + index * 100} /> : stat.value}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">{stat.label}</p>\n                    </motion.div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        <AIROICalculator \n          userCurrency={userCurrency}\n          currentTier={\n            currentPlan?.name === 'enterprise' ? 'enterprise' :\n            currentPlan?.name === 'pro' ? 'pro' : 'free'\n          }\n        />\n\n        <div className=\"space-y-8 sm:space-y-10\">\n          <motion.div \n            className=\"text-center space-y-3 sm:space-y-4\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.5 }}\n          >\n            <h2 className=\"text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight text-foreground\">\n              Choose Your Plan\n            </h2>\n            <p className=\"text-sm sm:text-base md:text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Start free and scale as you grow. Unlock AI-powered financial insights.\n            </p>\n            <div className=\"flex flex-wrap items-center justify-center gap-4 sm:gap-6 text-xs sm:text-sm text-muted-foreground pt-2\">\n              {[\n                { icon: Shield, text: 'Cancel anytime' },\n                { icon: Zap, text: 'Instant activation' },\n                { icon: Star, text: 'No setup fees' },\n              ].map((item, index) => (\n                <motion.div\n                  key={item.text}\n                  className=\"flex items-center gap-1.5\"\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.3, delay: 0.3 + index * 0.1 }}\n                >\n                  <item.icon className=\"w-4 h-4 text-green-500\" />\n                  <span>{item.text}</span>\n                </motion.div>\n              ))}\n            </div>\n          </motion.div>\n\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 max-w-6xl mx-auto px-1\">\n            {plans?.sort((a, b) => a.sortOrder - b.sortOrder).slice(0, 3).map((plan, index) => (\n              <PlanCard\n                key={plan.id}\n                plan={plan}\n                isCurrentPlan={currentPlan?.id === plan.id}\n                userCurrency={userCurrency}\n                onUpgrade={() => handleUpgradeClick(plan)}\n                delay={index * 0.15}\n              />\n            ))}\n          </div>\n        </div>\n\n        <motion.div\n          initial={{ opacity: 0, y: 30 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5, delay: 0.6 }}\n        >\n          <Card className=\"relative overflow-hidden border-border/40\">\n            <div className=\"absolute inset-0 bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5\" />\n            <CardContent className=\"relative p-6 sm:p-8\">\n              <div className=\"text-center space-y-6\">\n                <div className=\"flex items-center justify-center gap-4\">\n                  <div className=\"p-3 sm:p-4 bg-primary/10 rounded-2xl\">\n                    <Zap className=\"h-8 w-8 sm:h-10 sm:w-10 text-primary\" />\n                  </div>\n                  <div className=\"text-left\">\n                    <h3 className=\"text-xl sm:text-2xl font-bold text-foreground\">\n                      Why Choose Twealth AI?\n                    </h3>\n                    <p className=\"text-sm sm:text-base text-muted-foreground\">\n                      Advanced AI technology at unbeatable prices\n                    </p>\n                  </div>\n                </div>\n                \n                <div className=\"grid gap-4 sm:gap-6 sm:grid-cols-3\">\n                  {[\n                    { value: '25x', label: 'Cheaper than hiring a CFO' },\n                    { value: '4', label: 'AI models working for you' },\n                    { value: '24/7', label: 'Financial insights available' },\n                  ].map((stat, index) => (\n                    <motion.div\n                      key={stat.label}\n                      initial={{ opacity: 0, scale: 0.9 }}\n                      animate={{ opacity: 1, scale: 1 }}\n                      transition={{ duration: 0.4, delay: 0.8 + index * 0.1 }}\n                      className=\"text-center p-4 sm:p-6 bg-card rounded-xl border border-border/40\"\n                    >\n                      <p className=\"text-2xl sm:text-3xl md:text-4xl font-bold text-primary\">{stat.value}</p>\n                      <p className=\"text-xs sm:text-sm text-muted-foreground mt-1\">{stat.label}</p>\n                    </motion.div>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </div>\n\n      <GlassmorphismCheckoutModal\n        isOpen={isCheckoutModalOpen}\n        onClose={handleCloseCheckoutModal}\n        plan={selectedPlanForCheckout}\n        localizedPrice={selectedPlanForCheckout ? {\n          ...getLocalizedPrice(parseFloat(selectedPlanForCheckout.priceUsd), userCurrency),\n        } : { amount: 0, currency: { symbol: '$', code: 'USD' } }}\n        userCurrency={userCurrency}\n        onSuccess={() => {\n          toast({\n            title: \"Subscription Activated!\",\n            description: `You're now on ${selectedPlanForCheckout?.displayName}. Enjoy your premium features!`,\n          });\n          handleCloseCheckoutModal();\n        }}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":29677,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as HoverCardPrimitive from\"@radix-ui/react-hover-card\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n React.ElementRef<typeof HoverCardPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align =\"center\", sideOffset = 4, ...props }, ref) => (\n <HoverCardPrimitive.Content\n  ref={ref}\n  align={align}\n  sideOffset={sideOffset}\n  className={cn(\n  \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n   className\n  )}\n  {...props}\n />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1224,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from\"react\"\nimport * as SwitchPrimitives from\"@radix-ui/react-switch\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n React.ElementRef<typeof SwitchPrimitives.Root>,\n React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n <SwitchPrimitives.Root\n  className={cn(\n   \"peer inline-flex h-11 min-h-[44px] w-[60px] shrink-0 cursor-pointer items-center rounded-full px-1 transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/20 focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input hover:data-[state=unchecked]:bg-input/80\",\n   className\n  )}\n  {...props}\n  ref={ref}\n >\n  <SwitchPrimitives.Thumb\n   className={cn(\n    \"pointer-events-none block h-9 w-9 rounded-full bg-background shadow-lg ring-0 transition-transform duration-200 data-[state=checked]:translate-x-[18px] data-[state=unchecked]:translate-x-0\"\n   )}\n  />\n </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1173,"size_tokens":null},"client/src/pages/money-tracking.tsx":{"content":"import { useState, useEffect, lazy, Suspense, useMemo } from \"react\";\nimport { useTranslation } from 'react-i18next';\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus, TrendingUp, TrendingDown, DollarSign, Filter, Calendar, \n  BarChart3, Target, Lightbulb, Sparkles, CheckCircle, FileText, \n  Download, ChevronDown, ArrowUpRight, ArrowDownRight, Wallet,\n  CreditCard, ShoppingBag, Home, Car, Utensils, Heart, Plane,\n  Zap, Coffee, Smartphone, Gift, Briefcase, PiggyBank, Save, \n  Building2, AlertCircle, User\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport EmptyState from \"@/components/ui/empty-state\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient as globalQueryClient } from \"@/lib/queryClient\";\nimport TransactionForm from \"@/components/forms/transaction-form\";\nimport AdvancedSpendingAnalytics from \"@/components/money/advanced-spending-analytics\";\nimport SmartBudgetManagement from \"@/components/money/smart-budget-management\";\nimport SpendingInsights from \"@/components/money/spending-insights\";\nimport { SwipeableTransactionItem } from \"@/components/transactions/swipeable-transaction-item\";\nimport { ResponsiveTransactionDialog } from \"@/components/dialogs/responsive-transaction-dialog\";\nimport { CollapsibleList } from \"@/components/virtual-list\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\nconst financialProfileSchema = z.object({\n  monthlyIncome: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n  monthlyExpenses: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n  monthlySavings: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n  totalSavings: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n  savingsGoal: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n  emergencyFund: z.string().min(1, \"Required\").refine(v => !isNaN(Number(v)) && Number(v) >= 0, \"Must be a valid number\"),\n});\n\ntype FinancialProfileData = z.infer<typeof financialProfileSchema>;\n\nconst CSVAnalysisPanel = lazy(() => import(\"@/components/money/csv-analysis-panel\"));\n\nconst TRANSACTION_CATEGORIES = {\n  income: [\"salary\", \"freelance\", \"investment\", \"gift\", \"other\"],\n  expense: [\"rent\", \"utilities\", \"groceries\", \"dining\", \"transport\", \"healthcare\", \"entertainment\", \"shopping\", \"other\"],\n  transfer: [\"savings\", \"investment\", \"goal_contribution\"]\n};\n\nconst getCategoryIcon = (category: string) => {\n  const icons: Record<string, JSX.Element> = {\n    salary: <Briefcase className=\"w-4 h-4\" />,\n    freelance: <Zap className=\"w-4 h-4\" />,\n    investment: <TrendingUp className=\"w-4 h-4\" />,\n    rent: <Home className=\"w-4 h-4\" />,\n    utilities: <Zap className=\"w-4 h-4\" />,\n    groceries: <ShoppingBag className=\"w-4 h-4\" />,\n    dining: <Utensils className=\"w-4 h-4\" />,\n    transport: <Car className=\"w-4 h-4\" />,\n    healthcare: <Heart className=\"w-4 h-4\" />,\n    entertainment: <Smartphone className=\"w-4 h-4\" />,\n    shopping: <CreditCard className=\"w-4 h-4\" />,\n    gift: <Gift className=\"w-4 h-4\" />,\n    savings: <PiggyBank className=\"w-4 h-4\" />,\n    travel: <Plane className=\"w-4 h-4\" />,\n    coffee: <Coffee className=\"w-4 h-4\" />,\n    other: <Wallet className=\"w-4 h-4\" />,\n  };\n  return icons[category.toLowerCase()] || <DollarSign className=\"w-4 h-4\" />;\n};\n\nfunction AnimatedNumber({ value, prefix = \"$\", decimals = 0 }: { value: number; prefix?: string; decimals?: number }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const duration = 1000;\n    const steps = 60;\n    const increment = value / steps;\n    let current = 0;\n    \n    const timer = setInterval(() => {\n      current += increment;\n      if (current >= value) {\n        setDisplayValue(value);\n        clearInterval(timer);\n      } else {\n        setDisplayValue(current);\n      }\n    }, duration / steps);\n    \n    return () => clearInterval(timer);\n  }, [value]);\n  \n  return (\n    <span>\n      {prefix}{displayValue.toLocaleString(undefined, { \n        minimumFractionDigits: decimals, \n        maximumFractionDigits: decimals \n      })}\n    </span>\n  );\n}\n\nfunction StatCard({ \n  title, \n  value, \n  icon: Icon, \n  trend, \n  trendLabel,\n  colorClass,\n  bgClass,\n  delay = 0,\n  currencyPrefix = \"$\"\n}: { \n  title: string; \n  value: number; \n  icon: any; \n  trend?: 'up' | 'down' | 'neutral';\n  trendLabel?: string;\n  colorClass: string;\n  bgClass: string;\n  delay?: number;\n  currencyPrefix?: string;\n}) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay }}\n    >\n      <Card className=\"relative overflow-hidden group hover:shadow-lg transition-all duration-300 border-border/40\">\n        <div className={`absolute inset-0 ${bgClass} opacity-50`} />\n        <CardContent className=\"relative p-4 sm:p-6\">\n          <div className=\"flex items-start justify-between mb-3 sm:mb-4\">\n            <div className={`p-2 sm:p-2.5 rounded-xl ${bgClass}`}>\n              <Icon className={`w-4 h-4 sm:w-5 sm:h-5 ${colorClass}`} />\n            </div>\n            {trend && (\n              <div className={`flex items-center gap-1 text-xs font-medium ${\n                trend === 'up' ? 'text-green-600' : trend === 'down' ? 'text-red-600' : 'text-muted-foreground'\n              }`}>\n                {trend === 'up' ? (\n                  <ArrowUpRight className=\"w-3 h-3\" />\n                ) : trend === 'down' ? (\n                  <ArrowDownRight className=\"w-3 h-3\" />\n                ) : null}\n                {trendLabel}\n              </div>\n            )}\n          </div>\n          <p className=\"text-xs sm:text-sm font-medium text-muted-foreground mb-1\">{title}</p>\n          <p className={`text-xl sm:text-3xl font-bold tracking-tight ${colorClass}`}>\n            <AnimatedNumber value={value} prefix={currencyPrefix} />\n          </p>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nfunction CategoryBreakdown({ transactions }: { transactions: any[] }) {\n  const { formatAmount } = useUserCurrency();\n  const categoryTotals = useMemo(() => {\n    const totals: Record<string, number> = {};\n    transactions\n      .filter(t => t.type === 'expense')\n      .forEach(t => {\n        const cat = t.category || 'other';\n        totals[cat] = (totals[cat] || 0) + parseFloat(t.amount);\n      });\n    return Object.entries(totals)\n      .map(([category, amount]) => ({ category, amount }))\n      .sort((a, b) => b.amount - a.amount)\n      .slice(0, 5);\n  }, [transactions]);\n\n  const totalExpenses = categoryTotals.reduce((sum, c) => sum + c.amount, 0);\n\n  if (categoryTotals.length === 0) return null;\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay: 0.3 }}\n    >\n      <Card className=\"border-border/40\">\n        <CardHeader className=\"pb-3 sm:pb-4\">\n          <CardTitle className=\"text-sm sm:text-base font-semibold flex items-center gap-2\">\n            <BarChart3 className=\"w-4 h-4 text-primary\" />\n            Top Spending Categories\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3 sm:space-y-4\">\n          {categoryTotals.map((cat, index) => {\n            const percentage = totalExpenses > 0 ? (cat.amount / totalExpenses) * 100 : 0;\n            return (\n              <motion.div \n                key={cat.category}\n                initial={{ opacity: 0, x: -20 }}\n                animate={{ opacity: 1, x: 0 }}\n                transition={{ duration: 0.3, delay: index * 0.1 }}\n                className=\"space-y-1.5 sm:space-y-2\"\n              >\n                <div className=\"flex items-center justify-between text-xs sm:text-sm\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"p-1.5 rounded-lg bg-muted\">\n                      {getCategoryIcon(cat.category)}\n                    </div>\n                    <span className=\"font-medium capitalize\">{cat.category}</span>\n                  </div>\n                  <span className=\"font-semibold\">{formatAmount(cat.amount)}</span>\n                </div>\n                <div className=\"relative h-2 bg-muted rounded-full overflow-hidden\">\n                  <motion.div\n                    className=\"absolute inset-y-0 left-0 bg-primary rounded-full\"\n                    initial={{ width: 0 }}\n                    animate={{ width: `${percentage}%` }}\n                    transition={{ duration: 0.8, delay: 0.2 + index * 0.1 }}\n                  />\n                </div>\n                <p className=\"text-[10px] sm:text-xs text-muted-foreground text-right\">\n                  {percentage.toFixed(1)}% of expenses\n                </p>\n              </motion.div>\n            );\n          })}\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n\nexport default function MoneyTracking() {\n  const { t } = useTranslation();\n  const { formatAmount, currencySymbol } = useUserCurrency();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [isFiltersExpanded, setIsFiltersExpanded] = useState(false);\n  \n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get('add') === '1') {\n      setIsCreateDialogOpen(true);\n      window.history.replaceState({}, '', '/money-tracking');\n    }\n  }, []);\n  \n  const [filterType, setFilterType] = useState<string>(\"all\");\n  const [filterCategory, setFilterCategory] = useState<string>(\"all\");\n  const [timeRange, setTimeRange] = useState<string>(\"30\");\n\n  const { data: transactions, isLoading } = useQuery({\n    queryKey: [\"/api/transactions\", filterType, filterCategory, timeRange],\n    queryFn: () => fetch(`/api/transactions?limit=100`).then(res => res.json()),\n  });\n\n  const { data: stats } = useQuery({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  // Financial Profile data and form\n  const { data: profileData } = useQuery<any>({\n    queryKey: [\"/api/user/financial-profile\"],\n  });\n\n  const [isSavingProfile, setIsSavingProfile] = useState(false);\n  \n  const profileForm = useForm<FinancialProfileData>({\n    resolver: zodResolver(financialProfileSchema),\n    defaultValues: {\n      monthlyIncome: \"0\",\n      monthlyExpenses: \"0\",\n      monthlySavings: \"0\",\n      totalSavings: \"0\",\n      savingsGoal: \"0\",\n      emergencyFund: \"0\",\n    },\n    values: profileData?.profile ? {\n      monthlyIncome: profileData.profile.monthlyIncome?.toString() || \"0\",\n      monthlyExpenses: profileData.profile.monthlyExpenses?.toString() || \"0\",\n      monthlySavings: profileData.profile.monthlySavings?.toString() || \"0\",\n      totalSavings: profileData.profile.totalSavings?.toString() || \"0\",\n      savingsGoal: profileData.profile.savingsGoal?.toString() || \"0\",\n      emergencyFund: profileData.profile.emergencyFund?.toString() || \"0\",\n    } : undefined\n  });\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: FinancialProfileData) => {\n      const payload = {\n        profile: {\n          monthlyIncome: data.monthlyIncome,\n          monthlyExpenses: data.monthlyExpenses,\n          monthlySavings: data.monthlySavings,\n          totalSavings: data.totalSavings,\n          savingsGoal: data.savingsGoal,\n          emergencyFund: data.emergencyFund,\n        }\n      };\n      return apiRequest(\"POST\", \"/api/user/financial-profile\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/financial-profile\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial-health\"] });\n      toast({\n        title: \"Profile Updated!\",\n        description: \"Your financial profile has been saved successfully.\",\n      });\n      setIsSavingProfile(false);\n    },\n    onError: () => {\n      toast({\n        title: \"Update Failed\",\n        description: \"Failed to save your profile. Please try again.\",\n        variant: \"destructive\",\n      });\n      setIsSavingProfile(false);\n    },\n  });\n\n  const onProfileSubmit = async (data: FinancialProfileData) => {\n    setIsSavingProfile(true);\n    updateProfileMutation.mutate(data);\n  };\n\n  const bulkCategorizeMutation = useMutation({\n    mutationFn: async () => {\n      const uncategorizedIds = transactions\n        ?.filter((t: any) => t.category === 'Other' || t.category === 'other')\n        .map((t: any) => t.id) || [];\n      \n      if (uncategorizedIds.length === 0) {\n        throw new Error(\"No uncategorized transactions to fix\");\n      }\n      \n      const response = await apiRequest('POST', '/api/transactions/bulk-categorize', { transactionIds: uncategorizedIds });\n      return await response.json();\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n      toast({\n        title: \"Categories Fixed\",\n        description: `Successfully categorized ${data.updated} of ${data.total} transactions using AI detection.`,\n        variant: \"default\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to categorize transactions\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const archiveTransactionMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const response = await apiRequest('PATCH', `/api/transactions/${id}/archive`);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n      toast({\n        title: \"Transaction Archived\",\n        description: \"Transaction has been archived successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to archive transaction\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const flagTransactionMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const response = await apiRequest('PATCH', `/api/transactions/${id}/flag`);\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n      toast({\n        title: \"Transaction Flagged\",\n        description: \"Transaction has been flagged for review\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to flag transaction\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredTransactions = useMemo(() => {\n    if (!transactions) return [];\n    return transactions.filter((transaction: any) => {\n      const typeMatch = filterType === \"all\" || transaction.type === filterType;\n      const categoryMatch = filterCategory === \"all\" || transaction.category === filterCategory;\n      \n      const transactionDate = new Date(transaction.date);\n      const daysAgo = new Date(Date.now() - parseInt(timeRange) * 24 * 60 * 60 * 1000);\n      const dateMatch = transactionDate >= daysAgo;\n      \n      return typeMatch && categoryMatch && dateMatch;\n    });\n  }, [transactions, filterType, filterCategory, timeRange]);\n\n  const { totalIncome, totalExpenses, netCashFlow } = useMemo(() => {\n    const income = filteredTransactions\n      .filter((t: any) => t.type === \"income\")\n      .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n\n    const expenses = filteredTransactions\n      .filter((t: any) => t.type === \"expense\")\n      .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n\n    return { totalIncome: income, totalExpenses: expenses, netCashFlow: income - expenses };\n  }, [filteredTransactions]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n          <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6\">\n            <div className=\"h-8 bg-muted/50 rounded-lg w-48 mb-2 animate-pulse\" />\n            <div className=\"h-4 bg-muted/50 rounded w-64 animate-pulse\" />\n          </div>\n        </header>\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-8\">\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n            {[...Array(4)].map((_, i) => (\n              <Card key={i} className=\"p-6 border-border/50\">\n                <div className=\"h-10 w-10 bg-muted/50 rounded-xl mb-4 animate-pulse\" />\n                <div className=\"h-4 bg-muted/50 rounded w-1/2 mb-2 animate-pulse\" />\n                <div className=\"h-8 bg-muted/50 rounded w-3/4 animate-pulse\" />\n              </Card>\n            ))}\n          </div>\n          <Card className=\"p-6\">\n            <div className=\"space-y-4\">\n              {[...Array(5)].map((_, i) => (\n                <div key={i} className=\"flex items-center gap-4\">\n                  <div className=\"h-10 w-10 bg-muted/50 rounded-full animate-pulse\" />\n                  <div className=\"flex-1\">\n                    <div className=\"h-4 bg-muted/50 rounded w-1/3 mb-2 animate-pulse\" />\n                    <div className=\"h-3 bg-muted/50 rounded w-1/4 animate-pulse\" />\n                  </div>\n                  <div className=\"h-6 bg-muted/50 rounded w-20 animate-pulse\" />\n                </div>\n              ))}\n            </div>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen-mobile bg-background pb-24 md:pb-0\">\n      <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n        <div className=\"w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-6\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <motion.div \n              className=\"flex-1 min-w-0\"\n              initial={{ opacity: 0, x: -20 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ duration: 0.4 }}\n            >\n              <h1 className=\"text-lg sm:text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight text-foreground truncate\">\n                My Money\n              </h1>\n              <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 hidden sm:block line-clamp-1\">\n                Track your finances and manage your financial profile\n              </p>\n            </motion.div>\n            \n            <motion.div\n              initial={{ opacity: 0, scale: 0.9 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.3, delay: 0.2 }}\n            >\n              <ResponsiveTransactionDialog \n                open={isCreateDialogOpen} \n                onOpenChange={setIsCreateDialogOpen}\n              />\n            </motion.div>\n          </div>\n        </div>\n      </header>\n      \n      <div className=\"w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6\">\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <motion.div \n            className=\"overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0 mb-4 sm:mb-6 scrollbar-none scroll-snap-x\"\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.3 }}\n          >\n            <TabsList className=\"inline-flex w-auto min-w-full md:grid md:w-full md:grid-cols-6 p-1 gap-1 bg-muted/50\">\n              <TabsTrigger value=\"overview\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-overview\">\n                <DollarSign size={14} className=\"flex-shrink-0\" />\n                <span>Overview</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"profile\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-profile\">\n                <User size={14} className=\"flex-shrink-0\" />\n                <span>Profile</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"analytics\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-analytics\">\n                <BarChart3 size={14} className=\"flex-shrink-0\" />\n                <span>Analytics</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"budget\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-budget\">\n                <Target size={14} className=\"flex-shrink-0\" />\n                <span>Budget</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"insights\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-insights\">\n                <Lightbulb size={14} className=\"flex-shrink-0\" />\n                <span>Insights</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"csv-analyzer\" className=\"flex items-center justify-center gap-1.5 px-3 sm:px-4 py-2 text-xs whitespace-nowrap min-h-[44px] touch-target data-[state=active]:bg-background data-[state=active]:shadow-sm scroll-snap-item\" data-testid=\"tab-csv-analyzer\">\n                <FileText size={14} className=\"flex-shrink-0\" />\n                <span>CSV</span>\n              </TabsTrigger>\n            </TabsList>\n          </motion.div>\n\n          <TabsContent value=\"overview\" className=\"space-y-4 sm:space-y-6\">\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n              <StatCard\n                title=\"Total Income\"\n                value={totalIncome}\n                icon={TrendingUp}\n                trend=\"up\"\n                trendLabel=\"This period\"\n                colorClass=\"text-green-600 dark:text-green-400\"\n                bgClass=\"bg-green-500/10\"\n                delay={0}\n                currencyPrefix={currencySymbol}\n              />\n              <StatCard\n                title=\"Total Expenses\"\n                value={totalExpenses}\n                icon={TrendingDown}\n                trend=\"down\"\n                trendLabel=\"This period\"\n                colorClass=\"text-red-600 dark:text-red-400\"\n                bgClass=\"bg-red-500/10\"\n                delay={0.1}\n                currencyPrefix={currencySymbol}\n              />\n              <StatCard\n                title=\"Net Cash Flow\"\n                value={Math.abs(netCashFlow)}\n                icon={netCashFlow >= 0 ? ArrowUpRight : ArrowDownRight}\n                trend={netCashFlow >= 0 ? 'up' : 'down'}\n                trendLabel={netCashFlow >= 0 ? 'Positive' : 'Negative'}\n                colorClass={netCashFlow >= 0 ? \"text-green-600 dark:text-green-400\" : \"text-red-600 dark:text-red-400\"}\n                bgClass={netCashFlow >= 0 ? \"bg-green-500/10\" : \"bg-red-500/10\"}\n                delay={0.2}\n                currencyPrefix={currencySymbol}\n              />\n              <StatCard\n                title=\"Total Savings\"\n                value={(stats as any)?.totalSavings || 0}\n                icon={PiggyBank}\n                trend=\"neutral\"\n                trendLabel=\"All time\"\n                colorClass=\"text-blue-600 dark:text-blue-400\"\n                bgClass=\"bg-blue-500/10\"\n                delay={0.3}\n                currencyPrefix={currencySymbol}\n              />\n            </div>\n\n            <div className=\"grid lg:grid-cols-3 gap-4 sm:gap-6\">\n              <div className=\"lg:col-span-2 space-y-4 sm:space-y-6\">\n                <motion.div\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.4, delay: 0.2 }}\n                >\n                  <Card className=\"border-border/40\">\n                    <button \n                      className=\"flex items-center justify-between w-full p-4 sm:p-6 md:cursor-default\"\n                      onClick={() => setIsFiltersExpanded(!isFiltersExpanded)}\n                      data-testid=\"button-toggle-filters\"\n                    >\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"p-2 rounded-lg bg-muted\">\n                          <Filter className=\"w-4 h-4\" />\n                        </div>\n                        <div className=\"text-left\">\n                          <span className=\"text-sm sm:text-base font-semibold\">Filters</span>\n                          <span className=\"text-xs sm:text-sm text-muted-foreground ml-2\">\n                            ({filteredTransactions.length} transactions)\n                          </span>\n                        </div>\n                      </div>\n                      <ChevronDown className={`w-4 h-4 md:hidden transition-transform ${isFiltersExpanded ? 'rotate-180' : ''}`} />\n                    </button>\n                    \n                    <div className={`${isFiltersExpanded ? 'block' : 'hidden'} md:block px-4 sm:px-6 pb-4 sm:pb-6`}>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4\">\n                        <div>\n                          <label className=\"text-xs sm:text-sm font-medium mb-1.5 block text-muted-foreground\">Time Range</label>\n                          <Select value={timeRange} onValueChange={setTimeRange}>\n                            <SelectTrigger data-testid=\"select-time-range\" className=\"h-9 sm:h-10 text-xs sm:text-sm\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"7\">Last 7 days</SelectItem>\n                              <SelectItem value=\"30\">Last 30 days</SelectItem>\n                              <SelectItem value=\"90\">Last 3 months</SelectItem>\n                              <SelectItem value=\"365\">Last year</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        <div>\n                          <label className=\"text-xs sm:text-sm font-medium mb-1.5 block text-muted-foreground\">Type</label>\n                          <Select value={filterType} onValueChange={setFilterType}>\n                            <SelectTrigger data-testid=\"select-transaction-type\" className=\"h-9 sm:h-10 text-xs sm:text-sm\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"all\">All Types</SelectItem>\n                              <SelectItem value=\"income\">Income</SelectItem>\n                              <SelectItem value=\"expense\">Expense</SelectItem>\n                              <SelectItem value=\"transfer\">Transfer</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        <div>\n                          <label className=\"text-xs sm:text-sm font-medium mb-1.5 block text-muted-foreground\">Category</label>\n                          <Select value={filterCategory} onValueChange={setFilterCategory}>\n                            <SelectTrigger data-testid=\"select-filter-category\" className=\"h-9 sm:h-10 text-xs sm:text-sm\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"all\">All Categories</SelectItem>\n                              {Object.entries(TRANSACTION_CATEGORIES).map(([type, categories]) => (\n                                categories.map(category => (\n                                  <SelectItem key={`${type}-${category}`} value={category}>\n                                    {category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ')}\n                                  </SelectItem>\n                                ))\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        <div className=\"flex items-end gap-2 col-span-2 md:col-span-1\">\n                          <Button \n                            variant=\"outline\" \n                            size=\"sm\"\n                            onClick={() => {\n                              setFilterType(\"all\");\n                              setFilterCategory(\"all\");\n                              setTimeRange(\"30\");\n                            }}\n                            data-testid=\"button-clear-filters\"\n                            className=\"text-xs h-9 sm:h-10 flex-1\"\n                          >\n                            Clear\n                          </Button>\n                          <Button \n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              const params = new URLSearchParams();\n                              if (filterType !== 'all') params.set('type', filterType);\n                              if (filterCategory !== 'all') params.set('category', filterCategory);\n                              const days = parseInt(timeRange);\n                              const endDate = new Date();\n                              const startDate = new Date();\n                              startDate.setDate(startDate.getDate() - days);\n                              params.set('startDate', startDate.toISOString().split('T')[0]);\n                              params.set('endDate', endDate.toISOString().split('T')[0]);\n                              window.location.href = `/api/transactions/export?${params.toString()}`;\n                            }}\n                            data-testid=\"button-export-csv\"\n                            className=\"text-xs h-9 sm:h-10 flex-1\"\n                          >\n                            <Download size={14} className=\"mr-1.5\" />\n                            Export\n                          </Button>\n                        </div>\n                      </div>\n                    </div>\n                  </Card>\n                </motion.div>\n\n                <AnimatePresence mode=\"wait\">\n                  {transactions?.filter((t: any) => t.category === 'Other' || t.category === 'other').length > 0 && (\n                    <motion.div\n                      initial={{ opacity: 0, height: 0 }}\n                      animate={{ opacity: 1, height: 'auto' }}\n                      exit={{ opacity: 0, height: 0 }}\n                      transition={{ duration: 0.3 }}\n                    >\n                      <Card className=\"p-4 bg-primary/5 border-primary/20\">\n                        <div className=\"flex items-center justify-between gap-4\">\n                          <div className=\"flex items-center gap-3 flex-1\">\n                            <div className=\"w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center flex-shrink-0\">\n                              <Sparkles className=\"w-5 h-5 text-primary\" />\n                            </div>\n                            <div className=\"min-w-0 flex-1\">\n                              <h4 className=\"font-semibold text-foreground flex items-center gap-2 text-sm sm:text-base\">\n                                AI Smart Categorization\n                              </h4>\n                              <p className=\"text-xs sm:text-sm text-muted-foreground\">\n                                {transactions?.filter((t: any) => t.category === 'Other' || t.category === 'other').length} uncategorized transactions detected\n                              </p>\n                            </div>\n                          </div>\n                          <Button\n                            onClick={() => bulkCategorizeMutation.mutate()}\n                            disabled={bulkCategorizeMutation.isPending}\n                            size=\"sm\"\n                            className=\"font-medium flex-shrink-0\"\n                            data-testid=\"button-fix-categories\"\n                          >\n                            {bulkCategorizeMutation.isPending ? (\n                              <>\n                                <div className=\"animate-spin rounded-full h-3.5 w-3.5 border-2 border-white border-t-transparent mr-2\" />\n                                <span className=\"hidden sm:inline\">Categorizing...</span>\n                              </>\n                            ) : (\n                              <>\n                                <Sparkles className=\"w-3.5 h-3.5 mr-1.5\" />\n                                <span className=\"hidden sm:inline\">Fix Categories</span>\n                                <span className=\"sm:hidden\">Fix</span>\n                              </>\n                            )}\n                          </Button>\n                        </div>\n                      </Card>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n\n                <motion.div\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.4, delay: 0.3 }}\n                >\n                  <Card className=\"border-border/40\">\n                    <CardHeader className=\"pb-3 sm:pb-4 px-4 sm:px-6 pt-4 sm:pt-6\">\n                      <CardTitle className=\"text-sm sm:text-base font-semibold flex items-center gap-2\">\n                        <Wallet className=\"w-4 h-4 text-primary\" />\n                        Recent Transactions\n                      </CardTitle>\n                    </CardHeader>\n                    \n                    <CardContent className=\"px-4 sm:px-6 pb-4 sm:pb-6\">\n                      {filteredTransactions.length === 0 ? (\n                        transactions?.length === 0 ? (\n                          <EmptyState\n                            illustration=\"transactions\"\n                            title=\"No Transactions Yet\"\n                            description=\"Start tracking your financial journey by adding your first transaction. Every dollar tracked brings you closer to your goals.\"\n                            actionLabel=\"Add Your First Transaction\"\n                            onAction={() => setIsCreateDialogOpen(true)}\n                            actionTestId=\"button-add-first-transaction\"\n                          />\n                        ) : (\n                          <div className=\"text-center py-12\">\n                            <div className=\"w-16 h-16 mx-auto bg-muted rounded-2xl flex items-center justify-center mb-4\">\n                              <Filter className=\"w-8 h-8 text-muted-foreground\" />\n                            </div>\n                            <h3 className=\"text-base font-semibold mb-2\">No transactions match your filters</h3>\n                            <p className=\"text-sm text-muted-foreground mb-6 max-w-md mx-auto\">\n                              Try adjusting your date range or category filters to see more transactions\n                            </p>\n                            <Button\n                              variant=\"outline\"\n                              onClick={() => {\n                                setFilterType(\"all\");\n                                setFilterCategory(\"all\");\n                                setTimeRange(\"30\");\n                              }}\n                            >\n                              Clear Filters\n                            </Button>\n                          </div>\n                        )\n                      ) : (\n                        <CollapsibleList\n                          items={filteredTransactions}\n                          keyExtractor={(t: any) => t.id}\n                          initialVisible={10}\n                          showMoreLabel=\"View all transactions\"\n                          showLessLabel=\"Show fewer transactions\"\n                          className=\"space-y-2 sm:space-y-3\"\n                          renderItem={(transaction: any) => (\n                            <SwipeableTransactionItem\n                              transaction={transaction}\n                              onArchive={(id) => archiveTransactionMutation.mutate(id)}\n                              onFlag={(id) => flagTransactionMutation.mutate(id)}\n                            />\n                          )}\n                        />\n                      )}\n                    </CardContent>\n                  </Card>\n                </motion.div>\n              </div>\n\n              <div className=\"space-y-4 sm:space-y-6\">\n                <CategoryBreakdown transactions={filteredTransactions} />\n                \n                <motion.div\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.4, delay: 0.4 }}\n                >\n                  <Card className=\"border-border/40 p-4 sm:p-6\">\n                    <h3 className=\"text-sm sm:text-base font-semibold mb-4 flex items-center gap-2\">\n                      <Lightbulb className=\"w-4 h-4 text-amber-500\" />\n                      Quick Tips\n                    </h3>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50\">\n                        <CheckCircle className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\" />\n                        <p className=\"text-xs sm:text-sm text-muted-foreground\">\n                          Track expenses daily for accurate budgeting\n                        </p>\n                      </div>\n                      <div className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50\">\n                        <CheckCircle className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\" />\n                        <p className=\"text-xs sm:text-sm text-muted-foreground\">\n                          Review spending categories weekly\n                        </p>\n                      </div>\n                      <div className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50\">\n                        <CheckCircle className=\"w-4 h-4 text-green-500 mt-0.5 flex-shrink-0\" />\n                        <p className=\"text-xs sm:text-sm text-muted-foreground\">\n                          Set budget limits for each category\n                        </p>\n                      </div>\n                    </div>\n                  </Card>\n                </motion.div>\n              </div>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"profile\" className=\"space-y-6\">\n            <Card className=\"border-border/40\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Wallet className=\"h-5 w-5\" />\n                  Financial Overview\n                </CardTitle>\n                <CardDescription>\n                  Enter your financial details to get personalized AI advice. These values power all your recommendations.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...profileForm}>\n                  <form onSubmit={profileForm.handleSubmit(onProfileSubmit)} className=\"space-y-6\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6\">\n                      <FormField\n                        control={profileForm.control}\n                        name=\"monthlyIncome\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Monthly Income</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <DollarSign className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"5000\"\n                                  data-testid=\"input-monthly-income\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={profileForm.control}\n                        name=\"monthlyExpenses\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Monthly Expenses</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <TrendingDown className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"3000\"\n                                  data-testid=\"input-monthly-expenses\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={profileForm.control}\n                        name=\"monthlySavings\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Monthly Savings</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <TrendingUp className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"2000\"\n                                  data-testid=\"input-monthly-savings\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={profileForm.control}\n                        name=\"totalSavings\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Total Savings</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <Wallet className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"50000\"\n                                  data-testid=\"input-total-savings\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={profileForm.control}\n                        name=\"savingsGoal\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Savings Goal</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <Building2 className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"100000\"\n                                  data-testid=\"input-savings-goal\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={profileForm.control}\n                        name=\"emergencyFund\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Emergency Fund</FormLabel>\n                            <FormControl>\n                              <div className=\"relative\">\n                                <CreditCard className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                                <Input\n                                  {...field}\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  className=\"pl-9\"\n                                  placeholder=\"18000\"\n                                  data-testid=\"input-emergency-fund\"\n                                />\n                              </div>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"flex justify-end\">\n                      <Button\n                        type=\"submit\"\n                        disabled={isSavingProfile}\n                        data-testid=\"button-save-profile\"\n                      >\n                        {isSavingProfile ? (\n                          <>\n                            <div className=\"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent\" />\n                            Saving...\n                          </>\n                        ) : (\n                          <>\n                            <Save className=\"mr-2 h-4 w-4\" />\n                            Save Profile\n                          </>\n                        )}\n                      </Button>\n                    </div>\n                  </form>\n                </Form>\n\n                {profileData?.profile && (\n                  <div className=\"mt-8 grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <Card className=\"border-border/40\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"flex items-center justify-between\">\n                          <div>\n                            <p className=\"text-sm text-muted-foreground\">Monthly Net</p>\n                            <p className=\"text-2xl font-bold\">\n                              ${(parseFloat(profileData.profile.monthlyIncome || \"0\") - parseFloat(profileData.profile.monthlyExpenses || \"0\")).toLocaleString()}\n                            </p>\n                          </div>\n                          <TrendingUp className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"border-border/40\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"flex items-center justify-between\">\n                          <div>\n                            <p className=\"text-sm text-muted-foreground\">Savings Rate</p>\n                            <p className=\"text-2xl font-bold\">\n                              {(() => {\n                                const income = parseFloat(profileData.profile.monthlyIncome || \"0\");\n                                const savings = parseFloat(profileData.profile.monthlySavings || \"0\");\n                                if (income === 0) return \"0.0\";\n                                return ((savings / income) * 100).toFixed(1);\n                              })()}%\n                            </p>\n                          </div>\n                          <Wallet className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"border-border/40\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"flex items-center justify-between\">\n                          <div>\n                            <p className=\"text-sm text-muted-foreground\">Goal Progress</p>\n                            <p className=\"text-2xl font-bold\">\n                              {(() => {\n                                const savings = parseFloat(profileData.profile.totalSavings || \"0\");\n                                const goal = parseFloat(profileData.profile.savingsGoal || \"0\");\n                                if (goal === 0) return \"0.0\";\n                                return ((savings / goal) * 100).toFixed(1);\n                              })()}%\n                            </p>\n                          </div>\n                          <Building2 className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"analytics\" className=\"space-y-6\">\n            <AdvancedSpendingAnalytics \n              transactions={filteredTransactions || []} \n              timeRange={timeRange} \n            />\n          </TabsContent>\n\n          <TabsContent value=\"budget\" className=\"space-y-6\">\n            <SmartBudgetManagement \n              transactions={filteredTransactions || []} \n              timeRange={timeRange} \n            />\n          </TabsContent>\n\n          <TabsContent value=\"insights\" className=\"space-y-6\">\n            <SpendingInsights \n              transactions={filteredTransactions || []} \n              timeRange={timeRange} \n            />\n          </TabsContent>\n\n          <TabsContent value=\"csv-analyzer\" className=\"space-y-6\">\n            <Suspense fallback={\n              <Card className=\"p-12\">\n                <div className=\"text-center\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-2 border-primary border-t-transparent mx-auto mb-4\" />\n                  <p className=\"text-muted-foreground\">Loading CSV Analyzer...</p>\n                </div>\n              </Card>\n            }>\n              <CSVAnalysisPanel />\n            </Suspense>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":53040,"size_tokens":null},"client/src/components/chat/ai-chat-button.tsx":{"content":"import { useState } from\"react\";\nimport { MessageCircle, X, Send, Loader2 } from\"lucide-react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Input } from\"@/components/ui/input\";\nimport { ScrollArea } from\"@/components/ui/scroll-area\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { useQuery, useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { apiRequest } from\"@/lib/queryClient\";\n\ninterface ChatMessage {\n id: string;\n role: 'user' | 'assistant';\n content: string;\n createdAt: string;\n}\n\ninterface ChatConversation {\n id: string;\n title: string | null;\n messages?: ChatMessage[];\n}\n\ninterface APIResponse {\n userMessage: ChatMessage;\n aiMessage: ChatMessage;\n actionsPerformed?: Array<{\n  type: 'goal_created' | 'event_created' | 'transaction_added' | 'error';\n  data?: any;\n  tool?: string;\n  error?: string;\n }>;\n error?: string;\n}\n\nexport default function AIChatButton() {\n const [isOpen, setIsOpen] = useState(false);\n const [currentMessage, setCurrentMessage] = useState(\"\");\n const [currentConversationId, setCurrentConversationId] = useState<string | null>(null);\n const queryClient = useQueryClient();\n\n // Fetch conversations\n const { data: conversations = [] } = useQuery<ChatConversation[]>({\n  queryKey: [\"/api/chat/conversations\"],\n  enabled: isOpen\n });\n\n // Fetch current conversation with messages\n const { data: currentConversation } = useQuery<ChatConversation>({\n  queryKey: [\"/api/chat/conversations\", currentConversationId],\n  enabled: !!currentConversationId\n });\n\n // Create new conversation\n const createConversationMutation = useMutation({\n  mutationFn: async (): Promise<ChatConversation> => {\n   const response = await apiRequest(\"POST\",\"/api/chat/conversations\", { \n    title:\"New Conversation\" \n   });\n   return await response.json();\n  },\n  onSuccess: (conversation: ChatConversation) => {\n   setCurrentConversationId(conversation.id);\n   queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n  }\n });\n\n // Send message\n const sendMessageMutation = useMutation({\n  mutationFn: async ({ conversationId, content }: { conversationId: string; content: string }) => {\n   const response = await apiRequest(\"POST\", `/api/chat/conversations/${conversationId}/messages`, { \n    content \n   });\n   return await response.json();\n  },\n  onSuccess: (data: APIResponse) => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\", currentConversationId] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n   \n   // Invalidate related data if AI performed actions\n   if (data.actionsPerformed && data.actionsPerformed.length > 0) {\n    data.actionsPerformed.forEach(action => {\n     if (action.type === 'goal_created') {\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n     } else if (action.type === 'event_created') {\n      queryClient.invalidateQueries({ queryKey: [\"/api/events\"] });\n     } else if (action.type === 'transaction_added') {\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n     }\n    });\n   }\n   \n   setCurrentMessage(\"\");\n  }\n });\n\n const handleStartNewChat = () => {\n  createConversationMutation.mutate();\n };\n\n const handleSendMessage = async (e: React.FormEvent) => {\n  e.preventDefault();\n  if (!currentMessage.trim()) return;\n\n  if (!currentConversationId) {\n   // Create new conversation first\n   const response = await apiRequest(\"POST\",\"/api/chat/conversations\", { \n    title:\"New Conversation\" \n   });\n   const conversation: ChatConversation = await response.json();\n   setCurrentConversationId(conversation.id);\n   \n   // Send message to new conversation\n   sendMessageMutation.mutate({\n    conversationId: conversation.id,\n    content: currentMessage\n   });\n  } else {\n   sendMessageMutation.mutate({\n    conversationId: currentConversationId,\n    content: currentMessage\n   });\n  }\n };\n\n const formatMessageTime = (dateStr: string) => {\n  const date = new Date(dateStr);\n  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n };\n\n if (!isOpen) {\n  return (\n   <div \n    className=\"fixed left-4 md:left-auto md:right-6 md:bottom-6 z-50 group\"\n    style={{ bottom: 'calc(72px + env(safe-area-inset-bottom, 0px))' }}\n   >\n    <Button\n     onClick={() => setIsOpen(true)}\n     className=\"h-14 w-14 min-w-[56px] min-h-[56px] md:h-16 md:w-16 rounded-full shadow-lg hover:shadow-xl transition-all duration-200 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600\"\n     data-testid=\"button-open-chat\"\n    >\n     <MessageCircle className=\"h-6 w-6 text-gray-900 dark:text-gray-100\" />\n    </Button>\n    \n    {/* Tooltip */}\n    <div className=\"hidden md:block absolute bottom-full right-0 mb-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n     <div className=\"bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 text-xs font-medium rounded-md px-3 py-1.5 whitespace-nowrap shadow-lg\">\n      AI Assistant\n     </div>\n    </div>\n   </div>\n  );\n }\n\n return (\n  <Card className=\"fixed inset-4 md:inset-auto md:bottom-6 md:right-6 md:w-96 md:h-[500px] shadow-sm border z-50 flex flex-col max-h-[90vh] md:max-h-[500px]\" style={{ \n   maxHeight: 'calc(90vh - env(safe-area-inset-top) - env(safe-area-inset-bottom))',\n   bottom: 'max(1.5rem, calc(1.5rem + env(safe-area-inset-bottom)))'\n  }}>\n   <CardHeader className=\"pb-2 shrink-0 border-b\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-sm md:text-base flex items-center gap-2 font-semibold\">\n      <MessageCircle className=\"h-4 w-4 text-black dark:text-white\" />\n      Twealth AI\n     </CardTitle>\n     <Button\n      variant=\"ghost\"\n      size=\"sm\"\n      onClick={() => setIsOpen(false)}\n      data-testid=\"button-close-chat\"\n      className=\"h-11 w-11 md:h-9 md:w-9\"\n     >\n      <X className=\"h-4 w-4\" />\n     </Button>\n    </div>\n    \n    {/* Conversation selector */}\n    <div className=\"flex gap-2 mt-2\">\n     <Button\n      onClick={handleStartNewChat}\n      size=\"sm\"\n      variant=\"outline\"\n      disabled={createConversationMutation.isPending}\n      data-testid=\"button-new-chat\"\n      className=\"h-11 md:h-9 text-xs\"\n     >\n      New Chat\n     </Button>\n     {conversations.length > 0 && (\n      <Badge variant=\"secondary\" className=\"text-xs\">{conversations.length} chats</Badge>\n     )}\n    </div>\n   </CardHeader>\n\n   <CardContent className=\"flex-1 flex flex-col p-0 overflow-hidden\">\n    {/* Messages area */}\n    <ScrollArea className=\"flex-1 p-3 md:p-4\">\n     {!currentConversationId ? (\n      <div className=\"text-center text-muted-foreground py-4 md:py-8\" data-testid=\"text-welcome\">\n       <MessageCircle className=\"h-8 w-8 md:h-10 md:w-10 mx-auto mb-3 text-muted-foreground/50\" />\n       <p className=\"text-sm font-medium mb-2\">Chat with Twealth AI</p>\n       <p className=\"text-xs mb-3 md:mb-4\">Get expert financial advice</p>\n       <div className=\"space-y-2 text-xs text-left\">\n        <div className=\"border border-border rounded-lg p-2\">\n         <p className=\"text-muted-foreground\">How can I optimize my budget?</p>\n        </div>\n        <div className=\"border border-border rounded-lg p-2\">\n         <p className=\"text-muted-foreground\">What's my best savings strategy?</p>\n        </div>\n       </div>\n      </div>\n     ) : currentConversation?.messages ? (\n      <div className=\"space-y-3 md:space-y-4\">\n       {currentConversation.messages.map((message) => (\n        <div\n         key={message.id}\n         className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\n         data-testid={`message-${message.role}-${message.id}`}\n        >\n         <div\n          className={`max-w-[85%] md:max-w-[80%] rounded-lg p-2.5 md:p-3 ${\n           message.role === 'user'\n            ? 'bg-black dark:bg-white text-white dark:text-black'\n            : 'bg-muted'\n          }`}\n         >\n          <p className=\"text-xs md:text-sm whitespace-pre-wrap break-words\">{message.content}</p>\n          <p className=\"text-xs opacity-70 mt-1\">\n           {formatMessageTime(message.createdAt)}\n          </p>\n         </div>\n        </div>\n       ))}\n       {sendMessageMutation.isPending && (\n        <div className=\"flex justify-start\">\n         <div className=\"bg-muted rounded-lg p-2.5 flex items-center gap-2\">\n          <Loader2 className=\"h-3.5 w-3.5\" />\n          <span className=\"text-xs text-muted-foreground\">Thinking...</span>\n         </div>\n        </div>\n       )}\n      </div>\n     ) : (\n      <div className=\"text-center text-muted-foreground py-4\">\n       <Loader2 className=\"h-6 w-6 mx-auto mb-2\" />\n       <p className=\"text-sm\">Loading...</p>\n      </div>\n     )}\n    </ScrollArea>\n\n    {/* Message input */}\n    <div className=\"border-t p-3 md:p-4 shrink-0\">\n     <form onSubmit={handleSendMessage} className=\"flex gap-2\">\n      <Input\n       value={currentMessage}\n       onChange={(e) => setCurrentMessage(e.target.value)}\n       placeholder=\"Ask about your finances...\"\n       disabled={sendMessageMutation.isPending}\n       className=\"flex-1 text-sm h-11 md:h-10\"\n       data-testid=\"input-chat-message\"\n      />\n      <Button\n       type=\"submit\"\n       disabled={!currentMessage.trim() || sendMessageMutation.isPending}\n       className=\"shrink-0 h-11 w-11 md:h-10 md:w-10\"\n       size=\"icon\"\n       data-testid=\"button-send-message\"\n      >\n       <Send className=\"h-4 w-4 md:h-3.5 md:w-3.5\" />\n      </Button>\n     </form>\n    </div>\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":9622,"size_tokens":null},"client/src/components/onboarding-redirect.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { useLocation } from\"wouter\";\nimport { useEffect } from\"react\";\nimport { UserPreferences } from\"@shared/schema\";\nimport { SkeletonPage } from\"@/components/ui/skeleton\";\n\ninterface OnboardingRedirectProps {\n children: React.ReactNode;\n}\n\nexport function OnboardingRedirect({ children }: OnboardingRedirectProps) {\n const [location, setLocation] = useLocation();\n \n const { data: userPreferences, isLoading } = useQuery<UserPreferences>({\n  queryKey: [\"/api/user-preferences\"],\n });\n \n useEffect(() => {\n  // Don't do anything while loading\n  if (isLoading) {\n   return;\n  }\n  \n  // If on welcome page and onboarding is complete, redirect to dashboard\n  if (location ===\"/welcome\" && userPreferences?.hasCompletedOnboarding) {\n   setLocation(\"/\");\n   return;\n  }\n  \n  // If not on welcome page and onboarding is not complete, redirect to welcome\n  if (location !==\"/welcome\" && !userPreferences?.hasCompletedOnboarding) {\n   setLocation(\"/welcome\");\n  }\n }, [userPreferences, isLoading, location, setLocation]);\n \n // Show loading while checking onboarding status\n if (isLoading) {\n  return <SkeletonPage />;\n }\n \n // Don't render children if user needs onboarding and we're not on welcome page\n if (!userPreferences?.hasCompletedOnboarding && location !==\"/welcome\") {\n  return <SkeletonPage />;\n }\n \n return <>{children}</>;\n}","path":null,"size_bytes":1382,"size_tokens":null},"client/src/lib/performance.ts":{"content":"// Mobile Performance Optimization Utilities\n\n/**\n * Lazy load images with intersection observer for mobile\n */\nexport function useLazyImage(src: string, options?: IntersectionObserverInit) {\n if (typeof window === 'undefined') return src;\n \n // Return placeholder for mobile until image is in viewport\n const isMobile = window.innerWidth < 768;\n if (!isMobile) return src;\n \n // Create placeholder data URL for mobile\n const placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPgo8L3N2Zz4=';\n return placeholder;\n}\n\n/**\n * Detect mobile network speed and adjust loading behavior\n */\nexport function getNetworkQuality(): 'slow' | 'fast' | 'unknown' {\n if (typeof navigator === 'undefined' || !('connection' in navigator)) {\n  return 'unknown';\n }\n \n const connection = (navigator as any).connection;\n if (!connection) return 'unknown';\n \n // Detect slow connections (2G, slow-2g)\n if (connection.effectiveType === '2g' || connection.effectiveType === 'slow-2g') {\n  return 'slow';\n }\n \n // Consider 3G and above as fast\n return 'fast';\n}\n\n/**\n * Preload critical resources for mobile\n */\nexport function preloadCriticalResources() {\n if (typeof window === 'undefined') return;\n \n const isMobile = window.innerWidth < 768;\n if (!isMobile) return;\n \n // Preload critical fonts for mobile\n const criticalFonts = [\n  'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap'\n ];\n \n criticalFonts.forEach(font => {\n  const link = document.createElement('link');\n  link.rel = 'preload';\n  link.as = 'style';\n  link.href = font;\n  document.head.appendChild(link);\n });\n}\n\n/**\n * Debounce function for mobile input optimization\n */\nexport function debounce<T extends (...args: any[]) => any>(\n func: T,\n wait: number,\n immediate?: boolean\n): (...args: Parameters<T>) => void {\n let timeout: NodeJS.Timeout | null = null;\n \n return function executedFunction(...args: Parameters<T>) {\n  const later = () => {\n   timeout = null;\n   if (!immediate) func(...args);\n  };\n  \n  const callNow = immediate && !timeout;\n  \n  if (timeout) clearTimeout(timeout);\n  timeout = setTimeout(later, wait);\n  \n  if (callNow) func(...args);\n };\n}\n\n/**\n * Throttle function for scroll events on mobile\n */\nexport function throttle<T extends (...args: any[]) => any>(\n func: T,\n limit: number\n): (...args: Parameters<T>) => void {\n let inThrottle = false;\n \n return function executedFunction(...args: Parameters<T>) {\n  if (!inThrottle) {\n   func(...args);\n   inThrottle = true;\n   setTimeout(() => inThrottle = false, limit);\n  }\n };\n}\n\n/**\n * Check if device is mobile\n */\nexport function isMobileDevice(): boolean {\n if (typeof window === 'undefined') return false;\n \n return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n  navigator.userAgent\n ) || window.innerWidth < 768;\n}\n\n/**\n * Mobile-optimized intersection observer\n */\nexport function createMobileIntersectionObserver(\n callback: IntersectionObserverCallback,\n options?: IntersectionObserverInit\n): IntersectionObserver | null {\n if (typeof window === 'undefined' || !('IntersectionObserver' in window)) {\n  return null;\n }\n \n const defaultOptions: IntersectionObserverInit = {\n  // Larger root margin on mobile for earlier loading\n  rootMargin: isMobileDevice() ? '50px' : '10px',\n  threshold: 0.1,\n  ...options\n };\n \n return new IntersectionObserver(callback, defaultOptions);\n}\n\n/**\n * Reduce bundle size by conditionally loading features\n */\nexport async function loadFeatureOnDemand<T>(\n featureLoader: () => Promise<T>,\n condition: boolean = true\n): Promise<T | null> {\n if (!condition) return null;\n \n try {\n  return await featureLoader();\n } catch (error) {\n  console.warn('Failed to load feature on demand:', error);\n  return null;\n }\n}\n\n/**\n * Performance monitoring for mobile\n */\nexport class MobilePerformanceMonitor {\n private static instance: MobilePerformanceMonitor;\n private metrics: Map<string, number> = new Map();\n \n static getInstance(): MobilePerformanceMonitor {\n  if (!this.instance) {\n   this.instance = new MobilePerformanceMonitor();\n  }\n  return this.instance;\n }\n \n startTiming(name: string): void {\n  this.metrics.set(name, performance.now());\n }\n \n endTiming(name: string): number {\n  const startTime = this.metrics.get(name);\n  if (startTime === undefined) return 0;\n  \n  const duration = performance.now() - startTime;\n  this.metrics.delete(name);\n  \n  // Log slow operations on mobile\n  if (isMobileDevice() && duration > 100) {\n   console.warn(`Slow operation on mobile: ${name} took ${duration.toFixed(2)}ms`);\n  }\n  \n  return duration;\n }\n \n measureAsync<T>(name: string, asyncFn: () => Promise<T>): Promise<T> {\n  this.startTiming(name);\n  return asyncFn().finally(() => {\n   this.endTiming(name);\n  });\n }\n}","path":null,"size_bytes":4865,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from\"@tanstack/react-query\";\n\nexport class RateLimitError extends Error {\n retryAfter: number;\n constructor(message: string, retryAfter: number = 60) {\n  super(message);\n  this.name = 'RateLimitError';\n  this.retryAfter = retryAfter;\n }\n}\n\nasync function throwIfResNotOk(res: Response) {\n if (!res.ok) {\n  let errorMessage = res.statusText;\n  let retryAfter = 60; // Default 1 minute\n  \n  try {\n   const text = await res.text();\n   if (text) {\n    // Try to parse as JSON first\n    try {\n     const json = JSON.parse(text);\n     errorMessage = json.message || json.error || text;\n     retryAfter = json.retryAfter || retryAfter;\n    } catch {\n     errorMessage = text;\n    }\n   }\n  } catch (e) {\n   console.error('Error parsing response:', e);\n  }\n  \n  // Handle rate limiting specifically\n  if (res.status === 429) {\n   const retryAfterHeader = res.headers.get('Retry-After');\n   if (retryAfterHeader) {\n    retryAfter = parseInt(retryAfterHeader, 10);\n   }\n   const rateLimitMessage = `You've made too many requests. Please wait ${retryAfter} seconds and try again.`;\n   throw new RateLimitError(rateLimitMessage, retryAfter);\n  }\n  \n  // Create user-friendly error messages\n  const userFriendlyMessage = res.status === 401 \n   ? 'Please sign in to continue'\n   : res.status === 403\n   ? 'You don\\'t have permission to access this resource'\n   : res.status === 404\n   ? 'The requested resource was not found'\n   : res.status >= 500\n   ? 'Server error. Please try again later'\n   : errorMessage;\n  \n  throw new Error(userFriendlyMessage);\n }\n}\n\nexport async function apiRequest(\n method: string,\n url: string,\n data?: unknown | undefined,\n): Promise<Response> {\n const res = await fetch(url, {\n  method,\n  headers: data ? {\"Content-Type\":\"application/json\" } : {},\n  body: data ? JSON.stringify(data) : undefined,\n  credentials:\"include\",\n });\n\n await throwIfResNotOk(res);\n return res;\n}\n\ntype UnauthorizedBehavior =\"returnNull\" |\"throw\";\nexport const getQueryFn: <T>(options: {\n on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n ({ on401: unauthorizedBehavior }) =>\n async ({ queryKey }) => {\n  const res = await fetch(queryKey.join(\"/\") as string, {\n   credentials:\"include\",\n  });\n\n  if (unauthorizedBehavior ===\"returnNull\" && res.status === 401) {\n   return null;\n  }\n\n  await throwIfResNotOk(res);\n  return await res.json();\n };\n\nexport const queryClient = new QueryClient({\n defaultOptions: {\n  queries: {\n   queryFn: getQueryFn({ on401:\"throw\" }),\n   refetchInterval: false,\n   refetchOnWindowFocus: false,\n   staleTime: 5 * 60 * 1000, // 5 minutes - balance between freshness and performance\n   gcTime: 10 * 60 * 1000, // 10 minutes - keep unused data in cache longer (formerly cacheTime)\n   retry: (failureCount, error) => {\n    // Don't retry on rate limit errors - let user wait\n    if (error instanceof RateLimitError) return false;\n    \n    // Don't retry on 4xx errors (client errors)\n    if (error instanceof Error && error.message.includes('401')) return false;\n    if (error instanceof Error && error.message.includes('403')) return false;\n    if (error instanceof Error && error.message.includes('404')) return false;\n    \n    // Retry up to 2 times for other errors with exponential backoff\n    return failureCount < 2;\n   },\n   retryDelay: (attemptIndex) => {\n    // Exponential backoff: 1s, 2s, 4s, 8s...\n    return Math.min(1000 * 2 ** attemptIndex, 30000);\n   },\n  },\n  mutations: {\n   retry: (failureCount, error) => {\n    // Don't retry on rate limit errors\n    if (error instanceof RateLimitError) return false;\n    \n    // Don't retry mutations on client errors\n    if (error instanceof Error && error.message.includes('40')) return false;\n    \n    // Retry once for network errors with exponential backoff\n    return failureCount < 1;\n   },\n   retryDelay: (attemptIndex) => {\n    // Exponential backoff: 1s, 2s, 4s...\n    return Math.min(1000 * 2 ** attemptIndex, 30000);\n   },\n  },\n },\n});\n","path":null,"size_bytes":3965,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from\"react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Card = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\n  \"rounded-xl border bg-card text-card-foreground shadow-sm transition-all hover:shadow-md group\",\n   className\n  )}\n  {...props}\n />\n))\nCard.displayName =\"Card\"\n\nconst CardHeader = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n  {...props}\n />\n))\nCardHeader.displayName =\"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\n  \"text-2xl font-semibold leading-none tracking-tight\",\n   className\n  )}\n  {...props}\n />\n))\nCardTitle.displayName =\"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\"text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nCardDescription.displayName =\"CardDescription\"\n\nconst CardContent = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName =\"CardContent\"\n\nconst CardFooter = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n <div\n  ref={ref}\n  className={cn(\"flex items-center p-6 pt-0\", className)}\n  {...props}\n />\n))\nCardFooter.displayName =\"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1816,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from\"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":139,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState } from\"react\";\nimport { useTranslation } from 'react-i18next';\nimport { useQuery, useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { z } from\"zod\";\nimport { Settings as SettingsIcon, Clock, DollarSign, TrendingUp, Save, Info, User, Palette, Shield, Database, Sparkles, Lock, CreditCard, Brain, Zap, Cog, CheckCircle2, AlertCircle, LogOut, Loader2 } from\"lucide-react\";\nimport { useLocation } from\"wouter\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from\"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from\"@/components/ui/form\";\nimport { Input } from\"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from\"@/components/ui/tabs\";\nimport { ScrollArea } from\"@/components/ui/scroll-area\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport UserPreferences from\"@/components/settings/user-preferences\";\nimport FinancialPreferences from\"@/components/settings/financial-preferences\";\nimport DataPrivacy from\"@/components/settings/data-privacy\";\n\nconst settingsSchema = z.object({\n hourlyRate: z.string().min(1,\"Hourly rate is required\").refine(\n  (val) => !isNaN(Number(val)) && Number(val) > 0,\n \"Hourly rate must be a positive number\"\n ),\n currency: z.string().min(1,\"Currency is required\"),\n workHoursPerWeek: z.string().min(1,\"Work hours per week is required\").refine(\n  (val) => !isNaN(Number(val)) && Number(val) > 0 && Number(val) <= 168,\n \"Work hours must be between 1 and 168 hours per week\"\n ),\n timeValueStrategy: z.enum([\"fixed\",\"derived\"], {\n  required_error:\"Please select a time value strategy\"\n })\n});\n\ntype SettingsFormData = z.infer<typeof settingsSchema>;\n\nfunction Settings() {\n const { t } = useTranslation();\n const { toast } = useToast();\n const [isSaving, setIsSaving] = useState(false);\n const [activeTab, setActiveTab] = useState(\"account\");\n const [, setLocation] = useLocation();\n\n const logoutMutation = useMutation({\n  mutationFn: async () => {\n   return await apiRequest('POST', '/api/auth/logout', {});\n  },\n  onSuccess: () => {\n   // Invalidate auth queries\n   queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/auth/status'] });\n   queryClient.clear(); // Clear all cached data on logout\n   \n   // Show success toast\n   toast({\n    title:\"Signed out securely\",\n    description:\"You have been logged out successfully\",\n   });\n   \n   // Redirect to login page\n   setTimeout(() => {\n    setLocation('/login');\n   }, 100);\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Logout failed\",\n    description: error.message ||\"Please try again\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const handleLogout = () => {\n  logoutMutation.mutate();\n };\n\n const { data: userSettings, isLoading } = useQuery({\n  queryKey: [\"/api/user-settings\"],\n  enabled: true,\n });\n\n const form = useForm<SettingsFormData>({\n  resolver: zodResolver(settingsSchema),\n  defaultValues: {\n   hourlyRate:\"50\",\n   currency:\"USD\",\n   workHoursPerWeek:\"40\",\n   timeValueStrategy:\"fixed\" as const\n  },\n  values: userSettings ? {\n   hourlyRate: (userSettings as any).hourlyRate?.toString() ||\"50\",\n   currency: (userSettings as any).currency ||\"USD\",\n   workHoursPerWeek: (userSettings as any).workHoursPerWeek?.toString() ||\"40\",\n   timeValueStrategy: (userSettings as any).timeValueStrategy ||\"fixed\"\n  } : undefined\n });\n\n const updateSettingsMutation = useMutation({\n  mutationFn: async (data: SettingsFormData) => {\n   const payload = {\n    hourlyRate: parseFloat(data.hourlyRate),\n    currency: data.currency,\n    workHoursPerWeek: parseInt(data.workHoursPerWeek),\n    timeValueStrategy: data.timeValueStrategy\n   };\n\n   const method = userSettings ?\"PUT\" :\"POST\";\n   return apiRequest(method,\"/api/user-settings\", payload);\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/user-settings\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/insights/time-value\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/time-stats\"] });\n   toast({\n    title:\"Settings Updated!\",\n    description:\"Your time-value preferences have been saved successfully.\",\n    icon: <CheckCircle2 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n   });\n   setIsSaving(false);\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Update Failed\",\n    description:\"Failed to save your settings. Please try again.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n   setIsSaving(false);\n  },\n });\n\n const onSubmit = async (data: SettingsFormData) => {\n  setIsSaving(true);\n  updateSettingsMutation.mutate(data);\n };\n\n const hourlyRate = parseFloat(form.watch(\"hourlyRate\") ||\"0\");\n const workHoursPerWeek = parseInt(form.watch(\"workHoursPerWeek\") ||\"0\");\n const selectedCurrency = form.watch(\"currency\") ||\"USD\";\n const dailyValue = (hourlyRate * workHoursPerWeek) / 5;\n const monthlyValue = hourlyRate * workHoursPerWeek * 4.33;\n\n const formatCurrency = (amount: number) => {\n  return new Intl.NumberFormat('en-US', {\n   style: 'currency',\n   currency: selectedCurrency,\n   minimumFractionDigits: 2,\n   maximumFractionDigits: 2,\n  }).format(amount);\n };\n\n if (isLoading) {\n  return (\n   <div className=\"min-h-screen bg-background\">\n    <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n     <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6\">\n      <div className=\"h-8 bg-muted/50 rounded w-32 mb-2\" />\n      <div className=\"h-4 bg-muted/50 rounded w-48\" />\n     </div>\n    </header>\n    <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-8\">\n     <div className=\"h-12 bg-muted/50 rounded-lg w-full max-w-lg mb-8\" />\n     <div className=\"h-96 bg-muted/50 rounded-xl\" />\n    </div>\n   </div>\n  );\n }\n\n return (\n  <div className=\"min-h-screen-mobile bg-background pb-20 md:pb-0\">\n   <header className=\"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border/40 sticky top-0 z-30\">\n    <div className=\"w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-6\">\n     <div className=\"flex items-center justify-between gap-3\">\n      <div className=\"flex-1 min-w-0\">\n       <h1 className=\"text-lg sm:text-xl lg:text-2xl xl:text-3xl font-semibold tracking-tight text-foreground\">\n        {t('settings.title', 'Settings')}\n       </h1>\n       <p className=\"text-xs sm:text-sm text-muted-foreground mt-0.5 sm:mt-1 hidden sm:block\">\n        {t('settings.subtitle', 'Manage your account and preferences')}\n       </p>\n      </div>\n      <Button\n       variant=\"outline\"\n       size=\"sm\"\n       onClick={handleLogout}\n       disabled={logoutMutation.isPending}\n       className=\"text-red-600 dark:text-red-400 border-red-200 dark:border-red-900 hover:bg-red-50 dark:hover:bg-red-950 min-h-[44px] touch-target\"\n       data-testid=\"button-logout\"\n      >\n       {logoutMutation.isPending ? (\n        <Loader2 className=\"w-4 h-4 sm:mr-2 animate-spin\" />\n       ) : (\n        <LogOut className=\"w-4 h-4 sm:mr-2\" />\n       )}\n       <span className=\"hidden sm:inline\">Sign out</span>\n      </Button>\n     </div>\n    </div>\n   </header>\n\n   <div className=\"w-full px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8\">\n    <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n     <TabsList className=\"grid w-full grid-cols-2 sm:grid-cols-4 mb-4 sm:mb-6 lg:mb-8 p-1 h-auto bg-muted/50\">\n      <TabsTrigger \n       value=\"account\" \n       className=\"flex items-center justify-center gap-1.5 sm:gap-2 py-2.5 sm:py-3 text-xs sm:text-sm font-medium min-h-[44px] touch-target\"\n       data-testid=\"tab-account\"\n      >\n       <User className=\"w-4 h-4\" />\n       <span className=\"hidden sm:inline\">Account</span>\n      </TabsTrigger>\n      <TabsTrigger \n       value=\"preferences\" \n       className=\"flex items-center justify-center gap-1.5 sm:gap-2 py-2.5 sm:py-3 text-xs sm:text-sm font-medium min-h-[44px] touch-target\"\n       data-testid=\"tab-preferences\"\n      >\n       <Palette className=\"w-4 h-4\" />\n       <span className=\"hidden sm:inline\">Preferences</span>\n      </TabsTrigger>\n      <TabsTrigger \n       value=\"financial\" \n       className=\"flex items-center justify-center gap-1.5 sm:gap-2 py-2.5 sm:py-3 text-xs sm:text-sm font-medium min-h-[44px] touch-target\"\n       data-testid=\"tab-financial\"\n      >\n       <CreditCard className=\"w-4 h-4\" />\n       <span className=\"hidden sm:inline\">Financial</span>\n      </TabsTrigger>\n      <TabsTrigger \n       value=\"privacy\" \n       className=\"flex items-center justify-center gap-1.5 sm:gap-2 py-2.5 sm:py-3 text-xs sm:text-sm font-medium min-h-[44px] touch-target\"\n       data-testid=\"tab-privacy\"\n      >\n       <Shield className=\"w-4 h-4\" />\n       <span className=\"hidden sm:inline\">Privacy</span>\n      </TabsTrigger>\n     </TabsList>\n\n     {/* Account Tab */}\n     <TabsContent value=\"account\" className=\"space-y-6\">\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n       <div className=\"lg:col-span-2\">\n        <Card className=\"border-border/50\">\n         <CardHeader className=\"p-6\">\n          <CardTitle className=\"text-lg font-semibold\">\n           Time Value Configuration\n          </CardTitle>\n          <CardDescription>\n           Set your hourly rate and work schedule for time-value calculations\n          </CardDescription>\n         </CardHeader>\n         <CardContent className=\"p-6 pt-0\">\n          <Form {...form}>\n           <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <FormField\n             control={form.control}\n             name=\"hourlyRate\"\n             render={({ field }) => (\n              <FormItem>\n               <FormLabel className=\"text-sm font-medium\">\n                Hourly Rate\n               </FormLabel>\n               <FormControl>\n                <div className=\"relative\">\n                 <Input\n                  {...field}\n                  type=\"number\"\n                  step=\"0.01\"\n                  min=\"0\"\n                  placeholder=\"50.00\"\n                  className=\"h-11 pl-9\"\n                  data-testid=\"input-hourly-rate\"\n                 />\n                 <DollarSign className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                </div>\n               </FormControl>\n               <FormDescription className=\"text-xs\">\n                The monetary value of one hour of your time\n               </FormDescription>\n               <FormMessage />\n              </FormItem>\n             )}\n            />\n\n            <FormField\n             control={form.control}\n             name=\"currency\"\n             render={({ field }) => (\n              <FormItem>\n               <FormLabel className=\"text-sm font-medium\">Currency</FormLabel>\n               <Select onValueChange={field.onChange} defaultValue={field.value} value={field.value}>\n                <FormControl>\n                 <SelectTrigger className=\"h-11\" data-testid=\"select-currency\">\n                  <SelectValue placeholder=\"Select currency\" />\n                 </SelectTrigger>\n                </FormControl>\n                <SelectContent>\n                 <SelectItem value=\"USD\">USD ($)</SelectItem>\n                 <SelectItem value=\"THB\">THB (฿)</SelectItem>\n                 <SelectItem value=\"EUR\">EUR (€)</SelectItem>\n                 <SelectItem value=\"IDR\">IDR (Rp)</SelectItem>\n                 <SelectItem value=\"VND\">VND (₫)</SelectItem>\n                 <SelectItem value=\"INR\">INR (₹)</SelectItem>\n                 <SelectItem value=\"PHP\">PHP (₱)</SelectItem>\n                 <SelectItem value=\"BRL\">BRL (R$)</SelectItem>\n                 <SelectItem value=\"MYR\">MYR (RM)</SelectItem>\n                 <SelectItem value=\"MXN\">MXN ($)</SelectItem>\n                 <SelectItem value=\"TRY\">TRY (₺)</SelectItem>\n                 <SelectItem value=\"GBP\">GBP (£)</SelectItem>\n                 <SelectItem value=\"JPY\">JPY (¥)</SelectItem>\n                 <SelectItem value=\"CAD\">CAD (C$)</SelectItem>\n                 <SelectItem value=\"AUD\">AUD (A$)</SelectItem>\n                </SelectContent>\n               </Select>\n               <FormDescription className=\"text-xs\">\n                Your preferred currency for financial calculations\n               </FormDescription>\n               <FormMessage />\n              </FormItem>\n             )}\n            />\n\n            <FormField\n             control={form.control}\n             name=\"workHoursPerWeek\"\n             render={({ field }) => (\n              <FormItem>\n               <FormLabel className=\"text-sm font-medium\">\n                Work Hours Per Week\n               </FormLabel>\n               <FormControl>\n                <div className=\"relative\">\n                 <Input\n                  {...field}\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"168\"\n                  placeholder=\"40\"\n                  className=\"h-11 pl-9\"\n                  data-testid=\"input-work-hours\"\n                 />\n                 <Clock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n                </div>\n               </FormControl>\n               <FormDescription className=\"text-xs\">\n                Your typical working hours per week\n               </FormDescription>\n               <FormMessage />\n              </FormItem>\n             )}\n            />\n\n            <FormField\n             control={form.control}\n             name=\"timeValueStrategy\"\n             render={({ field }) => (\n              <FormItem>\n               <FormLabel className=\"text-sm font-medium\">\n                Time Value Strategy\n               </FormLabel>\n               <Select onValueChange={field.onChange} defaultValue={field.value} value={field.value}>\n                <FormControl>\n                 <SelectTrigger className=\"h-11\" data-testid=\"select-time-strategy\">\n                  <SelectValue placeholder=\"Select strategy\" />\n                 </SelectTrigger>\n                </FormControl>\n                <SelectContent>\n                 <SelectItem value=\"fixed\">Fixed Rate</SelectItem>\n                 <SelectItem value=\"derived\">Context-Derived</SelectItem>\n                </SelectContent>\n               </Select>\n               <FormDescription className=\"text-xs\">\n                How time value should be calculated for different events\n               </FormDescription>\n               <FormMessage />\n              </FormItem>\n             )}\n            />\n\n            <Button\n             type=\"submit\"\n             className=\"w-full h-11\"\n             disabled={isSaving}\n             data-testid=\"button-save-settings\"\n            >\n             {isSaving ? (\n              <>\n               <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n               Saving...\n              </>\n             ) : (\n              <>\n               <Save className=\"w-4 h-4 mr-2\" />\n               Save Settings\n              </>\n             )}\n            </Button>\n           </form>\n          </Form>\n         </CardContent>\n        </Card>\n       </div>\n\n       {/* Preview Panel */}\n       <div className=\"space-y-6\">\n        <Card className=\"border-border/50\">\n         <CardHeader className=\"p-6\">\n          <CardTitle className=\"text-lg font-semibold\">\n           Time Value Preview\n          </CardTitle>\n         </CardHeader>\n         <CardContent className=\"p-6 pt-0\">\n          <div className=\"space-y-4\">\n           <div className=\"flex justify-between items-center p-4 rounded-lg bg-muted/50\">\n            <span className=\"text-sm text-muted-foreground\">Per Hour</span>\n            <span className=\"text-lg font-semibold\" data-testid=\"text-preview-hourly\">\n             {formatCurrency(hourlyRate)}\n            </span>\n           </div>\n           <div className=\"flex justify-between items-center p-4 rounded-lg bg-muted/50\">\n            <span className=\"text-sm text-muted-foreground\">Per Day</span>\n            <span className=\"text-lg font-semibold\" data-testid=\"text-preview-daily\">\n             {formatCurrency(dailyValue)}\n            </span>\n           </div>\n           <div className=\"flex justify-between items-center p-4 rounded-lg bg-muted/50\">\n            <span className=\"text-sm text-muted-foreground\">Per Month</span>\n            <span className=\"text-lg font-semibold\" data-testid=\"text-preview-monthly\">\n             {formatCurrency(monthlyValue)}\n            </span>\n           </div>\n          </div>\n         </CardContent>\n        </Card>\n\n        <Card className=\"border-border/50\">\n         <CardHeader className=\"p-6\">\n          <CardTitle className=\"text-lg font-semibold flex items-center gap-2\">\n           <Info className=\"w-4 h-4 text-muted-foreground\" />\n           Strategy Guide\n          </CardTitle>\n         </CardHeader>\n         <CardContent className=\"p-6 pt-0 space-y-4 text-sm\">\n          <div className=\"p-4 rounded-lg bg-muted/50\">\n           <h4 className=\"font-medium mb-1\">Fixed Rate</h4>\n           <p className=\"text-muted-foreground text-xs\">\n            Uses your hourly rate consistently. Best for freelancers and consultants.\n           </p>\n          </div>\n          <div className=\"p-4 rounded-lg bg-muted/50\">\n           <h4 className=\"font-medium mb-1\">Context-Derived</h4>\n           <p className=\"text-muted-foreground text-xs\">\n            Adjusts value based on event type and meeting importance.\n           </p>\n          </div>\n         </CardContent>\n        </Card>\n       </div>\n      </div>\n     </TabsContent>\n\n     {/* Preferences Tab */}\n     <TabsContent value=\"preferences\" className=\"space-y-6\">\n      <UserPreferences />\n     </TabsContent>\n\n     {/* Financial Tab */}\n     <TabsContent value=\"financial\" className=\"space-y-6\">\n      <FinancialPreferences />\n     </TabsContent>\n\n     {/* Privacy Tab */}\n     <TabsContent value=\"privacy\" className=\"space-y-6\">\n      <DataPrivacy />\n     </TabsContent>\n    </Tabs>\n   </div>\n  </div>\n );\n}\n\nexport default Settings;\n","path":null,"size_bytes":18433,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from\"react\"\nimport * as TabsPrimitive from\"@radix-ui/react-tabs\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n React.ElementRef<typeof TabsPrimitive.List>,\n React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n <TabsPrimitive.List\n  ref={ref}\n  className={cn(\n  \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n   className\n  )}\n  {...props}\n />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n React.ElementRef<typeof TabsPrimitive.Trigger>,\n React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n <TabsPrimitive.Trigger\n  ref={ref}\n  className={cn(\n  \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n   className\n  )}\n  {...props}\n />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n React.ElementRef<typeof TabsPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n <TabsPrimitive.Content\n  ref={ref}\n  className={cn(\n  \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n   className\n  )}\n  {...props}\n />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1823,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from\"react\"\nimport * as AlertDialogPrimitive from\"@radix-ui/react-alert-dialog\"\n\nimport { cn } from\"@/lib/utils\"\nimport { buttonVariants } from\"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n <AlertDialogPrimitive.Overlay\n  className={cn(\n  \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n   className\n  )}\n  {...props}\n  ref={ref}\n />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n <AlertDialogPortal>\n  <AlertDialogOverlay />\n  <AlertDialogPrimitive.Content\n   ref={ref}\n   className={cn(\n   \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n    className\n   )}\n   {...props}\n  />\n </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col space-y-2 text-center sm:text-left\",\n   className\n  )}\n  {...props}\n />\n)\nAlertDialogHeader.displayName =\"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n   className\n  )}\n  {...props}\n />\n)\nAlertDialogFooter.displayName =\"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Title>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n <AlertDialogPrimitive.Title\n  ref={ref}\n  className={cn(\"text-lg font-semibold\", className)}\n  {...props}\n />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Description>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n <AlertDialogPrimitive.Description\n  ref={ref}\n  className={cn(\"text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nAlertDialogDescription.displayName =\n AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Action>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n <AlertDialogPrimitive.Action\n  ref={ref}\n  className={cn(buttonVariants(), className)}\n  {...props}\n />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n <AlertDialogPrimitive.Cancel\n  ref={ref}\n  className={cn(\n   buttonVariants({ variant:\"outline\" }),\n  \"mt-2 sm:mt-0\",\n   className\n  )}\n  {...props}\n />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n AlertDialog,\n AlertDialogPortal,\n AlertDialogOverlay,\n AlertDialogTrigger,\n AlertDialogContent,\n AlertDialogHeader,\n AlertDialogFooter,\n AlertDialogTitle,\n AlertDialogDescription,\n AlertDialogAction,\n AlertDialogCancel,\n}\n","path":null,"size_bytes":4251,"size_tokens":null},"client/src/index.css":{"content":"@import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* ============================================\n * MOBILE-FIRST FOUNDATION\n * Native app experience for phones & tablets\n * ============================================ */\n\n/* Safe area insets for mobile devices (iPhone notch, Android punch-hole) */\n@supports (padding: env(safe-area-inset-top)) {\n  body {\n    padding-top: env(safe-area-inset-top);\n    padding-bottom: env(safe-area-inset-bottom);\n    padding-left: env(safe-area-inset-left);\n    padding-right: env(safe-area-inset-right);\n  }\n}\n\n/* Prevent body scroll when modal/drawer is open */\nbody.modal-open,\nbody.drawer-open {\n  overflow: hidden;\n  position: fixed;\n  width: 100%;\n  height: 100%;\n}\n\n/* Mobile viewport height fix for iOS Safari */\n:root {\n  --vh: 1vh;\n  --mobile-header-height: 64px;\n  --mobile-nav-height: 72px;\n  --mobile-safe-bottom: env(safe-area-inset-bottom, 8px);\n}\n\n/* Full height utility that works on mobile */\n.h-screen-mobile {\n  height: 100vh;\n  height: calc(var(--vh, 1vh) * 100);\n}\n\n.min-h-screen-mobile {\n  min-height: 100vh;\n  min-height: calc(var(--vh, 1vh) * 100);\n}\n\n/* Mobile touch optimization */\n@media (pointer: coarse) {\n  /* Larger touch targets on touch devices */\n  button, \n  a, \n  input[type=\"checkbox\"], \n  input[type=\"radio\"],\n  [role=\"button\"],\n  [role=\"link\"],\n  .touch-target {\n    min-height: 44px;\n    min-width: 44px;\n  }\n  \n  /* Prevent text selection on interactive elements */\n  button,\n  [role=\"button\"],\n  .no-select {\n    -webkit-user-select: none;\n    user-select: none;\n  }\n  \n  /* Faster tap response on iOS */\n  a, button, [role=\"button\"] {\n    -webkit-tap-highlight-color: transparent;\n    touch-action: manipulation;\n  }\n}\n\n/* Smooth scrolling containers */\n.scroll-container {\n  -webkit-overflow-scrolling: touch;\n  overscroll-behavior: contain;\n  scroll-behavior: smooth;\n}\n\n/* Hide scrollbars but keep functionality */\n.scrollbar-none {\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.scrollbar-none::-webkit-scrollbar {\n  display: none;\n}\n\n/* Horizontal scroll snap for tabs/carousels */\n.scroll-snap-x {\n  scroll-snap-type: x mandatory;\n  -webkit-overflow-scrolling: touch;\n}\n\n.scroll-snap-item {\n  scroll-snap-align: start;\n  scroll-snap-stop: always;\n}\n\n/* Prevent pull-to-refresh on specific containers */\n.no-pull-refresh {\n  overscroll-behavior-y: contain;\n}\n\n/* Line clamp utilities for text truncation */\n@layer utilities {\n  .line-clamp-1 {\n    overflow: hidden;\n    display: -webkit-box;\n    -webkit-box-orient: vertical;\n    -webkit-line-clamp: 1;\n  }\n  .line-clamp-2 {\n    overflow: hidden;\n    display: -webkit-box;\n    -webkit-box-orient: vertical;\n    -webkit-line-clamp: 2;\n  }\n  .line-clamp-3 {\n    overflow: hidden;\n    display: -webkit-box;\n    -webkit-box-orient: vertical;\n    -webkit-line-clamp: 3;\n  }\n  \n  /* Prevent text overflow utilities */\n  .text-no-overflow {\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    hyphens: auto;\n  }\n  \n  /* Container overflow prevention */\n  .container-safe {\n    max-width: 100%;\n    overflow-x: hidden;\n  }\n  \n  /* Removed all animations and transforms for professional design */\n  \n  /* Improved focus styles for accessibility */\n  .focus-ring:focus-visible {\n    outline: 2px solid var(--primary);\n    outline-offset: 2px;\n    border-radius: var(--radius);\n  }\n  \n  /* Enhanced global focus styles for better keyboard navigation */\n  *:focus-visible {\n    outline: 2px solid hsl(var(--ring));\n    outline-offset: 2px;\n  }\n  \n  /* Premium tactile affordances - Stripe/Coinbase style */\n  button:focus-visible,\n  a:focus-visible,\n  input:focus-visible,\n  select:focus-visible,\n  textarea:focus-visible {\n    outline: 2px solid hsl(var(--ring));\n    outline-offset: 2px;\n  }\n  \n  /* Smooth transitions for all interactive elements */\n  button,\n  a,\n  input,\n  select,\n  textarea,\n  [role=\"button\"],\n  [role=\"link\"],\n  [tabindex=\"0\"] {\n    transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);\n  }\n  \n  /* Hover states for buttons and links */\n  button:hover:not(:disabled),\n  a:hover,\n  [role=\"button\"]:hover:not([aria-disabled=\"true\"]) {\n    opacity: 0.9;\n  }\n  \n  /* Pressed/active states */\n  button:active:not(:disabled),\n  a:active,\n  [role=\"button\"]:active:not([aria-disabled=\"true\"]) {\n    transform: translateY(0.5px);\n    opacity: 0.85;\n  }\n  \n  /* Card hover states for premium feel */\n  .card-interactive:hover {\n    border-color: hsl(var(--border));\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n  }\n  \n  /* Input focus enhancement */\n  input:focus,\n  select:focus,\n  textarea:focus {\n    border-color: hsl(var(--ring));\n    box-shadow: 0 0 0 1px hsl(var(--ring));\n  }\n  \n  /* Disabled state clarity */\n  button:disabled,\n  input:disabled,\n  select:disabled,\n  textarea:disabled,\n  [aria-disabled=\"true\"] {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n  \n  /* Skip to main content link styles */\n  .sr-only {\n    position: absolute;\n    width: 1px;\n    height: 1px;\n    padding: 0;\n    margin: -1px;\n    overflow: hidden;\n    clip: rect(0, 0, 0, 0);\n    white-space: nowrap;\n    border-width: 0;\n  }\n  \n  /* Removed gradient backgrounds and animations for professional design */\n  \n  /* ============================================\n   * MOBILE LAYOUT UTILITIES\n   * Responsive patterns for all screen sizes\n   * ============================================ */\n  \n  /* Mobile-first responsive container */\n  .container-mobile {\n    width: 100%;\n    padding-left: 1rem;\n    padding-right: 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .container-mobile {\n      padding-left: 1.5rem;\n      padding-right: 1.5rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .container-mobile {\n      padding-left: 2rem;\n      padding-right: 2rem;\n    }\n  }\n  \n  /* Mobile card that stacks properly */\n  .card-mobile {\n    @apply rounded-xl border bg-card;\n    margin-left: -0.5rem;\n    margin-right: -0.5rem;\n    border-radius: 0;\n  }\n  \n  @media (min-width: 640px) {\n    .card-mobile {\n      margin-left: 0;\n      margin-right: 0;\n      border-radius: var(--radius);\n    }\n  }\n  \n  /* Responsive grid that works on mobile */\n  .grid-mobile-1 {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: 0.75rem;\n  }\n  \n  @media (min-width: 640px) {\n    .grid-mobile-1 {\n      grid-template-columns: repeat(2, 1fr);\n      gap: 1rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .grid-mobile-1 {\n      grid-template-columns: repeat(3, 1fr);\n      gap: 1.5rem;\n    }\n  }\n  \n  /* Two column mobile grid */\n  .grid-mobile-2 {\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 0.75rem;\n  }\n  \n  @media (min-width: 1024px) {\n    .grid-mobile-2 {\n      grid-template-columns: repeat(4, 1fr);\n      gap: 1rem;\n    }\n  }\n  \n  /* Full width on mobile, constrained on desktop */\n  .w-full-mobile {\n    width: 100%;\n  }\n  \n  @media (min-width: 640px) {\n    .w-full-mobile {\n      width: auto;\n    }\n  }\n  \n  /* Hide on mobile, show on desktop */\n  .hide-mobile {\n    display: none;\n  }\n  \n  @media (min-width: 768px) {\n    .hide-mobile {\n      display: block;\n    }\n  }\n  \n  /* Show on mobile, hide on desktop */\n  .show-mobile {\n    display: block;\n  }\n  \n  @media (min-width: 768px) {\n    .show-mobile {\n      display: none;\n    }\n  }\n  \n  /* Mobile-first flex layouts */\n  .flex-col-mobile {\n    display: flex;\n    flex-direction: column;\n    gap: 0.75rem;\n  }\n  \n  @media (min-width: 640px) {\n    .flex-col-mobile {\n      flex-direction: row;\n      gap: 1rem;\n    }\n  }\n  \n  /* Stack to row layout */\n  .stack-to-row {\n    display: flex;\n    flex-direction: column;\n  }\n  \n  @media (min-width: 768px) {\n    .stack-to-row {\n      flex-direction: row;\n    }\n  }\n  \n  /* Mobile text scaling */\n  .text-responsive-xs {\n    font-size: 0.75rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-xs {\n      font-size: 0.875rem;\n    }\n  }\n  \n  .text-responsive-sm {\n    font-size: 0.875rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-sm {\n      font-size: 1rem;\n    }\n  }\n  \n  .text-responsive-base {\n    font-size: 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-base {\n      font-size: 1.125rem;\n    }\n  }\n  \n  .text-responsive-lg {\n    font-size: 1.125rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-lg {\n      font-size: 1.25rem;\n    }\n  }\n  \n  .text-responsive-xl {\n    font-size: 1.25rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-xl {\n      font-size: 1.5rem;\n    }\n  }\n  \n  .text-responsive-2xl {\n    font-size: 1.5rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-2xl {\n      font-size: 2rem;\n    }\n  }\n  \n  .text-responsive-3xl {\n    font-size: 1.875rem;\n  }\n  \n  @media (min-width: 640px) {\n    .text-responsive-3xl {\n      font-size: 2.25rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .text-responsive-3xl {\n      font-size: 3rem;\n    }\n  }\n  \n  /* Mobile spacing scale */\n  .p-mobile {\n    padding: 0.75rem;\n  }\n  \n  @media (min-width: 640px) {\n    .p-mobile {\n      padding: 1rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .p-mobile {\n      padding: 1.5rem;\n    }\n  }\n  \n  .px-mobile {\n    padding-left: 1rem;\n    padding-right: 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .px-mobile {\n      padding-left: 1.5rem;\n      padding-right: 1.5rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .px-mobile {\n      padding-left: 2rem;\n      padding-right: 2rem;\n    }\n  }\n  \n  .py-mobile {\n    padding-top: 1rem;\n    padding-bottom: 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .py-mobile {\n      padding-top: 1.5rem;\n      padding-bottom: 1.5rem;\n    }\n  }\n  \n  /* Mobile gap utilities */\n  .gap-mobile {\n    gap: 0.75rem;\n  }\n  \n  @media (min-width: 640px) {\n    .gap-mobile {\n      gap: 1rem;\n    }\n  }\n  \n  @media (min-width: 1024px) {\n    .gap-mobile {\n      gap: 1.5rem;\n    }\n  }\n  \n  /* Mobile button - full width on mobile */\n  .btn-mobile {\n    width: 100%;\n    min-height: 48px;\n    font-size: 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .btn-mobile {\n      width: auto;\n      min-height: 40px;\n      font-size: 0.875rem;\n    }\n  }\n  \n  /* Fixed bottom action bar for mobile */\n  .fixed-bottom-bar {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 1rem;\n    padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));\n    background: var(--background);\n    border-top: 1px solid var(--border);\n    z-index: 40;\n  }\n  \n  @media (min-width: 768px) {\n    .fixed-bottom-bar {\n      position: static;\n      padding: 0;\n      background: transparent;\n      border-top: none;\n    }\n  }\n  \n  \n  /* Mobile-friendly input */\n  .input-mobile {\n    min-height: 48px;\n    font-size: 16px; /* Prevents iOS zoom on focus */\n    padding: 0.75rem 1rem;\n  }\n  \n  @media (min-width: 640px) {\n    .input-mobile {\n      min-height: 40px;\n      font-size: 14px;\n      padding: 0.5rem 0.75rem;\n    }\n  }\n  \n  /* Swipe container */\n  .swipe-container {\n    touch-action: pan-x;\n    overflow-x: hidden;\n  }\n  \n  /* Bottom sheet handle */\n  .sheet-handle {\n    width: 48px;\n    height: 4px;\n    background: var(--muted);\n    border-radius: 2px;\n    margin: 8px auto 16px;\n  }\n  \n  /* Enhanced modern utilities */\n  .glass-effect {\n    background: rgba(255, 255, 255, 0.05);\n    backdrop-filter: blur(10px);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n  }\n  \n  .modern-shadow {\n    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);\n  }\n  \n  .modern-shadow-lg {\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);\n  }\n  \n  /* Removed scale animations for professional design */\n  \n  .glow-primary {\n    box-shadow: 0 0 20px hsl(var(--primary) / 0.3);\n  }\n  \n  /* Removed gradient and animation classes for professional design */\n}\n\n:root {\n  --background: hsl(220, 15%, 97%);\n  --foreground: hsl(220, 15%, 9%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(220, 15%, 9%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(220, 15%, 9%);\n  --primary: hsl(217, 91%, 60%); /* Royal blue - professional fintech */\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(220, 14%, 96%);\n  --secondary-foreground: hsl(220, 9%, 46%);\n  --muted: hsl(220, 14%, 96%);\n  --muted-foreground: hsl(220, 9%, 46%);\n  --accent: hsl(217, 91%, 96%);\n  --accent-foreground: hsl(217, 91%, 20%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 98%);\n  --border: hsl(220, 13%, 91%);\n  --input: hsl(220, 13%, 91%);\n  --ring: hsl(217, 91%, 60%);\n  --chart-1: hsl(217, 91%, 60%);\n  --chart-2: hsl(142, 76%, 36%);\n  --chart-3: hsl(45, 93%, 47%);\n  --chart-4: hsl(0, 84%, 60%);\n  --chart-5: hsl(217, 70%, 45%);\n  \n  /* Modern Color System - Single Primary with Status Colors */\n  --brand-primary: 217 91% 60%;\n  --success: 142 71% 45%;\n  --warning: 38 92% 50%;\n  --error: 0 84% 60%;\n  --neutral: 220 9% 46%;\n  \n  /* Removed gradient variables for professional design */\n  \n  --sidebar: hsl(0, 0%, 100%);\n  --sidebar-foreground: hsl(220, 15%, 9%);\n  --sidebar-primary: hsl(217, 91%, 60%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(220, 14%, 96%);\n  --sidebar-accent-foreground: hsl(217, 91%, 60%);\n  --sidebar-border: hsl(220, 13%, 91%);\n  --sidebar-ring: hsl(217, 91%, 60%);\n  --font-sans: Inter, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: 12px;\n  \n  /* 8pt Spacing Scale */\n  --space-1: 0.25rem;   /* 4px */\n  --space-2: 0.5rem;    /* 8px */\n  --space-3: 0.75rem;   /* 12px */\n  --space-4: 1rem;      /* 16px */\n  --space-5: 1.25rem;   /* 20px */\n  --space-6: 1.5rem;    /* 24px */\n  --space-8: 2rem;      /* 32px */\n  --space-10: 2.5rem;   /* 40px */\n  --space-12: 3rem;     /* 48px */\n  --space-16: 4rem;     /* 64px */\n  \n  /* Consistent Shadows */\n  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);\n  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);\n  \n  /* Typography Scale - Big Tech Professional Hierarchy */\n  --text-xs: 0.75rem;      /* 12px - Captions, metadata */\n  --text-sm: 0.875rem;     /* 14px - Secondary text */\n  --text-base: 1rem;       /* 16px - Body text */\n  --text-lg: 1.125rem;     /* 18px - Small headlines */\n  --text-xl: 1.25rem;      /* 20px - Subheadings */\n  --text-2xl: 1.5rem;      /* 24px - Section headlines */\n  --text-3xl: 2rem;        /* 32px - Page headlines */\n  --text-4xl: 2.5rem;      /* 40px - Hero text */\n  \n  /* Stripe-style Neutral Palette - Professional Grays */\n  --gray-50: hsl(220, 15%, 97%);\n  --gray-100: hsl(220, 14%, 96%);\n  --gray-200: hsl(220, 13%, 91%);\n  --gray-300: hsl(220, 12%, 80%);\n  --gray-400: hsl(220, 10%, 60%);\n  --gray-500: hsl(220, 9%, 46%);\n  --gray-600: hsl(220, 10%, 35%);\n  --gray-700: hsl(220, 12%, 25%);\n  --gray-800: hsl(220, 14%, 16%);\n  --gray-900: hsl(220, 15%, 9%);\n  --gray-950: hsl(220, 20%, 5%);\n  \n  /* Border Tokens - Consistent Line Weights */\n  --border-thin: 1px;\n  --border-medium: 1.5px;\n  --border-thick: 2px;\n  \n  /* Radius Tokens */\n  --radius-sm: 8px;\n  --radius-md: 12px;\n  --radius-lg: 16px;\n  --radius-xl: 20px;\n  \n  /* Modern transition tokens */\n  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);\n  --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);\n  --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);\n  --transition-bounce: 300ms cubic-bezier(0.68, -0.55, 0.265, 1.55);\n}\n\n.dark {\n  --background: hsl(220, 15%, 9%);\n  --foreground: hsl(220, 15%, 97%);\n  --card: hsl(220, 15%, 12%);\n  --card-foreground: hsl(220, 15%, 97%);\n  --popover: hsl(220, 15%, 12%);\n  --popover-foreground: hsl(220, 15%, 97%);\n  --primary: hsl(217, 91%, 65%); /* Royal blue for dark mode */\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(220, 15%, 15%);\n  --secondary-foreground: hsl(220, 15%, 60%);\n  --muted: hsl(220, 15%, 15%);\n  --muted-foreground: hsl(220, 15%, 60%);\n  --accent: hsl(217, 91%, 20%);\n  --accent-foreground: hsl(217, 91%, 95%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 98%);\n  --border: hsl(220, 15%, 18%);\n  --input: hsl(220, 15%, 18%);\n  --ring: hsl(217, 91%, 65%);\n  --sidebar: hsl(220, 15%, 12%);\n  --sidebar-foreground: hsl(220, 15%, 97%);\n  --sidebar-primary: hsl(217, 91%, 65%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(220, 15%, 15%);\n  --sidebar-accent-foreground: hsl(217, 91%, 65%);\n  --sidebar-border: hsl(220, 15%, 18%);\n  --sidebar-ring: hsl(217, 91%, 65%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    line-height: 1.6;\n  }\n  \n  /* Simple transitions for professional design - opacity only */\n  button, a, [role=\"button\"], input, textarea, select {\n    transition: opacity var(--transition-fast), \n                color var(--transition-fast), \n                background-color var(--transition-fast),\n                border-color var(--transition-fast);\n  }\n  \n  /* Modern Typography */\n  .text-brand {\n    color: hsl(var(--brand-primary));\n    font-weight: 600;\n  }\n  \n  .text-success {\n    color: hsl(var(--success));\n    font-weight: 600;\n  }\n  \n  .text-warning {\n    color: hsl(var(--warning));\n    font-weight: 600;\n  }\n  \n  .text-error {\n    color: hsl(var(--error));\n    font-weight: 600;\n  }\n  \n  /* Legacy Color Support */\n  .text-time {\n    color: hsl(var(--brand-primary));\n    font-weight: 600;\n  }\n  \n  .text-money {\n    color: hsl(var(--success));\n    font-weight: 600;\n  }\n  \n  .text-value-positive {\n    color: hsl(var(--success));\n    font-weight: 600;\n  }\n  \n  .text-value-negative {\n    color: hsl(var(--error));\n    font-weight: 600;\n  }\n}\n\n@layer components {\n  /* Removed gradient classes for professional design */\n  \n  /* Simplified Counter */\n  .counter-animate {\n    transition: color 0.3s ease-in-out;\n    font-variant-numeric: tabular-nums;\n  }\n  \n  /* Big Tech Typography Components - Stripe/Coinbase/Apple Style */\n  .headline-hero {\n    font-size: var(--text-4xl);\n    font-weight: 700;\n    line-height: 1.1;\n    letter-spacing: -0.025em;\n    color: hsl(var(--foreground));\n  }\n  \n  @media (min-width: 640px) {\n    .headline-hero {\n      font-size: 3rem;\n      letter-spacing: -0.03em;\n    }\n  }\n  \n  .headline-section {\n    font-size: var(--text-3xl);\n    font-weight: 600;\n    line-height: 1.2;\n    letter-spacing: -0.02em;\n    color: hsl(var(--foreground));\n  }\n  \n  .headline-card {\n    font-size: var(--text-2xl);\n    font-weight: 600;\n    line-height: 1.3;\n    letter-spacing: -0.015em;\n    color: hsl(var(--foreground));\n  }\n  \n  .headline-widget {\n    font-size: var(--text-lg);\n    font-weight: 600;\n    line-height: 1.4;\n    letter-spacing: -0.01em;\n    color: hsl(var(--foreground));\n  }\n  \n  .subheading {\n    font-size: var(--text-xl);\n    font-weight: 500;\n    line-height: 1.5;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .subheading-sm {\n    font-size: var(--text-base);\n    font-weight: 400;\n    line-height: 1.6;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .body-text {\n    font-size: var(--text-base);\n    font-weight: 400;\n    line-height: 1.6;\n    color: hsl(var(--foreground));\n  }\n  \n  .body-sm {\n    font-size: var(--text-sm);\n    font-weight: 400;\n    line-height: 1.5;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .caption {\n    font-size: var(--text-xs);\n    font-weight: 500;\n    line-height: 1.4;\n    letter-spacing: 0.01em;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .label {\n    font-size: var(--text-sm);\n    font-weight: 500;\n    line-height: 1.4;\n    color: hsl(var(--foreground));\n  }\n  \n  .overline {\n    font-size: 0.6875rem;\n    font-weight: 600;\n    line-height: 1.4;\n    letter-spacing: 0.08em;\n    text-transform: uppercase;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  /* Big Numbers - Dashboard KPIs */\n  .stat-value {\n    font-size: 2.5rem;\n    font-weight: 700;\n    line-height: 1;\n    letter-spacing: -0.02em;\n    font-variant-numeric: tabular-nums;\n    color: hsl(var(--foreground));\n  }\n  \n  @media (min-width: 640px) {\n    .stat-value {\n      font-size: 3rem;\n    }\n  }\n  \n  .stat-value-lg {\n    font-size: 4rem;\n    font-weight: 700;\n    line-height: 1;\n    letter-spacing: -0.03em;\n    font-variant-numeric: tabular-nums;\n    color: hsl(var(--foreground));\n  }\n  \n  @media (min-width: 640px) {\n    .stat-value-lg {\n      font-size: 5rem;\n    }\n  }\n  \n  .stat-label {\n    font-size: var(--text-sm);\n    font-weight: 500;\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .stat-change-positive {\n    font-size: var(--text-sm);\n    font-weight: 600;\n    color: hsl(var(--success));\n  }\n  \n  .stat-change-negative {\n    font-size: var(--text-sm);\n    font-weight: 600;\n    color: hsl(var(--error));\n  }\n  \n  /* Currency formatting */\n  .currency {\n    font-variant-numeric: tabular-nums;\n    letter-spacing: 0.01em;\n  }\n  \n  .currency-lg {\n    font-size: var(--text-2xl);\n    font-weight: 600;\n    font-variant-numeric: tabular-nums;\n    letter-spacing: 0;\n  }\n  \n  /* Touch-Optimized Interactive Elements - Apple HIG Standard */\n  .touch-target {\n    min-height: 44px;\n    min-width: 44px;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n  }\n  \n  .touch-target-lg {\n    min-height: 52px;\n    min-width: 52px;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n  }\n  \n  .touch-target-xl {\n    min-height: 60px;\n    min-width: 60px;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n  }\n  \n  /* Professional Button States - Stripe Style */\n  .button-press {\n    transition: transform 0.1s ease-out, box-shadow 0.15s ease-out, opacity 0.1s ease-out;\n  }\n  \n  .button-press:hover {\n    opacity: 0.95;\n  }\n  \n  .button-press:active {\n    transform: scale(0.98);\n    opacity: 0.9;\n  }\n  \n  .button-press:focus-visible {\n    outline: 2px solid hsl(var(--brand-primary));\n    outline-offset: 2px;\n  }\n  \n  /* Primary Button Glow */\n  .button-glow {\n    position: relative;\n    overflow: hidden;\n  }\n  \n  .button-glow::before {\n    content: '';\n    position: absolute;\n    inset: 0;\n    background: linear-gradient(\n      to bottom,\n      hsl(var(--brand-primary) / 0.15),\n      transparent\n    );\n    opacity: 0;\n    transition: opacity 0.2s ease-out;\n  }\n  \n  .button-glow:hover::before {\n    opacity: 1;\n  }\n  \n  /* Professional Card Hover (subtle) - Coinbase Style */\n  .card-interactive {\n    transition: box-shadow 0.2s ease-out, border-color 0.2s ease-out, transform 0.15s ease-out;\n    will-change: transform, box-shadow;\n  }\n  \n  .card-interactive:hover {\n    box-shadow: var(--shadow-lg);\n    border-color: hsl(var(--border) / 0.6);\n    transform: translateY(-1px);\n  }\n  \n  .card-interactive:active {\n    transform: translateY(0);\n  }\n  \n  /* Subtle card press */\n  .card-pressable {\n    transition: transform 0.1s ease-out, box-shadow 0.15s ease-out;\n    cursor: pointer;\n  }\n  \n  .card-pressable:active {\n    transform: scale(0.995);\n    box-shadow: var(--shadow-sm);\n  }\n  \n  /* Focus Ring - Accessible & Beautiful */\n  .focus-ring {\n    outline: none;\n  }\n  \n  .focus-ring:focus-visible {\n    outline: 2px solid hsl(var(--brand-primary));\n    outline-offset: 2px;\n  }\n  \n  /* Link Hover - Stripe Style */\n  .link-interactive {\n    color: hsl(var(--brand-primary));\n    text-decoration: none;\n    transition: color 0.15s ease-out;\n  }\n  \n  .link-interactive:hover {\n    color: hsl(var(--brand-primary) / 0.8);\n  }\n  \n  .link-underline {\n    position: relative;\n    color: hsl(var(--brand-primary));\n    text-decoration: none;\n  }\n  \n  .link-underline::after {\n    content: '';\n    position: absolute;\n    bottom: -1px;\n    left: 0;\n    width: 100%;\n    height: 1px;\n    background: currentColor;\n    transform: scaleX(0);\n    transform-origin: right;\n    transition: transform 0.2s ease-out;\n  }\n  \n  .link-underline:hover::after {\n    transform: scaleX(1);\n    transform-origin: left;\n  }\n  \n  /* Row hover - for list items */\n  .row-hover {\n    transition: background-color 0.15s ease-out;\n  }\n  \n  .row-hover:hover {\n    background-color: hsl(var(--muted) / 0.5);\n  }\n  \n  /* Icon button styling */\n  .icon-button {\n    @apply rounded-lg p-2;\n    min-height: 44px;\n    min-width: 44px;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    transition: background-color 0.15s ease-out, color 0.15s ease-out;\n  }\n  \n  .icon-button:hover {\n    background-color: hsl(var(--muted));\n  }\n  \n  .icon-button:active {\n    background-color: hsl(var(--muted) / 0.8);\n  }\n  \n  /* Pill button - for filters and tags */\n  .pill-button {\n    @apply rounded-full px-4 py-2 text-sm font-medium;\n    min-height: 36px;\n    transition: background-color 0.15s ease-out, color 0.15s ease-out, border-color 0.15s ease-out;\n    border: 1px solid hsl(var(--border));\n  }\n  \n  .pill-button:hover {\n    background-color: hsl(var(--muted) / 0.5);\n  }\n  \n  .pill-button[data-active=\"true\"] {\n    background-color: hsl(var(--brand-primary));\n    color: white;\n    border-color: hsl(var(--brand-primary));\n  }\n  \n  /* Input focus enhancement */\n  .input-focus-brand {\n    transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out;\n  }\n  \n  .input-focus-brand:focus {\n    border-color: hsl(var(--brand-primary));\n    box-shadow: 0 0 0 3px hsl(var(--brand-primary) / 0.1);\n  }\n  \n  /* Modern Badge System */\n  .badge-brand {\n    @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium;\n    background: hsl(var(--brand-primary) / 0.1);\n    color: hsl(var(--brand-primary));\n    border: 1px solid hsl(var(--brand-primary) / 0.15);\n  }\n  \n  .badge-success {\n    @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium;\n    background: hsl(var(--success) / 0.1);\n    color: hsl(var(--success));\n    border: 1px solid hsl(var(--success) / 0.15);\n  }\n  \n  .badge-warning {\n    @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium;\n    background: hsl(var(--warning) / 0.1);\n    color: hsl(var(--warning));\n    border: 1px solid hsl(var(--warning) / 0.15);\n  }\n  \n  .badge-error {\n    @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium;\n    background: hsl(var(--error) / 0.1);\n    color: hsl(var(--error));\n    border: 1px solid hsl(var(--error) / 0.15);\n  }\n  \n  /* Legacy Badge Support */\n  .time-badge { @apply badge-brand; }\n  .money-badge { @apply badge-success; }\n  .value-badge-positive { @apply badge-success; }\n  .value-badge-negative { @apply badge-error; }\n  \n  /* Modern Card System - no hover effects */\n  .card-elevated {\n    box-shadow: var(--shadow-md);\n    border-radius: var(--radius);\n  }\n  \n  /* Removed loading shimmer for professional design */\n}\n\n@layer utilities {\n  /* Removed all animations and hover effects for professional design */\n  \n  /* Status Indicators */\n  .status-active {\n    @apply bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-300;\n  }\n  \n  .status-inactive {\n    @apply bg-gray-50 border-gray-200 text-gray-600 dark:bg-gray-900/20 dark:border-gray-800 dark:text-gray-400;\n  }\n  \n  /* Removed motion preferences - all animations already removed */\n  \n  /* Typography Utilities */\n  .text-tabular {\n    font-variant-numeric: tabular-nums;\n    letter-spacing: 0.025em;\n  }\n  \n  .text-mono {\n    font-family: ui-monospace, monospace;\n    font-variant-numeric: tabular-nums;\n  }\n  \n  /* Spacing Utilities using 8pt scale */\n  .space-y-4 > * + * { margin-top: var(--space-4); }\n  .space-y-6 > * + * { margin-top: var(--space-6); }\n  .space-y-8 > * + * { margin-top: var(--space-8); }\n  \n  .p-4 { padding: var(--space-4); }\n  .p-6 { padding: var(--space-6); }\n  .p-8 { padding: var(--space-8); }\n  \n  .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }\n  .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }\n  \n  .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }\n  .py-6 { padding-top: var(--space-6); padding-bottom: var(--space-6); }\n  \n  /* Legacy Format Support */\n  .currency-format { @apply text-tabular; }\n  .time-format { @apply text-mono; }\n  \n  /* RTL (Right-to-Left) Language Support */\n  [dir=\"rtl\"] {\n    direction: rtl;\n  }\n  \n  /* Flip layout for RTL */\n  [dir=\"rtl\"] .flex-row {\n    flex-direction: row-reverse;\n  }\n  \n  [dir=\"rtl\"] .space-x-reverse > * + * {\n    margin-right: var(--tw-space-x-reverse, 0);\n    margin-left: calc(var(--tw-space-x-reverse, 0) * -1);\n  }\n  \n  /* Mirror icons and arrows for RTL */\n  [dir=\"rtl\"] .rtl-mirror {\n    transform: scaleX(-1);\n  }\n  \n  /* Adjust padding for RTL */\n  [dir=\"rtl\"] .pl-4 { padding-left: 0; padding-right: var(--space-4); }\n  [dir=\"rtl\"] .pr-4 { padding-right: 0; padding-left: var(--space-4); }\n  [dir=\"rtl\"] .ml-auto { margin-left: 0; margin-right: auto; }\n  [dir=\"rtl\"] .mr-auto { margin-right: 0; margin-left: auto; }\n  \n  /* RTL-specific text alignment */\n  [dir=\"rtl\"] .text-left { text-align: right; }\n  [dir=\"rtl\"] .text-right { text-align: left; }\n  \n  /* Border radius for RTL */\n  [dir=\"rtl\"] .rounded-l { border-radius: 0 var(--radius) var(--radius) 0; }\n  [dir=\"rtl\"] .rounded-r { border-radius: var(--radius) 0 0 var(--radius); }\n  \n  /* Professional Icon Container Styles */\n  .icon-container-primary {\n    @apply bg-blue-600 dark:bg-blue-500 text-white rounded-xl flex items-center justify-center;\n  }\n  \n  .icon-container-success {\n    @apply bg-green-600 dark:bg-green-500 text-white rounded-xl flex items-center justify-center;\n  }\n  \n  .icon-container-warning {\n    @apply bg-amber-600 dark:bg-amber-500 text-white rounded-xl flex items-center justify-center;\n  }\n  \n  .icon-container-error {\n    @apply bg-red-600 dark:bg-red-500 text-white rounded-xl flex items-center justify-center;\n  }\n  \n  .icon-container-neutral {\n    @apply bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl flex items-center justify-center;\n  }\n  \n  /* Stat Card Enhancement */\n  .stat-trend-positive {\n    @apply text-green-600 dark:text-green-400 font-medium;\n  }\n  \n  .stat-trend-negative {\n    @apply text-red-600 dark:text-red-400 font-medium;\n  }\n  \n  .stat-trend-neutral {\n    @apply text-gray-600 dark:text-gray-400 font-medium;\n  }\n  \n  /* Subtle Sparkline Container */\n  .sparkline-container {\n    @apply h-8 w-full;\n  }\n  \n  /* Empty State Containers */\n  .empty-state {\n    @apply flex flex-col items-center justify-center text-center p-8 space-y-4;\n  }\n  \n  .empty-state-icon {\n    @apply w-16 h-16 text-gray-400 dark:text-gray-600;\n  }\n  \n  /* Professional Focus Ring */\n  .focus-ring-pro:focus-visible {\n    outline: 2px solid hsl(var(--ring));\n    outline-offset: 2px;\n    border-radius: var(--radius-md);\n  }\n  \n  /* Premium Skeleton Loader with Royal Blue Shimmer */\n  .skeleton {\n    @apply bg-gray-200 dark:bg-gray-800 rounded;\n    position: relative;\n    overflow: hidden;\n  }\n  \n  .skeleton::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: linear-gradient(\n      90deg,\n      transparent 0%,\n      hsl(217 91% 60% / 0.08) 50%,\n      transparent 100%\n    );\n    animation: skeleton-shimmer 1.5s infinite;\n  }\n  \n  .dark .skeleton::after {\n    background: linear-gradient(\n      90deg,\n      transparent 0%,\n      hsl(217 91% 65% / 0.12) 50%,\n      transparent 100%\n    );\n  }\n  \n  @keyframes skeleton-shimmer {\n    0% {\n      transform: translateX(-100%);\n    }\n    100% {\n      transform: translateX(100%);\n    }\n  }\n  \n  @keyframes shimmer {\n    0% {\n      background-position: 200% 0;\n    }\n    100% {\n      background-position: -200% 0;\n    }\n  }\n  \n  .animate-shimmer {\n    animation: shimmer 2s infinite linear;\n  }\n  \n  /* Skeleton variants */\n  .skeleton-text {\n    @apply skeleton rounded h-4;\n  }\n  \n  .skeleton-heading {\n    @apply skeleton rounded h-6;\n  }\n  \n  .skeleton-avatar {\n    @apply skeleton rounded-full;\n  }\n  \n  .skeleton-button {\n    @apply skeleton rounded-lg h-10;\n  }\n  \n  .skeleton-card {\n    @apply skeleton rounded-xl;\n  }\n  \n  /* Reduced motion preference */\n  @media (prefers-reduced-motion: reduce) {\n    .skeleton::after {\n      animation: none;\n    }\n  }\n  \n  /* ============================================\n   * ACCESSIBILITY UTILITIES\n   * WCAG 2.1 AA Compliant\n   * ============================================ */\n  \n  /* Screen reader only - visually hidden but accessible */\n  .sr-only {\n    position: absolute;\n    width: 1px;\n    height: 1px;\n    padding: 0;\n    margin: -1px;\n    overflow: hidden;\n    clip: rect(0, 0, 0, 0);\n    white-space: nowrap;\n    border-width: 0;\n  }\n  \n  /* Skip to main content link */\n  .skip-link {\n    position: absolute;\n    top: -40px;\n    left: 0;\n    padding: 8px 16px;\n    background: hsl(var(--background));\n    color: hsl(var(--foreground));\n    border: 2px solid hsl(var(--primary));\n    border-radius: var(--radius);\n    z-index: 9999;\n    font-weight: 600;\n    transition: top 0.2s ease-out;\n  }\n  \n  .skip-link:focus {\n    top: 4px;\n    outline: 2px solid hsl(var(--primary));\n    outline-offset: 2px;\n  }\n  \n  /* Focus visible utilities - Enhanced focus rings */\n  .focus-visible-ring {\n    outline: none;\n  }\n  \n  .focus-visible-ring:focus-visible {\n    outline: 2px solid hsl(var(--primary));\n    outline-offset: 2px;\n  }\n  \n  /* High contrast focus for critical actions */\n  .focus-high-contrast:focus-visible {\n    outline: 3px solid hsl(var(--primary));\n    outline-offset: 3px;\n    box-shadow: 0 0 0 6px hsl(var(--primary) / 0.15);\n  }\n  \n  /* Focus within for container elements */\n  .focus-within-ring:focus-within {\n    outline: 2px solid hsl(var(--primary));\n    outline-offset: 2px;\n  }\n  \n  /* Keyboard navigation indicator */\n  .keyboard-nav-indicator {\n    position: relative;\n  }\n  \n  .keyboard-nav-indicator::before {\n    content: '';\n    position: absolute;\n    inset: -2px;\n    border: 2px solid transparent;\n    border-radius: calc(var(--radius) + 2px);\n    pointer-events: none;\n    transition: border-color 0.15s ease-out;\n  }\n  \n  .keyboard-nav-indicator:focus-visible::before {\n    border-color: hsl(var(--primary));\n  }\n  \n  /* High contrast mode support */\n  @media (prefers-contrast: high) {\n    * {\n      border-color: currentColor !important;\n    }\n    \n    .focus-visible-ring:focus-visible,\n    .focus-high-contrast:focus-visible {\n      outline-width: 3px;\n      outline-color: currentColor;\n    }\n    \n    button, a, input, select, textarea {\n      border-width: 2px !important;\n    }\n  }\n  \n  /* Color contrast helpers */\n  .text-high-contrast {\n    color: hsl(var(--foreground));\n    font-weight: 500;\n  }\n  \n  .bg-high-contrast {\n    background-color: hsl(var(--background));\n    color: hsl(var(--foreground));\n  }\n  \n  /* Interactive element minimum size (WCAG 2.5.5) */\n  .touch-accessible {\n    min-height: 44px;\n    min-width: 44px;\n    padding: 12px;\n  }\n  \n  /* Link accessibility - ensure links are distinguishable */\n  .link-accessible {\n    text-decoration: underline;\n    text-underline-offset: 2px;\n    text-decoration-thickness: 1px;\n  }\n  \n  .link-accessible:hover {\n    text-decoration-thickness: 2px;\n  }\n  \n  .link-accessible:focus-visible {\n    outline: 2px solid hsl(var(--primary));\n    outline-offset: 2px;\n    text-decoration: none;\n  }\n  \n  /* Error states with proper contrast */\n  .error-accessible {\n    color: hsl(var(--destructive));\n    font-weight: 500;\n  }\n  \n  .error-border-accessible {\n    border-color: hsl(var(--destructive));\n    border-width: 2px;\n  }\n  \n  /* Success states with proper contrast */\n  .success-accessible {\n    color: hsl(var(--success));\n    font-weight: 500;\n  }\n  \n  /* Warning states with proper contrast */\n  .warning-accessible {\n    color: hsl(var(--warning));\n    font-weight: 500;\n  }\n  \n  /* Disabled state styling */\n  .disabled-accessible {\n    opacity: 0.5;\n    cursor: not-allowed;\n    pointer-events: none;\n  }\n  \n  /* Selection color for better visibility */\n  ::selection {\n    background: hsl(var(--primary) / 0.2);\n    color: hsl(var(--foreground));\n  }\n  \n  /* Form label association */\n  label:has(+ input:required)::after,\n  label:has(+ select:required)::after,\n  label:has(+ textarea:required)::after {\n    content: ' *';\n    color: hsl(var(--destructive));\n    font-weight: 600;\n  }\n  \n  /* Reduced motion: disable all animations */\n  @media (prefers-reduced-motion: reduce) {\n    *,\n    *::before,\n    *::after {\n      animation-duration: 0.01ms !important;\n      animation-iteration-count: 1 !important;\n      transition-duration: 0.01ms !important;\n      scroll-behavior: auto !important;\n    }\n  }\n  \n  /* Print styles for accessibility */\n  @media print {\n    * {\n      color: #000 !important;\n      background: #fff !important;\n    }\n    \n    a {\n      text-decoration: underline !important;\n    }\n    \n    a[href]::after {\n      content: ' (' attr(href) ')';\n      font-size: 0.875em;\n    }\n  }\n  \n  /* ==========================================\n     MOBILE PERFORMANCE OPTIMIZATIONS\n     ========================================== */\n  \n  /* Optimize repaints on mobile - use will-change sparingly */\n  .gpu-accelerated {\n    transform: translateZ(0);\n    backface-visibility: hidden;\n    perspective: 1000px;\n  }\n  \n  /* Touch-action optimizations for specific elements */\n  .touch-pan-x {\n    touch-action: pan-x;\n  }\n  \n  .touch-pan-y {\n    touch-action: pan-y;\n  }\n  \n  .touch-pinch-zoom {\n    touch-action: pinch-zoom;\n  }\n  \n  /* Prevent rubber-banding on iOS for specific containers */\n  .no-overscroll {\n    overscroll-behavior: none;\n  }\n  \n  .overscroll-contain {\n    overscroll-behavior: contain;\n  }\n  \n  /* Mobile-specific reduced animations */\n  @media (hover: none) and (pointer: coarse) {\n    .mobile-reduce-motion * {\n      transition-duration: 0.15s !important;\n    }\n    \n    /* Disable hover effects on touch devices */\n    .no-hover-mobile:hover {\n      transform: none !important;\n      box-shadow: inherit !important;\n    }\n  }\n  \n  /* Mobile content visibility optimization */\n  .content-visibility-auto {\n    content-visibility: auto;\n    contain-intrinsic-size: auto 500px;\n  }\n  \n  /* Mobile-specific contain for layout optimization */\n  .contain-layout {\n    contain: layout;\n  }\n  \n  .contain-paint {\n    contain: paint;\n  }\n  \n  .contain-strict {\n    contain: strict;\n  }\n  \n  /* Improve text rendering on mobile */\n  @media (max-width: 768px) {\n    body {\n      text-rendering: optimizeSpeed;\n    }\n  }\n  \n  /* iOS-specific fixes */\n  @supports (-webkit-touch-callout: none) {\n    /* Prevent iOS text size adjust */\n    body {\n      -webkit-text-size-adjust: 100%;\n    }\n    \n    /* Fix iOS button styling */\n    button,\n    input[type=\"button\"],\n    input[type=\"submit\"] {\n      -webkit-appearance: none;\n    }\n    \n    /* Fix iOS tap highlight */\n    a, button, input, select, textarea {\n      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);\n    }\n  }\n  \n  /* Improve scroll performance */\n  .scroll-smooth-mobile {\n    scroll-behavior: smooth;\n    -webkit-overflow-scrolling: touch;\n  }\n  \n  /* Hide scrollbar on mobile but keep functionality */\n  .scrollbar-hide-mobile {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n  \n  .scrollbar-hide-mobile::-webkit-scrollbar {\n    display: none;\n  }\n  \n  /* Mobile image optimization */\n  img {\n    max-width: 100%;\n    height: auto;\n  }\n  \n  /* Lazy load hint for below-fold content */\n  .lazy-load-container {\n    content-visibility: auto;\n    contain-intrinsic-block-size: 200px;\n  }\n}\n\n/* ============================================\n * GRADIENT MESH ANIMATIONS\n * Subtle, professional animations for welcome page\n * Respects prefers-reduced-motion\n * ============================================ */\n\n@keyframes gentlePulse {\n  0%, 100% {\n    opacity: 1;\n    transform: scale(1);\n  }\n  50% {\n    opacity: 0.7;\n    transform: scale(1.05);\n  }\n}\n\n@keyframes meshFloat {\n  0%, 100% {\n    transform: translate(0, 0) rotate(0deg);\n  }\n  25% {\n    transform: translate(2%, 1%) rotate(0.5deg);\n  }\n  50% {\n    transform: translate(0, 2%) rotate(0deg);\n  }\n  75% {\n    transform: translate(-2%, 1%) rotate(-0.5deg);\n  }\n}\n\n@keyframes ambientGlow {\n  0%, 100% {\n    opacity: 0.3;\n    filter: blur(40px);\n  }\n  50% {\n    opacity: 0.5;\n    filter: blur(50px);\n  }\n}\n\n/* Respect user motion preferences */\n@media (prefers-reduced-motion: reduce) {\n  *,\n  *::before,\n  *::after {\n    animation-duration: 0.01ms !important;\n    animation-iteration-count: 1 !important;\n    transition-duration: 0.01ms !important;\n  }\n}\n","path":null,"size_bytes":40539,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from\"react\"\nimport * as TogglePrimitive from\"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst toggleVariants = cva(\n\"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n {\n  variants: {\n   variant: {\n    default:\"bg-transparent\",\n    outline:\n    \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n   },\n   size: {\n    default:\"h-10 px-3 min-w-10\",\n    sm:\"h-9 px-2.5 min-w-9\",\n    lg:\"h-11 px-5 min-w-11\",\n   },\n  },\n  defaultVariants: {\n   variant:\"default\",\n   size:\"default\",\n  },\n }\n)\n\nconst Toggle = React.forwardRef<\n React.ElementRef<typeof TogglePrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n  VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n <TogglePrimitive.Root\n  ref={ref}\n  className={cn(toggleVariants({ variant, size, className }))}\n  {...props}\n />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1449,"size_tokens":null},"client/src/components/dashboard/financial-goals-progress.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { Lightbulb, Target, TrendingUp } from\"lucide-react\";\nimport { Link } from\"wouter\";\nimport { ErrorState } from\"@/components/ui/error-state\";\nimport { queryClient } from\"@/lib/queryClient\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\nexport default function FinancialGoalsProgress() {\n const { formatAmount } = useUserCurrency();\n \n const { data: goals, isLoading, error } = useQuery({\n  queryKey: [\"/api/financial-goals\"],\n  queryFn: () => fetch(\"/api/financial-goals\").then(res => res.json()),\n });\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-1/3 mb-6\"></div>\n     <div className=\"space-y-6\">\n      {[...Array(3)].map((_, i) => (\n       <div key={i}>\n        <div className=\"h-4 bg-muted rounded w-1/2 mb-2\"></div>\n        <div className=\"h-3 bg-muted rounded w-full mb-2\"></div>\n        <div className=\"h-3 bg-muted rounded w-1/4\"></div>\n       </div>\n      ))}\n     </div>\n    </div>\n   </Card>\n  );\n }\n\n if (error) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <CardHeader className=\"p-0 mb-6\">\n     <CardTitle className=\"text-lg font-semibold\">Financial Goals Progress</CardTitle>\n    </CardHeader>\n    <CardContent className=\"p-0\">\n     <ErrorState \n      message=\"Failed to load goals. Please try again.\"\n      onRetry={() => queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] })}\n     />\n    </CardContent>\n   </Card>\n  );\n }\n\n const activeGoals = goals?.filter((goal: any) => goal.status ===\"active\") || [];\n\n return (\n  <Card className=\"p-6 shadow-sm\">\n   <CardHeader className=\"p-0 mb-6\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-xl font-semibold\">Financial Goals Progress</CardTitle>\n     <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-view-all-goals\" asChild>\n      <Link href=\"/financial-goals\">View All</Link>\n     </Button>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"p-0\">\n    {activeGoals.length === 0 ? (\n     <div className=\"text-center py-12 space-y-4\">\n      <div className=\"flex justify-center\">\n       <div className=\"w-16 h-16 bg-white dark:bg-gray-900 rounded-full flex items-center justify-center\">\n        <Target className=\"w-8 h-8 text-primary\" />\n       </div>\n      </div>\n      <div className=\"space-y-2\">\n       <h3 className=\"text-lg font-semibold text-foreground\">Start Your Financial Journey</h3>\n       <p className=\"text-sm text-muted-foreground max-w-md mx-auto\">\n        Set your first goal and track your progress towards financial freedom\n       </p>\n      </div>\n      <Button data-testid=\"button-create-first-goal\" asChild className=\"shadow-sm hover:shadow-md transition-shadow\">\n       <Link href=\"/financial-goals?create=1\">\n        <TrendingUp className=\"w-4 h-4 mr-2\" />\n        Create Your First Goal\n       </Link>\n      </Button>\n     </div>\n    ) : (\n     <div className=\"space-y-6\">\n      {activeGoals.slice(0, 3).map((goal: any) => {\n       const progress = (parseFloat(goal.currentAmount) / parseFloat(goal.targetAmount)) * 100;\n       const remaining = parseFloat(goal.targetAmount) - parseFloat(goal.currentAmount);\n       \n       return (\n        <div key={goal.id}>\n         <div className=\"flex items-center justify-between mb-2\">\n          <div>\n           <h3 className=\"font-medium text-foreground\" data-testid={`text-goal-${goal.id}`}>\n            {goal.title}\n           </h3>\n           <p className=\"text-sm text-muted-foreground\">\n            Target: {formatAmount(parseFloat(goal.targetAmount))} by {new Date(goal.targetDate).toLocaleDateString()}\n           </p>\n          </div>\n          <span className=\"text-sm font-medium text-foreground\">\n           {formatAmount(parseFloat(goal.currentAmount))} / {formatAmount(parseFloat(goal.targetAmount))}\n          </span>\n         </div>\n         <Progress value={progress} className=\"h-3 mb-1\" />\n         <p className=\"text-xs text-muted-foreground\">\n          {Math.round(progress)}% complete • {formatAmount(remaining)} remaining\n         </p>\n        </div>\n       );\n      })}\n     </div>\n    )}\n\n    <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800\">\n     <div className=\"flex items-start space-x-3\">\n      <Lightbulb className=\"text-primary mt-1\" size={16} />\n      <div>\n       <h4 className=\"font-medium text-foreground\">Smart Suggestion</h4>\n       <p className=\"text-sm text-muted-foreground mt-1\">\n        Create your first financial goal to start tracking your progress towards your savings targets.\n        Set realistic deadlines and amounts to stay motivated.\n       </p>\n      </div>\n     </div>\n    </div>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":4954,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from\"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from\"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n <nav\n  role=\"navigation\"\n  aria-label=\"pagination\"\n  className={cn(\"mx-auto flex w-full justify-center\", className)}\n  {...props}\n />\n)\nPagination.displayName =\"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n HTMLUListElement,\n React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n <ul\n  ref={ref}\n  className={cn(\"flex flex-row items-center gap-1\", className)}\n  {...props}\n />\n))\nPaginationContent.displayName =\"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n HTMLLIElement,\n React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName =\"PaginationItem\"\n\ntype PaginationLinkProps = {\n isActive?: boolean\n} & Pick<ButtonProps,\"size\"> &\n React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n className,\n isActive,\n size =\"icon\",\n ...props\n}: PaginationLinkProps) => (\n <a\n  aria-current={isActive ?\"page\" : undefined}\n  className={cn(\n   buttonVariants({\n    variant: isActive ?\"outline\" :\"ghost\",\n    size,\n   }),\n   className\n  )}\n  {...props}\n />\n)\nPaginationLink.displayName =\"PaginationLink\"\n\nconst PaginationPrevious = ({\n className,\n ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n <PaginationLink\n  aria-label=\"Go to previous page\"\n  size=\"default\"\n  className={cn(\"gap-1 pl-2.5\", className)}\n  {...props}\n >\n  <ChevronLeft className=\"h-4 w-4\" />\n  <span>Previous</span>\n </PaginationLink>\n)\nPaginationPrevious.displayName =\"PaginationPrevious\"\n\nconst PaginationNext = ({\n className,\n ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n <PaginationLink\n  aria-label=\"Go to next page\"\n  size=\"default\"\n  className={cn(\"gap-1 pr-2.5\", className)}\n  {...props}\n >\n  <span>Next</span>\n  <ChevronRight className=\"h-4 w-4\" />\n </PaginationLink>\n)\nPaginationNext.displayName =\"PaginationNext\"\n\nconst PaginationEllipsis = ({\n className,\n ...props\n}: React.ComponentProps<\"span\">) => (\n <span\n  aria-hidden\n  className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n  {...props}\n >\n  <MoreHorizontal className=\"h-4 w-4\" />\n  <span className=\"sr-only\">More pages</span>\n </span>\n)\nPaginationEllipsis.displayName =\"PaginationEllipsis\"\n\nexport {\n Pagination,\n PaginationContent,\n PaginationEllipsis,\n PaginationItem,\n PaginationLink,\n PaginationNext,\n PaginationPrevious,\n}\n","path":null,"size_bytes":2623,"size_tokens":null},"client/src/components/sidebar.tsx":{"content":"import { memo, useMemo, useCallback } from \"react\";\nimport { Link, useLocation } from\"wouter\";\nimport { useTranslation } from 'react-i18next';\nimport { \n Home, \n Target, \n Settings,\n Crown,\n Brain,\n Moon,\n Sun,\n User,\n Users,\n Wallet,\n LogOut,\n Loader2\n} from\"lucide-react\";\nimport logoUrl from\"@assets/5-removebg-preview_1761578659737.png\";\nimport { cn } from\"@/lib/utils\";\nimport LanguageSwitcher from\"@/components/language-switcher\";\nimport { useTheme } from\"@/components/theme-provider\";\nimport { Button } from\"@/components/ui/button\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from\"@/components/ui/tooltip\";\nimport { useAuth } from\"@/hooks/useAuth\";\nimport {\n Sidebar as SidebarWrapper,\n SidebarContent,\n SidebarFooter,\n SidebarHeader,\n} from\"@/components/ui/sidebar\";\nimport { useMutation } from\"@tanstack/react-query\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\n\ninterface NavSection {\n title: string;\n items: Array<{\n name: string;\n href: string;\n icon: any;\n description: string;\n }>;\n}\n\nconst getNavigationSections = (t: (key: string) => string): NavSection[] => [\n {\n title: t('navigation.sections.main'),\n items: [\n { \n name: t('navigation.dashboard'), \n href:\"/\", \n icon: Home,\n description: t('navigation.descriptions.dashboard')\n },\n { \n name: t('navigation.aiAssistant'), \n href:\"/ai-assistant\", \n icon: Brain,\n description:\"GPT-5 & Opus 4.1 financial intelligence with analytics and predictions\"\n },\n ]\n },\n {\n title: t('navigation.sections.finance'),\n items: [\n { \n name:\"My Money\", \n href:\"/money-tracking\", \n icon: Wallet,\n description:\"Track income, expenses, budgets, and your financial profile\"\n },\n { \n name: t('navigation.goals'), \n href:\"/financial-goals\", \n icon: Target,\n description: t('navigation.descriptions.goals')\n },\n ]\n },\n {\n title:\"Collaborate\",\n items: [\n { \n name: t('navigation.groups'), \n href:\"/groups\", \n icon: Users,\n description:\"Manage shared finances with family, friends, or teams\"\n },\n ]\n },\n {\n title: t('navigation.sections.more'),\n items: [\n { \n name:\"Settings\", \n href:\"/settings\", \n icon: Settings,\n description:\"Preferences, profile, and account settings\"\n },\n { \n name: t('navigation.premium'), \n href:\"/subscription\", \n icon: Crown,\n description:\"Upgrade to Pro or Enterprise for advanced AI\"\n },\n ]\n }\n];\n\nfunction SidebarComponent() {\n const [location, setLocation] = useLocation();\n const { t } = useTranslation();\n const { theme, setTheme } = useTheme();\n const { user } = useAuth();\n const { toast } = useToast();\n \n // Memoize navigation sections to avoid recalculation on every render\n const navigationSections = useMemo(() => getNavigationSections(t), [t]);\n\n const logoutMutation = useMutation({\n mutationFn: async () => {\n return await apiRequest('POST', '/api/auth/logout', {});\n },\n onSuccess: () => {\n // Invalidate auth queries\n queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n queryClient.invalidateQueries({ queryKey: ['/api/auth/status'] });\n queryClient.clear(); // Clear all cached data on logout\n \n // Show success toast\n toast({\n title:\"Signed out securely\",\n description:\"You have been logged out successfully\",\n });\n \n // Redirect to login page\n setTimeout(() => {\n setLocation('/login');\n }, 100);\n },\n onError: (error: any) => {\n toast({\n title:\"Logout failed\",\n description: error.message ||\"Please try again\",\n variant:\"destructive\",\n });\n },\n });\n\n const handleLogout = useCallback(() => {\n logoutMutation.mutate();\n }, [logoutMutation]);\n\n const toggleTheme = useCallback(() => {\n if (theme ===\"dark\") {\n setTheme(\"light\");\n } else {\n setTheme(\"dark\");\n }\n }, [theme, setTheme]);\n\n return (\n <SidebarWrapper className=\"bg-card border-r border-border shadow-sm\">\n <SidebarHeader className=\"p-6\">\n <Link href=\"/\">\n <div className=\"flex items-center gap-3 cursor-pointer group\" data-testid=\"link-logo\">\n <img \n src={logoUrl} \n alt=\"Twealth Logo\" \n className=\"w-10 h-10\"\n />\n <span className=\"font-bold text-xl text-foreground text-foreground\">\n Twealth\n </span>\n </div>\n </Link>\n </SidebarHeader>\n \n <SidebarContent>\n <nav className=\"px-4 pb-4\" aria-label=\"Main navigation\">\n <TooltipProvider delayDuration={300}>\n {navigationSections.map((section, sectionIndex) => (\n <div key={section.title} className={cn(sectionIndex > 0 &&\"mt-6\")}>\n <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 px-3\">\n {section.title}\n </h3>\n <ul className=\"space-y-1\" role=\"list\">\n {section.items.map((item) => {\n const isActive = location === item.href;\n return (\n <li key={item.name}>\n <Tooltip>\n <TooltipTrigger asChild>\n <Link href={item.href} className=\"block focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background rounded-lg\">\n <div\n className={cn(\n\"flex items-center space-x-3 px-3 py-2.5 min-h-[44px] rounded-lg cursor-pointer transition-all duration-150\",\n isActive\n ?\"bg-primary text-primary-foreground shadow-sm\"\n :\"text-muted-foreground hover:bg-muted hover:text-foreground active:scale-[0.98]\"\n )}\n data-testid={`nav-${item.name.toLowerCase().replace(/\\s+/g, '-')}`}\n role=\"link\"\n aria-label={`Navigate to ${item.name}`}\n aria-current={isActive ?\"page\" : undefined}\n >\n <item.icon size={20} aria-hidden=\"true\" className=\"flex-shrink-0\" />\n <span className=\"text-sm font-medium\">{item.name}</span>\n </div>\n </Link>\n </TooltipTrigger>\n <TooltipContent side=\"right\" className=\"max-w-xs\">\n <p className=\"text-xs\">{item.description}</p>\n </TooltipContent>\n </Tooltip>\n </li>\n );\n })}\n </ul>\n </div>\n ))}\n </TooltipProvider>\n </nav>\n </SidebarContent>\n \n <SidebarFooter>\n \n <div className=\"px-4 mb-4\">\n <div className=\"bg-muted rounded-lg p-4\">\n <div className=\"flex items-center space-x-3 mb-3\">\n <div className=\"w-10 h-10 bg-primary rounded-full flex items-center justify-center\">\n <User className=\"text-primary-foreground\" size={20} />\n </div>\n <div>\n <p className=\"font-semibold text-sm\" data-testid=\"text-username\">\n {user ? `${user.firstName} ${user.lastName}` : 'Loading...'}\n </p>\n <p className=\"text-xs text-muted-foreground\" data-testid=\"text-useremail\">\n {user?.email || 'Loading...'}\n </p>\n </div>\n </div>\n <div className=\"space-y-2\">\n <div className=\"flex items-center gap-2\">\n <LanguageSwitcher />\n <Tooltip>\n <TooltipTrigger asChild>\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={toggleTheme}\n className=\"h-8 w-8 p-0\"\n data-testid=\"button-theme-toggle\"\n aria-label={theme ===\"dark\" ? t('theme.switchToLight') : t('theme.switchToDark')}\n >\n {theme ===\"dark\" ? (\n <Sun size={16} className=\"text-muted-foreground hover:text-foreground\" aria-hidden=\"true\" />\n ) : (\n <Moon size={16} className=\"text-muted-foreground hover:text-foreground\" aria-hidden=\"true\" />\n )}\n </Button>\n </TooltipTrigger>\n <TooltipContent>\n <p className=\"text-xs\">{theme ===\"dark\" ? t('theme.switchToLight') : t('theme.switchToDark')}</p>\n </TooltipContent>\n </Tooltip>\n </div>\n <Link href=\"/settings\">\n <button \n className=\"text-xs text-muted-foreground hover:text-foreground transition-colors flex items-center\"\n data-testid=\"button-settings\"\n >\n <Settings size={12} className=\"mr-1\" />\n {t('navigation.settings')}\n </button>\n </Link>\n <button \n onClick={handleLogout}\n disabled={logoutMutation.isPending}\n className=\"text-xs text-destructive hover:text-destructive/90 transition-colors flex items-center disabled:opacity-50\"\n data-testid=\"button-logout\"\n >\n {logoutMutation.isPending ? (\n <Loader2 size={12} className=\"mr-1\" />\n ) : (\n <LogOut size={12} className=\"mr-1\" />\n )}\n {logoutMutation.isPending ?\"Signing out...\" :\"Sign out\"}\n </button>\n </div>\n </div>\n </div>\n </SidebarFooter>\n </SidebarWrapper>\n );\n}\n\n// Memoize the entire Sidebar to prevent re-renders when only location changes\nconst Sidebar = memo(SidebarComponent);\nexport default Sidebar;\n","path":null,"size_bytes":7844,"size_tokens":null},"client/src/components/forms/edit-goal-form.tsx":{"content":"import { useState } from\"react\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { z } from\"zod\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Textarea } from\"@/components/ui/textarea\";\nimport { Label } from\"@/components/ui/label\";\nimport { DialogHeader, DialogTitle, DialogDescription } from\"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\n\nconst editGoalFormSchema = z.object({\n title: z.string().min(1,\"Goal title is required\"),\n description: z.string().optional(),\n targetAmount: z.string().min(1,\"Target amount is required\").refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\"Must be a valid positive number\"),\n currentAmount: z.string().optional().refine((val) => !val || (!isNaN(parseFloat(val)) && parseFloat(val) >= 0),\"Must be a valid positive number\"),\n targetDate: z.string().min(1,\"Target date is required\"),\n category: z.string().optional(),\n priority: z.enum([\"low\",\"medium\",\"high\"]).default(\"medium\"),\n});\n\ntype EditGoalFormData = z.infer<typeof editGoalFormSchema>;\n\ninterface EditGoalFormProps {\n goal: any; // The existing goal data to edit\n onSuccess?: () => void;\n}\n\nconst GOAL_CATEGORIES = [\n\"emergency\",\n\"house\",\n\"vacation\",\n\"car\",\n\"education\",\n\"retirement\",\n\"investment\",\n\"other\"\n];\n\nexport default function EditGoalForm({ goal, onSuccess }: EditGoalFormProps) {\n const [isSubmitting, setIsSubmitting] = useState(false);\n const { toast } = useToast();\n const queryClient = useQueryClient();\n\n // Format date for input field (YYYY-MM-DD)\n const formatDateForInput = (date: string | Date) => {\n  if (!date) return\"\";\n  const d = new Date(date);\n  return d.toISOString().split('T')[0];\n };\n\n const {\n  register,\n  handleSubmit,\n  setValue,\n  watch,\n  formState: { errors },\n } = useForm<EditGoalFormData>({\n  resolver: zodResolver(editGoalFormSchema),\n  defaultValues: {\n   title: goal?.title ||\"\",\n   description: goal?.description ||\"\",\n   targetAmount: goal?.targetAmount ||\"\",\n   currentAmount: goal?.currentAmount ||\"0\",\n   targetDate: formatDateForInput(goal?.targetDate),\n   category: goal?.category ||\"\",\n   priority: goal?.priority ||\"medium\",\n  },\n });\n\n const updateGoalMutation = useMutation({\n  mutationFn: (data: EditGoalFormData) => \n   apiRequest(\"PUT\", `/api/financial-goals/${goal.id}`, {\n    ...data,\n    targetAmount: data.targetAmount, // Keep as string for decimal field\n    currentAmount: data.currentAmount ||\"0\", // Keep as string for decimal field\n    targetDate: new Date(data.targetDate), // Send as Date object for timestamp field\n   }),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/goal-milestones\"] });\n   toast({\n    title:\"Goal updated\",\n    description:\"Your financial goal has been updated successfully.\",\n   });\n   onSuccess?.();\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Error\",\n    description: error.message,\n    variant:\"destructive\",\n   });\n  },\n  onSettled: () => {\n   setIsSubmitting(false);\n  },\n });\n\n const onSubmit = (data: EditGoalFormData) => {\n  // Validate target date is in the future\n  if (new Date(data.targetDate) <= new Date()) {\n   toast({\n    title:\"Invalid date\",\n    description:\"Target date must be in the future.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n\n  // Validate current amount doesn't exceed target amount\n  const current = parseFloat(data.currentAmount ||\"0\");\n  const target = parseFloat(data.targetAmount);\n  if (current > target) {\n   toast({\n    title:\"Invalid amounts\",\n    description:\"Current amount cannot exceed target amount.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n  \n  setIsSubmitting(true);\n  updateGoalMutation.mutate(data);\n };\n\n return (\n  <>\n   <DialogHeader>\n    <DialogTitle>Edit Financial Goal</DialogTitle>\n    <DialogDescription>\n     Update your goal details, target amount, or deadline\n    </DialogDescription>\n   </DialogHeader>\n   \n   <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n    <div>\n     <Label htmlFor=\"title\">Goal Title</Label>\n     <Input\n      id=\"title\"\n      {...register(\"title\")}\n      placeholder=\"e.g., Emergency Fund, Vacation, House Down Payment\"\n      data-testid=\"input-edit-goal-title\"\n     />\n     {errors.title && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.title.message}</p>\n     )}\n    </div>\n\n    <div>\n     <Label htmlFor=\"description\">Description (Optional)</Label>\n     <Textarea\n      id=\"description\"\n      {...register(\"description\")}\n      placeholder=\"Describe your goal and why it's important to you\"\n      rows={3}\n      data-testid=\"input-edit-goal-description\"\n     />\n    </div>\n\n    <div className=\"grid grid-cols-2 gap-4\">\n     <div>\n      <Label htmlFor=\"targetAmount\">Target Amount ($)</Label>\n      <Input\n       id=\"targetAmount\"\n       type=\"number\"\n       step=\"0.01\"\n       min=\"0\"\n       {...register(\"targetAmount\")}\n       placeholder=\"10000\"\n       data-testid=\"input-edit-goal-target-amount\"\n      />\n      {errors.targetAmount && (\n       <p className=\"text-sm text-destructive mt-1\">{errors.targetAmount.message}</p>\n      )}\n     </div>\n\n     <div>\n      <Label htmlFor=\"currentAmount\">Current Amount ($)</Label>\n      <Input\n       id=\"currentAmount\"\n       type=\"number\"\n       step=\"0.01\"\n       min=\"0\"\n       {...register(\"currentAmount\")}\n       placeholder=\"0\"\n       data-testid=\"input-edit-goal-current-amount\"\n      />\n      {errors.currentAmount && (\n       <p className=\"text-sm text-destructive mt-1\">{errors.currentAmount.message}</p>\n      )}\n     </div>\n    </div>\n\n    <div>\n     <Label htmlFor=\"targetDate\">Target Date</Label>\n     <Input\n      id=\"targetDate\"\n      type=\"date\"\n      {...register(\"targetDate\")}\n      data-testid=\"input-edit-goal-target-date\"\n     />\n     {errors.targetDate && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.targetDate.message}</p>\n     )}\n    </div>\n\n    <div className=\"grid grid-cols-2 gap-4\">\n     <div>\n      <Label htmlFor=\"category\">Category</Label>\n      <Select value={watch(\"category\") ||\"\"} onValueChange={(value) => setValue(\"category\", value || undefined)}>\n       <SelectTrigger data-testid=\"select-edit-goal-category\">\n        <SelectValue placeholder=\"Select category\" />\n       </SelectTrigger>\n       <SelectContent>\n        {GOAL_CATEGORIES.map((category) => (\n         <SelectItem key={category} value={category}>\n          {category.charAt(0).toUpperCase() + category.slice(1)}\n         </SelectItem>\n        ))}\n       </SelectContent>\n      </Select>\n     </div>\n\n     <div>\n      <Label htmlFor=\"priority\">Priority</Label>\n      <Select value={watch(\"priority\")} onValueChange={(value) => setValue(\"priority\", value as any)}>\n       <SelectTrigger data-testid=\"select-edit-goal-priority\">\n        <SelectValue />\n       </SelectTrigger>\n       <SelectContent>\n        <SelectItem value=\"low\">Low</SelectItem>\n        <SelectItem value=\"medium\">Medium</SelectItem>\n        <SelectItem value=\"high\">High</SelectItem>\n       </SelectContent>\n      </Select>\n     </div>\n    </div>\n\n    <div className=\"flex justify-end space-x-2 pt-4\">\n     <Button\n      type=\"button\"\n      variant=\"outline\"\n      onClick={onSuccess}\n      data-testid=\"button-cancel-edit\"\n     >\n      Cancel\n     </Button>\n     <Button\n      type=\"submit\"\n      disabled={isSubmitting}\n      data-testid=\"button-save-goal\"\n     >\n      {isSubmitting ?\"Saving...\" :\"Save Changes\"}\n     </Button>\n    </div>\n   </form>\n  </>\n );\n}","path":null,"size_bytes":7873,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from\"react-dom/client\";\nimport App from\"./App\";\nimport\"./index.css\";\nimport\"./i18n\"; // Initialize i18n\n\n// Mobile viewport height fix for iOS Safari\n// This sets a CSS variable --vh that represents 1% of the actual viewport height\nfunction setViewportHeight() {\n  const vh = window.innerHeight * 0.01;\n  document.documentElement.style.setProperty('--vh', `${vh}px`);\n}\n\n// Set on load and resize\nsetViewportHeight();\nwindow.addEventListener('resize', setViewportHeight);\nwindow.addEventListener('orientationchange', () => {\n  // Small delay to ensure the browser has updated the dimensions\n  setTimeout(setViewportHeight, 100);\n});\n\n// Register service worker for PWA functionality\n// Always register in production, check for HTTPS or localhost in development\nconst canRegisterSW = 'serviceWorker' in navigator && (\n  import.meta.env.PROD || \n  window.location.protocol === 'https:' || \n  window.location.hostname === 'localhost'\n);\n\nif (canRegisterSW) {\n window.addEventListener('load', async () => {\n  try {\n   const registration = await navigator.serviceWorker.register('/sw.js', {\n    scope: '/',\n    updateViaCache: 'none'\n   });\n   console.log('[PWA] Service Worker registered successfully:', registration.scope);\n   \n   // Handle updates\n   registration.addEventListener('updatefound', () => {\n    const newWorker = registration.installing;\n    if (newWorker) {\n     newWorker.addEventListener('statechange', () => {\n      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n       // New version available\n       console.log('[PWA] New version available. Refresh to update.');\n       if (confirm('A new version of Twealth is available. Refresh to update?')) {\n        window.location.reload();\n       }\n      }\n     });\n    }\n   });\n\n   // Check for updates every hour\n   setInterval(() => {\n    registration.update();\n   }, 60 * 60 * 1000);\n\n  } catch (error) {\n   console.error('[PWA] Service Worker registration failed:', error);\n  }\n });\n}\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":2063,"size_tokens":null},"client/src/components/error-boundary.tsx":{"content":"import { Component, ErrorInfo, ReactNode } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { AlertTriangle, RefreshCw, Home } from 'lucide-react';\n\ninterface Props {\n children: ReactNode;\n fallback?: ReactNode;\n}\n\ninterface State {\n hasError: boolean;\n error?: Error;\n}\n\nclass ErrorBoundary extends Component<Props, State> {\n public state: State = {\n  hasError: false\n };\n\n public static getDerivedStateFromError(error: Error): State {\n  return { hasError: true, error };\n }\n\n public componentDidCatch(error: Error, errorInfo: ErrorInfo) {\n  console.error('Error boundary caught an error:', error, errorInfo);\n  \n  if (import.meta.env.DEV) {\n   console.group('Error Boundary Details');\n   console.error('Error:', error);\n   console.error('Component Stack:', errorInfo.componentStack);\n   console.groupEnd();\n  }\n }\n\n private handleRetry = () => {\n  this.setState({ hasError: false, error: undefined });\n };\n\n public render() {\n  if (this.state.hasError) {\n   if (this.props.fallback) {\n    return this.props.fallback;\n   }\n\n   return (\n    <div \n     className=\"fixed inset-0 flex items-center justify-center bg-background dark:bg-black p-4 sm:p-6\"\n     style={{ \n      paddingTop: 'max(1rem, env(safe-area-inset-top))',\n      paddingBottom: 'max(1rem, env(safe-area-inset-bottom))',\n      paddingLeft: 'max(1rem, env(safe-area-inset-left))',\n      paddingRight: 'max(1rem, env(safe-area-inset-right))'\n     }}\n     role=\"alert\" \n     aria-live=\"assertive\"\n    >\n     <Card className=\"w-full max-w-sm sm:max-w-md border-destructive/30 dark:border-red-500/30 bg-card dark:bg-zinc-900 shadow-xl\">\n      <CardHeader className=\"pb-3 sm:pb-4\">\n       <CardTitle className=\"flex items-center gap-2.5 sm:gap-3 text-destructive dark:text-red-400 text-lg sm:text-xl\">\n        <div className=\"w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-destructive/10 dark:bg-red-500/10 flex items-center justify-center flex-shrink-0\">\n         <AlertTriangle className=\"w-4 h-4 sm:w-5 sm:h-5\" aria-hidden=\"true\" />\n        </div>\n        Something went wrong\n       </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4 sm:space-y-5\">\n       <p className=\"text-sm sm:text-base text-muted-foreground dark:text-zinc-400 leading-relaxed\">\n        {this.state.error?.message || 'An unexpected error occurred while loading this page.'}\n       </p>\n       \n       {import.meta.env.DEV && this.state.error?.stack && (\n        <details className=\"text-xs\">\n         <summary className=\"cursor-pointer text-muted-foreground hover:text-foreground py-2 min-h-[44px] flex items-center\">\n          View error details\n         </summary>\n         <pre className=\"mt-2 p-3 bg-muted dark:bg-zinc-800 rounded-lg overflow-auto max-h-40 text-xs\">\n          {this.state.error.stack}\n         </pre>\n        </details>\n       )}\n       \n       <div className=\"flex flex-col sm:flex-row gap-3\">\n        <Button \n         onClick={this.handleRetry}\n         className=\"flex-1 min-h-[48px] sm:min-h-[44px] text-sm sm:text-base font-medium bg-primary hover:bg-primary/90 touch-target\"\n         data-testid=\"button-retry-error\"\n         aria-label=\"Try loading again\"\n        >\n         <RefreshCw className=\"w-4 h-4 mr-2\" aria-hidden=\"true\" />\n         Try Again\n        </Button>\n        <Button \n         onClick={() => window.location.href = '/'}\n         variant=\"outline\"\n         className=\"flex-1 min-h-[48px] sm:min-h-[44px] text-sm sm:text-base font-medium border-border/60 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800 touch-target\"\n         data-testid=\"button-go-home\"\n         aria-label=\"Go to homepage\"\n        >\n         <Home className=\"w-4 h-4 mr-2\" aria-hidden=\"true\" />\n         Go Home\n        </Button>\n       </div>\n      </CardContent>\n     </Card>\n    </div>\n   );\n  }\n\n  return this.props.children;\n }\n}\n\nexport default ErrorBoundary;","path":null,"size_bytes":3945,"size_tokens":null},"client/src/components/dashboard/quick-actions.tsx":{"content":"import { useState, useEffect, useCallback } from\"react\";\nimport { \n Plus, \n Target, \n DollarSign, \n Calendar, \n Users, \n TrendingUp,\n Clock,\n Zap\n} from\"lucide-react\";\nimport { useQuery } from\"@tanstack/react-query\";\nimport { Button } from\"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport {\n Drawer,\n DrawerContent,\n DrawerDescription,\n DrawerTitle,\n DrawerTrigger,\n} from\"@/components/ui/drawer\";\nimport GoalForm from\"@/components/forms/goal-form\";\nimport TransactionForm from\"@/components/forms/transaction-form\";\nimport EventForm from\"@/components/forms/event-form\";\nimport { TimeTracker } from\"@/components/time-tracker\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\n\nexport default function QuickActions() {\n const [isGoalDrawerOpen, setIsGoalDrawerOpen] = useState(false);\n const [isTransactionDrawerOpen, setIsTransactionDrawerOpen] = useState(false);\n const [isEventDrawerOpen, setIsEventDrawerOpen] = useState(false);\n const [isTimerDrawerOpen, setIsTimerDrawerOpen] = useState(false);\n const [selectedEventForTimer, setSelectedEventForTimer] = useState<string | null>(null);\n\n // Get upcoming events for timer\n const { data: upcomingEvents } = useQuery({\n queryKey: ['/api/events/upcoming'],\n queryFn: () => fetch('/api/events/upcoming?limit=5').then(res => res.json()),\n });\n\n // Keyboard shortcuts handler\n const handleKeyPress = useCallback((event: KeyboardEvent) => {\n // Only trigger if no modifier keys are pressed and not in an input/textarea\n if (event.ctrlKey || event.metaKey || event.altKey || event.shiftKey) return;\n if (event.target instanceof HTMLInputElement || event.target instanceof HTMLTextAreaElement) return;\n \n switch (event.key.toLowerCase()) {\n case 'g':\n event.preventDefault();\n setIsGoalDrawerOpen(true);\n break;\n case 't':\n event.preventDefault();\n setIsTransactionDrawerOpen(true);\n break;\n case 'e':\n event.preventDefault();\n setIsEventDrawerOpen(true);\n break;\n }\n }, []);\n\n // Set up keyboard shortcuts\n useEffect(() => {\n document.addEventListener('keydown', handleKeyPress);\n return () => document.removeEventListener('keydown', handleKeyPress);\n }, [handleKeyPress]);\n\n const quickActions = [\n {\n id:\"add-goal\",\n title:\"New Goal\",\n description:\"Set financial target\",\n icon: Target,\n color:\"text-primary\",\n bgColor:\"bg-primary/10\",\n action: () => setIsGoalDrawerOpen(true),\n shortcut:\"G\"\n },\n {\n id:\"add-transaction\",\n title:\"Add Transaction\",\n description:\"Record income/expense\",\n icon: DollarSign,\n color:\"text-success\",\n bgColor:\"bg-success/10\",\n action: () => setIsTransactionDrawerOpen(true),\n shortcut:\"T\"\n },\n {\n id:\"schedule-event\",\n title:\"Add Event\",\n description:\"Plan new activity\",\n icon: Calendar,\n color:\"text-warning\",\n bgColor:\"bg-warning/10\",\n action: () => setIsEventDrawerOpen(true),\n shortcut:\"E\"\n },\n {\n id:\"time-tracker\",\n title:\"Start Timer\",\n description:\"Track productivity\",\n icon: Clock,\n color:\"text-info\",\n bgColor:\"bg-info/10\",\n action: () => setIsTimerDrawerOpen(true),\n shortcut:\"⏲️\"\n }\n ];\n\n return (\n <>\n <Card className=\"overflow-hidden bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-lg\" role=\"region\" aria-label=\"Quick Actions\">\n <CardHeader className=\"pb-4\">\n <CardTitle className=\"text-lg font-semibold text-primary-foreground flex items-center gap-2\">\n <Zap className=\"h-5 w-5\" aria-hidden=\"true\" />\n Quick Actions\n </CardTitle>\n </CardHeader>\n <CardContent className=\"pt-0\">\n <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 md:gap-3\">\n {quickActions.map((action, index) => (\n <Button\n key={action.id}\n variant=\"ghost\"\n onClick={action.action}\n className={`h-auto p-3 md:p-4 flex flex-col items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600 button-press group touch-manipulation`}\n style={{\n animationDelay: `${index * 0.1}s`,\n borderRadius: 'var(--radius-lg)',\n minHeight: 'clamp(100px, 15vw, 120px)'\n }}\n data-testid={`button-${action.id}`}\n aria-label={`${action.title}: ${action.description}. Keyboard shortcut: ${action.shortcut}`}\n >\n <div \n className={`w-8 h-8 md:w-10 md:h-10 rounded-xl ${action.bgColor} ${action.color} flex items-center justify-center `}\n >\n <action.icon size={18} className=\"md:w-5 md:h-5\" />\n </div>\n <div className=\"text-center flex-1\">\n <p className=\"font-medium text-primary-foreground text-xs md:text-sm leading-tight\">\n {action.title}\n </p>\n <p className=\"text-xs text-primary-foreground/70 mt-1 hidden sm:block\">\n {action.description}\n </p>\n </div>\n <div className=\"text-xs bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 md:px-2 md:py-1 rounded-full text-foreground font-mono\">\n {action.shortcut}\n </div>\n </Button>\n ))}\n </div>\n </CardContent>\n </Card>\n\n {/* Goal Creation Drawer */}\n <Drawer open={isGoalDrawerOpen} onOpenChange={setIsGoalDrawerOpen}>\n <DrawerContent className=\"max-h-[90vh]\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <Target className=\"h-5 w-5 text-primary\" />\n Create New Financial Goal\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n Set up a new savings target and track your progress with smart insights\n </DrawerDescription>\n <GoalForm onSuccess={() => setIsGoalDrawerOpen(false)} />\n </div>\n </DrawerContent>\n </Drawer>\n\n {/* Transaction Creation Drawer */}\n <Drawer open={isTransactionDrawerOpen} onOpenChange={setIsTransactionDrawerOpen}>\n <DrawerContent className=\"max-h-[90vh]\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <DollarSign className=\"h-5 w-5 text-success\" />\n Add New Transaction\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n Record your income, expenses, or transfers to keep your finances up to date\n </DrawerDescription>\n <TransactionForm onSuccess={() => setIsTransactionDrawerOpen(false)} />\n </div>\n </DrawerContent>\n </Drawer>\n\n {/* Event Creation Drawer */}\n <Drawer open={isEventDrawerOpen} onOpenChange={setIsEventDrawerOpen}>\n <DrawerContent className=\"max-h-[90vh]\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <Calendar className=\"h-5 w-5 text-warning\" />\n Schedule New Event\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n Plan your time effectively and track the value of your scheduled activities\n </DrawerDescription>\n <EventForm onSuccess={() => setIsEventDrawerOpen(false)} />\n </div>\n </DrawerContent>\n </Drawer>\n\n {/* Timer Selection Drawer */}\n <Drawer open={isTimerDrawerOpen} onOpenChange={setIsTimerDrawerOpen}>\n <DrawerContent className=\"max-h-[90vh]\">\n <div className=\"p-4 pb-6\">\n <DrawerTitle className=\"text-xl font-semibold mb-2 flex items-center gap-2\">\n <Clock className=\"h-5 w-5 text-info\" />\n Start Time Tracking\n </DrawerTitle>\n <DrawerDescription className=\"text-muted-foreground mb-4\">\n Track time spent on your activities to optimize productivity and calculate value\n </DrawerDescription>\n \n {upcomingEvents && Array.isArray(upcomingEvents) && upcomingEvents.length > 0 ? (\n <div className=\"space-y-4\">\n <div>\n <label className=\"text-sm font-medium mb-2 block\">Select an event to track:</label>\n <Select value={selectedEventForTimer ||\"\"} onValueChange={setSelectedEventForTimer}>\n <SelectTrigger data-testid=\"select-event-timer\">\n <SelectValue placeholder=\"Choose an event...\" />\n </SelectTrigger>\n <SelectContent>\n {Array.isArray(upcomingEvents) && upcomingEvents.map((event: any) => (\n <SelectItem key={event.id} value={event.id}>\n {event.title} - {new Date(event.startTime).toLocaleDateString()}\n </SelectItem>\n ))}\n </SelectContent>\n </Select>\n </div>\n \n {selectedEventForTimer && (\n <div className=\"border rounded-lg p-4 bg-muted/20\">\n <TimeTracker\n eventId={selectedEventForTimer}\n eventTitle={Array.isArray(upcomingEvents) ? upcomingEvents.find((e: any) => e.id === selectedEventForTimer)?.title ||\"\" :\"\"}\n />\n </div>\n )}\n </div>\n ) : (\n <div className=\"text-center py-8\">\n <Clock className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n <h3 className=\"text-lg font-medium mb-2\">No Events Scheduled</h3>\n <p className=\"text-muted-foreground mb-4\">Create an event first to start tracking time</p>\n <Button \n onClick={() => {\n setIsTimerDrawerOpen(false);\n setIsEventDrawerOpen(true);\n }}\n data-testid=\"button-create-event-for-timer\"\n >\n <Calendar className=\"h-4 w-4 mr-2\" />\n Schedule Event\n </Button>\n </div>\n )}\n </div>\n </DrawerContent>\n </Drawer>\n </>\n );\n}","path":null,"size_bytes":8579,"size_tokens":null},"client/src/components/dashboard/upcoming-events.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from\"@/components/ui/avatar\";\nimport { Plus, Calendar } from\"lucide-react\";\nimport { Link } from\"wouter\";\nimport { SkeletonEvent } from\"@/components/ui/skeleton\";\n\n// Helper function to get user initials\nconst getUserInitials = (user: any): string => {\n if (user.firstName && user.lastName) {\n  return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();\n }\n if (user.firstName) {\n  return user.firstName[0].toUpperCase();\n }\n if (user.email) {\n  return user.email.slice(0, 2).toUpperCase();\n }\n return\"U\";\n};\n\nexport default function UpcomingEvents() {\n const { data: events, isLoading } = useQuery({\n  queryKey: [\"/api/events/upcoming\"],\n  queryFn: () => fetch(\"/api/events/upcoming?limit=5\").then(res => res.json()),\n });\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div className=\"space-y-4\">\n     {[...Array(3)].map((_, i) => (\n      <SkeletonEvent key={i} />\n     ))}\n    </div>\n   </Card>\n  );\n }\n\n const upcomingEvents = events || [];\n\n return (\n  <Card className=\"p-6 shadow-sm\">\n   <CardHeader className=\"p-0 mb-6\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-lg font-semibold\">Upcoming Events</CardTitle>\n     <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-view-calendar\" asChild>\n      <Link href=\"/calendar\">View Calendar</Link>\n     </Button>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"p-0\">\n    {upcomingEvents.length === 0 ? (\n     <div className=\"text-center py-8\">\n      <Calendar className=\"mx-auto h-12 w-12 text-muted-foreground mb-4\" />\n      <p className=\"text-muted-foreground mb-4\">No upcoming events</p>\n      <Button data-testid=\"button-schedule-first-event\" asChild>\n       <Link href=\"/calendar?create=1\">\n        <Plus size={16} className=\"mr-2\" />\n        Schedule Event\n       </Link>\n      </Button>\n     </div>\n    ) : (\n     <div className=\"space-y-4\">\n      {upcomingEvents.slice(0, 3).map((event: any) => (\n       <div key={event.id} className=\"flex items-start space-x-3 p-3 rounded-lg border border-border\">\n        <div className=\"w-2 h-2 bg-primary rounded-full mt-2\"></div>\n        <div className=\"flex-1\">\n         <h4 className=\"font-medium text-sm text-foreground\" data-testid={`text-event-${event.id}`}>\n          {event.title}\n         </h4>\n         <p className=\"text-xs text-muted-foreground\">\n          {event.groupId ?\"Group Event\" :\"Personal\"} • {new Date(event.startTime).toLocaleString()}\n         </p>\n         {event.attendeesWithUsers && event.attendeesWithUsers.length > 0 && (\n          <div className=\"flex items-center mt-2 space-x-2\">\n           <div className=\"flex -space-x-1\">\n            {event.attendeesWithUsers.slice(0, 3).map((attendee: any, index: number) => (\n             <Avatar key={index} className=\"w-6 h-6 border-2 border-background\">\n              <AvatarFallback className=\"text-xs\">\n               {getUserInitials(attendee.user)}\n              </AvatarFallback>\n             </Avatar>\n            ))}\n            {event.attendeesWithUsers.length > 3 && (\n             <Avatar className=\"w-6 h-6 border-2 border-background\">\n              <AvatarFallback className=\"text-xs\">\n               +{event.attendeesWithUsers.length - 3}\n              </AvatarFallback>\n             </Avatar>\n            )}\n           </div>\n          </div>\n         )}\n        </div>\n       </div>\n      ))}\n     </div>\n    )}\n\n    <Button variant=\"outline\" className=\"w-full mt-4\" data-testid=\"button-schedule-new-event\" asChild>\n     <Link href=\"/calendar?create=1\">\n      <Plus size={16} className=\"mr-2\" />\n      Schedule New Event\n     </Link>\n    </Button>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":3867,"size_tokens":null},"client/src/components/pwa/offline-indicator.tsx":{"content":"import { useState, useEffect } from\"react\";\nimport { Card, CardContent } from\"@/components/ui/card\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { WifiOff, Wifi } from\"lucide-react\";\n\nexport function OfflineIndicator() {\n const [isOnline, setIsOnline] = useState(navigator.onLine);\n const [showOfflineMessage, setShowOfflineMessage] = useState(false);\n\n useEffect(() => {\n  const handleOnline = () => {\n   setIsOnline(true);\n   setShowOfflineMessage(false);\n  };\n\n  const handleOffline = () => {\n   setIsOnline(false);\n   setShowOfflineMessage(true);\n   // Hide message after 5 seconds\n   setTimeout(() => setShowOfflineMessage(false), 5000);\n  };\n\n  window.addEventListener('online', handleOnline);\n  window.addEventListener('offline', handleOffline);\n\n  return () => {\n   window.removeEventListener('online', handleOnline);\n   window.removeEventListener('offline', handleOffline);\n  };\n }, []);\n\n if (!showOfflineMessage && isOnline) {\n  return null;\n }\n\n return (\n  <div className=\"fixed top-4 left-1/2 transform -translate-x-1/2 z-50\">\n   <Card className={`transition-all ${\n    isOnline \n     ? 'bg-green-50 border-green-200 dark:bg-green-950/20 dark:border-green-800/50' \n     : 'bg-orange-50 border-orange-200 dark:bg-orange-950/20 dark:border-orange-800/50'\n   }`}>\n    <CardContent className=\"py-2 px-4\">\n     <div className=\"flex items-center gap-2\">\n      {isOnline ? (\n       <>\n        <Wifi className=\"w-4 h-4 text-green-600 dark:text-green-400\" />\n        <span className=\"text-sm font-medium text-green-700 dark:text-green-300\">\n         Back online! Data syncing...\n        </span>\n       </>\n      ) : (\n       <>\n        <WifiOff className=\"w-4 h-4 text-orange-600 dark:text-orange-400\" />\n        <div className=\"flex flex-col\">\n         <span className=\"text-sm font-medium text-orange-700 dark:text-orange-300\">\n          You're offline\n         </span>\n         <span className=\"text-xs text-orange-600 dark:text-orange-400\">\n          Your data will sync when back online\n         </span>\n        </div>\n       </>\n      )}\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}","path":null,"size_bytes":2113,"size_tokens":null},"client/src/components/dashboard/groups-overview.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from\"@/components/ui/avatar\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Plus, Briefcase, TrendingUp, GraduationCap } from\"lucide-react\";\nimport { Link } from\"wouter\";\n\n// Helper function to get user initials\nconst getUserInitials = (user: any): string => {\n if (user.firstName && user.lastName) {\n  return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();\n }\n if (user.firstName) {\n  return user.firstName[0].toUpperCase();\n }\n if (user.username) {\n  return user.username.slice(0, 2).toUpperCase();\n }\n return\"U\";\n};\n\nconst getGroupIcon = (name: string) => {\n const lowerName = name.toLowerCase();\n if (lowerName.includes(\"team\") || lowerName.includes(\"work\")) return Briefcase;\n if (lowerName.includes(\"finance\") || lowerName.includes(\"money\")) return TrendingUp;\n if (lowerName.includes(\"learn\") || lowerName.includes(\"study\")) return GraduationCap;\n return Briefcase;\n};\n\nconst getGroupColor = (status: string) => {\n switch (status) {\n  case\"active\":\n   return { bg:\"bg-green-100\", text:\"text-green-800\" };\n  case\"planning\":\n   return { bg:\"bg-amber-100\", text:\"text-amber-800\" };\n  case\"archived\":\n   return { bg:\"bg-gray-100\", text:\"text-gray-800\" };\n  default:\n   return { bg:\"bg-blue-100\", text:\"text-blue-800\" };\n }\n};\n\n// Component to display member count\nfunction MemberCountDisplay({ groupId }: { groupId: string }) {\n const { data: members } = useQuery({\n  queryKey: ['/api/groups', groupId, 'members-with-users'],\n  enabled: !!groupId,\n });\n\n const memberCount = Array.isArray(members) ? members.length : 0;\n const memberText = memberCount === 1 ?\"member\" :\"members\";\n\n return (\n  <p className=\"text-xs text-muted-foreground\">\n   {memberCount} {memberText}\n  </p>\n );\n}\n\n// Component to display group member avatars\nfunction GroupMemberAvatars({ groupId }: { groupId: string }) {\n const { data: members } = useQuery({\n  queryKey: ['/api/groups', groupId, 'members-with-users'],\n  enabled: !!groupId,\n });\n\n if (!members || !Array.isArray(members)) {\n  return (\n   <div className=\"flex -space-x-2 mb-3\">\n    {[...Array(3)].map((_, index) => (\n     <Avatar key={index} className=\"w-8 h-8 border-2 border-background\">\n      <AvatarFallback className=\"text-xs bg-muted\">\n       {index + 1}\n      </AvatarFallback>\n     </Avatar>\n    ))}\n   </div>\n  );\n }\n\n const displayMembers = members.slice(0, 4);\n const remainingCount = Math.max(0, members.length - 4);\n\n return (\n  <div className=\"flex -space-x-2 mb-3\">\n   {displayMembers.map((member: any) => (\n    <Avatar key={member.user.id} className=\"w-8 h-8 border-2 border-background\">\n     <AvatarFallback className=\"text-xs\">\n      {getUserInitials(member.user)}\n     </AvatarFallback>\n    </Avatar>\n   ))}\n   {remainingCount > 0 && (\n    <Avatar className=\"w-8 h-8 border-2 border-background\">\n     <AvatarFallback className=\"text-xs bg-muted\">\n      +{remainingCount}\n     </AvatarFallback>\n    </Avatar>\n   )}\n  </div>\n );\n}\n\nexport default function GroupsOverview() {\n const { data: groups, isLoading } = useQuery({\n  queryKey: [\"/api/groups\"],\n });\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-1/2 mb-6\"></div>\n     <div className=\"space-y-4\">\n      {[...Array(3)].map((_, i) => (\n       <div key={i} className=\"p-4 border rounded-lg\">\n        <div className=\"h-4 bg-muted rounded w-3/4 mb-3\"></div>\n        <div className=\"flex -space-x-2 mb-3\">\n         {[...Array(4)].map((_, j) => (\n          <div key={j} className=\"w-8 h-8 bg-muted rounded-full\"></div>\n         ))}\n        </div>\n        <div className=\"h-3 bg-muted rounded w-1/2\"></div>\n       </div>\n      ))}\n     </div>\n    </div>\n   </Card>\n  );\n }\n\n const userGroups = Array.isArray(groups) ? groups : [];\n\n return (\n  <Card className=\"p-6 shadow-sm\">\n   <CardHeader className=\"p-0 mb-6\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-xl font-semibold\">Collaborative Events</CardTitle>\n     <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-manage-groups\" asChild>\n      <Link href=\"/groups\">View Events</Link>\n     </Button>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"p-0\">\n    {userGroups.length === 0 ? (\n     <div className=\"text-center py-8\">\n      <p className=\"text-muted-foreground mb-4\">No groups yet</p>\n      <Button data-testid=\"button-create-first-group\" asChild>\n       <Link href=\"/groups?create=1\">\n        <Plus size={16} className=\"mr-2\" />\n        Create Group\n       </Link>\n      </Button>\n     </div>\n    ) : (\n     <div className=\"space-y-4\">\n      {userGroups.slice(0, 3).map((group: any) => {\n       const Icon = getGroupIcon(group.name);\n       const statusColors = getGroupColor(group.status);\n       \n       return (\n        <div key={group.id} className=\"p-4 rounded-lg border border-border\">\n         <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"flex items-center space-x-3 min-w-0 flex-1\">\n           <div className=\"w-10 h-10 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center flex-shrink-0\">\n            <Icon className=\"text-blue-600\" size={20} />\n           </div>\n           <div className=\"min-w-0 flex-1\">\n            <h3 \n             className=\"font-medium text-foreground truncate\" \n             data-testid={`text-group-${group.id}`}\n             title={group.name}\n            >\n             {group.name}\n            </h3>\n            <MemberCountDisplay groupId={group.id} />\n           </div>\n          </div>\n          <Badge variant=\"secondary\" className={`${statusColors.bg} ${statusColors.text}`}>\n           {group.status}\n          </Badge>\n         </div>\n         \n         <GroupMemberAvatars groupId={group.id} />\n         \n         <p className=\"text-xs text-muted-foreground\">\n          Next meeting: Schedule pending\n         </p>\n        </div>\n       );\n      })}\n     </div>\n    )}\n\n    <Button variant=\"outline\" className=\"w-full mt-4\" data-testid=\"button-create-new-group\" asChild>\n     <Link href=\"/groups?create=1\">\n      <Plus size={16} className=\"mr-2\" />\n      Create New Group\n     </Link>\n    </Button>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":6365,"size_tokens":null},"client/src/components/settings/financial-preferences.tsx":{"content":"import { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Switch } from\"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { Input } from\"@/components/ui/input\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { \n DollarSign, \n Target, \n TrendingUp, \n Calendar, \n AlertTriangle,\n Settings,\n Plus,\n Minus,\n CheckCircle,\n Loader2,\n X\n} from\"lucide-react\";\n\ninterface FinancialPreferencesProps {}\n\ntype FinancialPreferences = {\n id: string;\n userId: string;\n defaultBudgetPeriod:\"weekly\" |\"monthly\" |\"yearly\";\n budgetWarningThreshold: number;\n autoSavingsEnabled: boolean;\n autoSavingsAmount: string;\n autoSavingsFrequency:\"weekly\" |\"monthly\";\n defaultGoalPriority:\"low\" |\"medium\" |\"high\";\n expenseCategories: string[];\n incomeCategories: string[];\n createdAt: string;\n updatedAt: string;\n};\n\nexport default function FinancialPreferences({ }: FinancialPreferencesProps) {\n const { toast } = useToast();\n\n const { data: preferences, isLoading } = useQuery<FinancialPreferences>({\n  queryKey: ['/api/financial-preferences'],\n });\n\n const updatePreferencesMutation = useMutation({\n  mutationFn: (updates: Partial<FinancialPreferences>) =>\n   apiRequest('PUT', '/api/financial-preferences', updates),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: ['/api/financial-preferences'] });\n   toast({\n    title:\"Financial preferences updated\",\n    description:\"Your settings have been saved successfully.\",\n   });\n  },\n  onError: () => {\n   toast({\n    title:\"Error\",\n    description:\"Failed to update financial preferences. Please try again.\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const budgetPeriods = [\n  { value:\"weekly\", label:\"Weekly\", description:\"Track spending week by week\", icon: Calendar },\n  { value:\"monthly\", label:\"Monthly\", description:\"Monthly budget cycles\", icon: Calendar },\n  { value:\"yearly\", label:\"Yearly\", description:\"Annual budget planning\", icon: Calendar }\n ];\n\n const goalPriorities = [\n  { value:\"low\", label:\"Low Priority\", color:\"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300\" },\n  { value:\"medium\", label:\"Medium Priority\", color:\"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300\" },\n  { value:\"high\", label:\"High Priority\", color:\"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300\" }\n ];\n\n const savingsFrequencies = [\n  { value:\"weekly\", label:\"Weekly\" },\n  { value:\"monthly\", label:\"Monthly\" }\n ];\n\n const handleBudgetPeriodChange = (period:\"weekly\" |\"monthly\" |\"yearly\") => {\n  updatePreferencesMutation.mutate({ defaultBudgetPeriod: period });\n };\n\n const handleAutoSavingsToggle = () => {\n  if (!preferences) return;\n  updatePreferencesMutation.mutate({ \n   autoSavingsEnabled: !preferences.autoSavingsEnabled \n  });\n };\n\n const handleAutoSavingsAmountChange = (amount: string) => {\n  updatePreferencesMutation.mutate({ autoSavingsAmount: amount });\n };\n\n const handleWarningThresholdChange = (threshold: number) => {\n  updatePreferencesMutation.mutate({ budgetWarningThreshold: threshold });\n };\n\n const handleGoalPriorityChange = (priority:\"low\" |\"medium\" |\"high\") => {\n  updatePreferencesMutation.mutate({ defaultGoalPriority: priority });\n };\n\n const handleSavingsFrequencyChange = (frequency:\"weekly\" |\"monthly\") => {\n  updatePreferencesMutation.mutate({ autoSavingsFrequency: frequency });\n };\n\n if (isLoading) {\n  return (\n   <div className=\"flex items-center justify-center p-8 sm:p-12\">\n    <Loader2 className=\"animate-spin mr-2 w-6 h-6 sm:w-8 sm:h-8 text-green-600\" />\n    <span className=\"text-base sm:text-lg text-slate-600 dark:text-slate-400\">Loading financial preferences...</span>\n   </div>\n  );\n }\n\n if (!preferences) {\n  return (\n   <div className=\"text-center p-8 sm:p-12\">\n    <p className=\"text-base sm:text-lg text-slate-600 dark:text-slate-400\">Failed to load financial preferences</p>\n   </div>\n  );\n }\n\n return (\n  <div className=\"space-y-4 sm:space-y-6\">\n   {/* Budget Settings */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <DollarSign className=\"w-5 h-5 sm:w-6 sm:h-6 text-green-600\" />\n      Budget Settings\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Configure your budget tracking and warning preferences\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-6\">\n     <div className=\"space-y-3 sm:space-y-4\">\n      <h4 className=\"font-medium text-sm sm:text-base text-slate-700 dark:text-slate-300\">Default Budget Period</h4>\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4\">\n       {budgetPeriods.map((period) => (\n        <button\n         key={period.value}\n         data-testid={`budget-period-${period.value}`}\n         onClick={() => handleBudgetPeriodChange(period.value as\"weekly\" |\"monthly\" |\"yearly\")}\n         disabled={updatePreferencesMutation.isPending}\n         className={`min-h-[88px] p-4 rounded-xl border-2 transition-all text-left ${\n          preferences.defaultBudgetPeriod === period.value \n           ? 'border-green-600 bg-green-50 dark:bg-green-950/30 shadow-md' \n           : 'border-slate-200 dark:border-slate-700 hover:border-green-400 dark:hover:border-green-600 bg-white dark:bg-slate-800/50'\n         } ${updatePreferencesMutation.isPending ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer[1.02]'}`}\n        >\n         <div className=\"flex items-center gap-2 mb-2\">\n          <period.icon className={`w-5 h-5 ${preferences.defaultBudgetPeriod === period.value ? 'text-green-600' : 'text-slate-400'}`} />\n          <h4 className=\"font-semibold text-sm sm:text-base text-slate-900 dark:text-white\">{period.label}</h4>\n         </div>\n         <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">{period.description}</p>\n        </button>\n       ))}\n      </div>\n     </div>\n\n     <div className=\"space-y-3 sm:space-y-4\">\n      <h4 className=\"font-medium text-sm sm:text-base text-slate-700 dark:text-slate-300\">Budget Warning Threshold</h4>\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4\">\n       <div className=\"flex-1 w-full\">\n        <Input\n         data-testid=\"input-warning-threshold\"\n         type=\"number\"\n         min=\"50\"\n         max=\"100\"\n         value={preferences.budgetWarningThreshold}\n         onChange={(e) => handleWarningThresholdChange(parseInt(e.target.value))}\n         disabled={updatePreferencesMutation.isPending}\n         className=\"h-12 sm:h-14 text-base w-full bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\"\n        />\n       </div>\n       <div className=\"flex items-center gap-2\">\n        <AlertTriangle className=\"text-yellow-600 w-5 h-5\" />\n        <span className=\"text-sm sm:text-base text-slate-600 dark:text-slate-400\">% of budget</span>\n       </div>\n      </div>\n      <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">\n       Get notified when spending reaches {preferences.budgetWarningThreshold}% of your budget\n      </p>\n     </div>\n    </CardContent>\n   </Card>\n\n   {/* Auto-Savings */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <Target className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" />\n      Auto-Savings Options\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Automatically save toward your financial goals\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-4\">\n     <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between min-h-[60px] p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700\">\n      <div className=\"mb-3 sm:mb-0\">\n       <p className=\"font-semibold text-sm sm:text-base text-slate-900 dark:text-white\">Enable Auto-Savings</p>\n       <p className=\"text-xs sm:text-sm text-slate-600 dark:text-slate-400\">Automatically save toward your goals</p>\n      </div>\n      <Switch \n       data-testid=\"switch-auto-savings\"\n       checked={preferences.autoSavingsEnabled}\n       onCheckedChange={handleAutoSavingsToggle}\n       disabled={updatePreferencesMutation.isPending}\n       className=\"scale-110\"\n      />\n     </div>\n\n     {preferences.autoSavingsEnabled && (\n      <div className=\"space-y-4-50 border-l-4 border-blue-500 pl-4 ml-2\">\n       <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n        <div className=\"space-y-2\">\n         <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Auto-Savings Amount</label>\n         <Input\n          data-testid=\"input-auto-savings-amount\"\n          type=\"number\"\n          min=\"0\"\n          step=\"0.01\"\n          value={preferences.autoSavingsAmount}\n          onChange={(e) => handleAutoSavingsAmountChange(e.target.value)}\n          disabled={updatePreferencesMutation.isPending}\n          placeholder=\"0.00\"\n          className=\"h-12 sm:h-14 text-base w-full bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\"\n         />\n        </div>\n\n        <div className=\"space-y-2\">\n         <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Frequency</label>\n         <Select \n          value={preferences.autoSavingsFrequency} \n          onValueChange={handleSavingsFrequencyChange}\n          disabled={updatePreferencesMutation.isPending}\n         >\n          <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-savings-frequency\">\n           <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n           {savingsFrequencies.map((freq) => (\n            <SelectItem key={freq.value} value={freq.value}>\n             {freq.label}\n            </SelectItem>\n           ))}\n          </SelectContent>\n         </Select>\n        </div>\n       </div>\n      </div>\n     )}\n    </CardContent>\n   </Card>\n\n   {/* Goal Defaults */}\n   <Card className=\"border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-md transition-shadow\">\n    <CardHeader className=\"p-4 sm:p-6\">\n     <CardTitle className=\"flex items-center gap-2 text-lg sm:text-xl\">\n      <TrendingUp className=\"w-5 h-5 sm:w-6 sm:h-6 text-blue-600\" />\n      Goal Defaults\n     </CardTitle>\n     <CardDescription className=\"text-sm sm:text-base mt-1\">\n      Set default priority level for new financial goals\n     </CardDescription>\n    </CardHeader>\n    <CardContent className=\"p-4 sm:p-6 space-y-4\">\n     <div className=\"space-y-2\">\n      <label className=\"text-sm sm:text-base font-medium text-slate-700 dark:text-slate-300 block\">Default Goal Priority</label>\n      <Select \n       value={preferences.defaultGoalPriority} \n       onValueChange={handleGoalPriorityChange}\n       disabled={updatePreferencesMutation.isPending}\n      >\n       <SelectTrigger className=\"h-12 sm:h-14 text-base bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-700\" data-testid=\"select-goal-priority\">\n        <SelectValue />\n       </SelectTrigger>\n       <SelectContent>\n        {goalPriorities.map((priority) => (\n         <SelectItem key={priority.value} value={priority.value}>\n          <div className=\"flex items-center py-1\">\n           <Badge className={`${priority.color} font-medium`}>\n            {priority.label}\n           </Badge>\n          </div>\n         </SelectItem>\n        ))}\n       </SelectContent>\n      </Select>\n     </div>\n    </CardContent>\n   </Card>\n  </div>\n );\n}\n","path":null,"size_bytes":12071,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from\"react\"\nimport * as ScrollAreaPrimitive from\"@radix-ui/react-scroll-area\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n <ScrollAreaPrimitive.Root\n  ref={ref}\n  className={cn(\"relative overflow-hidden\", className)}\n  {...props}\n >\n  <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n   {children}\n  </ScrollAreaPrimitive.Viewport>\n  <ScrollBar />\n  <ScrollAreaPrimitive.Corner />\n </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation =\"vertical\", ...props }, ref) => (\n <ScrollAreaPrimitive.ScrollAreaScrollbar\n  ref={ref}\n  orientation={orientation}\n  className={cn(\n  \"flex touch-none select-none transition-colors\",\n   orientation ===\"vertical\" &&\n   \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n   orientation ===\"horizontal\" &&\n   \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n   className\n  )}\n  {...props}\n >\n  <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1574,"size_tokens":null},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  \n  const isProduction = process.env.NODE_ENV === 'production';\n  \n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction,\n      sameSite: 'lax',\n      maxAge: sessionTtl,\n    },\n  });\n}\n\ninterface UserSession {\n  claims?: Record<string, any>;\n  access_token?: string;\n  refresh_token?: string;\n  expires_at?: number;\n}\n\nfunction updateUserSession(\n  user: UserSession,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: Record<string, any>,\n) {\n  const userId = claims[\"sub\"];\n  \n  // Create or update user - get the actual user record to ensure we have the correct ID\n  const user = await storage.upsertUser({\n    id: userId,\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n  \n  // Ensure user has a subscription (initialize Free tier if new)\n  // Use the returned user.id in case it differs from claims.sub\n  const subscription = await storage.getUserSubscription(user.id);\n  if (!subscription) {\n    await storage.initializeDefaultSubscription(user.id);\n  }\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    try {\n      const user: UserSession = {};\n      updateUserSession(user, tokens);\n      const claims = tokens.claims();\n      if (claims) {\n        await upsertUser(claims);\n      }\n      verified(null, user);\n    } catch (error) {\n      console.error(\"Auth verification error:\", error);\n      verified(error as Error, false);\n    }\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    req.session.save((err) => {\n      if (err) {\n        console.error(\"Session save error before OAuth:\", err);\n      }\n      passport.authenticate(`replitauth:${req.hostname}`, {\n        prompt: \"login consent\",\n        scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n      })(req, res, next);\n    });\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    }, (err: any, user: any, info: any) => {\n      if (err) {\n        console.error(\"Auth callback error:\", err);\n        return res.redirect(\"/api/login\");\n      }\n      if (!user) {\n        console.error(\"Auth callback failed - no user:\", info);\n        return res.redirect(\"/api/login\");\n      }\n      \n      req.logIn(user, (loginErr: any) => {\n        if (loginErr) {\n          console.error(\"Login error:\", loginErr);\n          return res.redirect(\"/api/login\");\n        }\n        \n        // Explicitly save session before redirecting to ensure cookie is set in all browser contexts\n        req.session.save((saveErr: any) => {\n          if (saveErr) {\n            console.error(\"Session save error:\", saveErr);\n            return res.redirect(\"/api/login\");\n          }\n          return res.redirect(\"/\");\n        });\n      });\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n\nexport function getUserIdFromRequest(req: any): string {\n  if (!req.user || !req.user.claims || !req.user.claims.sub) {\n    throw new Error(\"User not authenticated\");\n  }\n  return req.user.claims.sub;\n}","path":null,"size_bytes":6282,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from\"react\"\nimport { Slot } from\"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n HTMLElement,\n React.ComponentPropsWithoutRef<\"nav\"> & {\n  separator?: React.ReactNode\n }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName =\"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n HTMLOListElement,\n React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n <ol\n  ref={ref}\n  className={cn(\n  \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n   className\n  )}\n  {...props}\n />\n))\nBreadcrumbList.displayName =\"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n HTMLLIElement,\n React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n <li\n  ref={ref}\n  className={cn(\"inline-flex items-center gap-1.5\", className)}\n  {...props}\n />\n))\nBreadcrumbItem.displayName =\"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n HTMLAnchorElement,\n React.ComponentPropsWithoutRef<\"a\"> & {\n  asChild?: boolean\n }\n>(({ asChild, className, ...props }, ref) => {\n const Comp = asChild ? Slot :\"a\"\n\n return (\n  <Comp\n   ref={ref}\n   className={cn(\"transition-colors hover:text-foreground\", className)}\n   {...props}\n  />\n )\n})\nBreadcrumbLink.displayName =\"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n HTMLSpanElement,\n React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n <span\n  ref={ref}\n  role=\"link\"\n  aria-disabled=\"true\"\n  aria-current=\"page\"\n  className={cn(\"font-normal text-foreground\", className)}\n  {...props}\n />\n))\nBreadcrumbPage.displayName =\"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n children,\n className,\n ...props\n}: React.ComponentProps<\"li\">) => (\n <li\n  role=\"presentation\"\n  aria-hidden=\"true\"\n  className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n  {...props}\n >\n  {children ?? <ChevronRight />}\n </li>\n)\nBreadcrumbSeparator.displayName =\"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n className,\n ...props\n}: React.ComponentProps<\"span\">) => (\n <span\n  role=\"presentation\"\n  aria-hidden=\"true\"\n  className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n  {...props}\n >\n  <MoreHorizontal className=\"h-4 w-4\" />\n  <span className=\"sr-only\">More</span>\n </span>\n)\nBreadcrumbEllipsis.displayName =\"BreadcrumbElipssis\"\n\nexport {\n Breadcrumb,\n BreadcrumbList,\n BreadcrumbItem,\n BreadcrumbLink,\n BreadcrumbPage,\n BreadcrumbSeparator,\n BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2589,"size_tokens":null},"client/src/pages/ai-assistant.tsx":{"content":"import { useState, useEffect, useRef, type ReactNode } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useTranslation } from 'react-i18next';\nimport { useLocation } from 'wouter';\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  Send,\n  Brain,\n  Zap,\n  BarChart3,\n  Crown,\n  Sparkles,\n  TrendingUp,\n  PiggyBank,\n  Target,\n  DollarSign,\n  Shield,\n  Gem,\n  ArrowRight,\n  ChevronRight,\n  Mic,\n  MicOff,\n  Bookmark,\n  BookmarkCheck,\n  Search,\n  Download,\n  X\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ToastAction } from \"@/components/ui/toast\";\nimport { apiRequest, queryClient, RateLimitError } from \"@/lib/queryClient\";\nimport { ConversationSidebar } from \"@/components/chat/conversation-sidebar\";\nimport { MessageBubble, TypingIndicator } from \"@/components/chat/message-bubble\";\nimport { ProactiveInsightsPanel } from \"@/components/chat/proactive-insights-panel\";\nimport { WeeklySummaryCard } from \"@/components/weekly-summary-card\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface UsageInfo {\n  scoutUsage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n  sonnetUsage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n  gpt5Usage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n  opusUsage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n  chatUsage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n  analysisUsage: {\n    used: number;\n    limit: number;\n    remaining: number;\n    allowed: boolean;\n  };\n}\n\ninterface ChatMessage {\n  id: string;\n  conversationId: string;\n  role: 'user' | 'assistant';\n  content: string;\n  createdAt: string;\n}\n\ninterface ChatConversation {\n  id: string;\n  userId: string;\n  title: string;\n  isActive: boolean;\n  lastMessageAt: string;\n  createdAt: string;\n  messages?: ChatMessage[];\n}\n\ninterface StarterPrompt {\n  icon: ReactNode;\n  title: string;\n  prompt: string;\n  gradient: string;\n}\n\nfunction AnimatedNumber({ value, className }: { value: number; className?: string }) {\n  const [displayValue, setDisplayValue] = useState(0);\n  \n  useEffect(() => {\n    const duration = 800;\n    const steps = 30;\n    const increment = value / steps;\n    let current = 0;\n    const timer = setInterval(() => {\n      current += increment;\n      if (current >= value) {\n        setDisplayValue(value);\n        clearInterval(timer);\n      } else {\n        setDisplayValue(Math.floor(current));\n      }\n    }, duration / steps);\n    return () => clearInterval(timer);\n  }, [value]);\n\n  return <span className={className}>{displayValue}</span>;\n}\n\nfunction CircularProgress({ value, max, size = 44, strokeWidth = 3, color = \"blue\" }: { \n  value: number; \n  max: number; \n  size?: number; \n  strokeWidth?: number;\n  color?: string;\n}) {\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const clampedValue = Math.max(0, Math.min(value, max));\n  const percentage = max > 0 ? Math.min((clampedValue / max) * 100, 100) : 0;\n  const offset = circumference - (percentage / 100) * circumference;\n  \n  const colorMap: Record<string, string> = {\n    blue: \"stroke-blue-500\",\n    emerald: \"stroke-emerald-500\",\n    amber: \"stroke-amber-500\"\n  };\n\n  return (\n    <div className=\"relative\" style={{ width: size, height: size }}>\n      <svg width={size} height={size} className=\"transform -rotate-90\">\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={strokeWidth}\n          className=\"text-gray-200 dark:text-gray-800\"\n        />\n        <motion.circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          className={colorMap[color] || colorMap.blue}\n          initial={{ strokeDashoffset: circumference }}\n          animate={{ strokeDashoffset: offset }}\n          transition={{ duration: 1, ease: \"easeOut\" }}\n          style={{ strokeDasharray: circumference }}\n        />\n      </svg>\n    </div>\n  );\n}\n\nfunction QuotaCard({ \n  name, \n  badge, \n  used, \n  limit, \n  color,\n  locked = false,\n  lockText = \"Pro tier\"\n}: { \n  name: string; \n  badge: string; \n  used: number; \n  limit: number; \n  color: string;\n  locked?: boolean;\n  lockText?: string;\n}) {\n  const isUnlimited = limit === 999999;\n  const remaining = Math.max(0, limit - used);\n  \n  const colorMap: Record<string, { bg: string; text: string; badge: string; border: string }> = {\n    blue: { \n      bg: \"bg-blue-50 dark:bg-blue-950/30\", \n      text: \"text-blue-600 dark:text-blue-400\",\n      badge: \"bg-blue-600 text-white\",\n      border: \"border-blue-200/50 dark:border-blue-800/50\"\n    },\n    emerald: { \n      bg: \"bg-emerald-50 dark:bg-emerald-950/30\", \n      text: \"text-emerald-600 dark:text-emerald-400\",\n      badge: \"bg-emerald-600 text-white\",\n      border: \"border-emerald-200/50 dark:border-emerald-800/50\"\n    },\n    amber: { \n      bg: \"bg-amber-50 dark:bg-amber-950/30\", \n      text: \"text-amber-600 dark:text-amber-400\",\n      badge: \"bg-amber-600 text-white\",\n      border: \"border-amber-200/50 dark:border-amber-800/50\"\n    }\n  };\n  \n  const colors = colorMap[color] || colorMap.blue;\n\n  if (locked) {\n    return (\n      <motion.div \n        className=\"flex flex-col sm:flex-row items-center sm:justify-between p-3 sm:p-4 rounded-lg sm:rounded-xl border-2 border-dashed border-border/40 bg-muted/5 gap-2\"\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.3 }}\n      >\n        <div className=\"flex items-center gap-2 sm:gap-3\">\n          <div className=\"w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-muted/30 flex items-center justify-center\">\n            <Crown className=\"w-3.5 h-3.5 sm:w-4 sm:h-4 text-muted-foreground/50\" />\n          </div>\n          <div className=\"text-center sm:text-left\">\n            <p className=\"text-xs sm:text-sm font-medium text-muted-foreground\">{name}</p>\n            <p className=\"text-[10px] sm:text-xs text-muted-foreground/60\">{lockText}</p>\n          </div>\n        </div>\n      </motion.div>\n    );\n  }\n\n  return (\n    <motion.div \n      className={`relative p-3 sm:p-4 rounded-lg sm:rounded-xl border ${colors.border} ${colors.bg} overflow-hidden`}\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.3 }}\n      whileHover={{ scale: 1.02 }}\n    >\n      <div className=\"flex flex-col sm:flex-row items-center sm:justify-between gap-2\">\n        <div className=\"flex items-center gap-2 sm:gap-3\">\n          <CircularProgress \n            value={isUnlimited ? 100 : remaining} \n            max={isUnlimited ? 100 : limit} \n            color={color}\n            size={36}\n            strokeWidth={3}\n          />\n          <div className=\"text-center sm:text-left\">\n            <p className=\"text-xs sm:text-sm font-semibold\">{name}</p>\n            <Badge className={`${colors.badge} text-[8px] sm:text-[10px] px-1 sm:px-1.5 py-0 font-medium`}>{badge}</Badge>\n          </div>\n        </div>\n        <div className=\"text-center sm:text-right\">\n          <p className={`text-lg sm:text-xl font-bold ${colors.text}`}>\n            {isUnlimited ? (\n              <span className=\"text-xl sm:text-2xl\">∞</span>\n            ) : (\n              <AnimatedNumber value={remaining} />\n            )}\n          </p>\n          <p className=\"text-[8px] sm:text-[10px] text-muted-foreground font-medium uppercase tracking-wide\">\n            {isUnlimited ? 'unlimited' : 'remaining'}\n          </p>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\nexport default function AIAssistantPage() {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [currentMessage, setCurrentMessage] = useState(\"\");\n  const [currentConversationId, setCurrentConversationId] = useState<string | null>(null);\n  const [analysisMode, setAnalysisMode] = useState<'quick' | 'deep'>('quick');\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [rateLimitRetryAfter, setRateLimitRetryAfter] = useState<number>(0);\n  const [inputFocused, setInputFocused] = useState(false);\n  const [isStreaming, setIsStreaming] = useState(false);\n  const [streamingContent, setStreamingContent] = useState(\"\");\n  const [useStreaming, setUseStreaming] = useState(true);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  useEffect(() => {\n    if (rateLimitRetryAfter > 0) {\n      const timer = setInterval(() => {\n        setRateLimitRetryAfter(prev => Math.max(0, prev - 1));\n      }, 1000);\n      return () => clearInterval(timer);\n    }\n  }, [rateLimitRetryAfter]);\n\n  const { data: usage } = useQuery<UsageInfo>({\n    queryKey: [\"/api/subscription/usage\"],\n    refetchInterval: 5 * 60 * 1000,\n  });\n\n  const { data: currentConversation, isLoading: messagesLoading } = useQuery<ChatConversation>({\n    queryKey: [\"/api/chat/conversations\", currentConversationId],\n    enabled: !!currentConversationId,\n    refetchInterval: 30000,\n  });\n\n  useEffect(() => {\n    if (currentConversation?.messages) {\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n    }\n  }, [currentConversation?.messages]);\n\n  useEffect(() => {\n    if (textareaRef.current) {\n      textareaRef.current.style.height = 'auto';\n      textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 200) + 'px';\n    }\n  }, [currentMessage]);\n\n  useEffect(() => {\n    const textarea = textareaRef.current;\n    if (!textarea) return;\n\n    const handleFocus = () => {\n      setTimeout(() => {\n        textarea.scrollIntoView({ \n          behavior: 'smooth', \n          block: 'center' \n        });\n      }, 300);\n    };\n\n    textarea.addEventListener('focus', handleFocus);\n    return () => textarea.removeEventListener('focus', handleFocus);\n  }, []);\n\n  const getCurrentTier = () => {\n    if (!usage) return 'free';\n    if (usage.opusUsage && usage.opusUsage.limit > 0) return 'enterprise';\n    if (usage.sonnetUsage && usage.sonnetUsage.limit > 0) return 'pro';\n    return 'free';\n  };\n\n  const getUpgradeMessage = (exceededModel?: string) => {\n    const tier = getCurrentTier();\n    \n    if (exceededModel === 'opus') {\n      return {\n        title: \"Opus Quota Exceeded\",\n        description: \"You've used all your Enterprise Opus queries. Your queries will fall back to Sonnet until quota resets.\",\n        benefits: \"Opus provides the most advanced analysis for complex financial decisions.\"\n      };\n    }\n    \n    if (exceededModel === 'gpt5') {\n      if (tier === 'enterprise') {\n        return {\n          title: \"GPT-5 Quota Exceeded\",\n          description: \"You've used all your GPT-5 math queries. Your queries will use Sonnet for reasoning until quota resets.\",\n          benefits: \"GPT-5 provides advanced mathematical analysis and projections.\"\n        };\n      }\n      return {\n        title: \"Upgrade to Enterprise\",\n        description: \"Get more GPT-5 queries (10/month) plus Opus access for CFO-level analysis.\",\n        benefits: \"Enterprise includes: 10 GPT-5 queries, 20 Opus queries, 60 Sonnet queries, Unlimited Scout\"\n      };\n    }\n    \n    if (exceededModel === 'sonnet') {\n      return {\n        title: \"Upgrade to Enterprise\",\n        description: \"Unlock Opus for CFO-level analysis, more GPT-5 for math, and higher Sonnet limits.\",\n        benefits: \"Enterprise includes: 20 Opus queries, 10 GPT-5 queries, 60 Sonnet queries, Unlimited Scout\"\n      };\n    }\n    \n    if (tier === 'pro') {\n      return {\n        title: \"Upgrade to Enterprise\",\n        description: \"Unlock Opus for CFO-level analysis, more GPT-5 for math, and higher Sonnet limits.\",\n        benefits: \"Enterprise includes: 20 Opus queries, 10 GPT-5 queries, 60 Sonnet queries, Unlimited Scout\"\n      };\n    }\n    \n    return {\n      title: \"Upgrade to Pro\",\n      description: \"Get access to Sonnet for deep reasoning and GPT-5 for math analysis.\",\n      benefits: \"Pro includes: Unlimited Scout, 25 Sonnet queries, 5 GPT-5 queries per month\"\n    };\n  };\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (content: string) => {\n      let conversationId = currentConversationId;\n      \n      if (!conversationId) {\n        const response = await apiRequest(\"POST\", \"/api/chat/conversations\", { \n          title: content.slice(0, 50) + (content.length > 50 ? '...' : '')\n        });\n        const conversation = await response.json();\n        conversationId = conversation.id;\n        setCurrentConversationId(conversationId);\n      }\n      \n      const messageResponse = await apiRequest(\"POST\", `/api/chat/conversations/${conversationId}/messages`, { \n        content,\n        isDeepAnalysis: analysisMode === 'deep'\n      });\n      \n      if (messageResponse.status === 429) {\n        const errorData = await messageResponse.json();\n        const exceededModel = errorData.exceededModel;\n        throw { isQuotaError: true, exceededModel, message: errorData.message };\n      }\n      \n      return await messageResponse.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/subscription/usage\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\", currentConversationId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      setCurrentMessage(\"\");\n    },\n    onError: (error: any) => {\n      if (error instanceof RateLimitError) {\n        setRateLimitRetryAfter(error.retryAfter);\n        toast({\n          title: \"Rate Limit Exceeded\",\n          description: `Too many requests. Please wait ${error.retryAfter} seconds before trying again.`,\n          variant: \"destructive\",\n          duration: error.retryAfter * 1000,\n        });\n      } else if (error.isQuotaError) {\n        const upgradeMsg = getUpgradeMessage(error.exceededModel);\n        const tier = getCurrentTier();\n        const needsUpgrade = tier === 'free' || (tier === 'pro' && error.exceededModel === 'sonnet');\n        \n        toast({\n          title: upgradeMsg.title,\n          description: upgradeMsg.description,\n          variant: \"destructive\",\n          duration: 10000,\n          action: needsUpgrade ? (\n            <ToastAction \n              altText=\"Upgrade\"\n              onClick={() => setLocation('/subscription')}\n            >\n              <Crown className=\"w-4 h-4 mr-2\" />\n              Upgrade\n            </ToastAction>\n          ) : undefined\n        });\n      } else {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Failed to send message\",\n          variant: \"destructive\"\n        });\n      }\n    }\n  });\n\n  const handleSendMessage = () => {\n    if (!currentMessage.trim() || sendMessageMutation.isPending || isStreaming || rateLimitRetryAfter > 0) return;\n    \n    const isLimitExceeded = usage && usage.chatUsage.used >= usage.chatUsage.limit;\n    \n    if (isLimitExceeded) {\n      toast({\n        title: \"Upgrade Required\",\n        description: \"You've reached your AI chat limit. Upgrade to continue.\",\n        variant: \"destructive\",\n        action: (\n          <ToastAction \n            altText=\"Upgrade\"\n            onClick={() => setLocation('/subscription')}\n          >\n            <Crown className=\"w-4 h-4 mr-2\" />\n            Upgrade\n          </ToastAction>\n        )\n      });\n      return;\n    }\n\n    if (useStreaming && analysisMode === 'quick') {\n      sendStreamingMessage(currentMessage);\n    } else {\n      sendMessageMutation.mutate(currentMessage);\n    }\n  };\n  \n  const sendStreamingMessage = async (content: string) => {\n    let conversationId = currentConversationId;\n    \n    try {\n      setIsStreaming(true);\n      setStreamingContent(\"\");\n      setCurrentMessage(\"\");\n      \n      if (!conversationId) {\n        const response = await apiRequest(\"POST\", \"/api/chat/conversations\", { \n          title: content.slice(0, 50) + (content.length > 50 ? '...' : '')\n        });\n        const conversation = await response.json();\n        conversationId = conversation.id;\n        setCurrentConversationId(conversationId);\n      }\n      \n      abortControllerRef.current = new AbortController();\n      \n      const response = await fetch(`/api/chat/conversations/${conversationId}/messages/stream`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ content }),\n        credentials: 'include',\n        signal: abortControllerRef.current.signal\n      });\n      \n      if (!response.ok) {\n        throw new Error('Streaming failed');\n      }\n      \n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      \n      if (!reader) {\n        throw new Error('No response body');\n      }\n      \n      let buffer = '';\n      \n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n        \n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split('\\n');\n        buffer = lines.pop() || '';\n        \n        for (const line of lines) {\n          if (line.startsWith('event: ')) {\n            continue;\n          }\n          if (line.startsWith('data: ')) {\n            try {\n              const data = JSON.parse(line.slice(6));\n              if (data.content) {\n                setStreamingContent(prev => prev + data.content);\n              }\n            } catch {\n            }\n          }\n        }\n      }\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/subscription/usage\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\", conversationId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n      \n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Streaming failed\",\n          variant: \"destructive\"\n        });\n      }\n    } finally {\n      setIsStreaming(false);\n      setStreamingContent(\"\");\n      abortControllerRef.current = null;\n    }\n  };\n\n  const handleNewChat = () => {\n    setCurrentConversationId(null);\n    setCurrentMessage(\"\");\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  // Voice input state\n  const [isListening, setIsListening] = useState(false);\n  const [speechSupported, setSpeechSupported] = useState(false);\n  const recognitionRef = useRef<any>(null);\n\n  // Check for speech recognition support\n  useEffect(() => {\n    const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n    setSpeechSupported(!!SpeechRecognition);\n    \n    // Cleanup on unmount\n    return () => {\n      if (recognitionRef.current) {\n        recognitionRef.current.abort();\n        recognitionRef.current = null;\n      }\n    };\n  }, []);\n\n  const handleVoiceInput = () => {\n    const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;\n    if (!SpeechRecognition) {\n      toast({\n        title: \"Not Supported\",\n        description: \"Voice input is not supported in your browser\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Stop if already listening\n    if (isListening && recognitionRef.current) {\n      recognitionRef.current.stop();\n      recognitionRef.current = null;\n      setIsListening(false);\n      return;\n    }\n\n    // Create new recognition instance\n    const recognition = new SpeechRecognition();\n    recognition.continuous = false;\n    recognition.interimResults = false;\n    recognition.lang = 'en-US';\n\n    recognition.onstart = () => setIsListening(true);\n    recognition.onend = () => {\n      setIsListening(false);\n      recognitionRef.current = null;\n    };\n    recognition.onerror = () => {\n      setIsListening(false);\n      recognitionRef.current = null;\n    };\n\n    recognition.onresult = (event: any) => {\n      const transcript = event.results[0][0].transcript;\n      setCurrentMessage(prev => prev + (prev ? ' ' : '') + transcript);\n    };\n\n    recognitionRef.current = recognition;\n    recognition.start();\n  };\n\n  // Export conversation as text/markdown\n  const handleExportConversation = () => {\n    const exportMessages = currentConversation?.messages || [];\n    if (!currentConversation || exportMessages.length === 0) {\n      toast({\n        title: \"Nothing to export\",\n        description: \"Start a conversation first\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const title = currentConversation.title || 'AI Conversation';\n    const date = new Date().toLocaleDateString('en-US', { \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    });\n\n    let content = `# ${title}\\n`;\n    content += `**Exported:** ${date}\\n\\n---\\n\\n`;\n\n    exportMessages.forEach((msg) => {\n      const time = new Date(msg.createdAt).toLocaleTimeString([], { \n        hour: '2-digit', \n        minute: '2-digit' \n      });\n      if (msg.role === 'user') {\n        content += `### You (${time})\\n${msg.content}\\n\\n`;\n      } else {\n        content += `### Twealth AI (${time})\\n${msg.content}\\n\\n`;\n      }\n    });\n\n    const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.md`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n\n    toast({\n      title: \"Exported\",\n      description: \"Conversation downloaded as markdown file\"\n    });\n  };\n\n  // Quick action chips\n  const quickActions = [\n    { label: \"Budget\", prompt: \"Show me my spending by category this month\" },\n    { label: \"Goals\", prompt: \"How are my financial goals progressing?\" },\n    { label: \"Spending\", prompt: \"Any unusual spending patterns I should know about?\" },\n    { label: \"Save\", prompt: \"How can I save more money this month?\" },\n  ];\n\n  // Saved prompts functionality\n  const [savedPrompts, setSavedPrompts] = useState<string[]>(() => {\n    const saved = localStorage.getItem('twealth_saved_prompts');\n    return saved ? JSON.parse(saved) : [];\n  });\n  const [showSavedPrompts, setShowSavedPrompts] = useState(false);\n\n  const toggleSavePrompt = (prompt: string) => {\n    const newSaved = savedPrompts.includes(prompt)\n      ? savedPrompts.filter(p => p !== prompt)\n      : [...savedPrompts, prompt].slice(-10); // Keep max 10\n    setSavedPrompts(newSaved);\n    localStorage.setItem('twealth_saved_prompts', JSON.stringify(newSaved));\n    toast({\n      title: savedPrompts.includes(prompt) ? \"Removed\" : \"Saved\",\n      description: savedPrompts.includes(prompt) ? \"Prompt removed from favorites\" : \"Prompt saved to favorites\"\n    });\n  };\n\n  // Search state\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showSearch, setShowSearch] = useState(false);\n\n  const starterPrompts: StarterPrompt[] = [\n    {\n      icon: <Target className=\"w-5 h-5\" />,\n      title: \"Buy a Car\",\n      prompt: \"I want to buy a $35,000 car in 2 years. Can you help me create a savings plan?\",\n      gradient: \"from-blue-500/10 to-blue-600/5\"\n    },\n    {\n      icon: <PiggyBank className=\"w-5 h-5\" />,\n      title: \"Emergency Fund\",\n      prompt: \"How much should I have in my emergency fund? What's realistic for my situation?\",\n      gradient: \"from-emerald-500/10 to-emerald-600/5\"\n    },\n    {\n      icon: <TrendingUp className=\"w-5 h-5\" />,\n      title: \"Investment Strategy\",\n      prompt: \"I have $10,000 to invest. What's the best allocation for someone my age?\",\n      gradient: \"from-violet-500/10 to-violet-600/5\"\n    },\n    {\n      icon: <BarChart3 className=\"w-5 h-5\" />,\n      title: \"Retirement Planning\",\n      prompt: \"Help me calculate how much I need to save monthly to retire comfortably at 65\",\n      gradient: \"from-amber-500/10 to-amber-600/5\"\n    },\n    {\n      icon: <DollarSign className=\"w-5 h-5\" />,\n      title: \"Reduce Debt\",\n      prompt: \"I have $20,000 in credit card debt. What's the fastest way to pay it off?\",\n      gradient: \"from-rose-500/10 to-rose-600/5\"\n    },\n    {\n      icon: <Sparkles className=\"w-5 h-5\" />,\n      title: \"Full Financial Checkup\",\n      prompt: \"Give me a comprehensive analysis of my financial health with specific recommendations\",\n      gradient: \"from-cyan-500/10 to-cyan-600/5\"\n    }\n  ];\n\n  const messages = currentConversation?.messages || [];\n  const hasMessages = messages.length > 0;\n\n  const filteredMessages = searchQuery.trim()\n    ? messages.filter(m => m.content.toLowerCase().includes(searchQuery.toLowerCase()))\n    : messages;\n\n  const tier = getCurrentTier();\n  const scoutUsed = usage?.scoutUsage?.used || 0;\n  const scoutLimit = usage?.scoutUsage?.limit || 0;\n  const sonnetUsed = usage?.sonnetUsage?.used || 0;\n  const sonnetLimit = usage?.sonnetUsage?.limit || 0;\n  const gpt5Used = usage?.gpt5Usage?.used || 0;\n  const gpt5Limit = usage?.gpt5Usage?.limit || 0;\n  const opusUsed = usage?.opusUsage?.used || 0;\n  const opusLimit = usage?.opusUsage?.limit || 0;\n\n  return (\n    <div className=\"flex h-screen-mobile md:h-screen bg-gradient-to-b from-gray-50/50 to-white dark:from-zinc-950 dark:to-black\" style={{ height: 'var(--app-height, 100dvh)' }}>\n      <ConversationSidebar\n        currentConversationId={currentConversationId}\n        onSelectConversation={setCurrentConversationId}\n        onNewChat={handleNewChat}\n        isOpen={sidebarOpen}\n        onToggle={() => setSidebarOpen(!sidebarOpen)}\n      />\n\n      <div className=\"flex-1 flex flex-col h-full overflow-hidden\">\n        <header className=\"shrink-0 border-b border-border/40 bg-white/80 dark:bg-black/80 backdrop-blur-xl\">\n          <div className=\"flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4\" style={{ paddingTop: 'max(0.75rem, env(safe-area-inset-top))' }}>\n            <div className=\"flex items-center gap-3 sm:gap-4 min-w-0 flex-1\">\n              <motion.div \n                className=\"flex items-center gap-2.5 min-w-0\"\n                initial={{ opacity: 0, x: -10 }}\n                animate={{ opacity: 1, x: 0 }}\n              >\n                <div className=\"w-9 h-9 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg shadow-blue-500/20\">\n                  <Brain className=\"w-5 h-5 text-white\" />\n                </div>\n                <div>\n                  <h1 className=\"text-base sm:text-lg font-bold\">Twealth AI</h1>\n                  <p className=\"text-[10px] text-muted-foreground font-medium hidden sm:block\">Your Personal CFO</p>\n                </div>\n              </motion.div>\n              \n              <Select value={analysisMode} onValueChange={(v: 'quick' | 'deep') => setAnalysisMode(v)}>\n                <SelectTrigger className=\"w-[120px] sm:w-[150px] h-9 text-xs sm:text-sm bg-muted/30 border-border/50\" data-testid=\"select-analysis-mode\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"quick\">\n                    <div className=\"flex items-center gap-2\">\n                      <Zap className=\"w-4 h-4 text-blue-500\" />\n                      <span className=\"text-sm font-medium\">Quick Chat</span>\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"deep\">\n                    <div className=\"flex items-center gap-2\">\n                      <BarChart3 className=\"w-4 h-4 text-amber-500\" />\n                      <span className=\"text-sm font-medium\">Deep Analysis</span>\n                    </div>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex items-center gap-2 shrink-0\">\n              {hasMessages && (\n                <>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => setShowSearch(!showSearch)}\n                    className=\"h-9 w-9\"\n                    data-testid=\"button-search-messages\"\n                  >\n                    <Search className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={handleExportConversation}\n                    className=\"h-9 w-9\"\n                    data-testid=\"button-export-conversation\"\n                    title=\"Export conversation\"\n                  >\n                    <Download className=\"w-4 h-4\" />\n                  </Button>\n                </>\n              )}\n              \n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setShowSavedPrompts(!showSavedPrompts)}\n                className=\"h-9 w-9\"\n                data-testid=\"button-saved-prompts\"\n              >\n                <Bookmark className=\"w-4 h-4\" />\n              </Button>\n\n              {usage && (\n                <motion.div \n                  initial={{ opacity: 0, x: 10 }}\n                  animate={{ opacity: 1, x: 0 }}\n                >\n                  <Badge \n                    className={`\n                      text-xs font-semibold px-3 py-1 rounded-full shadow-sm\n                      ${tier === 'enterprise' ? 'bg-gradient-to-r from-amber-500 to-yellow-500 text-white border-0' : ''}\n                      ${tier === 'pro' ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white border-0' : ''}\n                      ${tier === 'free' ? 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-border/50' : ''}\n                    `}\n                    data-testid=\"badge-tier\"\n                  >\n                    {tier === 'enterprise' && <Gem className=\"w-3 h-3 mr-1.5\" />}\n                    {tier === 'pro' && <Crown className=\"w-3 h-3 mr-1.5\" />}\n                    {tier === 'free' && <Shield className=\"w-3 h-3 mr-1.5\" />}\n                    {tier.charAt(0).toUpperCase() + tier.slice(1)}\n                  </Badge>\n                </motion.div>\n              )}\n            </div>\n          </div>\n\n          {/* Search bar */}\n          <AnimatePresence>\n            {showSearch && (\n              <motion.div\n                initial={{ height: 0, opacity: 0 }}\n                animate={{ height: 'auto', opacity: 1 }}\n                exit={{ height: 0, opacity: 0 }}\n                className=\"border-t border-border/40 overflow-hidden\"\n              >\n                <div className=\"px-4 sm:px-6 py-2 flex items-center gap-2\">\n                  <Search className=\"w-4 h-4 text-muted-foreground shrink-0\" />\n                  <input\n                    type=\"text\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    placeholder=\"Search messages...\"\n                    className=\"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/60\"\n                    data-testid=\"input-search-messages\"\n                    autoFocus\n                  />\n                  {searchQuery && (\n                    <span className=\"text-xs text-muted-foreground\">\n                      {filteredMessages.length} found\n                    </span>\n                  )}\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => { setShowSearch(false); setSearchQuery(\"\"); }}\n                    className=\"h-7 w-7\"\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          {/* Saved prompts dropdown */}\n          <AnimatePresence>\n            {showSavedPrompts && savedPrompts.length > 0 && (\n              <motion.div\n                initial={{ height: 0, opacity: 0 }}\n                animate={{ height: 'auto', opacity: 1 }}\n                exit={{ height: 0, opacity: 0 }}\n                className=\"border-t border-border/40 overflow-hidden\"\n              >\n                <div className=\"px-4 sm:px-6 py-3 space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-xs font-medium text-muted-foreground\">Saved Prompts</span>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => setShowSavedPrompts(false)}\n                      className=\"h-6 w-6\"\n                    >\n                      <X className=\"w-3 h-3\" />\n                    </Button>\n                  </div>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {savedPrompts.map((prompt, idx) => (\n                      <button\n                        key={idx}\n                        onClick={() => {\n                          setCurrentMessage(prompt);\n                          setShowSavedPrompts(false);\n                        }}\n                        className=\"group flex items-center gap-1.5 px-3 py-1.5 text-xs bg-blue-50 dark:bg-blue-950/50 text-blue-700 dark:text-blue-300 rounded-full hover:bg-blue-100 dark:hover:bg-blue-950 transition-colors\"\n                        data-testid={`saved-prompt-${idx}`}\n                      >\n                        <BookmarkCheck className=\"w-3 h-3\" />\n                        <span className=\"max-w-[150px] truncate\">{prompt}</span>\n                        <button\n                          onClick={(e) => { e.stopPropagation(); toggleSavePrompt(prompt); }}\n                          className=\"opacity-0 group-hover:opacity-100 ml-1\"\n                        >\n                          <X className=\"w-3 h-3\" />\n                        </button>\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </header>\n\n        <div className=\"flex-1 overflow-y-auto px-4 sm:px-6\">\n          <div className=\"max-w-3xl mx-auto py-6 sm:py-8 space-y-6\">\n            \n            {usage && !hasMessages && (\n              <motion.div \n                className=\"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ duration: 0.4, delay: 0.1 }}\n                data-testid=\"quota-display\"\n              >\n                <QuotaCard\n                  name=\"Scout\"\n                  badge=\"Fast\"\n                  used={scoutUsed}\n                  limit={scoutLimit}\n                  color=\"blue\"\n                />\n                <QuotaCard\n                  name=\"Sonnet\"\n                  badge=\"Smart\"\n                  used={sonnetUsed}\n                  limit={sonnetLimit}\n                  color=\"blue\"\n                  locked={sonnetLimit === 0}\n                  lockText=\"Pro tier\"\n                />\n                <QuotaCard\n                  name=\"GPT-5\"\n                  badge=\"Math\"\n                  used={gpt5Used}\n                  limit={gpt5Limit}\n                  color=\"emerald\"\n                  locked={gpt5Limit === 0}\n                  lockText=\"Pro tier\"\n                />\n                <QuotaCard\n                  name=\"Opus\"\n                  badge=\"CFO\"\n                  used={opusUsed}\n                  limit={opusLimit}\n                  color=\"amber\"\n                  locked={opusLimit === 0}\n                  lockText=\"Enterprise\"\n                />\n              </motion.div>\n            )}\n\n            {!hasMessages ? (\n              <motion.div \n                className=\"flex flex-col items-center justify-center min-h-[45vh] text-center px-4\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ duration: 0.5, delay: 0.2 }}\n              >\n                <motion.div \n                  className=\"relative mb-8\"\n                  initial={{ scale: 0.8, opacity: 0 }}\n                  animate={{ scale: 1, opacity: 1 }}\n                  transition={{ duration: 0.5, delay: 0.3 }}\n                >\n                  <div className=\"absolute inset-0 bg-gradient-to-br from-blue-500/20 to-blue-600/10 rounded-3xl blur-2xl\" />\n                  <div className=\"relative w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-500/30\">\n                    <Brain className=\"w-10 h-10 text-white\" />\n                  </div>\n                </motion.div>\n                \n                <motion.h2 \n                  className=\"text-3xl sm:text-4xl font-bold mb-3 bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-400 bg-clip-text text-transparent\"\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.4 }}\n                >\n                  Your Personal CFO\n                </motion.h2>\n                <motion.p \n                  className=\"text-muted-foreground text-base sm:text-lg mb-2 max-w-md font-medium\"\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.5 }}\n                >\n                  Expert financial advice powered by AI\n                </motion.p>\n                <motion.p \n                  className=\"text-sm text-muted-foreground/70 mb-10 max-w-lg\"\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.6 }}\n                >\n                  Ask me anything about budgeting, investing, debt payoff, retirement, or financial planning\n                </motion.p>\n\n                <motion.div \n                  className=\"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 w-full max-w-4xl\"\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.7 }}\n                >\n                  {starterPrompts.map((prompt, index) => (\n                    <motion.button\n                      key={index}\n                      onClick={() => setCurrentMessage(prompt.prompt)}\n                      className={`group relative flex flex-col sm:flex-row items-start gap-2 sm:gap-3 p-3 sm:p-4 text-left rounded-lg sm:rounded-xl border border-border/50 bg-gradient-to-br ${prompt.gradient} hover:border-blue-500/30 hover:shadow-lg hover:shadow-blue-500/5 transition-all duration-300 touch-target min-h-[80px] sm:min-h-0`}\n                      data-testid={`starter-prompt-${index}`}\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.8 + index * 0.05 }}\n                      whileHover={{ y: -2 }}\n                      whileTap={{ scale: 0.98 }}\n                    >\n                      <div className=\"w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-zinc-900 shadow-sm flex items-center justify-center shrink-0 group-hover:shadow-md transition-shadow\">\n                        <span className=\"text-blue-600 dark:text-blue-400 [&>svg]:w-4 [&>svg]:h-4 sm:[&>svg]:w-5 sm:[&>svg]:h-5\">\n                          {prompt.icon}\n                        </span>\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-semibold text-xs sm:text-sm mb-0.5 sm:mb-1 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors\">{prompt.title}</p>\n                        <p className=\"text-[10px] sm:text-xs text-muted-foreground/80 line-clamp-2 leading-relaxed hidden sm:block\">{prompt.prompt}</p>\n                      </div>\n                      <ChevronRight className=\"hidden sm:block w-4 h-4 text-muted-foreground/30 group-hover:text-blue-500 group-hover:translate-x-1 transition-all shrink-0 mt-1\" />\n                    </motion.button>\n                  ))}\n                </motion.div>\n\n                <motion.div\n                  className=\"w-full max-w-4xl mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6\"\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 1.0 }}\n                >\n                  <ProactiveInsightsPanel \n                    maxItems={3}\n                    onAskAbout={(prompt) => {\n                      setCurrentMessage(prompt);\n                      setTimeout(() => sendMessageMutation.mutate(prompt), 100);\n                    }}\n                  />\n                  <WeeklySummaryCard />\n                </motion.div>\n\n                <motion.div\n                  className=\"mt-8 flex items-center gap-2\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  transition={{ delay: 1.2 }}\n                >\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"text-xs text-muted-foreground hover:text-blue-600\"\n                    onClick={() => setLocation('/subscription')}\n                    data-testid=\"button-view-plans\"\n                  >\n                    View Plans\n                    <ArrowRight className=\"w-3 h-3 ml-1\" />\n                  </Button>\n                </motion.div>\n              </motion.div>\n            ) : (\n              <div className=\"space-y-4 sm:space-y-6 pb-4\">\n                <AnimatePresence mode=\"popLayout\">\n                  {(searchQuery ? filteredMessages : messages).map((message, index) => (\n                    <MessageBubble\n                      key={message.id}\n                      role={message.role}\n                      content={message.content}\n                      timestamp={message.createdAt}\n                      isLatest={index === messages.length - 1 && message.role === 'assistant'}\n                      onRegenerate={() => {\n                        const lastUserMessage = messages.filter(m => m.role === 'user').pop();\n                        if (lastUserMessage) {\n                          sendMessageMutation.mutate(lastUserMessage.content);\n                        }\n                      }}\n                      onFollowUp={(prompt) => {\n                        setCurrentMessage(prompt);\n                        setTimeout(() => sendMessageMutation.mutate(prompt), 100);\n                      }}\n                    />\n                  ))}\n                </AnimatePresence>\n                \n                {sendMessageMutation.isPending && <TypingIndicator isDeepAnalysis={analysisMode === 'deep'} />}\n                \n                {isStreaming && streamingContent && (\n                  <MessageBubble\n                    role=\"assistant\"\n                    content={streamingContent}\n                    isStreaming={true}\n                  />\n                )}\n                \n                {isStreaming && !streamingContent && <TypingIndicator isDeepAnalysis={false} />}\n                \n                <div ref={messagesEndRef} />\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* Fixed bottom input area - positioned above mobile nav on small screens */}\n        <div \n          className=\"shrink-0 border-t border-border/40 bg-white/95 dark:bg-black/95 backdrop-blur-xl shadow-[0_-4px_20px_rgba(0,0,0,0.08)]\" \n          style={{ paddingBottom: 'max(0.5rem, env(safe-area-inset-bottom))' }}\n        >\n          {/* Quick action chips - compact on mobile, full on desktop */}\n          <div className=\"max-w-3xl mx-auto px-3 sm:px-6 pt-2 sm:pt-3\">\n            <div className=\"flex items-center gap-1.5 sm:gap-2 overflow-x-auto scrollbar-hide pb-1.5 sm:pb-2 -mx-1 px-1\">\n              {quickActions.map((action, idx) => (\n                <motion.button\n                  key={idx}\n                  onClick={() => {\n                    setCurrentMessage(action.prompt);\n                    sendMessageMutation.mutate(action.prompt);\n                  }}\n                  className=\"shrink-0 px-2.5 sm:px-3.5 py-1.5 sm:py-2 text-[11px] sm:text-xs font-medium bg-blue-50 dark:bg-blue-950/50 text-blue-700 dark:text-blue-300 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors border border-blue-100 dark:border-blue-900/50 min-h-[32px] sm:min-h-[36px] touch-target\"\n                  data-testid={`quick-action-${action.label.toLowerCase()}`}\n                  whileHover={{ scale: 1.02 }}\n                  whileTap={{ scale: 0.98 }}\n                >\n                  {action.label}\n                </motion.button>\n              ))}\n              {currentMessage.trim() && (\n                <motion.button\n                  onClick={() => toggleSavePrompt(currentMessage)}\n                  className={`shrink-0 flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3.5 py-1.5 sm:py-2 text-[11px] sm:text-xs font-medium rounded-full transition-colors min-h-[32px] sm:min-h-[36px] touch-target border ${\n                    savedPrompts.includes(currentMessage)\n                      ? 'bg-amber-100 dark:bg-amber-950/50 text-amber-700 dark:text-amber-300 border-amber-200 dark:border-amber-800/50'\n                      : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 border-gray-200 dark:border-gray-700'\n                  }`}\n                  data-testid=\"button-save-current-prompt\"\n                  whileHover={{ scale: 1.02 }}\n                  whileTap={{ scale: 0.98 }}\n                >\n                  {savedPrompts.includes(currentMessage) ? (\n                    <>\n                      <BookmarkCheck className=\"w-3 h-3\" />\n                      <span className=\"hidden sm:inline\">Saved</span>\n                    </>\n                  ) : (\n                    <>\n                      <Bookmark className=\"w-3 h-3\" />\n                      <span className=\"hidden sm:inline\">Save</span>\n                    </>\n                  )}\n                </motion.button>\n              )}\n            </div>\n          </div>\n\n          {/* Input box */}\n          <div className=\"max-w-3xl mx-auto px-3 sm:px-6 pb-1 sm:pb-3\">\n            <motion.div \n              className={`relative rounded-xl sm:rounded-2xl transition-all duration-300 ${\n                inputFocused \n                  ? 'ring-2 ring-blue-500/30 shadow-lg shadow-blue-500/10' \n                  : 'shadow-md hover:shadow-lg'\n              }`}\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n            >\n              <Textarea\n                ref={textareaRef}\n                value={currentMessage}\n                onChange={(e) => setCurrentMessage(e.target.value)}\n                onKeyDown={handleKeyDown}\n                onFocus={() => setInputFocused(true)}\n                onBlur={() => setInputFocused(false)}\n                placeholder=\"Ask anything about your finances...\"\n                className=\"min-h-[48px] sm:min-h-[56px] max-h-[100px] sm:max-h-[140px] resize-none pr-20 sm:pr-28 text-sm sm:text-base w-full rounded-xl sm:rounded-2xl border-border/50 bg-white dark:bg-zinc-900 py-3 sm:py-4 px-4 sm:px-5 placeholder:text-muted-foreground/60\"\n                rows={1}\n                data-testid=\"input-message\"\n              />\n              \n              {/* Voice and Send buttons */}\n              <div className=\"absolute right-2 sm:right-3 bottom-2 sm:bottom-3 flex items-center gap-1\">\n                {speechSupported && (\n                  <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>\n                    <Button\n                      onClick={handleVoiceInput}\n                      type=\"button\"\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      className={`h-8 w-8 sm:h-9 sm:w-9 rounded-lg transition-all ${\n                        isListening \n                          ? 'bg-red-100 dark:bg-red-950 text-red-600 dark:text-red-400 animate-pulse' \n                          : 'hover:bg-gray-100 dark:hover:bg-gray-800'\n                      }`}\n                      data-testid=\"button-voice-input\"\n                    >\n                      {isListening ? <MicOff className=\"w-4 h-4\" /> : <Mic className=\"w-4 h-4\" />}\n                    </Button>\n                  </motion.div>\n                )}\n                \n                <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>\n                  <Button\n                    onClick={handleSendMessage}\n                    disabled={!currentMessage.trim() || sendMessageMutation.isPending || isStreaming || rateLimitRetryAfter > 0}\n                    size=\"icon\"\n                    className={`h-9 w-9 sm:h-10 sm:w-10 rounded-lg sm:rounded-xl transition-all duration-300 touch-target ${\n                      currentMessage.trim() \n                        ? 'bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/30' \n                        : 'bg-gray-200 dark:bg-gray-800'\n                    }`}\n                    data-testid=\"button-send-message\"\n                    title={rateLimitRetryAfter > 0 ? `Wait ${rateLimitRetryAfter}s` : undefined}\n                  >\n                    {rateLimitRetryAfter > 0 ? (\n                      <span className=\"text-xs font-bold\">{rateLimitRetryAfter}</span>\n                    ) : sendMessageMutation.isPending ? (\n                      <motion.div\n                        className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full\"\n                        animate={{ rotate: 360 }}\n                        transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                      />\n                    ) : (\n                      <Send className={`w-4 h-4 ${currentMessage.trim() ? 'text-white' : 'text-gray-400'}`} />\n                    )}\n                  </Button>\n                </motion.div>\n              </div>\n            </motion.div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":50971,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from\"react\"\nimport { ChevronLeft, ChevronRight } from\"lucide-react\"\nimport { DayPicker } from\"react-day-picker\"\n\nimport { cn } from\"@/lib/utils\"\nimport { buttonVariants } from\"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n className,\n classNames,\n showOutsideDays = true,\n ...props\n}: CalendarProps) {\n return (\n  <DayPicker\n   showOutsideDays={showOutsideDays}\n   className={cn(\"p-3\", className)}\n   classNames={{\n    months:\"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n    month:\"space-y-4\",\n    caption:\"flex justify-center pt-1 relative items-center\",\n    caption_label:\"text-sm font-medium\",\n    nav:\"space-x-1 flex items-center\",\n    nav_button: cn(\n     buttonVariants({ variant:\"outline\" }),\n    \"h-11 w-11 min-w-[44px] min-h-[44px] bg-transparent p-0 opacity-50 hover:opacity-100\"\n    ),\n    nav_button_previous:\"absolute left-1\",\n    nav_button_next:\"absolute right-1\",\n    table:\"w-full border-collapse space-y-1\",\n    head_row:\"flex\",\n    head_cell:\n    \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n    row:\"flex w-full mt-2\",\n    cell:\"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n    day: cn(\n     buttonVariants({ variant:\"ghost\" }),\n    \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n    ),\n    day_range_end:\"day-range-end\",\n    day_selected:\n    \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n    day_today:\"bg-accent text-accent-foreground\",\n    day_outside:\n    \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n    day_disabled:\"text-muted-foreground opacity-50\",\n    day_range_middle:\n    \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n    day_hidden:\"invisible\",\n    ...classNames,\n   }}\n   components={{\n    IconLeft: ({ className, ...props }) => (\n     <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n    ),\n    IconRight: ({ className, ...props }) => (\n     <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n    ),\n   }}\n   {...props}\n  />\n )\n}\nCalendar.displayName =\"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2501,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as LabelPrimitive from\"@radix-ui/react-label\"\nimport { Slot } from\"@radix-ui/react-slot\"\nimport {\n Controller,\n FormProvider,\n useFormContext,\n type ControllerProps,\n type FieldPath,\n type FieldValues,\n} from\"react-hook-form\"\n\nimport { cn } from\"@/lib/utils\"\nimport { Label } from\"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n TFieldValues extends FieldValues = FieldValues,\n TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n {} as FormFieldContextValue\n)\n\nconst FormField = <\n TFieldValues extends FieldValues = FieldValues,\n TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n ...props\n}: ControllerProps<TFieldValues, TName>) => {\n return (\n  <FormFieldContext.Provider value={{ name: props.name }}>\n   <Controller {...props} />\n  </FormFieldContext.Provider>\n )\n}\n\nconst useFormField = () => {\n const fieldContext = React.useContext(FormFieldContext)\n const itemContext = React.useContext(FormItemContext)\n const { getFieldState, formState } = useFormContext()\n\n const fieldState = getFieldState(fieldContext.name, formState)\n\n if (!fieldContext) {\n  throw new Error(\"useFormField should be used within <FormField>\")\n }\n\n const { id } = itemContext\n\n return {\n  id,\n  name: fieldContext.name,\n  formItemId: `${id}-form-item`,\n  formDescriptionId: `${id}-form-item-description`,\n  formMessageId: `${id}-form-item-message`,\n  ...fieldState,\n }\n}\n\ntype FormItemContextValue = {\n id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n HTMLDivElement,\n React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n const id = React.useId()\n\n return (\n  <FormItemContext.Provider value={{ id }}>\n   <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n  </FormItemContext.Provider>\n )\n})\nFormItem.displayName =\"FormItem\"\n\nconst FormLabel = React.forwardRef<\n React.ElementRef<typeof LabelPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n const { error, formItemId } = useFormField()\n\n return (\n  <Label\n   ref={ref}\n   className={cn(error &&\"text-destructive\", className)}\n   htmlFor={formItemId}\n   {...props}\n  />\n )\n})\nFormLabel.displayName =\"FormLabel\"\n\nconst FormControl = React.forwardRef<\n React.ElementRef<typeof Slot>,\n React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n return (\n  <Slot\n   ref={ref}\n   id={formItemId}\n   aria-describedby={\n    !error\n     ? `${formDescriptionId}`\n     : `${formDescriptionId} ${formMessageId}`\n   }\n   aria-invalid={!!error}\n   {...props}\n  />\n )\n})\nFormControl.displayName =\"FormControl\"\n\nconst FormDescription = React.forwardRef<\n HTMLParagraphElement,\n React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n const { formDescriptionId } = useFormField()\n\n return (\n  <p\n   ref={ref}\n   id={formDescriptionId}\n   className={cn(\"text-sm text-muted-foreground\", className)}\n   {...props}\n  />\n )\n})\nFormDescription.displayName =\"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n HTMLParagraphElement,\n React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n const { error, formMessageId } = useFormField()\n const body = error ? String(error?.message ??\"\") : children\n\n if (!body) {\n  return null\n }\n\n return (\n  <p\n   ref={ref}\n   id={formMessageId}\n   className={cn(\"text-sm font-medium text-destructive\", className)}\n   {...props}\n  >\n   {body}\n  </p>\n )\n})\nFormMessage.displayName =\"FormMessage\"\n\nexport {\n useFormField,\n Form,\n FormItem,\n FormLabel,\n FormControl,\n FormDescription,\n FormMessage,\n FormField,\n}\n","path":null,"size_bytes":3926,"size_tokens":null},"replit.md":{"content":"# Overview\n\nTwealth is a full-stack web application for comprehensive schedule management, financial tracking, and goal setting. It offers a unified platform for personal and collaborative financial organization, featuring CFO-level AI financial advice, specialized cryptocurrency tools, and de-dollarization insights. The project aims to deliver an intuitive, globally accessible, production-ready product with premium design quality and a professional user experience to empower users in managing finances, achieving goals, and gaining actionable financial insights.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## UI/UX Decisions\n\nThe frontend is a React 18 single-page application built with TypeScript, `shadcn/ui`, Tailwind CSS, and Wouter for routing. It features a mobile-first, responsive, and accessible design with dynamic navigation and PWA support. Design principles include a clean black/white/gray color palette, professional typography, ample whitespace, simple borders, data-focused layouts, enterprise trust signals, and consistent professional iconography (Lucide React icons). The application includes sophisticated loading states, robust UI for rate limiting, retry logic, toast notifications, optimistic updates, comprehensive accessibility (WCAG 2.1 AA compliant), and advanced form validation. Key improvements include a streamlined dashboard, professional empty states, simplified navigation, an AI ROI Calculator, and the integration of AI Playbooks for weekly financial reports.\n\n## Streamlined Navigation (Dec 2025)\n\n**Sidebar (Desktop):** Dashboard → AI Assistant → My Money → Goals → Groups → Settings → Premium (7 items, organized by section: Main, Finance, Collaborate, More)\n\n**Mobile Nav:** Dashboard → AI → My Money → Goals → Premium (5 items - Groups accessible on desktop only for focused mobile experience)\n\n**My Money Page (/money-tracking):** Unified page with 6 tabs:\n- Overview: Transaction stats, filters, recent transactions\n- Profile: Manual financial overview form (income, expenses, savings, goals) - powers AI recommendations\n- Analytics: Advanced spending charts\n- Budget: Budget management\n- Insights: Spending insights and tips\n- CSV: Bank statement import (optional)\n\nLegacy routes /financial-profile and /planning redirect to their new locations.\n\n## Technical Implementations\n\nThe backend is an Express.js application in TypeScript, providing a RESTful API. It uses Drizzle ORM for type-safe PostgreSQL operations and employs a layered architecture with centralized error handling. Authentication utilizes a custom OAuth implementation supporting Google, Apple, and Facebook logins via Passport.js with PostgreSQL session management and role-based access control. The application supports 11 languages via `i18next` and `react-i18next`. API rate limiting is implemented with tiered protection for different endpoints. Input validation is handled using Zod.\n\n## Feature Specifications\n\nTwealth offers a three-tier subscription model (Free, Pro, Enterprise) with an intelligent 4-model hybrid AI architecture (Scout, Claude Sonnet, GPT-5, Claude Opus). This system features automatic model selection based on query complexity, cascading fallback, and quota enforcement. The AI Financial Advisor provides CFO-level advice with 33+ specialized financial tools including:\n\n**Advanced AI Tools (Dec 2025):**\n- **Debt Optimizer**: Avalanche vs Snowball strategies with month-by-month payoff schedules\n- **Investment Projector**: Multi-scenario compound growth with inflation adjustment\n- **What-If Analyzer**: Compare rent vs buy, lease vs own, debt vs invest scenarios\n- **Market Data**: Real-time stock prices, crypto prices, forex rates\n- **Tax Optimizer**: Retirement contribution strategies, deduction maximization\n- **Retirement Calculator**: Monte Carlo simulation, 4% rule analysis\n- **Spending Pattern Analyzer**: Deep trend analysis with anomaly detection\n\n**Enhanced Context Engine:**\nThe AI receives rich analytics including savingsRate, netWorth, debtToIncomeRatio, emergencyFundMonths, month-over-month spending trends, category anomaly detection (with severity levels), financial health score (0-100), top spending categories, and goal progress tracking (on-track vs at-risk). Proactive insights are auto-generated for spending spikes, goals at risk, emergency fund gaps, and debt payoff opportunities.\n\nCore features include conversational data collection, luxury purchase analysis, smart budget recommendations, actionable advice in 11 languages, and a tiered crypto experience. The system provides a real-time comprehensive financial health score, custom budget management, smart transaction auto-categorization, and proactive insights like spending anomaly detection. It also includes a Demo Mode with sample data, a professional subscription management system with visual quota progress, a zero-friction onboarding system, a Predictive Analytics Engine, and a floating AI Copilot Widget.\n\n## System Design Choices\n\nThe architecture incorporates a comprehensive caching strategy (system prompt, market data, React Query optimization) and database indexing for performance. Authentication handles OIDC foreign key constraints. Automatic investment data seeding populates strategies for new deployments. Production stability is ensured through a health check endpoint, global error handlers for server-side and React error boundaries for client-side issues, currency rate fallback, and AI service resilience with rate limit detection and exponential backoff retry logic.\n\n## Mobile-First Responsive Design\n\nAll pages use mobile-first responsive breakpoints: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3` for proper mobile stacking. Touch targets meet 44px minimum height requirement (`min-h-[44px]`). iOS safe-area padding uses `env(safe-area-inset-*)` CSS variables. The `/assets` middleware in server/index.ts serves static assets with cache headers and proper 404 handling to prevent MIME type errors on mobile. Subscription and pricing pages limit display to exactly 3 plans (Free, Pro, Enterprise) using `.slice(0, 3)`.\n\n# External Dependencies\n\n-   **React 18**: Frontend framework.\n-   **Express.js**: Backend web framework.\n-   **TypeScript**: Language for type safety.\n-   **Vite**: Build tool.\n-   **PostgreSQL**: Primary database.\n-   **Drizzle ORM**: Type-safe database toolkit.\n-   **Tailwind CSS**: Utility-first CSS framework.\n-   **Radix UI / shadcn/ui**: UI components.\n-   **TanStack Query**: Server state management.\n-   **React Hook Form**: Form state management.\n-   **Zod**: Schema validation.\n-   **Stripe**: Payment processing.\n-   **Groq AI**: AI financial advisor.\n-   **Alpha Vantage API**: Real-time stock market data.\n-   **Exchange Rate API**: Live forex and currency conversion.\n-   **Public Economic APIs**: Inflation and economic indicator data.","path":null,"size_bytes":6918,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport path from \"path\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { db } from \"./db\";\nimport { investmentStrategies } from \"@shared/schema\";\nimport { getSession, setupAuth } from \"./customAuth\";\n\n// ==================== GLOBAL ERROR HANDLERS ====================\n// Catch unhandled promise rejections (critical for production stability)\nprocess.on('unhandledRejection', (reason: any, promise: Promise<any>) => {\n  log(`[CRITICAL] Unhandled Promise Rejection: ${reason?.message || reason}`);\n  if (reason?.stack) {\n    log(`Stack: ${reason.stack}`);\n  }\n});\n\n// Catch uncaught exceptions (last resort safety net)\nprocess.on('uncaughtException', (error: Error) => {\n  log(`[CRITICAL] Uncaught Exception: ${error.message}`);\n  log(`Stack: ${error.stack}`);\n  // Give time to log before potential crash\n  setTimeout(() => process.exit(1), 1000);\n});\n\nconst app = express();\n\n// Trust proxy - required for secure cookies behind Replit's proxy\napp.set('trust proxy', 1);\n\n// Raw body middleware for Stripe webhooks (MUST come before express.json())\napp.use('/api/webhooks/stripe', express.raw({ type: 'application/json' }));\n\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\n// Session middleware (must be before routes)\napp.use(getSession());\n\n// Setup OAuth authentication routes\nsetupAuth(app);\n\n// Production-grade request logging middleware\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      // Safe logging: method, path, status, duration only (no response body)\n      const logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Auto-seed investment data if database is empty\n  try {\n    const existingStrategies = await db.select().from(investmentStrategies).limit(1);\n    if (existingStrategies.length === 0) {\n      log(\"Investment data not found, seeding database...\");\n      const { seedInvestments } = await import(\"./seed-investments\");\n      await seedInvestments();\n      log(\"Investment data seeded successfully\");\n    }\n  } catch (error: any) {\n    log(\"Failed to seed investment data:\", error?.message || error);\n  }\n\n  // Always sync subscription plans to ensure pricing is up-to-date\n  try {\n    log(\"Syncing subscription plans with latest configuration...\");\n    const { seedSubscriptionPlans } = await import(\"./seed-subscriptions\");\n    await seedSubscriptionPlans();\n    log(\"Subscription plans synced successfully\");\n  } catch (error: any) {\n    log(\"Failed to sync subscription plans:\", error?.message || error);\n  }\n\n  const server = await registerRoutes(app);\n\n  // ==================== CENTRALIZED ERROR HANDLER ====================\n  // Production-grade error handling with proper logging and user-friendly messages\n  app.use((err: any, req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const isProduction = process.env.NODE_ENV === 'production';\n    \n    // Log error details for debugging (safe: no sensitive data)\n    log(`[ERROR] ${req.method} ${req.path} - ${status}: ${err.message}`);\n    if (!isProduction && err.stack) {\n      log(`Stack: ${err.stack.split('\\n').slice(0, 5).join('\\n')}`);\n    }\n\n    // User-friendly error messages for common status codes\n    const userMessages: Record<number, string> = {\n      400: 'Invalid request. Please check your input and try again.',\n      401: 'Please sign in to continue.',\n      403: 'You don\\'t have permission to access this resource.',\n      404: 'The requested resource was not found.',\n      429: 'Too many requests. Please wait a moment and try again.',\n      500: 'Something went wrong on our end. Please try again later.',\n      502: 'Service temporarily unavailable. Please try again.',\n      503: 'Service is currently unavailable. Please try again later.',\n    };\n\n    const message = isProduction \n      ? (userMessages[status] || 'An unexpected error occurred.')\n      : (err.message || 'Internal Server Error');\n\n    res.status(status).json({ \n      message,\n      ...(isProduction ? {} : { stack: err.stack?.split('\\n').slice(0, 3) })\n    });\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    // ==================== PRODUCTION ASSET HANDLING ====================\n    // Serve /assets with dedicated middleware and proper cache headers\n    // This prevents MIME type errors when old cached HTML requests stale JS chunks\n    const distPath = path.resolve(import.meta.dirname, \"public\");\n    \n    // Serve hashed assets with long cache headers (immutable)\n    app.use(\"/assets\", express.static(path.resolve(distPath, \"assets\"), {\n      maxAge: \"1y\",\n      immutable: true,\n      etag: false,\n    }));\n    \n    // 404 guard for missing assets - prevents SPA fallback from returning HTML\n    app.use(\"/assets\", (_req, res) => {\n      res.status(404).send(\"Asset not found\");\n    });\n    \n    // Prevent caching of HTML pages to reduce stale chunk references\n    app.use((req, res, next) => {\n      const accept = req.headers.accept || \"\";\n      if (accept.includes(\"text/html\") && !req.path.startsWith(\"/api\") && !req.path.startsWith(\"/assets\")) {\n        res.setHeader(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n        res.setHeader(\"Pragma\", \"no-cache\");\n        res.setHeader(\"Expires\", \"0\");\n      }\n      next();\n    });\n    \n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":6259,"size_tokens":null},"client/src/components/dashboard/enhanced-financial-trends.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { \n TrendingUp, \n TrendingDown, \n DollarSign, \n Target, \n ArrowUp,\n ArrowDown,\n BarChart3,\n PieChart,\n Activity,\n Zap\n} from\"lucide-react\";\n\ninterface TrendData {\n label: string;\n current: number;\n previous: number;\n change: number;\n changePercent: number;\n status: 'up' | 'down' | 'neutral';\n category: 'income' | 'savings' | 'goals' | 'efficiency';\n}\n\nexport default function EnhancedFinancialTrends() {\n const [period, setPeriod] = useState<'7d' | '30d' | '90d'>('30d');\n\n const { data: currentStats, isLoading: currentStatsLoading } = useQuery({\n  queryKey: [\"/api/dashboard/stats\", period],\n  queryFn: () => fetch(`/api/dashboard/stats?period=${period}`).then(res => res.json()),\n });\n\n const { data: previousStats, isLoading: previousStatsLoading } = useQuery({\n  queryKey: [\"/api/dashboard/stats\", period,\"previous\"],\n  queryFn: () => fetch(`/api/dashboard/stats?period=${period}&previous=true`).then(res => res.json()),\n });\n\n const { data: transactions, isLoading: transactionsLoading } = useQuery({\n  queryKey: [\"/api/transactions\"],\n  queryFn: () => fetch(\"/api/transactions?limit=100\").then(res => res.json()),\n });\n\n // Calculate trend data\n const getTrendData = (): TrendData[] => {\n  if (!currentStats || !previousStats) return [];\n\n  const trends: TrendData[] = [];\n  \n  // Total Savings Trend\n  const currentSavings = (currentStats as any).totalSavings || 0;\n  const previousSavings = (previousStats as any).totalSavings || 0;\n  const savingsChange = currentSavings - previousSavings;\n  const savingsChangePercent = previousSavings ? (savingsChange / previousSavings) * 100 : 0;\n  \n  trends.push({\n   label: 'Total Savings',\n   current: currentSavings,\n   previous: previousSavings,\n   change: savingsChange,\n   changePercent: savingsChangePercent,\n   status: savingsChange > 0 ? 'up' : savingsChange < 0 ? 'down' : 'neutral',\n   category: 'savings'\n  });\n\n  // Active Goals Trend\n  const currentGoals = parseInt((currentStats as any).activeGoals ||\"0\");\n  const previousGoals = parseInt((previousStats as any).activeGoals ||\"0\");\n  const goalsChange = currentGoals - previousGoals;\n  const goalsChangePercent = previousGoals ? (goalsChange / previousGoals) * 100 : 0;\n  \n  trends.push({\n   label: 'Active Goals',\n   current: currentGoals,\n   previous: previousGoals,\n   change: goalsChange,\n   changePercent: goalsChangePercent,\n   status: goalsChange > 0 ? 'up' : goalsChange < 0 ? 'down' : 'neutral',\n   category: 'goals'\n  });\n\n  return trends;\n };\n\n // Calculate spending insights\n const getSpendingInsights = () => {\n  if (!transactions || !Array.isArray(transactions)) return null;\n  \n  const recentTransactions = transactions.filter((t: any) => {\n   const days = period === '7d' ? 7 : period === '30d' ? 30 : 90;\n   const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);\n   return new Date(t.date) >= cutoff;\n  });\n\n  const totalIncome = recentTransactions\n   .filter((t: any) => t.type === 'income')\n   .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n\n  const totalExpenses = recentTransactions\n   .filter((t: any) => t.type === 'expense')\n   .reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n\n  const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : 0;\n\n  // Top spending categories\n  const categorySpending = recentTransactions\n   .filter((t: any) => t.type === 'expense')\n   .reduce((acc: any, t: any) => {\n    acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount);\n    return acc;\n   }, {});\n\n  const topCategories = Object.entries(categorySpending)\n   .sort(([,a], [,b]) => (b as number) - (a as number))\n   .slice(0, 3);\n\n  return {\n   totalIncome,\n   totalExpenses,\n   savingsRate,\n   topCategories,\n   netCashFlow: totalIncome - totalExpenses\n  };\n };\n\n // Loading state\n const isLoading = currentStatsLoading || previousStatsLoading || transactionsLoading;\n \n if (isLoading) {\n  return (\n   <Card className=\"shadow-sm\">\n    <CardHeader className=\"pb-4\">\n     <div className=\"flex items-center justify-between\">\n      <div className=\"flex items-center gap-2\">\n       <div className=\"w-8 h-8 bg-muted rounded-lg\" />\n       <div className=\"h-5 bg-muted rounded w-32\" />\n      </div>\n      <div className=\"flex gap-2\">\n       {[1,2,3].map(i => <div key={i} className=\"w-12 h-8 bg-muted rounded\" />)}\n      </div>\n     </div>\n     <div className=\"h-4 bg-muted rounded w-48 mt-2\" />\n    </CardHeader>\n    <CardContent className=\"space-y-6\">\n     <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n      {[1,2].map(i => (\n       <div key={i} className=\"p-4 border rounded-lg\">\n        <div className=\"h-4 bg-muted rounded w-24 mb-3\" />\n        <div className=\"h-8 bg-muted rounded w-16 mb-2\" />\n        <div className=\"h-3 bg-muted rounded w-40\" />\n       </div>\n      ))}\n     </div>\n     <div className=\"space-y-4\">\n      <div className=\"h-5 bg-muted rounded w-32\" />\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n       {[1,2,3].map(i => (\n        <div key={i} className=\"p-4 border rounded-lg\">\n         <div className=\"h-4 bg-muted rounded w-20 mb-2\" />\n         <div className=\"h-6 bg-muted rounded w-12\" />\n        </div>\n       ))}\n      </div>\n     </div>\n    </CardContent>\n   </Card>\n  );\n }\n \n const trends = getTrendData();\n const spendingInsights = getSpendingInsights();\n\n const getTrendIcon = (status: string) => {\n  switch (status) {\n   case 'up':\n    return <ArrowUp size={16} className=\"text-green-600\" />;\n   case 'down':\n    return <ArrowDown size={16} className=\"text-red-600\" />;\n   default:\n    return <Activity size={16} className=\"text-muted-foreground\" />;\n  }\n };\n\n const getTrendColor = (status: string) => {\n  switch (status) {\n   case 'up':\n    return 'text-green-600';\n   case 'down':\n    return 'text-red-600';\n   default:\n    return 'text-muted-foreground';\n  }\n };\n\n const periodLabels = {\n  '7d': 'Last 7 days',\n  '30d': 'Last 30 days',\n  '90d': 'Last 90 days'\n };\n\n return (\n  <Card className=\"shadow-sm hover-lift\">\n   <CardHeader className=\"pb-4\">\n    <div className=\"flex items-center justify-between\">\n     <div className=\"flex items-center gap-2\">\n      <div className=\"w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center\">\n       <BarChart3 className=\"text-primary\" size={18} />\n      </div>\n      <CardTitle className=\"text-lg font-semibold text-foreground\">\n       Financial Trends\n      </CardTitle>\n     </div>\n     <div className=\"flex items-center gap-2\">\n      {(['7d', '30d', '90d'] as const).map((p) => (\n       <Button\n        key={p}\n        variant={period === p ?\"default\" :\"outline\"}\n        size=\"sm\"\n        onClick={() => setPeriod(p)}\n        data-testid={`button-period-${p}`}\n       >\n        {p}\n       </Button>\n      ))}\n     </div>\n    </div>\n    <p className=\"text-sm text-muted-foreground\">\n     {periodLabels[period]} • Track your financial progress over time\n    </p>\n   </CardHeader>\n   \n   <CardContent className=\"space-y-6\">\n    {/* Trend Cards */}\n    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n     {trends.map((trend, index) => (\n      <Card key={trend.label} className=\"p-4 border-l-4 border-l-blue-500 bg-white dark:bg-gray-900\">\n       <div className=\"flex items-center justify-between mb-3\">\n        <h4 className=\"font-medium text-sm\">{trend.label}</h4>\n        <Badge \n         variant={trend.status === 'up' ? 'default' : trend.status === 'down' ? 'destructive' : 'secondary'}\n         className=\"text-xs\"\n        >\n         {trend.status === 'up' ? 'Growth' : trend.status === 'down' ? 'Decline' : 'Stable'}\n        </Badge>\n       </div>\n       \n       <div className=\"space-y-2\">\n        <div className=\"flex items-center gap-2\">\n         <p className=\"text-2xl font-bold\">\n          {trend.category === 'savings' ? '$' : ''}{trend.current.toLocaleString()}\n         </p>\n         <div className={`flex items-center gap-1 ${getTrendColor(trend.status)}`}>\n          {getTrendIcon(trend.status)}\n          <span className=\"text-sm font-medium\">\n           {trend.changePercent > 0 ? '+' : ''}{trend.changePercent.toFixed(1)}%\n          </span>\n         </div>\n        </div>\n        \n        <p className=\"text-xs text-muted-foreground\">\n         {trend.change > 0 ? '+' : ''}{trend.category === 'savings' ? '$' : ''}{trend.change.toLocaleString()} vs previous period\n        </p>\n       </div>\n      </Card>\n     ))}\n    </div>\n\n    {/* Spending Insights */}\n    {spendingInsights ? (\n     <div className=\"space-y-4\">\n      <h3 className=\"text-base font-semibold flex items-center gap-2\">\n       <PieChart size={16} className=\"text-blue-600\" />\n       Spending Analysis\n      </h3>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n       {/* Savings Rate */}\n       <Card className=\"p-4 bg-white dark:bg-gray-900 border-green-200 dark:border-green-800\">\n        <div className=\"flex items-center gap-2 mb-2\">\n         <Target className=\"text-green-600\" size={16} />\n         <span className=\"text-sm font-medium\">Savings Rate</span>\n        </div>\n        <p className=\"text-2xl font-bold text-green-600\">\n         {spendingInsights.savingsRate.toFixed(1)}%\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n         {spendingInsights.savingsRate >= 15 ? 'Excellent!' : spendingInsights.savingsRate >= 10 ? 'Good' : 'Needs improvement'}\n        </p>\n       </Card>\n\n       {/* Net Cash Flow */}\n       <Card className={`p-4 border-2 ${spendingInsights.netCashFlow >= 0 ? 'bg-white dark:bg-gray-900 border-blue-200 dark:border-blue-800' : 'bg-white dark:bg-gray-900 border-red-200 dark:border-red-800'}`}>\n        <div className=\"flex items-center gap-2 mb-2\">\n         <DollarSign className={spendingInsights.netCashFlow >= 0 ?\"text-blue-600\" :\"text-red-600\"} size={16} />\n         <span className=\"text-sm font-medium\">Net Cash Flow</span>\n        </div>\n        <p className={`text-2xl font-bold ${spendingInsights.netCashFlow >= 0 ? 'text-blue-600' : 'text-red-600'}`}>\n         ${Math.abs(spendingInsights.netCashFlow).toLocaleString()}\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n         {spendingInsights.netCashFlow >= 0 ? 'Positive flow' : 'Spending exceeds income'}\n        </p>\n       </Card>\n\n       {/* Top Spending */}\n       <Card className=\"p-4 bg-white dark:bg-gray-900 border-orange-200 dark:border-orange-800\">\n        <div className=\"flex items-center gap-2 mb-2\">\n         <Zap className=\"text-orange-600\" size={16} />\n         <span className=\"text-sm font-medium\">Top Category</span>\n        </div>\n        {spendingInsights.topCategories.length > 0 ? (\n         <>\n          <p className=\"text-lg font-bold text-orange-600 capitalize\">\n           {spendingInsights.topCategories[0][0]}\n          </p>\n          <p className=\"text-xs text-muted-foreground\">\n           ${(spendingInsights.topCategories[0][1] as number).toLocaleString()} spent\n          </p>\n         </>\n        ) : (\n         <p className=\"text-sm text-muted-foreground\">No expenses recorded</p>\n        )}\n       </Card>\n      </div>\n\n      {/* Top Categories List */}\n      {spendingInsights.topCategories.length > 0 && (\n       <Card className=\"p-4\">\n        <h4 className=\"font-medium text-sm mb-3\">Top Spending Categories</h4>\n        <div className=\"space-y-2\">\n         {spendingInsights.topCategories.map(([category, amount], index) => {\n          const percentage = spendingInsights.totalExpenses > 0 \n           ? ((amount as number) / spendingInsights.totalExpenses) * 100 \n           : 0;\n          \n          return (\n           <div key={category} className=\"flex items-center justify-between p-2 bg-muted/50 rounded\">\n            <div className=\"flex items-center gap-2\">\n             <div className={`w-2 h-2 rounded-full ${index === 0 ? 'bg-orange-500' : index === 1 ? 'bg-blue-500' : 'bg-blue-500'}`} />\n             <span className=\"text-sm capitalize\">{category}</span>\n            </div>\n            <div className=\"text-right\">\n             <p className=\"text-sm font-medium\">${(amount as number).toLocaleString()}</p>\n             <p className=\"text-xs text-muted-foreground\">{percentage.toFixed(1)}%</p>\n            </div>\n           </div>\n          );\n         })}\n        </div>\n       </Card>\n      )}\n     </div>\n    ) : (\n     <div className=\"text-center py-8 text-muted-foreground\">\n      <PieChart size={32} className=\"mx-auto mb-2 opacity-50\" />\n      <p className=\"font-medium\">No spending data available</p>\n      <p className=\"text-sm\">Add some transactions to see spending insights</p>\n     </div>\n    )}\n   </CardContent>\n  </Card>\n );\n}","path":null,"size_bytes":12846,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from\"react\"\nimport * as CheckboxPrimitive from\"@radix-ui/react-checkbox\"\nimport { Check } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n React.ElementRef<typeof CheckboxPrimitive.Root>,\n React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n <CheckboxPrimitive.Root\n  ref={ref}\n  className={cn(\n   \"peer relative h-11 w-11 min-h-[44px] min-w-[44px] shrink-0 cursor-pointer rounded-md ring-offset-background transition-all duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-50 flex items-center justify-center\",\n   \"before:absolute before:inset-[11px] before:h-5 before:w-5 before:rounded-md before:border before:border-input before:transition-colors before:bg-background\",\n   \"data-[state=checked]:before:bg-primary data-[state=checked]:before:border-primary\",\n   \"hover:before:border-primary/60\",\n   className\n  )}\n  {...props}\n >\n  <CheckboxPrimitive.Indicator\n   className={cn(\"flex items-center justify-center text-primary-foreground z-10\")}\n  >\n   <Check className=\"h-3.5 w-3.5\" strokeWidth={3} />\n  </CheckboxPrimitive.Indicator>\n </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1336,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/pages/referrals.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { useTranslation } from 'react-i18next';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Label } from\"@/components/ui/label\";\nimport { Separator } from\"@/components/ui/separator\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { Copy, Share2, Gift, Users, ChevronRight, AlertCircle, Trophy, Star, Zap, Crown, Target, Award, TrendingUp, Sparkles, Rocket } from 'lucide-react';\nimport { format } from 'date-fns';\n\ninterface ReferralCode {\n id: string;\n userId: string;\n code: string;\n maxUses: number;\n currentUses: number;\n isActive: boolean;\n createdAt: string;\n}\n\ninterface Referral {\n id: string;\n referrerUserId: string;\n referredUserId: string;\n referralCodeId: string;\n createdAt: string;\n referredUserName?: string;\n}\n\ninterface BonusCredit {\n id: string;\n userId: string;\n amount: number;\n source: string;\n referralId?: string;\n description: string;\n usedAmount: number;\n createdAt: string;\n}\n\nexport default function ReferralsPage() {\n const { t } = useTranslation();\n const { toast } = useToast();\n const [shareCode, setShareCode] = useState('');\n\n // Fetch user's referral code\n const { data: referralCode, isLoading: isLoadingCode } = useQuery<ReferralCode>({\n queryKey: ['/api/referrals/my-code']\n });\n\n // Fetch user's referrals\n const { data: referrals = [], isLoading: isLoadingReferrals } = useQuery<Referral[]>({\n queryKey: ['/api/referrals/my-referrals']\n });\n\n // Fetch bonus credits\n const { data: bonusData, isLoading: isLoadingCredits } = useQuery<{\n credits: BonusCredit[];\n availableAmount: number;\n }>({\n queryKey: ['/api/referrals/bonus-credits']\n });\n\n // Use referral code mutation\n const useCodeMutation = useMutation({\n mutationFn: async (referralCode: string) => {\n const response = await apiRequest('POST', '/api/referrals/use-code', { referralCode });\n return await response.json();\n },\n onSuccess: (data: any) => {\n toast({\n title: t('referrals.success'),\n description: data.message,\n });\n queryClient.invalidateQueries({ queryKey: ['/api/referrals/bonus-credits'] });\n setShareCode('');\n },\n onError: (error: any) => {\n // Extract the actual error message from the API response\n let errorMessage = 'An error occurred';\n if (error?.message) {\n // Parse error message format:\"400: {\\\"message\\\":\\\"Invalid referral code\\\"}\"\n const match = error.message.match(/^\\d+:\\s*(.+)$/);\n if (match) {\n try {\n const parsed = JSON.parse(match[1]);\n errorMessage = parsed.message || errorMessage;\n } catch {\n errorMessage = match[1];\n }\n } else {\n errorMessage = error.message;\n }\n }\n \n toast({\n title: t('referrals.error'),\n description: errorMessage,\n variant: 'destructive'\n });\n }\n });\n\n const copyToClipboard = async (text: string) => {\n try {\n await navigator.clipboard.writeText(text);\n toast({\n title: t('referrals.copied'),\n description: t('referrals.copiedDescription'),\n });\n } catch (err) {\n console.error('Failed to copy: ', err);\n }\n };\n\n const shareReferralCode = async () => {\n if (!referralCode) return;\n \n const shareData = {\n title: t('referrals.shareTitle'),\n text: t('referrals.shareText', { code: referralCode.code }),\n url: `${window.location.origin}?ref=${referralCode.code}`\n };\n\n try {\n if (navigator.share) {\n await navigator.share(shareData);\n } else {\n await copyToClipboard(`${shareData.text} ${shareData.url}`);\n }\n } catch (err) {\n console.error('Error sharing:', err);\n }\n };\n\n const handleUseCode = () => {\n if (!shareCode.trim()) return;\n useCodeMutation.mutate(shareCode.trim());\n };\n\n if (isLoadingCode || isLoadingReferrals || isLoadingCredits) {\n return (\n <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-8 space-y-6\" data-testid=\"page-referrals\">\n <div className=\"space-y-4\">\n <div className=\"h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3\"></div>\n <div className=\"h-32 bg-gray-200 dark:bg-gray-700 rounded\"></div>\n <div className=\"h-32 bg-gray-200 dark:bg-gray-700 rounded\"></div>\n </div>\n </div>\n );\n }\n\n // Calculate referral level based on successful referrals\n const referralLevel = Math.floor((referrals.length) / 5) + 1;\n const nextLevelReferrals = (referralLevel * 5) - referrals.length;\n const levelProgress = ((referrals.length % 5) / 5) * 100;\n\n const getLevelBadge = (level: number) => {\n if (level >= 10) return { icon: Crown, color:\"text-blue-600\", bg:\"bg-blue-100 dark:bg-blue-900/20\", title:\"Referral Royalty\" };\n if (level >= 7) return { icon: Trophy, color:\"text-yellow-600\", bg:\"bg-yellow-100 dark:bg-yellow-900/20\", title:\"Referral Champion\" };\n if (level >= 4) return { icon: Star, color:\"text-blue-600\", bg:\"bg-blue-100 dark:bg-blue-900/20\", title:\"Referral Expert\" };\n if (level >= 2) return { icon: Award, color:\"text-green-600\", bg:\"bg-green-100 dark:bg-green-900/20\", title:\"Referral Pro\" };\n return { icon: Target, color:\"text-orange-600\", bg:\"bg-orange-100 dark:bg-orange-900/20\", title:\"Referral Starter\" };\n };\n\n const levelBadge = getLevelBadge(referralLevel);\n\n return (\n <>\n {/* Gamified Header */}\n <header className=\"bg-blue-50 dark:bg-blue-900/30 border-b border-border/50\">\n <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6 md:py-8\">\n <div className=\"flex items-center justify-between mb-6\">\n <div className=\"flex-1\">\n <div className=\"flex items-center gap-4 mb-4\">\n <div className=\"w-16 h-16 bg-white dark:bg-gray-900 rounded-2xl flex items-center justify-center shadow-xl\">\n <Users className=\"w-8 h-8 text-white\" />\n </div>\n <div>\n <h1 className=\"text-2xl md:text-4xl font-bold text-blue-600 dark:text-blue-400\" data-testid=\"heading-referrals\">\n Referral Rewards\n </h1>\n <p className=\"text-xl text-muted-foreground\">Share the wealth, grow together!</p>\n </div>\n </div>\n \n {/* Gamification Stats */}\n <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n <div className=\"bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-4 border border-white/20\">\n <div className=\"flex items-center gap-2 mb-2\">\n <levelBadge.icon className={`w-5 h-5 ${levelBadge.color}`} />\n <span className=\"text-sm font-medium\">Current Level</span>\n </div>\n <div className=\"text-2xl font-bold text-blue-600\">{referralLevel}</div>\n <div className=\"text-xs text-muted-foreground\">{levelBadge.title}</div>\n </div>\n \n <div className=\"bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-4 border border-white/20\">\n <div className=\"flex items-center gap-2 mb-2\">\n <Rocket className=\"w-5 h-5 text-green-500\" />\n <span className=\"text-sm font-medium\">Total Referrals</span>\n </div>\n <div className=\"text-2xl font-bold text-green-600\">{referrals.length}</div>\n <div className=\"text-xs text-muted-foreground\">Friends joined</div>\n </div>\n \n <div className=\"bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-4 border border-white/20\">\n <div className=\"flex items-center gap-2 mb-2\">\n <Gift className=\"w-5 h-5 text-orange-500\" />\n <span className=\"text-sm font-medium\">Total Earned</span>\n </div>\n <div className=\"text-2xl font-bold text-orange-600\">\n {bonusData?.credits.reduce((sum, credit) => sum + credit.amount, 0) || 0}\n </div>\n <div className=\"text-xs text-muted-foreground\">Bonus credits</div>\n </div>\n \n <div className=\"bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-4 border border-white/20\">\n <div className=\"flex items-center gap-2 mb-2\">\n <Zap className=\"w-5 h-5 text-blue-500\" />\n <span className=\"text-sm font-medium\">Available</span>\n </div>\n <div className=\"text-2xl font-bold text-blue-600\">\n {bonusData?.availableAmount || 0}\n </div>\n <div className=\"text-xs text-muted-foreground\">Ready to use</div>\n </div>\n </div>\n \n {/* Level Progress */}\n <div className=\"mt-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl p-4 border border-white/20\">\n <div className=\"flex items-center justify-between mb-2\">\n <span className=\"text-sm font-medium\">Progress to Level {referralLevel + 1}</span>\n <span className=\"text-xs text-muted-foreground\">{nextLevelReferrals} more referrals needed</span>\n </div>\n <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3\">\n <div \n className=\"bg-white dark:bg-gray-900 h-3 rounded-full relative\"\n style={{ width: `${levelProgress}%` }}\n >\n <div className=\"absolute right-0 top-0 h-full w-2 bg-white/30 rounded-full\"></div>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n </header>\n\n <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6 md:py-8 space-y-6\" data-testid=\"page-referrals\">\n\n {/* Enhanced Bonus Credits Summary */}\n {bonusData && (\n <Card className=\"bg-green-50 dark:bg-green-900/20 border-green-200/50 dark:border-green-700/50 shadow-lg transition-all\" data-testid=\"card-bonus-credits\">\n <CardHeader className=\"pb-4\">\n <CardTitle className=\"text-xl font-bold text-foreground flex items-center gap-2\">\n <div className=\"w-8 h-8 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center\">\n <Gift className=\"h-5 w-5 text-white\" />\n </div>\n Your Treasure Chest\n </CardTitle>\n <p className=\"text-muted-foreground\">Credits earned through referrals</p>\n </CardHeader>\n <CardContent>\n <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n <div className=\"text-center\">\n <div className=\"text-5xl font-bold text-foreground mb-2\" data-testid=\"text-available-credits\">\n {bonusData.availableAmount}\n </div>\n <p className=\"text-lg font-semibold text-green-700 dark:text-green-300\">Available Credits</p>\n <p className=\"text-sm text-muted-foreground\">Ready to spend!</p>\n </div>\n <div className=\"text-center\">\n <div className=\"text-3xl font-bold text-emerald-600 mb-2\">\n {bonusData.credits.reduce((sum, credit) => sum + credit.amount, 0)}\n </div>\n <p className=\"text-lg font-semibold text-emerald-700 dark:text-emerald-300\">Total Earned</p>\n <p className=\"text-sm text-muted-foreground\">All time rewards</p>\n </div>\n </div>\n </CardContent>\n </Card>\n )}\n\n <div className=\"grid gap-6 md:grid-cols-2\">\n {/* Enhanced My Referral Code */}\n <Card className=\"bg-blue-50 dark:bg-blue-900/20 border-blue-200/50 dark:border-blue-700/50 shadow-lg transition-all\" data-testid=\"card-my-code\">\n <CardHeader className=\"pb-4\">\n <CardTitle className=\"text-xl font-bold text-foreground flex items-center gap-2\">\n <div className=\"w-8 h-8 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center\">\n <Share2 className=\"h-5 w-5 text-white\" />\n </div>\n Your Magic Code\n </CardTitle>\n <CardDescription className=\"text-base\">\n Share this special code and earn rewards together!\n </CardDescription>\n </CardHeader>\n <CardContent className=\"space-y-4\">\n {referralCode && (\n <>\n <div className=\"relative\">\n <Input \n value={referralCode.code} \n readOnly \n className=\"font-mono text-xl text-center bg-white dark:bg-gray-900 border-2 border-blue-200 dark:border-blue-700 h-14 text-blue-800 dark:text-blue-200 font-bold\" \n data-testid=\"input-referral-code\"\n />\n <Button \n variant=\"ghost\" \n size=\"icon\"\n onClick={() => copyToClipboard(referralCode.code)}\n className=\"absolute right-2 top-1/2 -translate-y-1/2 hover:bg-blue-100 dark:hover:bg-blue-800\"\n data-testid=\"button-copy-code\"\n >\n <Copy className=\"h-5 w-5 text-blue-600\" />\n </Button>\n </div>\n \n <div className=\"flex items-center justify-between p-3 bg-white/50 dark:bg-gray-800/50 rounded-lg\">\n <div className=\"flex items-center gap-2\">\n <TrendingUp className=\"h-4 w-4 text-blue-600\" />\n <span className=\"text-sm font-medium\" data-testid=\"text-uses\">Used: {referralCode.currentUses}/{referralCode.maxUses}</span>\n </div>\n <Badge variant={referralCode.isActive ?\"default\" :\"secondary\"} className=\"bg-green-100 text-green-800 border-green-300\">\n {referralCode.isActive ? 'Active' : 'Inactive'}\n </Badge>\n </div>\n\n <Button \n onClick={shareReferralCode} \n className=\"w-full bg-primary text-primary-foreground font-semibold py-3 h-12 shadow-lg\"\n data-testid=\"button-share-code\"\n >\n <Share2 className=\"h-5 w-5 mr-2\" />\n Share & Earn Together\n </Button>\n </>\n )}\n </CardContent>\n </Card>\n\n {/* Enhanced Use Referral Code */}\n <Card className=\"bg-orange-50 dark:bg-orange-900/20 border-orange-200/50 dark:border-orange-700/50 shadow-lg transition-all\" data-testid=\"card-use-code\">\n <CardHeader className=\"pb-4\">\n <CardTitle className=\"text-xl font-bold text-foreground flex items-center gap-2\">\n <div className=\"w-8 h-8 bg-white dark:bg-gray-900 rounded-lg flex items-center justify-center\">\n <Gift className=\"h-5 w-5 text-white\" />\n </div>\n Redeem Invitation\n </CardTitle>\n <CardDescription className=\"text-base\">\n Got a friend's code? Claim your bonus here!\n </CardDescription>\n </CardHeader>\n <CardContent className=\"space-y-4\">\n <div className=\"space-y-2\">\n <Label htmlFor=\"referral-code\" className=\"text-sm font-semibold\">Enter Your Friend's Code</Label>\n <Input\n id=\"referral-code\"\n placeholder=\"TYPE-FRIEND-CODE\"\n value={shareCode}\n onChange={(e) => setShareCode(e.target.value.toUpperCase())}\n className=\"font-mono text-lg text-center bg-white dark:bg-gray-900 border-2 border-orange-200 dark:border-orange-700 h-12 text-orange-800 dark:text-orange-200 font-bold\"\n data-testid=\"input-use-code\"\n />\n </div>\n \n <Button \n onClick={handleUseCode}\n disabled={!shareCode.trim() || useCodeMutation.isPending}\n className=\"w-full bg-primary text-primary-foreground font-semibold py-3 h-12 shadow-lg disabled:opacity-50 disabled: disabled:hover:translate-y-0\"\n data-testid=\"button-use-code\"\n >\n {useCodeMutation.isPending ? (\n <>\n <Sparkles className=\"h-5 w-5 mr-2\" />\n Processing...\n </>\n ) : (\n <>\n <Gift className=\"h-5 w-5 mr-2\" />\n Claim Bonus Now\n </>\n )}\n </Button>\n\n <div className=\"flex items-start gap-3 p-4 bg-orange-100 dark:bg-orange-900/20 rounded-xl border border-orange-200/50 dark:border-orange-700/50\">\n <div className=\"w-6 h-6 bg-white dark:bg-gray-900 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5\">\n <AlertCircle className=\"h-3 w-3 text-white\" />\n </div>\n <div>\n <p className=\"text-sm font-semibold text-orange-800 dark:text-orange-200 mb-1\">Free Bonus Waiting!</p>\n <p className=\"text-xs text-orange-700 dark:text-orange-300\">\n Use a friend's code to get instant bonus credits - completely free!\n </p>\n </div>\n </div>\n </CardContent>\n </Card>\n </div>\n\n {/* Referral History */}\n <Card data-testid=\"card-referral-history\">\n <CardHeader>\n <CardTitle className=\"flex items-center gap-2\">\n <Users className=\"h-5 w-5\" />\n {t('referrals.history')}\n </CardTitle>\n <CardDescription>\n {t('referrals.historyDescription')}\n </CardDescription>\n </CardHeader>\n <CardContent>\n {referrals.length === 0 ? (\n <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-referrals\">\n <Users className=\"h-12 w-12 mx-auto mb-4 opacity-20\" />\n <p>{t('referrals.noReferrals')}</p>\n <p className=\"text-sm mt-2\">{t('referrals.startSharing')}</p>\n </div>\n ) : (\n <div className=\"space-y-2\">\n {referrals.map((referral, index) => (\n <div key={referral.id} className=\"flex items-center justify-between p-3 rounded-lg border\">\n <div className=\"flex items-center gap-3\">\n <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\n <Users className=\"h-4 w-4 text-primary\" />\n </div>\n <div>\n <p className=\"font-medium\" data-testid={`text-referred-user-${index}`}>\n {referral.referredUserName || t('referrals.friend')} #{index + 1}\n </p>\n <p className=\"text-sm text-muted-foreground\" data-testid={`text-referral-date-${index}`}>\n {format(new Date(referral.createdAt), 'MMM dd, yyyy')}\n </p>\n </div>\n </div>\n <div className=\"flex items-center gap-2\">\n <Badge variant=\"secondary\">+10 {t('referrals.credits')}</Badge>\n <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n </div>\n </div>\n ))}\n </div>\n )}\n </CardContent>\n </Card>\n\n {/* Bonus Credits History */}\n {bonusData && bonusData.credits.length > 0 && (\n <Card data-testid=\"card-credits-history\">\n <CardHeader>\n <CardTitle className=\"flex items-center gap-2\">\n <Gift className=\"h-5 w-5\" />\n {t('referrals.creditsHistory')}\n </CardTitle>\n </CardHeader>\n <CardContent>\n <div className=\"space-y-2\">\n {bonusData.credits.map((credit, index) => (\n <div key={credit.id} className=\"flex items-center justify-between p-3 rounded-lg border\">\n <div>\n <p className=\"font-medium\" data-testid={`text-credit-description-${index}`}>\n {credit.description}\n </p>\n <p className=\"text-sm text-muted-foreground\" data-testid={`text-credit-date-${index}`}>\n {format(new Date(credit.createdAt), 'MMM dd, yyyy')}\n </p>\n </div>\n <div className=\"text-right\">\n <p className=\"font-bold text-green-600\" data-testid={`text-credit-amount-${index}`}>\n +{credit.amount}\n </p>\n <p className=\"text-xs text-muted-foreground\">\n {t('referrals.used')}: {credit.usedAmount}\n </p>\n </div>\n </div>\n ))}\n </div>\n </CardContent>\n </Card>\n )}\n </div>\n </>\n );\n}","path":null,"size_bytes":16831,"size_tokens":null},"shared/schema.ts":{"content":"import { sql, relations } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, decimal, timestamp, boolean, jsonb, unique, index } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table - Updated for Replit Auth\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const groups = pgTable(\"groups\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  ownerId: varchar(\"owner_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  color: text(\"color\").default(\"#3B82F6\"),\n  status: text(\"status\").default(\"active\"), // active, planning, archived\n  category: text(\"category\").default(\"other\"), // house, car, savings, other\n  budget: decimal(\"budget\", { precision: 12, scale: 2 }), // target amount for the group goal\n  currentAmount: decimal(\"current_amount\", { precision: 12, scale: 2 }).default(\"0\"), // contributed so far\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const groupMembers = pgTable(\"group_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  groupId: varchar(\"group_id\").notNull().references(() => groups.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").default(\"member\"), // owner, admin, member\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n});\n\nexport const events = pgTable(\"events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  startTime: timestamp(\"start_time\").notNull(),\n  endTime: timestamp(\"end_time\").notNull(),\n  location: text(\"location\"),\n  groupId: varchar(\"group_id\").references(() => groups.id, { onDelete: \"cascade\" }),\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  attendees: jsonb(\"attendees\").default([]), // array of {userId: string, status: 'yes'|'no'|'maybe'}\n  status: text(\"status\").default(\"scheduled\"), // scheduled, completed, cancelled\n  // Financial fields\n  budget: decimal(\"budget\", { precision: 10, scale: 2 }), // planned budget for this event\n  actualCost: decimal(\"actual_cost\", { precision: 10, scale: 2 }).default(\"0\"), // total spent on this event\n  linkedGoalId: varchar(\"linked_goal_id\").references(() => financialGoals.id, { onDelete: \"set null\" }), // link to financial goal\n  costSharingType: text(\"cost_sharing_type\", { enum: [\"none\", \"equal\", \"custom\"] }).default(\"none\"),\n  // Time tracking fields\n  plannedDurationMinutes: integer(\"planned_duration_minutes\"), // expected duration in minutes\n  actualDurationMinutes: integer(\"actual_duration_minutes\"), // actual time spent from time logs\n  timeTracked: boolean(\"time_tracked\").default(false), // whether user has tracked time for this event\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_events_created_by\").on(table.createdBy),\n  index(\"idx_events_start_time\").on(table.startTime),\n  index(\"idx_events_group_id\").on(table.groupId),\n]);\n\nexport const financialGoals = pgTable(\"financial_goals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  targetAmount: decimal(\"target_amount\", { precision: 10, scale: 2 }).notNull(),\n  currentAmount: decimal(\"current_amount\", { precision: 10, scale: 2 }).default(\"0\"),\n  targetDate: timestamp(\"target_date\").notNull(),\n  category: text(\"category\"), // emergency, house, vacation, etc.\n  priority: text(\"priority\").default(\"medium\"), // low, medium, high\n  status: text(\"status\").default(\"active\"), // active, completed, paused\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_goals_user_id\").on(table.userId),\n  index(\"idx_goals_status\").on(table.status),\n]);\n\nexport const transactions = pgTable(\"transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  type: text(\"type\").notNull(), // income, expense, transfer\n  category: text(\"category\").notNull(),\n  description: text(\"description\"),\n  goalId: varchar(\"goal_id\").references(() => financialGoals.id, { onDelete: \"cascade\" }),\n  destination: text(\"destination\"), // For transfer/savings: emergency_fund, general_savings, investment_account, etc.\n  date: timestamp(\"date\").notNull(),\n  isArchived: boolean(\"is_archived\").default(false),\n  isFlagged: boolean(\"is_flagged\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_transactions_user_id\").on(table.userId),\n  index(\"idx_transactions_date\").on(table.date),\n  index(\"idx_transactions_type\").on(table.type),\n]);\n\nexport const budgets = pgTable(\"budgets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  category: text(\"category\").notNull(),\n  monthlyLimit: decimal(\"monthly_limit\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_budgets_user_id\").on(table.userId),\n  unique(\"unique_user_category\").on(table.userId, table.category),\n]);\n\nexport const goalContributions = pgTable(\"goal_contributions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  goalId: varchar(\"goal_id\").notNull().references(() => financialGoals.id, { onDelete: \"cascade\" }),\n  transactionId: varchar(\"transaction_id\").notNull().references(() => transactions.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const goalMilestones = pgTable(\"goal_milestones\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  goalId: varchar(\"goal_id\").notNull().references(() => financialGoals.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  milestone: integer(\"milestone\").notNull(), // 25, 50, 75, 100 (percentage)\n  amountAtMilestone: decimal(\"amount_at_milestone\", { precision: 10, scale: 2 }).notNull(),\n  celebratedAt: timestamp(\"celebrated_at\").defaultNow(),\n  isSeen: boolean(\"is_seen\").default(false),\n}, (table) => [\n  index(\"idx_milestones_goal_id\").on(table.goalId),\n  index(\"idx_milestones_user_id\").on(table.userId),\n  unique(\"unique_goal_milestone\").on(table.goalId, table.milestone),\n]);\n\nexport const userStreaks = pgTable(\"user_streaks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  currentStreak: integer(\"current_streak\").default(0),\n  longestStreak: integer(\"longest_streak\").default(0),\n  totalCheckIns: integer(\"total_check_ins\").default(0),\n  lastCheckIn: timestamp(\"last_check_in\"),\n  weeklyProgress: jsonb(\"weekly_progress\").default([false, false, false, false, false, false, false]),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_streaks_user_id\").on(table.userId),\n]);\n\nexport const userAchievements = pgTable(\"user_achievements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  achievementId: varchar(\"achievement_id\").notNull(),\n  progress: integer(\"progress\").default(0),\n  target: integer(\"target\").notNull(),\n  earnedAt: timestamp(\"earned_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_achievements_user_id\").on(table.userId),\n  unique(\"unique_user_achievement\").on(table.userId, table.achievementId),\n]);\n\nexport const investmentStrategies = pgTable(\"investment_strategies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(), // \"S&P 500 Index Funds\", \"High-Yield Savings\", etc.\n  category: text(\"category\").notNull(), // stocks, bonds, real_estate, crypto, savings, passive_income\n  subcategory: text(\"subcategory\"), // index_funds, reits, dividend_stocks, etc.\n  riskLevel: text(\"risk_level\").notNull(), // very_low, low, moderate, high, very_high\n  expectedReturn: decimal(\"expected_return\", { precision: 5, scale: 2 }).notNull(), // Annual percentage (e.g., 10.00 for 10%)\n  historicalReturn: decimal(\"historical_return\", { precision: 5, scale: 2 }), // Long-term historical average\n  minInvestment: decimal(\"min_investment\", { precision: 10, scale: 2 }), // Minimum amount to start\n  timeHorizon: text(\"time_horizon\").notNull(), // short (< 3 years), medium (3-10 years), long (10+ years)\n  liquidity: text(\"liquidity\").notNull(), // high, medium, low (how quickly you can access money)\n  description: text(\"description\").notNull(), // Detailed explanation\n  pros: text(\"pros\").array(), // Array of advantages\n  cons: text(\"cons\").array(), // Array of disadvantages\n  bestFor: text(\"best_for\").array(), // Who this is best for\n  volatility: text(\"volatility\"), // low, medium, high, very_high\n  taxTreatment: text(\"tax_treatment\"), // tax_deferred, tax_free, taxable, etc.\n  platformSuggestions: text(\"platform_suggestions\").array(), // [\"Vanguard\", \"Fidelity\", etc.]\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_strategies_category\").on(table.category),\n  index(\"idx_strategies_risk_level\").on(table.riskLevel),\n]);\n\nexport const passiveIncomeOpportunities = pgTable(\"passive_income_opportunities\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(), // \"Digital Products\", \"YouTube Content\", \"Airbnb\", etc.\n  category: text(\"category\").notNull(), // digital_products, content_creation, real_estate, investments\n  startupCost: text(\"startup_cost\").notNull(), // very_low, low, medium, high\n  monthlyEarningsMin: decimal(\"monthly_earnings_min\", { precision: 10, scale: 2 }), // Minimum realistic monthly earnings\n  monthlyEarningsMax: decimal(\"monthly_earnings_max\", { precision: 10, scale: 2 }), // Maximum realistic monthly earnings\n  effortLevel: text(\"effort_level\").notNull(), // low, medium, high, very_high (upfront work required)\n  timeToProfit: text(\"time_to_profit\").notNull(), // immediate, 1_3_months, 3_6_months, 6_12_months, 12_plus_months\n  scalability: text(\"scalability\").notNull(), // low, medium, high (can earnings grow significantly?)\n  description: text(\"description\").notNull(),\n  requiredSkills: text(\"required_skills\").array(), // [\"Writing\", \"Marketing\", \"Design\", etc.]\n  platforms: text(\"platforms\").array(), // [\"Etsy\", \"Gumroad\", \"YouTube\", etc.]\n  pros: text(\"pros\").array(),\n  cons: text(\"cons\").array(),\n  bestFor: text(\"best_for\").array(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_passive_income_category\").on(table.category),\n]);\n\nexport const groupInvites = pgTable(\"group_invites\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  groupId: varchar(\"group_id\").notNull().references(() => groups.id, { onDelete: \"cascade\" }),\n  token: text(\"token\").notNull().unique(),\n  role: text(\"role\").default(\"member\"), // owner, admin, member\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  acceptedBy: varchar(\"accepted_by\").references(() => users.id, { onDelete: \"set null\" }),\n  acceptedAt: timestamp(\"accepted_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const calendarShares = pgTable(\"calendar_shares\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  token: text(\"token\").notNull().unique(), // unique share token\n  scope: text(\"scope\", { enum: [\"user\", \"group\"] }).notNull(), // user calendar or group calendar\n  ownerId: varchar(\"owner_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  groupId: varchar(\"group_id\").references(() => groups.id, { onDelete: \"cascade\" }), // null for user scope\n  expiresAt: timestamp(\"expires_at\"),\n  isRevoked: boolean(\"is_revoked\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const friendRequests = pgTable(\"friend_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  fromUserId: varchar(\"from_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  toUserId: varchar(\"to_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  status: text(\"status\", { enum: [\"pending\", \"accepted\", \"declined\"] }).default(\"pending\"),\n  message: text(\"message\"), // optional message with request\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  respondedAt: timestamp(\"responded_at\"),\n});\n\nexport const friendships = pgTable(\"friendships\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  friendId: varchar(\"friend_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => {\n  return {\n    uniqueFriendship: unique().on(table.userId, table.friendId),\n  };\n});\n\n// Shared Goals - Friends can view and optionally contribute to each other's goals\nexport const sharedGoals = pgTable(\"shared_goals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  goalId: varchar(\"goal_id\").notNull().references(() => financialGoals.id, { onDelete: \"cascade\" }),\n  ownerId: varchar(\"owner_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sharedWithUserId: varchar(\"shared_with_user_id\").references(() => users.id, { onDelete: \"cascade\" }), // null for group shares\n  groupId: varchar(\"group_id\").references(() => groups.id, { onDelete: \"cascade\" }), // for sharing with entire group\n  permission: text(\"permission\", { enum: [\"view\", \"contribute\"] }).default(\"view\"), // view-only or can contribute\n  status: text(\"status\", { enum: [\"active\", \"removed\"] }).default(\"active\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => {\n  return {\n    uniqueShare: unique().on(table.goalId, table.sharedWithUserId),\n  };\n});\n\n// Shared Budgets - Friends can track expenses together\nexport const sharedBudgets = pgTable(\"shared_budgets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  totalBudget: decimal(\"total_budget\", { precision: 10, scale: 2 }).notNull(),\n  currentSpent: decimal(\"current_spent\", { precision: 10, scale: 2 }).default(\"0\"),\n  period: text(\"period\", { enum: [\"weekly\", \"monthly\", \"yearly\"] }).default(\"monthly\"),\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  linkedGoalId: varchar(\"linked_goal_id\").references(() => financialGoals.id, { onDelete: \"set null\" }), // link budget to a goal\n  status: text(\"status\", { enum: [\"active\", \"completed\", \"archived\"] }).default(\"active\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Shared Budget Members - Who has access to a shared budget\nexport const sharedBudgetMembers = pgTable(\"shared_budget_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  budgetId: varchar(\"budget_id\").notNull().references(() => sharedBudgets.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  role: text(\"role\", { enum: [\"owner\", \"contributor\"] }).default(\"contributor\"),\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n}, (table) => {\n  return {\n    uniqueMember: unique().on(table.budgetId, table.userId),\n  };\n});\n\n// Shared Budget Expenses - Track expenses in shared budgets\nexport const sharedBudgetExpenses = pgTable(\"shared_budget_expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  budgetId: varchar(\"budget_id\").notNull().references(() => sharedBudgets.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  category: text(\"category\").notNull(),\n  description: text(\"description\"),\n  date: timestamp(\"date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Friend Group Invitations - Invite friends to join groups directly\nexport const friendGroupInvitations = pgTable(\"friend_group_invitations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  groupId: varchar(\"group_id\").notNull().references(() => groups.id, { onDelete: \"cascade\" }),\n  invitedBy: varchar(\"invited_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  invitedUserId: varchar(\"invited_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  role: text(\"role\", { enum: [\"admin\", \"member\"] }).default(\"member\"),\n  status: text(\"status\", { enum: [\"pending\", \"accepted\", \"declined\"] }).default(\"pending\"),\n  message: text(\"message\"), // optional invitation message\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  respondedAt: timestamp(\"responded_at\"),\n}, (table) => {\n  return {\n    uniqueInvitation: unique().on(table.groupId, table.invitedUserId),\n  };\n});\n\nexport const userSettings = pgTable(\"user_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  hourlyRate: decimal(\"hourly_rate\", { precision: 10, scale: 2 }).default(\"50.00\"), // default $50/hour\n  currency: text(\"currency\").default(\"USD\"),\n  workHoursPerWeek: integer(\"work_hours_per_week\").default(40),\n  timeValueStrategy: text(\"time_value_strategy\", { enum: [\"fixed\", \"derived\"] }).default(\"fixed\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const userPreferences = pgTable(\"user_preferences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  theme: text(\"theme\", { enum: [\"light\", \"dark\", \"system\"] }).default(\"system\"),\n  language: text(\"language\").default(\"en\"),\n  timeZone: text(\"time_zone\").default(\"UTC\"),\n  dateFormat: text(\"date_format\").default(\"MM/dd/yyyy\"),\n  currency: text(\"currency\").default(\"USD\"),\n  hasCompletedOnboarding: boolean(\"has_completed_onboarding\").default(false),\n  onboardingStep: integer(\"onboarding_step\"), // 1: Profile, 2: Goals, 3: AI Preferences, null: not started or completed\n  onboardingData: jsonb(\"onboarding_data\").$type<{\n    fullName?: string;\n    incomeRange?: string; // 'under_30k', '30k-60k', '60k-100k', '100k-200k', 'over_200k'\n    riskTolerance?: string; // 'conservative', 'moderate', 'aggressive'\n    savingsTarget?: number;\n    savingsTimeline?: string; // '3months', '6months', '1year', '3years', '5years+'\n    financialPriorities?: string[]; // 'emergency_fund', 'retirement', 'debt_payoff', 'investment', 'major_purchase'\n    notificationFrequency?: string; // 'daily', 'weekly', 'monthly', 'never'\n    adviceStyle?: string; // 'detailed', 'concise', 'conversational'\n    preferredLanguage?: string; // 'en', 'es', 'ar', etc.\n  }>(),\n  emailNotifications: boolean(\"email_notifications\").default(true),\n  pushNotifications: boolean(\"push_notifications\").default(true),\n  marketingEmails: boolean(\"marketing_emails\").default(false),\n  weeklyReports: boolean(\"weekly_reports\").default(true),\n  goalReminders: boolean(\"goal_reminders\").default(true),\n  expenseAlerts: boolean(\"expense_alerts\").default(true),\n  // Crypto & Multi-currency features\n  cryptoEnabled: boolean(\"crypto_enabled\").default(false),\n  experienceLevel: text(\"experience_level\", { enum: [\"beginner\", \"intermediate\", \"advanced\"] }).default(\"beginner\"),\n  preferredCurrencies: text(\"preferred_currencies\").array().default(sql`ARRAY['USD']::text[]`), // e.g., ['USD', 'BTC', 'EUR', 'CNY']\n  // Demo Mode - Show sample data for new users\n  demoMode: boolean(\"demo_mode\").default(true), // New users start in demo mode\n  // Country-aware financial intelligence\n  countryCode: text(\"country_code\").default(\"US\"), // ISO 3166-1 alpha-2 code (e.g., US, GB, JP, DE)\n  // Financial estimates provided by user via AI chat\n  monthlyIncomeEstimate: decimal(\"monthly_income_estimate\", { precision: 10, scale: 2 }),\n  monthlyExpensesEstimate: decimal(\"monthly_expenses_estimate\", { precision: 10, scale: 2 }),\n  currentSavingsEstimate: decimal(\"current_savings_estimate\", { precision: 10, scale: 2 }),\n  // AI Conversation Memory - Stores key insights learned from user conversations\n  conversationMemory: jsonb(\"conversation_memory\").$type<{\n    financialPriorities?: string[]; // e.g., [\"saving for house\", \"planning retirement\"]\n    investmentPreferences?: string[]; // e.g., [\"prefers conservative\", \"interested in tech stocks\"]\n    lifeEvents?: { event: string; timeframe?: string }[]; // e.g., [{ event: \"getting married\", timeframe: \"2026\" }]\n    spendingHabits?: string[]; // e.g., [\"eats out frequently\", \"shops online weekly\"]\n    riskTolerance?: string; // e.g., \"conservative\", \"moderate\", \"aggressive\"\n    lastUpdated?: string; // ISO timestamp of last memory update\n  }>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const financialPreferences = pgTable(\"financial_preferences\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  defaultBudgetPeriod: text(\"default_budget_period\", { enum: [\"weekly\", \"monthly\", \"yearly\"] }).default(\"monthly\"),\n  budgetWarningThreshold: integer(\"budget_warning_threshold\").default(80), // percentage\n  autoSavingsEnabled: boolean(\"auto_savings_enabled\").default(false),\n  autoSavingsAmount: decimal(\"auto_savings_amount\", { precision: 10, scale: 2 }).default(\"0.00\"),\n  autoSavingsFrequency: text(\"auto_savings_frequency\", { enum: [\"weekly\", \"monthly\"] }).default(\"monthly\"),\n  defaultGoalPriority: text(\"default_goal_priority\", { enum: [\"low\", \"medium\", \"high\"] }).default(\"medium\"),\n  expenseCategories: jsonb(\"expense_categories\").default([\n    \"Food & Dining\",\n    \"Transportation\", \n    \"Shopping\",\n    \"Entertainment\",\n    \"Utilities\",\n    \"Healthcare\",\n    \"Education\",\n    \"Travel\",\n    \"Other\"\n  ]),\n  incomeCategories: jsonb(\"income_categories\").default([\n    \"Salary\",\n    \"Freelance\", \n    \"Investment\",\n    \"Business\",\n    \"Gift\",\n    \"Other\"\n  ]),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const privacySettings = pgTable(\"privacy_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  dataRetentionPeriod: integer(\"data_retention_period\").default(365), // days\n  allowAnalytics: boolean(\"allow_analytics\").default(true),\n  allowCookies: boolean(\"allow_cookies\").default(true),\n  shareDataWithPartners: boolean(\"share_data_with_partners\").default(false),\n  profileVisibility: text(\"profile_visibility\", { enum: [\"public\", \"private\", \"friends\"] }).default(\"private\"),\n  allowDataExport: boolean(\"allow_data_export\").default(true),\n  twoFactorEnabled: boolean(\"two_factor_enabled\").default(false),\n  lastPasswordChange: timestamp(\"last_password_change\"),\n  lastDataExport: timestamp(\"last_data_export\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const eventTimeLogs = pgTable(\"event_time_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  startedAt: timestamp(\"started_at\").notNull(),\n  endedAt: timestamp(\"ended_at\"),\n  durationMinutes: integer(\"duration_minutes\"),\n  source: text(\"source\", { enum: [\"timer\", \"manual\"] }).default(\"timer\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const eventExpenses = pgTable(\"event_expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paidBy: varchar(\"paid_by\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  category: text(\"category\"), // food, transport, accommodation, entertainment, etc.\n  receiptUrl: text(\"receipt_url\"), // for receipt uploads\n  date: timestamp(\"date\").notNull(),\n  isShared: boolean(\"is_shared\").default(false), // whether to split among attendees\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const eventExpenseShares = pgTable(\"event_expense_shares\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  expenseId: varchar(\"expense_id\").notNull().references(() => eventExpenses.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  shareAmount: decimal(\"share_amount\", { precision: 10, scale: 2 }).notNull(),\n  isPaid: boolean(\"is_paid\").default(false),\n  paidAt: timestamp(\"paid_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => {\n  return {\n    // Unique constraint to prevent duplicate shares per user per expense\n    expenseUserUnique: unique(\"event_expense_shares_expense_user_unique\").on(table.expenseId, table.userId),\n  };\n});\n\n// User Financial Profile - Core financial data for Personal CFO AI\nexport const userFinancialProfiles = pgTable(\"user_financial_profiles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }).unique(),\n  monthlyIncome: decimal(\"monthly_income\", { precision: 10, scale: 2 }).notNull(),\n  monthlyExpenses: decimal(\"monthly_expenses\", { precision: 10, scale: 2 }).notNull(),\n  monthlySavings: decimal(\"monthly_savings\", { precision: 10, scale: 2 }).notNull(),\n  totalSavings: decimal(\"total_savings\", { precision: 10, scale: 2 }).notNull(),\n  savingsGoal: decimal(\"savings_goal\", { precision: 10, scale: 2 }).notNull(),\n  emergencyFund: decimal(\"emergency_fund\", { precision: 10, scale: 2 }).notNull(),\n  lastUpdated: timestamp(\"last_updated\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_financial_profiles_user_id\").on(table.userId),\n]);\n\n// User Expense Categories - Monthly expense breakdown by category\nexport const userExpenseCategories = pgTable(\"user_expense_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  category: text(\"category\").notNull(), // Food & Dining, Transportation, Shopping, etc.\n  monthlyAmount: decimal(\"monthly_amount\", { precision: 10, scale: 2 }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_expense_categories_user_id\").on(table.userId),\n  unique(\"unique_user_expense_category\").on(table.userId, table.category),\n]);\n\n// User Debts - Individual debts with interest rates and payments\nexport const userDebts = pgTable(\"user_debts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(), // \"Credit Card\", \"Student Loan\", \"Car Loan\", etc.\n  balance: decimal(\"balance\", { precision: 10, scale: 2 }).notNull(), // Current amount owed\n  originalAmount: decimal(\"original_amount\", { precision: 10, scale: 2 }), // Original total debt amount (nullable for existing rows)\n  interestRate: decimal(\"interest_rate\", { precision: 5, scale: 2 }).notNull(), // APR as percentage (e.g., 4.5 for 4.5%)\n  minimumPayment: decimal(\"minimum_payment\", { precision: 10, scale: 2 }).notNull(),\n  monthlyPayment: decimal(\"monthly_payment\", { precision: 10, scale: 2 }).notNull(), // actual payment user makes\n  dueDate: integer(\"due_date\"), // day of month (1-31)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_debts_user_id\").on(table.userId),\n]);\n\n// User Assets - Individual assets with type and value\nexport const userAssets = pgTable(\"user_assets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(), // \"Primary Home\", \"Investment Portfolio\", \"Savings Account\", etc.\n  type: text(\"type\").notNull(), // real_estate, investment, savings, vehicle, other\n  value: decimal(\"value\", { precision: 12, scale: 2 }).notNull(), // Current value\n  purchasePrice: decimal(\"purchase_price\", { precision: 12, scale: 2 }), // Original purchase price (nullable for existing rows)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_assets_user_id\").on(table.userId),\n]);\n\n// Insert schemas for Replit Auth\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Upsert user schema for OAuth - accepts provider-formatted IDs like google_123, facebook_456, apple_789\nexport const upsertUserSchema = createInsertSchema(users).extend({\n  id: z.string().min(1).max(128), // Accept provider-formatted IDs or UUIDs with length limit\n});\nexport type UpsertUser = z.infer<typeof upsertUserSchema>;\n\nexport const insertGroupSchema = createInsertSchema(groups).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertGroupMemberSchema = createInsertSchema(groupMembers).omit({\n  id: true,\n  joinedAt: true,\n});\n\nexport const insertEventSchema = createInsertSchema(events).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  startTime: z.preprocess((val) => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }, z.date()),\n  endTime: z.preprocess((val) => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }, z.date()),\n});\n\nexport const insertFinancialGoalSchema = createInsertSchema(financialGoals).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  targetDate: z.preprocess((val) => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }, z.date()),\n});\n\nexport const insertTransactionSchema = createInsertSchema(transactions).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  userId: z.string().optional(), // Optional - will be set from session on backend\n  category: z.string().optional(), // Optional - backend will auto-categorize if not provided\n  amount: z.preprocess((val) => {\n    if (typeof val === 'number') return val.toFixed(2);\n    if (typeof val === 'string') return val;\n    return val;\n  }, z.string()),\n  date: z.preprocess((val) => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }, z.date()),\n});\n\nexport const insertBudgetSchema = createInsertSchema(budgets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  userId: z.string().optional(), // Will be set from session\n  monthlyLimit: z.preprocess((val) => {\n    if (typeof val === 'number') return val.toFixed(2);\n    if (typeof val === 'string') return val;\n    return val;\n  }, z.string()),\n});\n\nexport const insertGoalContributionSchema = createInsertSchema(goalContributions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertGoalMilestoneSchema = createInsertSchema(goalMilestones).omit({\n  id: true,\n  celebratedAt: true,\n  isSeen: true,\n});\n\nexport const insertUserStreakSchema = createInsertSchema(userStreaks).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertUserAchievementSchema = createInsertSchema(userAchievements).omit({\n  id: true,\n  createdAt: true,\n  earnedAt: true,\n});\n\nexport const insertInvestmentStrategySchema = createInsertSchema(investmentStrategies).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertPassiveIncomeOpportunitySchema = createInsertSchema(passiveIncomeOpportunities).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertGroupInviteSchema = createInsertSchema(groupInvites).omit({\n  id: true,\n  token: true,\n  acceptedBy: true,\n  acceptedAt: true,\n  createdAt: true,\n}).extend({\n  role: z.enum([\"owner\", \"admin\", \"member\"]).default(\"member\"),\n});\n\nexport const insertCalendarShareSchema = createInsertSchema(calendarShares).omit({\n  id: true,\n  token: true,\n  createdAt: true,\n}).extend({\n  scope: z.enum([\"user\", \"group\"]),\n}).refine((data) => {\n  if (data.scope === \"user\") return !!data.ownerId && !data.groupId;\n  if (data.scope === \"group\") return !!data.ownerId && !!data.groupId;\n  return false;\n}, {\n  message: \"scope='user' requires ownerId only, scope='group' requires both ownerId and groupId\",\n});\n\nexport const insertFriendRequestSchema = createInsertSchema(friendRequests).omit({\n  id: true,\n  createdAt: true,\n  respondedAt: true,\n}).extend({\n  status: z.enum([\"pending\", \"accepted\", \"declined\"]).default(\"pending\"),\n});\n\nexport const insertFriendshipSchema = createInsertSchema(friendships).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSharedGoalSchema = createInsertSchema(sharedGoals).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  permission: z.enum([\"view\", \"contribute\"]).default(\"view\"),\n  status: z.enum([\"active\", \"removed\"]).default(\"active\"),\n});\n\nexport const insertSharedBudgetSchema = createInsertSchema(sharedBudgets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  totalBudget: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  currentSpent: z.union([z.string(), z.number()]).transform(val => val.toString()).default(\"0\"),\n  period: z.enum([\"weekly\", \"monthly\", \"yearly\"]).default(\"monthly\"),\n  status: z.enum([\"active\", \"completed\", \"archived\"]).default(\"active\"),\n});\n\nexport const insertSharedBudgetMemberSchema = createInsertSchema(sharedBudgetMembers).omit({\n  id: true,\n  joinedAt: true,\n}).extend({\n  role: z.enum([\"owner\", \"contributor\"]).default(\"contributor\"),\n});\n\nexport const insertSharedBudgetExpenseSchema = createInsertSchema(sharedBudgetExpenses).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  amount: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  date: z.preprocess((val) => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }, z.date()),\n});\n\nexport const insertFriendGroupInvitationSchema = createInsertSchema(friendGroupInvitations).omit({\n  id: true,\n  createdAt: true,\n  respondedAt: true,\n}).extend({\n  role: z.enum([\"admin\", \"member\"]).default(\"member\"),\n  status: z.enum([\"pending\", \"accepted\", \"declined\"]).default(\"pending\"),\n});\n\nexport const insertEventExpenseSchema = createInsertSchema(eventExpenses).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  // Allow both string and number for amount, then convert to string\n  amount: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertEventExpenseShareSchema = createInsertSchema(eventExpenseShares).omit({\n  id: true,\n  createdAt: true,\n  paidAt: true,\n}).extend({\n  // Allow both string and number for shareAmount, then convert to string\n  shareAmount: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertUserSettingsSchema = createInsertSchema(userSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  hourlyRate: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  timeValueStrategy: z.enum([\"fixed\", \"derived\"]).default(\"fixed\"),\n});\n\nexport const insertUserPreferencesSchema = createInsertSchema(userPreferences).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  theme: z.enum([\"light\", \"dark\", \"system\"]).default(\"system\"),\n  conversationMemory: z.object({\n    financialPriorities: z.array(z.string()).optional(),\n    investmentPreferences: z.array(z.string()).optional(),\n    lifeEvents: z.array(z.object({\n      event: z.string(),\n      timeframe: z.string().optional()\n    })).optional(),\n    spendingHabits: z.array(z.string()).optional(),\n    riskTolerance: z.string().optional(),\n    lastUpdated: z.string().optional()\n  }).optional(),\n});\n\nexport const insertFinancialPreferencesSchema = createInsertSchema(financialPreferences).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  defaultBudgetPeriod: z.enum([\"weekly\", \"monthly\", \"yearly\"]).default(\"monthly\"),\n  autoSavingsFrequency: z.enum([\"weekly\", \"monthly\"]).default(\"monthly\"),\n  defaultGoalPriority: z.enum([\"low\", \"medium\", \"high\"]).default(\"medium\"),\n  autoSavingsAmount: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertPrivacySettingsSchema = createInsertSchema(privacySettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastPasswordChange: true,\n  lastDataExport: true,\n}).extend({\n  profileVisibility: z.enum([\"public\", \"private\", \"friends\"]).default(\"private\"),\n});\n\nexport const insertEventTimeLogSchema = createInsertSchema(eventTimeLogs).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  source: z.enum([\"timer\", \"manual\"]).default(\"timer\"),\n});\n\n// Financial Profile Insert Schemas\nexport const insertUserFinancialProfileSchema = createInsertSchema(userFinancialProfiles).omit({\n  id: true,\n  createdAt: true,\n  lastUpdated: true,\n}).extend({\n  monthlyIncome: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  monthlyExpenses: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  monthlySavings: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  totalSavings: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  savingsGoal: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  emergencyFund: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertUserExpenseCategorySchema = createInsertSchema(userExpenseCategories).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  monthlyAmount: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertUserDebtSchema = createInsertSchema(userDebts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  balance: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  interestRate: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  minimumPayment: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  monthlyPayment: z.union([z.string(), z.number()]).transform(val => val.toString()),\n});\n\nexport const insertUserAssetSchema = createInsertSchema(userAssets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  value: z.union([z.string(), z.number()]).transform(val => val.toString()),\n  type: z.enum([\"real_estate\", \"investment\", \"savings\", \"vehicle\", \"other\"]),\n});\n\n// Move this down after notifications table is defined\n\n// Event attendee schema for type consistency\nexport const eventAttendeeSchema = z.object({\n  userId: z.string(),\n  status: z.enum([\"yes\", \"no\", \"maybe\"]),\n});\n\nexport type EventAttendee = z.infer<typeof eventAttendeeSchema>;\n\n// Types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type Group = typeof groups.$inferSelect;\nexport type InsertGroup = z.infer<typeof insertGroupSchema>;\n\nexport type GroupMember = typeof groupMembers.$inferSelect;\nexport type InsertGroupMember = z.infer<typeof insertGroupMemberSchema>;\n\nexport type Event = typeof events.$inferSelect;\nexport type InsertEvent = z.infer<typeof insertEventSchema>;\n\nexport type FinancialGoal = typeof financialGoals.$inferSelect;\nexport type InsertFinancialGoal = z.infer<typeof insertFinancialGoalSchema>;\n\nexport type Transaction = typeof transactions.$inferSelect;\nexport type InsertTransaction = z.infer<typeof insertTransactionSchema>;\n\nexport type Budget = typeof budgets.$inferSelect;\nexport type InsertBudget = z.infer<typeof insertBudgetSchema>;\n\nexport type GoalContribution = typeof goalContributions.$inferSelect;\nexport type InsertGoalContribution = z.infer<typeof insertGoalContributionSchema>;\n\nexport type GoalMilestone = typeof goalMilestones.$inferSelect;\nexport type InsertGoalMilestone = z.infer<typeof insertGoalMilestoneSchema>;\n\nexport type UserStreak = typeof userStreaks.$inferSelect;\nexport type InsertUserStreak = z.infer<typeof insertUserStreakSchema>;\n\nexport type UserAchievement = typeof userAchievements.$inferSelect;\nexport type InsertUserAchievement = z.infer<typeof insertUserAchievementSchema>;\n\nexport type InvestmentStrategy = typeof investmentStrategies.$inferSelect;\nexport type InsertInvestmentStrategy = z.infer<typeof insertInvestmentStrategySchema>;\n\nexport type PassiveIncomeOpportunity = typeof passiveIncomeOpportunities.$inferSelect;\nexport type InsertPassiveIncomeOpportunity = z.infer<typeof insertPassiveIncomeOpportunitySchema>;\n\nexport type GroupInvite = typeof groupInvites.$inferSelect;\nexport type InsertGroupInvite = z.infer<typeof insertGroupInviteSchema>;\n\nexport type CalendarShare = typeof calendarShares.$inferSelect;\nexport type InsertCalendarShare = z.infer<typeof insertCalendarShareSchema>;\n\nexport type FriendRequest = typeof friendRequests.$inferSelect;\nexport type InsertFriendRequest = z.infer<typeof insertFriendRequestSchema>;\n\nexport type Friendship = typeof friendships.$inferSelect;\nexport type InsertFriendship = z.infer<typeof insertFriendshipSchema>;\n\nexport type SharedGoal = typeof sharedGoals.$inferSelect;\nexport type InsertSharedGoal = z.infer<typeof insertSharedGoalSchema>;\n\nexport type SharedBudget = typeof sharedBudgets.$inferSelect;\nexport type InsertSharedBudget = z.infer<typeof insertSharedBudgetSchema>;\n\nexport type SharedBudgetMember = typeof sharedBudgetMembers.$inferSelect;\nexport type InsertSharedBudgetMember = z.infer<typeof insertSharedBudgetMemberSchema>;\n\nexport type SharedBudgetExpense = typeof sharedBudgetExpenses.$inferSelect;\nexport type InsertSharedBudgetExpense = z.infer<typeof insertSharedBudgetExpenseSchema>;\n\nexport type FriendGroupInvitation = typeof friendGroupInvitations.$inferSelect;\nexport type InsertFriendGroupInvitation = z.infer<typeof insertFriendGroupInvitationSchema>;\n\nexport type EventExpense = typeof eventExpenses.$inferSelect;\nexport type InsertEventExpense = z.infer<typeof insertEventExpenseSchema>;\n\nexport type EventExpenseShare = typeof eventExpenseShares.$inferSelect;\nexport type InsertEventExpenseShare = z.infer<typeof insertEventExpenseShareSchema>;\n\nexport type UserSettings = typeof userSettings.$inferSelect;\nexport type InsertUserSettings = z.infer<typeof insertUserSettingsSchema>;\n\nexport type UserPreferences = typeof userPreferences.$inferSelect;\nexport type InsertUserPreferences = z.infer<typeof insertUserPreferencesSchema>;\n\nexport type FinancialPreferences = typeof financialPreferences.$inferSelect;\nexport type InsertFinancialPreferences = z.infer<typeof insertFinancialPreferencesSchema>;\n\nexport type PrivacySettings = typeof privacySettings.$inferSelect;\nexport type InsertPrivacySettings = z.infer<typeof insertPrivacySettingsSchema>;\n\nexport type EventTimeLog = typeof eventTimeLogs.$inferSelect;\nexport type InsertEventTimeLog = z.infer<typeof insertEventTimeLogSchema>;\n\nexport type UserFinancialProfile = typeof userFinancialProfiles.$inferSelect;\nexport type InsertUserFinancialProfile = z.infer<typeof insertUserFinancialProfileSchema>;\n\nexport type UserExpenseCategory = typeof userExpenseCategories.$inferSelect;\nexport type InsertUserExpenseCategory = z.infer<typeof insertUserExpenseCategorySchema>;\n\nexport type UserDebt = typeof userDebts.$inferSelect;\nexport type InsertUserDebt = z.infer<typeof insertUserDebtSchema>;\n\nexport type UserAsset = typeof userAssets.$inferSelect;\nexport type InsertUserAsset = z.infer<typeof insertUserAssetSchema>;\n\nexport type Notification = typeof notifications.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\n\n// Relations\nexport const usersRelations = relations(users, ({ many, one }) => ({\n  groups: many(groups),\n  groupMemberships: many(groupMembers),\n  events: many(events),\n  financialGoals: many(financialGoals),\n  transactions: many(transactions),\n  createdInvites: many(groupInvites, { relationName: \"createdBy\" }),\n  acceptedInvites: many(groupInvites, { relationName: \"acceptedBy\" }),\n  calendarShares: many(calendarShares),\n  notifications: many(notifications),\n  sentFriendRequests: many(friendRequests, { relationName: \"fromUser\" }),\n  receivedFriendRequests: many(friendRequests, { relationName: \"toUser\" }),\n  friendships: many(friendships, { relationName: \"userFriends\" }),\n  friendOf: many(friendships, { relationName: \"friendOf\" }),\n  financialProfile: one(userFinancialProfiles),\n  expenseCategories: many(userExpenseCategories),\n  debts: many(userDebts),\n  assets: many(userAssets),\n}));\n\nexport const friendRequestsRelations = relations(friendRequests, ({ one }) => ({\n  fromUser: one(users, {\n    fields: [friendRequests.fromUserId],\n    references: [users.id],\n    relationName: \"fromUser\",\n  }),\n  toUser: one(users, {\n    fields: [friendRequests.toUserId],\n    references: [users.id],\n    relationName: \"toUser\",\n  }),\n}));\n\nexport const friendshipsRelations = relations(friendships, ({ one }) => ({\n  user: one(users, {\n    fields: [friendships.userId],\n    references: [users.id],\n    relationName: \"userFriends\",\n  }),\n  friend: one(users, {\n    fields: [friendships.friendId],\n    references: [users.id],\n    relationName: \"friendOf\",\n  }),\n}));\n\nexport const groupsRelations = relations(groups, ({ one, many }) => ({\n  owner: one(users, {\n    fields: [groups.ownerId],\n    references: [users.id],\n  }),\n  members: many(groupMembers),\n  events: many(events),\n  invites: many(groupInvites),\n  calendarShares: many(calendarShares),\n}));\n\nexport const groupMembersRelations = relations(groupMembers, ({ one }) => ({\n  group: one(groups, {\n    fields: [groupMembers.groupId],\n    references: [groups.id],\n  }),\n  user: one(users, {\n    fields: [groupMembers.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const eventsRelations = relations(events, ({ one, many }) => ({\n  creator: one(users, {\n    fields: [events.createdBy],\n    references: [users.id],\n  }),\n  group: one(groups, {\n    fields: [events.groupId],\n    references: [groups.id],\n  }),\n  linkedGoal: one(financialGoals, {\n    fields: [events.linkedGoalId],\n    references: [financialGoals.id],\n  }),\n  expenses: many(eventExpenses),\n}));\n\n\nexport const transactionsRelations = relations(transactions, ({ one }) => ({\n  user: one(users, {\n    fields: [transactions.userId],\n    references: [users.id],\n  }),\n  goal: one(financialGoals, {\n    fields: [transactions.goalId],\n    references: [financialGoals.id],\n  }),\n}));\n\nexport const goalContributionsRelations = relations(goalContributions, ({ one }) => ({\n  goal: one(financialGoals, {\n    fields: [goalContributions.goalId],\n    references: [financialGoals.id],\n  }),\n  transaction: one(transactions, {\n    fields: [goalContributions.transactionId],\n    references: [transactions.id],\n  }),\n}));\n\nexport const goalMilestonesRelations = relations(goalMilestones, ({ one }) => ({\n  goal: one(financialGoals, {\n    fields: [goalMilestones.goalId],\n    references: [financialGoals.id],\n  }),\n  user: one(users, {\n    fields: [goalMilestones.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const groupInvitesRelations = relations(groupInvites, ({ one }) => ({\n  group: one(groups, {\n    fields: [groupInvites.groupId],\n    references: [groups.id],\n  }),\n  creator: one(users, {\n    fields: [groupInvites.createdBy],\n    references: [users.id],\n    relationName: \"createdBy\",\n  }),\n  acceptedByUser: one(users, {\n    fields: [groupInvites.acceptedBy],\n    references: [users.id],\n    relationName: \"acceptedBy\",\n  }),\n}));\n\nexport const eventExpensesRelations = relations(eventExpenses, ({ one, many }) => ({\n  event: one(events, {\n    fields: [eventExpenses.eventId],\n    references: [events.id],\n  }),\n  paidByUser: one(users, {\n    fields: [eventExpenses.paidBy],\n    references: [users.id],\n  }),\n  shares: many(eventExpenseShares),\n}));\n\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  type: text(\"type\").notNull(), // goal_deadline, transaction_reminder, goal_complete, budget_warning, suggestion\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  priority: text(\"priority\").default(\"normal\"), // low, normal, high, urgent\n  category: text(\"category\").notNull(), // goals, transactions, budget, achievements, suggestions\n  isRead: boolean(\"is_read\").default(false),\n  isArchived: boolean(\"is_archived\").default(false),\n  data: jsonb(\"data\").default({}), // Additional context data (goalId, transactionId, etc.)\n  actionType: text(\"action_type\"), // add_transaction, create_goal, view_goal, etc.\n  actionData: jsonb(\"action_data\").default({}), // Data for action buttons\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  readAt: timestamp(\"read_at\"),\n});\n\nexport const eventExpenseSharesRelations = relations(eventExpenseShares, ({ one }) => ({\n  expense: one(eventExpenses, {\n    fields: [eventExpenseShares.expenseId],\n    references: [eventExpenses.id],\n  }),\n  user: one(users, {\n    fields: [eventExpenseShares.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const calendarSharesRelations = relations(calendarShares, ({ one }) => ({\n  owner: one(users, {\n    fields: [calendarShares.ownerId],\n    references: [users.id],\n  }),\n  group: one(groups, {\n    fields: [calendarShares.groupId],\n    references: [groups.id],\n  }),\n}));\n\nexport const financialGoalsRelations = relations(financialGoals, ({ one, many }) => ({\n  user: one(users, {\n    fields: [financialGoals.userId],\n    references: [users.id],\n  }),\n  transactions: many(transactions),\n  contributions: many(goalContributions),\n  linkedEvents: many(events, { relationName: \"linkedGoal\" }),\n}));\n\nexport const userFinancialProfilesRelations = relations(userFinancialProfiles, ({ one }) => ({\n  user: one(users, {\n    fields: [userFinancialProfiles.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const userExpenseCategoriesRelations = relations(userExpenseCategories, ({ one }) => ({\n  user: one(users, {\n    fields: [userExpenseCategories.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const userDebtsRelations = relations(userDebts, ({ one }) => ({\n  user: one(users, {\n    fields: [userDebts.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const userAssetsRelations = relations(userAssets, ({ one }) => ({\n  user: one(users, {\n    fields: [userAssets.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n  readAt: true,\n}).extend({\n  priority: z.enum([\"low\", \"normal\", \"high\", \"urgent\"]).default(\"normal\"),\n  category: z.enum([\"goals\", \"transactions\", \"budget\", \"achievements\", \"suggestions\"]),\n});\n\nexport const notificationsRelations = relations(notifications, ({ one }) => ({\n  user: one(users, {\n    fields: [notifications.userId],\n    references: [users.id],\n  }),\n}));\n\n// AI Chat Tables\nexport const chatConversations = pgTable(\"chat_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").default(\"New Conversation\"),\n  isActive: boolean(\"is_active\").default(true),\n  lastMessageAt: timestamp(\"last_message_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").notNull().references(() => chatConversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\", { enum: [\"user\", \"assistant\"] }).notNull(),\n  content: text(\"content\").notNull(),\n  userContext: jsonb(\"user_context\"), // Financial data at time of message\n  tokenCount: integer(\"token_count\").default(0),\n  cost: decimal(\"cost\", { precision: 10, scale: 4 }).default(\"0.0000\"), // Track API costs\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// AI Message Feedback/Rating Table\nexport const messageFeedback = pgTable(\"message_feedback\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").notNull().references(() => chatMessages.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  rating: text(\"rating\", { enum: [\"helpful\", \"not_helpful\"] }).notNull(),\n  feedbackText: text(\"feedback_text\"), // Optional detailed feedback\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  unique(\"unique_user_message_feedback\").on(table.userId, table.messageId)\n]);\n\nexport const insertChatConversationSchema = createInsertSchema(chatConversations).omit({\n  id: true,\n  createdAt: true,\n  lastMessageAt: true,\n});\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageFeedbackSchema = createInsertSchema(messageFeedback).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type ChatConversation = typeof chatConversations.$inferSelect;\nexport type InsertChatConversation = z.infer<typeof insertChatConversationSchema>;\n\nexport type ChatMessage = typeof chatMessages.$inferSelect;\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\n\nexport type MessageFeedback = typeof messageFeedback.$inferSelect;\nexport type InsertMessageFeedback = z.infer<typeof insertMessageFeedbackSchema>;\n\nexport const chatConversationsRelations = relations(chatConversations, ({ one, many }) => ({\n  user: one(users, {\n    fields: [chatConversations.userId],\n    references: [users.id],\n  }),\n  messages: many(chatMessages),\n}));\n\nexport const chatMessagesRelations = relations(chatMessages, ({ one, many }) => ({\n  conversation: one(chatConversations, {\n    fields: [chatMessages.conversationId],\n    references: [chatConversations.id],\n  }),\n  feedback: many(messageFeedback),\n}));\n\nexport const messageFeedbackRelations = relations(messageFeedback, ({ one }) => ({\n  message: one(chatMessages, {\n    fields: [messageFeedback.messageId],\n    references: [chatMessages.id],\n  }),\n  user: one(users, {\n    fields: [messageFeedback.userId],\n    references: [users.id],\n  }),\n}));\n\n// Subscription Management Tables\nexport const subscriptionPlans = pgTable(\"subscription_plans\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(), // \"Free\", \"Pro\", \"Enterprise\"\n  displayName: text(\"display_name\").notNull(), // \"Twealth Free\", \"Twealth Pro\"\n  description: text(\"description\"),\n  priceThb: decimal(\"price_thb\", { precision: 10, scale: 2 }).notNull(), // Price in THB\n  priceUsd: decimal(\"price_usd\", { precision: 10, scale: 2 }).notNull(), // Price in USD\n  currency: text(\"currency\").default(\"USD\"),\n  stripePriceId: text(\"stripe_price_id\"), // Stripe Price ID (e.g., price_xxx from Stripe dashboard)\n  billingInterval: text(\"billing_interval\").notNull(), // \"monthly\", \"yearly\", \"lifetime\"\n  // AI Usage Limits - Hybrid AI System (Scout/Sonnet/GPT-5/Opus)\n  scoutLimit: integer(\"scout_limit\").default(0), // Scout queries per period (null = unlimited for paid tiers)\n  sonnetLimit: integer(\"sonnet_limit\").default(0), // Sonnet (reasoning) queries per period\n  gpt5Limit: integer(\"gpt5_limit\").default(0), // GPT-5 (advanced math) queries per period\n  opusLimit: integer(\"opus_limit\").default(0), // Opus (enterprise CFO) queries per period\n  // Legacy AI Limits (for backward compatibility)\n  aiChatLimit: integer(\"ai_chat_limit\").default(0), // Messages per period (monthly or lifetime)\n  aiDeepAnalysisLimit: integer(\"ai_deep_analysis_limit\").default(0), // Complex queries per period\n  aiInsightsFrequency: text(\"ai_insights_frequency\").default(\"never\"), // \"never\", \"weekly\", \"daily\"\n  isLifetimeLimit: boolean(\"is_lifetime_limit\").default(false), // true = no reset (Free), false = monthly reset (Pro)\n  // Feature Access\n  features: jsonb(\"features\").default([]), // Array of feature names\n  isActive: boolean(\"is_active\").default(true),\n  sortOrder: integer(\"sort_order\").default(0), // For display ordering\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const subscriptions = pgTable(\"subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  planId: varchar(\"plan_id\").notNull().references(() => subscriptionPlans.id),\n  status: text(\"status\").notNull(), // \"active\", \"cancelled\", \"past_due\", \"incomplete\"\n  currentPeriodStart: timestamp(\"current_period_start\").notNull(),\n  currentPeriodEnd: timestamp(\"current_period_end\").notNull(),\n  cancelledAt: timestamp(\"cancelled_at\"),\n  trialEnd: timestamp(\"trial_end\"),\n  // Payment tracking\n  stripeSubscriptionId: text(\"stripe_subscription_id\").unique(),\n  stripeCustomerId: text(\"stripe_customer_id\"),\n  // Regional pricing\n  localCurrency: text(\"local_currency\").default(\"THB\"),\n  localPrice: decimal(\"local_price\", { precision: 10, scale: 2 }),\n  // Free premium access for special users\n  freePremium: boolean(\"free_premium\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const usageTracking = pgTable(\"usage_tracking\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  subscriptionId: varchar(\"subscription_id\").references(() => subscriptions.id, { onDelete: \"set null\" }),\n  // Tracking period\n  periodStart: timestamp(\"period_start\").notNull(),\n  periodEnd: timestamp(\"period_end\").notNull(),\n  // Hybrid AI Usage counters (Scout/Sonnet/GPT-5/Opus)\n  scoutQueriesUsed: integer(\"scout_queries_used\").default(0),\n  sonnetQueriesUsed: integer(\"sonnet_queries_used\").default(0),\n  gpt5QueriesUsed: integer(\"gpt5_queries_used\").default(0),\n  opusQueriesUsed: integer(\"opus_queries_used\").default(0),\n  // Legacy AI Usage counters (for backward compatibility)\n  aiChatsUsed: integer(\"ai_chats_used\").default(0),\n  aiDeepAnalysisUsed: integer(\"ai_deep_analysis_used\").default(0),\n  aiInsightsGenerated: integer(\"ai_insights_generated\").default(0),\n  // Cost tracking\n  totalTokensUsed: integer(\"total_tokens_used\").default(0),\n  estimatedCostUsd: decimal(\"estimated_cost_usd\", { precision: 10, scale: 4 }).default(\"0\"),\n  // Last updated\n  lastResetAt: timestamp(\"last_reset_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => ({\n  // Unique constraint to ensure one usage record per user per period\n  uniqueUserPeriod: unique().on(table.userId, table.periodStart),\n}));\n\nexport const subscriptionAddOns = pgTable(\"subscription_add_ons\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  subscriptionId: varchar(\"subscription_id\").notNull().references(() => subscriptions.id, { onDelete: \"cascade\" }),\n  addOnType: text(\"add_on_type\").notNull(), // \"extra_chats\", \"extra_deep_analysis\"\n  quantity: integer(\"quantity\").notNull(), // How many units purchased\n  priceThb: decimal(\"price_thb\", { precision: 10, scale: 2 }).notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  isActive: boolean(\"is_active\").default(true),\n  stripePaymentIntentId: text(\"stripe_payment_intent_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Referral system tables\nexport const referralCodes = pgTable(\"referral_codes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  code: text(\"code\").notNull().unique(), // Unique referral code (e.g., \"ALEX123\")\n  maxUses: integer(\"max_uses\").default(100), // Maximum number of times it can be used\n  currentUses: integer(\"current_uses\").default(0), // Current number of uses\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  expiresAt: timestamp(\"expires_at\"), // Optional expiration date\n});\n\nexport const referrals = pgTable(\"referrals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  referrerUserId: varchar(\"referrer_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  referredUserId: varchar(\"referred_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  referralCodeId: varchar(\"referral_code_id\").notNull().references(() => referralCodes.id, { onDelete: \"cascade\" }),\n  status: text(\"status\").default(\"pending\"), // pending, completed, cancelled\n  bonusCreditsPaid: boolean(\"bonus_credits_paid\").default(false),\n  completedAt: timestamp(\"completed_at\"), // When referred user completed required action (e.g., upgraded)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const bonusCredits = pgTable(\"bonus_credits\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  amount: integer(\"amount\").notNull(), // Number of bonus AI credits\n  source: text(\"source\").notNull(), // \"referral_made\", \"referral_signup\", \"promotion\", etc.\n  referralId: varchar(\"referral_id\").references(() => referrals.id, { onDelete: \"set null\" }),\n  description: text(\"description\"), // Human-readable description\n  expiresAt: timestamp(\"expires_at\"), // Optional expiration date for credits\n  isUsed: boolean(\"is_used\").default(false),\n  usedAt: timestamp(\"used_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Stripe Webhook Event Idempotency - Persisted to survive server restarts\nexport const webhookEvents = pgTable(\"webhook_events\", {\n  id: varchar(\"id\").primaryKey(), // Stripe event ID (evt_xxx)\n  eventType: text(\"event_type\").notNull(), // checkout.session.completed, etc.\n  processedAt: timestamp(\"processed_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_webhook_events_processed_at\").on(table.processedAt),\n]);\n\n// Crypto tracking tables\nexport const cryptoHoldings = pgTable(\"crypto_holdings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  coinId: varchar(\"coin_id\", { length: 50 }).notNull(), // CoinGecko ID: bitcoin, ethereum\n  symbol: varchar(\"symbol\", { length: 20 }).notNull(), // BTC, ETH, etc.\n  name: text(\"name\").notNull(), // Bitcoin, Ethereum\n  amount: decimal(\"amount\", { precision: 20, scale: 8 }).notNull(), // Support small fractions\n  averageBuyPrice: decimal(\"average_buy_price\", { precision: 20, scale: 2 }), // USD price when bought\n  currentPrice: decimal(\"current_price\", { precision: 20, scale: 2 }), // Current USD price (cached)\n  source: text(\"source\").default(\"manual\"), // manual, coinbase, binance, wallet\n  walletAddress: text(\"wallet_address\"), // For blockchain wallet tracking\n  notes: text(\"notes\"),\n  lastPriceUpdate: timestamp(\"last_price_update\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const cryptoPriceAlerts = pgTable(\"crypto_price_alerts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  symbol: varchar(\"symbol\", { length: 20 }).notNull(), // BTC, ETH\n  targetPrice: decimal(\"target_price\", { precision: 20, scale: 2 }).notNull(),\n  condition: text(\"condition\", { enum: [\"above\", \"below\"] }).notNull(),\n  isActive: boolean(\"is_active\").default(true),\n  triggered: boolean(\"triggered\").default(false),\n  triggeredAt: timestamp(\"triggered_at\"),\n  notificationSent: boolean(\"notification_sent\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const cryptoTransactions = pgTable(\"crypto_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  holdingId: varchar(\"holding_id\").references(() => cryptoHoldings.id, { onDelete: \"set null\" }),\n  type: text(\"type\", { enum: [\"buy\", \"sell\", \"transfer_in\", \"transfer_out\"] }).notNull(),\n  symbol: varchar(\"symbol\", { length: 20 }).notNull(),\n  amount: decimal(\"amount\", { precision: 20, scale: 8 }).notNull(),\n  pricePerUnit: decimal(\"price_per_unit\", { precision: 20, scale: 2 }).notNull(), // USD price at transaction\n  totalValue: decimal(\"total_value\", { precision: 20, scale: 2 }).notNull(), // Total USD value\n  fee: decimal(\"fee\", { precision: 20, scale: 2 }).default(\"0\"),\n  notes: text(\"notes\"),\n  transactionDate: timestamp(\"transaction_date\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// AI Usage Logs - Detailed tracking of individual AI queries\nexport const aiUsageLogs = pgTable(\"ai_usage_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  subscriptionId: varchar(\"subscription_id\").references(() => subscriptions.id, { onDelete: \"set null\" }),\n  // Query details\n  query: text(\"query\").notNull(), // User's question\n  response: text(\"response\"), // AI's response (optional, can be large)\n  // Model & routing\n  modelUsed: text(\"model_used\").notNull(), // \"scout\", \"sonnet\", \"opus\"\n  modelName: text(\"model_name\").notNull(), // Full model name (e.g., \"meta-llama/llama-4-scout-17b-16e-instruct\")\n  escalated: boolean(\"escalated\").default(false), // Was it escalated from Scout to Reasoning?\n  escalationReason: text(\"escalation_reason\"), // Why was it escalated?\n  orchestratorUsed: text(\"orchestrator_used\"), // debt, retirement, tax, portfolio, etc.\n  // Token usage\n  tokensIn: integer(\"tokens_in\").notNull(),\n  tokensOut: integer(\"tokens_out\").notNull(),\n  totalTokens: integer(\"total_tokens\").notNull(),\n  // Cost tracking\n  costUsd: decimal(\"cost_usd\", { precision: 10, scale: 6 }).notNull(), // Cost in USD\n  // Performance\n  responseTimeMs: integer(\"response_time_ms\"), // How long the query took\n  // Subscription tier at time of query\n  tierAtQuery: text(\"tier_at_query\"), // \"free\", \"pro\", \"enterprise\"\n  // Metadata\n  ipAddress: text(\"ip_address\"), // For abuse detection\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_ai_logs_user_id\").on(table.userId),\n  index(\"idx_ai_logs_model_used\").on(table.modelUsed),\n  index(\"idx_ai_logs_created_at\").on(table.createdAt),\n]);\n\n// AI Financial Playbooks - Weekly automated insights\nexport const playbooks = pgTable(\"playbooks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  subscriptionId: varchar(\"subscription_id\").references(() => subscriptions.id, { onDelete: \"set null\" }),\n  // Time period\n  weekStartDate: timestamp(\"week_start_date\").notNull(), // Monday of the week\n  weekEndDate: timestamp(\"week_end_date\").notNull(), // Sunday of the week\n  // Financial Pulse (Hero Card)\n  financialHealthScore: integer(\"financial_health_score\").notNull(), // 0-100\n  scoreDelta: integer(\"score_delta\").notNull(), // Change from last week\n  confidenceBand: text(\"confidence_band\"), // \"improving\", \"stable\", \"declining\"\n  // Insight Highlights (JSON array)\n  insights: jsonb(\"insights\").notNull(), // [{text: string, tag: string, severity: \"high\"|\"medium\"|\"low\"}]\n  insightsCount: integer(\"insights_count\").notNull(), // 2/5/7 based on tier\n  // Action Queue (JSON array)\n  actions: jsonb(\"actions\").notNull(), // [{title: string, description: string, effort: \"low\"|\"medium\"|\"high\", impact: \"low\"|\"medium\"|\"high\", deepLink: string}]\n  actionsCount: integer(\"actions_count\").default(3), // Top 3 prioritized\n  // Measurable Impact\n  roiSavings: decimal(\"roi_savings\", { precision: 10, scale: 2 }).default(\"0\"), // Money saved this week from AI advice\n  cumulativeRoi: decimal(\"cumulative_roi\", { precision: 10, scale: 2 }).default(\"0\"), // Total savings to date\n  forecastLift: text(\"forecast_lift\"), // e.g., \"+5% net worth by year-end\"\n  // Generation metadata\n  tier: text(\"tier\").notNull(), // \"free\", \"pro\", \"enterprise\"\n  generatedBy: text(\"generated_by\").notNull(), // \"gpt5\", \"opus\"\n  generationTimeMs: integer(\"generation_time_ms\"),\n  tokensUsed: integer(\"tokens_used\"),\n  // Engagement tracking\n  isViewed: boolean(\"is_viewed\").default(false),\n  viewedAt: timestamp(\"viewed_at\"),\n  actionsCompleted: integer(\"actions_completed\").default(0), // How many actions user marked done\n  completedActionIndices: jsonb(\"completed_action_indices\").default([]), // Array of indices of completed actions to prevent duplicates\n  shareCount: integer(\"share_count\").default(0), // Times user shared playbook\n  // Metadata\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_playbooks_user_id\").on(table.userId),\n  index(\"idx_playbooks_week_start\").on(table.weekStartDate),\n  index(\"idx_playbooks_created_at\").on(table.createdAt),\n]);\n\n// Subscription schema exports\nexport const insertSubscriptionPlanSchema = createInsertSchema(subscriptionPlans).omit({ id: true, createdAt: true });\nexport const insertSubscriptionSchema = createInsertSchema(subscriptions).omit({ id: true, createdAt: true });\nexport const insertUsageTrackingSchema = createInsertSchema(usageTracking).omit({ id: true, createdAt: true });\nexport const insertSubscriptionAddOnSchema = createInsertSchema(subscriptionAddOns).omit({ id: true, createdAt: true });\n\n// Referral schema exports\nexport const insertReferralCodeSchema = createInsertSchema(referralCodes).omit({ id: true, createdAt: true });\nexport const insertReferralSchema = createInsertSchema(referrals).omit({ id: true, createdAt: true });\nexport const insertBonusCreditSchema = createInsertSchema(bonusCredits).omit({ id: true, createdAt: true });\n\n// Crypto schema exports\nexport const insertCryptoHoldingSchema = createInsertSchema(cryptoHoldings).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertCryptoPriceAlertSchema = createInsertSchema(cryptoPriceAlerts).omit({ id: true, createdAt: true });\nexport const insertCryptoTransactionSchema = createInsertSchema(cryptoTransactions).omit({ id: true, createdAt: true });\n\n// AI Usage Logs schema exports\nexport const insertAiUsageLogSchema = createInsertSchema(aiUsageLogs).omit({ id: true, createdAt: true });\n\n// Playbooks schema exports\nexport const insertPlaybookSchema = createInsertSchema(playbooks).omit({ id: true, createdAt: true, viewedAt: true });\n\n// Subscription types\nexport type SubscriptionPlan = typeof subscriptionPlans.$inferSelect;\nexport type Subscription = typeof subscriptions.$inferSelect;\nexport type UsageTracking = typeof usageTracking.$inferSelect;\nexport type SubscriptionAddOn = typeof subscriptionAddOns.$inferSelect;\n\nexport type InsertSubscriptionPlan = z.infer<typeof insertSubscriptionPlanSchema>;\nexport type InsertSubscription = z.infer<typeof insertSubscriptionSchema>;\nexport type InsertUsageTracking = z.infer<typeof insertUsageTrackingSchema>;\nexport type InsertSubscriptionAddOn = z.infer<typeof insertSubscriptionAddOnSchema>;\n\n// Referral types\nexport type ReferralCode = typeof referralCodes.$inferSelect;\nexport type Referral = typeof referrals.$inferSelect;\nexport type BonusCredit = typeof bonusCredits.$inferSelect;\n\nexport type InsertReferralCode = z.infer<typeof insertReferralCodeSchema>;\nexport type InsertReferral = z.infer<typeof insertReferralSchema>;\nexport type InsertBonusCredit = z.infer<typeof insertBonusCreditSchema>;\n\n// Crypto types\nexport type CryptoHolding = typeof cryptoHoldings.$inferSelect;\nexport type CryptoPriceAlert = typeof cryptoPriceAlerts.$inferSelect;\nexport type CryptoTransaction = typeof cryptoTransactions.$inferSelect;\n\nexport type InsertCryptoHolding = z.infer<typeof insertCryptoHoldingSchema>;\nexport type InsertCryptoPriceAlert = z.infer<typeof insertCryptoPriceAlertSchema>;\nexport type InsertCryptoTransaction = z.infer<typeof insertCryptoTransactionSchema>;\n\n// AI Usage Logs types\nexport type AiUsageLog = typeof aiUsageLogs.$inferSelect;\nexport type InsertAiUsageLog = z.infer<typeof insertAiUsageLogSchema>;\n\n// Playbooks types\nexport type Playbook = typeof playbooks.$inferSelect;\nexport type InsertPlaybook = z.infer<typeof insertPlaybookSchema>;\n\n// Subscription relations\nexport const subscriptionPlansRelations = relations(subscriptionPlans, ({ many }) => ({\n  subscriptions: many(subscriptions),\n}));\n\nexport const subscriptionsRelations = relations(subscriptions, ({ one, many }) => ({\n  user: one(users, {\n    fields: [subscriptions.userId],\n    references: [users.id],\n  }),\n  plan: one(subscriptionPlans, {\n    fields: [subscriptions.planId],\n    references: [subscriptionPlans.id],\n  }),\n  usageRecords: many(usageTracking),\n  addOns: many(subscriptionAddOns),\n}));\n\nexport const usageTrackingRelations = relations(usageTracking, ({ one }) => ({\n  user: one(users, {\n    fields: [usageTracking.userId],\n    references: [users.id],\n  }),\n  subscription: one(subscriptions, {\n    fields: [usageTracking.subscriptionId],\n    references: [subscriptions.id],\n  }),\n}));\n\nexport const subscriptionAddOnsRelations = relations(subscriptionAddOns, ({ one }) => ({\n  user: one(users, {\n    fields: [subscriptionAddOns.userId],\n    references: [users.id],\n  }),\n  subscription: one(subscriptions, {\n    fields: [subscriptionAddOns.subscriptionId],\n    references: [subscriptions.id],\n  }),\n}));\n\n// Referral relations\nexport const referralCodesRelations = relations(referralCodes, ({ one, many }) => ({\n  user: one(users, {\n    fields: [referralCodes.userId],\n    references: [users.id],\n  }),\n  referrals: many(referrals),\n}));\n\nexport const referralsRelations = relations(referrals, ({ one, many }) => ({\n  referrer: one(users, {\n    fields: [referrals.referrerUserId],\n    references: [users.id],\n  }),\n  referred: one(users, {\n    fields: [referrals.referredUserId],\n    references: [users.id],\n  }),\n  referralCode: one(referralCodes, {\n    fields: [referrals.referralCodeId],\n    references: [referralCodes.id],\n  }),\n  bonusCredits: many(bonusCredits),\n}));\n\nexport const bonusCreditsRelations = relations(bonusCredits, ({ one }) => ({\n  user: one(users, {\n    fields: [bonusCredits.userId],\n    references: [users.id],\n  }),\n  referral: one(referrals, {\n    fields: [bonusCredits.referralId],\n    references: [referrals.id],\n  }),\n}));\n","path":null,"size_bytes":76656,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as TooltipPrimitive from\"@radix-ui/react-tooltip\"\n\nimport { cn } from\"../../lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n React.ElementRef<typeof TooltipPrimitive.Content>,\n React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n <TooltipPrimitive.Content\n  ref={ref}\n  sideOffset={sideOffset}\n  className={cn(\n  \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n   className\n  )}\n  {...props}\n />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1170,"size_tokens":null},"client/src/components/dashboard/monthly-progress-chart.tsx":{"content":"import { useState } from\"react\";\nimport { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, AreaChart } from 'recharts';\n\nexport default function MonthlyProgressChart() {\n const [period, setPeriod] = useState(\"6months\");\n \n const { data: transactions, isLoading } = useQuery({\n  queryKey: [\"/api/transactions\"],\n });\n \n const { data: stats } = useQuery({\n  queryKey: [\"/api/dashboard/stats\"],\n });\n \n const monthlyTarget = Math.max(parseFloat((stats as any)?.monthlyIncome ||\"5000\"), 5000);\n \n const monthsToShow = period ===\"12months\" ? 12 : period ===\"year\" ? 12 : 6;\n \n const generateMonthlyData = () => {\n  const now = new Date();\n  const months = [];\n  const monthlyIncome: Record<string, number> = {};\n  \n  for (let i = monthsToShow - 1; i >= 0; i--) {\n   const date = new Date(now.getFullYear(), now.getMonth() - i, 1);\n   const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n   const monthLabel = date.toLocaleDateString('en-US', { month: 'short' });\n   months.push({ key: monthKey, label: monthLabel, date });\n   monthlyIncome[monthKey] = 0;\n  }\n  \n  if (Array.isArray(transactions)) {\n   transactions.forEach((transaction: any) => {\n    if (transaction.type === 'income') {\n     const transactionDate = new Date(transaction.date);\n     const monthKey = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;\n     if (monthlyIncome.hasOwnProperty(monthKey)) {\n      monthlyIncome[monthKey] += parseFloat(transaction.amount);\n     }\n    }\n   });\n  }\n  \n  return months.map((month, index) => ({\n   month: month.label,\n   income: Math.round(monthlyIncome[month.key]),\n   target: monthlyTarget,\n   projected: index === months.length - 1 && month.date.getMonth() === now.getMonth(),\n  }));\n };\n \n const monthlyData = isLoading ? [] : generateMonthlyData();\n const maxValue = Math.max(monthlyTarget, ...monthlyData.map(d => d.income), 1);\n const currentMonth = monthlyData.length > 0 ? monthlyData[monthlyData.length - 1] : { month:\"Now\", income: 0, target: monthlyTarget };\n\n if (isLoading) {\n  return (\n   <Card className=\"p-6 shadow-sm\">\n    <div>\n     <div className=\"h-6 bg-muted rounded w-1/3 mb-6\"></div>\n     <div className=\"h-64 bg-muted/20 rounded-lg mb-4\"></div>\n     <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4\">\n      {[...Array(3)].map((_, i) => (\n       <div key={i} className=\"h-16 bg-muted/50 rounded-lg\"></div>\n      ))}\n     </div>\n    </div>\n   </Card>\n  );\n }\n\n return (\n  <Card className=\"p-6 shadow-sm\">\n   <CardHeader className=\"p-0 mb-6\">\n    <div className=\"flex items-center justify-between\">\n     <CardTitle className=\"text-xl font-semibold\">Monthly Financial Progress</CardTitle>\n     <Select value={period} onValueChange={setPeriod}>\n      <SelectTrigger className=\"w-40\" data-testid=\"select-period\">\n       <SelectValue />\n      </SelectTrigger>\n      <SelectContent>\n       <SelectItem value=\"6months\">Last 6 months</SelectItem>\n       <SelectItem value=\"12months\">Last 12 months</SelectItem>\n       <SelectItem value=\"year\">This year</SelectItem>\n      </SelectContent>\n     </Select>\n    </div>\n   </CardHeader>\n   \n   <CardContent className=\"p-0\">\n    {/* Beautiful Recharts Visualization */}\n    <div className=\"h-80\">\n     <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <BarChart \n       data={monthlyData} \n       margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\n      >\n       <defs>\n        <linearGradient id=\"colorIncome\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n         <stop offset=\"5%\" stopColor=\"#3b82f6\" stopOpacity={0.9}/>\n         <stop offset=\"95%\" stopColor=\"#8b5cf6\" stopOpacity={0.9}/>\n        </linearGradient>\n        <linearGradient id=\"colorTarget\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n         <stop offset=\"5%\" stopColor=\"#10b981\" stopOpacity={0.6}/>\n         <stop offset=\"95%\" stopColor=\"#6ee7b7\" stopOpacity={0.6}/>\n        </linearGradient>\n       </defs>\n       <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" opacity={0.3} />\n       <XAxis \n        dataKey=\"month\" \n        tick={{ fill: '#6b7280', fontSize: 12 }}\n        tickLine={false}\n       />\n       <YAxis \n        tick={{ fill: '#6b7280', fontSize: 12 }}\n        tickLine={false}\n        tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}\n       />\n       <Tooltip \n        contentStyle={{ \n         backgroundColor: 'rgba(255, 255, 255, 0.95)', \n         border: '1px solid #e5e7eb',\n         borderRadius: '8px',\n         boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'\n        }}\n        formatter={(value: any) => [`$${value.toLocaleString()}`, '']}\n        labelStyle={{ fontWeight: 600, marginBottom: 4 }}\n       />\n       <Legend \n        wrapperStyle={{ paddingTop: 20 }}\n        iconType=\"square\"\n       />\n       <Bar \n        dataKey=\"income\" \n        name=\"Income\" \n        fill=\"url(#colorIncome)\" \n        radius={[8, 8, 0, 0]}\n        animationDuration={1000}\n        data-testid=\"chart-bar-income\"\n       />\n       <Bar \n        dataKey=\"target\" \n        name=\"Target\" \n        fill=\"url(#colorTarget)\" \n        radius={[8, 8, 0, 0]}\n        animationDuration={1000}\n        fillOpacity={0.7}\n        data-testid=\"chart-bar-target\"\n       />\n      </BarChart>\n     </ResponsiveContainer>\n    </div>\n    \n    {/* Summary Stats */}\n    <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-4\">\n     <div className=\"text-center p-3 bg-muted/50 rounded-lg\">\n      <p className=\"text-sm text-muted-foreground\">This Month</p>\n      <p className=\"text-lg font-semibold text-foreground\" data-testid=\"text-current-month-income\">\n       ${currentMonth.income.toLocaleString()}\n      </p>\n     </div>\n     <div className=\"text-center p-3 bg-muted/50 rounded-lg\">\n      <p className=\"text-sm text-muted-foreground\">Monthly Target</p>\n      <p className=\"text-lg font-semibold text-foreground\" data-testid=\"text-monthly-target\">\n       ${currentMonth.target.toLocaleString()}\n      </p>\n     </div>\n     <div className=\"text-center p-3 bg-muted/50 rounded-lg\">\n      <p className=\"text-sm text-muted-foreground\">Remaining</p>\n      <p className=\"text-lg font-semibold text-primary\" data-testid=\"text-remaining-target\">\n       ${(currentMonth.target - currentMonth.income).toLocaleString()}\n      </p>\n     </div>\n    </div>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":6587,"size_tokens":null},"client/src/components/forms/goal-form.tsx":{"content":"import { useState } from\"react\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient, useQuery } from\"@tanstack/react-query\";\nimport { z } from\"zod\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Textarea } from\"@/components/ui/textarea\";\nimport { Label } from\"@/components/ui/label\";\nimport { DialogHeader, DialogTitle, DialogDescription } from\"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { Checkbox } from\"@/components/ui/checkbox\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { useUser } from\"@/lib/userContext\";\nimport { Users, Loader2, Target, AlertCircle } from\"lucide-react\";\n\nconst goalFormSchema = z.object({\n title: z.string().min(1,\"Goal title is required\"),\n description: z.string().optional(),\n targetAmount: z.string().min(1,\"Target amount is required\").refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0,\"Must be a valid positive number\"),\n currentAmount: z.string().optional().refine((val) => !val || (!isNaN(parseFloat(val)) && parseFloat(val) >= 0),\"Must be a valid positive number\"),\n targetDate: z.string().min(1,\"Target date is required\"),\n category: z.string().optional(),\n priority: z.enum([\"low\",\"medium\",\"high\"]).default(\"medium\"),\n});\n\ntype GoalFormData = z.infer<typeof goalFormSchema>;\n\ninterface GoalFormProps {\n onSuccess?: () => void;\n}\n\nconst GOAL_CATEGORIES = [\n\"emergency\",\n\"house\",\n\"vacation\",\n\"car\",\n\"education\",\n\"retirement\",\n\"investment\",\n\"other\"\n];\n\nexport default function GoalForm({ onSuccess }: GoalFormProps) {\n const [isSubmitting, setIsSubmitting] = useState(false);\n const [shareWithGroup, setShareWithGroup] = useState(false);\n const [selectedGroupId, setSelectedGroupId] = useState<string>(\"\");\n const [groupPermission, setGroupPermission] = useState<\"view\" |\"can_contribute\">(\"view\");\n const { toast } = useToast();\n const queryClient = useQueryClient();\n const { user, isLoading: userLoading } = useUser();\n\n // Fetch user's groups\n const { data: groups } = useQuery({\n  queryKey: [\"/api/groups\"],\n  enabled: !!user,\n });\n\n const {\n  register,\n  handleSubmit,\n  setValue,\n  watch,\n  formState: { errors },\n } = useForm<GoalFormData>({\n  resolver: zodResolver(goalFormSchema),\n  defaultValues: {\n   currentAmount:\"0\",\n   priority:\"medium\",\n   targetDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 1 year from now\n  },\n });\n\n const createGoalMutation = useMutation({\n  mutationFn: async (data: GoalFormData) => {\n   const response = await apiRequest(\"POST\",\"/api/financial-goals\", {\n    ...data,\n    targetAmount: data.targetAmount, // Keep as string for decimal field\n    currentAmount: data.currentAmount ||\"0\", // Keep as string for decimal field\n    targetDate: new Date(data.targetDate), // Send as Date object for timestamp field\n   });\n   return await response.json();\n  },\n  onMutate: async (newGoal: GoalFormData) => {\n   // Cancel outgoing refetches\n   await queryClient.cancelQueries({ queryKey: [\"/api/financial-goals\"] });\n   \n   // Snapshot previous data\n   const previousGoals = queryClient.getQueryData([\"/api/financial-goals\"]);\n   \n   // Create optimistic goal with temporary ID\n   const optimisticGoal = {\n    id: `temp-${Date.now()}`,\n    userId: user?.id,\n    title: newGoal.title,\n    targetAmount: newGoal.targetAmount,\n    currentAmount: newGoal.currentAmount ||\"0\",\n    targetDate: new Date(newGoal.targetDate).toISOString(),\n    priority: newGoal.priority,\n    category: newGoal.category,\n    description: newGoal.description,\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n   };\n   \n   // Optimistically update cache\n   queryClient.setQueryData([\"/api/financial-goals\"], (old: any) => \n    Array.isArray(old) ? [optimisticGoal, ...old] : [optimisticGoal]\n   );\n   \n   return { previousGoals };\n  },\n  onSuccess: async (createdGoal: any) => {\n   // If sharing with group, call the share API\n   if (shareWithGroup && selectedGroupId) {\n    try {\n     await apiRequest(\"POST\", `/api/goals/${createdGoal.id}/share-with-group`, {\n      groupId: selectedGroupId,\n      permission: groupPermission,\n     });\n     toast({\n      title:\"Goal created and shared\",\n      description:\"Your goal has been created and shared with the group.\",\n      icon: <Target className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n     });\n    } catch (error: any) {\n     toast({\n      title:\"Goal created but sharing failed\",\n      description: error.message,\n      variant:\"destructive\",\n      icon: <AlertCircle className=\"h-5 w-5\" />,\n     });\n    }\n   } else {\n    toast({\n     title:\"Goal created\",\n     description:\"Your financial goal has been created successfully.\",\n     icon: <Target className=\"h-5 w-5 text-green-600 dark:text-green-400\" />,\n    });\n   }\n   \n   queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n   queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n   onSuccess?.();\n  },\n  onError: (error: any, _variables, context) => {\n   // Rollback on error\n   if (context?.previousGoals) {\n    queryClient.setQueryData([\"/api/financial-goals\"], context.previousGoals);\n   }\n   \n   const isNetworkError = error.message?.includes('fetch') || error.message?.includes('network');\n   toast({\n    title:\"Couldn't Create Goal\",\n    description: isNetworkError \n     ?\"Check your internet connection and try again.\"\n     : error.message ||\"Please check your goal details and try again.\",\n    variant:\"destructive\",\n    icon: <AlertCircle className=\"h-5 w-5\" />,\n   });\n  },\n  onSettled: () => {\n   setIsSubmitting(false);\n  },\n });\n\n const onSubmit = (data: GoalFormData) => {\n  // Validate target date is in the future\n  if (new Date(data.targetDate) <= new Date()) {\n   toast({\n    title:\"Invalid date\",\n    description:\"Target date must be in the future.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n\n  // Validate current amount doesn't exceed target amount\n  const current = parseFloat(data.currentAmount ||\"0\");\n  const target = parseFloat(data.targetAmount);\n  if (current > target) {\n   toast({\n    title:\"Invalid amounts\",\n    description:\"Current amount cannot exceed target amount.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n\n  if (!user) {\n   toast({\n    title:\"Sign In Required\",\n    description:\"Please sign in to create financial goals and track your progress.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n  \n  setIsSubmitting(true);\n  createGoalMutation.mutate(data);\n };\n\n return (\n  <>\n   <DialogHeader>\n    <DialogTitle>Create Financial Goal</DialogTitle>\n    <DialogDescription>\n     Set a target amount and date for your financial goal\n    </DialogDescription>\n   </DialogHeader>\n   \n   <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-5\">\n    {/* Goal Title - Most Important */}\n    <div>\n     <Label htmlFor=\"title\" className=\"text-base font-semibold\">What are you saving for?</Label>\n     <Input\n      id=\"title\"\n      {...register(\"title\")}\n      placeholder=\"Emergency Fund\"\n      className=\"mt-2 h-12 text-base\"\n      data-testid=\"input-goal-title\"\n     />\n     {errors.title && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.title.message}</p>\n     )}\n    </div>\n\n    {/* Target Amount - Critical */}\n    <div>\n     <Label htmlFor=\"targetAmount\" className=\"text-base font-semibold\">How much do you need?</Label>\n     <div className=\"relative mt-2\">\n      <span className=\"absolute left-4 top-1/2 -translate-y-1/2 text-lg text-muted-foreground\">$</span>\n      <Input\n       id=\"targetAmount\"\n       type=\"number\"\n       step=\"0.01\"\n       min=\"0\"\n       {...register(\"targetAmount\")}\n       placeholder=\"10,000\"\n       className=\"h-12 pl-8 text-lg\"\n       data-testid=\"input-goal-target-amount\"\n      />\n     </div>\n     {errors.targetAmount && (\n      <p className=\"text-sm text-destructive mt-1\">{errors.targetAmount.message}</p>\n     )}\n    </div>\n\n    {/* Target Date - Important */}\n    <div>\n     <Label htmlFor=\"targetDate\" className=\"text-base font-semibold\">When do you need it by?</Label>\n     <Input\n      id=\"targetDate\"\n      type=\"date\"\n      {...register(\"targetDate\")}\n      className=\"mt-2 h-12 text-base\"\n      data-testid=\"input-goal-target-date\"\n     />\n     {errors.targetDate && (\n      <p className=\"text-sm text-destructive mt-1\">{String(errors.targetDate.message)}</p>\n     )}\n    </div>\n\n    {/* Category - Helpful */}\n    <div>\n     <Label htmlFor=\"category\" className=\"text-sm font-medium\">Category</Label>\n     <Select value={watch(\"category\") ||\"\"} onValueChange={(value) => setValue(\"category\", value || undefined)}>\n      <SelectTrigger className=\"mt-1.5 h-11\" data-testid=\"select-goal-category\">\n       <SelectValue placeholder=\"Select category\" />\n      </SelectTrigger>\n      <SelectContent>\n       {GOAL_CATEGORIES.map((category) => (\n        <SelectItem key={category} value={category}>\n         {category.charAt(0).toUpperCase() + category.slice(1)}\n        </SelectItem>\n       ))}\n      </SelectContent>\n     </Select>\n    </div>\n\n    {/* Group Sharing Section */}\n    {Array.isArray(groups) && groups.length > 0 && (\n     <div className=\"border rounded-lg p-4 space-y-4 bg-muted/30\">\n      <div className=\"flex items-center space-x-2\">\n       <Checkbox \n        id=\"shareWithGroup\" \n        checked={shareWithGroup} \n        onCheckedChange={(checked) => setShareWithGroup(checked as boolean)}\n        data-testid=\"checkbox-share-with-group\"\n       />\n       <Label htmlFor=\"shareWithGroup\" className=\"flex items-center gap-2 cursor-pointer\">\n        <Users className=\"w-4 h-4\" />\n        Share with Group\n       </Label>\n      </div>\n\n      {shareWithGroup && (\n       <div className=\"space-y-3 pl-6\">\n        <div>\n         <Label htmlFor=\"groupSelect\">Select Group</Label>\n         <Select value={selectedGroupId} onValueChange={setSelectedGroupId}>\n          <SelectTrigger data-testid=\"select-share-group\">\n           <SelectValue placeholder=\"Choose a group\" />\n          </SelectTrigger>\n          <SelectContent>\n           {(groups as any[]).map((group: any) => (\n            <SelectItem key={group.id} value={group.id}>\n             {group.name}\n            </SelectItem>\n           ))}\n          </SelectContent>\n         </Select>\n        </div>\n\n        <div>\n         <Label htmlFor=\"permissionSelect\">Permission Level</Label>\n         <Select value={groupPermission} onValueChange={(val) => setGroupPermission(val as\"view\" |\"can_contribute\")}>\n          <SelectTrigger data-testid=\"select-group-permission\">\n           <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n           <SelectItem value=\"view\">View Only</SelectItem>\n           <SelectItem value=\"can_contribute\">Can Contribute</SelectItem>\n          </SelectContent>\n         </Select>\n         <p className=\"text-xs text-muted-foreground mt-1\">\n          {groupPermission ===\"view\" \n           ?\"Group members can view this goal but cannot contribute\"\n           :\"Group members can view and add money to this goal\"}\n         </p>\n        </div>\n       </div>\n      )}\n     </div>\n    )}\n\n    <div className=\"flex justify-end space-x-2 pt-4\">\n     <Button\n      type=\"submit\"\n      disabled={isSubmitting}\n      className=\"min-w-[140px]\"\n      data-testid=\"button-submit-goal\"\n     >\n      {isSubmitting ? (\n       <>\n        <Loader2 className=\"mr-2 h-4 w-4\" />\n        Creating...\n       </>\n      ) : (\n      \"Create Goal\"\n      )}\n     </Button>\n    </div>\n   </form>\n  </>\n );\n}\n","path":null,"size_bytes":11665,"size_tokens":null},"client/src/components/dashboard/notification-actions.tsx":{"content":"import { useState } from\"react\";\nimport { useLocation } from\"wouter\";\nimport { \n Dialog, \n DialogContent, \n DialogDescription,\n DialogHeader,\n DialogTitle \n} from\"@/components/ui/dialog\";\nimport TransactionForm from\"@/components/forms/transaction-form\";\nimport GoalForm from\"@/components/forms/goal-form\";\nimport AddFundsForm from\"@/components/forms/add-funds-form\";\nimport { useToast } from\"@/hooks/use-toast\";\n\ninterface NotificationActionHandler {\n openTransactionForm: (data?: any) => void;\n openGoalForm: (data?: any) => void;\n openAddFundsForm: (goalId: string, goalTitle: string, currentAmount: string, targetAmount: string) => void;\n navigateToTransactions: (category?: string) => void;\n navigateToGoal: (goalId: string) => void;\n}\n\ninterface NotificationActionsProps {\n children: (handlers: NotificationActionHandler) => React.ReactNode;\n}\n\nexport default function NotificationActions({ children }: NotificationActionsProps) {\n const [isTransactionFormOpen, setIsTransactionFormOpen] = useState(false);\n const [isGoalFormOpen, setIsGoalFormOpen] = useState(false);\n const [isAddFundsFormOpen, setIsAddFundsFormOpen] = useState(false);\n const [addFundsData, setAddFundsData] = useState<{\n  goalId: string;\n  goalTitle: string;\n  currentAmount: string;\n  targetAmount: string;\n } | null>(null);\n const [transactionFormData, setTransactionFormData] = useState<any>(null);\n const [goalFormData, setGoalFormData] = useState<any>(null);\n \n const [, setLocation] = useLocation();\n const { toast } = useToast();\n\n const handlers: NotificationActionHandler = {\n  openTransactionForm: (data) => {\n   setTransactionFormData(data);\n   setIsTransactionFormOpen(true);\n  },\n\n  openGoalForm: (data) => {\n   setGoalFormData(data);\n   setIsGoalFormOpen(true);\n  },\n\n  openAddFundsForm: (goalId, goalTitle, currentAmount, targetAmount) => {\n   setAddFundsData({ goalId, goalTitle, currentAmount, targetAmount });\n   setIsAddFundsFormOpen(true);\n  },\n\n  navigateToTransactions: (category) => {\n   if (category) {\n    setLocation(`/money-tracking?category=${category}`);\n   } else {\n    setLocation('/money-tracking');\n   }\n   toast({\n    title:\"Navigating to Transactions\",\n    description: category ? `Showing ${category} transactions` :\"Viewing all transactions\",\n   });\n  },\n\n  navigateToGoal: (goalId) => {\n   setLocation(`/financial-goals`);\n   toast({\n    title:\"Navigating to Goal\",\n    description:\"Opening financial goals page\",\n   });\n  }\n };\n\n const handleTransactionFormSuccess = () => {\n  setIsTransactionFormOpen(false);\n  setTransactionFormData(null);\n  toast({\n   title:\"Transaction Added\",\n   description:\"Your transaction has been recorded successfully.\",\n  });\n };\n\n const handleGoalFormSuccess = () => {\n  setIsGoalFormOpen(false);\n  setGoalFormData(null);\n  toast({\n   title:\"Goal Created\",\n   description:\"Your financial goal has been created successfully.\",\n  });\n };\n\n const handleAddFundsSuccess = () => {\n  setIsAddFundsFormOpen(false);\n  setAddFundsData(null);\n };\n\n return (\n  <>\n   {children(handlers)}\n\n   {/* Transaction Form Modal */}\n   <Dialog open={isTransactionFormOpen} onOpenChange={setIsTransactionFormOpen}>\n    <DialogContent className=\"max-w-lg\">\n     <DialogHeader>\n      <DialogTitle>Add Transaction</DialogTitle>\n      <DialogDescription>\n       Record a new income, expense, or transfer transaction.\n      </DialogDescription>\n     </DialogHeader>\n     <TransactionForm onSuccess={handleTransactionFormSuccess} />\n    </DialogContent>\n   </Dialog>\n\n   {/* Goal Form Modal */}\n   <Dialog open={isGoalFormOpen} onOpenChange={setIsGoalFormOpen}>\n    <DialogContent className=\"max-w-lg\">\n     <DialogHeader>\n      <DialogTitle>Create Financial Goal</DialogTitle>\n      <DialogDescription>\n       Set up a new savings goal to track your progress.\n      </DialogDescription>\n     </DialogHeader>\n     <GoalForm onSuccess={handleGoalFormSuccess} />\n    </DialogContent>\n   </Dialog>\n\n   {/* Add Funds Form Modal */}\n   {addFundsData && (\n    <Dialog open={isAddFundsFormOpen} onOpenChange={setIsAddFundsFormOpen}>\n     <DialogContent className=\"max-w-lg\">\n      <DialogHeader>\n       <DialogTitle>Add Funds to Goal</DialogTitle>\n       <DialogDescription>\n        Add money to your\"{addFundsData.goalTitle}\" goal.\n       </DialogDescription>\n      </DialogHeader>\n      <AddFundsForm\n       goalId={addFundsData.goalId}\n       goalTitle={addFundsData.goalTitle}\n       currentAmount={addFundsData.currentAmount}\n       targetAmount={addFundsData.targetAmount}\n       onSuccess={handleAddFundsSuccess}\n      />\n     </DialogContent>\n    </Dialog>\n   )}\n  </>\n );\n}","path":null,"size_bytes":4592,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n\nexport function useMediaQuery(query: string) {\n  const [matches, setMatches] = React.useState<boolean>(false)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(query)\n    const onChange = (e: MediaQueryListEvent) => {\n      setMatches(e.matches)\n    }\n    \n    setMatches(mql.matches)\n    mql.addEventListener(\"change\", onChange)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [query])\n\n  return matches\n}\n","path":null,"size_bytes":1002,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from\"react\"\nimport * as SheetPrimitive from\"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from\"class-variance-authority\"\nimport { X } from\"lucide-react\"\n\nimport { cn } from\"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n React.ElementRef<typeof SheetPrimitive.Overlay>,\n React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n <SheetPrimitive.Overlay\n  className={cn(\n  \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n   className\n  )}\n  {...props}\n  ref={ref}\n />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n\"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n {\n  variants: {\n   side: {\n    top:\"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n    bottom:\n    \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n    left:\"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n    right:\n    \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n   },\n  },\n  defaultVariants: {\n   side:\"right\",\n  },\n }\n)\n\ninterface SheetContentProps\n extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n  VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n React.ElementRef<typeof SheetPrimitive.Content>,\n SheetContentProps\n>(({ side =\"right\", className, children, ...props }, ref) => (\n <SheetPortal>\n  <SheetOverlay />\n  <SheetPrimitive.Content\n   ref={ref}\n   className={cn(sheetVariants({ side }), className)}\n   {...props}\n  >\n   {children}\n   <SheetPrimitive.Close className=\"absolute right-2 top-2 rounded-md opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary p-2 min-w-[44px] min-h-[44px] flex items-center justify-center\">\n    <X className=\"h-5 w-5\" />\n    <span className=\"sr-only\">Close</span>\n   </SheetPrimitive.Close>\n  </SheetPrimitive.Content>\n </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col space-y-2 text-center sm:text-left\",\n   className\n  )}\n  {...props}\n />\n)\nSheetHeader.displayName =\"SheetHeader\"\n\nconst SheetFooter = ({\n className,\n ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n <div\n  className={cn(\n  \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n   className\n  )}\n  {...props}\n />\n)\nSheetFooter.displayName =\"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n React.ElementRef<typeof SheetPrimitive.Title>,\n React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n <SheetPrimitive.Title\n  ref={ref}\n  className={cn(\"text-lg font-semibold text-foreground\", className)}\n  {...props}\n />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n React.ElementRef<typeof SheetPrimitive.Description>,\n React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n <SheetPrimitive.Description\n  ref={ref}\n  className={cn(\"text-sm text-muted-foreground\", className)}\n  {...props}\n />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n Sheet,\n SheetPortal,\n SheetOverlay,\n SheetTrigger,\n SheetClose,\n SheetContent,\n SheetHeader,\n SheetFooter,\n SheetTitle,\n SheetDescription,\n}\n","path":null,"size_bytes":4158,"size_tokens":null},"client/src/i18n/index.ts":{"content":"import i18n from 'i18next';\nimport { initReactI18next } from 'react-i18next';\nimport LanguageDetector from 'i18next-browser-languagedetector';\n\n// Translation resources\nimport en from './locales/en.json';\nimport es from './locales/es.json';\nimport id from './locales/id.json';\nimport th from './locales/th.json';\nimport pt from './locales/pt.json';\nimport hi from './locales/hi.json';\nimport vi from './locales/vi.json';\nimport tl from './locales/tl.json';\nimport ms from './locales/ms.json';\nimport tr from './locales/tr.json';\nimport ar from './locales/ar.json';\n\nconst resources = {\n en: { translation: en },\n es: { translation: es },\n id: { translation: id },\n th: { translation: th },\n pt: { translation: pt },\n hi: { translation: hi },\n vi: { translation: vi },\n tl: { translation: tl },\n ms: { translation: ms },\n tr: { translation: tr },\n ar: { translation: ar }\n};\n\ni18n\n .use(LanguageDetector)\n .use(initReactI18next)\n .init({\n  resources,\n  fallbackLng: 'en',\n  \n  detection: {\n   order: ['localStorage', 'navigator', 'htmlTag'],\n   caches: ['localStorage']\n  },\n  \n  interpolation: {\n   escapeValue: false\n  },\n  \n  react: {\n   useSuspense: false\n  }\n });\n\nexport default i18n;","path":null,"size_bytes":1189,"size_tokens":null},"client/src/components/rtl-provider.tsx":{"content":"import { useEffect } from 'react';\nimport { useTranslation } from 'react-i18next';\n\n// Languages that use RTL (right-to-left) text direction\nconst RTL_LANGUAGES = ['ar', 'he', 'fa', 'ur'];\n\nexport function RTLProvider({ children }: { children: React.ReactNode }) {\n const { i18n } = useTranslation();\n\n useEffect(() => {\n  const isRTL = RTL_LANGUAGES.includes(i18n.language);\n  const direction = isRTL ? 'rtl' : 'ltr';\n  \n  // Set direction on HTML element\n  document.documentElement.setAttribute('dir', direction);\n  document.documentElement.setAttribute('lang', i18n.language);\n  \n  // Add/remove RTL class for CSS styling\n  if (isRTL) {\n   document.documentElement.classList.add('rtl');\n  } else {\n   document.documentElement.classList.remove('rtl');\n  }\n }, [i18n.language]);\n\n return <>{children}</>;\n}\n","path":null,"size_bytes":808,"size_tokens":null},"client/src/hooks/useLocale.ts":{"content":"// React hook for locale-aware formatting\nimport { useTranslation } from 'react-i18next';\nimport { \n formatDateLocale, \n formatRelativeTime, \n formatRelativeDate,\n formatNumber,\n formatCurrencyLocale,\n formatPercentage,\n getDateFormatPattern,\n getTimeFormatPattern \n} from '@/lib/locale';\n\nexport function useLocale() {\n const { i18n } = useTranslation();\n const currentLanguage = i18n.language || 'en';\n\n return {\n  /**\n   * Current language code\n   */\n  language: currentLanguage,\n\n  /**\n   * Format a date with locale-specific format\n   */\n  formatDate: (\n   date: Date | string | number,\n   formatStr: string = getDateFormatPattern(currentLanguage, 'medium')\n  ) => formatDateLocale(date, formatStr, currentLanguage),\n\n  /**\n   * Format relative time (e.g.,\"2 days ago\")\n   */\n  formatRelativeTime: (date: Date | string | number, baseDate?: Date) =>\n   formatRelativeTime(date, baseDate, currentLanguage),\n\n  /**\n   * Format relative date (e.g.,\"yesterday at 3:54 PM\")\n   */\n  formatRelativeDate: (date: Date | string | number, baseDate?: Date) =>\n   formatRelativeDate(date, baseDate, currentLanguage),\n\n  /**\n   * Format number with locale-specific separators\n   */\n  formatNumber: (value: number, options?: Intl.NumberFormatOptions) =>\n   formatNumber(value, currentLanguage, options),\n\n  /**\n   * Format currency with locale-specific format\n   */\n  formatCurrency: (\n   amount: number,\n   currencyCode: string,\n   options?: Intl.NumberFormatOptions\n  ) => formatCurrencyLocale(amount, currencyCode, currentLanguage, options),\n\n  /**\n   * Format percentage with locale-specific format\n   */\n  formatPercentage: (value: number, decimals?: number) =>\n   formatPercentage(value, currentLanguage, decimals),\n\n  /**\n   * Get locale-specific date format pattern\n   */\n  getDatePattern: (type: 'short' | 'medium' | 'long' | 'full' = 'medium') =>\n   getDateFormatPattern(currentLanguage, type),\n\n  /**\n   * Get locale-specific time format pattern\n   */\n  getTimePattern: () => getTimeFormatPattern(currentLanguage),\n };\n}\n","path":null,"size_bytes":2021,"size_tokens":null},"client/src/lib/locale.ts":{"content":"// Locale utilities for date/time formatting and number display\nimport { format, formatDistance, formatRelative } from 'date-fns';\nimport { enUS, es, id as idLocale, th, ptBR, hi, vi, tr, type Locale } from 'date-fns/locale';\n\n// Map language codes to date-fns locales\nconst DATE_LOCALES: Record<string, Locale> = {\n 'en': enUS,\n 'es': es,\n 'id': idLocale,\n 'th': th,\n 'pt': ptBR,\n 'hi': hi,\n 'vi': vi,\n 'tl': enUS, // Tagalog uses English formatting\n 'ms': enUS, // Malay uses English formatting \n 'tr': tr,\n};\n\n// Map language codes to Intl.NumberFormat locales\nconst NUMBER_LOCALES: Record<string, string> = {\n 'en': 'en-US',\n 'es': 'es-ES',\n 'id': 'id-ID',\n 'th': 'th-TH',\n 'pt': 'pt-BR',\n 'hi': 'hi-IN',\n 'vi': 'vi-VN',\n 'tl': 'fil-PH', // Filipino\n 'ms': 'ms-MY',\n 'tr': 'tr-TR',\n};\n\n// Map language codes to currency formatting locales\nconst CURRENCY_LOCALES: Record<string, string> = {\n 'en': 'en-US',\n 'es': 'es-ES',\n 'id': 'id-ID',\n 'th': 'th-TH',\n 'pt': 'pt-BR',\n 'hi': 'hi-IN',\n 'vi': 'vi-VN',\n 'tl': 'en-PH',\n 'ms': 'ms-MY',\n 'tr': 'tr-TR',\n};\n\n/**\n * Get date-fns locale for a language code\n */\nexport function getDateLocale(languageCode: string): Locale {\n return DATE_LOCALES[languageCode] || enUS;\n}\n\n/**\n * Get Intl.NumberFormat locale for a language code\n */\nexport function getNumberLocale(languageCode: string): string {\n return NUMBER_LOCALES[languageCode] || 'en-US';\n}\n\n/**\n * Get currency formatting locale for a language code\n */\nexport function getCurrencyLocale(languageCode: string): string {\n return CURRENCY_LOCALES[languageCode] || 'en-US';\n}\n\n/**\n * Format a date with locale-specific format\n */\nexport function formatDateLocale(\n date: Date | string | number,\n formatStr: string,\n languageCode: string = 'en'\n): string {\n const locale = getDateLocale(languageCode);\n const dateObj = typeof date === 'string' || typeof date === 'number' ? new Date(date) : date;\n return format(dateObj, formatStr, { locale });\n}\n\n/**\n * Format relative time with locale (e.g.,\"2 days ago\")\n */\nexport function formatRelativeTime(\n date: Date | string | number,\n baseDate: Date = new Date(),\n languageCode: string = 'en'\n): string {\n const locale = getDateLocale(languageCode);\n const dateObj = typeof date === 'string' || typeof date === 'number' ? new Date(date) : date;\n return formatDistance(dateObj, baseDate, { addSuffix: true, locale });\n}\n\n/**\n * Format relative date with locale (e.g.,\"yesterday at 3:54 PM\")\n */\nexport function formatRelativeDate(\n date: Date | string | number,\n baseDate: Date = new Date(),\n languageCode: string = 'en'\n): string {\n const locale = getDateLocale(languageCode);\n const dateObj = typeof date === 'string' || typeof date === 'number' ? new Date(date) : date;\n return formatRelative(dateObj, baseDate, { locale });\n}\n\n/**\n * Format number with locale-specific separators\n */\nexport function formatNumber(\n value: number,\n languageCode: string = 'en',\n options: Intl.NumberFormatOptions = {}\n): string {\n const locale = getNumberLocale(languageCode);\n return new Intl.NumberFormat(locale, options).format(value);\n}\n\n/**\n * Format currency with locale-specific format and symbol positioning\n */\nexport function formatCurrencyLocale(\n amount: number,\n currencyCode: string,\n languageCode: string = 'en',\n options: Intl.NumberFormatOptions = {}\n): string {\n const locale = getCurrencyLocale(languageCode);\n \n return new Intl.NumberFormat(locale, {\n  style: 'currency',\n  currency: currencyCode,\n  ...options,\n }).format(amount);\n}\n\n/**\n * Format percentage with locale-specific format\n */\nexport function formatPercentage(\n value: number,\n languageCode: string = 'en',\n decimals: number = 0\n): string {\n const locale = getNumberLocale(languageCode);\n \n return new Intl.NumberFormat(locale, {\n  style: 'percent',\n  minimumFractionDigits: decimals,\n  maximumFractionDigits: decimals,\n }).format(value / 100);\n}\n\n/**\n * Get locale-specific date format patterns\n */\nexport function getDateFormatPattern(\n languageCode: string,\n formatType: 'short' | 'medium' | 'long' | 'full' = 'medium'\n): string {\n const patterns: Record<string, Record<string, string>> = {\n  'en': {\n   'short': 'MM/dd/yyyy',\n   'medium': 'MMM d, yyyy',\n   'long': 'MMMM d, yyyy',\n   'full': 'EEEE, MMMM d, yyyy',\n  },\n  'es': {\n   'short': 'dd/MM/yyyy',\n   'medium': 'd MMM yyyy',\n   'long': 'd \\'de\\' MMMM \\'de\\' yyyy',\n   'full': 'EEEE, d \\'de\\' MMMM \\'de\\' yyyy',\n  },\n  'id': {\n   'short': 'dd/MM/yyyy',\n   'medium': 'd MMM yyyy',\n   'long': 'd MMMM yyyy',\n   'full': 'EEEE, d MMMM yyyy',\n  },\n  'th': {\n   'short': 'dd/MM/yyyy',\n   'medium': 'd MMM yyyy',\n   'long': 'd MMMM yyyy',\n   'full': 'EEEE d MMMM yyyy',\n  },\n  'pt': {\n   'short': 'dd/MM/yyyy',\n   'medium': 'd \\'de\\' MMM \\'de\\' yyyy',\n   'long': 'd \\'de\\' MMMM \\'de\\' yyyy',\n   'full': 'EEEE, d \\'de\\' MMMM \\'de\\' yyyy',\n  },\n  'vi': {\n   'short': 'dd/MM/yyyy',\n   'medium': 'd \\'thg\\' M, yyyy',\n   'long': 'd \\'tháng\\' M \\'năm\\' yyyy',\n   'full': 'EEEE, d \\'tháng\\' M \\'năm\\' yyyy',\n  },\n  'tr': {\n   'short': 'dd.MM.yyyy',\n   'medium': 'd MMM yyyy',\n   'long': 'd MMMM yyyy',\n   'full': 'd MMMM yyyy EEEE',\n  },\n };\n\n const localePatterns = patterns[languageCode] || patterns['en'];\n return localePatterns[formatType];\n}\n\n/**\n * Get locale-specific time format (12h vs 24h)\n */\nexport function getTimeFormatPattern(languageCode: string): string {\n // Countries that use 12-hour format\n const use12Hour = ['en', 'tl', 'ms'];\n \n if (use12Hour.includes(languageCode)) {\n  return 'h:mm a'; // 12-hour with AM/PM\n }\n \n return 'HH:mm'; // 24-hour\n}\n","path":null,"size_bytes":5532,"size_tokens":null},"client/src/components/sharing/share-goal-dialog.tsx":{"content":"import { useState } from\"react\";\nimport { useQuery, useMutation, useQueryClient } from\"@tanstack/react-query\";\nimport { Users, Share2, Check, X } from\"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from\"@/components/ui/dialog\";\nimport { Button } from\"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { ScrollArea } from\"@/components/ui/scroll-area\";\nimport { apiRequest } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { Avatar, AvatarFallback, AvatarImage } from\"@/components/ui/avatar\";\n\ninterface ShareGoalDialogProps {\n goalId: string;\n goalTitle: string;\n open?: boolean;\n onOpenChange?: (open: boolean) => void;\n children?: React.ReactNode;\n}\n\nexport default function ShareGoalDialog({ goalId, goalTitle, open, onOpenChange, children }: ShareGoalDialogProps) {\n const [selectedFriend, setSelectedFriend] = useState(\"\");\n const [permission, setPermission] = useState<\"view\" |\"contribute\">(\"view\");\n const { toast } = useToast();\n const queryClient = useQueryClient();\n\n // Fetch friends list\n const { data: friends = [], isLoading: friendsLoading } = useQuery<any[]>({\n  queryKey: [\"/api/friends\"],\n });\n\n // Fetch current shares for this goal\n const { data: shares = [], isLoading: sharesLoading } = useQuery<any[]>({\n  queryKey: [\"/api/goals\", goalId,\"shares\"],\n });\n\n // Share goal mutation\n const shareGoalMutation = useMutation({\n  mutationFn: (data: { sharedWithUserId: string; permission: string }) =>\n   apiRequest(\"POST\", `/api/goals/${goalId}/share`, data),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/goals\", goalId,\"shares\"] });\n   toast({\n    title:\"Goal shared successfully\",\n    description: `${goalTitle} has been shared with your friend.`,\n   });\n   setSelectedFriend(\"\");\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Failed to share goal\",\n    description: error.message ||\"Something went wrong\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n // Remove share mutation\n const removeShareMutation = useMutation({\n  mutationFn: (userId: string) =>\n   apiRequest(\"DELETE\", `/api/goals/${goalId}/share/${userId}`),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/goals\", goalId,\"shares\"] });\n   toast({\n    title:\"Share removed\",\n    description:\"Access has been revoked successfully.\",\n   });\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Failed to remove share\",\n    description: error.message ||\"Something went wrong\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n // Update permission mutation\n const updatePermissionMutation = useMutation({\n  mutationFn: ({ userId, permission }: { userId: string; permission: string }) =>\n   apiRequest(\"PATCH\", `/api/goals/${goalId}/share/${userId}`, { permission }),\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/goals\", goalId,\"shares\"] });\n   toast({\n    title:\"Permission updated\",\n    description:\"Share permission has been updated successfully.\",\n   });\n  },\n });\n\n const handleShare = () => {\n  if (!selectedFriend) {\n   toast({\n    title:\"No friend selected\",\n    description:\"Please select a friend to share with.\",\n    variant:\"destructive\",\n   });\n   return;\n  }\n\n  shareGoalMutation.mutate({\n   sharedWithUserId: selectedFriend,\n   permission,\n  });\n };\n\n const getInitials = (firstName?: string | null, lastName?: string | null) => {\n  return `${firstName?.[0] || ''}${lastName?.[0] || ''}`.toUpperCase() || '?';\n };\n\n // Filter out friends who already have access\n const availableFriends = friends.filter(\n  (friend: any) => !shares.some((share: any) => share.sharedWith.id === friend.id)\n );\n\n return (\n  <Dialog open={open} onOpenChange={onOpenChange}>\n   {children && <DialogTrigger asChild>{children}</DialogTrigger>}\n   <DialogContent className=\"max-w-2xl max-h-[90vh]\">\n    <DialogHeader>\n     <DialogTitle className=\"flex items-center gap-2\">\n      <Share2 className=\"w-5 h-5\" />\n      Share Goal: {goalTitle}\n     </DialogTitle>\n     <DialogDescription>\n      Share this financial goal with friends. Choose whether they can view only or contribute to the goal.\n     </DialogDescription>\n    </DialogHeader>\n\n    <div className=\"space-y-6\">\n     {/* Add New Share */}\n     <div className=\"space-y-4 border-b pb-6\">\n      <h3 className=\"font-semibold text-sm\">Share with a Friend</h3>\n      \n      {friendsLoading ? (\n       <div className=\"text-sm text-muted-foreground\">Loading friends...</div>\n      ) : availableFriends.length === 0 ? (\n       <div className=\"text-sm text-muted-foreground\">\n        {friends.length === 0 \n         ?\"You don't have any friends to share with yet.\" \n         :\"All your friends already have access to this goal.\"}\n       </div>\n      ) : (\n       <div className=\"space-y-3\">\n        <Select value={selectedFriend} onValueChange={setSelectedFriend}>\n         <SelectTrigger data-testid=\"select-friend\">\n          <SelectValue placeholder=\"Select a friend\" />\n         </SelectTrigger>\n         <SelectContent>\n          {availableFriends.map((friend: any) => (\n           <SelectItem key={friend.id} value={friend.id}>\n            {friend.firstName} {friend.lastName} ({friend.email})\n           </SelectItem>\n          ))}\n         </SelectContent>\n        </Select>\n\n        <div className=\"flex items-center gap-3\">\n         <Select value={permission} onValueChange={(val) => setPermission(val as\"view\" |\"contribute\")}>\n          <SelectTrigger className=\"flex-1\" data-testid=\"select-permission\">\n           <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n           <SelectItem value=\"view\">View Only</SelectItem>\n           <SelectItem value=\"contribute\">Can Contribute</SelectItem>\n          </SelectContent>\n         </Select>\n\n         <Button\n          onClick={handleShare}\n          disabled={!selectedFriend || shareGoalMutation.isPending}\n          data-testid=\"button-share-goal\"\n         >\n          {shareGoalMutation.isPending ?\"Sharing...\" :\"Share\"}\n         </Button>\n        </div>\n\n        <div className=\"text-xs text-muted-foreground space-y-1\">\n         <p><strong>View Only:</strong> Friend can see the goal and its progress</p>\n         <p><strong>Can Contribute:</strong> Friend can add funds to help reach the goal</p>\n        </div>\n       </div>\n      )}\n     </div>\n\n     {/* Current Shares */}\n     <div className=\"space-y-4\">\n      <h3 className=\"font-semibold text-sm\">People with Access</h3>\n      \n      {sharesLoading ? (\n       <div className=\"text-sm text-muted-foreground\">Loading shares...</div>\n      ) : shares.length === 0 ? (\n       <div className=\"text-sm text-muted-foreground\">\n        This goal isn't shared with anyone yet.\n       </div>\n      ) : (\n       <ScrollArea className=\"max-h-60\">\n        <div className=\"space-y-3\">\n         {shares.map((share: any) => (\n          <div\n           key={share.id}\n           className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n           data-testid={`share-item-${share.sharedWith.id}`}\n          >\n           <div className=\"flex items-center gap-3 flex-1\">\n            <Avatar className=\"w-10 h-10\">\n             <AvatarImage src={share.sharedWith.profileImageUrl} />\n             <AvatarFallback>\n              {getInitials(share.sharedWith.firstName, share.sharedWith.lastName)}\n             </AvatarFallback>\n            </Avatar>\n            <div className=\"flex-1\">\n             <p className=\"font-medium\">\n              {share.sharedWith.firstName} {share.sharedWith.lastName}\n             </p>\n             <p className=\"text-sm text-muted-foreground\">{share.sharedWith.email}</p>\n            </div>\n           </div>\n\n           <div className=\"flex items-center gap-2\">\n            <Select\n             value={share.permission}\n             onValueChange={(val) => updatePermissionMutation.mutate({ \n              userId: share.sharedWith.id, \n              permission: val \n             })}\n            >\n             <SelectTrigger className=\"w-32\">\n              <SelectValue />\n             </SelectTrigger>\n             <SelectContent>\n              <SelectItem value=\"view\">View Only</SelectItem>\n              <SelectItem value=\"contribute\">Can Contribute</SelectItem>\n             </SelectContent>\n            </Select>\n\n            <Button\n             variant=\"ghost\"\n             size=\"icon\"\n             onClick={() => removeShareMutation.mutate(share.sharedWith.id)}\n             disabled={removeShareMutation.isPending}\n             data-testid={`button-remove-share-${share.sharedWith.id}`}\n            >\n             <X className=\"w-4 h-4\" />\n            </Button>\n           </div>\n          </div>\n         ))}\n        </div>\n       </ScrollArea>\n      )}\n     </div>\n    </div>\n   </DialogContent>\n  </Dialog>\n );\n}\n","path":null,"size_bytes":8921,"size_tokens":null},"client/src/lib/aiConfirmation.ts":{"content":"// Utility to detect AI confirmation questions and extract action type\n\nexport interface ConfirmationPattern {\n detected: boolean;\n actionType?: 'goal' | 'transaction' | 'event' | 'budget' | 'group' | 'general';\n actionContext?: string;\n}\n\nexport function detectConfirmation(message: string): ConfirmationPattern {\n const lowerMessage = message.toLowerCase();\n \n // Check for common confirmation patterns\n const confirmationPatterns = [\n  /do you want me to (add|create|set up|schedule)/i,\n  /would you like me to (add|create|set up|schedule)/i,\n  /shall I (add|create|set up|schedule)/i,\n  /should I (add|create|set up|schedule)/i,\n  /want to (add|create|set up|schedule)/i,\n  /ready to (add|create|set up|schedule)/i,\n  /can I (add|create|set up|schedule)/i,\n ];\n\n const isConfirmation = confirmationPatterns.some(pattern => pattern.test(message));\n \n if (!isConfirmation) {\n  return { detected: false };\n }\n\n // Determine action type based on keywords\n if (lowerMessage.includes('goal') || lowerMessage.includes('saving')) {\n  return {\n   detected: true,\n   actionType: 'goal',\n   actionContext: extractActionContext(message)\n  };\n }\n \n if (lowerMessage.includes('transaction') || lowerMessage.includes('expense') || lowerMessage.includes('income')) {\n  return {\n   detected: true,\n   actionType: 'transaction',\n   actionContext: extractActionContext(message)\n  };\n }\n \n if (lowerMessage.includes('event') || lowerMessage.includes('schedule') || lowerMessage.includes('reminder')) {\n  return {\n   detected: true,\n   actionType: 'event',\n   actionContext: extractActionContext(message)\n  };\n }\n \n if (lowerMessage.includes('budget')) {\n  return {\n   detected: true,\n   actionType: 'budget',\n   actionContext: extractActionContext(message)\n  };\n }\n \n if (lowerMessage.includes('group')) {\n  return {\n   detected: true,\n   actionType: 'group',\n   actionContext: extractActionContext(message)\n  };\n }\n\n return {\n  detected: true,\n  actionType: 'general',\n  actionContext: extractActionContext(message)\n };\n}\n\nfunction extractActionContext(message: string): string {\n // Extract the action being proposed (for display purposes)\n const match = message.match(/(?:add|create|set up|schedule)\\s+(?:this|a|an|the)?\\s*([^?.\\n]+)/i);\n return match ? match[1].trim() : 'this action';\n}\n","path":null,"size_bytes":2276,"size_tokens":null},"client/src/components/chat/ConfirmationButtons.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Check, X, Plus } from 'lucide-react';\nimport { useTranslation } from 'react-i18next';\nimport type { ConfirmationPattern } from '@/lib/aiConfirmation';\n\ninterface ConfirmationButtonsProps {\n confirmation: ConfirmationPattern;\n onConfirm: () => void;\n onDecline: () => void;\n disabled?: boolean;\n}\n\nexport function ConfirmationButtons({ \n confirmation, \n onConfirm, \n onDecline,\n disabled = false \n}: ConfirmationButtonsProps) {\n const { t } = useTranslation();\n const [selected, setSelected] = useState<'yes' | 'no' | null>(null);\n\n const handleConfirm = () => {\n  setSelected('yes');\n  onConfirm();\n };\n\n const handleDecline = () => {\n  setSelected('no');\n  onDecline();\n };\n\n // Removed action emojis for professional design\n\n return (\n  <div className=\"mt-4 space-y-3\">\n   <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n    <Plus className=\"w-3 h-3\" />\n    <span>{t('aiAssistant.confirmAction')}</span>\n   </div>\n   \n   <div className=\"flex flex-col sm:flex-row gap-3\">\n    <Button\n     onClick={handleConfirm}\n     disabled={disabled || selected !== null}\n     className={`\n      flex-1 h-12 sm:h-11 text-base sm:text-sm\n      bg-white dark:bg-gray-900 \n      \n      disabled:opacity-50 disabled:cursor-not-allowed\n      shadow-md hover:shadow-lg\n      transform\n      \n      ${selected === 'yes' ? 'ring-2 ring-green-500 ring-offset-2' : ''}\n     `}\n     data-testid=\"button-confirm-yes\"\n    >\n     <Check className=\"w-5 h-5 sm:w-4 sm:h-4 mr-2\" />\n     {t('common.yes')}\n    </Button>\n    \n    <Button\n     onClick={handleDecline}\n     disabled={disabled || selected !== null}\n     variant=\"outline\"\n     className={`\n      flex-1 h-12 sm:h-11 text-base sm:text-sm\n      border-2 border-red-200 dark:border-red-800\n      hover:bg-red-50 dark:hover:bg-red-950/20\n      hover:border-red-300 dark:hover:border-red-700\n      disabled:opacity-50 disabled:cursor-not-allowed\n      shadow-sm hover:shadow-md\n      transform\n      \n      ${selected === 'no' ? 'ring-2 ring-red-500 ring-offset-2 bg-red-50 dark:bg-red-950/20' : ''}\n     `}\n     data-testid=\"button-confirm-no\"\n    >\n     <X className=\"w-5 h-5 sm:w-4 sm:h-4 mr-2\" />\n     {t('common.no')}\n    </Button>\n   </div>\n   \n   {selected && (\n    <div className=\"text-xs text-center text-muted-foreground\">\n     {selected === 'yes' \n      ? `${t('aiAssistant.processingRequest')}`\n      : `${t('aiAssistant.actionCancelled')}`\n     }\n    </div>\n   )}\n  </div>\n );\n}\n","path":null,"size_bytes":2536,"size_tokens":null},"server/marketDataService.ts":{"content":"// Comprehensive Market Data Service\n// Integrates stocks, forex, inflation, economic indicators, and financial benchmarks\n\ninterface StockQuote {\n  symbol: string;\n  price: number;\n  change: number;\n  changePercent: number;\n  volume?: number;\n  marketCap?: number;\n}\n\ninterface ForexRate {\n  from: string;\n  to: string;\n  rate: number;\n  lastUpdated: Date;\n}\n\ninterface InflationData {\n  country: string;\n  rate: number; // Annual inflation rate percentage\n  month: string;\n  year: number;\n}\n\ninterface EconomicIndicator {\n  name: string;\n  value: number;\n  unit: string;\n  country: string;\n  lastUpdated: Date;\n}\n\ninterface FearGreedIndex {\n  value: number;  // 0-100\n  classification: 'Extreme Fear' | 'Fear' | 'Neutral' | 'Greed' | 'Extreme Greed';\n  timestamp: Date;\n}\n\ninterface FinancialBenchmarks {\n  savingsRateByAge: { ageRange: string; recommendedRate: number; averageRate: number }[];\n  emergencyFundMonths: { incomeLevel: string; months: number }[];\n  debtToIncomeRatios: { type: string; healthy: number; warning: number; critical: number }[];\n  retirementMultiples: { age: number; multiplier: number }[];\n  expenseRatiosByCategory: { category: string; averagePercent: number; healthyMax: number }[];\n}\n\ninterface MarketDataCache {\n  stocks: Map<string, { data: StockQuote; timestamp: number }>;\n  forex: Map<string, { data: ForexRate; timestamp: number }>;\n  inflation: Map<string, { data: InflationData; timestamp: number }>;\n  indicators: Map<string, { data: EconomicIndicator; timestamp: number }>;\n  fearGreed: { data: FearGreedIndex; timestamp: number } | null;\n  economicIndicatorsSet: Map<string, { data: Map<string, EconomicIndicator>; timestamp: number }>;\n}\n\nconst CACHE_DURATION = 60 * 60 * 1000; // 1 hour for market data\nconst FEAR_GREED_CACHE_DURATION = 4 * 60 * 60 * 1000; // 4 hours for fear/greed\nconst cache: MarketDataCache = {\n  stocks: new Map(),\n  forex: new Map(),\n  inflation: new Map(),\n  indicators: new Map(),\n  fearGreed: null,\n  economicIndicatorsSet: new Map()\n};\n\nexport class MarketDataService {\n  /**\n   * Get real-time stock quote\n   * Using Yahoo Finance alternative API (no key required)\n   */\n  async getStockQuote(symbol: string): Promise<StockQuote | null> {\n    const cacheKey = symbol.toUpperCase();\n    const cached = cache.stocks.get(cacheKey);\n    \n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\n      return cached.data;\n    }\n\n    try {\n      // Using Yahoo Finance v8 API (free, no key)\n      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        console.error(`[MarketData] Stock quote failed for ${symbol}: ${response.status}`);\n        return null;\n      }\n\n      const data = await response.json();\n      const result = data?.chart?.result?.[0];\n      \n      if (!result) return null;\n\n      const meta = result.meta;\n      const quote: StockQuote = {\n        symbol: symbol.toUpperCase(),\n        price: meta.regularMarketPrice || 0,\n        change: (meta.regularMarketPrice || 0) - (meta.previousClose || 0),\n        changePercent: meta.regularMarketPrice && meta.previousClose \n          ? ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100 \n          : 0,\n        volume: meta.regularMarketVolume,\n        marketCap: meta.marketCap\n      };\n\n      cache.stocks.set(cacheKey, { data: quote, timestamp: Date.now() });\n      return quote;\n    } catch (error) {\n      console.error(`[MarketData] Error fetching stock ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get multiple stock quotes in parallel\n   */\n  async getMultipleStocks(symbols: string[]): Promise<Map<string, StockQuote>> {\n    const results = new Map<string, StockQuote>();\n    \n    try {\n      const promises = symbols.map(async (symbol) => {\n        try {\n          const quote = await this.getStockQuote(symbol);\n          if (quote) results.set(symbol.toUpperCase(), quote);\n        } catch (error) {\n          console.error(`[MarketData] Error fetching stock ${symbol}:`, error);\n          // Continue with other stocks even if one fails\n        }\n      });\n      \n      await Promise.all(promises);\n      return results;\n    } catch (error) {\n      console.error('[MarketData] Error fetching multiple stocks:', error);\n      return results; // Return whatever we managed to fetch\n    }\n  }\n\n  /**\n   * Get forex exchange rate\n   */\n  async getForexRate(from: string, to: string): Promise<ForexRate | null> {\n    const cacheKey = `${from}_${to}`;\n    const cached = cache.forex.get(cacheKey);\n    \n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\n      return cached.data;\n    }\n\n    try {\n      // Using exchangerate-api (free tier)\n      const url = `https://api.exchangerate-api.com/v4/latest/${from}`;\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        console.error(`[MarketData] Forex rate failed for ${from}/${to}: ${response.status}`);\n        return null;\n      }\n\n      const data = await response.json();\n      const rate = data.rates?.[to];\n      \n      if (!rate) return null;\n\n      const forexRate: ForexRate = {\n        from: from.toUpperCase(),\n        to: to.toUpperCase(),\n        rate: rate,\n        lastUpdated: new Date(data.time_last_updated * 1000)\n      };\n\n      cache.forex.set(cacheKey, { data: forexRate, timestamp: Date.now() });\n      return forexRate;\n    } catch (error) {\n      console.error(`[MarketData] Error fetching forex ${from}/${to}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get current inflation rate for a country\n   * Using World Bank API (free, no key)\n   */\n  async getInflationRate(countryCode: string = 'US'): Promise<InflationData | null> {\n    const cacheKey = countryCode.toUpperCase();\n    const cached = cache.inflation.get(cacheKey);\n    \n    // Inflation data changes monthly, cache longer\n    if (cached && Date.now() - cached.timestamp < 24 * 60 * 60 * 1000) {\n      return cached.data;\n    }\n\n    try {\n      // World Bank inflation data\n      const url = `https://api.worldbank.org/v2/country/${countryCode}/indicator/FP.CPI.TOTL.ZG?format=json&per_page=1&date=2020:2025`;\n      const response = await fetch(url);\n      \n      if (!response.ok) {\n        console.error(`[MarketData] Inflation data failed for ${countryCode}: ${response.status}`);\n        return null;\n      }\n\n      const data = await response.json();\n      const latest = data?.[1]?.[0];\n      \n      if (!latest || !latest.value) {\n        // Fallback to hardcoded recent rates\n        return this.getFallbackInflation(countryCode);\n      }\n\n      const inflationData: InflationData = {\n        country: countryCode.toUpperCase(),\n        rate: latest.value,\n        month: 'Annual',\n        year: parseInt(latest.date)\n      };\n\n      cache.inflation.set(cacheKey, { data: inflationData, timestamp: Date.now() });\n      return inflationData;\n    } catch (error) {\n      console.error(`[MarketData] Error fetching inflation for ${countryCode}:`, error);\n      return this.getFallbackInflation(countryCode);\n    }\n  }\n\n  /**\n   * Fallback inflation rates (updated 2024)\n   */\n  private getFallbackInflation(countryCode: string): InflationData {\n    const fallbackRates: { [key: string]: number } = {\n      'US': 3.4,   // USA\n      'UK': 4.0,   // United Kingdom\n      'EU': 2.8,   // Eurozone\n      'CA': 3.1,   // Canada\n      'AU': 4.1,   // Australia\n      'JP': 3.2,   // Japan\n      'CN': 0.2,   // China\n      'IN': 5.4,   // India\n      'BR': 4.5,   // Brazil\n      'MX': 4.8,   // Mexico\n      'TH': 1.0,   // Thailand\n      'ID': 2.5,   // Indonesia\n      'PH': 3.2,   // Philippines\n      'VN': 3.7,   // Vietnam\n      'MY': 2.0,   // Malaysia\n      'TR': 64.8,  // Turkey (high inflation)\n      'AR': 211.4, // Argentina (hyperinflation)\n    };\n\n    return {\n      country: countryCode.toUpperCase(),\n      rate: fallbackRates[countryCode.toUpperCase()] || 3.0,\n      month: 'Annual',\n      year: 2024\n    };\n  }\n\n  /**\n   * Get crypto Fear & Greed Index from alternative.me API\n   */\n  async getCryptoFearGreedIndex(): Promise<FearGreedIndex | null> {\n    if (cache.fearGreed && Date.now() - cache.fearGreed.timestamp < FEAR_GREED_CACHE_DURATION) {\n      return cache.fearGreed.data;\n    }\n\n    try {\n      const response = await fetch('https://api.alternative.me/fng/?limit=1');\n      \n      if (!response.ok) {\n        console.error(`[MarketData] Fear & Greed Index failed: ${response.status}`);\n        return this.getFallbackFearGreed();\n      }\n\n      const data = await response.json();\n      const fngData = data?.data?.[0];\n      \n      if (!fngData) return this.getFallbackFearGreed();\n\n      const value = parseInt(fngData.value);\n      const classification = this.classifyFearGreed(value);\n\n      const result: FearGreedIndex = {\n        value,\n        classification,\n        timestamp: new Date(parseInt(fngData.timestamp) * 1000)\n      };\n\n      cache.fearGreed = { data: result, timestamp: Date.now() };\n      return result;\n    } catch (error) {\n      console.error('[MarketData] Error fetching Fear & Greed Index:', error);\n      return this.getFallbackFearGreed();\n    }\n  }\n\n  private classifyFearGreed(value: number): FearGreedIndex['classification'] {\n    if (value <= 20) return 'Extreme Fear';\n    if (value <= 40) return 'Fear';\n    if (value <= 60) return 'Neutral';\n    if (value <= 80) return 'Greed';\n    return 'Extreme Greed';\n  }\n\n  private getFallbackFearGreed(): FearGreedIndex {\n    return {\n      value: 50,\n      classification: 'Neutral',\n      timestamp: new Date()\n    };\n  }\n\n  /**\n   * Get expert-sourced financial benchmarks for personalized advice\n   * Based on research from Fidelity, Vanguard, and financial planning standards\n   */\n  getFinancialBenchmarks(): FinancialBenchmarks {\n    return {\n      savingsRateByAge: [\n        { ageRange: '20-29', recommendedRate: 15, averageRate: 8 },\n        { ageRange: '30-39', recommendedRate: 18, averageRate: 10 },\n        { ageRange: '40-49', recommendedRate: 20, averageRate: 12 },\n        { ageRange: '50-59', recommendedRate: 25, averageRate: 14 },\n        { ageRange: '60+', recommendedRate: 30, averageRate: 16 }\n      ],\n      emergencyFundMonths: [\n        { incomeLevel: 'Low (<$40k)', months: 3 },\n        { incomeLevel: 'Medium ($40k-$100k)', months: 6 },\n        { incomeLevel: 'High (>$100k)', months: 9 },\n        { incomeLevel: 'Variable/Self-employed', months: 12 }\n      ],\n      debtToIncomeRatios: [\n        { type: 'Front-end (Housing)', healthy: 28, warning: 35, critical: 40 },\n        { type: 'Back-end (Total Debt)', healthy: 36, warning: 43, critical: 50 },\n        { type: 'Credit Card Utilization', healthy: 10, warning: 30, critical: 50 }\n      ],\n      retirementMultiples: [\n        { age: 30, multiplier: 1 },    // 1x annual salary\n        { age: 35, multiplier: 2 },\n        { age: 40, multiplier: 3 },\n        { age: 45, multiplier: 4 },\n        { age: 50, multiplier: 6 },\n        { age: 55, multiplier: 7 },\n        { age: 60, multiplier: 8 },\n        { age: 65, multiplier: 10 },\n        { age: 67, multiplier: 10 }   // Full retirement age\n      ],\n      expenseRatiosByCategory: [\n        { category: 'Housing', averagePercent: 33, healthyMax: 30 },\n        { category: 'Transportation', averagePercent: 17, healthyMax: 15 },\n        { category: 'Food', averagePercent: 13, healthyMax: 12 },\n        { category: 'Insurance', averagePercent: 11, healthyMax: 10 },\n        { category: 'Healthcare', averagePercent: 8, healthyMax: 8 },\n        { category: 'Utilities', averagePercent: 6, healthyMax: 5 },\n        { category: 'Entertainment', averagePercent: 5, healthyMax: 5 },\n        { category: 'Clothing', averagePercent: 3, healthyMax: 3 },\n        { category: 'Personal Care', averagePercent: 2, healthyMax: 2 },\n        { category: 'Miscellaneous', averagePercent: 2, healthyMax: 5 }\n      ]\n    };\n  }\n\n  /**\n   * Get major economic indicators with live data where available (cached)\n   */\n  async getEconomicIndicators(country: string = 'US'): Promise<Map<string, EconomicIndicator>> {\n    const cacheKey = country.toUpperCase();\n    const cached = cache.economicIndicatorsSet.get(cacheKey);\n    \n    // Return cached indicators if still valid\n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\n      return cached.data;\n    }\n\n    const indicators = new Map<string, EconomicIndicator>();\n    \n    if (country === 'US') {\n      // Try to fetch live treasury yields as proxy for Fed rate expectations\n      try {\n        const treasuryData = await this.fetchTreasuryYields();\n        if (treasuryData) {\n          indicators.set('treasury_10y', {\n            name: '10-Year Treasury Yield',\n            value: treasuryData.tenYear,\n            unit: '%',\n            country: 'US',\n            lastUpdated: new Date()\n          });\n          indicators.set('treasury_2y', {\n            name: '2-Year Treasury Yield',\n            value: treasuryData.twoYear,\n            unit: '%',\n            country: 'US',\n            lastUpdated: new Date()\n          });\n          // Yield curve inversion indicator\n          const yieldSpread = treasuryData.tenYear - treasuryData.twoYear;\n          indicators.set('yield_curve_spread', {\n            name: 'Yield Curve Spread (10Y-2Y)',\n            value: yieldSpread,\n            unit: '%',\n            country: 'US',\n            lastUpdated: new Date()\n          });\n        }\n      } catch (error) {\n        console.error('[MarketData] Error fetching treasury yields:', error);\n      }\n\n      // Latest Fed Funds Rate (updated regularly based on FOMC meetings)\n      indicators.set('federal_funds_rate', {\n        name: 'Federal Funds Rate',\n        value: 4.50, // Updated Dec 2024 (after Dec FOMC cut)\n        unit: '%',\n        country: 'US',\n        lastUpdated: new Date('2024-12-18')\n      });\n\n      indicators.set('unemployment_rate', {\n        name: 'Unemployment Rate',\n        value: 4.2,\n        unit: '%',\n        country: 'US',\n        lastUpdated: new Date('2024-11-01')\n      });\n\n      indicators.set('gdp_growth', {\n        name: 'GDP Growth (Q3 2024)',\n        value: 2.8,\n        unit: '%',\n        country: 'US',\n        lastUpdated: new Date('2024-10-30')\n      });\n\n      // Consumer confidence\n      indicators.set('consumer_confidence', {\n        name: 'Consumer Confidence Index',\n        value: 111.7,\n        unit: 'index',\n        country: 'US',\n        lastUpdated: new Date('2024-11-26')\n      });\n\n      // Prime rate (follows Fed rate + 3%)\n      indicators.set('prime_rate', {\n        name: 'Prime Rate',\n        value: 7.50,\n        unit: '%',\n        country: 'US',\n        lastUpdated: new Date('2024-12-18')\n      });\n    }\n\n    // Cache the results\n    cache.economicIndicatorsSet.set(cacheKey, { data: indicators, timestamp: Date.now() });\n    \n    return indicators;\n  }\n\n  /**\n   * Fetch live treasury yields from Yahoo Finance\n   */\n  private async fetchTreasuryYields(): Promise<{ tenYear: number; twoYear: number } | null> {\n    try {\n      const [tenYearQuote, twoYearQuote] = await Promise.all([\n        this.getStockQuote('^TNX'), // 10-year treasury yield\n        this.getStockQuote('^IRX')  // 3-month treasury (2Y not available, use as proxy)\n      ]);\n      \n      if (tenYearQuote && twoYearQuote) {\n        return {\n          tenYear: tenYearQuote.price / 10, // Yahoo returns as whole number\n          twoYear: twoYearQuote.price / 10\n        };\n      }\n      return null;\n    } catch (error) {\n      console.error('[MarketData] Error fetching treasury yields:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Get comprehensive market overview\n   */\n  async getMarketOverview(): Promise<{\n    stocks: Map<string, StockQuote>;\n    inflation: InflationData | null;\n    indicators: Map<string, EconomicIndicator>;\n  }> {\n    try {\n      // Fetch major indices in parallel with error handling\n      const majorIndices = ['SPY', 'QQQ', 'DIA']; // S&P 500, NASDAQ, Dow Jones ETFs\n      \n      const [stocks, inflation, indicators] = await Promise.all([\n        this.getMultipleStocks(majorIndices).catch(err => {\n          console.error('[MarketData] Error fetching stocks in overview:', err);\n          return new Map<string, StockQuote>();\n        }),\n        this.getInflationRate('US').catch(err => {\n          console.error('[MarketData] Error fetching inflation in overview:', err);\n          return null;\n        }),\n        this.getEconomicIndicators('US').catch(err => {\n          console.error('[MarketData] Error fetching indicators in overview:', err);\n          return new Map<string, EconomicIndicator>();\n        })\n      ]);\n\n      return {\n        stocks,\n        inflation,\n        indicators\n      };\n    } catch (error) {\n      console.error('[MarketData] Critical error in market overview:', error);\n      // Return safe defaults if everything fails\n      return {\n        stocks: new Map(),\n        inflation: null,\n        indicators: new Map()\n      };\n    }\n  }\n\n  /**\n   * Get market sentiment summary for AI context - Enhanced with all data sources\n   */\n  async getMarketContextForAI(userCountry: string = 'US'): Promise<string> {\n    try {\n      const [sp500, nasdaq, inflation, indicators, fearGreed] = await Promise.all([\n        this.getStockQuote('SPY'),\n        this.getStockQuote('QQQ'),\n        this.getInflationRate(userCountry),\n        this.getEconomicIndicators(userCountry),\n        this.getCryptoFearGreedIndex()\n      ]);\n\n      let context = 'CURRENT MARKET CONDITIONS (Live Data):\\n\\n';\n      \n      // Stock Market\n      context += '📈 STOCK MARKET:\\n';\n      if (sp500) {\n        context += `• S&P 500 (SPY): $${sp500.price.toFixed(2)} (${sp500.changePercent > 0 ? '+' : ''}${sp500.changePercent.toFixed(2)}% today)\\n`;\n      }\n      if (nasdaq) {\n        context += `• NASDAQ (QQQ): $${nasdaq.price.toFixed(2)} (${nasdaq.changePercent > 0 ? '+' : ''}${nasdaq.changePercent.toFixed(2)}% today)\\n`;\n      }\n      if (sp500) {\n        const marketSentiment = sp500.changePercent > 1 ? 'BULLISH 🟢' : sp500.changePercent < -1 ? 'BEARISH 🔴' : 'NEUTRAL ⚪';\n        context += `• Today's Sentiment: ${marketSentiment}\\n`;\n      }\n      \n      // Crypto Sentiment\n      if (fearGreed) {\n        context += '\\n🪙 CRYPTO MARKET SENTIMENT:\\n';\n        context += `• Fear & Greed Index: ${fearGreed.value}/100 (${fearGreed.classification})\\n`;\n        if (fearGreed.value <= 25) {\n          context += `  → OPPORTUNITY: Extreme fear often signals buying opportunities for long-term investors\\n`;\n        } else if (fearGreed.value >= 75) {\n          context += `  → CAUTION: Extreme greed may indicate market is overheated\\n`;\n        }\n      }\n\n      // Economic Indicators\n      context += '\\n💹 ECONOMIC INDICATORS:\\n';\n      if (inflation) {\n        context += `• Inflation (${inflation.country}): ${inflation.rate.toFixed(1)}% annually\\n`;\n        const inflationStatus = inflation.rate > 4 ? 'HIGH - Consider I-Bonds, TIPS, commodities' : inflation.rate > 2.5 ? 'MODERATE' : 'LOW - Favorable for bonds';\n        context += `  → Status: ${inflationStatus}\\n`;\n      }\n\n      const fedRate = indicators.get('federal_funds_rate');\n      const primeRate = indicators.get('prime_rate');\n      if (fedRate) {\n        context += `• Fed Funds Rate: ${fedRate.value}%\\n`;\n        context += `  → ${fedRate.value > 4 ? 'High rates: Favor savings accounts, CDs, bonds' : 'Lower rates: Favor stocks, real estate'}\\n`;\n      }\n      if (primeRate) {\n        context += `• Prime Rate: ${primeRate.value}% (affects credit cards, HELOCs, loans)\\n`;\n      }\n\n      const treasuryYield = indicators.get('treasury_10y');\n      const yieldSpread = indicators.get('yield_curve_spread');\n      if (treasuryYield) {\n        context += `• 10-Year Treasury Yield: ${treasuryYield.value.toFixed(2)}%\\n`;\n        context += `  → Safe return benchmark: Investments should beat this rate\\n`;\n      }\n      if (yieldSpread) {\n        context += `• Yield Curve Spread: ${yieldSpread.value.toFixed(2)}%\\n`;\n        if (yieldSpread.value < 0) {\n          context += `  → ⚠️ INVERTED: Historically signals recession risk within 12-18 months\\n`;\n        }\n      }\n\n      const unemployment = indicators.get('unemployment_rate');\n      const gdp = indicators.get('gdp_growth');\n      const consumerConf = indicators.get('consumer_confidence');\n      \n      if (unemployment) {\n        context += `• Unemployment Rate: ${unemployment.value}%\\n`;\n        const jobMarket = unemployment.value < 4 ? 'STRONG - Good for wage growth' : unemployment.value < 5.5 ? 'HEALTHY' : 'WEAKENING - May affect income';\n        context += `  → Job Market: ${jobMarket}\\n`;\n      }\n      if (gdp) {\n        context += `• GDP Growth: ${gdp.value}% annually\\n`;\n      }\n      if (consumerConf) {\n        context += `• Consumer Confidence: ${consumerConf.value} (${consumerConf.value > 100 ? 'Optimistic' : 'Cautious'})\\n`;\n      }\n\n      // Financial Planning Context\n      context += '\\n📊 FINANCIAL PLANNING CONTEXT:\\n';\n      const benchmarks = this.getFinancialBenchmarks();\n      context += `• Recommended savings rate: 15-20% of income\\n`;\n      context += `• Emergency fund target: 3-6 months of expenses\\n`;\n      context += `• Healthy debt-to-income ratio: Under 36%\\n`;\n      context += `• Housing expense guideline: Max 30% of gross income\\n`;\n\n      return context;\n    } catch (error) {\n      console.error('[MarketData] Error building AI context:', error);\n      return 'Market data temporarily unavailable - using historical averages for advice.\\n';\n    }\n  }\n\n  /**\n   * Get comprehensive financial context for AI including user-specific benchmarks\n   */\n  getPersonalizedBenchmarks(userAge: number, userIncome: number): string {\n    const benchmarks = this.getFinancialBenchmarks();\n    let context = '\\n📊 PERSONALIZED FINANCIAL BENCHMARKS:\\n';\n\n    // Find age-appropriate savings rate\n    const ageRange = userAge < 30 ? '20-29' : userAge < 40 ? '30-39' : userAge < 50 ? '40-49' : userAge < 60 ? '50-59' : '60+';\n    const savingsData = benchmarks.savingsRateByAge.find(s => s.ageRange === ageRange);\n    if (savingsData) {\n      context += `• For your age (${ageRange}): Save ${savingsData.recommendedRate}% of income (avg American saves ${savingsData.averageRate}%)\\n`;\n    }\n\n    // Find income-appropriate emergency fund\n    const incomeLevel = userIncome < 40000 ? 'Low (<$40k)' : userIncome < 100000 ? 'Medium ($40k-$100k)' : 'High (>$100k)';\n    const efData = benchmarks.emergencyFundMonths.find(e => e.incomeLevel === incomeLevel);\n    if (efData) {\n      context += `• Emergency fund for your income: ${efData.months} months of expenses\\n`;\n    }\n\n    // Retirement savings target\n    const retirementData = benchmarks.retirementMultiples.find(r => r.age === userAge) || \n      benchmarks.retirementMultiples.find(r => r.age === Math.round(userAge / 5) * 5);\n    if (retirementData) {\n      const targetSavings = userIncome * retirementData.multiplier;\n      context += `• Retirement savings target by age ${retirementData.age}: $${targetSavings.toLocaleString()} (${retirementData.multiplier}x annual salary)\\n`;\n    }\n\n    return context;\n  }\n}\n\n// Singleton instance\nexport const marketDataService = new MarketDataService();\n","path":null,"size_bytes":23360,"size_tokens":null},"server/conversationMemoryService.ts":{"content":"import type { IStorage } from './storage';\n\ninterface ConversationMemory {\n  financialPriorities?: string[];\n  investmentPreferences?: string[];\n  lifeEvents?: { event: string; timeframe?: string }[];\n  spendingHabits?: string[];\n  riskTolerance?: string;\n  lastUpdated?: string;\n  // Enhanced memory features\n  adviceHistory?: Array<{\n    topic: string;\n    advice: string;\n    date: string;\n    outcome?: 'followed' | 'ignored' | 'modified' | 'pending';\n  }>;\n  financialLiteracyLevel?: 'beginner' | 'intermediate' | 'advanced';\n  emotionalState?: {\n    recentStressIndicators?: string[];\n    recentWins?: string[];\n    lastAssessed?: string;\n  };\n  preferredDetailLevel?: 'brief' | 'detailed' | 'comprehensive';\n  followUpTopics?: string[]; // Topics where we need to check back with user\n}\n\nexport async function extractAndUpdateMemory(\n  storage: IStorage,\n  userId: string,\n  userMessage: string,\n  aiResponse: string\n): Promise<void> {\n  try {\n    const messageLower = userMessage.toLowerCase();\n    const responseLower = aiResponse.toLowerCase();\n    const combinedText = `${messageLower} ${responseLower}`;\n\n    // Get existing memory\n    const prefs = await storage.getUserPreferences(userId);\n    const existingMemory: ConversationMemory = (prefs?.conversationMemory as ConversationMemory) || {};\n\n    let updated = false;\n\n    // Extract financial priorities\n    const priorities: string[] = [...(existingMemory.financialPriorities || [])];\n    \n    if (messageLower.includes('saving for') || messageLower.includes('want to buy')) {\n      const savingMatch = messageLower.match(/saving for (?:a |an )?(\\w+(?:\\s+\\w+)?)/i);\n      if (savingMatch && !priorities.includes(savingMatch[1])) {\n        priorities.push(`saving for ${savingMatch[1]}`);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('planning') || messageLower.includes('plan to')) {\n      const planMatch = messageLower.match(/plan(?:ning)? (?:to |for )?(\\w+(?:\\s+\\w+)?)/i);\n      if (planMatch && !priorities.includes(planMatch[1])) {\n        priorities.push(`planning ${planMatch[1]}`);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('retire') || messageLower.includes('retirement')) {\n      if (!priorities.includes('retirement planning')) {\n        priorities.push('retirement planning');\n        updated = true;\n      }\n    }\n\n    // Extract investment preferences\n    const investments: string[] = [...(existingMemory.investmentPreferences || [])];\n\n    if (combinedText.includes('conservative') && combinedText.includes('invest')) {\n      if (!investments.includes('prefers conservative investments')) {\n        investments.push('prefers conservative investments');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('aggressive') && combinedText.includes('invest')) {\n      if (!investments.includes('prefers aggressive investments')) {\n        investments.push('prefers aggressive investments');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('tech stock') || combinedText.includes('technology stock')) {\n      if (!investments.includes('interested in tech stocks')) {\n        investments.push('interested in tech stocks');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('index fund') || combinedText.includes('etf')) {\n      if (!investments.includes('interested in index funds/ETFs')) {\n        investments.push('interested in index funds/ETFs');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('crypto') || combinedText.includes('bitcoin') || combinedText.includes('ethereum')) {\n      if (!investments.includes('interested in cryptocurrency')) {\n        investments.push('interested in cryptocurrency');\n        updated = true;\n      }\n    }\n\n    // Extract life events\n    const lifeEvents: { event: string; timeframe?: string }[] = [...(existingMemory.lifeEvents || [])];\n\n    if (messageLower.includes('getting married') || messageLower.includes('wedding')) {\n      const yearMatch = messageLower.match(/\\b(202[4-9]|20[3-9]\\d)\\b/);\n      const event = { event: 'getting married', timeframe: yearMatch ? yearMatch[1] : undefined };\n      if (!lifeEvents.some(e => e.event === 'getting married')) {\n        lifeEvents.push(event);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('baby') || messageLower.includes('expecting') || messageLower.includes('pregnant')) {\n      const event = { event: 'expecting baby', timeframe: undefined };\n      if (!lifeEvents.some(e => e.event === 'expecting baby')) {\n        lifeEvents.push(event);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('buying house') || messageLower.includes('buying a house') || messageLower.includes('house purchase')) {\n      const event = { event: 'buying house', timeframe: undefined };\n      if (!lifeEvents.some(e => e.event === 'buying house')) {\n        lifeEvents.push(event);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('graduating') || messageLower.includes('graduation')) {\n      const event = { event: 'graduating', timeframe: undefined };\n      if (!lifeEvents.some(e => e.event === 'graduating')) {\n        lifeEvents.push(event);\n        updated = true;\n      }\n    }\n\n    if (messageLower.includes('new job') || messageLower.includes('changing job') || messageLower.includes('career change')) {\n      const event = { event: 'career change', timeframe: undefined };\n      if (!lifeEvents.some(e => e.event === 'career change')) {\n        lifeEvents.push(event);\n        updated = true;\n      }\n    }\n\n    // Extract spending habits\n    const habits: string[] = [...(existingMemory.spendingHabits || [])];\n\n    if (combinedText.includes('eat out') || combinedText.includes('dining out') || combinedText.includes('restaurant')) {\n      if (!habits.includes('eats out frequently')) {\n        habits.push('eats out frequently');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('online shopping') || combinedText.includes('amazon')) {\n      if (!habits.includes('shops online frequently')) {\n        habits.push('shops online frequently');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('impulse buy') || combinedText.includes('impulse purchase')) {\n      if (!habits.includes('impulse buyer')) {\n        habits.push('impulse buyer');\n        updated = true;\n      }\n    }\n\n    if (combinedText.includes('budgets carefully') || combinedText.includes('track every expense')) {\n      if (!habits.includes('careful budgeter')) {\n        habits.push('careful budgeter');\n        updated = true;\n      }\n    }\n\n    // Extract risk tolerance\n    let riskTolerance = existingMemory.riskTolerance;\n\n    if (!riskTolerance) {\n      if (combinedText.includes('risk-averse') || combinedText.includes('low risk') || combinedText.includes('safe investments')) {\n        riskTolerance = 'conservative';\n        updated = true;\n      } else if (combinedText.includes('moderate risk') || combinedText.includes('balanced')) {\n        riskTolerance = 'moderate';\n        updated = true;\n      } else if (combinedText.includes('high risk') || combinedText.includes('aggressive')) {\n        riskTolerance = 'aggressive';\n        updated = true;\n      }\n    }\n\n    // Detect financial literacy level from language complexity\n    let financialLiteracyLevel = existingMemory.financialLiteracyLevel;\n    if (!financialLiteracyLevel) {\n      const advancedTerms = ['etf', 'rebalancing', 'asset allocation', 'tax-loss harvesting', 'dividend yield', 'p/e ratio', 'market cap', 'arbitrage', 'derivatives', 'options trading', 'short selling'];\n      const intermediateTerms = ['401k', 'roth ira', 'index fund', 'compound interest', 'expense ratio', 'diversification', 'bonds', 'mutual fund'];\n      const advancedCount = advancedTerms.filter(term => messageLower.includes(term)).length;\n      const intermediateCount = intermediateTerms.filter(term => messageLower.includes(term)).length;\n      \n      if (advancedCount >= 2) {\n        financialLiteracyLevel = 'advanced';\n        updated = true;\n      } else if (intermediateCount >= 2 || advancedCount >= 1) {\n        financialLiteracyLevel = 'intermediate';\n        updated = true;\n      } else if (messageLower.includes(\"what is\") || messageLower.includes(\"explain\") || messageLower.includes(\"i don't understand\") || messageLower.includes(\"confused about\")) {\n        financialLiteracyLevel = 'beginner';\n        updated = true;\n      }\n    }\n\n    // Detect emotional state - stress indicators and wins\n    const emotionalState = existingMemory.emotionalState ?? { recentStressIndicators: [], recentWins: [] };\n    const stressIndicators: string[] = [...(emotionalState.recentStressIndicators || [])];\n    const recentWins: string[] = [...(emotionalState.recentWins || [])];\n\n    // Stress detection\n    const stressPatterns = [\n      { pattern: /can't (afford|pay|save)/i, label: 'affordability concern' },\n      { pattern: /worried|anxious|stressed|scared/i, label: 'financial anxiety' },\n      { pattern: /debt.*overwhelming|drowning in debt/i, label: 'debt stress' },\n      { pattern: /emergency|unexpected expense|crisis/i, label: 'financial emergency' },\n      { pattern: /lost.*job|laid off|unemployed/i, label: 'income loss' },\n      { pattern: /behind on (payments|bills)/i, label: 'payment struggles' },\n    ];\n\n    for (const { pattern, label } of stressPatterns) {\n      if (pattern.test(messageLower) && !stressIndicators.includes(label)) {\n        stressIndicators.push(label);\n        updated = true;\n      }\n    }\n\n    // Win detection - celebrate achievements\n    const winPatterns = [\n      { pattern: /paid off|debt.free/i, label: 'paid off debt' },\n      { pattern: /saved (up|enough)|reached.*goal/i, label: 'reached savings goal' },\n      { pattern: /got.*raise|promotion|new job.*higher/i, label: 'income increase' },\n      { pattern: /emergency fund.*complete|fully funded/i, label: 'emergency fund complete' },\n      { pattern: /first.*investment|started investing/i, label: 'started investing' },\n      { pattern: /under budget|saved more than/i, label: 'budget success' },\n    ];\n\n    for (const { pattern, label } of winPatterns) {\n      if (pattern.test(combinedText) && !recentWins.includes(label)) {\n        recentWins.push(label);\n        updated = true;\n      }\n    }\n\n    // Extract advice topics from AI response for tracking\n    const adviceHistory = [...(existingMemory.adviceHistory || [])].slice(-10); // Keep last 10\n    const adviceTopics = [\n      { pattern: /recommend.*saving|should save/i, topic: 'savings' },\n      { pattern: /recommend.*invest|should invest/i, topic: 'investing' },\n      { pattern: /recommend.*pay.*debt|debt.*strategy/i, topic: 'debt payoff' },\n      { pattern: /recommend.*budget|budget.*strategy/i, topic: 'budgeting' },\n      { pattern: /emergency fund|rainy day/i, topic: 'emergency fund' },\n      { pattern: /retirement|401k|ira/i, topic: 'retirement' },\n      { pattern: /tax.*strategy|tax.*saving/i, topic: 'tax optimization' },\n    ];\n\n    for (const { pattern, topic } of adviceTopics) {\n      if (pattern.test(aiResponse.toLowerCase())) {\n        const recentAdvice = adviceHistory.find(a => a.topic === topic && \n          new Date(a.date).getTime() > Date.now() - 7 * 24 * 60 * 60 * 1000);\n        if (!recentAdvice) {\n          adviceHistory.push({\n            topic,\n            advice: aiResponse.slice(0, 200), // Store summary\n            date: new Date().toISOString(),\n            outcome: 'pending'\n          });\n          updated = true;\n        }\n      }\n    }\n\n    // Update memory if anything changed\n    if (updated) {\n      const newMemory: ConversationMemory = {\n        ...(priorities.length > 0 && { financialPriorities: priorities }),\n        ...(investments.length > 0 && { investmentPreferences: investments }),\n        ...(lifeEvents.length > 0 && { lifeEvents }),\n        ...(habits.length > 0 && { spendingHabits: habits }),\n        ...(riskTolerance && { riskTolerance }),\n        ...(financialLiteracyLevel && { financialLiteracyLevel }),\n        ...((stressIndicators.length > 0 || recentWins.length > 0) && {\n          emotionalState: {\n            recentStressIndicators: stressIndicators.slice(-5),\n            recentWins: recentWins.slice(-5),\n            lastAssessed: new Date().toISOString()\n          }\n        }),\n        ...(adviceHistory.length > 0 && { adviceHistory }),\n        lastUpdated: new Date().toISOString()\n      };\n\n      await storage.updateUserPreferences(userId, {\n        conversationMemory: newMemory as any\n      });\n    }\n  } catch (error) {\n    console.error('[ConversationMemory] Update failed:', error);\n    // Memory update failures shouldn't break the chat\n  }\n}\n\n/**\n * Summarize a long conversation history into a compact context string\n * This allows maintaining context from older messages without exceeding token limits\n */\nexport function summarizeConversationHistory(\n  messages: Array<{ role: 'user' | 'assistant'; content: string }>\n): string {\n  if (messages.length === 0) return '';\n  \n  // Extract key topics and entities from the conversation\n  const topics: Set<string> = new Set();\n  const amounts: string[] = [];\n  const goals: string[] = [];\n  const actions: string[] = [];\n  \n  for (const msg of messages) {\n    const content = msg.content.toLowerCase();\n    \n    // Extract financial topics\n    if (content.includes('budget')) topics.add('budgeting');\n    if (content.includes('invest')) topics.add('investing');\n    if (content.includes('retire')) topics.add('retirement');\n    if (content.includes('debt') || content.includes('loan')) topics.add('debt management');\n    if (content.includes('save') || content.includes('saving')) topics.add('savings');\n    if (content.includes('tax')) topics.add('tax planning');\n    if (content.includes('crypto') || content.includes('bitcoin')) topics.add('cryptocurrency');\n    if (content.includes('emergency fund')) topics.add('emergency planning');\n    if (content.includes('house') || content.includes('home')) topics.add('home buying');\n    if (content.includes('car')) topics.add('vehicle purchase');\n    \n    // Extract dollar amounts mentioned\n    const amountMatches = content.match(/\\$[\\d,]+(?:\\.\\d{2})?/g);\n    if (amountMatches) amounts.push(...amountMatches.slice(0, 3));\n    \n    // Extract goals mentioned\n    if (content.includes('goal') || content.includes('want to')) {\n      const goalMatch = content.match(/(?:goal|want to|saving for|plan to)\\s+(.{10,50})/i);\n      if (goalMatch) goals.push(goalMatch[1].trim());\n    }\n    \n    // Extract actions taken by assistant\n    if (msg.role === 'assistant') {\n      if (content.includes('created') || content.includes('added')) {\n        const actionMatch = content.match(/(?:created|added|tracked)\\s*:?\\s*(.{10,40})/i);\n        if (actionMatch) actions.push(actionMatch[1].trim());\n      }\n    }\n  }\n  \n  const parts: string[] = [];\n  \n  if (topics.size > 0) {\n    parts.push(`Topics discussed: ${Array.from(topics).slice(0, 5).join(', ')}`);\n  }\n  \n  if (amounts.length > 0) {\n    parts.push(`Key amounts mentioned: ${Array.from(new Set(amounts)).slice(0, 4).join(', ')}`);\n  }\n  \n  if (goals.length > 0) {\n    parts.push(`Goals mentioned: ${Array.from(new Set(goals)).slice(0, 3).join('; ')}`);\n  }\n  \n  if (actions.length > 0) {\n    parts.push(`Recent actions: ${Array.from(new Set(actions)).slice(0, 3).join('; ')}`);\n  }\n  \n  if (parts.length === 0) return '';\n  \n  return `\\n\\n[CONVERSATION SUMMARY FROM EARLIER MESSAGES]\\n${parts.join('\\n')}`;\n}\n\nexport async function getMemoryContext(storage: IStorage, userId: string): Promise<string> {\n  try {\n    const prefs = await storage.getUserPreferences(userId);\n    const memory: ConversationMemory = (prefs?.conversationMemory as ConversationMemory) || {};\n\n    if (!memory || Object.keys(memory).length === 0) {\n      return '';\n    }\n\n    const parts: string[] = [];\n\n    if (memory.financialPriorities && memory.financialPriorities.length > 0) {\n      parts.push(`Financial priorities: ${memory.financialPriorities.join(', ')}`);\n    }\n\n    if (memory.investmentPreferences && memory.investmentPreferences.length > 0) {\n      parts.push(`Investment preferences: ${memory.investmentPreferences.join(', ')}`);\n    }\n\n    if (memory.lifeEvents && memory.lifeEvents.length > 0) {\n      const events = memory.lifeEvents.map(e => \n        e.timeframe ? `${e.event} (${e.timeframe})` : e.event\n      ).join(', ');\n      parts.push(`Life events: ${events}`);\n    }\n\n    if (memory.spendingHabits && memory.spendingHabits.length > 0) {\n      parts.push(`Spending habits: ${memory.spendingHabits.join(', ')}`);\n    }\n\n    if (memory.riskTolerance) {\n      parts.push(`Risk tolerance: ${memory.riskTolerance}`);\n    }\n\n    // Enhanced memory fields\n    if (memory.financialLiteracyLevel) {\n      parts.push(`Financial expertise level: ${memory.financialLiteracyLevel}`);\n    }\n\n    if (memory.emotionalState) {\n      if (memory.emotionalState.recentStressIndicators && memory.emotionalState.recentStressIndicators.length > 0) {\n        parts.push(`Recent stress indicators: ${memory.emotionalState.recentStressIndicators.join(', ')} - BE SUPPORTIVE AND EMPATHETIC`);\n      }\n      if (memory.emotionalState.recentWins && memory.emotionalState.recentWins.length > 0) {\n        parts.push(`Recent wins to celebrate: ${memory.emotionalState.recentWins.join(', ')} - ACKNOWLEDGE AND ENCOURAGE`);\n      }\n    }\n\n    if (memory.adviceHistory && memory.adviceHistory.length > 0) {\n      const recentAdvice = memory.adviceHistory.slice(-3).map(a => \n        `${a.topic} (${new Date(a.date).toLocaleDateString()})`\n      ).join(', ');\n      parts.push(`Recent advice given: ${recentAdvice} - FOLLOW UP on pending items and maintain consistency`);\n    }\n\n    if (parts.length === 0) {\n      return '';\n    }\n\n    return `\\n\\nREMEMBERED USER CONTEXT (from previous conversations):\\n${parts.join('\\n')}`;\n  } catch (error) {\n    console.error('[ConversationMemory] Get context failed:', error);\n    return '';\n  }\n}\n","path":null,"size_bytes":18033,"size_tokens":null},"server/luxuryAssets.ts":{"content":"// Luxury Asset Reference Database\n// Accurate pricing and specifications for luxury items\n\nexport interface LuxuryVehicle {\n  brand: string;\n  model: string;\n  basePrice: number;\n  category: 'supercar' | 'luxury-suv' | 'sports-car' | 'hypercar' | 'luxury-sedan';\n  yearlyInsurance?: number;\n  yearlyMaintenance?: number;\n  depreciationYear1?: number; // percentage\n}\n\nexport interface LuxuryRealEstate {\n  type: string;\n  location: string;\n  priceRange: { min: number; max: number };\n  avgPropertyTax?: number; // percentage\n  avgHOA?: number; // monthly\n}\n\nexport interface LuxuryWatch {\n  brand: string;\n  model: string;\n  price: number;\n  appreciates: boolean;\n}\n\nexport interface LuxuryYacht {\n  brand: string;\n  model: string;\n  length: number; // feet\n  basePrice: number;\n  yearlyDocking?: number;\n  yearlyCrew?: number;\n  yearlyFuel?: number;\n  yearlyMaintenance?: number;\n}\n\nexport interface PrivateJet {\n  manufacturer: string;\n  model: string;\n  basePrice: number;\n  hourlyOperating: number; // cost per flight hour\n  maxRange: number; // nautical miles\n  passengers: number;\n  yearlyMaintenance?: number;\n}\n\nexport interface LuxuryJewelry {\n  type: string;\n  brand?: string;\n  priceRange: { min: number; max: number };\n  appreciates: boolean;\n  description: string;\n}\n\nexport interface DesignerFashion {\n  brand: string;\n  category: string;\n  priceRange: { min: number; max: number };\n  retainsValue: boolean;\n  iconic: boolean;\n}\n\nexport interface LuxuryArt {\n  category: string;\n  priceRange: { min: number; max: number };\n  appreciationRate: number; // percentage per year\n  description: string;\n}\n\n// LUXURY VEHICLES DATABASE\nexport const LUXURY_VEHICLES: LuxuryVehicle[] = [\n  // Lamborghini\n  { brand: 'Lamborghini', model: 'Huracán EVO', basePrice: 287400, category: 'supercar', yearlyInsurance: 12000, yearlyMaintenance: 8000, depreciationYear1: 20 },\n  { brand: 'Lamborghini', model: 'Huracán STO', basePrice: 327838, category: 'supercar', yearlyInsurance: 15000, yearlyMaintenance: 10000, depreciationYear1: 22 },\n  { brand: 'Lamborghini', model: 'Aventador SVJ', basePrice: 573966, category: 'hypercar', yearlyInsurance: 25000, yearlyMaintenance: 15000, depreciationYear1: 18 },\n  { brand: 'Lamborghini', model: 'Urus', basePrice: 229495, category: 'luxury-suv', yearlyInsurance: 10000, yearlyMaintenance: 7000, depreciationYear1: 25 },\n  { brand: 'Lamborghini', model: 'Revuelto', basePrice: 608358, category: 'hypercar', yearlyInsurance: 28000, yearlyMaintenance: 18000, depreciationYear1: 15 },\n  \n  // Ferrari\n  { brand: 'Ferrari', model: 'Roma', basePrice: 243360, category: 'sports-car', yearlyInsurance: 11000, yearlyMaintenance: 9000, depreciationYear1: 20 },\n  { brand: 'Ferrari', model: 'F8 Tributo', basePrice: 280000, category: 'supercar', yearlyInsurance: 14000, yearlyMaintenance: 10000, depreciationYear1: 18 },\n  { brand: 'Ferrari', model: '296 GTB', basePrice: 321400, category: 'supercar', yearlyInsurance: 16000, yearlyMaintenance: 11000, depreciationYear1: 17 },\n  { brand: 'Ferrari', model: 'SF90 Stradale', basePrice: 507300, category: 'hypercar', yearlyInsurance: 22000, yearlyMaintenance: 14000, depreciationYear1: 15 },\n  { brand: 'Ferrari', model: 'Purosangue', basePrice: 398350, category: 'luxury-suv', yearlyInsurance: 18000, yearlyMaintenance: 12000, depreciationYear1: 20 },\n  \n  // McLaren\n  { brand: 'McLaren', model: 'GT', basePrice: 210000, category: 'sports-car', yearlyInsurance: 9000, yearlyMaintenance: 8000, depreciationYear1: 22 },\n  { brand: 'McLaren', model: '720S', basePrice: 310000, category: 'supercar', yearlyInsurance: 15000, yearlyMaintenance: 12000, depreciationYear1: 25 },\n  { brand: 'McLaren', model: '765 LT', basePrice: 382500, category: 'hypercar', yearlyInsurance: 18000, yearlyMaintenance: 14000, depreciationYear1: 20 },\n  { brand: 'McLaren', model: 'Artura', basePrice: 237500, category: 'supercar', yearlyInsurance: 12000, yearlyMaintenance: 9000, depreciationYear1: 23 },\n  \n  // Porsche\n  { brand: 'Porsche', model: '911 Turbo S', basePrice: 230400, category: 'sports-car', yearlyInsurance: 8000, yearlyMaintenance: 5000, depreciationYear1: 15 },\n  { brand: 'Porsche', model: '911 GT3 RS', basePrice: 241300, category: 'sports-car', yearlyInsurance: 10000, yearlyMaintenance: 6000, depreciationYear1: 10 },\n  { brand: 'Porsche', model: 'Taycan Turbo S', basePrice: 185000, category: 'luxury-sedan', yearlyInsurance: 7000, yearlyMaintenance: 3000, depreciationYear1: 30 },\n  { brand: 'Porsche', model: 'Cayenne Turbo GT', basePrice: 182150, category: 'luxury-suv', yearlyInsurance: 6000, yearlyMaintenance: 4000, depreciationYear1: 25 },\n  \n  // Aston Martin\n  { brand: 'Aston Martin', model: 'DB12', basePrice: 248000, category: 'sports-car', yearlyInsurance: 11000, yearlyMaintenance: 9000, depreciationYear1: 22 },\n  { brand: 'Aston Martin', model: 'DBX707', basePrice: 247000, category: 'luxury-suv', yearlyInsurance: 10000, yearlyMaintenance: 8000, depreciationYear1: 28 },\n  { brand: 'Aston Martin', model: 'Vantage', basePrice: 139000, category: 'sports-car', yearlyInsurance: 7000, yearlyMaintenance: 6000, depreciationYear1: 20 },\n  \n  // Bentley\n  { brand: 'Bentley', model: 'Continental GT', basePrice: 236000, category: 'luxury-sedan', yearlyInsurance: 9000, yearlyMaintenance: 7000, depreciationYear1: 25 },\n  { brand: 'Bentley', model: 'Bentayga', basePrice: 200000, category: 'luxury-suv', yearlyInsurance: 8000, yearlyMaintenance: 6000, depreciationYear1: 30 },\n  { brand: 'Bentley', model: 'Flying Spur', basePrice: 214600, category: 'luxury-sedan', yearlyInsurance: 8500, yearlyMaintenance: 6500, depreciationYear1: 28 },\n  \n  // Rolls-Royce\n  { brand: 'Rolls-Royce', model: 'Ghost', basePrice: 348500, category: 'luxury-sedan', yearlyInsurance: 15000, yearlyMaintenance: 10000, depreciationYear1: 20 },\n  { brand: 'Rolls-Royce', model: 'Cullinan', basePrice: 355000, category: 'luxury-suv', yearlyInsurance: 16000, yearlyMaintenance: 11000, depreciationYear1: 22 },\n  { brand: 'Rolls-Royce', model: 'Phantom', basePrice: 460000, category: 'luxury-sedan', yearlyInsurance: 20000, yearlyMaintenance: 13000, depreciationYear1: 18 },\n];\n\n// LUXURY WATCHES\nexport const LUXURY_WATCHES: LuxuryWatch[] = [\n  { brand: 'Rolex', model: 'Daytona', price: 35000, appreciates: true },\n  { brand: 'Rolex', model: 'Submariner', price: 12000, appreciates: true },\n  { brand: 'Rolex', model: 'GMT-Master II', price: 14000, appreciates: true },\n  { brand: 'Rolex', model: 'Sky-Dweller', price: 45000, appreciates: true },\n  { brand: 'Patek Philippe', model: 'Nautilus 5711', price: 150000, appreciates: true },\n  { brand: 'Patek Philippe', model: 'Aquanaut', price: 55000, appreciates: true },\n  { brand: 'Patek Philippe', model: 'Calatrava', price: 35000, appreciates: true },\n  { brand: 'Audemars Piguet', model: 'Royal Oak', price: 85000, appreciates: true },\n  { brand: 'Audemars Piguet', model: 'Royal Oak Offshore', price: 95000, appreciates: true },\n  { brand: 'Richard Mille', model: 'RM 011', price: 180000, appreciates: false },\n  { brand: 'Richard Mille', model: 'RM 055', price: 250000, appreciates: false },\n  { brand: 'Omega', model: 'Speedmaster Professional', price: 6500, appreciates: false },\n  { brand: 'Omega', model: 'Seamaster 300M', price: 5800, appreciates: false },\n  { brand: 'Vacheron Constantin', model: 'Overseas', price: 65000, appreciates: true },\n  { brand: 'A. Lange & Söhne', model: 'Lange 1', price: 48000, appreciates: true },\n];\n\n// LUXURY YACHTS\nexport const LUXURY_YACHTS: LuxuryYacht[] = [\n  { brand: 'Sunseeker', model: 'Predator 65', length: 65, basePrice: 2800000, yearlyDocking: 150000, yearlyCrew: 200000, yearlyFuel: 180000, yearlyMaintenance: 280000 },\n  { brand: 'Azimut', model: 'Grande 35 Metri', length: 115, basePrice: 18000000, yearlyDocking: 450000, yearlyCrew: 800000, yearlyFuel: 500000, yearlyMaintenance: 1800000 },\n  { brand: 'Ferretti', model: '850', length: 85, basePrice: 8500000, yearlyDocking: 250000, yearlyCrew: 400000, yearlyFuel: 300000, yearlyMaintenance: 850000 },\n  { brand: 'Princess', model: 'Y85', length: 85, basePrice: 9200000, yearlyDocking: 260000, yearlyCrew: 420000, yearlyFuel: 320000, yearlyMaintenance: 920000 },\n  { brand: 'Benetti', model: 'Delfino 95', length: 95, basePrice: 14500000, yearlyDocking: 380000, yearlyCrew: 650000, yearlyFuel: 450000, yearlyMaintenance: 1450000 },\n  { brand: 'Lürssen', model: 'Custom 111m', length: 364, basePrice: 275000000, yearlyDocking: 2500000, yearlyCrew: 5000000, yearlyFuel: 3500000, yearlyMaintenance: 27500000 },\n  { brand: 'Feadship', model: 'Custom 78m', length: 256, basePrice: 180000000, yearlyDocking: 1800000, yearlyCrew: 3500000, yearlyFuel: 2500000, yearlyMaintenance: 18000000 },\n  { brand: 'Oceanco', model: 'Y719', length: 295, basePrice: 200000000, yearlyDocking: 2000000, yearlyCrew: 4000000, yearlyFuel: 2800000, yearlyMaintenance: 20000000 },\n  { brand: 'Heesen', model: 'Project Cosmos', length: 262, basePrice: 150000000, yearlyDocking: 1500000, yearlyCrew: 3000000, yearlyFuel: 2200000, yearlyMaintenance: 15000000 },\n  { brand: 'Sanlorenzo', model: 'SX112', length: 112, basePrice: 17500000, yearlyDocking: 420000, yearlyCrew: 750000, yearlyFuel: 480000, yearlyMaintenance: 1750000 },\n  { brand: 'Riva', model: '88 Florida', length: 88, basePrice: 7800000, yearlyDocking: 220000, yearlyCrew: 380000, yearlyFuel: 280000, yearlyMaintenance: 780000 },\n  { brand: 'Pershing', model: '140', length: 140, basePrice: 22000000, yearlyDocking: 550000, yearlyCrew: 950000, yearlyFuel: 620000, yearlyMaintenance: 2200000 },\n];\n\n// PRIVATE JETS\nexport const PRIVATE_JETS: PrivateJet[] = [\n  { manufacturer: 'Gulfstream', model: 'G650ER', basePrice: 70000000, hourlyOperating: 5500, maxRange: 7500, passengers: 19, yearlyMaintenance: 1200000 },\n  { manufacturer: 'Gulfstream', model: 'G700', basePrice: 75000000, hourlyOperating: 6000, maxRange: 7500, passengers: 19, yearlyMaintenance: 1300000 },\n  { manufacturer: 'Bombardier', model: 'Global 7500', basePrice: 73000000, hourlyOperating: 5800, maxRange: 7700, passengers: 19, yearlyMaintenance: 1250000 },\n  { manufacturer: 'Dassault', model: 'Falcon 8X', basePrice: 58000000, hourlyOperating: 4500, maxRange: 6450, passengers: 16, yearlyMaintenance: 950000 },\n  { manufacturer: 'Cessna', model: 'Citation Longitude', basePrice: 28000000, hourlyOperating: 3200, maxRange: 3500, passengers: 12, yearlyMaintenance: 580000 },\n  { manufacturer: 'Embraer', model: 'Praetor 600', basePrice: 21000000, hourlyOperating: 2800, maxRange: 4018, passengers: 12, yearlyMaintenance: 450000 },\n  { manufacturer: 'Bombardier', model: 'Challenger 350', basePrice: 27000000, hourlyOperating: 3100, maxRange: 3200, passengers: 10, yearlyMaintenance: 550000 },\n  { manufacturer: 'Cessna', model: 'Citation X+', basePrice: 23000000, hourlyOperating: 2900, maxRange: 3242, passengers: 12, yearlyMaintenance: 480000 },\n  { manufacturer: 'Gulfstream', model: 'G280', basePrice: 24500000, hourlyOperating: 2700, maxRange: 3600, passengers: 10, yearlyMaintenance: 500000 },\n  { manufacturer: 'HondaJet', model: 'Elite II', basePrice: 7200000, hourlyOperating: 1200, maxRange: 1547, passengers: 6, yearlyMaintenance: 180000 },\n  { manufacturer: 'Pilatus', model: 'PC-24', basePrice: 10900000, hourlyOperating: 1800, maxRange: 2000, passengers: 11, yearlyMaintenance: 250000 },\n  { manufacturer: 'Dassault', model: 'Falcon 2000LXS', basePrice: 35000000, hourlyOperating: 3500, maxRange: 4000, passengers: 10, yearlyMaintenance: 720000 },\n];\n\n// LUXURY REAL ESTATE (Major global markets)\nexport const LUXURY_REAL_ESTATE: LuxuryRealEstate[] = [\n  { type: 'Penthouse', location: 'Manhattan, NYC', priceRange: { min: 15000000, max: 95000000 }, avgPropertyTax: 0.88, avgHOA: 8500 },\n  { type: 'Mansion', location: 'Beverly Hills, CA', priceRange: { min: 25000000, max: 150000000 }, avgPropertyTax: 1.2, avgHOA: 5000 },\n  { type: 'Oceanfront Villa', location: 'Malibu, CA', priceRange: { min: 20000000, max: 110000000 }, avgPropertyTax: 1.25, avgHOA: 3500 },\n  { type: 'Townhouse', location: 'Knightsbridge, London', priceRange: { min: 12000000, max: 75000000 }, avgPropertyTax: 0.5, avgHOA: 6000 },\n  { type: 'Penthouse', location: 'Monaco, Monte Carlo', priceRange: { min: 35000000, max: 200000000 }, avgPropertyTax: 0, avgHOA: 12000 },\n  { type: 'Villa', location: 'Dubai Palm Jumeirah', priceRange: { min: 8000000, max: 45000000 }, avgPropertyTax: 0, avgHOA: 4500 },\n  { type: 'Apartment', location: 'Paris 8th Arr.', priceRange: { min: 10000000, max: 60000000 }, avgPropertyTax: 0.7, avgHOA: 5500 },\n  { type: 'Penthouse', location: 'Hong Kong The Peak', priceRange: { min: 40000000, max: 180000000 }, avgPropertyTax: 0, avgHOA: 9000 },\n  { type: 'Villa', location: 'Lake Como, Italy', priceRange: { min: 15000000, max: 85000000 }, avgPropertyTax: 0.76, avgHOA: 3000 },\n  { type: 'Mansion', location: 'Hamptons, NY', priceRange: { min: 18000000, max: 95000000 }, avgPropertyTax: 2.1, avgHOA: 2500 },\n  { type: 'Penthouse', location: 'Miami Beach, FL', priceRange: { min: 12000000, max: 75000000 }, avgPropertyTax: 1.02, avgHOA: 7500 },\n  { type: 'Chalet', location: 'Aspen, CO', priceRange: { min: 22000000, max: 120000000 }, avgPropertyTax: 0.55, avgHOA: 4000 },\n  { type: 'Villa', location: 'Santorini, Greece', priceRange: { min: 3500000, max: 18000000 }, avgPropertyTax: 0.3, avgHOA: 2000 },\n  { type: 'Estate', location: 'Scottsdale, AZ', priceRange: { min: 8000000, max: 45000000 }, avgPropertyTax: 0.72, avgHOA: 3500 },\n  { type: 'Penthouse', location: 'Singapore Downtown', priceRange: { min: 25000000, max: 120000000 }, avgPropertyTax: 0, avgHOA: 8000 },\n];\n\n// LUXURY JEWELRY\nexport const LUXURY_JEWELRY: LuxuryJewelry[] = [\n  { type: 'Engagement Ring', brand: 'Tiffany & Co.', priceRange: { min: 15000, max: 500000 }, appreciates: false, description: '2-5 carat diamond solitaire' },\n  { type: 'Diamond Necklace', brand: 'Cartier', priceRange: { min: 50000, max: 2000000 }, appreciates: true, description: 'Investment-grade diamonds' },\n  { type: 'Emerald Ring', brand: 'Harry Winston', priceRange: { min: 75000, max: 1500000 }, appreciates: true, description: 'Colombian emerald with diamonds' },\n  { type: 'Sapphire Bracelet', brand: 'Van Cleef & Arpels', priceRange: { min: 40000, max: 800000 }, appreciates: true, description: 'Ceylon sapphires' },\n  { type: 'Ruby Earrings', brand: 'Bulgari', priceRange: { min: 35000, max: 600000 }, appreciates: true, description: 'Burmese rubies' },\n  { type: 'Diamond Bracelet', brand: 'Graff', priceRange: { min: 120000, max: 5000000 }, appreciates: true, description: 'D-color flawless diamonds' },\n  { type: 'Pearl Necklace', brand: 'Mikimoto', priceRange: { min: 8000, max: 150000 }, appreciates: false, description: 'South Sea pearls' },\n  { type: 'Gold Watch', brand: 'Chopard', priceRange: { min: 25000, max: 300000 }, appreciates: false, description: 'Diamond-set luxury watch' },\n  { type: 'Tanzanite Ring', priceRange: { min: 12000, max: 180000 }, appreciates: true, description: 'Rare tanzanite gemstone' },\n  { type: 'Pink Diamond Ring', brand: 'De Beers', priceRange: { min: 250000, max: 10000000 }, appreciates: true, description: 'Investment-grade pink diamond' },\n];\n\n// DESIGNER FASHION\nexport const DESIGNER_FASHION: DesignerFashion[] = [\n  { brand: 'Hermès', category: 'Birkin Bag', priceRange: { min: 12000, max: 500000 }, retainsValue: true, iconic: true },\n  { brand: 'Hermès', category: 'Kelly Bag', priceRange: { min: 10000, max: 400000 }, retainsValue: true, iconic: true },\n  { brand: 'Chanel', category: 'Classic Flap Bag', priceRange: { min: 9000, max: 45000 }, retainsValue: true, iconic: true },\n  { brand: 'Louis Vuitton', category: 'Monogram Canvas Bag', priceRange: { min: 1500, max: 8000 }, retainsValue: false, iconic: true },\n  { brand: 'Dior', category: 'Lady Dior Bag', priceRange: { min: 5000, max: 25000 }, retainsValue: false, iconic: true },\n  { brand: 'Gucci', category: 'Jackie 1961 Bag', priceRange: { min: 3500, max: 15000 }, retainsValue: false, iconic: true },\n  { brand: 'Bottega Veneta', category: 'Intrecciato Bag', priceRange: { min: 3000, max: 18000 }, retainsValue: false, iconic: false },\n  { brand: 'Christian Louboutin', category: 'Heels', priceRange: { min: 700, max: 6000 }, retainsValue: false, iconic: true },\n  { brand: 'Manolo Blahnik', category: 'Hangisi Pumps', priceRange: { min: 1000, max: 5000 }, retainsValue: false, iconic: true },\n  { brand: 'Burberry', category: 'Trench Coat', priceRange: { min: 2000, max: 8000 }, retainsValue: false, iconic: true },\n  { brand: 'Tom Ford', category: 'Suit', priceRange: { min: 5000, max: 20000 }, retainsValue: false, iconic: false },\n  { brand: 'Loro Piana', category: 'Cashmere Coat', priceRange: { min: 6000, max: 25000 }, retainsValue: false, iconic: false },\n];\n\n// LUXURY ART & COLLECTIBLES\nexport const LUXURY_ART: LuxuryArt[] = [\n  { category: 'Contemporary Art (Blue-chip)', priceRange: { min: 100000, max: 50000000 }, appreciationRate: 8.5, description: 'Works by Banksy, Kaws, Basquiat' },\n  { category: 'Impressionist Paintings', priceRange: { min: 500000, max: 100000000 }, appreciationRate: 6.2, description: 'Monet, Renoir, Degas' },\n  { category: 'Modern Art', priceRange: { min: 250000, max: 75000000 }, appreciationRate: 7.1, description: 'Picasso, Warhol, Rothko' },\n  { category: 'Photography (Fine Art)', priceRange: { min: 15000, max: 5000000 }, appreciationRate: 5.8, description: 'Limited editions by masters' },\n  { category: 'Sculpture (Bronze)', priceRange: { min: 50000, max: 15000000 }, appreciationRate: 6.5, description: 'Rodin, Moore, Giacometti' },\n  { category: 'Rare Wine Collection', priceRange: { min: 10000, max: 2000000 }, appreciationRate: 9.2, description: 'Bordeaux, Burgundy investment bottles' },\n  { category: 'Classic Cars (Investment)', priceRange: { min: 500000, max: 70000000 }, appreciationRate: 12.5, description: 'Ferrari 250 GTO, vintage Porsches' },\n  { category: 'Rare Whisky', priceRange: { min: 5000, max: 500000 }, appreciationRate: 15.0, description: 'Macallan, Dalmore rare casks' },\n  { category: 'Vintage Hermès Bags', priceRange: { min: 15000, max: 500000 }, appreciationRate: 11.3, description: 'Birkin, Kelly investment pieces' },\n  { category: 'First Edition Books', priceRange: { min: 8000, max: 1000000 }, appreciationRate: 7.8, description: 'Shakespeare, Darwin, rare manuscripts' },\n];\n\n// Helper functions\nexport function findVehicle(searchTerm: string): LuxuryVehicle | null {\n  const term = searchTerm.toLowerCase();\n  return LUXURY_VEHICLES.find(v => \n    v.model.toLowerCase().includes(term) || \n    v.brand.toLowerCase().includes(term) ||\n    `${v.brand} ${v.model}`.toLowerCase().includes(term)\n  ) || null;\n}\n\nexport function getVehiclesByBrand(brand: string): LuxuryVehicle[] {\n  return LUXURY_VEHICLES.filter(v => v.brand.toLowerCase() === brand.toLowerCase());\n}\n\nexport function calculateTotalOwnershipCost(vehicle: LuxuryVehicle, years: number = 5): {\n  purchasePrice: number;\n  totalInsurance: number;\n  totalMaintenance: number;\n  totalDepreciation: number;\n  totalCost: number;\n  remainingValue: number;\n} {\n  const insurance = (vehicle.yearlyInsurance || 0) * years;\n  const maintenance = (vehicle.yearlyMaintenance || 0) * years;\n  \n  // Calculate depreciation (more aggressive in year 1)\n  const year1Depreciation = vehicle.basePrice * ((vehicle.depreciationYear1 || 20) / 100);\n  const remainingYears = years - 1;\n  const avgYearlyDepreciation = (vehicle.basePrice - year1Depreciation) * 0.10; // 10% per year after year 1\n  const totalDepreciation = year1Depreciation + (avgYearlyDepreciation * remainingYears);\n  \n  const remainingValue = Math.max(0, vehicle.basePrice - totalDepreciation);\n  const totalCost = vehicle.basePrice + insurance + maintenance;\n  \n  return {\n    purchasePrice: vehicle.basePrice,\n    totalInsurance: insurance,\n    totalMaintenance: maintenance,\n    totalDepreciation: totalDepreciation,\n    totalCost: totalCost,\n    remainingValue: remainingValue\n  };\n}\n\nexport function suggestAlternatives(targetPrice: number, category?: string): LuxuryVehicle[] {\n  const tolerance = targetPrice * 0.20; // 20% tolerance\n  let vehicles = LUXURY_VEHICLES.filter(v => \n    v.basePrice >= targetPrice - tolerance && \n    v.basePrice <= targetPrice + tolerance\n  );\n  \n  if (category) {\n    vehicles = vehicles.filter(v => v.category === category);\n  }\n  \n  return vehicles.sort((a, b) => a.basePrice - b.basePrice);\n}\n\n// Yacht helper functions\nexport function findYacht(searchTerm: string): LuxuryYacht | null {\n  const term = searchTerm.toLowerCase();\n  return LUXURY_YACHTS.find(y => \n    y.model.toLowerCase().includes(term) || \n    y.brand.toLowerCase().includes(term) ||\n    `${y.brand} ${y.model}`.toLowerCase().includes(term)\n  ) || null;\n}\n\nexport function calculateYachtOwnershipCost(yacht: LuxuryYacht, years: number = 5): {\n  purchasePrice: number;\n  totalDocking: number;\n  totalCrew: number;\n  totalFuel: number;\n  totalMaintenance: number;\n  totalCost: number;\n  annualRunningCost: number;\n} {\n  const docking = (yacht.yearlyDocking || 0) * years;\n  const crew = (yacht.yearlyCrew || 0) * years;\n  const fuel = (yacht.yearlyFuel || 0) * years;\n  const maintenance = (yacht.yearlyMaintenance || 0) * years;\n  const annualRunningCost = (yacht.yearlyDocking || 0) + (yacht.yearlyCrew || 0) + (yacht.yearlyFuel || 0) + (yacht.yearlyMaintenance || 0);\n  \n  return {\n    purchasePrice: yacht.basePrice,\n    totalDocking: docking,\n    totalCrew: crew,\n    totalFuel: fuel,\n    totalMaintenance: maintenance,\n    totalCost: yacht.basePrice + docking + crew + fuel + maintenance,\n    annualRunningCost: annualRunningCost\n  };\n}\n\n// Private jet helper functions\nexport function findJet(searchTerm: string): PrivateJet | null {\n  const term = searchTerm.toLowerCase();\n  return PRIVATE_JETS.find(j => \n    j.model.toLowerCase().includes(term) || \n    j.manufacturer.toLowerCase().includes(term) ||\n    `${j.manufacturer} ${j.model}`.toLowerCase().includes(term)\n  ) || null;\n}\n\nexport function calculateJetOwnershipCost(jet: PrivateJet, hoursPerYear: number = 200, years: number = 5): {\n  purchasePrice: number;\n  totalOperating: number;\n  totalMaintenance: number;\n  totalCost: number;\n  costPerHour: number;\n} {\n  const operating = jet.hourlyOperating * hoursPerYear * years;\n  const maintenance = (jet.yearlyMaintenance || 0) * years;\n  \n  return {\n    purchasePrice: jet.basePrice,\n    totalOperating: operating,\n    totalMaintenance: maintenance,\n    totalCost: jet.basePrice + operating + maintenance,\n    costPerHour: (jet.basePrice + operating + maintenance) / (hoursPerYear * years)\n  };\n}\n\n// Real estate helper functions\nexport function findRealEstate(location: string): LuxuryRealEstate[] {\n  const term = location.toLowerCase();\n  return LUXURY_REAL_ESTATE.filter(r => \n    r.location.toLowerCase().includes(term)\n  );\n}\n\nexport function calculateRealEstateOwnershipCost(property: LuxuryRealEstate, purchasePrice: number, years: number = 5): {\n  purchasePrice: number;\n  totalPropertyTax: number;\n  totalHOA: number;\n  totalCost: number;\n  annualCost: number;\n} {\n  const propertyTax = purchasePrice * ((property.avgPropertyTax || 0) / 100) * years;\n  const hoa = (property.avgHOA || 0) * 12 * years;\n  const annualCost = (purchasePrice * ((property.avgPropertyTax || 0) / 100)) + ((property.avgHOA || 0) * 12);\n  \n  return {\n    purchasePrice: purchasePrice,\n    totalPropertyTax: propertyTax,\n    totalHOA: hoa,\n    totalCost: purchasePrice + propertyTax + hoa,\n    annualCost: annualCost\n  };\n}\n\n// Jewelry helper functions\nexport function findJewelry(type: string): LuxuryJewelry[] {\n  const term = type.toLowerCase();\n  return LUXURY_JEWELRY.filter(j => \n    j.type.toLowerCase().includes(term) ||\n    (j.brand && j.brand.toLowerCase().includes(term))\n  );\n}\n\n// Fashion helper functions\nexport function findFashion(brand: string): DesignerFashion[] {\n  const term = brand.toLowerCase();\n  return DESIGNER_FASHION.filter(f => \n    f.brand.toLowerCase().includes(term) ||\n    f.category.toLowerCase().includes(term)\n  );\n}\n\n// Art helper functions\nexport function findArt(category: string): LuxuryArt[] {\n  const term = category.toLowerCase();\n  return LUXURY_ART.filter(a => \n    a.category.toLowerCase().includes(term)\n  );\n}\n\nexport function calculateArtAppreciation(art: LuxuryArt, purchasePrice: number, years: number = 10): {\n  purchasePrice: number;\n  appreciationRate: number;\n  projectedValue: number;\n  totalGain: number;\n  annualGain: number;\n} {\n  const projectedValue = purchasePrice * Math.pow(1 + (art.appreciationRate / 100), years);\n  const totalGain = projectedValue - purchasePrice;\n  const annualGain = totalGain / years;\n  \n  return {\n    purchasePrice: purchasePrice,\n    appreciationRate: art.appreciationRate,\n    projectedValue: projectedValue,\n    totalGain: totalGain,\n    annualGain: annualGain\n  };\n}\n","path":null,"size_bytes":24869,"size_tokens":null},"server/spendingPatternService.ts":{"content":"// Spending Pattern Recognition Service\n// Analyzes transaction history to detect behavioral patterns and spending trends\n\nexport interface Transaction {\n  id: string;\n  userId: string;\n  amount: string;\n  category: string;\n  date: Date;\n  type: 'income' | 'expense';\n  description?: string;\n}\n\nexport interface SpendingPattern {\n  category: string;\n  totalAmount: number;\n  averageAmount: number;\n  transactionCount: number;\n  percentage: number; // Percentage of total spending\n  trend: 'increasing' | 'decreasing' | 'stable';\n  frequency: 'daily' | 'weekly' | 'monthly' | 'occasional';\n}\n\nexport interface RecurringExpense {\n  category: string;\n  amount: number;\n  frequency: 'weekly' | 'monthly' | 'quarterly';\n  nextExpectedDate: Date;\n  confidence: number; // 0-1, how confident we are this is recurring\n}\n\nexport interface SpendingBehavior {\n  impulsiveBuying: {\n    detected: boolean;\n    frequency: number; // transactions per week\n    averageAmount: number;\n    categories: string[];\n  };\n  weekendSpending: {\n    weekendPercentage: number;\n    weekdayPercentage: number;\n    difference: number; // How much more/less on weekends\n  };\n  timeOfDayPatterns: {\n    morning: number; // 6am-12pm\n    afternoon: number; // 12pm-6pm\n    evening: number; // 6pm-12am\n    night: number; // 12am-6am\n  };\n  monthlyPattern: {\n    earlyMonth: number; // Days 1-10\n    midMonth: number; // Days 11-20\n    lateMonth: number; // Days 21-31\n  };\n}\n\nexport interface SpendingInsights {\n  patterns: SpendingPattern[];\n  recurringExpenses: RecurringExpense[];\n  behavior: SpendingBehavior;\n  topCategories: { category: string; amount: number; percentage: number }[];\n  unusualTransactions: { transaction: Transaction; reason: string }[];\n  recommendations: string[];\n}\n\nclass SpendingPatternService {\n  /**\n   * Analyze spending patterns from transaction history\n   */\n  analyzeSpendingPatterns(transactions: Transaction[]): SpendingInsights {\n    const expenses = transactions.filter(t => t.type === 'expense');\n    \n    if (expenses.length === 0) {\n      return {\n        patterns: [],\n        recurringExpenses: [],\n        behavior: this.getEmptyBehavior(),\n        topCategories: [],\n        unusualTransactions: [],\n        recommendations: ['Start tracking expenses to get personalized insights']\n      };\n    }\n    \n    const patterns = this.categorizeSpending(expenses);\n    const recurringExpenses = this.detectRecurringExpenses(expenses);\n    const behavior = this.analyzeBehavior(expenses);\n    const topCategories = this.getTopCategories(expenses);\n    const unusualTransactions = this.detectUnusualTransactions(expenses);\n    const recommendations = this.generateRecommendations(patterns, behavior, expenses);\n    \n    return {\n      patterns,\n      recurringExpenses,\n      behavior,\n      topCategories,\n      unusualTransactions,\n      recommendations\n    };\n  }\n  \n  /**\n   * Categorize spending by category\n   */\n  private categorizeSpending(expenses: Transaction[]): SpendingPattern[] {\n    const categoryMap = new Map<string, Transaction[]>();\n    \n    // Group by category\n    expenses.forEach(t => {\n      const category = t.category || 'Uncategorized';\n      if (!categoryMap.has(category)) {\n        categoryMap.set(category, []);\n      }\n      categoryMap.get(category)!.push(t);\n    });\n    \n    const totalSpending = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    const patterns: SpendingPattern[] = [];\n    \n    categoryMap.forEach((transactions, category) => {\n      const totalAmount = transactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);\n      const averageAmount = totalAmount / transactions.length;\n      const percentage = (totalAmount / totalSpending) * 100;\n      \n      // Analyze trend (compare first half vs second half)\n      const midpoint = Math.floor(transactions.length / 2);\n      const firstHalf = transactions.slice(0, midpoint);\n      const secondHalf = transactions.slice(midpoint);\n      \n      const firstHalfAvg = firstHalf.length > 0 \n        ? firstHalf.reduce((sum, t) => sum + parseFloat(t.amount), 0) / firstHalf.length \n        : 0;\n      const secondHalfAvg = secondHalf.length > 0\n        ? secondHalf.reduce((sum, t) => sum + parseFloat(t.amount), 0) / secondHalf.length\n        : 0;\n      \n      let trend: 'increasing' | 'decreasing' | 'stable' = 'stable';\n      const trendThreshold = 0.2; // 20% change\n      if (secondHalfAvg > firstHalfAvg * (1 + trendThreshold)) {\n        trend = 'increasing';\n      } else if (secondHalfAvg < firstHalfAvg * (1 - trendThreshold)) {\n        trend = 'decreasing';\n      }\n      \n      // Determine frequency\n      const daySpan = this.getDaySpan(transactions);\n      const frequency = this.determineFrequency(transactions.length, daySpan);\n      \n      patterns.push({\n        category,\n        totalAmount: Math.round(totalAmount * 100) / 100,\n        averageAmount: Math.round(averageAmount * 100) / 100,\n        transactionCount: transactions.length,\n        percentage: Math.round(percentage * 10) / 10,\n        trend,\n        frequency\n      });\n    });\n    \n    // Sort by total amount descending\n    return patterns.sort((a, b) => b.totalAmount - a.totalAmount);\n  }\n  \n  /**\n   * Detect recurring expenses\n   */\n  private detectRecurringExpenses(expenses: Transaction[]): RecurringExpense[] {\n    const categoryMap = new Map<string, Transaction[]>();\n    \n    expenses.forEach(t => {\n      const category = t.category || 'Uncategorized';\n      if (!categoryMap.has(category)) {\n        categoryMap.set(category, []);\n      }\n      categoryMap.get(category)!.push(t);\n    });\n    \n    const recurring: RecurringExpense[] = [];\n    \n    categoryMap.forEach((transactions, category) => {\n      if (transactions.length < 3) return; // Need at least 3 occurrences\n      \n      // Sort by date\n      const sorted = [...transactions].sort((a, b) => a.date.getTime() - b.date.getTime());\n      \n      // Calculate intervals between transactions\n      const intervals: number[] = [];\n      for (let i = 1; i < sorted.length; i++) {\n        const dayDiff = (sorted[i].date.getTime() - sorted[i-1].date.getTime()) / (1000 * 60 * 60 * 24);\n        intervals.push(dayDiff);\n      }\n      \n      // Check if intervals are consistent (within 20% variance)\n      const avgInterval = intervals.reduce((sum, val) => sum + val, 0) / intervals.length;\n      const variance = intervals.reduce((sum, val) => sum + Math.pow(val - avgInterval, 2), 0) / intervals.length;\n      const stdDev = Math.sqrt(variance);\n      const coefficientOfVariation = stdDev / avgInterval;\n      \n      if (coefficientOfVariation < 0.3) { // Reasonably consistent\n        let frequency: 'weekly' | 'monthly' | 'quarterly' = 'monthly';\n        if (avgInterval < 10) frequency = 'weekly';\n        else if (avgInterval > 60) frequency = 'quarterly';\n        \n        const averageAmount = sorted.reduce((sum, t) => sum + parseFloat(t.amount), 0) / sorted.length;\n        const lastDate = sorted[sorted.length - 1].date;\n        const nextExpectedDate = new Date(lastDate.getTime() + avgInterval * 24 * 60 * 60 * 1000);\n        \n        recurring.push({\n          category,\n          amount: Math.round(averageAmount * 100) / 100,\n          frequency,\n          nextExpectedDate,\n          confidence: Math.max(0, 1 - coefficientOfVariation)\n        });\n      }\n    });\n    \n    return recurring.sort((a, b) => b.amount - a.amount);\n  }\n  \n  /**\n   * Analyze spending behavior\n   */\n  private analyzeBehavior(expenses: Transaction[]): SpendingBehavior {\n    if (expenses.length === 0) return this.getEmptyBehavior();\n    \n    // Impulsive buying detection (small frequent purchases)\n    const smallPurchases = expenses.filter(t => parseFloat(t.amount) < 50);\n    const daySpan = this.getDaySpan(expenses);\n    const weeksSpan = Math.max(1, daySpan / 7);\n    const impulsiveFrequency = smallPurchases.length / weeksSpan;\n    const impulsiveCategories = Array.from(new Set(smallPurchases.map(t => t.category)));\n    \n    // Weekend vs weekday spending\n    let weekendTotal = 0;\n    let weekdayTotal = 0;\n    expenses.forEach(t => {\n      const amount = parseFloat(t.amount);\n      const dayOfWeek = t.date.getDay();\n      if (dayOfWeek === 0 || dayOfWeek === 6) {\n        weekendTotal += amount;\n      } else {\n        weekdayTotal += amount;\n      }\n    });\n    const totalSpending = weekendTotal + weekdayTotal;\n    const weekendPercentage = (weekendTotal / totalSpending) * 100;\n    const weekdayPercentage = (weekdayTotal / totalSpending) * 100;\n    \n    // Time of day patterns\n    const timePatterns = { morning: 0, afternoon: 0, evening: 0, night: 0 };\n    expenses.forEach(t => {\n      const hour = t.date.getHours();\n      const amount = parseFloat(t.amount);\n      if (hour >= 6 && hour < 12) timePatterns.morning += amount;\n      else if (hour >= 12 && hour < 18) timePatterns.afternoon += amount;\n      else if (hour >= 18 && hour < 24) timePatterns.evening += amount;\n      else timePatterns.night += amount;\n    });\n    \n    // Monthly pattern (early/mid/late month)\n    const monthlyPattern = { earlyMonth: 0, midMonth: 0, lateMonth: 0 };\n    expenses.forEach(t => {\n      const day = t.date.getDate();\n      const amount = parseFloat(t.amount);\n      if (day <= 10) monthlyPattern.earlyMonth += amount;\n      else if (day <= 20) monthlyPattern.midMonth += amount;\n      else monthlyPattern.lateMonth += amount;\n    });\n    \n    return {\n      impulsiveBuying: {\n        detected: impulsiveFrequency > 5, // More than 5 small purchases per week\n        frequency: Math.round(impulsiveFrequency * 10) / 10,\n        averageAmount: smallPurchases.length > 0 \n          ? Math.round((smallPurchases.reduce((sum, t) => sum + parseFloat(t.amount), 0) / smallPurchases.length) * 100) / 100\n          : 0,\n        categories: impulsiveCategories\n      },\n      weekendSpending: {\n        weekendPercentage: Math.round(weekendPercentage * 10) / 10,\n        weekdayPercentage: Math.round(weekdayPercentage * 10) / 10,\n        difference: Math.round((weekendPercentage - (weekdayPercentage * 2/5)) * 10) / 10\n      },\n      timeOfDayPatterns: {\n        morning: Math.round(timePatterns.morning * 100) / 100,\n        afternoon: Math.round(timePatterns.afternoon * 100) / 100,\n        evening: Math.round(timePatterns.evening * 100) / 100,\n        night: Math.round(timePatterns.night * 100) / 100\n      },\n      monthlyPattern: {\n        earlyMonth: Math.round(monthlyPattern.earlyMonth * 100) / 100,\n        midMonth: Math.round(monthlyPattern.midMonth * 100) / 100,\n        lateMonth: Math.round(monthlyPattern.lateMonth * 100) / 100\n      }\n    };\n  }\n  \n  /**\n   * Get top spending categories\n   */\n  private getTopCategories(expenses: Transaction[]): { category: string; amount: number; percentage: number }[] {\n    const categoryMap = new Map<string, number>();\n    const totalSpending = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n    expenses.forEach(t => {\n      const category = t.category || 'Uncategorized';\n      const current = categoryMap.get(category) || 0;\n      categoryMap.set(category, current + parseFloat(t.amount));\n    });\n    \n    const categories = Array.from(categoryMap.entries()).map(([category, amount]) => ({\n      category,\n      amount: Math.round(amount * 100) / 100,\n      percentage: Math.round((amount / totalSpending) * 100 * 10) / 10\n    }));\n    \n    return categories.sort((a, b) => b.amount - a.amount).slice(0, 5);\n  }\n  \n  /**\n   * Detect unusual transactions\n   */\n  private detectUnusualTransactions(expenses: Transaction[]): { transaction: Transaction; reason: string }[] {\n    if (expenses.length < 5) return [];\n    \n    const amounts = expenses.map(t => parseFloat(t.amount));\n    const avg = amounts.reduce((sum, val) => sum + val, 0) / amounts.length;\n    const variance = amounts.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / amounts.length;\n    const stdDev = Math.sqrt(variance);\n    \n    const unusual: { transaction: Transaction; reason: string }[] = [];\n    \n    expenses.forEach(t => {\n      const amount = parseFloat(t.amount);\n      \n      // Outlier detection (more than 2 standard deviations from mean)\n      if (amount > avg + (2 * stdDev)) {\n        unusual.push({\n          transaction: t,\n          reason: `Unusually large amount ($${amount.toFixed(2)} vs average $${avg.toFixed(2)})`\n        });\n      }\n      \n      // Same-day multiple large purchases\n      const sameDay = expenses.filter(e => \n        e.date.toDateString() === t.date.toDateString() && \n        parseFloat(e.amount) > avg\n      );\n      if (sameDay.length > 3 && amount > avg) {\n        unusual.push({\n          transaction: t,\n          reason: `Multiple large purchases on same day (${sameDay.length} transactions)`\n        });\n      }\n    });\n    \n    // Remove duplicates and limit to top 5\n    const seen = new Set();\n    return unusual\n      .filter(u => {\n        if (seen.has(u.transaction.id)) return false;\n        seen.add(u.transaction.id);\n        return true;\n      })\n      .slice(0, 5);\n  }\n  \n  /**\n   * Generate personalized recommendations\n   */\n  private generateRecommendations(\n    patterns: SpendingPattern[],\n    behavior: SpendingBehavior,\n    expenses: Transaction[]\n  ): string[] {\n    const recommendations: string[] = [];\n    \n    // Impulsive buying recommendations\n    if (behavior.impulsiveBuying.detected) {\n      recommendations.push(\n        `You make ${behavior.impulsiveBuying.frequency} small purchases weekly (avg $${behavior.impulsiveBuying.averageAmount}). Try the 24-hour rule: wait a day before buying to reduce impulse spending by 30%.`\n      );\n    }\n    \n    // Weekend spending recommendations\n    if (behavior.weekendSpending.weekendPercentage > 40) {\n      recommendations.push(\n        `${behavior.weekendSpending.weekendPercentage}% of spending happens on weekends. Plan weekend activities in advance to avoid overspending.`\n      );\n    }\n    \n    // Increasing trend recommendations\n    const increasingCategories = patterns.filter(p => p.trend === 'increasing');\n    if (increasingCategories.length > 0) {\n      const top = increasingCategories[0];\n      recommendations.push(\n        `${top.category} spending is increasing (${top.percentage}% of budget). Set a monthly limit of $${Math.round(top.averageAmount * 4)} to control costs.`\n      );\n    }\n    \n    // High single category recommendations\n    const topCategory = patterns[0];\n    if (topCategory && topCategory.percentage > 40) {\n      recommendations.push(\n        `${topCategory.category} takes ${topCategory.percentage}% of your budget. Consider finding cheaper alternatives or reducing frequency.`\n      );\n    }\n    \n    // Monthly pattern recommendations\n    if (behavior.monthlyPattern.lateMonth > behavior.monthlyPattern.earlyMonth * 1.5) {\n      recommendations.push(\n        `You spend more late in the month. This suggests budget depletion - try spreading expenses evenly or increasing early-month savings.`\n      );\n    }\n    \n    // Default recommendation if none generated\n    if (recommendations.length === 0) {\n      recommendations.push(\n        'Your spending patterns look balanced. Keep tracking to maintain healthy financial habits.'\n      );\n    }\n    \n    return recommendations.slice(0, 5); // Limit to 5 recommendations\n  }\n  \n  /**\n   * Get context for AI\n   */\n  getSpendingPatternsForAI(transactions: Transaction[]): string {\n    const insights = this.analyzeSpendingPatterns(transactions);\n    \n    if (insights.patterns.length === 0) {\n      return '\\nSPENDING PATTERNS: No transaction data available yet';\n    }\n    \n    const topPatterns = insights.topCategories.slice(0, 3);\n    const behaviorNotes: string[] = [];\n    \n    if (insights.behavior.impulsiveBuying.detected) {\n      behaviorNotes.push(`Impulsive buying detected: ${insights.behavior.impulsiveBuying.frequency} small purchases/week`);\n    }\n    \n    if (insights.behavior.weekendSpending.weekendPercentage > 40) {\n      behaviorNotes.push(`Weekend heavy spender: ${insights.behavior.weekendSpending.weekendPercentage}% on weekends`);\n    }\n    \n    const recurringInfo = insights.recurringExpenses.length > 0\n      ? `\\n• Recurring: ${insights.recurringExpenses.slice(0, 2).map(r => `${r.category} ($${r.amount}/${r.frequency})`).join(', ')}`\n      : '';\n    \n    return `\nSPENDING PATTERN ANALYSIS:\n• Top Categories: ${topPatterns.map(c => `${c.category} (${c.percentage}%)`).join(', ')}${recurringInfo}\n${behaviorNotes.length > 0 ? behaviorNotes.map(n => `• ${n}`).join('\\n') : ''}\n• Key Insights: ${insights.recommendations[0] || 'Balanced spending'}\n\nUse these insights to give personalized budgeting advice.`;\n  }\n  \n  /**\n   * Helper functions\n   */\n  private getDaySpan(transactions: Transaction[]): number {\n    if (transactions.length === 0) return 0;\n    const dates = transactions.map(t => t.date.getTime());\n    const min = Math.min(...dates);\n    const max = Math.max(...dates);\n    return Math.max(1, (max - min) / (1000 * 60 * 60 * 24));\n  }\n  \n  private determineFrequency(count: number, daySpan: number): 'daily' | 'weekly' | 'monthly' | 'occasional' {\n    const perDay = count / Math.max(1, daySpan);\n    if (perDay >= 0.8) return 'daily';\n    if (perDay >= 0.2) return 'weekly';\n    if (perDay >= 0.05) return 'monthly';\n    return 'occasional';\n  }\n  \n  private getEmptyBehavior(): SpendingBehavior {\n    return {\n      impulsiveBuying: {\n        detected: false,\n        frequency: 0,\n        averageAmount: 0,\n        categories: []\n      },\n      weekendSpending: {\n        weekendPercentage: 0,\n        weekdayPercentage: 0,\n        difference: 0\n      },\n      timeOfDayPatterns: {\n        morning: 0,\n        afternoon: 0,\n        evening: 0,\n        night: 0\n      },\n      monthlyPattern: {\n        earlyMonth: 0,\n        midMonth: 0,\n        lateMonth: 0\n      }\n    };\n  }\n}\n\nexport const spendingPatternService = new SpendingPatternService();\n","path":null,"size_bytes":17949,"size_tokens":null},"server/proactiveInsightsService.ts":{"content":"import type { IStorage } from './storage';\nimport type { Transaction, FinancialGoal } from '@shared/schema';\n\nexport interface ProactiveInsight {\n  id: string;\n  type: 'spending_anomaly' | 'savings_opportunity' | 'goal_deadline' | 'budget_warning' | 'achievement';\n  priority: 'high' | 'medium' | 'low';\n  title: string;\n  message: string;\n  actionable: string;\n  emoji: string;\n  data?: any;\n  createdAt: Date;\n}\n\nfunction generateInsightId(): string {\n  return `insight_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\nexport async function generateProactiveInsights(\n  storage: IStorage,\n  userId: string\n): Promise<ProactiveInsight[]> {\n  const insights: ProactiveInsight[] = [];\n\n  try {\n    const [transactions, goals, prefs, stats] = await Promise.all([\n      storage.getTransactionsByUserId(userId, 90),\n      storage.getFinancialGoalsByUserId(userId),\n      storage.getUserPreferences(userId),\n      storage.getUserStats(userId)\n    ]);\n\n    const now = new Date();\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n\n    // 1. SPENDING ANOMALY DETECTION\n    \n    // Detect unusually large transactions\n    const recentTransactions = transactions.filter(t => t.date >= sevenDaysAgo);\n    const avgTransactionAmount = recentTransactions.length > 0\n      ? recentTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0) / recentTransactions.length\n      : 0;\n\n    recentTransactions.forEach(t => {\n      const amount = parseFloat(t.amount);\n      if (amount > avgTransactionAmount * 3 && amount > 100) {\n        insights.push({\n          id: generateInsightId(),\n          type: 'spending_anomaly',\n          priority: amount > 500 ? 'high' : 'medium',\n          title: 'Unusual Large Purchase Detected',\n          message: `You spent $${amount.toLocaleString()} on ${t.category} - 3x your average transaction.`,\n          actionable: `Review this ${t.category} expense. Was it planned? Consider setting a spending alert for purchases over $${Math.round(avgTransactionAmount * 2)}.`,\n          emoji: '',\n          data: { transaction: t, avgAmount: avgTransactionAmount },\n          createdAt: new Date()\n        });\n      }\n    });\n\n    // Category overspending\n    const categorySpending = new Map<string, number>();\n    const lastMonthTransactions = transactions.filter(t => \n      t.type === 'expense' && t.date >= thirtyDaysAgo\n    );\n\n    lastMonthTransactions.forEach(t => {\n      const category = t.category;\n      categorySpending.set(category, (categorySpending.get(category) || 0) + parseFloat(t.amount));\n    });\n\n    const monthlyIncome = stats.monthlyIncome || parseFloat(prefs?.monthlyIncomeEstimate?.toString() || '0');\n    \n    categorySpending.forEach((amount, category) => {\n      const percentOfIncome = monthlyIncome > 0 ? (amount / monthlyIncome) * 100 : 0;\n      \n      if (percentOfIncome > 30 && category !== 'housing' && category !== 'rent') {\n        insights.push({\n          id: generateInsightId(),\n          type: 'spending_anomaly',\n          priority: 'high',\n          title: `High ${category} Spending`,\n          message: `Your ${category} spending is $${amount.toLocaleString()}/month (${percentOfIncome.toFixed(0)}% of income).`,\n          actionable: `This is above the recommended 20% limit. Try reducing ${category} spending by 25% to save $${Math.round(amount * 0.25).toLocaleString()}/month.`,\n          emoji: '',\n          data: { category, amount, percentOfIncome },\n          createdAt: new Date()\n        });\n      }\n    });\n\n    // 2. SAVINGS OPPORTUNITIES\n\n    // Detect recurring subscriptions\n    const subscriptionKeywords = ['subscription', 'netflix', 'spotify', 'gym', 'membership', 'monthly'];\n    const subscriptions = transactions.filter(t =>\n      t.type === 'expense' &&\n      subscriptionKeywords.some(keyword => \n        t.description?.toLowerCase().includes(keyword) || \n        t.category.toLowerCase().includes(keyword)\n      )\n    );\n\n    if (subscriptions.length >= 3) {\n      const totalSubCost = subscriptions.reduce((sum, s) => sum + parseFloat(s.amount), 0);\n      insights.push({\n        id: generateInsightId(),\n        type: 'savings_opportunity',\n        priority: 'medium',\n        title: 'Subscription Audit Recommended',\n        message: `You have ${subscriptions.length} subscriptions costing ~$${totalSubCost.toLocaleString()}/month.`,\n        actionable: `Review and cancel unused subscriptions. Even cutting 2 subscriptions could save $${Math.round(totalSubCost * 0.3).toLocaleString()}/month = $${Math.round(totalSubCost * 0.3 * 12).toLocaleString()}/year.`,\n        emoji: '',\n        data: { subscriptions, totalCost: totalSubCost },\n        createdAt: new Date()\n      });\n    }\n\n    // High dining out spending\n    const diningCategories = ['dining', 'food', 'restaurant', 'delivery'];\n    const diningSpend = lastMonthTransactions\n      .filter(t => diningCategories.some(cat => t.category.toLowerCase().includes(cat)))\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    if (diningSpend > 500) {\n      const cookingSavings = diningSpend * 0.6; // Cooking saves ~60%\n      insights.push({\n        id: generateInsightId(),\n        type: 'savings_opportunity',\n        priority: 'medium',\n        title: 'Dining Out Opportunity',\n        message: `You spent $${diningSpend.toLocaleString()} on dining out this month.`,\n        actionable: `Cooking 3 more meals/week could save $${Math.round(cookingSavings).toLocaleString()}/month. Use meal prep Sunday to save time and money.`,\n        emoji: '',\n        data: { diningSpend, potentialSavings: cookingSavings },\n        createdAt: new Date()\n      });\n    }\n\n    // Recommend high-yield savings if cash heavy\n    const totalSavings = stats.totalSavings || parseFloat(prefs?.currentSavingsEstimate?.toString() || '0');\n    if (totalSavings > 10000) {\n      insights.push({\n        id: generateInsightId(),\n        type: 'savings_opportunity',\n        priority: 'low',\n        title: 'High-Yield Savings Opportunity',\n        message: `You have $${totalSavings.toLocaleString()} in savings. Are you earning 4-5% interest?`,\n        actionable: `Move funds to a high-yield savings account (4-5% APY) to earn $${Math.round(totalSavings * 0.045 / 12).toLocaleString()}/month passive income instead of 0.01%.`,\n        emoji: '',\n        data: { totalSavings, potentialInterest: totalSavings * 0.045 },\n        createdAt: new Date()\n      });\n    }\n\n    // 3. GOAL DEADLINE REMINDERS\n\n    const activeGoals = goals.filter(g => g.status === 'active');\n    activeGoals.forEach(goal => {\n      const targetDate = new Date(goal.targetDate);\n      const daysUntilDeadline = Math.ceil((targetDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n      const targetAmount = parseFloat(goal.targetAmount);\n      const currentAmount = parseFloat(goal.currentAmount || '0');\n      const remaining = targetAmount - currentAmount;\n      const percentComplete = (currentAmount / targetAmount) * 100;\n\n      // Urgent deadline approaching\n      if (daysUntilDeadline <= 30 && percentComplete < 90) {\n        insights.push({\n          id: generateInsightId(),\n          type: 'goal_deadline',\n          priority: 'high',\n          title: `Goal Deadline Approaching: ${goal.title}`,\n          message: `Only ${daysUntilDeadline} days left! You're ${percentComplete.toFixed(0)}% there.`,\n          actionable: `Need $${remaining.toLocaleString()} more. Save $${Math.round(remaining / (daysUntilDeadline / 30)).toLocaleString()}/month or extend deadline by ${Math.ceil(remaining / (monthlyIncome * 0.1))} months.`,\n          emoji: '',\n          data: { goal, daysRemaining: daysUntilDeadline, remaining },\n          createdAt: new Date()\n        });\n      }\n\n      // Milestone reminder\n      if (percentComplete >= 45 && percentComplete < 55) {\n        insights.push({\n          id: generateInsightId(),\n          type: 'achievement',\n          priority: 'low',\n          title: `Almost Halfway: ${goal.title}`,\n          message: `You're at ${percentComplete.toFixed(0)}%! The 50% milestone is just $${(targetAmount * 0.5 - currentAmount).toLocaleString()} away.`,\n          actionable: `One more push to hit 50%! Reaching this milestone will give you major momentum.`,\n          emoji: '',\n          data: { goal, percentComplete },\n          createdAt: new Date()\n        });\n      }\n    });\n\n    // 4. BUDGET WARNINGS\n\n    const monthlyExpenses = lastMonthTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    const budgetEstimate = parseFloat(prefs?.monthlyExpensesEstimate?.toString() || '0');\n\n    if (budgetEstimate > 0 && monthlyExpenses > budgetEstimate * 1.2) {\n      const overspend = monthlyExpenses - budgetEstimate;\n      insights.push({\n        id: generateInsightId(),\n        type: 'budget_warning',\n        priority: 'high',\n        title: 'Budget Exceeded',\n        message: `You've spent $${monthlyExpenses.toLocaleString()} this month, ${((monthlyExpenses / budgetEstimate - 1) * 100).toFixed(0)}% over your $${budgetEstimate.toLocaleString()} budget.`,\n        actionable: `Review discretionary spending and cut back $${Math.round(overspend).toLocaleString()} to stay on track. Top categories to review: ${Array.from(categorySpending.entries()).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([cat]) => cat).join(', ')}.`,\n        emoji: '',\n        data: { monthlyExpenses, budgetEstimate, overspend },\n        createdAt: new Date()\n      });\n    }\n\n    // 5. ACHIEVEMENT CELEBRATIONS\n\n    // Savings streak\n    const last3MonthsIncome = transactions\n      .filter(t => t.type === 'income' && t.date >= new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000))\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n    const last3MonthsExpenses = transactions\n      .filter(t => t.type === 'expense' && t.date >= new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000))\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    if (last3MonthsIncome > last3MonthsExpenses && last3MonthsIncome > 0) {\n      const savingsRate = ((last3MonthsIncome - last3MonthsExpenses) / last3MonthsIncome) * 100;\n      if (savingsRate >= 15) {\n        insights.push({\n          id: generateInsightId(),\n          type: 'achievement',\n          priority: 'low',\n          title: 'Impressive Savings Discipline!',\n          message: `You've maintained a ${savingsRate.toFixed(0)}% savings rate for 3 months straight!`,\n          actionable: `You're building serious wealth! At this rate, you'll save $${Math.round((last3MonthsIncome - last3MonthsExpenses) / 3 * 12).toLocaleString()}/year. Keep this momentum!`,\n          emoji: '',\n          data: { savingsRate, monthlySavings: (last3MonthsIncome - last3MonthsExpenses) / 3 },\n          createdAt: new Date()\n        });\n      }\n    }\n\n    // Sort insights by priority (high -> medium -> low)\n    const priorityOrder = { high: 0, medium: 1, low: 2 };\n    insights.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);\n\n    return insights;\n\n  } catch (error) {\n    console.error('Error generating proactive insights:', error);\n    throw error;\n  }\n}\n\n/**\n * Weekly Financial Summary Generator\n * Provides a comprehensive overview of the user's financial week\n */\nexport interface WeeklySummary {\n  weekStarting: string; // ISO date string\n  weekEnding: string; // ISO date string\n  totalIncome: number;\n  totalExpenses: number;\n  netCashFlow: number;\n  savingsRate: number;\n  topSpendingCategories: Array<{ category: string; amount: number; percentOfTotal: number }>;\n  comparisonToPreviousWeek: {\n    incomeChange: number;\n    expenseChange: number;\n    trend: 'improving' | 'stable' | 'declining';\n  };\n  goalProgress: Array<{ goalName: string; previousPercent: number; currentPercent: number; change: number }>;\n  keyHighlights: string[];\n  actionItems: string[];\n}\n\nexport async function generateWeeklySummary(\n  storage: IStorage,\n  userId: string\n): Promise<WeeklySummary> {\n  const now = new Date();\n  const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n  const previousWeekStart = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);\n\n  const [transactions, goals, prefs] = await Promise.all([\n    storage.getTransactionsByUserId(userId, 30),\n    storage.getFinancialGoalsByUserId(userId),\n    storage.getUserPreferences(userId)\n  ]);\n\n  // This week's transactions\n  const thisWeekTransactions = transactions.filter(t => t.date >= weekStart);\n  const previousWeekTransactions = transactions.filter(t => t.date >= previousWeekStart && t.date < weekStart);\n\n  // Calculate totals\n  const thisWeekIncome = thisWeekTransactions\n    .filter(t => t.type === 'income')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n  const thisWeekExpenses = thisWeekTransactions\n    .filter(t => t.type === 'expense')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n  const netCashFlow = thisWeekIncome - thisWeekExpenses;\n  const savingsRate = thisWeekIncome > 0 ? ((thisWeekIncome - thisWeekExpenses) / thisWeekIncome) * 100 : 0;\n\n  // Previous week comparison\n  const prevWeekIncome = previousWeekTransactions\n    .filter(t => t.type === 'income')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n  const prevWeekExpenses = previousWeekTransactions\n    .filter(t => t.type === 'expense')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n  // Handle edge cases for percentage calculations (avoid NaN/Infinity)\n  const incomeChange = prevWeekIncome > 0 \n    ? Math.round(((thisWeekIncome - prevWeekIncome) / prevWeekIncome) * 100 * 10) / 10 \n    : (thisWeekIncome > 0 ? 100 : 0);\n  const expenseChange = prevWeekExpenses > 0 \n    ? Math.round(((thisWeekExpenses - prevWeekExpenses) / prevWeekExpenses) * 100 * 10) / 10 \n    : (thisWeekExpenses > 0 ? 100 : 0);\n\n  // Determine trend with null-safe comparison\n  const prevNetCashFlow = prevWeekIncome - prevWeekExpenses;\n  let trend: 'improving' | 'stable' | 'declining';\n  if (prevNetCashFlow === 0 && netCashFlow === 0) {\n    trend = 'stable';\n  } else if (prevNetCashFlow === 0) {\n    trend = netCashFlow > 0 ? 'improving' : 'declining';\n  } else if (netCashFlow > prevNetCashFlow * 1.1) {\n    trend = 'improving';\n  } else if (netCashFlow < prevNetCashFlow * 0.9) {\n    trend = 'declining';\n  } else {\n    trend = 'stable';\n  }\n\n  // Top spending categories\n  const categoryTotals = new Map<string, number>();\n  thisWeekTransactions\n    .filter(t => t.type === 'expense')\n    .forEach(t => {\n      categoryTotals.set(t.category, (categoryTotals.get(t.category) || 0) + parseFloat(t.amount));\n    });\n\n  const topSpendingCategories = Array.from(categoryTotals.entries())\n    .map(([category, amount]) => ({\n      category,\n      amount,\n      percentOfTotal: thisWeekExpenses > 0 ? (amount / thisWeekExpenses) * 100 : 0\n    }))\n    .sort((a, b) => b.amount - a.amount)\n    .slice(0, 5);\n\n  // Goal progress\n  const goalProgress = goals\n    .filter(g => g.status === 'active')\n    .slice(0, 3)\n    .map(goal => {\n      const targetAmount = parseFloat(goal.targetAmount);\n      const currentAmount = parseFloat(goal.currentAmount || '0');\n      const currentPercent = (currentAmount / targetAmount) * 100;\n      const change = netCashFlow > 0 ? (netCashFlow / targetAmount) * 100 : 0;\n      return {\n        goalName: goal.title,\n        previousPercent: Math.max(0, currentPercent - change),\n        currentPercent,\n        change\n      };\n    });\n\n  // Generate key highlights\n  const keyHighlights: string[] = [];\n  if (netCashFlow > 0) {\n    keyHighlights.push(`Positive cash flow: +$${netCashFlow.toLocaleString()}`);\n  } else if (netCashFlow < 0) {\n    keyHighlights.push(`Negative cash flow: -$${Math.abs(netCashFlow).toLocaleString()}`);\n  }\n  if (savingsRate >= 20) {\n    keyHighlights.push(`Strong savings rate: ${savingsRate.toFixed(0)}%`);\n  }\n  if (trend === 'improving') {\n    keyHighlights.push('Financial trend improving vs last week');\n  }\n  if (topSpendingCategories.length > 0) {\n    keyHighlights.push(`Top expense: ${topSpendingCategories[0].category} ($${topSpendingCategories[0].amount.toLocaleString()})`);\n  }\n\n  // Generate action items\n  const actionItems: string[] = [];\n  if (savingsRate < 10 && thisWeekIncome > 0) {\n    actionItems.push('Consider reducing discretionary spending to boost savings');\n  }\n  if (expenseChange > 20) {\n    actionItems.push(`Expenses up ${expenseChange.toFixed(0)}% - review recent purchases`);\n  }\n  if (goalProgress.some(g => g.change > 0)) {\n    actionItems.push('Keep momentum on your savings goals');\n  }\n  if (topSpendingCategories.some(c => c.percentOfTotal > 40 && c.category !== 'housing')) {\n    const highCat = topSpendingCategories.find(c => c.percentOfTotal > 40 && c.category !== 'housing');\n    if (highCat) {\n      actionItems.push(`${highCat.category} is ${highCat.percentOfTotal.toFixed(0)}% of spending - consider setting a budget`);\n    }\n  }\n\n  return {\n    weekStarting: weekStart.toISOString(),\n    weekEnding: now.toISOString(),\n    totalIncome: Math.round(thisWeekIncome * 100) / 100,\n    totalExpenses: Math.round(thisWeekExpenses * 100) / 100,\n    netCashFlow: Math.round(netCashFlow * 100) / 100,\n    savingsRate: Math.round(savingsRate * 10) / 10,\n    topSpendingCategories: topSpendingCategories.map(c => ({\n      ...c,\n      amount: Math.round(c.amount * 100) / 100,\n      percentOfTotal: Math.round(c.percentOfTotal * 10) / 10\n    })),\n    comparisonToPreviousWeek: {\n      incomeChange,\n      expenseChange,\n      trend\n    },\n    goalProgress: goalProgress.map(g => ({\n      ...g,\n      previousPercent: Math.round(g.previousPercent * 10) / 10,\n      currentPercent: Math.round(g.currentPercent * 10) / 10,\n      change: Math.round(g.change * 10) / 10\n    })),\n    keyHighlights,\n    actionItems\n  };\n}\n","path":null,"size_bytes":17830,"size_tokens":null},"server/goalMilestoneService.ts":{"content":"import type { IStorage } from './storage';\n\nexport interface GoalProgress {\n  goalId: string;\n  goalTitle: string;\n  targetAmount: number;\n  currentAmount: number;\n  percentComplete: number;\n  milestone: 'started' | '25%' | '50%' | '75%' | 'complete' | null;\n  daysRemaining: number;\n  targetDate: Date;\n  isOnTrack: boolean;\n  requiredMonthlyContribution: number;\n  celebration?: string;\n  motivationalMessage: string;\n  nextMilestone: string;\n}\n\nexport interface MilestoneEvent {\n  type: 'milestone_reached' | 'goal_completed' | 'goal_at_risk' | 'ahead_of_schedule';\n  goalId: string;\n  goalTitle: string;\n  message: string;\n  celebrationEmoji: string;\n  actionRequired?: string;\n}\n\nfunction getMilestoneLevel(percentComplete: number): '25%' | '50%' | '75%' | 'complete' | null {\n  if (percentComplete >= 100) return 'complete';\n  if (percentComplete >= 75) return '75%';\n  if (percentComplete >= 50) return '50%';\n  if (percentComplete >= 25) return '25%';\n  return null;\n}\n\nfunction getCelebrationMessage(milestone: string, goalTitle: string, percentComplete: number): string {\n  switch (milestone) {\n    case '25%':\n      return `Quarter way there! You've saved 25% for \"${goalTitle}\". Momentum is building.`;\n    case '50%':\n      return `Halfway point! You're 50% towards \"${goalTitle}\". The finish line is in sight.`;\n    case '75%':\n      return `Three quarters done! You're at 75% for \"${goalTitle}\". Almost there, keep pushing.`;\n    case 'complete':\n      return `GOAL ACHIEVED! You did it! \"${goalTitle}\" is complete at ${percentComplete.toFixed(1)}%. Celebrate this win.`;\n    default:\n      return `Great start on \"${goalTitle}\". Every dollar saved brings you closer.`;\n  }\n}\n\nfunction getMotivationalMessage(percentComplete: number, isOnTrack: boolean, daysRemaining: number): string {\n  if (percentComplete >= 100) {\n    return `Incredible discipline! Time to set your next ambitious goal and keep the momentum going.`;\n  }\n  \n  if (isOnTrack) {\n    if (percentComplete >= 75) {\n      return `You're crushing it! Just ${(100 - percentComplete).toFixed(1)}% to go. The finish line is within reach!`;\n    } else if (percentComplete >= 50) {\n      return `Excellent progress! You're on pace to hit your goal. Stay consistent with your contributions.`;\n    } else if (percentComplete >= 25) {\n      return `Solid foundation! You're on track. Keep up the steady contributions to reach your goal on time.`;\n    } else {\n      return `Great start! You're on schedule. Consistency is key - stick to your monthly savings plan.`;\n    }\n  } else {\n    const remaining = 100 - percentComplete;\n    if (daysRemaining < 30) {\n      return `Critical: ${daysRemaining} days left, ${remaining.toFixed(1)}% to go. Consider a final push or adjust timeline.`;\n    } else if (daysRemaining < 90) {\n      return `Behind schedule with ${daysRemaining} days left. Need to increase monthly contributions by 50% to hit target.`;\n    } else {\n      return `Behind pace but recoverable. Time to reassess and increase monthly contributions to get back on track.`;\n    }\n  }\n}\n\nfunction getNextMilestone(percentComplete: number): string {\n  if (percentComplete >= 100) return 'Goal achieved';\n  if (percentComplete >= 75) return 'Next: 100% completion';\n  if (percentComplete >= 50) return 'Next: 75% milestone';\n  if (percentComplete >= 25) return 'Next: 50% halfway mark';\n  return 'Next: 25% first milestone';\n}\n\nexport async function checkGoalProgress(\n  storage: IStorage,\n  userId: string\n): Promise<{ progress: GoalProgress[]; events: MilestoneEvent[] }> {\n  try {\n    const goals = await storage.getFinancialGoalsByUserId(userId);\n    const activeGoals = goals.filter(g => g.status === 'active');\n\n    const progressList: GoalProgress[] = [];\n    const events: MilestoneEvent[] = [];\n\n    for (const goal of activeGoals) {\n      const targetAmount = parseFloat(goal.targetAmount);\n      const currentAmount = parseFloat(goal.currentAmount || '0');\n      const percentComplete = (currentAmount / targetAmount) * 100;\n      \n      const now = new Date();\n      const targetDate = new Date(goal.targetDate);\n      const daysRemaining = Math.ceil((targetDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n      const monthsRemaining = Math.max(1, daysRemaining / 30);\n      \n      const remainingAmount = targetAmount - currentAmount;\n      const requiredMonthlyContribution = remainingAmount / monthsRemaining;\n      \n      // Calculate if on track\n      const timeElapsed = now.getTime() - new Date(goal.createdAt || now).getTime();\n      const totalTime = targetDate.getTime() - new Date(goal.createdAt || now).getTime();\n      const expectedProgress = totalTime > 0 ? (timeElapsed / totalTime) * 100 : 0;\n      const isOnTrack = percentComplete >= expectedProgress * 0.9; // 90% of expected is \"on track\"\n\n      const milestone = getMilestoneLevel(percentComplete);\n      const celebration = milestone ? getCelebrationMessage(milestone, goal.title, percentComplete) : undefined;\n      const motivationalMessage = getMotivationalMessage(percentComplete, isOnTrack, daysRemaining);\n      const nextMilestone = getNextMilestone(percentComplete);\n\n      // Check for milestone events\n      const previousPercent = percentComplete - 5; // Assume 5% growth since last check\n\n      // Milestone reached\n      if (milestone && previousPercent < 25 && percentComplete >= 25) {\n        events.push({\n          type: 'milestone_reached',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `25% milestone reached. You've saved $${currentAmount.toLocaleString()} of $${targetAmount.toLocaleString()}`,\n          celebrationEmoji: ''\n        });\n      } else if (milestone && previousPercent < 50 && percentComplete >= 50) {\n        events.push({\n          type: 'milestone_reached',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `Halfway there. You've saved $${currentAmount.toLocaleString()} of $${targetAmount.toLocaleString()}`,\n          celebrationEmoji: ''\n        });\n      } else if (milestone && previousPercent < 75 && percentComplete >= 75) {\n        events.push({\n          type: 'milestone_reached',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `75% complete. Just $${remainingAmount.toLocaleString()} left.`,\n          celebrationEmoji: ''\n        });\n      } else if (milestone === 'complete' && previousPercent < 100) {\n        events.push({\n          type: 'goal_completed',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `GOAL ACHIEVED. \"${goal.title}\" complete. Celebrate this incredible achievement.`,\n          celebrationEmoji: ''\n        });\n        \n        // Mark goal as completed\n        await storage.updateFinancialGoal(goal.id, { status: 'completed' });\n      }\n\n      // Check if behind schedule\n      if (!isOnTrack && daysRemaining < 60 && percentComplete < 90) {\n        events.push({\n          type: 'goal_at_risk',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `\"${goal.title}\" is ${(100 - percentComplete).toFixed(1)}% short with ${daysRemaining} days left`,\n          celebrationEmoji: '',\n          actionRequired: `Increase monthly savings to $${requiredMonthlyContribution.toFixed(0)} to stay on track`\n        });\n      }\n\n      // Check if ahead of schedule\n      if (percentComplete > expectedProgress * 1.2 && percentComplete < 100) {\n        events.push({\n          type: 'ahead_of_schedule',\n          goalId: goal.id,\n          goalTitle: goal.title,\n          message: `You're ahead of schedule on \"${goal.title}\".`,\n          celebrationEmoji: '',\n          actionRequired: `You could reach this goal ${Math.floor((percentComplete - expectedProgress) / 10)} months early.`\n        });\n      }\n\n      progressList.push({\n        goalId: goal.id,\n        goalTitle: goal.title,\n        targetAmount,\n        currentAmount,\n        percentComplete,\n        milestone,\n        daysRemaining,\n        targetDate,\n        isOnTrack,\n        requiredMonthlyContribution,\n        celebration,\n        motivationalMessage,\n        nextMilestone\n      });\n    }\n\n    return { progress: progressList, events };\n  } catch (error) {\n    console.error('Error checking goal progress:', error);\n    throw error;\n  }\n}\n\nexport async function getGoalMilestones(\n  storage: IStorage,\n  goalId: string\n): Promise<{\n  goalTitle: string;\n  milestones: Array<{\n    level: string;\n    targetAmount: number;\n    reached: boolean;\n    dateReached?: Date;\n    percentComplete: number;\n  }>;\n}> {\n  try {\n    const goal = await storage.getFinancialGoal(goalId);\n    if (!goal) {\n      throw new Error('Goal not found');\n    }\n\n    const targetAmount = parseFloat(goal.targetAmount);\n    const currentAmount = parseFloat(goal.currentAmount || '0');\n    const percentComplete = (currentAmount / targetAmount) * 100;\n\n    const milestones = [\n      { level: '25% Milestone', targetAmount: targetAmount * 0.25, threshold: 25 },\n      { level: '50% Halfway Mark', targetAmount: targetAmount * 0.50, threshold: 50 },\n      { level: '75% Almost There', targetAmount: targetAmount * 0.75, threshold: 75 },\n      { level: '100% Goal Complete', targetAmount: targetAmount, threshold: 100 }\n    ].map(m => ({\n      level: m.level,\n      targetAmount: m.targetAmount,\n      reached: percentComplete >= m.threshold,\n      dateReached: percentComplete >= m.threshold ? new Date() : undefined,\n      percentComplete: Math.min(percentComplete, m.threshold)\n    }));\n\n    return {\n      goalTitle: goal.title,\n      milestones\n    };\n  } catch (error) {\n    console.error('Error getting goal milestones:', error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":9692,"size_tokens":null},"server/financialHealthService.ts":{"content":"import type { IStorage } from './storage';\n\nexport interface HealthScore {\n  overall: number; // 0-100\n  breakdown: {\n    savingsRate: { score: number; value: number; label: string; recommendation: string };\n    emergencyFund: { score: number; months: number; label: string; recommendation: string };\n    debtRatio: { score: number; ratio: number; label: string; recommendation: string };\n    netWorthGrowth: { score: number; growth: number; label: string; recommendation: string };\n    budgetAdherence: { score: number; adherence: number; label: string; recommendation: string };\n  };\n  grade: 'Excellent' | 'Good' | 'Fair' | 'Needs Improvement' | 'Critical';\n  summary: string;\n  topPriority: string;\n}\n\nfunction getScoreLabel(score: number): string {\n  if (score >= 90) return 'Excellent';\n  if (score >= 75) return 'Good';\n  if (score >= 60) return 'Fair';\n  if (score >= 40) return 'Needs Improvement';\n  return 'Critical';\n}\n\nfunction getGrade(overall: number): 'Excellent' | 'Good' | 'Fair' | 'Needs Improvement' | 'Critical' {\n  if (overall >= 90) return 'Excellent';\n  if (overall >= 75) return 'Good';\n  if (overall >= 60) return 'Fair';\n  if (overall >= 40) return 'Needs Improvement';\n  return 'Critical';\n}\n\nexport async function calculateFinancialHealth(\n  storage: IStorage,\n  userId: string\n): Promise<HealthScore> {\n  try {\n    const [stats, prefs, transactions, goals] = await Promise.all([\n      storage.getUserStats(userId),\n      storage.getUserPreferences(userId),\n      storage.getTransactionsByUserId(userId, 90), // Last 90 days\n      storage.getFinancialGoalsByUserId(userId)\n    ]);\n\n    const monthlyIncome = stats.monthlyIncome || \n      parseFloat(prefs?.monthlyIncomeEstimate?.toString() || '0');\n    \n    // Calculate actual monthly expenses from last 30 days\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const recentExpenses = transactions\n      .filter(t => t.type === 'expense' && t.date >= thirtyDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n    const monthlyExpenses = recentExpenses > 0 \n      ? recentExpenses \n      : parseFloat(prefs?.monthlyExpensesEstimate?.toString() || '0');\n\n    const totalSavings = stats.totalSavings || \n      parseFloat(prefs?.currentSavingsEstimate?.toString() || '0');\n\n    // 1. Savings Rate Score (30% weight)\n    const savingsRate = monthlyIncome > 0 \n      ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 \n      : 0;\n    \n    let savingsScore = 0;\n    let savingsLabel = '';\n    let savingsRec = '';\n    \n    if (savingsRate >= 20) {\n      savingsScore = 100;\n      savingsLabel = 'Excellent';\n      savingsRec = 'Outstanding! Maintain this rate for long-term wealth building.';\n    } else if (savingsRate >= 15) {\n      savingsScore = 85;\n      savingsLabel = 'Very Good';\n      savingsRec = 'Great job! Consider increasing to 20% to accelerate your goals.';\n    } else if (savingsRate >= 10) {\n      savingsScore = 70;\n      savingsLabel = 'Good';\n      savingsRec = 'Solid foundation. Try to reach 15% by cutting one major expense.';\n    } else if (savingsRate >= 5) {\n      savingsScore = 50;\n      savingsLabel = 'Fair';\n      savingsRec = `Critical: At ${savingsRate.toFixed(1)}%, you're saving $${Math.round(monthlyIncome * savingsRate / 100)}/month. Target: $${Math.round(monthlyIncome * 0.15)}/month (15%)`;\n    } else if (savingsRate > 0) {\n      savingsScore = 25;\n      savingsLabel = 'Low';\n      savingsRec = `Urgent: Only ${savingsRate.toFixed(1)}% savings rate. Review expenses immediately - start with $${Math.round(monthlyIncome * 0.05)}/month minimum.`;\n    } else {\n      savingsScore = 0;\n      savingsLabel = 'Critical';\n      savingsRec = 'CRITICAL: Expenses exceed income. Create emergency budget, cut discretionary spending by 30%.';\n    }\n\n    // 2. Emergency Fund Score (25% weight)\n    const emergencyFundMonths = monthlyExpenses > 0 ? totalSavings / monthlyExpenses : 0;\n    \n    let emergencyScore = 0;\n    let emergencyLabel = '';\n    let emergencyRec = '';\n    \n    if (emergencyFundMonths >= 6) {\n      emergencyScore = 100;\n      emergencyLabel = 'Excellent';\n      emergencyRec = 'Excellent! You have 6+ months of expenses saved. Focus on investing excess.';\n    } else if (emergencyFundMonths >= 3) {\n      emergencyScore = 75;\n      emergencyLabel = 'Good';\n      emergencyRec = `Good start at ${emergencyFundMonths.toFixed(1)} months. Target: ${(6 - emergencyFundMonths).toFixed(1)} more months ($${Math.round(monthlyExpenses * (6 - emergencyFundMonths)).toLocaleString()})`;\n    } else if (emergencyFundMonths >= 1) {\n      emergencyScore = 50;\n      emergencyLabel = 'Fair';\n      emergencyRec = `Only ${emergencyFundMonths.toFixed(1)} months saved. Save $${Math.round(monthlyExpenses * (3 - emergencyFundMonths)).toLocaleString()} more for 3-month minimum.`;\n    } else if (emergencyFundMonths > 0) {\n      emergencyScore = 25;\n      emergencyLabel = 'Low';\n      emergencyRec = `Urgent: Less than 1 month saved. Start emergency fund now - target $${Math.round(monthlyExpenses).toLocaleString()}/month for 3 months.`;\n    } else {\n      emergencyScore = 0;\n      emergencyLabel = 'Critical';\n      emergencyRec = `CRITICAL: No emergency fund. Start with $500-$1,000 immediately, then build to 3-6 months expenses ($${Math.round(monthlyExpenses * 3).toLocaleString()}-$${Math.round(monthlyExpenses * 6).toLocaleString()})`;\n    }\n\n    // 3. Debt Ratio Score (20% weight)\n    // Calculate debt payments from transaction history\n    const debtCategories = ['credit card', 'loan', 'debt', 'mortgage'];\n    const monthlyDebtPayments = transactions\n      .filter(t => \n        t.type === 'expense' && \n        t.date >= thirtyDaysAgo &&\n        debtCategories.some(cat => t.category.toLowerCase().includes(cat))\n      )\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const debtRatio = monthlyIncome > 0 ? (monthlyDebtPayments / monthlyIncome) * 100 : 0;\n    \n    let debtScore = 0;\n    let debtLabel = '';\n    let debtRec = '';\n    \n    if (debtRatio === 0) {\n      debtScore = 100;\n      debtLabel = 'Debt Free';\n      debtRec = 'Excellent! No debt payments detected. Maximize savings and investments.';\n    } else if (debtRatio <= 10) {\n      debtScore = 90;\n      debtLabel = 'Very Low';\n      debtRec = `Manageable at ${debtRatio.toFixed(1)}%. Consider accelerating payoff to save on interest.`;\n    } else if (debtRatio <= 20) {\n      debtScore = 75;\n      debtLabel = 'Moderate';\n      debtRec = `${debtRatio.toFixed(1)}% is acceptable. Use avalanche method to pay highest interest debt first.`;\n    } else if (debtRatio <= 36) {\n      debtScore = 50;\n      debtLabel = 'High';\n      debtRec = `Warning: ${debtRatio.toFixed(1)}% debt ratio. Aim for <20% - consider debt consolidation.`;\n    } else {\n      debtScore = 20;\n      debtLabel = 'Critical';\n      debtRec = `CRITICAL: ${debtRatio.toFixed(1)}% debt ratio exceeds safe limits (36%). Urgent: Stop new debt, pay minimums + extra to highest APR.`;\n    }\n\n    // 4. Net Worth Growth Score (15% weight)\n    // Compare current savings to 60 days ago\n    const sixtyDaysAgo = new Date(Date.now() - 60 * 24 * 60 * 60 * 1000);\n    const oldIncome = transactions\n      .filter(t => t.type === 'income' && t.date >= sixtyDaysAgo && t.date < thirtyDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n    const oldExpenses = transactions\n      .filter(t => t.type === 'expense' && t.date >= sixtyDaysAgo && t.date < thirtyDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const monthlyGrowth = (monthlyIncome - monthlyExpenses) - (oldIncome - oldExpenses);\n    const growthPercentage = oldIncome > 0 ? (monthlyGrowth / oldIncome) * 100 : 0;\n\n    let growthScore = 0;\n    let growthLabel = '';\n    let growthRec = '';\n\n    if (growthPercentage >= 5) {\n      growthScore = 100;\n      growthLabel = 'Excellent Growth';\n      growthRec = `Amazing! ${growthPercentage.toFixed(1)}% month-over-month growth. Keep this momentum!`;\n    } else if (growthPercentage >= 2) {\n      growthScore = 80;\n      growthLabel = 'Good Growth';\n      growthRec = `Solid ${growthPercentage.toFixed(1)}% growth. Compounding at this rate = strong future wealth.`;\n    } else if (growthPercentage > 0) {\n      growthScore = 60;\n      growthLabel = 'Positive Growth';\n      growthRec = `${growthPercentage.toFixed(1)}% growth is positive. Try to increase savings rate for faster progress.`;\n    } else if (growthPercentage >= -2) {\n      growthScore = 40;\n      growthLabel = 'Stagnant';\n      growthRec = 'Net worth flat. Identify one area to cut expenses or boost income this month.';\n    } else {\n      growthScore = 20;\n      growthLabel = 'Declining';\n      growthRec = `Warning: ${Math.abs(growthPercentage).toFixed(1)}% decline. Emergency action needed - review major expenses now.`;\n    }\n\n    // 5. Budget Adherence Score (10% weight)\n    const budgetEstimate = parseFloat(prefs?.monthlyExpensesEstimate?.toString() || '0');\n    const budgetAdherence = budgetEstimate > 0 \n      ? Math.max(0, 100 - Math.abs((monthlyExpenses - budgetEstimate) / budgetEstimate * 100))\n      : (monthlyExpenses > 0 ? 50 : 100);\n\n    let budgetScore = budgetAdherence;\n    let budgetLabel = '';\n    let budgetRec = '';\n\n    if (budgetAdherence >= 95) {\n      budgetLabel = 'Excellent';\n      budgetRec = 'Perfect budget control! You are within 5% of planned spending.';\n    } else if (budgetAdherence >= 85) {\n      budgetLabel = 'Good';\n      budgetRec = 'Good budget adherence. Minor adjustments can get you to perfect control.';\n    } else if (budgetAdherence >= 70) {\n      budgetLabel = 'Fair';\n      budgetRec = `${(100 - budgetAdherence).toFixed(0)}% over/under budget. Track daily expenses to improve accuracy.`;\n    } else {\n      budgetLabel = 'Poor';\n      budgetRec = `Significant budget variance. Use 50/30/20 rule: 50% needs, 30% wants, 20% savings.`;\n    }\n\n    // Calculate overall score with weighted average\n    const overall = Math.round(\n      (savingsScore * 0.30) +\n      (emergencyScore * 0.25) +\n      (debtScore * 0.20) +\n      (growthScore * 0.15) +\n      (budgetScore * 0.10)\n    );\n\n    const grade = getGrade(overall);\n\n    // Determine top priority (lowest score)\n    const scores = [\n      { name: 'savings rate', score: savingsScore, rec: savingsRec },\n      { name: 'emergency fund', score: emergencyScore, rec: emergencyRec },\n      { name: 'debt management', score: debtScore, rec: debtRec },\n      { name: 'net worth growth', score: growthScore, rec: growthRec },\n      { name: 'budget adherence', score: budgetScore, rec: budgetRec }\n    ];\n\n    const topPriority = scores.reduce((min, curr) => \n      curr.score < min.score ? curr : min\n    );\n\n    // Generate summary\n    let summary = '';\n    if (overall >= 90) {\n      summary = `Outstanding financial health! You're in the top 10% of savers. Your ${savingsRate.toFixed(0)}% savings rate and ${emergencyFundMonths.toFixed(1)}-month emergency fund demonstrate excellent discipline.`;\n    } else if (overall >= 75) {\n      summary = `Solid financial foundation. You're on the right track with good habits. Focus on your ${topPriority.name} to reach excellent status.`;\n    } else if (overall >= 60) {\n      summary = `Fair financial health with room for improvement. Your ${topPriority.name} needs immediate attention to prevent future issues.`;\n    } else if (overall >= 40) {\n      summary = `Financial health needs significant improvement. Critical focus area: ${topPriority.name}. Small changes today prevent major problems tomorrow.`;\n    } else {\n      summary = `CRITICAL: Financial health requires urgent action. Start with ${topPriority.name} immediately. Consider speaking with a financial advisor.`;\n    }\n\n    return {\n      overall,\n      breakdown: {\n        savingsRate: { score: savingsScore, value: savingsRate, label: savingsLabel, recommendation: savingsRec },\n        emergencyFund: { score: emergencyScore, months: emergencyFundMonths, label: emergencyLabel, recommendation: emergencyRec },\n        debtRatio: { score: debtScore, ratio: debtRatio, label: debtLabel, recommendation: debtRec },\n        netWorthGrowth: { score: growthScore, growth: growthPercentage, label: growthLabel, recommendation: growthRec },\n        budgetAdherence: { score: budgetScore, adherence: budgetAdherence, label: budgetLabel, recommendation: budgetRec }\n      },\n      grade,\n      summary,\n      topPriority: topPriority.rec\n    };\n\n  } catch (error) {\n    console.error('Error calculating financial health:', error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":12587,"size_tokens":null},"server/taxService.ts":{"content":"// Tax Service - Country-specific tax bracket calculations\n// Provides accurate net income calculations based on location and income level\n\nexport interface TaxBracket {\n  min: number;\n  max: number | null; // null means infinity\n  rate: number; // percentage\n}\n\nexport interface CountryTaxInfo {\n  countryCode: string;\n  countryName: string;\n  currency: string;\n  brackets: TaxBracket[];\n  standardDeduction?: number;\n  socialSecurityRate?: number; // additional payroll tax\n  medicareRate?: number; // additional healthcare tax\n}\n\n// Comprehensive tax data for multiple countries (2024-2025 rates)\nconst TAX_DATA: Record<string, CountryTaxInfo> = {\n  'US': {\n    countryCode: 'US',\n    countryName: 'United States',\n    currency: 'USD',\n    standardDeduction: 14600, // 2024 standard deduction for single filers\n    socialSecurityRate: 6.2,\n    medicareRate: 1.45,\n    brackets: [\n      { min: 0, max: 11600, rate: 10 },\n      { min: 11600, max: 47150, rate: 12 },\n      { min: 47150, max: 100525, rate: 22 },\n      { min: 100525, max: 191950, rate: 24 },\n      { min: 191950, max: 243725, rate: 32 },\n      { min: 243725, max: 609350, rate: 35 },\n      { min: 609350, max: null, rate: 37 }\n    ]\n  },\n  'GB': {\n    countryCode: 'GB',\n    countryName: 'United Kingdom',\n    currency: 'GBP',\n    standardDeduction: 12570, // Personal allowance\n    socialSecurityRate: 12, // National Insurance\n    brackets: [\n      { min: 0, max: 12570, rate: 0 },\n      { min: 12570, max: 50270, rate: 20 },\n      { min: 50270, max: 125140, rate: 40 },\n      { min: 125140, max: null, rate: 45 }\n    ]\n  },\n  'CA': {\n    countryCode: 'CA',\n    countryName: 'Canada',\n    currency: 'CAD',\n    standardDeduction: 15000,\n    socialSecurityRate: 5.95, // CPP\n    medicareRate: 0, // Healthcare covered by taxes\n    brackets: [\n      { min: 0, max: 53359, rate: 15 },\n      { min: 53359, max: 106717, rate: 20.5 },\n      { min: 106717, max: 165430, rate: 26 },\n      { min: 165430, max: 235675, rate: 29 },\n      { min: 235675, max: null, rate: 33 }\n    ]\n  },\n  'AU': {\n    countryCode: 'AU',\n    countryName: 'Australia',\n    currency: 'AUD',\n    standardDeduction: 18200, // Tax-free threshold\n    medicareRate: 2, // Medicare levy\n    brackets: [\n      { min: 0, max: 18200, rate: 0 },\n      { min: 18200, max: 45000, rate: 19 },\n      { min: 45000, max: 120000, rate: 32.5 },\n      { min: 120000, max: 180000, rate: 37 },\n      { min: 180000, max: null, rate: 45 }\n    ]\n  },\n  'DE': {\n    countryCode: 'DE',\n    countryName: 'Germany',\n    currency: 'EUR',\n    standardDeduction: 10908, // Basic allowance (Grundfreibetrag)\n    socialSecurityRate: 18.6, // Social security + unemployment insurance\n    medicareRate: 7.3, // Health insurance\n    brackets: [\n      { min: 0, max: 10908, rate: 0 },\n      { min: 10908, max: 62810, rate: 14 }, // Progressive from 14% to 24%\n      { min: 62810, max: 277826, rate: 42 },\n      { min: 277826, max: null, rate: 45 }\n    ]\n  },\n  'FR': {\n    countryCode: 'FR',\n    countryName: 'France',\n    currency: 'EUR',\n    standardDeduction: 10777, // Minimum tax-free allowance\n    socialSecurityRate: 15, // Social contributions\n    brackets: [\n      { min: 0, max: 10777, rate: 0 },\n      { min: 10777, max: 27478, rate: 11 },\n      { min: 27478, max: 78570, rate: 30 },\n      { min: 78570, max: 168994, rate: 41 },\n      { min: 168994, max: null, rate: 45 }\n    ]\n  },\n  'IN': {\n    countryCode: 'IN',\n    countryName: 'India',\n    currency: 'INR',\n    standardDeduction: 50000, // Standard deduction\n    brackets: [\n      { min: 0, max: 300000, rate: 0 },\n      { min: 300000, max: 600000, rate: 5 },\n      { min: 600000, max: 900000, rate: 10 },\n      { min: 900000, max: 1200000, rate: 15 },\n      { min: 1200000, max: 1500000, rate: 20 },\n      { min: 1500000, max: null, rate: 30 }\n    ]\n  },\n  'BR': {\n    countryCode: 'BR',\n    countryName: 'Brazil',\n    currency: 'BRL',\n    standardDeduction: 24511, // Basic deduction\n    socialSecurityRate: 11, // INSS\n    brackets: [\n      { min: 0, max: 24511, rate: 0 },\n      { min: 24511, max: 33919, rate: 7.5 },\n      { min: 33919, max: 45012, rate: 15 },\n      { min: 45012, max: 55976, rate: 22.5 },\n      { min: 55976, max: null, rate: 27.5 }\n    ]\n  },\n  'SG': {\n    countryCode: 'SG',\n    countryName: 'Singapore',\n    currency: 'SGD',\n    standardDeduction: 20000, // Personal relief\n    brackets: [\n      { min: 0, max: 20000, rate: 0 },\n      { min: 20000, max: 30000, rate: 2 },\n      { min: 30000, max: 40000, rate: 3.5 },\n      { min: 40000, max: 80000, rate: 7 },\n      { min: 80000, max: 120000, rate: 11.5 },\n      { min: 120000, max: 160000, rate: 15 },\n      { min: 160000, max: 200000, rate: 18 },\n      { min: 200000, max: 240000, rate: 19 },\n      { min: 240000, max: 280000, rate: 19.5 },\n      { min: 280000, max: 320000, rate: 20 },\n      { min: 320000, max: null, rate: 22 }\n    ]\n  },\n  'AE': {\n    countryCode: 'AE',\n    countryName: 'United Arab Emirates',\n    currency: 'AED',\n    brackets: [\n      { min: 0, max: null, rate: 0 } // No personal income tax\n    ]\n  }\n};\n\nexport interface TaxCalculationResult {\n  grossIncome: number;\n  federalTax: number;\n  socialSecurityTax: number;\n  medicareTax: number;\n  totalTax: number;\n  netIncome: number;\n  effectiveTaxRate: number; // percentage\n  marginalTaxRate: number; // percentage\n  taxableIncome: number;\n  countryInfo: CountryTaxInfo;\n}\n\nclass TaxService {\n  /**\n   * Calculate taxes for annual income\n   */\n  calculateAnnualTax(annualIncome: number, countryCode: string = 'US'): TaxCalculationResult {\n    const taxInfo = TAX_DATA[countryCode] || TAX_DATA['US'];\n    \n    // Calculate taxable income after standard deduction\n    const taxableIncome = Math.max(0, annualIncome - (taxInfo.standardDeduction || 0));\n    \n    // Calculate federal/income tax using progressive brackets\n    let federalTax = 0;\n    let marginalRate = 0;\n    \n    for (const bracket of taxInfo.brackets) {\n      if (taxableIncome > bracket.min) {\n        const taxableInBracket = bracket.max \n          ? Math.min(taxableIncome - bracket.min, bracket.max - bracket.min)\n          : taxableIncome - bracket.min;\n        \n        federalTax += (taxableInBracket * bracket.rate) / 100;\n        marginalRate = bracket.rate; // Update to highest bracket reached\n      }\n    }\n    \n    // Calculate payroll taxes (on gross income, not taxable)\n    const socialSecurityTax = taxInfo.socialSecurityRate \n      ? (annualIncome * taxInfo.socialSecurityRate) / 100 \n      : 0;\n    \n    const medicareTax = taxInfo.medicareRate \n      ? (annualIncome * taxInfo.medicareRate) / 100 \n      : 0;\n    \n    const totalTax = federalTax + socialSecurityTax + medicareTax;\n    const netIncome = annualIncome - totalTax;\n    const effectiveTaxRate = annualIncome > 0 ? (totalTax / annualIncome) * 100 : 0;\n    \n    return {\n      grossIncome: annualIncome,\n      federalTax: Math.round(federalTax * 100) / 100,\n      socialSecurityTax: Math.round(socialSecurityTax * 100) / 100,\n      medicareTax: Math.round(medicareTax * 100) / 100,\n      totalTax: Math.round(totalTax * 100) / 100,\n      netIncome: Math.round(netIncome * 100) / 100,\n      effectiveTaxRate: Math.round(effectiveTaxRate * 10) / 10,\n      marginalTaxRate: marginalRate,\n      taxableIncome: Math.round(taxableIncome * 100) / 100,\n      countryInfo: taxInfo\n    };\n  }\n  \n  /**\n   * Calculate taxes for monthly income\n   */\n  calculateMonthlyTax(monthlyIncome: number, countryCode: string = 'US'): TaxCalculationResult {\n    const annualIncome = monthlyIncome * 12;\n    const result = this.calculateAnnualTax(annualIncome, countryCode);\n    \n    // Convert to monthly values\n    return {\n      ...result,\n      grossIncome: monthlyIncome,\n      federalTax: Math.round((result.federalTax / 12) * 100) / 100,\n      socialSecurityTax: Math.round((result.socialSecurityTax / 12) * 100) / 100,\n      medicareTax: Math.round((result.medicareTax / 12) * 100) / 100,\n      totalTax: Math.round((result.totalTax / 12) * 100) / 100,\n      netIncome: Math.round((result.netIncome / 12) * 100) / 100\n    };\n  }\n  \n  /**\n   * Get tax info for AI context\n   */\n  getTaxContextForAI(monthlyIncome: number, countryCode: string = 'US'): string {\n    if (monthlyIncome === 0) {\n      return ''; // Skip tax info if no income data\n    }\n    \n    const result = this.calculateMonthlyTax(monthlyIncome, countryCode);\n    \n    return `\nTAX CALCULATION (${result.countryInfo.countryName}):\n• Gross Monthly Income: ${result.countryInfo.currency} ${result.grossIncome.toLocaleString()}\n• Annual Income: ${result.countryInfo.currency} ${(result.grossIncome * 12).toLocaleString()}\n• Federal/Income Tax: ${result.countryInfo.currency} ${result.federalTax.toLocaleString()}/month (${result.countryInfo.currency} ${(result.federalTax * 12).toLocaleString()}/year)\n${result.socialSecurityTax > 0 ? `• Social Security: ${result.countryInfo.currency} ${result.socialSecurityTax.toLocaleString()}/month` : ''}\n${result.medicareTax > 0 ? `• Medicare/Healthcare: ${result.countryInfo.currency} ${result.medicareTax.toLocaleString()}/month` : ''}\n• Total Monthly Tax: ${result.countryInfo.currency} ${result.totalTax.toLocaleString()} \n• Net Monthly Income: ${result.countryInfo.currency} ${result.netIncome.toLocaleString()} (take-home pay)\n• Effective Tax Rate: ${result.effectiveTaxRate}% | Marginal Rate: ${result.marginalTaxRate}%\n• Tax Bracket: ${result.marginalTaxRate}% (highest bracket reached)\n\nIMPORTANT: When giving financial advice, use NET income (${result.countryInfo.currency} ${result.netIncome.toLocaleString()}/month), not gross. This is the actual take-home pay after all taxes.`;\n  }\n  \n  /**\n   * Get supported countries\n   */\n  getSupportedCountries(): CountryTaxInfo[] {\n    return Object.values(TAX_DATA);\n  }\n  \n  /**\n   * Check if country is supported\n   */\n  isCountrySupported(countryCode: string): boolean {\n    return countryCode in TAX_DATA;\n  }\n}\n\nexport const taxService = new TaxService();\n","path":null,"size_bytes":9984,"size_tokens":null},"client/src/pages/checkout.tsx":{"content":"import { useEffect, useState } from 'react';\nimport { useStripe, useElements, PaymentElement, Elements } from '@stripe/react-stripe-js';\nimport { loadStripe } from '@stripe/stripe-js';\nimport { useQuery } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Loader2, CreditCard, ArrowLeft, Shield, CheckCircle2 } from 'lucide-react';\nimport { useLocation, useRoute } from 'wouter';\nimport { Skeleton } from '@/components/ui/skeleton';\n\n// Load Stripe outside component to avoid recreating on every render\nif (!import.meta.env.VITE_STRIPE_PUBLIC_KEY) {\n console.error('Missing required Stripe key: VITE_STRIPE_PUBLIC_KEY');\n}\nconst stripePromise = import.meta.env.VITE_STRIPE_PUBLIC_KEY \n ? loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY)\n : null;\n\ninterface SubscriptionPlan {\n id: string;\n name: string;\n displayName: string;\n description: string;\n priceUsd: string;\n priceThb: string;\n aiChatLimit: number;\n billingInterval: string;\n}\n\nfunction CheckoutForm({ planId }: { planId: string }) {\n const stripe = useStripe();\n const elements = useElements();\n const { toast } = useToast();\n const [, setLocation] = useLocation();\n const [isProcessing, setIsProcessing] = useState(false);\n\n const handleSubmit = async (e: React.FormEvent) => {\n e.preventDefault();\n\n if (!stripe || !elements) {\n return;\n }\n\n setIsProcessing(true);\n\n try {\n const { error } = await stripe.confirmPayment({\n elements,\n confirmParams: {\n return_url: `${window.location.origin}/subscription?payment=success`,\n },\n });\n\n if (error) {\n toast({\n title:\"Payment Failed\",\n description: error.message,\n variant:\"destructive\",\n });\n }\n } catch (err: any) {\n toast({\n title:\"Payment Error\",\n description: err.message ||\"An unexpected error occurred\",\n variant:\"destructive\",\n });\n } finally {\n setIsProcessing(false);\n }\n };\n\n return (\n <form onSubmit={handleSubmit} className=\"space-y-6\">\n <PaymentElement />\n \n <div className=\"flex gap-3\">\n <Button\n type=\"button\"\n variant=\"outline\"\n onClick={() => setLocation('/subscription')}\n className=\"flex-1\"\n data-testid=\"button-back\"\n >\n <ArrowLeft className=\"w-4 h-4 mr-2\" />\n Back\n </Button>\n <Button\n type=\"submit\"\n disabled={!stripe || isProcessing}\n className=\"flex-1 bg-white dark:bg-gray-900\"\n data-testid=\"button-submit-payment\"\n >\n {isProcessing ? (\n <>\n <Loader2 className=\"w-4 h-4 mr-2\" />\n Processing...\n </>\n ) : (\n <>\n <CreditCard className=\"w-4 h-4 mr-2\" />\n Subscribe Now\n </>\n )}\n </Button>\n </div>\n\n <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n <Shield className=\"w-4 h-4\" />\n <span>Secured by Stripe • Cancel anytime</span>\n </div>\n </form>\n );\n}\n\nexport default function CheckoutPage() {\n const [, params] = useRoute('/checkout/:planId');\n const planId = params?.planId;\n const [, setLocation] = useLocation();\n const [clientSecret, setClientSecret] = useState<string>('');\n const { toast } = useToast();\n\n const { data: plans, isLoading: planLoading } = useQuery<SubscriptionPlan[]>({\n queryKey: ['/api/subscription/plans'],\n enabled: !!planId,\n });\n\n const plan = plans?.find(p => p.id === planId);\n\n useEffect(() => {\n if (!planId) {\n toast({\n title:\"Invalid Plan\",\n description:\"No plan selected. Redirecting to subscription page.\",\n variant:\"destructive\",\n });\n setLocation('/subscription');\n return;\n }\n\n // Create subscription session\n const createSubscription = async () => {\n try {\n // Use environment variable for Stripe Price ID or construct it from plan name\n const stripePriceId = import.meta.env[`VITE_STRIPE_PRICE_${plan?.name?.toUpperCase()}`] || \n `price_${plan?.name?.toLowerCase()}`;\n \n const response = await apiRequest('POST', '/api/subscription/create-subscription', {\n planId,\n priceId: stripePriceId,\n });\n\n if (response.ok) {\n const data = await response.json();\n setClientSecret(data.clientSecret);\n } else {\n const error = await response.json();\n toast({\n title:\"Setup Failed\",\n description: error.message ||\"Failed to setup payment\",\n variant:\"destructive\",\n });\n setLocation('/subscription');\n }\n } catch (error: any) {\n toast({\n title:\"Error\",\n description: error.message ||\"An error occurred\",\n variant:\"destructive\",\n });\n setLocation('/subscription');\n }\n };\n\n if (plan) {\n createSubscription();\n }\n }, [planId, plan]);\n\n if (!stripePromise) {\n return (\n <div className=\"min-h-screen flex items-center justify-center bg-orange-50 dark:bg-orange-900/20\">\n <Card className=\"max-w-md\">\n <CardHeader>\n <CardTitle className=\"text-red-600\">Payment Unavailable</CardTitle>\n <CardDescription>\n Stripe is not configured. Please contact support.\n </CardDescription>\n </CardHeader>\n </Card>\n </div>\n );\n }\n\n if (planLoading || !plan) {\n return (\n <div className=\"min-h-screen flex items-center justify-center bg-orange-50 dark:bg-orange-900/20\">\n <Card className=\"w-full max-w-2xl\">\n <CardHeader>\n <Skeleton className=\"h-8 w-48\" />\n <Skeleton className=\"h-4 w-full\" />\n </CardHeader>\n <CardContent className=\"space-y-4\">\n <Skeleton className=\"h-40 w-full\" />\n <Skeleton className=\"h-12 w-full\" />\n </CardContent>\n </Card>\n </div>\n );\n }\n\n if (!clientSecret) {\n return (\n <div className=\"min-h-screen flex items-center justify-center bg-orange-50 dark:bg-orange-900/20\">\n <Card className=\"w-full max-w-2xl\">\n <CardHeader>\n <CardTitle className=\"flex items-center gap-2\">\n <Loader2 className=\"w-5 h-5\" />\n Setting up your subscription...\n </CardTitle>\n </CardHeader>\n </Card>\n </div>\n );\n }\n\n return (\n <div className=\"min-h-screen bg-orange-50 dark:bg-orange-900/20 py-12 px-4\">\n <div className=\"container max-w-2xl mx-auto space-y-6\">\n {/* Plan Summary */}\n <Card className=\"border-0 shadow-2xl\">\n <CardHeader>\n <CardTitle className=\"text-2xl flex items-center gap-2\">\n <CheckCircle2 className=\"w-6 h-6 text-green-500\" />\n Subscribe to {plan.displayName}\n </CardTitle>\n <CardDescription>{plan.description}</CardDescription>\n </CardHeader>\n <CardContent>\n <div className=\"flex items-baseline justify-between mb-6 p-6 bg-white dark:bg-gray-900 rounded-xl\">\n <div>\n <div className=\"text-sm text-muted-foreground mb-1\">Monthly Subscription</div>\n <div className=\"text-4xl font-bold text-foreground\">\n ${parseFloat(plan.priceUsd).toFixed(2)}\n </div>\n </div>\n <div className=\"text-right\">\n <div className=\"text-sm text-muted-foreground mb-1\">AI Chats Included</div>\n <div className=\"text-3xl font-bold text-primary\">\n {plan.aiChatLimit}\n </div>\n </div>\n </div>\n\n <div className=\"space-y-2 text-sm\">\n <div className=\"flex items-center gap-2\">\n <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n <span>Cancel anytime, no commitments</span>\n </div>\n <div className=\"flex items-center gap-2\">\n <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n <span>Instant activation after payment</span>\n </div>\n <div className=\"flex items-center gap-2\">\n <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n <span>Secure payment processing by Stripe</span>\n </div>\n </div>\n </CardContent>\n </Card>\n\n {/* Payment Form */}\n <Card className=\"border-0 shadow-2xl\">\n <CardHeader>\n <CardTitle className=\"flex items-center gap-2\">\n <CreditCard className=\"w-5 h-5\" />\n Payment Details\n </CardTitle>\n <CardDescription>\n Enter your payment information to complete subscription\n </CardDescription>\n </CardHeader>\n <CardContent>\n <Elements \n stripe={stripePromise} \n options={{ \n clientSecret,\n appearance: {\n theme: 'stripe',\n variables: {\n colorPrimary: '#f97316',\n },\n },\n }}\n >\n <CheckoutForm planId={planId!} />\n </Elements>\n </CardContent>\n </Card>\n </div>\n </div>\n );\n}\n","path":null,"size_bytes":7676,"size_tokens":null},"client/src/components/mobile-header.tsx":{"content":"import { Menu, User, LogOut, Loader2 } from\"lucide-react\";\nimport logoUrl from\"@assets/5-removebg-preview_1761578659737.png\";\nimport { cn } from\"@/lib/utils\";\nimport { useAuth } from\"@/hooks/useAuth\";\nimport { SidebarTrigger } from\"@/components/ui/sidebar\";\nimport {\n DropdownMenu,\n DropdownMenuContent,\n DropdownMenuItem,\n DropdownMenuLabel,\n DropdownMenuSeparator,\n DropdownMenuTrigger,\n} from\"@/components/ui/dropdown-menu\";\nimport { Avatar, AvatarFallback } from\"@/components/ui/avatar\";\nimport { Button } from\"@/components/ui/button\";\nimport { Link, useLocation } from\"wouter\";\nimport { useTranslation } from\"react-i18next\";\nimport { useMutation } from\"@tanstack/react-query\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { useState } from\"react\";\n\nexport default function MobileHeader() {\n const { user } = useAuth();\n const { t } = useTranslation();\n const [, setLocation] = useLocation();\n const { toast } = useToast();\n const [isMenuOpen, setIsMenuOpen] = useState(false);\n\n const logoutMutation = useMutation({\n  mutationFn: async () => {\n   return await apiRequest('POST', '/api/auth/logout', {});\n  },\n  onSuccess: () => {\n   // Invalidate auth queries\n   queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n   queryClient.invalidateQueries({ queryKey: ['/api/auth/status'] });\n   queryClient.clear(); // Clear all cached data on logout\n   \n   // Show success toast\n   toast({\n    title:\"Signed out securely\",\n    description:\"You have been logged out successfully\",\n   });\n   \n   // Redirect to login page\n   setTimeout(() => {\n    setLocation('/login');\n   }, 100);\n  },\n  onError: (error: any) => {\n   toast({\n    title:\"Logout failed\",\n    description: error.message ||\"Please try again\",\n    variant:\"destructive\",\n   });\n  },\n });\n\n const handleLogout = () => {\n  setIsMenuOpen(false); // Close menu immediately\n  logoutMutation.mutate();\n };\n\n const getUserInitials = () => {\n  if (!user) return\"U\";\n  const firstInitial = user.firstName?.[0] ||\"\";\n  const lastInitial = user.lastName?.[0] ||\"\";\n  return (firstInitial + lastInitial).toUpperCase() ||\"U\";\n };\n\n return (\n  <header\n   className={cn(\n   \"md:hidden\", // Only show on mobile\n   \"sticky top-0 z-50\",\n   \"bg-background/80 backdrop-blur-lg\",\n   \"border-b border-border/40\",\n   \"shadow-sm\"\n   )}\n   data-testid=\"mobile-header\"\n  >\n   <div className=\"flex items-center justify-between px-3 h-16\">\n    {/* Left: Hamburger Menu */}\n    <SidebarTrigger\n     className=\"h-11 w-11 min-h-[44px] min-w-[44px]\"\n     data-testid=\"button-mobile-menu\"\n    />\n\n    {/* Center: Logo */}\n    <Link href=\"/\">\n     <div className=\"flex items-center gap-2 cursor-pointer\" data-testid=\"link-logo\">\n      <img \n       src={logoUrl} \n       alt=\"Twealth Logo\" \n       className=\"w-8 h-8\"\n      />\n      <span className=\"font-bold text-lg text-foreground\">Twealth</span>\n     </div>\n    </Link>\n\n    {/* Right: User Avatar Menu */}\n    <DropdownMenu open={isMenuOpen} onOpenChange={setIsMenuOpen}>\n     <DropdownMenuTrigger asChild>\n      <Button\n       variant=\"ghost\"\n       className=\"h-11 w-11 min-h-[44px] min-w-[44px] rounded-full p-0\"\n       data-testid=\"button-user-menu\"\n      >\n       <Avatar className=\"h-9 w-9\">\n        <AvatarFallback className=\"bg-primary text-primary-foreground font-semibold\">\n         {getUserInitials()}\n        </AvatarFallback>\n       </Avatar>\n      </Button>\n     </DropdownMenuTrigger>\n     <DropdownMenuContent align=\"end\" className=\"w-56\">\n      <DropdownMenuLabel>\n       <div className=\"flex flex-col space-y-1\">\n        <p className=\"text-sm font-medium leading-none\" data-testid=\"text-user-name\">\n         {user ? `${user.firstName} ${user.lastName}` : 'Loading...'}\n        </p>\n        <p className=\"text-xs leading-none text-muted-foreground\" data-testid=\"text-user-email\">\n         {user?.email || 'Loading...'}\n        </p>\n       </div>\n      </DropdownMenuLabel>\n      <DropdownMenuSeparator />\n      <DropdownMenuItem asChild>\n       <Link href=\"/settings\">\n        <span className=\"cursor-pointer w-full\" data-testid=\"link-settings\">\n         {t('navigation.settings')}\n        </span>\n       </Link>\n      </DropdownMenuItem>\n      <DropdownMenuItem asChild>\n       <Link href=\"/subscription\">\n        <span className=\"cursor-pointer w-full\" data-testid=\"link-subscription\">\n         {t('navigation.premium')}\n        </span>\n       </Link>\n      </DropdownMenuItem>\n      <DropdownMenuSeparator />\n      <DropdownMenuItem\n       onClick={handleLogout}\n       disabled={logoutMutation.isPending}\n       className=\"cursor-pointer text-destructive focus:text-destructive\"\n       data-testid=\"button-logout\"\n      >\n       <div className=\"flex items-center gap-2 w-full\">\n        {logoutMutation.isPending ? (\n         <Loader2 className=\"h-4 w-4\" />\n        ) : (\n         <LogOut className=\"h-4 w-4\" />\n        )}\n        <span>\n         {logoutMutation.isPending ?\"Signing out...\" :\"Sign out\"}\n        </span>\n       </div>\n      </DropdownMenuItem>\n     </DropdownMenuContent>\n    </DropdownMenu>\n   </div>\n  </header>\n );\n}\n","path":null,"size_bytes":5117,"size_tokens":null},"server/services/systemPromptCache.ts":{"content":"// System Prompt Cache Service\n// Caches the expensive buildSystemPrompt() result to avoid redundant API calls\n\ninterface CacheKey {\n  userId: string;\n  monthlyIncome: number;\n  monthlyExpenses: number;\n  totalSavings: number;\n  activeGoals: number;\n  language: string;\n  cryptoEnabled: boolean;\n  experienceLevel: string;\n}\n\nclass SystemPromptCacheService {\n  private cache: Map<string, { prompt: string; timestamp: number; contextHash: string }> = new Map();\n  private readonly CACHE_DURATION = 60 * 60 * 1000; // 1 hour - market data changes, but not frequently enough to warrant per-message fetches\n  \n  /**\n   * Generate a stable cache key from user context\n   */\n  private generateCacheKey(context: CacheKey): string {\n    // Round financial values to ranges to increase cache hits\n    const incomeRange = this.getIncomeRange(context.monthlyIncome);\n    const expensesRange = this.getExpensesRange(context.monthlyExpenses);\n    const savingsRange = this.getSavingsRange(context.totalSavings);\n    \n    return `${context.userId}:${incomeRange}:${expensesRange}:${savingsRange}:${context.activeGoals}:${context.language}:${context.cryptoEnabled}:${context.experienceLevel}`;\n  }\n  \n  private getIncomeRange(income: number): string {\n    if (income === 0) return 'zero';\n    if (income < 30000) return 'low';\n    if (income < 80000) return 'medium';\n    if (income < 150000) return 'high';\n    return 'very-high';\n  }\n  \n  private getExpensesRange(expenses: number): string {\n    if (expenses === 0) return 'zero';\n    if (expenses < 20000) return 'low';\n    if (expenses < 60000) return 'medium';\n    if (expenses < 120000) return 'high';\n    return 'very-high';\n  }\n  \n  private getSavingsRange(savings: number): string {\n    if (savings === 0) return 'zero';\n    if (savings < 5000) return 'low';\n    if (savings < 50000) return 'medium';\n    if (savings < 250000) return 'high';\n    return 'very-high';\n  }\n  \n  /**\n   * Get cached system prompt if available and not expired\n   */\n  get(context: CacheKey): string | null {\n    const key = this.generateCacheKey(context);\n    const cached = this.cache.get(key);\n    \n    if (!cached) {\n      return null;\n    }\n    \n    // Check if expired\n    if (Date.now() - cached.timestamp > this.CACHE_DURATION) {\n      this.cache.delete(key);\n      return null;\n    }\n    \n    return cached.prompt;\n  }\n  \n  /**\n   * Store system prompt in cache\n   */\n  set(context: CacheKey, prompt: string): void {\n    const key = this.generateCacheKey(context);\n    \n    // Cleanup old entries if cache is getting large (keep last 100 users)\n    if (this.cache.size >= 100) {\n      const oldestKey = this.cache.keys().next().value;\n      if (oldestKey) this.cache.delete(oldestKey);\n    }\n    \n    this.cache.set(key, {\n      prompt,\n      timestamp: Date.now(),\n      contextHash: key\n    });\n  }\n  \n  /**\n   * Clear cache for a specific user (when their data changes significantly)\n   */\n  clearUser(userId: string): void {\n    const keysToDelete: string[] = [];\n    this.cache.forEach((_, key) => {\n      if (key.startsWith(`${userId}:`)) {\n        keysToDelete.push(key);\n      }\n    });\n    keysToDelete.forEach(key => this.cache.delete(key));\n  }\n  \n  /**\n   * Get cache statistics\n   */\n  getStats(): { size: number; oldestEntry: number | null } {\n    let oldestTimestamp: number | null = null;\n    \n    this.cache.forEach((value) => {\n      if (!oldestTimestamp || value.timestamp < oldestTimestamp) {\n        oldestTimestamp = value.timestamp;\n      }\n    });\n    \n    return {\n      size: this.cache.size,\n      oldestEntry: oldestTimestamp ? Date.now() - oldestTimestamp : null\n    };\n  }\n}\n\nexport const systemPromptCache = new SystemPromptCacheService();\n","path":null,"size_bytes":3701,"size_tokens":null},"server/demo-data/index.ts":{"content":"/**\n * Demo Data Service\n * Provides realistic sample data for new users to explore the app\n */\n\nimport { addMonths, subDays, subMonths } from 'date-fns';\n\nexport interface DemoTransaction {\n  id: string;\n  amount: string;\n  type: 'income' | 'expense' | 'transfer';\n  category: string;\n  description: string;\n  date: Date;\n}\n\nexport interface DemoGoal {\n  id: string;\n  title: string;\n  description: string;\n  targetAmount: string;\n  currentAmount: string;\n  targetDate: Date;\n  category: string;\n  priority: string;\n  status: string;\n  createdAt: Date;\n}\n\n// Generate realistic demo transactions for the past 6 months\nexport function generateDemoTransactions(): DemoTransaction[] {\n  const transactions: DemoTransaction[] = [];\n  const now = new Date();\n  \n  // Monthly income (salary)\n  for (let i = 0; i < 6; i++) {\n    const date = subMonths(now, i);\n    transactions.push({\n      id: `demo-income-${i}`,\n      amount: '5250',\n      type: 'income',\n      category: 'Salary',\n      description: 'Monthly Salary',\n      date: new Date(date.getFullYear(), date.getMonth(), 1)\n    });\n  }\n  \n  // Recurring expenses\n  const recurringExpenses = [\n    { category: 'Housing', description: 'Rent', amount: '1800', day: 1 },\n    { category: 'Utilities', description: 'Electricity & Water', amount: '150', day: 5 },\n    { category: 'Transportation', description: 'Car Payment', amount: '350', day: 10 },\n    { category: 'Insurance', description: 'Health Insurance', amount: '280', day: 1 },\n    { category: 'Subscriptions', description: 'Netflix & Spotify', amount: '35', day: 15 },\n    { category: 'Subscriptions', description: 'Gym Membership', amount: '50', day: 1 },\n  ];\n  \n  for (let month = 0; month < 6; month++) {\n    recurringExpenses.forEach((expense, idx) => {\n      const date = subMonths(now, month);\n      transactions.push({\n        id: `demo-expense-${month}-${idx}`,\n        amount: expense.amount,\n        type: 'expense',\n        category: expense.category,\n        description: expense.description,\n        date: new Date(date.getFullYear(), date.getMonth(), expense.day)\n      });\n    });\n  }\n  \n  // Random one-time expenses (groceries, dining, shopping)\n  const randomExpenses = [\n    { category: 'Food & Dining', descriptions: ['Whole Foods', 'Starbucks', 'Restaurant', 'Chipotle', 'Grocery Store'], range: [15, 120] },\n    { category: 'Shopping', descriptions: ['Amazon', 'Target', 'Best Buy', 'Online Store'], range: [30, 200] },\n    { category: 'Entertainment', descriptions: ['Movie Theater', 'Concert Tickets', 'Gaming', 'Books'], range: [20, 150] },\n    { category: 'Health', descriptions: ['Pharmacy', 'Doctor Visit', 'Vitamins'], range: [25, 100] },\n  ];\n  \n  let expenseId = 1000;\n  for (let month = 0; month < 6; month++) {\n    for (let week = 0; week < 4; week++) {\n      randomExpenses.forEach(category => {\n        const randomCount = Math.floor(Math.random() * 3) + 1;\n        for (let i = 0; i < randomCount; i++) {\n          const day = week * 7 + Math.floor(Math.random() * 7) + 1;\n          const date = subMonths(now, month);\n          const amount = Math.floor(Math.random() * (category.range[1] - category.range[0]) + category.range[0]);\n          const description = category.descriptions[Math.floor(Math.random() * category.descriptions.length)];\n          \n          if (day <= new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate()) {\n            transactions.push({\n              id: `demo-random-${expenseId++}`,\n              amount: amount.toString(),\n              type: 'expense',\n              category: category.category,\n              description,\n              date: new Date(date.getFullYear(), date.getMonth(), day)\n            });\n          }\n        }\n      });\n    }\n  }\n  \n  return transactions.sort((a, b) => b.date.getTime() - a.date.getTime());\n}\n\n// Generate realistic demo financial goals\nexport function generateDemoGoals(): DemoGoal[] {\n  const now = new Date();\n  \n  return [\n    {\n      id: 'demo-goal-1',\n      title: 'Emergency Fund',\n      description: 'Build a 6-month emergency fund for financial security',\n      targetAmount: '18000',\n      currentAmount: '7250',\n      targetDate: addMonths(now, 10),\n      category: 'emergency',\n      priority: 'high',\n      status: 'active',\n      createdAt: subMonths(now, 4)\n    },\n    {\n      id: 'demo-goal-2',\n      title: 'Dream Vacation to Japan',\n      description: 'Two-week trip to Tokyo and Kyoto',\n      targetAmount: '6000',\n      currentAmount: '2100',\n      targetDate: addMonths(now, 8),\n      category: 'vacation',\n      priority: 'medium',\n      status: 'active',\n      createdAt: subMonths(now, 2)\n    },\n    {\n      id: 'demo-goal-3',\n      title: 'New Laptop',\n      description: 'MacBook Pro for work and creative projects',\n      targetAmount: '2500',\n      currentAmount: '1850',\n      targetDate: addMonths(now, 3),\n      category: 'purchase',\n      priority: 'high',\n      status: 'active',\n      createdAt: subMonths(now, 3)\n    },\n    {\n      id: 'demo-goal-4',\n      title: 'Investment Portfolio',\n      description: 'Start building a diversified investment portfolio',\n      targetAmount: '10000',\n      currentAmount: '3400',\n      targetDate: addMonths(now, 12),\n      category: 'investment',\n      priority: 'medium',\n      status: 'active',\n      createdAt: subMonths(now, 5)\n    },\n    {\n      id: 'demo-goal-5',\n      title: 'Down Payment for House',\n      description: 'Saving for a 20% down payment on a home',\n      targetAmount: '60000',\n      currentAmount: '12500',\n      targetDate: addMonths(now, 36),\n      category: 'house',\n      priority: 'high',\n      status: 'active',\n      createdAt: subMonths(now, 8)\n    }\n  ];\n}\n\n// Generate demo crypto holdings\nexport function generateDemoCryptoHoldings() {\n  const now = new Date();\n  \n  return [\n    {\n      id: 'demo-crypto-1',\n      coinId: 'bitcoin',\n      symbol: 'BTC',\n      name: 'Bitcoin',\n      amount: '0.15',\n      averageBuyPrice: '42000',\n      currentPrice: '45000', // Will be updated by real API\n      source: 'manual',\n      notes: 'Long-term holding',\n      lastPriceUpdate: now,\n      createdAt: subMonths(now, 6)\n    },\n    {\n      id: 'demo-crypto-2',\n      coinId: 'ethereum',\n      symbol: 'ETH',\n      name: 'Ethereum',\n      amount: '2.5',\n      averageBuyPrice: '2200',\n      currentPrice: '2500',\n      source: 'manual',\n      notes: 'DeFi investments',\n      lastPriceUpdate: now,\n      createdAt: subMonths(now, 4)\n    }\n  ];\n}\n\n// Calculate demo financial stats\nexport function getDemoFinancialStats() {\n  const transactions = generateDemoTransactions();\n  const goals = generateDemoGoals();\n  \n  const totalIncome = transactions\n    .filter(t => t.type === 'income')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n  const totalExpenses = transactions\n    .filter(t => t.type === 'expense')\n    .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n  const totalSavings = totalIncome - totalExpenses;\n  const currentGoalsSavings = goals.reduce((sum, g) => sum + parseFloat(g.currentAmount), 0);\n  \n  return {\n    totalSavings: totalSavings.toFixed(2),\n    activeGoals: goals.filter(g => g.status === 'active').length.toString(),\n    monthlyIncome: '5250',\n    monthlyExpenses: (totalExpenses / 6).toFixed(2),\n    savingsRate: ((totalSavings / totalIncome) * 100).toFixed(1) + '%',\n    goalsProgress: currentGoalsSavings.toFixed(2)\n  };\n}\n\n// Demo time-value insights\nexport function getDemoTimeStats() {\n  return {\n    totalTimeHours: 720, // ~90 days worth of tracked time\n    timeValue: 3600, // 720 hours * $50/hour\n    productivity: 0.85,\n    efficiency: 0.78,\n    focusScore: 82\n  };\n}\n","path":null,"size_bytes":7651,"size_tokens":null},"client/src/pages/pricing.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Check, ArrowRight, Zap, Crown, Sparkles } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useUserCurrency } from \"@/lib/userContext\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\n\ninterface Plan {\n  id: string;\n  name: string;\n  displayName: string;\n  description: string;\n  priceThb: string;\n  priceUsd: string;\n  billingInterval: string;\n  features: string[];\n  scoutLimit: number;\n  sonnetLimit: number;\n  gpt5Limit: number;\n  opusLimit: number;\n}\n\nexport default function Pricing() {\n  const [, setLocation] = useLocation();\n  const { formatAmount, currencySymbol } = useUserCurrency();\n\n  const { data: plans = [], isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/subscription/plans\"],\n  });\n\n  const { data: currentSubscription } = useQuery({\n    queryKey: [\"/api/subscription/current\"],\n  });\n\n  const currentPlanName = (currentSubscription as any)?.subscription?.plan?.name || \"free\";\n\n  const sortedPlans = [...plans].sort((a, b) => {\n    const order: Record<string, number> = { free: 0, pro: 1, enterprise: 2 };\n    return (order[a.name] || 0) - (order[b.name] || 0);\n  });\n\n  const getPlanFeatures = (plan: Plan) => {\n    const features: string[] = [];\n    \n    if (plan.name === \"free\") {\n      features.push(\"50 Scout AI queries/month\");\n      features.push(\"Basic financial tracking\");\n      features.push(\"Up to 3 financial goals\");\n      features.push(\"30-day transaction history\");\n      features.push(\"11 language support\");\n    } else if (plan.name === \"pro\") {\n      features.push(\"Unlimited Scout AI queries\");\n      features.push(\"25 Sonnet reasoning queries/month\");\n      features.push(\"5 GPT-5 math queries/month\");\n      features.push(\"Unlimited financial goals\");\n      features.push(\"Full transaction history\");\n      features.push(\"Crypto portfolio tracking\");\n      features.push(\"Advanced analytics & reports\");\n      features.push(\"Priority support\");\n    } else if (plan.name === \"enterprise\") {\n      features.push(\"Everything in Pro, plus:\");\n      features.push(\"60 Sonnet reasoning queries/month\");\n      features.push(\"10 GPT-5 math queries/month\");\n      features.push(\"20 Opus CFO queries/month\");\n      features.push(\"CFO-level financial analysis\");\n      features.push(\"Team collaboration features\");\n      features.push(\"API access\");\n      features.push(\"Dedicated support\");\n    }\n    \n    return features;\n  };\n\n  const getPlanIcon = (planName: string) => {\n    switch (planName) {\n      case \"free\": return <Sparkles className=\"w-5 h-5\" />;\n      case \"pro\": return <Crown className=\"w-5 h-5\" />;\n      case \"enterprise\": return <Zap className=\"w-5 h-5\" />;\n      default: return <Sparkles className=\"w-5 h-5\" />;\n    }\n  };\n\n  const formatPrice = (priceUsd: string | undefined, billingInterval: string) => {\n    const price = parseFloat(priceUsd || \"0\");\n    if (isNaN(price) || price === 0) return { amount: `${currencySymbol}0`, period: \"forever\" };\n    return { \n      amount: formatAmount(price), \n      period: `/${billingInterval === \"monthly\" ? \"mo\" : billingInterval}` \n    };\n  };\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-black\">\n      <header className=\"border-b border-gray-100 dark:border-gray-900 bg-white/80 dark:bg-black/80 backdrop-blur-sm sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8 py-4 flex items-center justify-between\">\n          <Link href=\"/\">\n            <a className=\"flex items-center gap-3\">\n              <img src={logoUrl} alt=\"Twealth\" className=\"w-8 h-8\" />\n              <span className=\"text-xl font-semibold text-black dark:text-white\">Twealth</span>\n            </a>\n          </Link>\n          <div className=\"flex items-center gap-4\">\n            <Button \n              variant=\"ghost\" \n              className=\"text-sm font-medium\"\n              onClick={() => setLocation(\"/login\")}\n            >\n              Sign in\n            </Button>\n            <Button \n              size=\"sm\"\n              className=\"text-sm font-medium bg-black dark:bg-white text-white dark:text-black hover:bg-gray-800 dark:hover:bg-gray-200\"\n              onClick={() => setLocation(\"/login\")}\n            >\n              Get started\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      <section className=\"max-w-7xl mx-auto px-6 lg:px-8 pt-20 pb-12 text-center\">\n        <Badge \n          variant=\"outline\" \n          className=\"mb-6 px-4 py-1.5 text-sm font-medium border-gray-200 dark:border-gray-800\"\n        >\n          Pricing\n        </Badge>\n        <h1 className=\"text-5xl sm:text-6xl font-bold tracking-tight text-black dark:text-white mb-6\">\n          Simple, transparent pricing\n        </h1>\n        <p className=\"text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto\">\n          Start free and scale as you grow. Unlock AI-powered financial insights with Pro or Enterprise.\n        </p>\n      </section>\n\n      <section className=\"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-24\">\n        {isLoading ? (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"h-[450px] sm:h-[500px] bg-gray-100 dark:bg-gray-900 rounded-2xl animate-pulse\" />\n            ))}\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8\">\n            {sortedPlans.slice(0, 3).map((plan) => {\n              const isCurrentPlan = currentPlanName === plan.name;\n              const isPro = plan.name === \"pro\";\n              const isEnterprise = plan.name === \"enterprise\";\n              const { amount, period } = formatPrice(plan.priceUsd, plan.billingInterval);\n              const features = getPlanFeatures(plan);\n\n              return (\n                <div\n                  key={plan.id}\n                  className={`relative rounded-2xl p-5 sm:p-6 lg:p-8 ${\n                    isPro\n                      ? \"border-2 border-black dark:border-white bg-gray-50 dark:bg-gray-950\"\n                      : \"border border-gray-200 dark:border-gray-800\"\n                  }`}\n                  data-testid={`card-plan-${plan.name.toLowerCase()}`}\n                >\n                  {isPro && (\n                    <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\n                      <Badge className=\"bg-black dark:bg-white text-white dark:text-black px-4 py-1 text-xs font-medium\">\n                        Most Popular\n                      </Badge>\n                    </div>\n                  )}\n                  {isEnterprise && (\n                    <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\n                      <Badge className=\"bg-gradient-to-r from-amber-500 to-yellow-600 text-white px-4 py-1 text-xs font-medium\">\n                        Best for Teams\n                      </Badge>\n                    </div>\n                  )}\n\n                  <div className=\"mb-5 sm:mb-8\">\n                    <div className=\"flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4\">\n                      <div className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl flex items-center justify-center ${\n                        isPro \n                          ? \"bg-blue-100 dark:bg-blue-950 text-blue-600 dark:text-blue-400\"\n                          : isEnterprise\n                          ? \"bg-amber-100 dark:bg-amber-950 text-amber-600 dark:text-amber-400\"\n                          : \"bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-400\"\n                      }`}>\n                        {getPlanIcon(plan.name)}\n                      </div>\n                      <h2 className=\"text-lg sm:text-xl font-semibold text-black dark:text-white\">\n                        {plan.displayName}\n                      </h2>\n                    </div>\n                    \n                    <p className=\"text-gray-600 dark:text-gray-400 text-xs sm:text-sm mb-4 sm:mb-6 min-h-[36px] sm:min-h-[40px]\">\n                      {plan.description}\n                    </p>\n\n                    <div className=\"flex items-baseline gap-1 mb-4 sm:mb-6\">\n                      <span className=\"text-3xl sm:text-4xl font-bold text-black dark:text-white\">\n                        {amount}\n                      </span>\n                      <span className=\"text-gray-500 dark:text-gray-500 text-sm\">\n                        {period}\n                      </span>\n                    </div>\n\n                    <Button\n                      className={`w-full h-11 sm:h-12 text-sm sm:text-base font-medium rounded-xl min-h-[44px] touch-target ${\n                        isPro\n                          ? \"bg-black dark:bg-white text-white dark:text-black hover:bg-gray-800 dark:hover:bg-gray-200\"\n                          : \"bg-gray-100 dark:bg-gray-900 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-800\"\n                      }`}\n                      disabled={isCurrentPlan}\n                      onClick={() => setLocation(isCurrentPlan ? \"/subscription\" : \"/subscription\")}\n                      data-testid={`button-${plan.name.toLowerCase()}-plan`}\n                    >\n                      {isCurrentPlan ? (\n                        \"Current plan\"\n                      ) : (\n                        <>\n                          Get started\n                          <ArrowRight className=\"w-4 h-4 ml-2\" />\n                        </>\n                      )}\n                    </Button>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    {features.map((feature, index) => (\n                      <div key={index} className=\"flex items-start gap-3\">\n                        <Check className=\"w-4 h-4 text-black dark:text-white flex-shrink-0 mt-0.5\" />\n                        <span className=\"text-sm text-gray-600 dark:text-gray-400\">\n                          {feature}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </section>\n\n      <section className=\"border-t border-gray-100 dark:border-gray-900 bg-gray-50 dark:bg-gray-950\">\n        <div className=\"max-w-4xl mx-auto px-6 lg:px-8 py-20 text-center\">\n          <h2 className=\"text-3xl font-bold text-black dark:text-white mb-4\">\n            Ready to take control of your finances?\n          </h2>\n          <p className=\"text-gray-600 dark:text-gray-400 mb-8 max-w-xl mx-auto\">\n            Join thousands of users who trust Twealth for their financial management. Start free today.\n          </p>\n          <Button\n            size=\"lg\"\n            className=\"h-14 px-8 text-base font-medium bg-black dark:bg-white text-white dark:text-black hover:bg-gray-800 dark:hover:bg-gray-200 rounded-xl\"\n            onClick={() => setLocation(\"/login\")}\n          >\n            Start for free\n            <ArrowRight className=\"w-4 h-4 ml-2\" />\n          </Button>\n        </div>\n      </section>\n\n      <footer className=\"border-t border-gray-100 dark:border-gray-900 py-8\">\n        <div className=\"max-w-7xl mx-auto px-6 lg:px-8 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <img src={logoUrl} alt=\"Twealth\" className=\"w-6 h-6\" />\n            <span className=\"text-sm text-gray-500\">2025 Twealth</span>\n          </div>\n          <div className=\"flex items-center gap-6 text-sm text-gray-500\">\n            <button \n              onClick={() => setLocation(\"/terms\")}\n              className=\"hover:text-gray-700 dark:hover:text-gray-300 transition-colors\"\n              data-testid=\"link-terms\"\n            >\n              Terms\n            </button>\n            <button \n              onClick={() => setLocation(\"/privacy\")}\n              className=\"hover:text-gray-700 dark:hover:text-gray-300 transition-colors\"\n              data-testid=\"link-privacy\"\n            >\n              Privacy\n            </button>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":12273,"size_tokens":null},"server/middleware/demoMode.ts":{"content":"/**\n * Demo Mode Middleware\n * Checks if user has demo mode enabled and injects demo data into requests\n */\n\nimport { Request, Response, NextFunction } from 'express';\n\nexport async function checkDemoMode(req: Request, res: Response, next: NextFunction) {\n  // Demo mode check will be handled in individual routes\n  // This middleware just adds a helper to check demo status\n  res.locals.isDemoMode = false;\n  \n  if (req.user) {\n    try {\n      const storage = req.app.locals.storage;\n      const userId = (req.user as any).id;\n      const preferences = await storage.getUserPreferences(userId);\n      res.locals.isDemoMode = preferences?.demoMode === true;\n    } catch (error) {\n      // If we can't get preferences, assume not in demo mode\n      res.locals.isDemoMode = false;\n    }\n  }\n  \n  next();\n}\n\nexport function isDemoMode(res: Response): boolean {\n  return res.locals.isDemoMode === true;\n}\n","path":null,"size_bytes":901,"size_tokens":null},"client/src/components/onboarding/onboarding-wizard.tsx":{"content":"import { useState } from\"react\";\nimport { useForm } from\"react-hook-form\";\nimport { zodResolver } from\"@hookform/resolvers/zod\";\nimport { z } from\"zod\";\nimport { useMutation } from\"@tanstack/react-query\";\nimport { useLocation } from\"wouter\";\nimport { \n Sparkles, \n DollarSign, \n Target, \n CheckCircle2, \n ArrowRight, \n ArrowLeft,\n TrendingUp,\n PiggyBank,\n Rocket,\n Loader2\n} from\"lucide-react\";\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { Progress } from\"@/components/ui/progress\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from\"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from\"@/components/ui/select\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\n\nconst financialInfoSchema = z.object({\n monthlyIncome: z.string().min(1,\"Monthly income is required\"),\n monthlyExpenses: z.string().min(1,\"Monthly expenses are required\"),\n});\n\nconst goalSchema = z.object({\n title: z.string().min(1,\"Goal name is required\"),\n targetAmount: z.string().min(1,\"Target amount is required\"),\n targetDate: z.string().min(1,\"Target date is required\"),\n category: z.string().min(1,\"Category is required\"),\n priority: z.string().default(\"medium\"),\n});\n\ntype FinancialInfo = z.infer<typeof financialInfoSchema>;\ntype GoalInfo = z.infer<typeof goalSchema>;\n\ninterface OnboardingWizardProps {\n onComplete: () => void;\n}\n\nexport default function OnboardingWizard({ onComplete }: OnboardingWizardProps) {\n const [step, setStep] = useState(1);\n const [financialData, setFinancialData] = useState<FinancialInfo | null>(null);\n const [, navigate] = useLocation();\n const { toast } = useToast();\n\n const totalSteps = 4;\n const progress = (step / totalSteps) * 100;\n\n // Financial info form\n const financialForm = useForm<FinancialInfo>({\n resolver: zodResolver(financialInfoSchema),\n defaultValues: {\n monthlyIncome:\"\",\n monthlyExpenses:\"\",\n },\n });\n\n // Goal form\n const goalForm = useForm<GoalInfo>({\n resolver: zodResolver(goalSchema),\n defaultValues: {\n title:\"\",\n targetAmount:\"\",\n targetDate:\"\",\n category:\"savings\",\n priority:\"medium\",\n },\n });\n\n // Save financial estimates mutation\n const saveEstimates = useMutation({\n mutationFn: async (data: FinancialInfo) => {\n return apiRequest(\"POST\",\"/api/financial-estimates\", {\n monthlyIncome: parseFloat(data.monthlyIncome),\n monthlyExpenses: parseFloat(data.monthlyExpenses),\n });\n },\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n },\n });\n\n // Create goal mutation\n const createGoal = useMutation({\n mutationFn: async (data: GoalInfo) => {\n return apiRequest(\"POST\",\"/api/financial-goals\", {\n title: data.title,\n targetAmount: data.targetAmount,\n currentAmount:\"0\",\n targetDate: data.targetDate,\n category: data.category,\n priority: data.priority,\n status:\"active\",\n });\n },\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n },\n });\n\n const handleFinancialSubmit = async (data: FinancialInfo) => {\n setFinancialData(data);\n await saveEstimates.mutateAsync(data);\n setStep(3);\n };\n\n const handleGoalSubmit = async (data: GoalInfo) => {\n await createGoal.mutateAsync(data);\n setStep(4);\n };\n\n const handleComplete = () => {\n toast({\n title:\"Welcome to Twealth!\",\n description:\"Your financial journey starts now. Let's build wealth together!\",\n });\n onComplete();\n };\n\n return (\n <div className=\"min-h-screen bg-gray-50 dark:bg-gray-950 flex items-center justify-center p-4\">\n <div className=\"w-full max-w-2xl\">\n {/* Progress Bar */}\n <div className=\"mb-8\">\n <div className=\"flex justify-between items-center mb-3\">\n <span className=\"text-sm font-medium text-muted-foreground\">\n Step {step} of {totalSteps}\n </span>\n <span className=\"text-sm font-medium text-primary\">\n {Math.round(progress)}% Complete\n </span>\n </div>\n <Progress value={progress} className=\"h-2\" />\n </div>\n\n {/* Step 1: Welcome */}\n {step === 1 && (\n <Card className=\"border-2 shadow-xl\">\n <CardHeader className=\"text-center pb-4\">\n <div className=\"mx-auto mb-4 w-16 h-16 bg-white dark:bg-gray-900 rounded-2xl flex items-center justify-center shadow-lg\">\n <Sparkles className=\"w-8 h-8 text-white\" />\n </div>\n <CardTitle className=\"text-3xl font-bold text-foreground\">\n Welcome to Twealth!\n </CardTitle>\n <CardDescription className=\"text-base mt-2\">\n Your AI-powered CFO advisor for smarter financial decisions\n </CardDescription>\n </CardHeader>\n <CardContent className=\"space-y-6\">\n <div className=\"space-y-4\">\n <div className=\"flex items-start gap-3 p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20\">\n <TrendingUp className=\"w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5\" />\n <div>\n <h4 className=\"font-semibold text-sm mb-1\">Track Everything</h4>\n <p className=\"text-sm text-muted-foreground\">\n Monitor income, expenses, and financial goals in real-time\n </p>\n </div>\n </div>\n <div className=\"flex items-start gap-3 p-4 rounded-lg bg-blue-50 dark:bg-blue-950/20\">\n <PiggyBank className=\"w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5\" />\n <div>\n <h4 className=\"font-semibold text-sm mb-1\">AI-Powered Insights</h4>\n <p className=\"text-sm text-muted-foreground\">\n Get CFO-level advice on spending, saving, and investing\n </p>\n </div>\n </div>\n <div className=\"flex items-start gap-3 p-4 rounded-lg bg-green-50 dark:bg-green-950/20\">\n <Rocket className=\"w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5\" />\n <div>\n <h4 className=\"font-semibold text-sm mb-1\">Achieve Your Goals</h4>\n <p className=\"text-sm text-muted-foreground\">\n Set goals, track progress, and reach them faster\n </p>\n </div>\n </div>\n </div>\n \n <div className=\"pt-4\">\n <Button \n onClick={() => setStep(2)}\n className=\"w-full bg-primary text-primary-foreground font-semibold h-12\"\n data-testid=\"button-start-onboarding\"\n >\n Get Started\n <ArrowRight className=\"ml-2 w-5 h-5\" />\n </Button>\n </div>\n </CardContent>\n </Card>\n )}\n\n {/* Step 2: Financial Basics */}\n {step === 2 && (\n <Card className=\"border-2 shadow-xl\">\n <CardHeader>\n <div className=\"mx-auto mb-4 w-12 h-12 bg-blue-600 dark:bg-blue-500 rounded-xl flex items-center justify-center\">\n <DollarSign className=\"w-6 h-6 text-white\" />\n </div>\n <CardTitle className=\"text-center\">Tell us about your finances</CardTitle>\n <CardDescription className=\"text-center\">\n This helps us provide personalized advice\n </CardDescription>\n </CardHeader>\n <CardContent>\n <Form {...financialForm}>\n <form onSubmit={financialForm.handleSubmit(handleFinancialSubmit)} className=\"space-y-6\">\n <FormField\n control={financialForm.control}\n name=\"monthlyIncome\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Monthly Income</FormLabel>\n <FormControl>\n <div className=\"relative\">\n <DollarSign className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n <Input\n {...field}\n type=\"number\"\n placeholder=\"5000\"\n className=\"pl-9 h-11\"\n data-testid=\"input-monthly-income\"\n />\n </div>\n </FormControl>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <FormField\n control={financialForm.control}\n name=\"monthlyExpenses\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Monthly Expenses</FormLabel>\n <FormControl>\n <div className=\"relative\">\n <DollarSign className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n <Input\n {...field}\n type=\"number\"\n placeholder=\"3000\"\n className=\"pl-9 h-11\"\n data-testid=\"input-monthly-expenses\"\n />\n </div>\n </FormControl>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <div className=\"flex gap-3 pt-4\">\n <Button\n type=\"button\"\n variant=\"outline\"\n onClick={() => setStep(1)}\n className=\"flex-1\"\n data-testid=\"button-back-step1\"\n >\n <ArrowLeft className=\"mr-2 w-4 h-4\" />\n Back\n </Button>\n <Button\n type=\"submit\"\n disabled={saveEstimates.isPending}\n className=\"flex-1 bg-white dark:bg-gray-900\"\n data-testid=\"button-continue-step2\"\n >\n {saveEstimates.isPending && <Loader2 className=\"mr-2 h-4 w-4\" />}\n {saveEstimates.isPending ?\"Saving...\" :\"Continue\"}\n {!saveEstimates.isPending && <ArrowRight className=\"ml-2 w-4 h-4\" />}\n </Button>\n </div>\n </form>\n </Form>\n </CardContent>\n </Card>\n )}\n\n {/* Step 3: Create First Goal */}\n {step === 3 && (\n <Card className=\"border-2 shadow-xl\">\n <CardHeader>\n <div className=\"mx-auto mb-4 w-12 h-12 bg-blue-600 dark:bg-blue-500 rounded-xl flex items-center justify-center\">\n <Target className=\"w-6 h-6 text-white\" />\n </div>\n <CardTitle className=\"text-center\">Set your first goal</CardTitle>\n <CardDescription className=\"text-center\">\n What would you like to achieve? (You can add more goals later)\n </CardDescription>\n </CardHeader>\n <CardContent>\n <Form {...goalForm}>\n <form onSubmit={goalForm.handleSubmit(handleGoalSubmit)} className=\"space-y-4\">\n <FormField\n control={goalForm.control}\n name=\"title\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Goal Name</FormLabel>\n <FormControl>\n <Input\n {...field}\n placeholder=\"Emergency Fund\"\n className=\"h-11\"\n data-testid=\"input-goal-title\"\n />\n </FormControl>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <FormField\n control={goalForm.control}\n name=\"targetAmount\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Target Amount</FormLabel>\n <FormControl>\n <div className=\"relative\">\n <DollarSign className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n <Input\n {...field}\n type=\"number\"\n placeholder=\"10000\"\n className=\"pl-9 h-11\"\n data-testid=\"input-goal-amount\"\n />\n </div>\n </FormControl>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <FormField\n control={goalForm.control}\n name=\"targetDate\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Target Date</FormLabel>\n <FormControl>\n <Input\n {...field}\n type=\"date\"\n className=\"h-11\"\n min={new Date().toISOString().split('T')[0]}\n data-testid=\"input-goal-date\"\n />\n </FormControl>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <FormField\n control={goalForm.control}\n name=\"category\"\n render={({ field }) => (\n <FormItem>\n <FormLabel>Category</FormLabel>\n <Select onValueChange={field.onChange} defaultValue={field.value}>\n <FormControl>\n <SelectTrigger className=\"h-11\" data-testid=\"select-goal-category\">\n <SelectValue placeholder=\"Select a category\" />\n </SelectTrigger>\n </FormControl>\n <SelectContent>\n <SelectItem value=\"savings\">Savings</SelectItem>\n <SelectItem value=\"investment\">Investment</SelectItem>\n <SelectItem value=\"debt\">Debt Payoff</SelectItem>\n <SelectItem value=\"purchase\">Major Purchase</SelectItem>\n <SelectItem value=\"travel\">Travel</SelectItem>\n <SelectItem value=\"education\">Education</SelectItem>\n <SelectItem value=\"retirement\">Retirement</SelectItem>\n <SelectItem value=\"other\">Other</SelectItem>\n </SelectContent>\n </Select>\n <FormMessage />\n </FormItem>\n )}\n />\n\n <div className=\"flex gap-3 pt-4\">\n <Button\n type=\"button\"\n variant=\"outline\"\n onClick={() => setStep(2)}\n className=\"flex-1\"\n data-testid=\"button-back-step2\"\n >\n <ArrowLeft className=\"mr-2 w-4 h-4\" />\n Back\n </Button>\n <Button\n type=\"submit\"\n disabled={createGoal.isPending}\n className=\"flex-1 bg-white dark:bg-gray-900\"\n data-testid=\"button-create-goal\"\n >\n {createGoal.isPending && <Loader2 className=\"mr-2 h-4 w-4\" />}\n {createGoal.isPending ?\"Creating...\" :\"Create Goal\"}\n {!createGoal.isPending && <ArrowRight className=\"ml-2 w-4 h-4\" />}\n </Button>\n </div>\n </form>\n </Form>\n </CardContent>\n </Card>\n )}\n\n {/* Step 4: Complete */}\n {step === 4 && (\n <Card className=\"border-2 shadow-xl\">\n <CardHeader className=\"text-center pb-4\">\n <div className=\"mx-auto mb-4 w-16 h-16 bg-white dark:bg-gray-900 rounded-2xl flex items-center justify-center shadow-lg\">\n <CheckCircle2 className=\"w-8 h-8 text-white\" />\n </div>\n <CardTitle className=\"text-3xl font-bold text-foreground\">\n You're All Set!\n </CardTitle>\n <CardDescription className=\"text-base mt-2\">\n Your Twealth account is ready. Let's start building wealth!\n </CardDescription>\n </CardHeader>\n <CardContent className=\"space-y-6\">\n <div className=\"p-6 rounded-lg bg-white dark:bg-gray-900\">\n <h4 className=\"font-semibold mb-3\">What's Next?</h4>\n <ul className=\"space-y-2 text-sm\">\n <li className=\"flex items-center gap-2\">\n <div className=\"w-5 h-5 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0\">\n <CheckCircle2 className=\"w-3 h-3 text-white\" />\n </div>\n <span>View your personalized dashboard</span>\n </li>\n <li className=\"flex items-center gap-2\">\n <div className=\"w-5 h-5 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0\">\n <CheckCircle2 className=\"w-3 h-3 text-white\" />\n </div>\n <span>Chat with AI for financial advice</span>\n </li>\n <li className=\"flex items-center gap-2\">\n <div className=\"w-5 h-5 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0\">\n <CheckCircle2 className=\"w-3 h-3 text-white\" />\n </div>\n <span>Track transactions and monitor progress</span>\n </li>\n </ul>\n </div>\n\n <Button\n onClick={handleComplete}\n className=\"w-full bg-primary text-primary-foreground font-semibold h-12\"\n data-testid=\"button-go-to-dashboard\"\n >\n <Sparkles className=\"mr-2 w-5 h-5\" />\n Go to Dashboard\n </Button>\n </CardContent>\n </Card>\n )}\n </div>\n </div>\n );\n}\n","path":null,"size_bytes":13238,"size_tokens":null},"client/src/hooks/use-onboarding.ts":{"content":"import { useState, useEffect } from\"react\";\nimport { useQuery } from\"@tanstack/react-query\";\n\ninterface OnboardingStatus {\n needsOnboarding: boolean;\n hasFinancialData: boolean;\n hasGoals: boolean;\n}\n\nexport function useOnboarding() {\n const [showOnboarding, setShowOnboarding] = useState(false);\n const [onboardingComplete, setOnboardingComplete] = useState(false);\n\n // Check if user has financial data\n const { data: stats } = useQuery({\n  queryKey: [\"/api/dashboard/stats\"],\n });\n\n // Check if user has any goals\n const { data: goals } = useQuery({\n  queryKey: [\"/api/financial-goals\"],\n });\n\n // Check onboarding status from localStorage\n useEffect(() => {\n  const completed = localStorage.getItem(\"onboarding_completed\");\n  setOnboardingComplete(completed ===\"true\");\n }, []);\n\n // Determine if onboarding is needed\n useEffect(() => {\n  if (onboardingComplete) {\n   setShowOnboarding(false);\n   return;\n  }\n\n  if (!stats || !goals) return;\n\n  const hasFinancialData = \n   (stats as any)?.monthlyIncome > 0 || \n   (stats as any)?.monthlyExpenses > 0 || \n   (stats as any)?.totalSavings > 0;\n  \n  const hasGoals = Array.isArray(goals) && goals.length > 0;\n\n  // Show onboarding if user has no financial data AND no goals\n  if (!hasFinancialData && !hasGoals) {\n   setShowOnboarding(true);\n  }\n }, [stats, goals, onboardingComplete]);\n\n const completeOnboarding = () => {\n  localStorage.setItem(\"onboarding_completed\",\"true\");\n  setOnboardingComplete(true);\n  setShowOnboarding(false);\n };\n\n const skipOnboarding = () => {\n  localStorage.setItem(\"onboarding_completed\",\"true\");\n  setOnboardingComplete(true);\n  setShowOnboarding(false);\n };\n\n return {\n  showOnboarding,\n  completeOnboarding,\n  skipOnboarding,\n };\n}\n","path":null,"size_bytes":1719,"size_tokens":null},"scripts/seed-investments.js":{"content":"import('../server/seed-investments.js').then(async ({ seedInvestments }) => {\n  try {\n    await seedInvestments();\n    console.log('✅ Seeding complete!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Seeding failed:', error);\n    process.exit(1);\n  }\n});\n","path":null,"size_bytes":276,"size_tokens":null},"server/seed-investments.ts":{"content":"import { db } from \"./db\";\nimport { investmentStrategies, passiveIncomeOpportunities } from \"@shared/schema\";\n\nexport async function seedInvestments() {\n  console.log(\"Seeding investment strategies...\");\n\n  const strategies = [\n    {\n      name: \"S&P 500 Index Funds\",\n      category: \"stocks\",\n      subcategory: \"index_funds\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"10.00\",\n      historicalReturn: \"10.26\",\n      minInvestment: \"1.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Invest in the 500 largest US companies through a single fund. Historically returns ~10% annually over the long term.\",\n      pros: [\"Highly diversified across sectors\", \"Low fees (0.03-0.20%)\", \"Simple to manage\", \"Strong historical performance\", \"Tracks overall market growth\"],\n      cons: [\"Market volatility in short term\", \"No downside protection\", \"Returns not guaranteed\", \"Taxable dividends\"],\n      bestFor: [\"Long-term investors (10+ years)\", \"Retirement savings\", \"Beginners seeking diversification\", \"Passive investors\"],\n      volatility: \"medium\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard (VOO)\", \"Fidelity (FXAIX)\", \"Schwab (SWPPX)\", \"iShares (IVV)\"],\n    },\n    {\n      name: \"High-Yield Savings Account\",\n      category: \"savings\",\n      subcategory: \"cash_equivalents\",\n      riskLevel: \"very_low\",\n      expectedReturn: \"4.50\",\n      historicalReturn: \"4.50\",\n      minInvestment: \"0.01\",\n      timeHorizon: \"short\",\n      liquidity: \"high\",\n      description: \"FDIC-insured savings accounts offering 4-5% APY. Perfect for emergency funds and short-term savings with zero risk.\",\n      pros: [\"FDIC insured up to $250k\", \"No market risk\", \"Instant liquidity\", \"Predictable returns\", \"No fees\"],\n      cons: [\"Returns barely beat inflation\", \"Rate can change\", \"Not ideal for long-term growth\", \"Lower than stock market returns\"],\n      bestFor: [\"Emergency funds\", \"Short-term savings goals\", \"Risk-averse investors\", \"Parking cash temporarily\"],\n      volatility: \"very_low\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Marcus by Goldman Sachs\", \"Ally Bank\", \"American Express Personal Savings\", \"CIT Bank\"],\n    },\n    {\n      name: \"Real Estate Investment Trusts (REITs)\",\n      category: \"real_estate\",\n      subcategory: \"reits\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"9.50\",\n      historicalReturn: \"11.80\",\n      minInvestment: \"10.00\",\n      timeHorizon: \"medium\",\n      liquidity: \"high\",\n      description: \"Own real estate without buying property. REITs own commercial buildings, apartments, data centers, etc. and pay 90% of income as dividends.\",\n      pros: [\"High dividend yields (4-8%)\", \"Real estate exposure without property management\", \"Diversification from stocks\", \"Inflation hedge\", \"Liquid (trade like stocks)\"],\n      cons: [\"Interest rate sensitive\", \"Not tax-efficient (dividends taxed as income)\", \"Market volatility\", \"No control over properties\"],\n      bestFor: [\"Income-seeking investors\", \"Portfolio diversification\", \"Real estate exposure without buying property\", \"Dividend investors\"],\n      volatility: \"medium\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard Real Estate ETF (VNQ)\", \"Realty Income (O)\", \"Prologis (PLD)\", \"American Tower (AMT)\"],\n    },\n    {\n      name: \"Treasury Bonds\",\n      category: \"bonds\",\n      subcategory: \"government_bonds\",\n      riskLevel: \"very_low\",\n      expectedReturn: \"4.60\",\n      historicalReturn: \"5.20\",\n      minInvestment: \"100.00\",\n      timeHorizon: \"medium\",\n      liquidity: \"medium\",\n      description: \"US government bonds backed by the full faith and credit of the United States. Currently yielding 4.6-4.9% with zero default risk.\",\n      pros: [\"Zero default risk\", \"Predictable income\", \"Safe haven in market crashes\", \"Tax advantages (state tax-free)\", \"Capital preservation\"],\n      cons: [\"Lower returns than stocks\", \"Inflation risk\", \"Interest rate risk\", \"Opportunity cost vs stocks\"],\n      bestFor: [\"Conservative investors\", \"Near-retirees\", \"Portfolio diversification\", \"Capital preservation\"],\n      volatility: \"low\",\n      taxTreatment: \"tax_advantaged\",\n      platformSuggestions: [\"TreasuryDirect.gov\", \"Vanguard Total Bond Market (BND)\", \"iShares 20+ Year Treasury (TLT)\"],\n    },\n    {\n      name: \"Bitcoin & Cryptocurrency\",\n      category: \"crypto\",\n      subcategory: \"cryptocurrency\",\n      riskLevel: \"very_high\",\n      expectedReturn: \"30.00\",\n      historicalReturn: \"100.00\",\n      minInvestment: \"1.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Digital currencies with high volatility but significant upside potential. Bitcoin up 36% YTD in 2025. Extremely risky but potentially transformative.\",\n      pros: [\"High growth potential\", \"24/7 trading\", \"Inflation hedge (limited supply)\", \"Portfolio diversification\", \"Decentralized\"],\n      cons: [\"Extreme volatility (-80% drawdowns possible)\", \"Regulatory uncertainty\", \"Security risks\", \"No intrinsic value\", \"Speculative\"],\n      bestFor: [\"Risk-tolerant investors\", \"Long-term believers in crypto\", \"Small portfolio allocation (1-5%)\", \"Tech-savvy investors\"],\n      volatility: \"very_high\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Coinbase\", \"Kraken\", \"Binance.US\", \"Gemini\"],\n    },\n    {\n      name: \"Dividend Growth Stocks\",\n      category: \"stocks\",\n      subcategory: \"dividend_stocks\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"8.00\",\n      historicalReturn: \"9.50\",\n      minInvestment: \"10.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Established companies with track records of increasing dividends annually. Provides growing income stream plus capital appreciation.\",\n      pros: [\"Growing passive income\", \"Less volatile than growth stocks\", \"Quality companies\", \"Dividend reinvestment compounds returns\", \"Tax-advantaged (qualified dividends)\"],\n      cons: [\"Lower growth than tech stocks\", \"Dividend cuts during recessions\", \"Sector concentration (utilities, consumer staples)\", \"Still subject to market risk\"],\n      bestFor: [\"Income investors\", \"Retirees\", \"Long-term wealth building\", \"Dividend reinvestors\"],\n      volatility: \"medium\",\n      taxTreatment: \"tax_advantaged\",\n      platformSuggestions: [\"Vanguard Dividend Appreciation (VIG)\", \"Schwab US Dividend Equity (SCHD)\", \"Procter & Gamble (PG)\", \"Johnson & Johnson (JNJ)\"],\n    },\n    {\n      name: \"Corporate Bonds (Investment Grade)\",\n      category: \"bonds\",\n      subcategory: \"corporate_bonds\",\n      riskLevel: \"low\",\n      expectedReturn: \"5.50\",\n      historicalReturn: \"6.00\",\n      minInvestment: \"1000.00\",\n      timeHorizon: \"medium\",\n      liquidity: \"medium\",\n      description: \"Bonds issued by financially strong corporations rated BBB or higher. Higher yield than Treasuries with moderate additional risk.\",\n      pros: [\"Higher yields than Treasuries\", \"Relatively safe (investment grade)\", \"Predictable income\", \"Portfolio diversification\", \"Lower volatility than stocks\"],\n      cons: [\"Credit risk (companies can default)\", \"Interest rate risk\", \"Less liquid than stocks\", \"Call risk\"],\n      bestFor: [\"Conservative income seekers\", \"Diversifying bond portfolio\", \"Retirees needing income\", \"Risk-averse investors\"],\n      volatility: \"low\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard Intermediate-Term Corporate Bond (VCIT)\", \"iShares iBoxx Investment Grade Corporate Bond (LQD)\", \"Fidelity\"],\n    },\n    {\n      name: \"Gold & Precious Metals\",\n      category: \"real_estate\",\n      subcategory: \"commodities\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"6.00\",\n      historicalReturn: \"7.50\",\n      minInvestment: \"50.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Physical gold, gold ETFs, or mining stocks. Traditional safe haven and inflation hedge with 3,000+ year track record.\",\n      pros: [\"Inflation hedge\", \"Safe haven during crises\", \"Portfolio diversification\", \"No counterparty risk (physical)\", \"Global acceptance\"],\n      cons: [\"No cash flow or dividends\", \"Storage costs (physical)\", \"Volatile short-term\", \"Opportunity cost vs stocks\", \"Doesn't compound\"],\n      bestFor: [\"Inflation protection\", \"Crisis hedge (5-10% allocation)\", \"Long-term wealth preservation\", \"Diversification\"],\n      volatility: \"medium\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"SPDR Gold Shares (GLD)\", \"iShares Gold Trust (IAU)\", \"Physical gold (APMEX, JM Bullion)\", \"Barrick Gold (GOLD)\"],\n    },\n    {\n      name: \"Target-Date Retirement Funds\",\n      category: \"stocks\",\n      subcategory: \"target_date_funds\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"7.50\",\n      historicalReturn: \"8.00\",\n      minInvestment: \"1.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"All-in-one funds that automatically rebalance from stocks to bonds as you near retirement. Perfect 'set and forget' option.\",\n      pros: [\"Automatic rebalancing\", \"Age-appropriate risk adjustment\", \"Professionally managed\", \"Ultimate simplicity\", \"Diversified globally\"],\n      cons: [\"Higher fees than basic index funds\", \"One-size-fits-all approach\", \"Can't customize allocation\", \"May be too conservative\"],\n      bestFor: [\"Retirement savers\", \"401(k) investors\", \"Hands-off investors\", \"Beginners\"],\n      volatility: \"medium\",\n      taxTreatment: \"tax_deferred\",\n      platformSuggestions: [\"Vanguard Target Retirement 2050 (VFIFX)\", \"Fidelity Freedom 2050 (FFFHX)\", \"Schwab Target 2050 (SWYMX)\"],\n    },\n    {\n      name: \"Peer-to-Peer Lending\",\n      category: \"bonds\",\n      subcategory: \"alternative_credit\",\n      riskLevel: \"high\",\n      expectedReturn: \"7.00\",\n      historicalReturn: \"5.50\",\n      minInvestment: \"25.00\",\n      timeHorizon: \"short\",\n      liquidity: \"low\",\n      description: \"Lend money directly to individuals or small businesses. Returns of 5-9% but with default risk and limited liquidity.\",\n      pros: [\"Higher yields than bonds\", \"Diversification from traditional investments\", \"Help individuals/businesses\", \"Monthly income\"],\n      cons: [\"High default risk\", \"Not liquid (3-5 year loans)\", \"Platform fees\", \"No FDIC insurance\", \"Economic downturn risk\"],\n      bestFor: [\"Experienced investors seeking alternative income\", \"Diversification (small allocation)\", \"Risk-tolerant income seekers\"],\n      volatility: \"medium\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"LendingClub\", \"Prosper\", \"Funding Circle\", \"Upstart\"],\n    },\n    {\n      name: \"International Stocks (Developed Markets)\",\n      category: \"stocks\",\n      subcategory: \"international_equities\",\n      riskLevel: \"moderate\",\n      expectedReturn: \"8.50\",\n      historicalReturn: \"7.80\",\n      minInvestment: \"1.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Invest in companies outside the US in developed countries (Europe, Japan, Canada, Australia). Provides geographic diversification.\",\n      pros: [\"Geographic diversification\", \"Currency diversification\", \"Access to global leaders\", \"Potentially undervalued vs US\", \"Dividend yields often higher\"],\n      cons: [\"Currency risk\", \"Political risk\", \"Lower returns than US historically\", \"Higher fees\", \"Tax complexity\"],\n      bestFor: [\"Long-term diversification\", \"Global exposure\", \"Reducing US concentration risk\"],\n      volatility: \"medium\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard FTSE Developed Markets (VEA)\", \"iShares MSCI EAFE (EFA)\", \"Schwab International Equity (SCHF)\"],\n    },\n    {\n      name: \"Small-Cap Stocks\",\n      category: \"stocks\",\n      subcategory: \"small_cap_equities\",\n      riskLevel: \"high\",\n      expectedReturn: \"12.00\",\n      historicalReturn: \"11.90\",\n      minInvestment: \"10.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Smaller companies ($300M-$2B market cap) with higher growth potential but more volatility. Historically outperform large caps long-term.\",\n      pros: [\"Higher growth potential\", \"Less analyst coverage (inefficiencies)\", \"Acquisition targets\", \"Domestic focused (less global risk)\", \"Tax-loss harvesting opportunities\"],\n      cons: [\"Much higher volatility\", \"Less liquidity\", \"Higher business risk\", \"Economic sensitivity\", \"More bankruptcies\"],\n      bestFor: [\"Long-term aggressive investors\", \"Younger investors\", \"Portfolio diversification\", \"Risk-tolerant investors\"],\n      volatility: \"high\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard Small-Cap ETF (VB)\", \"iShares Russell 2000 (IWM)\", \"Schwab US Small-Cap (SCHA)\"],\n    },\n    {\n      name: \"Emerging Market Stocks\",\n      category: \"stocks\",\n      subcategory: \"emerging_markets\",\n      riskLevel: \"very_high\",\n      expectedReturn: \"10.00\",\n      historicalReturn: \"6.50\",\n      minInvestment: \"10.00\",\n      timeHorizon: \"long\",\n      liquidity: \"high\",\n      description: \"Invest in developing countries (China, India, Brazil, etc.). Higher growth potential with significantly higher risk and volatility.\",\n      pros: [\"High growth potential (younger demographics)\", \"Diversification\", \"Currency upside\", \"Rising middle class\", \"Undervalued\"],\n      cons: [\"Extreme volatility\", \"Political instability\", \"Currency risk\", \"Accounting standards vary\", \"Liquidity issues\", \"Regulatory risk\"],\n      bestFor: [\"Very long-term investors\", \"Aggressive portfolios\", \"Small allocation for diversification (5-10%)\"],\n      volatility: \"very_high\",\n      taxTreatment: \"taxable\",\n      platformSuggestions: [\"Vanguard FTSE Emerging Markets (VWO)\", \"iShares MSCI Emerging Markets (EEM)\", \"Schwab Emerging Markets (SCHE)\"],\n    },\n    {\n      name: \"Municipal Bonds (Tax-Free)\",\n      category: \"bonds\",\n      subcategory: \"municipal_bonds\",\n      riskLevel: \"low\",\n      expectedReturn: \"3.50\",\n      historicalReturn: \"4.50\",\n      minInvestment: \"5000.00\",\n      timeHorizon: \"medium\",\n      liquidity: \"medium\",\n      description: \"Bonds issued by state/local governments. Interest is federal tax-free (and often state tax-free). Ideal for high earners.\",\n      pros: [\"Federal tax-free income\", \"Often state tax-free too\", \"Low default rates\", \"Supports local communities\", \"Predictable income\"],\n      cons: [\"Lower yields than taxable bonds\", \"Credit risk varies by issuer\", \"Less liquid\", \"High minimum investments\", \"Call risk\"],\n      bestFor: [\"High-income earners (24%+ tax bracket)\", \"Tax-efficient income\", \"Conservative investors\", \"State residents (double tax-free)\"],\n      volatility: \"low\",\n      taxTreatment: \"tax_free\",\n      platformSuggestions: [\"Vanguard Tax-Exempt Bond (VTEB)\", \"iShares National Muni Bond (MUB)\", \"Fidelity Tax-Free Bond (FTABX)\"],\n    },\n    {\n      name: \"I Bonds (Series I Savings Bonds)\",\n      category: \"bonds\",\n      subcategory: \"savings_bonds\",\n      riskLevel: \"very_low\",\n      expectedReturn: \"4.00\",\n      historicalReturn: \"3.50\",\n      minInvestment: \"25.00\",\n      timeHorizon: \"medium\",\n      liquidity: \"low\",\n      description: \"US government savings bonds with inflation-adjusted rates. Currently ~4% with zero default risk. Must hold 1 year minimum.\",\n      pros: [\"100% inflation protected\", \"Zero default risk\", \"State/local tax-free\", \"Low minimum ($25)\", \"Backed by US government\"],\n      cons: [\"$10k annual purchase limit\", \"Must hold 1 year minimum\", \"Penalty if sold before 5 years\", \"Lower returns than stocks\", \"Not liquid\"],\n      bestFor: [\"Inflation protection\", \"Ultra-conservative savers\", \"Diversifying bond holdings\", \"Small allocations\"],\n      volatility: \"very_low\",\n      taxTreatment: \"tax_advantaged\",\n      platformSuggestions: [\"TreasuryDirect.gov (only option)\"],\n    },\n  ];\n\n  await db.insert(investmentStrategies).values(strategies);\n  console.log(`Seeded ${strategies.length} investment strategies`);\n\n  console.log(\"Seeding passive income opportunities...\");\n\n  const passiveIncomes = [\n    {\n      name: \"Digital Products (eBooks, Courses, Templates)\",\n      category: \"digital_products\",\n      startupCost: \"low\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"5000.00\",\n      effortLevel: \"high\",\n      timeToProfit: \"3_6_months\",\n      scalability: \"high\",\n      description: \"Create once, sell forever. Build eBooks, online courses, Notion templates, spreadsheets, or design assets. Earnings scale infinitely with no inventory costs.\",\n      requiredSkills: [\"Writing/Design\", \"Marketing\", \"Subject matter expertise\", \"Basic tech skills\"],\n      platforms: [\"Gumroad\", \"Teachable\", \"Udemy\", \"Etsy (digital)\", \"Amazon KDP\"],\n      pros: [\"Zero marginal cost per sale\", \"Fully passive after creation\", \"Infinitely scalable\", \"Global audience\", \"No inventory\"],\n      cons: [\"High upfront time investment\", \"Marketing required\", \"Competitive space\", \"Need audience/platform\", \"Income varies wildly\"],\n      bestFor: [\"Experts in a field\", \"Creators/educators\", \"Designers\", \"Writers\", \"Anyone with teachable skills\"],\n    },\n    {\n      name: \"Dividend Stocks Portfolio\",\n      category: \"investments\",\n      startupCost: \"medium\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"2000.00\",\n      effortLevel: \"low\",\n      timeToProfit: \"immediate\",\n      scalability: \"high\",\n      description: \"Build a portfolio of dividend-paying stocks. With $50k invested at 4% yield = $2,000/year passive income. Reinvest to compound.\",\n      requiredSkills: [\"Basic investing knowledge\", \"Patience\", \"Discipline\"],\n      platforms: [\"Vanguard\", \"Fidelity\", \"Schwab\", \"Robinhood\", \"M1 Finance\"],\n      pros: [\"Truly passive\", \"Compounds over time\", \"Tax-advantaged (qualified dividends)\", \"Growing income\", \"Capital appreciation too\"],\n      cons: [\"Requires capital ($10k+ for meaningful income)\", \"Market risk\", \"Dividends can be cut\", \"Slow to build\"],\n      bestFor: [\"Long-term investors\", \"Those with capital to invest\", \"Patient builders\", \"Retirement planning\"],\n    },\n    {\n      name: \"YouTube Ad Revenue\",\n      category: \"content_creation\",\n      startupCost: \"very_low\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"5000.00\",\n      effortLevel: \"very_high\",\n      timeToProfit: \"6_12_months\",\n      scalability: \"high\",\n      description: \"Create evergreen video content that generates ad revenue for years. 1,000 subscribers + 4,000 watch hours to monetize. $2-7 per 1,000 views typical.\",\n      requiredSkills: [\"Video editing\", \"Speaking/presentation\", \"SEO optimization\", \"Consistency\"],\n      platforms: [\"YouTube\", \"AdSense\"],\n      pros: [\"Videos earn for years\", \"Highly scalable\", \"Multiple revenue streams (ads, sponsors, affiliates)\", \"Build an audience\", \"Low startup cost\"],\n      cons: [\"Extremely time-intensive upfront\", \"Slow to monetize\", \"Algorithm dependency\", \"High competition\", \"Burnout risk\"],\n      bestFor: [\"Video creators\", \"Educators\", \"Entertainers\", \"Patient builders\", \"Those with unique expertise\"],\n    },\n    {\n      name: \"Affiliate Marketing Blog/Website\",\n      category: \"content_creation\",\n      startupCost: \"low\",\n      monthlyEarningsMin: \"200.00\",\n      monthlyEarningsMax: \"3000.00\",\n      effortLevel: \"high\",\n      timeToProfit: \"6_12_months\",\n      scalability: \"high\",\n      description: \"Build a niche website with product reviews/comparisons. Earn commissions when visitors buy through your affiliate links. SEO-driven traffic.\",\n      requiredSkills: [\"SEO\", \"Writing\", \"Web basics\", \"Marketing\", \"Niche research\"],\n      platforms: [\"Amazon Associates\", \"ShareASale\", \"CJ Affiliate\", \"ClickBank\", \"WordPress\"],\n      pros: [\"Evergreen content earns for years\", \"No product creation\", \"Multiple affiliate programs\", \"Scale with more content\", \"Passive once ranked\"],\n      cons: [\"SEO takes 6-12 months\", \"Google algorithm changes\", \"Affiliate commission cuts\", \"Competitive niches\", \"Requires consistent content\"],\n      bestFor: [\"Writers\", \"SEO enthusiasts\", \"Patient marketers\", \"Niche experts\"],\n    },\n    {\n      name: \"Print on Demand (Merch, T-Shirts, Art)\",\n      category: \"digital_products\",\n      startupCost: \"very_low\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"2000.00\",\n      effortLevel: \"medium\",\n      timeToProfit: \"1_3_months\",\n      scalability: \"high\",\n      description: \"Design t-shirts, mugs, phone cases, etc. Third-party handles printing/shipping. You earn royalties per sale. Zero inventory risk.\",\n      requiredSkills: [\"Graphic design\", \"Niche research\", \"Marketing basics\"],\n      platforms: [\"Merch by Amazon\", \"Redbubble\", \"Printful\", \"Teespring\", \"Etsy\"],\n      pros: [\"Zero inventory/shipping\", \"Fully automated fulfillment\", \"Global sales\", \"One design sells indefinitely\", \"Low startup cost\"],\n      cons: [\"Low profit margins ($2-5/sale)\", \"Saturated market\", \"Design theft risk\", \"Platform dependency\", \"Need volume for income\"],\n      bestFor: [\"Graphic designers\", \"Artists\", \"Trend spotters\", \"Side hustlers\"],\n    },\n    {\n      name: \"Rental Income (Airbnb, Extra Room)\",\n      category: \"real_estate\",\n      startupCost: \"low\",\n      monthlyEarningsMin: \"500.00\",\n      monthlyEarningsMax: \"3000.00\",\n      effortLevel: \"medium\",\n      timeToProfit: \"immediate\",\n      scalability: \"medium\",\n      description: \"Rent out a spare room, basement, or property on Airbnb/VRBO. Earn $500-3,000/month depending on location. Semi-passive with property manager.\",\n      requiredSkills: [\"Hospitality\", \"Property management basics\", \"Communication\"],\n      platforms: [\"Airbnb\", \"VRBO\", \"Furnished Finder\"],\n      pros: [\"Immediate income\", \"High earnings potential\", \"Leverage existing property\", \"Tax deductions\", \"Flexible hosting\"],\n      cons: [\"Guest management time\", \"Property wear and tear\", \"Regulatory issues\", \"Not fully passive\", \"Income varies seasonally\"],\n      bestFor: [\"Homeowners with extra space\", \"High-traffic location residents\", \"People-oriented hosts\"],\n    },\n    {\n      name: \"High-Yield Savings/CDs Interest\",\n      category: \"investments\",\n      startupCost: \"medium\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"1000.00\",\n      effortLevel: \"very_low\",\n      timeToProfit: \"immediate\",\n      scalability: \"medium\",\n      description: \"Park emergency fund in 4-5% high-yield savings accounts or CDs. $25k at 5% = $1,250/year. Completely passive and FDIC insured.\",\n      requiredSkills: [\"None - just open account\"],\n      platforms: [\"Marcus\", \"Ally Bank\", \"American Express Savings\", \"CIT Bank\"],\n      pros: [\"Zero risk (FDIC insured)\", \"Zero effort\", \"Instant liquidity\", \"Predictable returns\", \"No fees\"],\n      cons: [\"Requires significant capital\", \"Returns barely beat inflation\", \"Not wealth-building\", \"Rate can change\"],\n      bestFor: [\"Emergency funds\", \"Risk-averse savers\", \"Short-term parking\", \"Capital preservation\"],\n    },\n    {\n      name: \"Stock Photography/Video\",\n      category: \"digital_products\",\n      startupCost: \"low\",\n      monthlyEarningsMin: \"50.00\",\n      monthlyEarningsMax: \"1000.00\",\n      effortLevel: \"medium\",\n      timeToProfit: \"3_6_months\",\n      scalability: \"high\",\n      description: \"Upload photos/videos to stock sites. Earn royalties every time someone downloads. One photo can sell hundreds of times over years.\",\n      requiredSkills: [\"Photography/videography\", \"Editing\", \"Understanding market demand\"],\n      platforms: [\"Shutterstock\", \"Adobe Stock\", \"iStock\", \"Getty Images\", \"Pond5 (video)\"],\n      pros: [\"One asset sells infinitely\", \"Fully passive after upload\", \"Global marketplace\", \"Compound portfolio value\", \"Low startup cost\"],\n      cons: [\"Extremely low per-sale royalty ($0.25-$5)\", \"Highly competitive\", \"Need large portfolio (500+)\", \"Trends change\", \"Time to build portfolio\"],\n      bestFor: [\"Photographers\", \"Videographers\", \"Travelers\", \"Drone operators\"],\n    },\n    {\n      name: \"License Music/Beats (Royalty Income)\",\n      category: \"digital_products\",\n      startupCost: \"low\",\n      monthlyEarningsMin: \"100.00\",\n      monthlyEarningsMax: \"2000.00\",\n      effortLevel: \"high\",\n      timeToProfit: \"3_6_months\",\n      scalability: \"high\",\n      description: \"Create instrumental beats, background music, or sound effects. License to YouTubers, filmmakers, podcasters. Earn royalties per use.\",\n      requiredSkills: [\"Music production\", \"Audio engineering\", \"Genre knowledge\"],\n      platforms: [\"BeatStars\", \"Soundstripe\", \"AudioJungle\", \"Epidemic Sound\", \"Artlist\"],\n      pros: [\"One track earns indefinitely\", \"High demand (content creator boom)\", \"Multiple licensing models\", \"Portfolio compounds\", \"Creative work\"],\n      cons: [\"Competitive field\", \"Requires music production skills/equipment\", \"Building library takes time\", \"Income inconsistent initially\"],\n      bestFor: [\"Music producers\", \"Composers\", \"Beat makers\", \"Sound designers\"],\n    },\n    {\n      name: \"Automated Dropshipping Store\",\n      category: \"digital_products\",\n      startupCost: \"medium\",\n      monthlyEarningsMin: \"200.00\",\n      monthlyEarningsMax: \"5000.00\",\n      effortLevel: \"high\",\n      timeToProfit: \"3_6_months\",\n      scalability: \"very_high\",\n      description: \"Sell products online without holding inventory. Supplier ships directly to customer. Automate with tools. Can be 80% passive once optimized.\",\n      requiredSkills: [\"E-commerce\", \"Marketing\", \"Customer service\", \"Product research\"],\n      platforms: [\"Shopify + Oberlo\", \"AutoDS\", \"Spocket\", \"AliExpress\"],\n      pros: [\"No inventory costs\", \"Highly scalable\", \"Work from anywhere\", \"Automated fulfillment\", \"Multiple niches\"],\n      cons: [\"Thin profit margins (10-20%)\", \"Shipping delays\", \"Customer service issues\", \"High competition\", \"Ad costs\", \"Not truly passive\"],\n      bestFor: [\"Entrepreneurs\", \"Marketers\", \"E-commerce enthusiasts\", \"Risk-tolerant hustlers\"],\n    },\n    {\n      name: \"App/Software SaaS Subscriptions\",\n      category: \"digital_products\",\n      startupCost: \"high\",\n      monthlyEarningsMin: \"500.00\",\n      monthlyEarningsMax: \"10000.00\",\n      effortLevel: \"very_high\",\n      timeToProfit: \"12_plus_months\",\n      scalability: \"very_high\",\n      description: \"Build a software product once, collect recurring monthly subscriptions forever. Holy grail of passive income but requires technical skills.\",\n      requiredSkills: [\"Programming\", \"Product design\", \"Marketing\", \"Customer support\"],\n      platforms: [\"Web app (self-hosted)\", \"Mobile app stores\", \"Chrome extensions\"],\n      pros: [\"Recurring revenue (MRR)\", \"Infinitely scalable\", \"High profit margins\", \"Valuable asset (acquisition potential)\", \"True passive potential\"],\n      cons: [\"Requires significant development time\", \"Technical expertise required\", \"Ongoing maintenance\", \"Competitive market\", \"Slow initial growth\"],\n      bestFor: [\"Developers\", \"Product builders\", \"SaaS entrepreneurs\", \"Technical founders\"],\n    },\n  ];\n\n  await db.insert(passiveIncomeOpportunities).values(passiveIncomes);\n  console.log(`Seeded ${passiveIncomes.length} passive income opportunities`);\n\n  console.log(\"Investment seeding complete\");\n}\n","path":null,"size_bytes":27054,"size_tokens":null},"server/financialCalculations.ts":{"content":"// Financial Calculation Utilities\n// Real formulas for compound interest, monthly payments, and investment returns\n\n/**\n * Calculate Future Value with compound interest\n * FV = PV * (1 + r)^n + PMT * [((1 + r)^n - 1) / r]\n * @param principal - Initial investment amount\n * @param monthlyContribution - Monthly payment/contribution\n * @param annualRate - Annual interest rate (e.g., 0.08 for 8%)\n * @param years - Number of years\n * @returns Future value\n */\nexport function calculateFutureValue(\n  principal: number,\n  monthlyContribution: number,\n  annualRate: number,\n  years: number\n): number {\n  const monthlyRate = annualRate / 12;\n  const months = years * 12;\n  \n  // FV of principal\n  const pvFuture = principal * Math.pow(1 + monthlyRate, months);\n  \n  // FV of monthly contributions\n  const pmtFuture = monthlyContribution * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);\n  \n  return pvFuture + pmtFuture;\n}\n\n/**\n * Calculate required monthly payment to reach a goal\n * PMT = FV * [r / ((1 + r)^n - 1)]\n * @param futureValue - Target amount\n * @param principal - Initial amount already saved\n * @param annualRate - Annual interest rate\n * @param years - Number of years\n * @returns Required monthly payment\n */\nexport function calculateMonthlyPayment(\n  futureValue: number,\n  principal: number,\n  annualRate: number,\n  years: number\n): number {\n  const monthlyRate = annualRate / 12;\n  const months = years * 12;\n  \n  // Adjust for initial principal\n  const futureValueNeeded = futureValue - (principal * Math.pow(1 + monthlyRate, months));\n  \n  if (futureValueNeeded <= 0) return 0;\n  \n  // Calculate PMT\n  const pmt = futureValueNeeded * (monthlyRate / (Math.pow(1 + monthlyRate, months) - 1));\n  \n  return pmt;\n}\n\n/**\n * Calculate investment scenarios with different risk levels\n */\nexport interface InvestmentPlan {\n  name: string;\n  riskLevel: 'Low' | 'Medium' | 'High';\n  annualReturn: number;\n  monthlyPayment: number;\n  futureValue: number;\n  totalContributed: number;\n  totalGains: number;\n  description: string;\n  recommendations: string[];\n}\n\nexport function calculateInvestmentPlans(\n  targetAmount: number,\n  currentSavings: number,\n  monthlyIncome: number,\n  monthlyExpenses: number,\n  years: number\n): {\n  conservative: InvestmentPlan;\n  balanced: InvestmentPlan;\n  aggressive: InvestmentPlan;\n  maxMonthlyCapacity: number;\n} {\n  const maxMonthlyCapacity = Math.max(0, monthlyIncome - monthlyExpenses);\n  \n  // Conservative: High-yield savings (4-5%)\n  const conservativeRate = 0.045;\n  const conservativePmt = calculateMonthlyPayment(targetAmount, currentSavings, conservativeRate, years);\n  const conservativeFv = calculateFutureValue(currentSavings, conservativePmt, conservativeRate, years);\n  const conservativeContributed = currentSavings + (conservativePmt * years * 12);\n  \n  // Balanced: Index funds (7-8%)\n  const balancedRate = 0.075;\n  const balancedPmt = calculateMonthlyPayment(targetAmount, currentSavings, balancedRate, years);\n  const balancedFv = calculateFutureValue(currentSavings, balancedPmt, balancedRate, years);\n  const balancedContributed = currentSavings + (balancedPmt * years * 12);\n  \n  // Aggressive: Growth stocks/diversified portfolio (10-12%)\n  const aggressiveRate = 0.11;\n  const aggressivePmt = calculateMonthlyPayment(targetAmount, currentSavings, aggressiveRate, years);\n  const aggressiveFv = calculateFutureValue(currentSavings, aggressivePmt, aggressiveRate, years);\n  const aggressiveContributed = currentSavings + (aggressivePmt * years * 12);\n  \n  return {\n    maxMonthlyCapacity,\n    conservative: {\n      name: 'Conservative Plan',\n      riskLevel: 'Low',\n      annualReturn: conservativeRate,\n      monthlyPayment: conservativePmt,\n      futureValue: conservativeFv,\n      totalContributed: conservativeContributed,\n      totalGains: conservativeFv - conservativeContributed,\n      description: 'High-yield savings accounts, CDs, bonds',\n      recommendations: ['Marcus by Goldman Sachs (4.5% APY)', 'Treasury bonds', 'Certificate of Deposit (CD)']\n    },\n    balanced: {\n      name: 'Balanced Plan',\n      riskLevel: 'Medium',\n      annualReturn: balancedRate,\n      monthlyPayment: balancedPmt,\n      futureValue: balancedFv,\n      totalContributed: balancedContributed,\n      totalGains: balancedFv - balancedContributed,\n      description: 'Index funds, diversified ETFs, balanced portfolio',\n      recommendations: ['Vanguard S&P 500 (VOO)', 'Total Stock Market (VTI)', 'Target-Date Funds']\n    },\n    aggressive: {\n      name: 'Aggressive Plan',\n      riskLevel: 'High',\n      annualReturn: aggressiveRate,\n      monthlyPayment: aggressivePmt,\n      futureValue: aggressiveFv,\n      totalContributed: aggressiveContributed,\n      totalGains: aggressiveFv - aggressiveContributed,\n      description: 'Growth stocks, tech sector, higher risk higher reward',\n      recommendations: ['QQQ (Tech-heavy)', 'Individual growth stocks', 'Emerging markets ETF']\n    }\n  };\n}\n\n/**\n * Calculate realistic timeline based on monthly capacity\n */\nexport function calculateRealisticTimeline(\n  targetAmount: number,\n  currentSavings: number,\n  maxMonthlyCapacity: number,\n  utilizationRate: number = 0.7 // Use 70% of capacity for safety\n): {\n  yearsNeeded: number;\n  monthlyContribution: number;\n  annualReturn: number;\n  isRealistic: boolean;\n} {\n  const safeMonthlyAmount = maxMonthlyCapacity * utilizationRate;\n  \n  // Try with balanced returns (7.5%)\n  const balancedRate = 0.075;\n  \n  // Calculate years needed with this monthly amount\n  const monthlyRate = balancedRate / 12;\n  const futureValueFromPrincipal = currentSavings;\n  const remainingNeeded = targetAmount - futureValueFromPrincipal;\n  \n  if (safeMonthlyAmount <= 0) {\n    // Can't save anything\n    return {\n      yearsNeeded: Infinity,\n      monthlyContribution: 0,\n      annualReturn: balancedRate,\n      isRealistic: false\n    };\n  }\n  \n  // Solve for n: FV = PMT * [((1 + r)^n - 1) / r] + PV * (1 + r)^n\n  // This is complex, so we'll use iterative approach\n  let years = 1;\n  while (years <= 100) {\n    const fv = calculateFutureValue(currentSavings, safeMonthlyAmount, balancedRate, years);\n    if (fv >= targetAmount) {\n      return {\n        yearsNeeded: years,\n        monthlyContribution: safeMonthlyAmount,\n        annualReturn: balancedRate,\n        isRealistic: years <= 30 // Realistic if <= 30 years\n      };\n    }\n    years++;\n  }\n  \n  return {\n    yearsNeeded: years,\n    monthlyContribution: safeMonthlyAmount,\n    annualReturn: balancedRate,\n    isRealistic: false\n  };\n}\n\n/**\n * Detect language from message text\n */\nexport function detectLanguage(message: string): string {\n  const text = message.toLowerCase();\n  \n  // Thai detection - check for Thai script\n  const thaiPattern = /[\\u0E00-\\u0E7F]/;\n  if (thaiPattern.test(message)) {\n    return 'th';\n  }\n  \n  // Spanish detection - common Spanish words\n  const spanishWords = ['hola', 'gracias', 'por favor', 'dinero', 'casa', 'coche', 'quiero', 'necesito', 'tengo', 'cuánto', 'precio'];\n  if (spanishWords.some(word => text.includes(word))) {\n    return 'es';\n  }\n  \n  // Portuguese detection\n  const portugueseWords = ['olá', 'obrigado', 'dinheiro', 'quanto', 'preciso', 'quero', 'casa', 'carro'];\n  if (portugueseWords.some(word => text.includes(word))) {\n    return 'pt';\n  }\n  \n  // Indonesian detection\n  const indonesianWords = ['halo', 'terima kasih', 'uang', 'rumah', 'mobil', 'berapa', 'saya', 'ingin'];\n  if (indonesianWords.some(word => text.includes(word))) {\n    return 'id';\n  }\n  \n  // Japanese detection - check for Japanese scripts\n  const japanesePattern = /[\\u3040-\\u309F\\u30A0-\\u30FF\\u4E00-\\u9FAF]/;\n  if (japanesePattern.test(message)) {\n    return 'ja';\n  }\n  \n  // Chinese detection\n  const chinesePattern = /[\\u4E00-\\u9FFF]/;\n  if (chinesePattern.test(message)) {\n    return 'zh';\n  }\n  \n  // Korean detection\n  const koreanPattern = /[\\uAC00-\\uD7AF]/;\n  if (koreanPattern.test(message)) {\n    return 'ko';\n  }\n  \n  // Vietnamese detection\n  const vietnameseWords = ['xin chào', 'cảm ơn', 'tiền', 'nhà', 'xe', 'bao nhiêu', 'tôi', 'muốn'];\n  if (vietnameseWords.some(word => text.includes(word))) {\n    return 'vi';\n  }\n  \n  // Hindi detection - check for Devanagari script\n  const hindiPattern = /[\\u0900-\\u097F]/;\n  if (hindiPattern.test(message)) {\n    return 'hi';\n  }\n  \n  // Arabic detection\n  const arabicPattern = /[\\u0600-\\u06FF]/;\n  if (arabicPattern.test(message)) {\n    return 'ar';\n  }\n  \n  // Turkish detection\n  const turkishWords = ['merhaba', 'teşekkür', 'para', 'ev', 'araba', 'ne kadar', 'istiyorum'];\n  if (turkishWords.some(word => text.includes(word))) {\n    return 'tr';\n  }\n  \n  // Default to English\n  return 'en';\n}\n\n/**\n * Check if a financial goal is mathematically feasible\n * Used for pre-AI validation to prevent impossible advice\n */\nexport interface GoalFeasibilityCheck {\n  isFeasible: boolean;\n  monthlyNeeded: number;\n  monthlyCapacity: number;\n  shortfall: number;\n  multiplier: number; // How many times over capacity (e.g., 13x)\n  realisticYears: number;\n  reason?: string;\n}\n\nexport function checkGoalFeasibility(\n  goalAmount: number,\n  timeframeYears: number,\n  monthlyIncome: number,\n  monthlyExpenses: number,\n  currentSavings: number = 0\n): GoalFeasibilityCheck {\n  const monthlyCapacity = Math.max(0, monthlyIncome - monthlyExpenses);\n  const months = timeframeYears * 12;\n  \n  // Simple calculation: what they need to save per month (without compound interest)\n  const amountNeeded = goalAmount - currentSavings;\n  const simpleMonthlyNeeded = amountNeeded / months;\n  \n  // Check if it's impossible\n  const isFeasible = simpleMonthlyNeeded <= monthlyCapacity;\n  const shortfall = Math.max(0, simpleMonthlyNeeded - monthlyCapacity);\n  const multiplier = monthlyCapacity > 0 ? simpleMonthlyNeeded / monthlyCapacity : Infinity;\n  \n  // Calculate realistic timeline with 70% of capacity @ 7.5% returns\n  const realistic = calculateRealisticTimeline(goalAmount, currentSavings, monthlyCapacity, 0.7);\n  \n  return {\n    isFeasible,\n    monthlyNeeded: simpleMonthlyNeeded,\n    monthlyCapacity,\n    shortfall,\n    multiplier,\n    realisticYears: realistic.yearsNeeded,\n    reason: !isFeasible \n      ? `Requires $${Math.round(simpleMonthlyNeeded).toLocaleString()}/month but capacity is only $${Math.round(monthlyCapacity).toLocaleString()}/month (${multiplier.toFixed(1)}x over capacity)`\n      : undefined\n  };\n}\n","path":null,"size_bytes":10408,"size_tokens":null},"client/src/components/chat/message-bubble.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Copy, \n  ThumbsUp, \n  ThumbsDown, \n  RefreshCw,\n  Check,\n  Sparkles,\n  ArrowRight,\n  AlertTriangle,\n  TrendingUp,\n  Trophy,\n  Lightbulb,\n  Calculator,\n  Target\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Brain, User } from \"lucide-react\";\nimport ReactMarkdown from 'react-markdown';\nimport remarkGfm from 'remark-gfm';\n\ninterface MessageBubbleProps {\n  role: 'user' | 'assistant';\n  content: string;\n  timestamp?: string;\n  onRegenerate?: () => void;\n  isLatest?: boolean;\n  isRegenerating?: boolean;\n  onFollowUp?: (prompt: string) => void;\n  isStreaming?: boolean;\n}\n\nexport type { MessageBubbleProps };\n\ninterface ParsedInsight {\n  type: 'warning' | 'opportunity' | 'milestone';\n  title: string;\n  message: string;\n}\n\ninterface ParsedCalculation {\n  title: string;\n  items: Array<{ label: string; value: string; highlight?: boolean }>;\n  result?: { label: string; value: string };\n}\n\ninterface ParsedProgress {\n  title: string;\n  current: number;\n  target: number;\n  unit?: string;\n}\n\ninterface ParsedContent {\n  mainContent: string;\n  insight?: ParsedInsight;\n  calculations: ParsedCalculation[];\n  progressBars: ParsedProgress[];\n  suggestions: string[];\n}\n\nconst parseAIResponse = (content: string): ParsedContent => {\n  let mainContent = content;\n  let insight: ParsedInsight | undefined;\n  const suggestions: string[] = [];\n  const calculations: ParsedCalculation[] = [];\n  const progressBars: ParsedProgress[] = [];\n  \n  // Extract insight section\n  const insightMatch = content.match(/---INSIGHT---\\s*\\n?([\\s\\S]*?)(?=---SUGGESTIONS---|---CALCULATION---|---PROGRESS---|$)/i);\n  if (insightMatch) {\n    const insightBlock = insightMatch[1].trim();\n    const typeMatch = insightBlock.match(/type:\\s*(warning|opportunity|milestone)/i);\n    const titleMatch = insightBlock.match(/title:\\s*(.+?)(?:\\n|$)/i);\n    const messageMatch = insightBlock.match(/message:\\s*([\\s\\S]+?)(?=\\n\\n|$)/i);\n    \n    if (typeMatch && titleMatch && messageMatch) {\n      insight = {\n        type: typeMatch[1].toLowerCase() as 'warning' | 'opportunity' | 'milestone',\n        title: titleMatch[1].trim(),\n        message: messageMatch[1].trim()\n      };\n    }\n  }\n  \n  // Extract calculation sections (can have multiple)\n  const calcMatches = Array.from(content.matchAll(/---CALCULATION---\\s*\\n?([\\s\\S]*?)(?=---CALCULATION---|---SUGGESTIONS---|---PROGRESS---|---INSIGHT---|$)/gi));\n  for (const match of calcMatches) {\n    const calcBlock = match[1].trim();\n    const titleMatch = calcBlock.match(/title:\\s*(.+?)(?:\\n|$)/i);\n    const itemsMatch = calcBlock.match(/items:\\s*([\\s\\S]*?)(?=result:|$)/i);\n    const resultMatch = calcBlock.match(/result:\\s*(.+?)\\s*=\\s*(.+?)(?:\\n|$)/i);\n    \n    if (titleMatch) {\n      const items: Array<{ label: string; value: string; highlight?: boolean }> = [];\n      if (itemsMatch) {\n        const itemLines = itemsMatch[1].trim().split('\\n');\n        itemLines.forEach((line: string) => {\n          const itemMatch = line.match(/[-*]?\\s*(.+?):\\s*(.+)/);\n          if (itemMatch) {\n            items.push({\n              label: itemMatch[1].trim(),\n              value: itemMatch[2].trim(),\n              highlight: line.includes('*') || line.includes('**')\n            });\n          }\n        });\n      }\n      \n      calculations.push({\n        title: titleMatch[1].trim(),\n        items,\n        result: resultMatch ? { label: resultMatch[1].trim(), value: resultMatch[2].trim() } : undefined\n      });\n    }\n  }\n  \n  // Extract progress bar sections\n  const progressMatches = Array.from(content.matchAll(/---PROGRESS---\\s*\\n?([\\s\\S]*?)(?=---PROGRESS---|---SUGGESTIONS---|---CALCULATION---|---INSIGHT---|$)/gi));\n  for (const match of progressMatches) {\n    const progBlock = match[1].trim();\n    const titleMatch = progBlock.match(/title:\\s*(.+?)(?:\\n|$)/i);\n    const currentMatch = progBlock.match(/current:\\s*(\\d+(?:\\.\\d+)?)/i);\n    const targetMatch = progBlock.match(/target:\\s*(\\d+(?:\\.\\d+)?)/i);\n    const unitMatch = progBlock.match(/unit:\\s*(.+?)(?:\\n|$)/i);\n    \n    if (titleMatch && currentMatch && targetMatch) {\n      progressBars.push({\n        title: titleMatch[1].trim(),\n        current: parseFloat(currentMatch[1]),\n        target: parseFloat(targetMatch[1]),\n        unit: unitMatch?.[1]?.trim()\n      });\n    }\n  }\n  \n  // Extract suggestions section\n  const suggestionsMatch = content.match(/---SUGGESTIONS---\\s*\\n?([\\s\\S]*?)$/i);\n  if (suggestionsMatch) {\n    const suggestionsBlock = suggestionsMatch[1].trim();\n    const lines = suggestionsBlock.split('\\n');\n    lines.forEach(line => {\n      const cleaned = line.replace(/^\\d+\\.\\s*/, '').replace(/^-\\s*/, '').trim();\n      if (cleaned && cleaned.length > 5 && cleaned.length < 100) {\n        suggestions.push(cleaned);\n      }\n    });\n  }\n  \n  // Remove all special sections from main content\n  mainContent = content\n    .replace(/---INSIGHT---[\\s\\S]*?(?=---SUGGESTIONS---|---CALCULATION---|---PROGRESS---|$)/gi, '')\n    .replace(/---CALCULATION---[\\s\\S]*?(?=---CALCULATION---|---SUGGESTIONS---|---PROGRESS---|---INSIGHT---|$)/gi, '')\n    .replace(/---PROGRESS---[\\s\\S]*?(?=---PROGRESS---|---SUGGESTIONS---|---CALCULATION---|---INSIGHT---|$)/gi, '')\n    .replace(/---SUGGESTIONS---[\\s\\S]*$/i, '')\n    .trim();\n  \n  // Fallback suggestions if none parsed\n  if (suggestions.length === 0) {\n    if (content.toLowerCase().includes('budget') || content.toLowerCase().includes('spending')) {\n      suggestions.push(\"Show my spending breakdown\", \"How can I reduce expenses?\");\n    } else if (content.toLowerCase().includes('save') || content.toLowerCase().includes('goal')) {\n      suggestions.push(\"Create a savings goal\", \"Best strategies for me\");\n    } else if (content.toLowerCase().includes('debt') || content.toLowerCase().includes('loan')) {\n      suggestions.push(\"Debt payoff strategies\", \"Should I pay debt or invest?\");\n    } else {\n      suggestions.push(\"Tell me more\", \"What should I do next?\");\n    }\n  }\n  \n  return {\n    mainContent,\n    insight,\n    calculations,\n    progressBars,\n    suggestions: suggestions.slice(0, 3)\n  };\n};\n\nconst CalculationBlock = ({ calculation }: { calculation: ParsedCalculation }) => {\n  return (\n    <motion.div\n      className=\"my-4 p-4 rounded-xl bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 border border-slate-200/60 dark:border-slate-700/40 shadow-sm\"\n      initial={{ opacity: 0, y: 10, scale: 0.98 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      transition={{ duration: 0.3 }}\n    >\n      <div className=\"flex items-center gap-2 mb-3\">\n        <div className=\"p-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/50\">\n          <Calculator className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n        </div>\n        <h4 className=\"text-sm font-semibold text-foreground\">{calculation.title}</h4>\n      </div>\n      \n      <div className=\"space-y-2 mb-3\">\n        {calculation.items.map((item, idx) => (\n          <div \n            key={idx} \n            className={`flex justify-between items-center text-sm ${item.highlight ? 'font-medium text-foreground' : 'text-muted-foreground'}`}\n          >\n            <span>{item.label}</span>\n            <span className={item.highlight ? 'text-blue-600 dark:text-blue-400' : ''}>{item.value}</span>\n          </div>\n        ))}\n      </div>\n      \n      {calculation.result && (\n        <div className=\"pt-3 border-t border-slate-200 dark:border-slate-700\">\n          <div className=\"flex justify-between items-center\">\n            <span className=\"text-sm font-semibold text-foreground\">{calculation.result.label}</span>\n            <span className=\"text-lg font-bold text-emerald-600 dark:text-emerald-400\">{calculation.result.value}</span>\n          </div>\n        </div>\n      )}\n    </motion.div>\n  );\n};\n\nconst ProgressBarBlock = ({ progress }: { progress: ParsedProgress }) => {\n  const percentage = Math.min(100, Math.max(0, (progress.current / progress.target) * 100));\n  const isComplete = percentage >= 100;\n  \n  return (\n    <motion.div\n      className=\"my-4 p-4 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 border border-blue-200/60 dark:border-blue-800/40 shadow-sm\"\n      initial={{ opacity: 0, y: 10, scale: 0.98 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      transition={{ duration: 0.3 }}\n    >\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <div className={`p-1.5 rounded-lg ${isComplete ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'bg-blue-100 dark:bg-blue-900/50'}`}>\n            <Target className={`w-4 h-4 ${isComplete ? 'text-emerald-600 dark:text-emerald-400' : 'text-blue-600 dark:text-blue-400'}`} />\n          </div>\n          <h4 className=\"text-sm font-semibold text-foreground\">{progress.title}</h4>\n        </div>\n        <span className={`text-sm font-bold ${isComplete ? 'text-emerald-600 dark:text-emerald-400' : 'text-blue-600 dark:text-blue-400'}`}>\n          {percentage.toFixed(0)}%\n        </span>\n      </div>\n      \n      <div className=\"relative\">\n        <Progress \n          value={percentage} \n          className={`h-3 ${isComplete ? '[&>div]:bg-emerald-500' : '[&>div]:bg-blue-500'}`}\n        />\n      </div>\n      \n      <div className=\"flex justify-between mt-2 text-xs text-muted-foreground\">\n        <span>{progress.unit ? `${progress.current.toLocaleString()} ${progress.unit}` : progress.current.toLocaleString()}</span>\n        <span>Target: {progress.unit ? `${progress.target.toLocaleString()} ${progress.unit}` : progress.target.toLocaleString()}</span>\n      </div>\n    </motion.div>\n  );\n};\n\nconst InsightCard = ({ insight }: { insight: ParsedInsight }) => {\n  const iconMap = {\n    warning: AlertTriangle,\n    opportunity: TrendingUp,\n    milestone: Trophy\n  };\n  const colorMap = {\n    warning: {\n      bg: 'bg-amber-50 dark:bg-amber-950/30',\n      border: 'border-amber-200 dark:border-amber-800',\n      icon: 'text-amber-600 dark:text-amber-400',\n      title: 'text-amber-800 dark:text-amber-200'\n    },\n    opportunity: {\n      bg: 'bg-emerald-50 dark:bg-emerald-950/30',\n      border: 'border-emerald-200 dark:border-emerald-800',\n      icon: 'text-emerald-600 dark:text-emerald-400',\n      title: 'text-emerald-800 dark:text-emerald-200'\n    },\n    milestone: {\n      bg: 'bg-blue-50 dark:bg-blue-950/30',\n      border: 'border-blue-200 dark:border-blue-800',\n      icon: 'text-blue-600 dark:text-blue-400',\n      title: 'text-blue-800 dark:text-blue-200'\n    }\n  };\n  \n  const Icon = iconMap[insight.type];\n  const colors = colorMap[insight.type];\n  \n  return (\n    <motion.div\n      className={`mt-4 p-4 rounded-xl border ${colors.bg} ${colors.border}`}\n      initial={{ opacity: 0, y: 10, scale: 0.98 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      transition={{ duration: 0.3, delay: 0.2 }}\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className={`p-2 rounded-lg ${colors.bg}`}>\n          <Icon className={`w-4 h-4 ${colors.icon}`} />\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <p className={`text-sm font-semibold ${colors.title}`}>{insight.title}</p>\n          <p className=\"text-sm text-muted-foreground mt-1\">{insight.message}</p>\n        </div>\n      </div>\n    </motion.div>\n  );\n};\n\nfunction StreamingText({ content, onComplete }: { content: string; onComplete?: () => void }) {\n  const [displayedContent, setDisplayedContent] = useState(\"\");\n  const [isComplete, setIsComplete] = useState(false);\n  const contentRef = useRef(content);\n  \n  useEffect(() => {\n    if (content !== contentRef.current) {\n      contentRef.current = content;\n      setDisplayedContent(\"\");\n      setIsComplete(false);\n    }\n  }, [content]);\n\n  useEffect(() => {\n    if (isComplete) return;\n    \n    const words = content.split(' ');\n    let currentIndex = 0;\n    \n    const interval = setInterval(() => {\n      if (currentIndex < words.length) {\n        setDisplayedContent(words.slice(0, currentIndex + 1).join(' '));\n        currentIndex++;\n      } else {\n        setIsComplete(true);\n        onComplete?.();\n        clearInterval(interval);\n      }\n    }, 25);\n    \n    return () => clearInterval(interval);\n  }, [content, isComplete, onComplete]);\n\n  return <>{displayedContent || content}</>;\n}\n\nconst EXACT_ERROR_MESSAGES = [\n  \"i'm having trouble processing your request. please try again in a moment.\",\n  \"i'm having trouble processing your request.\",\n  \"something went wrong while processing your request.\",\n  \"unable to process your request at this time.\",\n  \"service is temporarily unavailable.\",\n  \"an error occurred while generating a response.\"\n];\n\nconst isExactErrorMessage = (content: string): boolean => {\n  const trimmedContent = content.trim();\n  const lowerContent = trimmedContent.toLowerCase();\n  \n  // Must be a short message (backend errors are typically concise)\n  if (trimmedContent.length > 100) return false;\n  \n  // Must not contain markdown formatting (real AI responses have this)\n  if (/^#{1,3}\\s|^\\*\\*|^-\\s|^\\d+\\.\\s|\\n\\n/m.test(trimmedContent)) return false;\n  \n  // Must exactly match one of our known error messages\n  return EXACT_ERROR_MESSAGES.some(pattern => lowerContent === pattern);\n};\n\nexport function MessageBubble({ role, content, timestamp, onRegenerate, isLatest, isRegenerating, onFollowUp, isStreaming }: MessageBubbleProps) {\n  const { toast } = useToast();\n  const [copied, setCopied] = useState(false);\n  const [showActions, setShowActions] = useState(false);\n  const [feedbackGiven, setFeedbackGiven] = useState<'positive' | 'negative' | null>(null);\n  const [streamComplete, setStreamComplete] = useState(!isLatest);\n  const [isRetrying, setIsRetrying] = useState(false);\n  \n  // Detect if this is an exact error message (very specific backend error responses only)\n  const isError = role === 'assistant' && isExactErrorMessage(content);\n  \n  // Parse AI response to extract main content, insights, and suggestions\n  const parsedContent = role === 'assistant' ? parseAIResponse(content) : null;\n  \n  const handleRetry = () => {\n    setIsRetrying(true);\n    onRegenerate?.();\n    setTimeout(() => setIsRetrying(false), 2000);\n  };\n  \n  useEffect(() => {\n    if (isLatest && role === 'assistant') {\n      const timer = setTimeout(() => setShowActions(true), 800);\n      return () => clearTimeout(timer);\n    } else {\n      setShowActions(true);\n    }\n  }, [isLatest, role]);\n\n  const handleCopy = async () => {\n    await navigator.clipboard.writeText(parsedContent?.mainContent || content);\n    setCopied(true);\n    toast({\n      title: \"Copied to clipboard\",\n      description: \"Message copied successfully\",\n    });\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  const handleFeedback = (type: 'positive' | 'negative') => {\n    setFeedbackGiven(type);\n    toast({\n      title: type === 'positive' ? \"Thanks for the feedback\" : \"We'll do better\",\n      description: type === 'positive' ? \"Glad this was helpful\" : \"Your feedback helps us improve\",\n    });\n  };\n\n  const followUpSuggestions = isLatest && role === 'assistant' && parsedContent ? parsedContent.suggestions : [];\n\n  if (role === 'user') {\n    return (\n      <motion.div \n        className=\"flex justify-end gap-3 group\" \n        data-testid=\"message-user\"\n        initial={{ opacity: 0, y: 16, scale: 0.98 }}\n        animate={{ opacity: 1, y: 0, scale: 1 }}\n        transition={{ duration: 0.3, ease: [0.16, 1, 0.3, 1] }}\n      >\n        <div className=\"flex flex-col items-end max-w-[85%] sm:max-w-[75%]\">\n          <motion.div \n            className=\"relative bg-black dark:bg-white text-white dark:text-black rounded-2xl rounded-tr-sm px-4 py-3 shadow-lg shadow-black/5\"\n            whileHover={{ scale: 1.01 }}\n            transition={{ duration: 0.2 }}\n          >\n            <p className=\"text-sm whitespace-pre-wrap break-words leading-relaxed font-medium\">{content}</p>\n          </motion.div>\n          {timestamp && (\n            <motion.span \n              className=\"text-[10px] text-muted-foreground/60 mt-1.5 font-medium\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 0.2 }}\n            >\n              {new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n            </motion.span>\n          )}\n        </div>\n        <motion.div \n          className=\"w-9 h-9 rounded-full bg-black dark:bg-white flex items-center justify-center flex-shrink-0 shadow-lg shadow-black/10\"\n          initial={{ scale: 0.8, opacity: 0 }}\n          animate={{ scale: 1, opacity: 1 }}\n          transition={{ delay: 0.1, duration: 0.2 }}\n        >\n          <User className=\"w-4 h-4 text-white dark:text-black\" />\n        </motion.div>\n      </motion.div>\n    );\n  }\n\n  return (\n    <motion.div \n      className=\"flex gap-3 group\" \n      data-testid=\"message-assistant\"\n      initial={{ opacity: 0, y: 16 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, ease: [0.16, 1, 0.3, 1] }}\n    >\n      <motion.div \n        className=\"w-9 h-9 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/20\"\n        initial={{ scale: 0.8, opacity: 0 }}\n        animate={{ scale: 1, opacity: 1 }}\n        transition={{ delay: 0.1, duration: 0.2 }}\n      >\n        <Brain className=\"w-4 h-4 text-white\" />\n      </motion.div>\n      <div className=\"flex-1 min-w-0 space-y-3\">\n        <motion.div \n          className=\"relative bg-white dark:bg-zinc-900 rounded-2xl rounded-tl-sm px-5 py-4 border border-border/50 shadow-lg shadow-black/[0.03]\"\n          initial={{ scale: 0.98 }}\n          animate={{ scale: 1 }}\n          transition={{ delay: 0.1, duration: 0.2 }}\n        >\n          <div className=\"absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-50/50 to-transparent dark:from-blue-950/20 dark:to-transparent rounded-2xl rounded-tl-sm pointer-events-none\" />\n          <div className=\"relative text-sm leading-relaxed prose prose-sm dark:prose-invert max-w-none prose-p:my-2 prose-headings:mt-4 prose-headings:mb-2 prose-li:my-0.5\">\n            <ReactMarkdown\n              remarkPlugins={[remarkGfm]}\n              components={{\n                code({ node, inline, className, children, ...props }: any) {\n                  const match = /language-(\\w+)/.exec(className || '');\n                  return !inline ? (\n                    <div className=\"my-4 rounded-xl bg-zinc-950 overflow-hidden border border-zinc-800/50 shadow-lg\">\n                      <div className=\"flex items-center justify-between px-4 py-2.5 bg-zinc-900 border-b border-zinc-800/50\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"flex gap-1.5\">\n                            <div className=\"w-2.5 h-2.5 rounded-full bg-zinc-700\" />\n                            <div className=\"w-2.5 h-2.5 rounded-full bg-zinc-700\" />\n                            <div className=\"w-2.5 h-2.5 rounded-full bg-zinc-700\" />\n                          </div>\n                          <span className=\"text-xs text-zinc-500 font-medium ml-2\">{match?.[1] || 'code'}</span>\n                        </div>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"h-6 px-2.5 text-xs text-zinc-400 hover:text-white hover:bg-zinc-800\"\n                          onClick={() => {\n                            navigator.clipboard.writeText(String(children));\n                            toast({ title: \"Code copied\" });\n                          }}\n                        >\n                          <Copy className=\"w-3 h-3 mr-1.5\" />\n                          Copy\n                        </Button>\n                      </div>\n                      <div className=\"p-4 overflow-x-auto\">\n                        <code className=\"text-xs font-mono text-zinc-100 block whitespace-pre\" {...props}>\n                          {String(children).replace(/\\n$/, '')}\n                        </code>\n                      </div>\n                    </div>\n                  ) : (\n                    <code className=\"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-1.5 py-0.5 rounded-md text-xs font-mono font-medium\" {...props}>\n                      {children}\n                    </code>\n                  );\n                },\n                p({ children }) {\n                  return <p className=\"mb-3 last:mb-0 text-foreground/90 leading-relaxed\">{children}</p>;\n                },\n                ul({ children }) {\n                  return <ul className=\"list-none ml-0 mb-3 space-y-2\">{children}</ul>;\n                },\n                ol({ children }) {\n                  return <ol className=\"list-decimal list-outside ml-4 mb-3 space-y-2\">{children}</ol>;\n                },\n                li({ children }) {\n                  return (\n                    <li className=\"text-foreground/90 flex items-start gap-2\">\n                      <span className=\"w-1.5 h-1.5 rounded-full bg-blue-500 mt-2 flex-shrink-0\" />\n                      <span>{children}</span>\n                    </li>\n                  );\n                },\n                strong({ children }) {\n                  return <strong className=\"font-semibold text-foreground\">{children}</strong>;\n                },\n                em({ children }) {\n                  return <em className=\"italic text-foreground/80\">{children}</em>;\n                },\n                h1({ children }) {\n                  return <h1 className=\"text-lg font-bold text-foreground border-b border-border/30 pb-2 mb-3\">{children}</h1>;\n                },\n                h2({ children }) {\n                  return <h2 className=\"text-base font-semibold text-foreground\">{children}</h2>;\n                },\n                h3({ children }) {\n                  return <h3 className=\"text-sm font-semibold text-foreground\">{children}</h3>;\n                },\n                blockquote({ children }) {\n                  return (\n                    <blockquote className=\"border-l-4 border-blue-500 pl-4 my-4 py-2 bg-blue-50/50 dark:bg-blue-950/20 rounded-r-lg text-foreground/80\">\n                      {children}\n                    </blockquote>\n                  );\n                },\n                table({ children }) {\n                  return (\n                    <div className=\"my-4 overflow-x-auto rounded-xl border border-border/50 shadow-sm\">\n                      <table className=\"w-full text-sm\">{children}</table>\n                    </div>\n                  );\n                },\n                th({ children }) {\n                  return <th className=\"px-4 py-3 bg-muted/50 font-semibold text-left border-b text-xs uppercase tracking-wide\">{children}</th>;\n                },\n                td({ children }) {\n                  return <td className=\"px-4 py-3 border-b border-border/30\">{children}</td>;\n                },\n              }}\n            >\n              {parsedContent?.mainContent || content}\n            </ReactMarkdown>\n            {isStreaming && (\n              <motion.span\n                className=\"inline-block w-2 h-4 bg-blue-500 ml-0.5 -mb-0.5 rounded-sm\"\n                animate={{ opacity: [1, 0] }}\n                transition={{ duration: 0.5, repeat: Infinity, repeatType: \"reverse\" }}\n              />\n            )}\n          </div>\n          \n          {/* Calculation Blocks - displayed for financial calculations */}\n          {parsedContent?.calculations && parsedContent.calculations.length > 0 && (\n            <div className=\"space-y-2\">\n              {parsedContent.calculations.map((calc, idx) => (\n                <CalculationBlock key={idx} calculation={calc} />\n              ))}\n            </div>\n          )}\n          \n          {/* Progress Bars - displayed for goal/budget progress */}\n          {parsedContent?.progressBars && parsedContent.progressBars.length > 0 && (\n            <div className=\"space-y-2\">\n              {parsedContent.progressBars.map((prog, idx) => (\n                <ProgressBarBlock key={idx} progress={prog} />\n              ))}\n            </div>\n          )}\n          \n          {/* Insight Card - displayed when AI detects something important */}\n          {parsedContent?.insight && (\n            <InsightCard insight={parsedContent.insight} />\n          )}\n          \n          {/* Inline Retry Banner - for error messages only, doesn't hide content */}\n          {isError && onRegenerate && (\n            <motion.div \n              className=\"mt-3 p-3 rounded-lg bg-amber-50/80 dark:bg-amber-950/30 border border-amber-200/60 dark:border-amber-800/50\"\n              initial={{ opacity: 0, y: 8 }}\n              animate={{ opacity: 1, y: 0 }}\n            >\n              <div className=\"flex items-center justify-between gap-3 flex-wrap\">\n                <div className=\"flex items-center gap-2 text-sm text-amber-700 dark:text-amber-300\">\n                  <AlertTriangle className=\"w-4 h-4\" />\n                  <span>Having trouble? Try sending your request again.</span>\n                </div>\n                <Button\n                  onClick={handleRetry}\n                  disabled={isRetrying}\n                  size=\"sm\"\n                  className=\"bg-amber-600 hover:bg-amber-700 text-white shadow-sm h-8\"\n                  data-testid=\"button-retry-message\"\n                >\n                  {isRetrying ? (\n                    <>\n                      <motion.div\n                        className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full mr-1.5\"\n                        animate={{ rotate: 360 }}\n                        transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                      />\n                      Retrying...\n                    </>\n                  ) : (\n                    <>\n                      <RefreshCw className=\"w-3.5 h-3.5 mr-1.5\" />\n                      Try Again\n                    </>\n                  )}\n                </Button>\n              </div>\n            </motion.div>\n          )}\n        </motion.div>\n        \n        <AnimatePresence>\n          {followUpSuggestions.length > 0 && onFollowUp && showActions && (\n            <motion.div \n              className=\"flex flex-wrap gap-2\"\n              initial={{ opacity: 0, y: 8 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -8 }}\n              transition={{ duration: 0.3, delay: 0.3 }}\n            >\n              {followUpSuggestions.map((suggestion, idx) => (\n                <motion.div\n                  key={idx}\n                  initial={{ opacity: 0, scale: 0.9 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  transition={{ delay: 0.4 + idx * 0.1 }}\n                >\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-9 text-xs font-medium rounded-full border-border/60 hover:border-blue-500/50 hover:bg-blue-50 dark:hover:bg-blue-950/30 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200 group/btn shadow-sm\"\n                    onClick={() => onFollowUp(suggestion)}\n                    data-testid={`follow-up-${idx}`}\n                  >\n                    <Sparkles className=\"w-3.5 h-3.5 mr-2 text-blue-500 group-hover/btn:text-blue-600\" />\n                    {suggestion}\n                    <ArrowRight className=\"w-3 h-3 ml-2 opacity-0 -translate-x-1 group-hover/btn:opacity-100 group-hover/btn:translate-x-0 transition-all duration-200\" />\n                  </Button>\n                </motion.div>\n              ))}\n            </motion.div>\n          )}\n        </AnimatePresence>\n        \n        <motion.div \n          className=\"flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-300\"\n          initial={{ opacity: 0 }}\n          animate={{ opacity: showActions ? undefined : 0 }}\n        >\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={handleCopy}\n            className=\"h-8 w-8 p-0 rounded-full hover:bg-muted/80 transition-colors\"\n            data-testid=\"button-copy-message\"\n            aria-label={copied ? \"Copied to clipboard\" : \"Copy message\"}\n          >\n            {copied ? (\n              <Check className=\"w-3.5 h-3.5 text-green-500\" />\n            ) : (\n              <Copy className=\"w-3.5 h-3.5 text-muted-foreground\" />\n            )}\n          </Button>\n          \n          {isLatest && onRegenerate && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onRegenerate}\n              disabled={isRegenerating}\n              className=\"h-8 w-8 p-0 rounded-full hover:bg-muted/80 transition-colors\"\n              data-testid=\"button-regenerate-response\"\n              aria-label=\"Regenerate response\"\n            >\n              <RefreshCw className={`w-3.5 h-3.5 text-muted-foreground ${isRegenerating ? 'animate-spin' : ''}`} />\n            </Button>\n          )}\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleFeedback('positive')}\n            disabled={feedbackGiven !== null}\n            className={`h-8 w-8 p-0 rounded-full transition-colors ${feedbackGiven === 'positive' ? 'bg-green-100 dark:bg-green-900/30' : 'hover:bg-muted/80'}`}\n            data-testid=\"button-feedback-positive\"\n            aria-label=\"Mark as helpful\"\n          >\n            <ThumbsUp className={`w-3.5 h-3.5 ${feedbackGiven === 'positive' ? 'text-green-500' : 'text-muted-foreground hover:text-green-500'}`} />\n          </Button>\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleFeedback('negative')}\n            disabled={feedbackGiven !== null}\n            className={`h-8 w-8 p-0 rounded-full transition-colors ${feedbackGiven === 'negative' ? 'bg-red-100 dark:bg-red-900/30' : 'hover:bg-muted/80'}`}\n            data-testid=\"button-feedback-negative\"\n            aria-label=\"Mark as not helpful\"\n          >\n            <ThumbsDown className={`w-3.5 h-3.5 ${feedbackGiven === 'negative' ? 'text-red-500' : 'text-muted-foreground hover:text-red-500'}`} />\n          </Button>\n          \n          {timestamp && (\n            <span className=\"text-[10px] text-muted-foreground/60 ml-2 font-medium\">\n              {new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n            </span>\n          )}\n        </motion.div>\n      </div>\n    </motion.div>\n  );\n}\n\nconst analysisStages = [\n  { text: \"Analyzing your financial data...\", icon: \"📊\" },\n  { text: \"Reviewing market conditions...\", icon: \"📈\" },\n  { text: \"Calculating recommendations...\", icon: \"🧮\" },\n  { text: \"Preparing personalized advice...\", icon: \"✨\" }\n];\n\nexport function TypingIndicator({ isDeepAnalysis = false }: { isDeepAnalysis?: boolean }) {\n  const [stageIndex, setStageIndex] = useState(0);\n\n  useEffect(() => {\n    if (!isDeepAnalysis) return;\n    \n    const interval = setInterval(() => {\n      setStageIndex((prev) => (prev + 1) % analysisStages.length);\n    }, 2500);\n    \n    return () => clearInterval(interval);\n  }, [isDeepAnalysis]);\n\n  const currentStage = analysisStages[stageIndex];\n\n  return (\n    <motion.div \n      className=\"flex gap-3\" \n      data-testid=\"typing-indicator\"\n      initial={{ opacity: 0, y: 16 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.3, ease: [0.16, 1, 0.3, 1] }}\n    >\n      <motion.div \n        className=\"w-9 h-9 rounded-full bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/20\"\n        initial={{ scale: 0.8 }}\n        animate={{ scale: 1 }}\n        transition={{ duration: 0.2 }}\n      >\n        <Brain className=\"w-4 h-4 text-white\" />\n      </motion.div>\n      <motion.div \n        className=\"relative bg-white dark:bg-zinc-900 rounded-2xl rounded-tl-sm px-5 py-4 border border-border/50 shadow-lg shadow-black/[0.03] overflow-hidden\"\n        initial={{ scale: 0.95 }}\n        animate={{ scale: 1 }}\n        transition={{ duration: 0.2 }}\n      >\n        <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-blue-100/30 dark:via-blue-900/20 to-transparent animate-shimmer\" style={{ backgroundSize: '200% 100%' }} />\n        <div className=\"relative flex flex-col gap-2\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center gap-1.5\">\n              <motion.div \n                className=\"w-2 h-2 bg-blue-500 rounded-full\"\n                animate={{ \n                  scale: [1, 1.3, 1],\n                  opacity: [0.5, 1, 0.5]\n                }}\n                transition={{ duration: 1.2, repeat: Infinity, delay: 0 }}\n              />\n              <motion.div \n                className=\"w-2 h-2 bg-blue-500 rounded-full\"\n                animate={{ \n                  scale: [1, 1.3, 1],\n                  opacity: [0.5, 1, 0.5]\n                }}\n                transition={{ duration: 1.2, repeat: Infinity, delay: 0.2 }}\n              />\n              <motion.div \n                className=\"w-2 h-2 bg-blue-500 rounded-full\"\n                animate={{ \n                  scale: [1, 1.3, 1],\n                  opacity: [0.5, 1, 0.5]\n                }}\n                transition={{ duration: 1.2, repeat: Infinity, delay: 0.4 }}\n              />\n            </div>\n            <motion.span \n              className=\"text-xs text-muted-foreground font-medium\"\n              animate={{ opacity: [0.5, 1, 0.5] }}\n              transition={{ duration: 2, repeat: Infinity }}\n            >\n              {isDeepAnalysis ? \"Deep Analysis in progress...\" : \"Twealth is thinking...\"}\n            </motion.span>\n          </div>\n          \n          {isDeepAnalysis && (\n            <motion.div \n              className=\"flex items-center gap-2 text-xs text-blue-600 dark:text-blue-400\"\n              key={stageIndex}\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: 10 }}\n              transition={{ duration: 0.3 }}\n            >\n              <span>{currentStage.icon}</span>\n              <span className=\"font-medium\">{currentStage.text}</span>\n            </motion.div>\n          )}\n        </div>\n      </motion.div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":34766,"size_tokens":null},"client/src/components/chat/conversation-sidebar.tsx":{"content":"import { useState } from\"react\";\nimport { useQuery, useMutation } from\"@tanstack/react-query\";\nimport { useTranslation } from 'react-i18next';\nimport { Button } from\"@/components/ui/button\";\nimport { Input } from\"@/components/ui/input\";\nimport { ScrollArea } from\"@/components/ui/scroll-area\";\nimport {\n DropdownMenu,\n DropdownMenuContent,\n DropdownMenuItem,\n DropdownMenuTrigger,\n} from\"@/components/ui/dropdown-menu\";\nimport { \n Plus, \n MessageSquare, \n Search, \n MoreVertical, \n Trash2, \n Edit2,\n Menu,\n X\n} from\"lucide-react\";\nimport { apiRequest, queryClient } from\"@/lib/queryClient\";\nimport { useToast } from\"@/hooks/use-toast\";\nimport { formatDistanceToNow } from\"date-fns\";\n\ninterface ChatConversation {\n id: string;\n userId: string;\n title: string;\n isActive: boolean;\n lastMessageAt: string;\n createdAt: string;\n}\n\ninterface ConversationSidebarProps {\n currentConversationId: string | null;\n onSelectConversation: (id: string) => void;\n onNewChat: () => void;\n isOpen: boolean;\n onToggle: () => void;\n}\n\nexport function ConversationSidebar({ \n currentConversationId, \n onSelectConversation, \n onNewChat,\n isOpen,\n onToggle \n}: ConversationSidebarProps) {\n const { t } = useTranslation();\n const { toast } = useToast();\n const [searchQuery, setSearchQuery] = useState(\"\");\n const [editingId, setEditingId] = useState<string | null>(null);\n const [editTitle, setEditTitle] = useState(\"\");\n\n // Fetch conversations\n const { data: conversations = [] } = useQuery<ChatConversation[]>({\n  queryKey: [\"/api/chat/conversations\"],\n  refetchInterval: 2 * 60 * 1000, // Refetch every 2 minutes\n });\n\n // Delete conversation mutation\n const deleteConversationMutation = useMutation({\n  mutationFn: async (id: string) => {\n   await apiRequest(\"DELETE\", `/api/chat/conversations/${id}`);\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n   if (currentConversationId === editingId) {\n    onNewChat();\n   }\n   toast({\n    title:\"Conversation deleted\",\n    description:\"The conversation has been removed.\",\n   });\n  },\n });\n\n // Update conversation title mutation\n const updateTitleMutation = useMutation({\n  mutationFn: async ({ id, title }: { id: string; title: string }) => {\n   await apiRequest(\"PATCH\", `/api/chat/conversations/${id}`, { title });\n  },\n  onSuccess: () => {\n   queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\"] });\n   setEditingId(null);\n   toast({\n    title:\"Conversation renamed\",\n    description:\"The conversation title has been updated.\",\n   });\n  },\n });\n\n const handleRename = (conversation: ChatConversation) => {\n  setEditingId(conversation.id);\n  setEditTitle(conversation.title);\n };\n\n const saveRename = (id: string) => {\n  if (editTitle.trim()) {\n   updateTitleMutation.mutate({ id, title: editTitle });\n  } else {\n   setEditingId(null);\n  }\n };\n\n const filteredConversations = conversations.filter((conv) =>\n  conv.title.toLowerCase().includes(searchQuery.toLowerCase())\n );\n\n // Sort by lastMessageAt, most recent first\n const sortedConversations = [...filteredConversations].sort(\n  (a, b) => new Date(b.lastMessageAt).getTime() - new Date(a.lastMessageAt).getTime()\n );\n\n return (\n  <>\n   {/* Mobile overlay */}\n   {isOpen && (\n    <div \n     className=\"fixed inset-0 bg-black/50 z-40 lg:hidden\"\n     onClick={onToggle}\n    />\n   )}\n\n   {/* Sidebar */}\n   <aside\n    className={`\n     fixed lg:sticky top-0 left-0 h-screen\n     w-[280px] bg-background border-r border-border\n     flex flex-col z-50\n     transform ease-in-out\n     ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}\n    `}\n   >\n    {/* Header */}\n    <div className=\"p-4 border-b border-border flex items-center justify-between\">\n     <h2 className=\"text-lg font-semibold\">Conversations</h2>\n     <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      className=\"lg:hidden\"\n      onClick={onToggle}\n      data-testid=\"button-close-sidebar\"\n     >\n      <X className=\"w-5 h-5\" />\n     </Button>\n    </div>\n\n    {/* New Chat Button */}\n    <div className=\"p-3\">\n     <Button\n      onClick={onNewChat}\n      className=\"w-full justify-start gap-2\"\n      variant=\"outline\"\n      data-testid=\"button-new-chat\"\n     >\n      <Plus className=\"w-4 h-4\" />\n      New Chat\n     </Button>\n    </div>\n\n    {/* Search */}\n    <div className=\"px-3 pb-3\">\n     <div className=\"relative\">\n      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n      <Input\n       placeholder=\"Search conversations...\"\n       value={searchQuery}\n       onChange={(e) => setSearchQuery(e.target.value)}\n       className=\"pl-9\"\n       data-testid=\"input-search-conversations\"\n      />\n     </div>\n    </div>\n\n    {/* Conversations List */}\n    <ScrollArea className=\"flex-1\">\n     <div className=\"px-2 space-y-1\">\n      {sortedConversations.length === 0 ? (\n       <div className=\"text-center py-8 text-sm text-muted-foreground\">\n        No conversations yet\n       </div>\n      ) : (\n       sortedConversations.map((conversation) => (\n        <div\n         key={conversation.id}\n         className={`\n          group relative flex items-center gap-2 px-3 py-2.5 rounded-lg\n          cursor-pointer transition-all duration-200\n          ${currentConversationId === conversation.id \n            ? 'bg-blue-100 dark:bg-blue-950/50 border-l-2 border-blue-500 pl-[10px]' \n            : 'hover:bg-muted/50 border-l-2 border-transparent pl-[10px]'}\n         `}\n         onClick={() => onSelectConversation(conversation.id)}\n         data-testid={`conversation-item-${conversation.id}`}\n        >\n         <MessageSquare className={`w-4 h-4 flex-shrink-0 ${currentConversationId === conversation.id ? 'text-blue-600 dark:text-blue-400' : 'text-muted-foreground'}`} />\n         \n         {editingId === conversation.id ? (\n          <Input\n           value={editTitle}\n           onChange={(e) => setEditTitle(e.target.value)}\n           onBlur={() => saveRename(conversation.id)}\n           onKeyDown={(e) => {\n            if (e.key === 'Enter') saveRename(conversation.id);\n            if (e.key === 'Escape') setEditingId(null);\n           }}\n           className=\"h-6 text-sm\"\n           autoFocus\n           onClick={(e) => e.stopPropagation()}\n          />\n         ) : (\n          <div className=\"flex-1 min-w-0\">\n           <p className={`text-sm font-medium truncate ${currentConversationId === conversation.id ? 'text-blue-700 dark:text-blue-300' : ''}`}>\n            {conversation.title}\n           </p>\n           <p className={`text-xs ${currentConversationId === conversation.id ? 'text-blue-600/70 dark:text-blue-400/70' : 'text-muted-foreground'}`}>\n            {formatDistanceToNow(new Date(conversation.lastMessageAt), { addSuffix: true })}\n           </p>\n          </div>\n         )}\n\n         <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n           <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"w-6 h-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n            onClick={(e) => e.stopPropagation()}\n            data-testid={`button-conversation-menu-${conversation.id}`}\n           >\n            <MoreVertical className=\"w-4 h-4\" />\n           </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\">\n           <DropdownMenuItem onClick={() => handleRename(conversation)}>\n            <Edit2 className=\"w-4 h-4 mr-2\" />\n            Rename\n           </DropdownMenuItem>\n           <DropdownMenuItem\n            onClick={() => deleteConversationMutation.mutate(conversation.id)}\n            className=\"text-destructive\"\n           >\n            <Trash2 className=\"w-4 h-4 mr-2\" />\n            Delete\n           </DropdownMenuItem>\n          </DropdownMenuContent>\n         </DropdownMenu>\n        </div>\n       ))\n      )}\n     </div>\n    </ScrollArea>\n\n    {/* Footer - Usage Info */}\n    <div className=\"p-4 border-t border-border\">\n     <div className=\"text-xs text-muted-foreground\">\n      <div className=\"flex items-center justify-between mb-1\">\n       <span>AI Chats</span>\n       <span className=\"font-medium\">-/-</span>\n      </div>\n     </div>\n    </div>\n   </aside>\n\n   {/* Mobile Toggle Button - positioned above bottom nav with safe-area */}\n   <Button\n    variant=\"outline\"\n    size=\"icon\"\n    className=\"fixed left-4 lg:hidden z-[45] shadow-lg min-w-[48px] min-h-[48px]\"\n    style={{ bottom: 'calc(72px + env(safe-area-inset-bottom, 0px))' }}\n    onClick={onToggle}\n    data-testid=\"button-toggle-sidebar\"\n   >\n    <Menu className=\"w-5 h-5\" />\n   </Button>\n  </>\n );\n}\n","path":null,"size_bytes":8574,"size_tokens":null},"client/src/components/page-transition.tsx":{"content":"import { motion } from\"framer-motion\";\nimport { ReactNode } from\"react\";\n\ninterface PageTransitionProps {\n children: ReactNode;\n}\n\nexport function PageTransition({ children }: PageTransitionProps) {\n return (\n  <motion.div\n   initial={{ opacity: 0, y: 10 }}\n   animate={{ opacity: 1, y: 0 }}\n   exit={{ opacity: 0, y: -10 }}\n   transition={{\n    duration: 0.3,\n    ease: [0.4, 0, 0.2, 1]\n   }}\n   className=\"h-full w-full\"\n  >\n   {children}\n  </motion.div>\n );\n}\n","path":null,"size_bytes":463,"size_tokens":null},"client/src/components/ui/error-state.tsx":{"content":"import { AlertCircle, RefreshCw } from\"lucide-react\";\nimport { Button } from\"./button\";\n\ninterface ErrorStateProps {\n message?: string;\n onRetry?: () => void;\n compact?: boolean;\n}\n\nexport function ErrorState({ \n message =\"Something went wrong\", \n onRetry,\n compact = false \n}: ErrorStateProps) {\n if (compact) {\n  return (\n   <div className=\"flex items-center justify-center py-4 px-3 rounded-lg border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-950/20\">\n    <div className=\"flex items-center gap-3 text-sm\">\n     <AlertCircle className=\"w-4 h-4 text-red-600 flex-shrink-0\" />\n     <span className=\"text-red-700 dark:text-red-400\">{message}</span>\n     {onRetry && (\n      <Button\n       variant=\"ghost\"\n       size=\"sm\"\n       onClick={onRetry}\n       className=\"h-7 px-2 text-red-700 hover:text-red-800 hover:bg-red-100 dark:hover:bg-red-900/30\"\n      >\n       <RefreshCw className=\"w-3 h-3\" />\n      </Button>\n     )}\n    </div>\n   </div>\n  );\n }\n\n return (\n  <div className=\"flex flex-col items-center justify-center py-12 space-y-4\">\n   <div className=\"w-16 h-16 bg-white dark:bg-gray-900 rounded-full flex items-center justify-center\">\n    <AlertCircle className=\"w-8 h-8 text-red-600\" />\n   </div>\n   <div className=\"text-center space-y-2\">\n    <h3 className=\"text-lg font-semibold text-foreground\">Oops!</h3>\n    <p className=\"text-sm text-muted-foreground max-w-md mx-auto\">\n     {message}\n    </p>\n   </div>\n   {onRetry && (\n    <Button \n     onClick={onRetry}\n     variant=\"outline\"\n     className=\"shadow-sm hover:shadow-md transition-all\"\n    >\n     <RefreshCw className=\"w-4 h-4 mr-2\" />\n     Try Again\n    </Button>\n   )}\n  </div>\n );\n}\n","path":null,"size_bytes":1667,"size_tokens":null},"server/categorizationService.ts":{"content":"/**\n * Smart Transaction Categorization Service\n * Automatically detects spending categories from merchant names and descriptions\n */\n\nexport interface CategoryMatch {\n  category: string;\n  confidence: 'high' | 'medium' | 'low';\n  matchedKeyword: string;\n}\n\n// Comprehensive merchant keyword database\nconst CATEGORY_KEYWORDS: Record<string, string[]> = {\n  // Food & Dining\n  'Dining': [\n    'restaurant', 'cafe', 'coffee', 'starbucks', 'dunkin', 'mcdonald', 'burger', 'pizza', 'subway',\n    'chipotle', 'kfc', 'taco bell', 'wendy', 'chick-fil-a', 'panera', 'domino', 'papa john',\n    'diner', 'bistro', 'grill', 'kitchen', 'eatery', 'bar & grill', 'steakhouse', 'sushi',\n    'thai', 'chinese', 'italian', 'mexican', 'food delivery', 'uber eats', 'doordash', 'grubhub',\n    'postmates', 'seamless', 'deliveroo', 'foodpanda', 'grab food', 'dining', 'meal'\n  ],\n  \n  // Groceries\n  'Groceries': [\n    'walmart', 'target', 'costco', 'safeway', 'kroger', 'whole foods', 'trader joe',\n    'aldi', 'publix', 'sprouts', 'food lion', 'stop & shop', 'giant', 'albertsons',\n    'grocery', 'supermarket', 'market', 'mart', 'fresh', 'organic', 'produce',\n    'wegmans', 'harris teeter', 'smiths', 'ralphs', 'vons', 'pavilions', 'carrefour',\n    'tesco', 'sainsbury', 'asda', 'lidl', 'mercadona', 'lotus', 'big c'\n  ],\n  \n  // Transportation\n  'Transportation': [\n    'shell', 'chevron', 'exxon', 'bp', 'mobil', 'texaco', 'arco', 'valero', 'citgo',\n    'gas station', 'fuel', 'petrol', 'uber', 'lyft', 'taxi', 'cab', 'transit',\n    'metro', 'subway', 'bus', 'train', 'parking', 'toll', 'car wash', 'car repair',\n    'auto', 'mechanic', 'tire', 'oil change', 'smog check', 'dmv', 'registration',\n    'grab', 'gojek', 'ola', 'didi', 'bolt', 'via', 'public transport', 'mrt', 'lrt'\n  ],\n  \n  // Shopping\n  'Shopping': [\n    'amazon', 'ebay', 'etsy', 'walmart.com', 'target.com', 'bestbuy', 'apple store',\n    'nike', 'adidas', 'h&m', 'zara', 'gap', 'old navy', 'forever 21', 'uniqlo',\n    'nordstrom', 'macy', 'kohl', 'jcpenney', 'dillard', 'sephora', 'ulta',\n    'home depot', 'lowe', 'ikea', 'wayfair', 'overstock', 'bed bath', 'container store',\n    'aliexpress', 'shopee', 'lazada', 'tokopedia', 'bukalapak', 'mercado libre',\n    'clothing', 'apparel', 'fashion', 'shoes', 'accessories', 'jewelry', 'cosmetics'\n  ],\n  \n  // Entertainment\n  'Entertainment': [\n    'netflix', 'hulu', 'disney+', 'hbo', 'amazon prime', 'spotify', 'apple music',\n    'youtube', 'twitch', 'playstation', 'xbox', 'nintendo', 'steam', 'epic games',\n    'cinema', 'theater', 'movie', 'amc', 'regal', 'concert', 'ticket', 'event',\n    'spotify', 'pandora', 'tidal', 'soundcloud', 'audible', 'kindle', 'books',\n    'paramount+', 'peacock', 'max', 'showtime', 'starz', 'funimation', 'crunchyroll',\n    'gaming', 'game', 'entertainment', 'streaming', 'subscription'\n  ],\n  \n  // Utilities\n  'Utilities': [\n    'electric', 'water', 'gas company', 'power', 'utility', 'sewage', 'garbage',\n    'waste management', 'pg&e', 'con edison', 'duke energy', 'southern company',\n    'internet', 'cable', 'phone', 'wireless', 'verizon', 'at&t', 't-mobile',\n    'comcast', 'spectrum', 'xfinity', 'cox', 'centurylink', 'frontier',\n    'broadband', 'wifi', 'mobile', 'cellular', 'landline', 'bill'\n  ],\n  \n  // Healthcare\n  'Healthcare': [\n    'pharmacy', 'cvs', 'walgreens', 'rite aid', 'drug', 'prescription', 'medicine',\n    'doctor', 'dentist', 'hospital', 'clinic', 'medical', 'health', 'urgent care',\n    'laboratory', 'radiology', 'therapy', 'counseling', 'psychiatrist', 'psychologist',\n    'optometry', 'vision', 'glasses', 'contact lens', 'hearing', 'physical therapy',\n    'chiropractor', 'acupuncture', 'massage', 'wellness', 'gym', 'fitness'\n  ],\n  \n  // Housing\n  'Rent': [\n    'rent', 'lease', 'landlord', 'property management', 'apartment', 'housing',\n    'mortgage', 'home loan', 'property tax', 'hoa', 'homeowner', 'condo fee'\n  ],\n  \n  // Insurance\n  'Insurance': [\n    'insurance', 'geico', 'state farm', 'allstate', 'progressive', 'liberty mutual',\n    'farmers', 'nationwide', 'usaa', 'aaa', 'metlife', 'prudential', 'aetna',\n    'blue cross', 'cigna', 'humana', 'kaiser', 'united health', 'health insurance',\n    'life insurance', 'auto insurance', 'home insurance', 'renters insurance'\n  ],\n  \n  // Education\n  'Education': [\n    'tuition', 'university', 'college', 'school', 'course', 'udemy', 'coursera',\n    'masterclass', 'skillshare', 'linkedin learning', 'pluralsight', 'datacamp',\n    'books', 'textbook', 'supplies', 'student', 'education', 'learning', 'training'\n  ],\n  \n  // Personal Care\n  'Personal Care': [\n    'salon', 'barber', 'haircut', 'spa', 'nail', 'beauty', 'cosmetic', 'makeup',\n    'skincare', 'fragrance', 'perfume', 'grooming', 'shave', 'wax', 'facial'\n  ],\n  \n  // Travel\n  'Travel': [\n    'airline', 'flight', 'hotel', 'airbnb', 'booking.com', 'expedia', 'hotels.com',\n    'marriott', 'hilton', 'hyatt', 'ihg', 'travel', 'vacation', 'trip', 'resort',\n    'hostel', 'motel', 'inn', 'rental car', 'hertz', 'enterprise', 'avis', 'budget',\n    'agoda', 'traveloka', 'tiket', 'pegipegi', 'cruise', 'airport'\n  ],\n  \n  // Subscriptions\n  'Subscriptions': [\n    'patreon', 'onlyfans', 'substack', 'medium', 'new york times', 'washington post',\n    'wall street journal', 'economist', 'financial times', 'bloomberg', 'membership',\n    'adobe', 'microsoft 365', 'office 365', 'dropbox', 'google one', 'icloud',\n    'cloud storage', 'software subscription', 'saas', 'monthly subscription'\n  ],\n  \n  // Pets\n  'Pets': [\n    'petco', 'petsmart', 'pet', 'veterinary', 'vet', 'animal', 'dog', 'cat',\n    'grooming', 'pet food', 'pet supplies', 'pet care', 'kennel', 'daycare'\n  ],\n  \n  // Charity\n  'Charity': [\n    'donation', 'charity', 'foundation', 'nonprofit', 'give', 'contribution',\n    'red cross', 'unicef', 'salvation army', 'goodwill', 'church', 'temple',\n    'mosque', 'synagogue', 'religious', 'tithe', 'offering', 'relief fund'\n  ],\n  \n  // Fees & Charges\n  'Fees': [\n    'fee', 'charge', 'service charge', 'atm', 'overdraft', 'late fee', 'penalty',\n    'interest', 'finance charge', 'transaction fee', 'processing fee', 'bank fee'\n  ],\n  \n  // Income categories\n  'Salary': [\n    'salary', 'payroll', 'paycheck', 'wage', 'direct deposit', 'employer',\n    'monthly pay', 'bi-weekly', 'weekly pay', 'compensation'\n  ],\n  \n  'Freelance': [\n    'freelance', 'contractor', 'consulting', 'gig', 'upwork', 'fiverr', 'freelancer',\n    'contract work', 'client payment', 'invoice payment', 'project payment'\n  ],\n  \n  'Investment': [\n    'dividend', 'capital gain', 'interest income', 'stock sale', 'crypto profit',\n    'rental income', 'investment return', 'profit', 'passive income'\n  ],\n  \n  'Refund': [\n    'refund', 'reimbursement', 'cashback', 'rebate', 'return', 'credit'\n  ],\n};\n\n/**\n * Automatically categorize a transaction based on description and merchant name\n */\nexport function autoCategorizeTransaction(description: string, amount: number, type: 'income' | 'expense' | 'transfer'): string {\n  if (!description || description.trim().length === 0) {\n    return 'Other';\n  }\n\n  const normalizedDesc = description.toLowerCase().trim();\n  \n  // For income transactions, check income categories first\n  if (type === 'income') {\n    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {\n      // Only check income-related categories for income transactions\n      if (['Salary', 'Freelance', 'Investment', 'Refund'].includes(category)) {\n        for (const keyword of keywords) {\n          if (normalizedDesc.includes(keyword.toLowerCase())) {\n            return category;\n          }\n        }\n      }\n    }\n    return 'Other Income';\n  }\n  \n  // For expenses, check all expense categories\n  if (type === 'expense') {\n    for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {\n      // Skip income categories\n      if (['Salary', 'Freelance', 'Investment', 'Refund'].includes(category)) {\n        continue;\n      }\n      \n      for (const keyword of keywords) {\n        if (normalizedDesc.includes(keyword.toLowerCase())) {\n          return category;\n        }\n      }\n    }\n  }\n  \n  return 'Other';\n}\n\n/**\n * Get category suggestions with confidence scores\n */\nexport function getCategorySuggestions(description: string, type: 'income' | 'expense' | 'transfer'): CategoryMatch[] {\n  if (!description || description.trim().length === 0) {\n    return [];\n  }\n\n  const normalizedDesc = description.toLowerCase().trim();\n  const matches: CategoryMatch[] = [];\n  \n  // Filter categories based on transaction type\n  const relevantCategories = Object.entries(CATEGORY_KEYWORDS).filter(([category]) => {\n    if (type === 'income') {\n      return ['Salary', 'Freelance', 'Investment', 'Refund'].includes(category);\n    } else if (type === 'expense') {\n      return !['Salary', 'Freelance', 'Investment', 'Refund'].includes(category);\n    }\n    return true;\n  });\n  \n  for (const [category, keywords] of relevantCategories) {\n    for (const keyword of keywords) {\n      const keywordLower = keyword.toLowerCase();\n      \n      // Exact word match = high confidence\n      const wordBoundary = new RegExp(`\\\\b${keywordLower}\\\\b`);\n      if (wordBoundary.test(normalizedDesc)) {\n        matches.push({ category, confidence: 'high', matchedKeyword: keyword });\n        break; // Only one match per category\n      }\n      \n      // Partial match = medium confidence\n      if (normalizedDesc.includes(keywordLower)) {\n        matches.push({ category, confidence: 'medium', matchedKeyword: keyword });\n        break;\n      }\n    }\n  }\n  \n  // Sort by confidence (high > medium > low)\n  return matches.sort((a, b) => {\n    const confidenceOrder = { high: 3, medium: 2, low: 1 };\n    return confidenceOrder[b.confidence] - confidenceOrder[a.confidence];\n  });\n}\n\n/**\n * Get all available categories for a transaction type\n */\nexport function getAvailableCategories(type: 'income' | 'expense' | 'transfer'): string[] {\n  const allCategories = Object.keys(CATEGORY_KEYWORDS);\n  \n  if (type === 'income') {\n    return ['Salary', 'Freelance', 'Investment', 'Refund', 'Other Income'];\n  } else if (type === 'expense') {\n    return allCategories.filter(cat => \n      !['Salary', 'Freelance', 'Investment', 'Refund'].includes(cat)\n    ).concat(['Other']);\n  }\n  \n  return allCategories.concat(['Other', 'Other Income']);\n}\n\n/**\n * Validate if a category is valid for a transaction type\n */\nexport function isValidCategory(category: string, type: 'income' | 'expense' | 'transfer'): boolean {\n  return getAvailableCategories(type).includes(category);\n}\n","path":null,"size_bytes":10558,"size_tokens":null},"client/src/components/dashboard/premium-roi-widget.tsx":{"content":"import { useQuery } from\"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from\"@/components/ui/card\";\nimport { Crown, TrendingUp, DollarSign, Plus } from\"lucide-react\";\nimport { Badge } from\"@/components/ui/badge\";\nimport { Button } from\"@/components/ui/button\";\nimport { Link } from\"wouter\";\nimport { useUserCurrency } from\"@/lib/userContext\";\n\nexport default function PremiumROIWidget() {\n const { formatAmount, convertFromUSD } = useUserCurrency();\n \n const { data: subscription } = useQuery({\n  queryKey: [\"/api/subscription/current\"],\n });\n\n const { data: transactions = [] } = useQuery({\n  queryKey: [\"/api/transactions\"],\n });\n\n const { data: goals = [] } = useQuery({\n  queryKey: [\"/api/financial-goals\"],\n });\n\n const isPremium = (subscription as any)?.subscription?.plan?.name ===\"Pro\";\n\n if (!isPremium) {\n  return null; // Only show for premium users\n }\n\n // Calculate savings this month ONLY (not historical or future)\n const now = new Date();\n const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n const firstDayNextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);\n \n // Filter to only THIS MONTH's transactions (with upper and lower bounds)\n const thisMonthTransactions = Array.isArray(transactions)\n  ? transactions.filter((t: any) => {\n    const transactionDate = new Date(t.date);\n    return transactionDate >= firstDayOfMonth && transactionDate < firstDayNextMonth;\n   })\n  : [];\n \n // Calculate savings from auto-categorization THIS MONTH (estimated $50-100/month in time saved)\n const thisMonthUncategorized = thisMonthTransactions.filter((t: any) => t.category === 'Other' || t.category === 'other').length;\n const thisMonthAutoCategorized = Math.max(0, thisMonthTransactions.length - thisMonthUncategorized);\n const timeSavingsValue = Math.min(100, thisMonthAutoCategorized * 2); // $2 per auto-categorized transaction\n\n // Calculate potential savings from budget tracking (already filtered to this month above)\n const thisMonthExpenses = thisMonthTransactions.filter((t: any) => t.type === 'expense');\n const monthlyExpenses = thisMonthExpenses.reduce((sum: number, t: any) => sum + parseFloat(t.amount), 0);\n \n // Estimate 5-10% savings from better expense tracking\n const budgetSavings = Math.min(500, monthlyExpenses * 0.07);\n\n // Calculate goal progress value (staying on track is worth money)\n const activeGoals = Array.isArray(goals) ? goals.filter((g: any) => g.status === 'active') : [];\n const goalValue = activeGoals.length * 50; // $50 value per active goal being tracked\n\n // Total estimated monthly value\n const totalValue = Math.round(timeSavingsValue + budgetSavings + goalValue);\n \n const subscriptionCost = 9.99; // Pro tier monthly cost\n const netBenefit = totalValue - subscriptionCost;\n const roi = totalValue > 0 ? (totalValue / subscriptionCost).toFixed(1) :\"0\";\n\n return (\n  <Card className=\"relative overflow-hidden border-primary/20 bg-white dark:bg-gray-900\">\n   <div className=\"absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl\"></div>\n   \n   <CardHeader className=\"relative\">\n    <div className=\"flex items-center justify-between\">\n     <div className=\"flex items-center gap-2\">\n      <div className=\"p-2 bg-primary/10 rounded-lg\">\n       <Crown className=\"h-5 w-5 text-primary\" />\n      </div>\n      <CardTitle className=\"text-lg font-semibold\">Your Premium ROI</CardTitle>\n     </div>\n     <Badge variant=\"secondary\" className=\"bg-primary/10 text-primary border-primary/20\">\n      This Month\n     </Badge>\n    </div>\n   </CardHeader>\n\n   <CardContent className=\"space-y-4\">\n    {/* ROI Breakdown */}\n    <div className=\"space-y-3\">\n     <div className=\"flex items-center justify-between text-sm\">\n      <span className=\"text-muted-foreground\">Premium Subscription</span>\n      <span className=\"font-medium text-red-600\">-{formatAmount(convertFromUSD(subscriptionCost))}</span>\n     </div>\n     \n     <div className=\"flex items-center justify-between text-sm\">\n      <div className=\"flex items-center gap-2\">\n       <Plus className=\"h-4 w-4 text-blue-500\" />\n       <span className=\"text-muted-foreground\">AI Time Savings</span>\n      </div>\n      <span className=\"font-medium text-green-600\">+{formatAmount(convertFromUSD(Math.round(timeSavingsValue)))}</span>\n     </div>\n\n     <div className=\"flex items-center justify-between text-sm\">\n      <div className=\"flex items-center gap-2\">\n       <TrendingUp className=\"h-4 w-4 text-emerald-500\" />\n       <span className=\"text-muted-foreground\">Budget Optimization</span>\n      </div>\n      <span className=\"font-medium text-green-600\">+{formatAmount(convertFromUSD(Math.round(budgetSavings)))}</span>\n     </div>\n\n     <div className=\"flex items-center justify-between text-sm\">\n      <div className=\"flex items-center gap-2\">\n       <DollarSign className=\"h-4 w-4 text-amber-500\" />\n       <span className=\"text-muted-foreground\">Goal Tracking Value</span>\n      </div>\n      <span className=\"font-medium text-green-600\">+{formatAmount(convertFromUSD(goalValue))}</span>\n     </div>\n\n     <div className=\"h-px bg-border my-3\"></div>\n\n     {/* Net Benefit */}\n     <div className=\"flex items-center justify-between\">\n      <span className=\"font-semibold\">Net Benefit</span>\n      <span className={`text-xl font-bold ${netBenefit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n       {netBenefit >= 0 ? '+' : ''}{formatAmount(convertFromUSD(netBenefit))}\n      </span>\n     </div>\n\n     {/* ROI Multiplier */}\n     <div className=\"bg-primary/10 rounded-lg p-4 text-center\">\n      <div className=\"text-sm text-muted-foreground mb-1\">You're saving</div>\n      <div className=\"text-3xl font-bold text-primary\">{roi}x</div>\n      <div className=\"text-sm text-muted-foreground mt-1\">your subscription cost</div>\n     </div>\n    </div>\n\n    {/* CTA */}\n    <div className=\"pt-2\">\n     <p className=\"text-xs text-muted-foreground text-center mb-3\">\n      Premium features help you save an average of {formatAmount(convertFromUSD(totalValue))}/month through better financial management\n     </p>\n     <Button variant=\"outline\" className=\"w-full\" asChild>\n      <Link href=\"/subscription\">\n       <Crown className=\"h-4 w-4 mr-2\" />\n       View Premium Benefits\n      </Link>\n     </Button>\n    </div>\n   </CardContent>\n  </Card>\n );\n}\n","path":null,"size_bytes":6302,"size_tokens":null},"server/customAuth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as GoogleStrategy } from \"passport-google-oauth20\";\nimport { Strategy as FacebookStrategy } from \"passport-facebook\";\nimport { Strategy as AppleStrategy } from \"passport-apple\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\nimport { authLogger } from \"./utils/logger\";\n\n// Safe default for REPLIT_DOMAINS in development\nconst REPLIT_DOMAINS = process.env.REPLIT_DOMAINS || 'localhost:5000';\n\n// Use production domain for OAuth in production, dev domain in development\nconst PRODUCTION_DOMAIN = 'twealth.ltd';\nconst domains = REPLIT_DOMAINS.split(',');\nconst isDevelopment = process.env.NODE_ENV === 'development';\nconst customDomain = isDevelopment ? domains[0] : PRODUCTION_DOMAIN;\n\n// Development-only debug logging for OAuth setup\nif (isDevelopment) {\n  authLogger.debug('OAuth Environment', { data: { NODE_ENV: process.env.NODE_ENV } });\n  authLogger.debug('Using domain for callbacks', { data: { domain: customDomain } });\n}\n\nconst FRONTEND_URL = `https://${customDomain}`;\nconst BACKEND_URL = FRONTEND_URL; // Same domain setup\n\nif (isDevelopment) {\n  authLogger.debug('Google callback URL', { data: { url: `${BACKEND_URL}/api/auth/google/callback` } });\n}\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  \n  // Detect production: NODE_ENV=production OR deployment flag\n  const isProduction = process.env.NODE_ENV === 'production' || \n                       process.env.REPLIT_DEPLOYMENT === '1';\n  \n  // Development-only session config logging\n  if (isDevelopment) {\n    authLogger.debug('Session configuration', { \n      data: {\n        NODE_ENV: process.env.NODE_ENV,\n        REPLIT_DEPLOYMENT: process.env.REPLIT_DEPLOYMENT,\n        isProduction,\n        secure: isProduction,\n        sameSite: isProduction ? 'none' : 'lax'\n      }\n    });\n  }\n  \n  // Use a safe default for SESSION_SECRET in development\n  const sessionSecret = process.env.SESSION_SECRET || (isDevelopment ? 'dev-session-secret-change-in-production' : undefined);\n  if (!sessionSecret) {\n    throw new Error('SESSION_SECRET must be set in production');\n  }\n  \n  return session({\n    secret: sessionSecret,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction, // Secure cookies only in production\n      sameSite: isProduction ? 'none' : 'lax', // 'none' for production OAuth, 'lax' for dev\n      domain: isProduction ? '.twealth.ltd' : undefined, // Domain only in production\n      maxAge: sessionTtl,\n    },\n  });\n}\n\ninterface UserSession {\n  userId?: string;\n  email?: string;\n  firstName?: string;\n  lastName?: string;\n  profileImageUrl?: string;\n}\n\n// Google OAuth Strategy\nif (process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET) {\n  passport.use(\n    new GoogleStrategy(\n      {\n        clientID: process.env.GOOGLE_CLIENT_ID,\n        clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n        callbackURL: `${BACKEND_URL}/api/auth/google/callback`,\n        scope: ['profile', 'email'],\n      },\n      async (accessToken, refreshToken, profile, done) => {\n        try {\n          // Extract user info from Google profile\n          const email = profile.emails?.[0]?.value;\n          const firstName = profile.name?.givenName || '';\n          const lastName = profile.name?.familyName || '';\n          const profileImageUrl = profile.photos?.[0]?.value;\n\n          if (!email) {\n            return done(new Error('No email found in Google profile'));\n          }\n\n          // Upsert user in database\n          const user = await storage.upsertUser({\n            id: `google_${profile.id}`,\n            email,\n            firstName,\n            lastName,\n            profileImageUrl,\n          });\n\n          // Initialize subscription if new user\n          const subscription = await storage.getUserSubscription(user.id);\n          if (!subscription) {\n            await storage.initializeDefaultSubscription(user.id);\n          }\n\n          return done(null, {\n            userId: user.id,\n            email: user.email,\n            firstName: user.firstName,\n            lastName: user.lastName,\n            profileImageUrl: user.profileImageUrl,\n          });\n        } catch (error) {\n          return done(error as Error);\n        }\n      }\n    )\n  );\n}\n\n// Facebook OAuth Strategy\nif (process.env.FACEBOOK_APP_ID && process.env.FACEBOOK_APP_SECRET) {\n  passport.use(\n    new FacebookStrategy(\n      {\n        clientID: process.env.FACEBOOK_APP_ID,\n        clientSecret: process.env.FACEBOOK_APP_SECRET,\n        callbackURL: `${BACKEND_URL}/api/auth/facebook/callback`,\n        profileFields: ['id', 'emails', 'name', 'picture.type(large)'],\n      },\n      async (accessToken, refreshToken, profile, done) => {\n        try {\n          // Extract user info from Facebook profile\n          const email = profile.emails?.[0]?.value;\n          const firstName = profile.name?.givenName || '';\n          const lastName = profile.name?.familyName || '';\n          const profileImageUrl = profile.photos?.[0]?.value;\n\n          if (!email) {\n            return done(new Error('No email found in Facebook profile'));\n          }\n\n          // Upsert user in database\n          const user = await storage.upsertUser({\n            id: `facebook_${profile.id}`,\n            email,\n            firstName,\n            lastName,\n            profileImageUrl,\n          });\n\n          // Initialize subscription if new user\n          const subscription = await storage.getUserSubscription(user.id);\n          if (!subscription) {\n            await storage.initializeDefaultSubscription(user.id);\n          }\n\n          return done(null, {\n            userId: user.id,\n            email: user.email,\n            firstName: user.firstName,\n            lastName: user.lastName,\n            profileImageUrl: user.profileImageUrl,\n          });\n        } catch (error) {\n          return done(error as Error);\n        }\n      }\n    )\n  );\n}\n\n// Apple Sign In Strategy\nif (process.env.APPLE_SERVICE_ID && process.env.APPLE_TEAM_ID && process.env.APPLE_KEY_ID && process.env.APPLE_PRIVATE_KEY) {\n  passport.use(\n    new AppleStrategy(\n      {\n        clientID: process.env.APPLE_SERVICE_ID,\n        teamID: process.env.APPLE_TEAM_ID,\n        keyID: process.env.APPLE_KEY_ID,\n        privateKeyString: process.env.APPLE_PRIVATE_KEY.replace(/\\\\n/g, '\\n'),\n        callbackURL: `${BACKEND_URL}/api/auth/apple/callback`,\n        scope: ['email', 'name'],\n        passReqToCallback: false,\n      },\n      async (accessToken: string, refreshToken: string, idToken: any, profile: any, done: any) => {\n        try {\n          // Apple provides email only on first sign in\n          const email = idToken.email || profile.email;\n          const firstName = profile.name?.firstName || '';\n          const lastName = profile.name?.lastName || '';\n\n          if (!email) {\n            return done(new Error('No email found in Apple profile'));\n          }\n\n          // Upsert user in database\n          const user = await storage.upsertUser({\n            id: `apple_${profile.id || idToken.sub}`,\n            email,\n            firstName,\n            lastName,\n            profileImageUrl: null,\n          });\n\n          // Initialize subscription if new user\n          const subscription = await storage.getUserSubscription(user.id);\n          if (!subscription) {\n            await storage.initializeDefaultSubscription(user.id);\n          }\n\n          return done(null, {\n            userId: user.id,\n            email: user.email,\n            firstName: user.firstName,\n            lastName: user.lastName,\n            profileImageUrl: user.profileImageUrl,\n          });\n        } catch (error) {\n          return done(error as Error);\n        }\n      }\n    )\n  );\n}\n\n// Serialize/deserialize user for session\npassport.serializeUser((user: any, done) => {\n  done(null, user);\n});\n\npassport.deserializeUser((user: any, done) => {\n  done(null, user);\n});\n\n// Middleware to check if user is authenticated\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  if (req.isAuthenticated && req.isAuthenticated()) {\n    const userSession = req.user as UserSession;\n    \n    // Attach user ID to request for downstream middleware\n    (req as any).userId = userSession.userId;\n    \n    return next();\n  }\n  \n  res.status(401).json({ error: \"Unauthorized - Please log in\" });\n};\n\nexport function setupAuth(app: Express) {\n  if (isDevelopment) authLogger.debug('setupAuth() called');\n  \n  // Initialize Passport\n  app.use(passport.initialize());\n  app.use(passport.session());\n  if (isDevelopment) authLogger.debug('Passport initialized');\n\n  // Test route to verify routing works (development only)\n  if (isDevelopment) {\n    app.get(\"/api/auth/test\", (req, res) => {\n      authLogger.debug('Test route hit');\n      res.json({ message: \"OAuth routes working\", timestamp: new Date().toISOString() });\n    });\n  }\n\n  // Google OAuth routes\n  if (process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET) {\n    if (isDevelopment) authLogger.debug('Registering Google OAuth routes');\n    app.get(\n      \"/api/auth/google\",\n      (req, res, next) => {\n        if (isDevelopment) authLogger.debug('Initiating Google login');\n        next();\n      },\n      passport.authenticate(\"google\", { scope: [\"profile\", \"email\"] })\n    );\n\n    app.get(\n      \"/api/auth/google/callback\",\n      (req, res, next) => {\n        if (isDevelopment) {\n          authLogger.debug('Callback received', { data: { query: req.query, sessionID: req.sessionID } });\n        }\n        next();\n      },\n      (req, res, next) => {\n        passport.authenticate(\"google\", (err: any, user: any, info: any) => {\n          if (isDevelopment) {\n            authLogger.debug('Passport authenticate callback', { data: { hasError: !!err, hasUser: !!user } });\n          }\n          \n          if (err) {\n            authLogger.error('Authentication error', err);\n            return res.redirect(\"/login\");\n          }\n          \n          if (!user) {\n            authLogger.warn('No user returned from passport');\n            return res.redirect(\"/login\");\n          }\n          \n          req.login(user, (loginErr) => {\n            if (loginErr) {\n              authLogger.error('Login error', loginErr);\n              return res.redirect(\"/login\");\n            }\n            \n            if (isDevelopment) authLogger.debug('User logged in successfully');\n            \n            req.session.save((saveErr) => {\n              if (saveErr) {\n                authLogger.error('Session save error', saveErr);\n                return res.redirect(\"/login\");\n              }\n              if (isDevelopment) authLogger.debug('Session saved, redirecting');\n              res.redirect(\"/\");\n            });\n          });\n        })(req, res, next);\n      }\n    );\n  }\n\n  // Facebook OAuth routes\n  if (process.env.FACEBOOK_APP_ID && process.env.FACEBOOK_APP_SECRET) {\n    app.get(\n      \"/api/auth/facebook\",\n      passport.authenticate(\"facebook\", { scope: [\"email\"] })\n    );\n\n    app.get(\n      \"/api/auth/facebook/callback\",\n      passport.authenticate(\"facebook\", { failureRedirect: \"/login\" }),\n      (req, res) => {\n        // Explicitly save session before redirecting\n        req.session.save((err) => {\n          if (err) {\n            authLogger.error('Facebook session save error', err);\n            return res.redirect(\"/login\");\n          }\n          res.redirect(\"/\");\n        });\n      }\n    );\n  }\n\n  // Apple Sign In routes\n  if (process.env.APPLE_SERVICE_ID && process.env.APPLE_TEAM_ID && process.env.APPLE_KEY_ID && process.env.APPLE_PRIVATE_KEY) {\n    app.post(\n      \"/api/auth/apple\",\n      passport.authenticate(\"apple\")\n    );\n\n    app.post(\n      \"/api/auth/apple/callback\",\n      passport.authenticate(\"apple\", { failureRedirect: \"/login\" }),\n      (req, res) => {\n        // Explicitly save session before redirecting\n        req.session.save((err) => {\n          if (err) {\n            authLogger.error('Apple session save error', err);\n            return res.redirect(\"/login\");\n          }\n          res.redirect(\"/\");\n        });\n      }\n    );\n  }\n\n  // Get current user endpoint\n  app.get(\"/api/auth/user\", isAuthenticated, async (req, res) => {\n    const userSession = req.user as UserSession;\n    const user = await storage.getUser(userSession.userId!);\n    res.json(user);\n  });\n\n  // Logout endpoint\n  app.post(\"/api/auth/logout\", (req, res) => {\n    req.logout((err) => {\n      if (err) {\n        return res.status(500).json({ error: \"Logout failed\" });\n      }\n      req.session.destroy((err) => {\n        if (err) {\n          return res.status(500).json({ error: \"Session destruction failed\" });\n        }\n        res.json({ success: true });\n      });\n    });\n  });\n\n  // Check auth status\n  app.get(\"/api/auth/status\", (req, res) => {\n    res.json({ authenticated: req.isAuthenticated ? req.isAuthenticated() : false });\n  });\n\n  // Get available OAuth providers\n  app.get(\"/api/auth/providers\", (req, res) => {\n    const providers = {\n      google: !!(process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET),\n      facebook: !!(process.env.FACEBOOK_APP_ID && process.env.FACEBOOK_APP_SECRET),\n      apple: !!(process.env.APPLE_SERVICE_ID && process.env.APPLE_TEAM_ID && process.env.APPLE_KEY_ID && process.env.APPLE_PRIVATE_KEY),\n    };\n    res.json(providers);\n  });\n}\n","path":null,"size_bytes":13780,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useTranslation } from \"react-i18next\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { SiGoogle, SiFacebook, SiApple } from \"react-icons/si\";\nimport { Shield, Lock, Eye, Loader2, ArrowLeft } from \"lucide-react\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\n\ninterface AuthProviders {\n  google: boolean;\n  facebook: boolean;\n  apple: boolean;\n}\n\nexport default function Login() {\n  const { t } = useTranslation();\n  const [, setLocation] = useLocation();\n  const [loadingProvider, setLoadingProvider] = useState<string | null>(null);\n  const [isCheckingAuth, setIsCheckingAuth] = useState(true);\n\n  const { data: providers, isLoading: providersLoading, isError: providersError } = useQuery<AuthProviders>({\n    queryKey: [\"/api/auth/providers\"],\n    retry: 2,\n  });\n\n  useEffect(() => {\n    fetch(\"/api/auth/status\")\n      .then(res => res.json())\n      .then(data => {\n        if (data.authenticated) {\n          setLocation(\"/\");\n        }\n      })\n      .catch((err) => {\n        console.warn('[Auth] Failed to check auth status:', err.message);\n      })\n      .finally(() => setIsCheckingAuth(false));\n  }, [setLocation]);\n\n  const handleGoogleLogin = () => {\n    setLoadingProvider(\"google\");\n    window.location.assign(\"/api/auth/google\");\n  };\n\n  const handleFacebookLogin = () => {\n    setLoadingProvider(\"facebook\");\n    window.location.assign(\"/api/auth/facebook\");\n  };\n\n  const handleAppleLogin = () => {\n    setLoadingProvider(\"apple\");\n    const form = document.createElement('form');\n    form.method = 'POST';\n    form.action = '/api/auth/apple';\n    document.body.appendChild(form);\n    form.submit();\n  };\n\n  const hasAnyProvider = providers?.google || providers?.facebook || providers?.apple;\n\n  if (isCheckingAuth || providersLoading) {\n    return (\n      <div className=\"min-h-screen bg-slate-950 flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-950\">\n      <div className=\"absolute inset-0 bg-gradient-to-b from-slate-900 to-slate-950\" />\n      \n      <div className=\"relative min-h-screen flex flex-col\">\n        <header className=\"px-6 py-4\">\n          <button\n            onClick={() => setLocation(\"/\")}\n            className=\"inline-flex items-center gap-2 text-sm text-slate-400 hover:text-white transition-colors\"\n            data-testid=\"button-back-home\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            {t('login.backToHome')}\n          </button>\n        </header>\n\n        <div className=\"flex-1 flex items-center justify-center p-6\">\n          <div className=\"w-full max-w-md\">\n            <div className=\"text-center mb-10\">\n              <div className=\"inline-flex items-center justify-center mb-6\">\n                <img \n                  src={logoUrl} \n                  alt=\"Twealth\" \n                  className=\"w-14 h-14 object-contain\"\n                />\n              </div>\n              <h1 className=\"text-3xl font-bold tracking-tight text-white mb-2\">\n                {t('login.title')}\n              </h1>\n              <p className=\"text-slate-400\">\n                {t('login.subtitle')}\n              </p>\n            </div>\n\n            <div className=\"rounded-2xl border border-slate-700 bg-slate-900 shadow-xl\">\n              <div className=\"p-8 space-y-4\">\n                {providersError ? (\n                  <div className=\"text-center py-6\">\n                    <p className=\"text-red-400 mb-2\">{t('login.unableToLoad')}</p>\n                    <p className=\"text-sm text-slate-500\">{t('login.refreshPage')}</p>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => window.location.reload()}\n                      className=\"mt-4 border-slate-600 text-slate-300\"\n                    >\n                      {t('login.refresh')}\n                    </Button>\n                  </div>\n                ) : !hasAnyProvider ? (\n                  <div className=\"text-center py-6\">\n                    <p className=\"text-slate-400 mb-2\">{t('login.authConfiguring')}</p>\n                    <p className=\"text-sm text-slate-500\">{t('login.checkBackSoon')}</p>\n                  </div>\n                ) : (\n                  <>\n                    {providers?.google && (\n                      <Button\n                        onClick={handleGoogleLogin}\n                        disabled={loadingProvider !== null}\n                        variant=\"outline\"\n                        className=\"w-full h-12 font-medium border-slate-600 bg-slate-800 hover:bg-slate-700 text-white rounded-xl\"\n                        data-testid=\"button-google-login\"\n                      >\n                        {loadingProvider === \"google\" ? (\n                          <Loader2 className=\"mr-3 h-4 w-4 animate-spin\" />\n                        ) : (\n                          <SiGoogle className=\"mr-3 h-4 w-4\" />\n                        )}\n                        {t('login.google')}\n                      </Button>\n                    )}\n\n                    {providers?.apple && (\n                      <Button\n                        onClick={handleAppleLogin}\n                        disabled={loadingProvider !== null}\n                        variant=\"outline\"\n                        className=\"w-full h-12 font-medium border-slate-600 bg-slate-800 hover:bg-slate-700 text-white rounded-xl\"\n                        data-testid=\"button-apple-login\"\n                      >\n                        {loadingProvider === \"apple\" ? (\n                          <Loader2 className=\"mr-3 h-4 w-4 animate-spin\" />\n                        ) : (\n                          <SiApple className=\"mr-3 h-4 w-4\" />\n                        )}\n                        {t('login.apple')}\n                      </Button>\n                    )}\n\n                    {providers?.facebook && (\n                      <Button\n                        onClick={handleFacebookLogin}\n                        disabled={loadingProvider !== null}\n                        variant=\"outline\"\n                        className=\"w-full h-12 font-medium border-slate-600 bg-slate-800 hover:bg-slate-700 text-white rounded-xl\"\n                        data-testid=\"button-facebook-login\"\n                      >\n                        {loadingProvider === \"facebook\" ? (\n                          <Loader2 className=\"mr-3 h-4 w-4 animate-spin\" />\n                        ) : (\n                          <SiFacebook className=\"mr-3 h-4 w-4 text-[#1877F2]\" />\n                        )}\n                        {t('login.facebook')}\n                      </Button>\n                    )}\n                  </>\n                )}\n\n                <div className=\"relative my-6\">\n                  <div className=\"absolute inset-0 flex items-center\">\n                    <Separator className=\"w-full bg-slate-700\" />\n                  </div>\n                  <div className=\"relative flex justify-center text-xs\">\n                    <span className=\"bg-slate-900 px-3 text-slate-500\">\n                      {t('login.enterpriseSecurity')}\n                    </span>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-3 gap-4 pt-2\">\n                  <div className=\"text-center\">\n                    <div className=\"w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-2\">\n                      <Lock className=\"w-4 h-4 text-slate-400\" />\n                    </div>\n                    <p className=\"text-xs text-slate-400\">{t('login.encryption')}</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-2\">\n                      <Shield className=\"w-4 h-4 text-slate-400\" />\n                    </div>\n                    <p className=\"text-xs text-slate-400\">{t('login.soc2')}</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-2\">\n                      <Eye className=\"w-4 h-4 text-slate-400\" />\n                    </div>\n                    <p className=\"text-xs text-slate-400\">{t('login.gdpr')}</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"mt-8 space-y-4\">\n              <p className=\"text-center text-sm text-slate-400\">\n                {t('login.newToTwealth')}{\" \"}\n                <button\n                  onClick={() => setLocation(\"/welcome\")}\n                  className=\"text-white font-medium hover:underline\"\n                  data-testid=\"link-learn-more\"\n                >\n                  {t('login.learnMore')}\n                </button>\n              </p>\n\n              <div className=\"flex items-center justify-center gap-4 text-xs text-slate-500\">\n                <button \n                  onClick={() => setLocation(\"/terms\")}\n                  className=\"hover:text-slate-300 transition-colors\"\n                  data-testid=\"link-terms\"\n                >\n                  {t('login.terms')}\n                </button>\n                <span className=\"w-1 h-1 rounded-full bg-slate-600\" />\n                <button \n                  onClick={() => setLocation(\"/privacy\")}\n                  className=\"hover:text-slate-300 transition-colors\"\n                  data-testid=\"link-privacy\"\n                >\n                  {t('login.privacy')}\n                </button>\n                <span className=\"w-1 h-1 rounded-full bg-slate-600\" />\n                <span>{t('login.copyright')}</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10118,"size_tokens":null},"client/src/components/ui/sparkline.tsx":{"content":"import { memo } from 'react';\n\ninterface SparklineProps {\n  data: number[];\n  color?: 'green' | 'red' | 'blue' | 'purple' | 'gray';\n  className?: string;\n}\n\nfunction Sparkline({ data, color = 'blue', className = '' }: SparklineProps) {\n  if (!data || data.length < 2) {\n    return <div className={`sparkline-container ${className}`}></div>;\n  }\n\n  const max = Math.max(...data, 1);\n  const min = Math.min(...data, 0);\n  const range = max - min || 1;\n  \n  const points = data.map((value, index) => {\n    const x = (index / (data.length - 1)) * 100;\n    const y = 100 - ((value - min) / range) * 100;\n    return `${x},${y}`;\n  }).join(' ');\n\n  const colorClasses = {\n    green: 'stroke-green-600 dark:stroke-green-400',\n    red: 'stroke-red-600 dark:stroke-red-400',\n    blue: 'stroke-primary',\n    purple: 'stroke-primary',\n    gray: 'stroke-muted-foreground'\n  };\n\n  return (\n    <svg \n      className={`sparkline-container ${className}`} \n      viewBox=\"0 0 100 100\" \n      preserveAspectRatio=\"none\"\n      aria-hidden=\"true\"\n    >\n      <polyline\n        fill=\"none\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n        points={points}\n        className={colorClasses[color]}\n        vectorEffect=\"non-scaling-stroke\"\n      />\n    </svg>\n  );\n}\n\nexport default memo(Sparkline);\n","path":null,"size_bytes":1350,"size_tokens":null},"client/src/components/dashboard/insights-feed-widget.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Trophy,\n  TrendingUp,\n  TrendingDown,\n  AlertCircle,\n  Target,\n  Award,\n  Zap,\n  ChevronLeft,\n  ChevronRight\n} from \"lucide-react\";\n\ninterface InsightItem {\n  id: string;\n  type: 'achievement' | 'anomaly' | 'benchmark';\n  title: string;\n  description: string;\n  metric?: string;\n  comparison?: string;\n  priority: 'low' | 'normal' | 'high';\n  icon: any;\n  color: string;\n}\n\nexport default function InsightsFeedWidget() {\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const [isTransitioning, setIsTransitioning] = useState(false);\n\n  // Fetch data\n  const { data: transactions = [] } = useQuery<any[]>({\n    queryKey: [\"/api/transactions\"],\n  });\n\n  const { data: goals = [] } = useQuery<any[]>({\n    queryKey: [\"/api/financial-goals\"],\n  });\n\n  const { data: stats } = useQuery({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  // Memoize insights to prevent regeneration on every render\n  const insights = useMemo((): InsightItem[] => {\n    const insights: InsightItem[] = [];\n    const now = new Date();\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n\n    // Calculate financial metrics\n    const totalIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    \n    const totalExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : 0;\n\n    // Achievement Insights\n    const completedGoals = goals.filter(g => g.status === 'completed');\n    if (completedGoals.length > 0) {\n      insights.push({\n        id: 'achievement-goals',\n        type: 'achievement',\n        title: `${completedGoals.length} Goal${completedGoals.length > 1 ? 's' : ''} Completed`,\n        description: `You've successfully completed ${completedGoals.length} financial goal${completedGoals.length > 1 ? 's' : ''} this year.`,\n        metric: `${completedGoals.length}`,\n        priority: 'high',\n        icon: Trophy,\n        color: 'text-yellow-600 dark:text-yellow-400'\n      });\n    }\n\n    const activeGoals = goals.filter(g => g.status === 'active');\n    const goalsNearCompletion = activeGoals.filter(g => {\n      const progress = (parseFloat(g.currentAmount) / parseFloat(g.targetAmount)) * 100;\n      return progress >= 75 && progress < 100;\n    });\n\n    if (goalsNearCompletion.length > 0) {\n      insights.push({\n        id: 'achievement-progress',\n        type: 'achievement',\n        title: 'Goals Nearly Complete',\n        description: `${goalsNearCompletion.length} goal${goalsNearCompletion.length > 1 ? 's are' : ' is'} over 75% funded. You're almost there.`,\n        metric: `${goalsNearCompletion.length}`,\n        priority: 'normal',\n        icon: Award,\n        color: 'text-blue-600 dark:text-blue-400'\n      });\n    }\n\n    // Spending Anomaly Detection\n    const categoryTotals: Record<string, number> = {};\n    recentTransactions\n      .filter(t => t.type === 'expense')\n      .forEach(t => {\n        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + parseFloat(t.amount);\n      });\n\n    const sortedCategories = Object.entries(categoryTotals)\n      .sort(([, a], [, b]) => b - a);\n\n    if (sortedCategories.length > 0) {\n      const [topCategory, topAmount] = sortedCategories[0];\n      const categoryPercent = totalExpenses > 0 ? (topAmount / totalExpenses) * 100 : 0;\n      \n      if (categoryPercent > 40) {\n        insights.push({\n          id: 'anomaly-concentration',\n          type: 'anomaly',\n          title: 'Spending Concentration Alert',\n          description: `${categoryPercent.toFixed(0)}% of your expenses are in ${topCategory}. Consider diversifying your spending.`,\n          metric: `${categoryPercent.toFixed(0)}%`,\n          comparison: topCategory,\n          priority: 'high',\n          icon: AlertCircle,\n          color: 'text-orange-600 dark:text-orange-400'\n        });\n      }\n    }\n\n    // Large transaction detection\n    const averageTransaction = totalExpenses / recentTransactions.filter(t => t.type === 'expense').length;\n    const largeTransactions = recentTransactions\n      .filter(t => t.type === 'expense' && parseFloat(t.amount) > averageTransaction * 2);\n\n    if (largeTransactions.length > 0 && averageTransaction > 0) {\n      insights.push({\n        id: 'anomaly-large',\n        type: 'anomaly',\n        title: 'Unusual Spending Detected',\n        description: `${largeTransactions.length} transaction${largeTransactions.length > 1 ? 's' : ''} exceeded double your average spend this month.`,\n        metric: `${largeTransactions.length}`,\n        priority: 'normal',\n        icon: TrendingUp,\n        color: 'text-red-600 dark:text-red-400'\n      });\n    }\n\n    // Benchmark Comparisons\n    if (savingsRate >= 20) {\n      insights.push({\n        id: 'benchmark-savings-excellent',\n        type: 'benchmark',\n        title: 'Savings Rate: Excellent',\n        description: `Your ${savingsRate.toFixed(0)}% savings rate exceeds the recommended 20%. You're in the top quartile.`,\n        metric: `${savingsRate.toFixed(0)}%`,\n        comparison: 'vs. 20% target',\n        priority: 'low',\n        icon: TrendingUp,\n        color: 'text-green-600 dark:text-green-400'\n      });\n    } else if (savingsRate >= 10) {\n      insights.push({\n        id: 'benchmark-savings-good',\n        type: 'benchmark',\n        title: 'Savings Rate: Above Average',\n        description: `Your ${savingsRate.toFixed(0)}% savings rate is above the national average of 7%. Keep it up.`,\n        metric: `${savingsRate.toFixed(0)}%`,\n        comparison: 'vs. 7% average',\n        priority: 'normal',\n        icon: Target,\n        color: 'text-blue-600 dark:text-blue-400'\n      });\n    } else if (savingsRate >= 0) {\n      insights.push({\n        id: 'benchmark-savings-low',\n        type: 'benchmark',\n        title: 'Savings Rate: Below Target',\n        description: `Your ${savingsRate.toFixed(0)}% savings rate is below the recommended 20%. Small changes can make a big difference.`,\n        metric: `${savingsRate.toFixed(0)}%`,\n        comparison: 'vs. 20% target',\n        priority: 'high',\n        icon: TrendingDown,\n        color: 'text-orange-600 dark:text-orange-400'\n      });\n    }\n\n    // Active goals benchmark\n    if (activeGoals.length >= 3) {\n      insights.push({\n        id: 'benchmark-goals',\n        type: 'benchmark',\n        title: 'Goal Planning: Strong',\n        description: `You're managing ${activeGoals.length} active goals. Most successful savers track 2-5 goals simultaneously.`,\n        metric: `${activeGoals.length}`,\n        comparison: 'vs. 2-5 typical',\n        priority: 'low',\n        icon: Zap,\n        color: 'text-blue-600 dark:text-blue-400'\n      });\n    }\n\n    return insights.length > 0 ? insights : [{\n      id: 'getting-started',\n      type: 'benchmark',\n      title: 'Start Tracking',\n      description: 'Add transactions and goals to receive personalized financial insights.',\n      priority: 'normal',\n      icon: Target,\n      color: 'text-gray-600 dark:text-gray-400'\n    }];\n  }, [transactions, goals, stats]);\n\n  // Auto-rotate insights every 5 seconds\n  useEffect(() => {\n    if (insights.length <= 1) return;\n\n    const interval = setInterval(() => {\n      setIsTransitioning(true);\n      setTimeout(() => {\n        setCurrentIndex((prev) => (prev + 1) % insights.length);\n        setIsTransitioning(false);\n      }, 150); // Match transition duration\n    }, 5000);\n\n    return () => clearInterval(interval);\n  }, [insights.length]);\n\n  const handlePrevious = () => {\n    setIsTransitioning(true);\n    setTimeout(() => {\n      setCurrentIndex((prev) => (prev - 1 + insights.length) % insights.length);\n      setIsTransitioning(false);\n    }, 150);\n  };\n\n  const handleNext = () => {\n    setIsTransitioning(true);\n    setTimeout(() => {\n      setCurrentIndex((prev) => (prev + 1) % insights.length);\n      setIsTransitioning(false);\n    }, 150);\n  };\n\n  const currentInsight = insights[currentIndex];\n  const Icon = currentInsight.icon;\n\n  const getPriorityBadge = (priority: string) => {\n    switch (priority) {\n      case 'high':\n        return 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300';\n      case 'normal':\n        return 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300';\n      case 'low':\n        return 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300';\n      default:\n        return 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300';\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'achievement': return 'Achievement';\n      case 'anomaly': return 'Alert';\n      case 'benchmark': return 'Insight';\n      default: return 'Insight';\n    }\n  };\n\n  return (\n    <Card className=\"border-border/50\" data-testid=\"card-insights-feed\">\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg font-semibold tracking-tight\">Smart Insights</CardTitle>\n          {insights.length > 1 && (\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-xs text-muted-foreground\">\n                {currentIndex + 1} / {insights.length}\n              </span>\n              <div className=\"flex gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7 w-7 p-0\"\n                  onClick={handlePrevious}\n                  data-testid=\"button-insights-previous\"\n                >\n                  <ChevronLeft className=\"h-4 w-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7 w-7 p-0\"\n                  onClick={handleNext}\n                  data-testid=\"button-insights-next\"\n                >\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </div>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div\n          className=\"transition-opacity duration-150\"\n          style={{ opacity: isTransitioning ? 0 : 1 }}\n        >\n          <div className=\"flex items-start gap-4\">\n            <div className=\"flex-shrink-0\">\n              <div className={`w-12 h-12 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center ${currentInsight.color}`}>\n                <Icon className=\"w-6 h-6\" />\n              </div>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Badge variant=\"secondary\" className={getPriorityBadge(currentInsight.priority)}>\n                  {getTypeLabel(currentInsight.type)}\n                </Badge>\n                {currentInsight.metric && (\n                  <span className=\"text-sm font-semibold text-foreground\">\n                    {currentInsight.metric}\n                  </span>\n                )}\n              </div>\n              <h3 className=\"font-semibold text-base mb-1 text-foreground\">\n                {currentInsight.title}\n              </h3>\n              <p className=\"text-sm text-muted-foreground leading-relaxed\">\n                {currentInsight.description}\n              </p>\n              {currentInsight.comparison && (\n                <p className=\"text-xs text-muted-foreground/80 mt-2\">\n                  {currentInsight.comparison}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":12053,"size_tokens":null},"client/src/components/ui/empty-state.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { Link } from \"wouter\";\nimport { LucideIcon, Target, Receipt, PiggyBank, MessageSquare, Coins, Calendar, Bell, Users, LineChart, FileText, BarChart3, CreditCard, Briefcase, Wallet } from \"lucide-react\";\n\ninterface EmptyStateProps {\n  illustration?: 'transactions' | 'goals' | 'budgets' | 'conversations' | 'crypto' | 'calendar' | 'notifications' | 'friends' | 'insights' | 'investments' | 'debts' | 'assets';\n  icon?: LucideIcon;\n  title: string;\n  description: string;\n  actionLabel?: string;\n  onAction?: () => void;\n  actionHref?: string;\n  actionTestId?: string;\n  size?: 'sm' | 'md' | 'lg';\n  className?: string;\n}\n\ninterface EmptyStateConfig {\n  icon: LucideIcon;\n  iconBgClass: string;\n  iconClass: string;\n}\n\nconst emptyStateConfigs: Record<NonNullable<EmptyStateProps['illustration']>, EmptyStateConfig> = {\n  transactions: {\n    icon: Receipt,\n    iconBgClass: \"bg-blue-50 dark:bg-blue-950/30\",\n    iconClass: \"text-blue-600 dark:text-blue-400\"\n  },\n  goals: {\n    icon: Target,\n    iconBgClass: \"bg-green-50 dark:bg-green-950/30\",\n    iconClass: \"text-green-600 dark:text-green-400\"\n  },\n  budgets: {\n    icon: PiggyBank,\n    iconBgClass: \"bg-purple-50 dark:bg-purple-950/30\",\n    iconClass: \"text-purple-600 dark:text-purple-400\"\n  },\n  conversations: {\n    icon: MessageSquare,\n    iconBgClass: \"bg-blue-50 dark:bg-blue-950/30\",\n    iconClass: \"text-blue-600 dark:text-blue-400\"\n  },\n  crypto: {\n    icon: Coins,\n    iconBgClass: \"bg-orange-50 dark:bg-orange-950/30\",\n    iconClass: \"text-orange-600 dark:text-orange-400\"\n  },\n  calendar: {\n    icon: Calendar,\n    iconBgClass: \"bg-teal-50 dark:bg-teal-950/30\",\n    iconClass: \"text-teal-600 dark:text-teal-400\"\n  },\n  notifications: {\n    icon: Bell,\n    iconBgClass: \"bg-gray-50 dark:bg-gray-900/30\",\n    iconClass: \"text-gray-600 dark:text-gray-400\"\n  },\n  friends: {\n    icon: Users,\n    iconBgClass: \"bg-pink-50 dark:bg-pink-950/30\",\n    iconClass: \"text-pink-600 dark:text-pink-400\"\n  },\n  insights: {\n    icon: LineChart,\n    iconBgClass: \"bg-blue-50 dark:bg-blue-950/30\",\n    iconClass: \"text-blue-600 dark:text-blue-400\"\n  },\n  investments: {\n    icon: BarChart3,\n    iconBgClass: \"bg-emerald-50 dark:bg-emerald-950/30\",\n    iconClass: \"text-emerald-600 dark:text-emerald-400\"\n  },\n  debts: {\n    icon: CreditCard,\n    iconBgClass: \"bg-red-50 dark:bg-red-950/30\",\n    iconClass: \"text-red-600 dark:text-red-400\"\n  },\n  assets: {\n    icon: Briefcase,\n    iconBgClass: \"bg-amber-50 dark:bg-amber-950/30\",\n    iconClass: \"text-amber-600 dark:text-amber-400\"\n  }\n};\n\nconst sizeClasses = {\n  sm: {\n    container: 'py-8 px-4',\n    iconWrapper: 'w-12 h-12',\n    icon: 'w-5 h-5',\n    title: 'text-sm',\n    description: 'text-xs max-w-xs',\n    button: 'h-8 text-xs'\n  },\n  md: {\n    container: 'py-12 px-4',\n    iconWrapper: 'w-16 h-16',\n    icon: 'w-7 h-7',\n    title: 'text-lg',\n    description: 'text-sm max-w-sm',\n    button: 'h-9 text-sm'\n  },\n  lg: {\n    container: 'py-16 px-6',\n    iconWrapper: 'w-20 h-20',\n    icon: 'w-9 h-9',\n    title: 'text-xl',\n    description: 'text-base max-w-md',\n    button: 'h-10'\n  }\n};\n\nexport default function EmptyState({\n  illustration,\n  icon: CustomIcon,\n  title,\n  description,\n  actionLabel,\n  onAction,\n  actionHref,\n  actionTestId,\n  size = 'md',\n  className\n}: EmptyStateProps) {\n  const config = illustration ? emptyStateConfigs[illustration] : null;\n  const Icon = CustomIcon || config?.icon || Wallet;\n  const sizes = sizeClasses[size];\n  \n  const buttonContent = (\n    <Button \n      onClick={onAction} \n      data-testid={actionTestId || `empty-state-action`} \n      className={cn(\"min-h-[44px]\", sizes.button)}\n    >\n      {actionLabel}\n    </Button>\n  );\n\n  return (\n    <div \n      className={cn(\n        \"flex flex-col items-center justify-center text-center\",\n        sizes.container,\n        className\n      )} \n      data-testid=\"empty-state\"\n    >\n      {illustration ? (\n        <div \n          className={cn(\n            \"rounded-2xl flex items-center justify-center mb-5\",\n            sizes.iconWrapper,\n            config?.iconBgClass\n          )}\n        >\n          <Icon className={cn(sizes.icon, config?.iconClass)} />\n        </div>\n      ) : (\n        <div className=\"mb-5\">\n          <Icon className={cn(\"text-muted-foreground/40\", sizes.icon === 'w-5 h-5' ? 'w-12 h-12' : sizes.icon === 'w-7 h-7' ? 'w-14 h-14' : 'w-16 h-16')} />\n        </div>\n      )}\n\n      <div className={cn(\"space-y-2 mb-6\", sizes.description.split(' ').pop())}>\n        <h3 className={cn(\"font-semibold text-foreground tracking-tight\", sizes.title)}>{title}</h3>\n        <p className={cn(\"text-muted-foreground leading-relaxed\", sizes.description)}>{description}</p>\n      </div>\n\n      {actionLabel && (onAction || actionHref) && (\n        actionHref ? (\n          <Link href={actionHref}>\n            {buttonContent}\n          </Link>\n        ) : (\n          buttonContent\n        )\n      )}\n    </div>\n  );\n}\n\nexport function EmptyStateMinimal({\n  icon: Icon = Wallet,\n  message,\n  className\n}: {\n  icon?: LucideIcon;\n  message: string;\n  className?: string;\n}) {\n  return (\n    <div \n      className={cn(\n        \"flex flex-col items-center justify-center text-center py-8\",\n        className\n      )}\n      data-testid=\"empty-state-minimal\"\n    >\n      <Icon className=\"w-8 h-8 text-muted-foreground/40 mb-3\" />\n      <p className=\"text-sm text-muted-foreground\">{message}</p>\n    </div>\n  );\n}\n\nexport function EmptyStateInline({\n  message,\n  actionLabel,\n  onAction,\n  actionHref,\n  className\n}: {\n  message: string;\n  actionLabel?: string;\n  onAction?: () => void;\n  actionHref?: string;\n  className?: string;\n}) {\n  const button = actionLabel && (onAction || actionHref) && (\n    <Button variant=\"outline\" size=\"sm\" onClick={onAction} className=\"min-h-[36px]\">\n      {actionLabel}\n    </Button>\n  );\n\n  return (\n    <div \n      className={cn(\n        \"flex items-center justify-center gap-4 py-6 px-4 rounded-xl border border-dashed border-border/60 bg-muted/20\",\n        className\n      )}\n      data-testid=\"empty-state-inline\"\n    >\n      <p className=\"text-sm text-muted-foreground\">{message}</p>\n      {actionHref && button ? (\n        <Link href={actionHref}>{button}</Link>\n      ) : button}\n    </div>\n  );\n}\n\nfunction TransactionsIllustration() {\n  return (\n    <svg\n      width=\"120\"\n      height=\"120\"\n      viewBox=\"0 0 120 120\"\n      fill=\"none\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className=\"text-muted-foreground/40\"\n    >\n      <rect x=\"30\" y=\"15\" width=\"60\" height=\"90\" rx=\"4\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <line x1=\"40\" y1=\"28\" x2=\"80\" y2=\"28\" stroke=\"currentColor\" strokeWidth=\"2\" />\n      <line x1=\"40\" y1=\"42\" x2=\"70\" y2=\"42\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n      <circle cx=\"77\" cy=\"42\" r=\"2\" fill=\"currentColor\" />\n      <line x1=\"40\" y1=\"52\" x2=\"65\" y2=\"52\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n      <circle cx=\"77\" cy=\"52\" r=\"2\" fill=\"currentColor\" />\n      <line x1=\"40\" y1=\"62\" x2=\"68\" y2=\"62\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n      <circle cx=\"77\" cy=\"62\" r=\"2\" fill=\"currentColor\" />\n      <line x1=\"40\" y1=\"72\" x2=\"72\" y2=\"72\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\n      <circle cx=\"77\" cy=\"72\" r=\"2\" fill=\"currentColor\" />\n      <line x1=\"40\" y1=\"88\" x2=\"80\" y2=\"88\" stroke=\"currentColor\" strokeWidth=\"2\" />\n      <line x1=\"40\" y1=\"92\" x2=\"80\" y2=\"92\" stroke=\"currentColor\" strokeWidth=\"2\" />\n    </svg>\n  );\n}\n\nfunction GoalsIllustration() {\n  return (\n    <svg\n      width=\"120\"\n      height=\"120\"\n      viewBox=\"0 0 120 120\"\n      fill=\"none\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className=\"text-muted-foreground/40\"\n    >\n      <circle cx=\"60\" cy=\"60\" r=\"35\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <circle cx=\"60\" cy=\"60\" r=\"25\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <circle cx=\"60\" cy=\"60\" r=\"15\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <circle cx=\"60\" cy=\"60\" r=\"5\" fill=\"currentColor\" />\n      <path\n        d=\"M 85 35 L 67 53\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n      />\n      <path\n        d=\"M 85 35 L 78 38 M 85 35 L 82 42\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n      />\n    </svg>\n  );\n}\n\nfunction BudgetsIllustration() {\n  return (\n    <svg\n      width=\"120\"\n      height=\"120\"\n      viewBox=\"0 0 120 120\"\n      fill=\"none\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className=\"text-muted-foreground/40\"\n    >\n      <ellipse cx=\"60\" cy=\"65\" rx=\"30\" ry=\"25\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <ellipse cx=\"82\" cy=\"60\" rx=\"8\" ry=\"6\" stroke=\"currentColor\" strokeWidth=\"2\" fill=\"none\" />\n      <circle cx=\"79\" cy=\"59\" r=\"1.5\" fill=\"currentColor\" />\n      <circle cx=\"82\" cy=\"61\" r=\"1.5\" fill=\"currentColor\" />\n      <path\n        d=\"M 48 45 Q 42 40 45 35\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        fill=\"none\"\n        strokeLinecap=\"round\"\n      />\n      <circle cx=\"55\" cy=\"58\" r=\"2.5\" fill=\"currentColor\" />\n      <rect x=\"55\" y=\"42\" width=\"10\" height=\"3\" rx=\"1\" stroke=\"currentColor\" strokeWidth=\"1.5\" fill=\"none\" />\n      <line x1=\"45\" y1=\"90\" x2=\"45\" y2=\"100\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" />\n      <line x1=\"55\" y1=\"90\" x2=\"55\" y2=\"100\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" />\n      <line x1=\"65\" y1=\"90\" x2=\"65\" y2=\"100\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" />\n      <line x1=\"75\" y1=\"90\" x2=\"75\" y2=\"100\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" />\n      <path\n        d=\"M 30 65 Q 25 65 25 60 Q 25 55 28 55\"\n        stroke=\"currentColor\"\n        strokeWidth=\"2\"\n        fill=\"none\"\n        strokeLinecap=\"round\"\n      />\n    </svg>\n  );\n}\n\nexport { TransactionsIllustration, GoalsIllustration, BudgetsIllustration };\n","path":null,"size_bytes":9964,"size_tokens":null},"client/src/components/transactions/swipeable-transaction-item.tsx":{"content":"import { useState, useRef, useCallback } from \"react\";\nimport { motion, PanInfo, useMotionValue, useTransform, animate } from \"framer-motion\";\nimport { Archive, Flag, TrendingUp, TrendingDown, DollarSign } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\ninterface Transaction {\n  id: number;\n  type: string;\n  description: string;\n  category: string;\n  date: string;\n  amount: string;\n  goalId?: number;\n  isArchived?: boolean;\n  isFlagged?: boolean;\n}\n\ninterface SwipeableTransactionItemProps {\n  transaction: Transaction;\n  onArchive?: (id: number) => void;\n  onFlag?: (id: number) => void;\n}\n\nconst SWIPE_THRESHOLD = 80;\n\nexport function SwipeableTransactionItem({ \n  transaction, \n  onArchive, \n  onFlag \n}: SwipeableTransactionItemProps) {\n  const [isDragging, setIsDragging] = useState(false);\n  const [isFocused, setIsFocused] = useState(false);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const x = useMotionValue(0);\n  const { formatAmount } = useUserCurrency();\n  \n  const archiveOpacity = useTransform(x, [-SWIPE_THRESHOLD, 0], [1, 0]);\n  const flagOpacity = useTransform(x, [0, SWIPE_THRESHOLD], [0, 1]);\n\n  const handleKeyDown = useCallback((event: React.KeyboardEvent) => {\n    if (event.key === 'ArrowLeft' && onArchive) {\n      event.preventDefault();\n      animate(x, -300, {\n        duration: 0.3,\n        ease: \"easeOut\",\n        onComplete: () => {\n          onArchive(transaction.id);\n          x.set(0);\n        }\n      });\n    } else if (event.key === 'ArrowRight' && onFlag) {\n      event.preventDefault();\n      animate(x, 300, {\n        duration: 0.3,\n        ease: \"easeOut\",\n        onComplete: () => {\n          onFlag(transaction.id);\n          x.set(0);\n        }\n      });\n    } else if (event.key === 'a' && onArchive) {\n      event.preventDefault();\n      onArchive(transaction.id);\n    } else if (event.key === 'f' && onFlag) {\n      event.preventDefault();\n      onFlag(transaction.id);\n    }\n  }, [x, onArchive, onFlag, transaction.id]);\n\n  const getTransactionIcon = (type: string) => {\n    switch (type) {\n      case \"income\":\n        return <TrendingUp className=\"text-green-600\" size={16} />;\n      case \"expense\":\n        return <TrendingDown className=\"text-red-600\" size={16} />;\n      case \"transfer\":\n        return <DollarSign className=\"text-blue-600\" size={16} />;\n      default:\n        return <DollarSign className=\"text-gray-600\" size={16} />;\n    }\n  };\n\n  const getAmountColor = (type: string) => {\n    switch (type) {\n      case \"income\":\n        return \"text-green-600\";\n      case \"expense\":\n        return \"text-red-600\";\n      case \"transfer\":\n        return \"text-blue-600\";\n      default:\n        return \"text-gray-600\";\n    }\n  };\n\n  const handleDragEnd = (event: any, info: PanInfo) => {\n    setIsDragging(false);\n    \n    const swipeDistance = info.offset.x;\n    \n    if (swipeDistance < -SWIPE_THRESHOLD && onArchive) {\n      // Slide out left with confirmation animation\n      animate(x, -300, {\n        duration: 0.3,\n        ease: \"easeOut\",\n        onComplete: () => {\n          onArchive(transaction.id);\n          // Reset position for when item reappears\n          x.set(0);\n        }\n      });\n    } else if (swipeDistance > SWIPE_THRESHOLD && onFlag) {\n      // Slide out right with confirmation animation\n      animate(x, 300, {\n        duration: 0.3,\n        ease: \"easeOut\",\n        onComplete: () => {\n          onFlag(transaction.id);\n          // Reset position for when item reappears\n          x.set(0);\n        }\n      });\n    } else {\n      // Snap back to original position if threshold not met\n      animate(x, 0, {\n        duration: 0.3,\n        ease: \"easeOut\"\n      });\n    }\n  };\n\n  return (\n    <div \n      ref={containerRef}\n      tabIndex={0}\n      role=\"button\"\n      aria-label={`${transaction.description || transaction.category}: ${transaction.type === \"income\" ? \"+\" : \"-\"}${formatAmount(Math.abs(parseFloat(transaction.amount)))}. Press left arrow or A to archive, right arrow or F to flag.`}\n      onKeyDown={handleKeyDown}\n      onFocus={() => setIsFocused(true)}\n      onBlur={() => setIsFocused(false)}\n      className={cn(\n        \"relative overflow-hidden rounded-lg border outline-none\",\n        isFocused && \"ring-2 ring-blue-500 ring-offset-2 ring-offset-background\"\n      )}\n    >\n      {/* Background Actions */}\n      <div className=\"absolute inset-0 flex items-center justify-between px-6 pointer-events-none\">\n        <motion.div \n          style={{ opacity: archiveOpacity }}\n          className=\"flex items-center gap-2 text-red-600 font-medium\"\n        >\n          <Archive size={20} />\n          <span className=\"text-sm\">Archive</span>\n        </motion.div>\n        \n        <motion.div \n          style={{ opacity: flagOpacity }}\n          className=\"flex items-center gap-2 text-amber-600 font-medium\"\n        >\n          <span className=\"text-sm\">Flag</span>\n          <Flag size={20} />\n        </motion.div>\n      </div>\n\n      {/* Draggable Transaction Card */}\n      <motion.div\n        drag=\"x\"\n        dragConstraints={{ left: -150, right: 150 }}\n        dragElastic={0.2}\n        onDragStart={() => setIsDragging(true)}\n        onDragEnd={handleDragEnd}\n        style={{ x }}\n        className={cn(\n          \"flex items-center justify-between bg-background border-0 rounded-lg transition-colors relative z-10\",\n          isDragging ? \"cursor-grabbing\" : \"cursor-grab hover:bg-muted/50\"\n        )}\n      >\n        <div \n          className=\"flex items-center min-w-0 flex-1\" \n          style={{ \n            gap: 'var(--space-3)', \n            padding: 'var(--space-3)'\n          }}\n        >\n          <div \n            className=\"bg-muted rounded-lg flex items-center justify-center flex-shrink-0\"\n            style={{ width: '32px', height: '32px' }}\n          >\n            {getTransactionIcon(transaction.type)}\n          </div>\n          \n          <div className=\"flex-1 min-w-0\">\n            <h4 \n              className=\"font-medium text-foreground truncate\" \n              data-testid={`text-transaction-${transaction.id}`}\n              style={{ fontSize: 'var(--text-sm)' }}\n              title={transaction.description || transaction.category}\n            >\n              {transaction.description || transaction.category}\n            </h4>\n            <div \n              className=\"flex items-center text-muted-foreground\" \n              style={{ gap: 'var(--space-2)', fontSize: 'var(--text-xs)' }}\n            >\n              <span>{new Date(transaction.date).toLocaleDateString()}</span>\n              <span>•</span>\n              <span className=\"capitalize\">\n                {transaction.category.replace('_', ' ')}\n              </span>\n              {transaction.isArchived && (\n                <>\n                  <span>•</span>\n                  <span className=\"text-red-600 flex items-center gap-1\">\n                    <Archive size={12} />\n                    Archived\n                  </span>\n                </>\n              )}\n              {transaction.isFlagged && (\n                <>\n                  <span>•</span>\n                  <span className=\"text-amber-600 flex items-center gap-1\">\n                    <Flag size={12} />\n                    Flagged\n                  </span>\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n        \n        <div className=\"text-right flex-shrink-0\" style={{ paddingRight: 'var(--space-3)' }}>\n          <span \n            className={`font-semibold whitespace-nowrap ${getAmountColor(transaction.type)}`}\n            style={{ fontSize: 'var(--text-base)' }}\n            data-testid={`text-amount-${transaction.id}`}\n          >\n            {transaction.type === \"income\" ? \"+\" : \"-\"}{formatAmount(Math.abs(parseFloat(transaction.amount)))}\n          </span>\n          {transaction.goalId && (\n            <p \n              className=\"text-muted-foreground whitespace-nowrap\" \n              style={{ fontSize: 'var(--text-xs)' }}\n            >\n              Goal contribution\n            </p>\n          )}\n        </div>\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8184,"size_tokens":null},"client/src/components/ui/bottom-sheet.tsx":{"content":"import * as React from \"react\";\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\";\nimport { X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst BottomSheet = DialogPrimitive.Root;\n\nconst BottomSheetTrigger = DialogPrimitive.Trigger;\n\nconst BottomSheetPortal = DialogPrimitive.Portal;\n\nconst BottomSheetClose = DialogPrimitive.Close;\n\nconst BottomSheetOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n));\nBottomSheetOverlay.displayName = DialogPrimitive.Overlay.displayName;\n\nconst BottomSheetContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <BottomSheetPortal>\n    <BottomSheetOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed bottom-0 left-0 right-0 z-50 grid w-full gap-4 border-t bg-background p-6 shadow-lg\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out\",\n        \"data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n        \"data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        \"rounded-t-2xl\",\n        \"max-h-[85vh] overflow-y-auto\",\n        className\n      )}\n      {...props}\n    >\n      {/* Handle bar for visual affordance */}\n      <div className=\"mx-auto w-12 h-1.5 rounded-full bg-muted-foreground/20 mb-4\" />\n      \n      {children}\n      \n      <DialogPrimitive.Close \n        className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\"\n        data-testid=\"button-close-sheet\"\n      >\n        <X className=\"h-5 w-5\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </BottomSheetPortal>\n));\nBottomSheetContent.displayName = DialogPrimitive.Content.displayName;\n\nconst BottomSheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n);\nBottomSheetHeader.displayName = \"BottomSheetHeader\";\n\nconst BottomSheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col gap-2 sm:flex-row sm:justify-end\",\n      className\n    )}\n    {...props}\n  />\n);\nBottomSheetFooter.displayName = \"BottomSheetFooter\";\n\nconst BottomSheetTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n));\nBottomSheetTitle.displayName = DialogPrimitive.Title.displayName;\n\nconst BottomSheetDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nBottomSheetDescription.displayName = DialogPrimitive.Description.displayName;\n\nexport {\n  BottomSheet,\n  BottomSheetPortal,\n  BottomSheetOverlay,\n  BottomSheetTrigger,\n  BottomSheetClose,\n  BottomSheetContent,\n  BottomSheetHeader,\n  BottomSheetFooter,\n  BottomSheetTitle,\n  BottomSheetDescription,\n};\n","path":null,"size_bytes":4075,"size_tokens":null},"client/src/components/dialogs/responsive-transaction-dialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Plus } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  BottomSheet,\n  BottomSheetContent,\n  BottomSheetTrigger,\n} from \"@/components/ui/bottom-sheet\";\nimport TransactionForm from \"@/components/forms/transaction-form\";\n\ninterface ResponsiveTransactionDialogProps {\n  open?: boolean;\n  onOpenChange?: (open: boolean) => void;\n  triggerButton?: React.ReactNode;\n}\n\nexport function ResponsiveTransactionDialog({\n  open,\n  onOpenChange,\n  triggerButton,\n}: ResponsiveTransactionDialogProps) {\n  const [isMobile, setIsMobile] = useState(false);\n\n  useEffect(() => {\n    const checkMobile = () => {\n      setIsMobile(window.innerWidth < 768);\n    };\n\n    checkMobile();\n    window.addEventListener(\"resize\", checkMobile);\n\n    return () => window.removeEventListener(\"resize\", checkMobile);\n  }, []);\n\n  const defaultTrigger = (\n    <Button\n      className=\"bg-primary hover:bg-primary/90 text-primary-foreground shadow-sm min-h-[44px] hidden md:flex\"\n      data-testid=\"button-add-transaction\"\n    >\n      <Plus className=\"h-4 w-4 mr-2\" />\n      Add\n    </Button>\n  );\n\n  const handleSuccess = () => {\n    if (onOpenChange) {\n      onOpenChange(false);\n    }\n  };\n\n  if (isMobile) {\n    return (\n      <BottomSheet open={open} onOpenChange={onOpenChange}>\n        <BottomSheetTrigger asChild>\n          {triggerButton || defaultTrigger}\n        </BottomSheetTrigger>\n        <BottomSheetContent>\n          <TransactionForm onSuccess={handleSuccess} />\n        </BottomSheetContent>\n      </BottomSheet>\n    );\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogTrigger asChild>\n        {triggerButton || defaultTrigger}\n      </DialogTrigger>\n      <DialogContent className=\"max-w-md\">\n        <TransactionForm onSuccess={handleSuccess} />\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":1982,"size_tokens":null},"client/src/components/onboarding/progressive-onboarding-wizard.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { ChevronLeft, ChevronRight, Check, User, Target, Sparkles } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nconst step1Schema = z.object({\n  fullName: z.string().min(1, \"Name is required\"),\n  incomeRange: z.string().min(1, \"Please select your income range\"),\n  riskTolerance: z.string().min(1, \"Please select your risk tolerance\"),\n});\n\nconst step2Schema = z.object({\n  savingsTarget: z.string().min(1, \"Savings target is required\"),\n  savingsTimeline: z.string().min(1, \"Please select a timeline\"),\n  financialPriorities: z.array(z.string()).min(1, \"Select at least one priority\"),\n});\n\nconst step3Schema = z.object({\n  notificationFrequency: z.string().min(1, \"Please select a frequency\"),\n  adviceStyle: z.string().min(1, \"Please select a style\"),\n  preferredLanguage: z.string().min(1, \"Please select a language\"),\n});\n\ntype Step1Data = z.infer<typeof step1Schema>;\ntype Step2Data = z.infer<typeof step2Schema>;\ntype Step3Data = z.infer<typeof step3Schema>;\n\ninterface ProgressiveOnboardingWizardProps {\n  onComplete: () => void;\n}\n\nexport function ProgressiveOnboardingWizard({ onComplete }: ProgressiveOnboardingWizardProps) {\n  const [currentStep, setCurrentStep] = useState(1);\n  const [step1Data, setStep1Data] = useState<Step1Data | null>(null);\n  const [step2Data, setStep2Data] = useState<Step2Data | null>(null);\n  const [isHydrated, setIsHydrated] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: userPreferences, isLoading: prefsLoading } = useQuery<any>({\n    queryKey: [\"/api/user-preferences\"],\n  });\n\n  const step1Form = useForm<Step1Data>({\n    resolver: zodResolver(step1Schema),\n    defaultValues: {\n      fullName: \"\",\n      incomeRange: \"\",\n      riskTolerance: \"\",\n    },\n  });\n\n  const step2Form = useForm<Step2Data>({\n    resolver: zodResolver(step2Schema),\n    defaultValues: {\n      savingsTarget: \"\",\n      savingsTimeline: \"\",\n      financialPriorities: [],\n    },\n  });\n\n  const step3Form = useForm<Step3Data>({\n    resolver: zodResolver(step3Schema),\n    defaultValues: {\n      notificationFrequency: \"weekly\",\n      adviceStyle: \"conversational\",\n      preferredLanguage: \"en\",\n    },\n  });\n\n  useEffect(() => {\n    if (!prefsLoading && !isHydrated) {\n      const savedData = userPreferences?.onboardingData || {};\n      const savedStep = userPreferences?.onboardingStep || 1;\n\n      if (savedData && Object.keys(savedData).length > 0) {\n        if (savedData.fullName || savedData.incomeRange || savedData.riskTolerance) {\n          step1Form.reset({\n            fullName: savedData.fullName || \"\",\n            incomeRange: savedData.incomeRange || \"\",\n            riskTolerance: savedData.riskTolerance || \"\",\n          });\n          setStep1Data({\n            fullName: savedData.fullName || \"\",\n            incomeRange: savedData.incomeRange || \"\",\n            riskTolerance: savedData.riskTolerance || \"\",\n          });\n        }\n\n        if (savedData.savingsTarget || savedData.savingsTimeline || savedData.financialPriorities) {\n          step2Form.reset({\n            savingsTarget: savedData.savingsTarget?.toString() || \"\",\n            savingsTimeline: savedData.savingsTimeline || \"\",\n            financialPriorities: savedData.financialPriorities || [],\n          });\n          setStep2Data({\n            savingsTarget: savedData.savingsTarget?.toString() || \"\",\n            savingsTimeline: savedData.savingsTimeline || \"\",\n            financialPriorities: savedData.financialPriorities || [],\n          });\n        }\n\n        if (savedData.notificationFrequency || savedData.adviceStyle || savedData.preferredLanguage) {\n          step3Form.reset({\n            notificationFrequency: savedData.notificationFrequency || \"weekly\",\n            adviceStyle: savedData.adviceStyle || \"conversational\",\n            preferredLanguage: savedData.preferredLanguage || \"en\",\n          });\n        }\n\n        setCurrentStep(savedStep);\n      }\n\n      setIsHydrated(true);\n    }\n  }, [prefsLoading, isHydrated, userPreferences, step1Form, step2Form, step3Form]);\n\n  const saveProgressMutation = useMutation({\n    mutationFn: async (data: { step: number; data: any }) => {\n      const response = await apiRequest(\"PUT\", \"/api/user-preferences/onboarding\", {\n        onboardingStep: data.step,\n        onboardingData: data.data,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-preferences\"] });\n    },\n  });\n\n  const completeOnboardingMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"PUT\", \"/api/user-preferences\", {\n        hasCompletedOnboarding: true,\n        onboardingStep: null,\n        onboardingData: data,\n        language: data.preferredLanguage || \"en\",\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-preferences\"] });\n      toast({\n        title: \"Welcome to Twealth!\",\n        description: \"Your profile has been set up successfully.\",\n      });\n      onComplete();\n    },\n  });\n\n  const handleStep1Submit = (data: Step1Data) => {\n    setStep1Data(data);\n    saveProgressMutation.mutate({ step: 2, data });\n    setCurrentStep(2);\n  };\n\n  const handleStep2Submit = (data: Step2Data) => {\n    setStep2Data(data);\n    saveProgressMutation.mutate({ step: 3, data: { ...step1Data, ...data } });\n    setCurrentStep(3);\n  };\n\n  const handleStep3Submit = (data: Step3Data) => {\n    const finalData = {\n      ...step1Data,\n      ...step2Data,\n      ...data,\n      savingsTarget: step2Data ? parseFloat(step2Data.savingsTarget) : 0,\n    };\n    completeOnboardingMutation.mutate(finalData);\n  };\n\n  const steps = [\n    { number: 1, title: \"Your Profile\", icon: User },\n    { number: 2, title: \"Financial Goals\", icon: Target },\n    { number: 3, title: \"AI Preferences\", icon: Sparkles },\n  ];\n\n  if (prefsLoading || !isHydrated) {\n    return (\n      <div className=\"w-full max-w-xl mx-auto\">\n        <div className=\"bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-8 shadow-2xl backdrop-blur-sm\">\n          <div className=\"text-center mb-6\">\n            <h2 className=\"text-xl font-semibold text-white mb-2\">Loading your profile...</h2>\n            <p className=\"text-slate-400\">Please wait a moment</p>\n          </div>\n          <div className=\"space-y-4\">\n            <div className=\"h-14 bg-slate-800/80 rounded-2xl animate-pulse\"></div>\n            <div className=\"h-14 bg-slate-800/80 rounded-2xl animate-pulse\"></div>\n            <div className=\"h-14 bg-slate-800/80 rounded-2xl animate-pulse\"></div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-xl mx-auto\">\n      <div className=\"mb-10\">\n        <div className=\"flex items-center justify-center gap-2 sm:gap-4\">\n          {steps.map((step, index) => {\n            const Icon = step.icon;\n            const isComplete = currentStep > step.number;\n            const isCurrent = currentStep === step.number;\n            \n            return (\n              <div key={step.number} className=\"flex items-center\">\n                <div className=\"flex flex-col items-center\">\n                  <div\n                    className={`\n                      w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center mb-2 transition-all duration-500 ease-out\n                      ${isComplete ? \"bg-gradient-to-br from-green-500 to-green-600 text-white shadow-lg shadow-green-500/30\" : \"\"}\n                      ${isCurrent ? \"bg-gradient-to-br from-blue-500 to-blue-600 text-white ring-4 ring-blue-500/30 shadow-lg shadow-blue-500/30 scale-110\" : \"\"}\n                      ${!isComplete && !isCurrent ? \"bg-slate-800 text-slate-500 border border-slate-700\" : \"\"}\n                    `}\n                    data-testid={`step-indicator-${step.number}`}\n                  >\n                    {isComplete ? <Check className=\"h-6 w-6\" /> : <Icon className=\"h-6 w-6\" />}\n                  </div>\n                  <span\n                    className={`text-xs sm:text-sm font-medium transition-colors ${\n                      isCurrent ? \"text-white\" : isComplete ? \"text-green-400\" : \"text-slate-500\"\n                    }`}\n                  >\n                    {step.title}\n                  </span>\n                </div>\n                {index < steps.length - 1 && (\n                  <div\n                    className={`w-12 sm:w-20 h-1 mx-3 sm:mx-4 rounded-full transition-all duration-500 ${\n                      isComplete ? \"bg-gradient-to-r from-green-500 to-green-400\" : \"bg-slate-800\"\n                    }`}\n                  />\n                )}\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {currentStep === 1 && (\n        <div className=\"bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-7 sm:p-9 shadow-2xl backdrop-blur-sm\">\n          <div className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-2\">Tell us about yourself</h2>\n            <p className=\"text-slate-400\">Help us personalize your financial guidance</p>\n          </div>\n          <Form {...step1Form}>\n            <form onSubmit={step1Form.handleSubmit(handleStep1Submit)} className=\"space-y-6\">\n              <FormField\n                control={step1Form.control}\n                name=\"fullName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Full Name</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"John Doe\"\n                        {...field}\n                        data-testid=\"input-full-name\"\n                        className=\"h-14 bg-slate-800/80 border-slate-600 text-white placeholder:text-slate-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base transition-all duration-200\"\n                      />\n                    </FormControl>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step1Form.control}\n                name=\"incomeRange\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Annual Income Range</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-income-range\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue placeholder=\"Select your income range\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl\">\n                        <SelectItem value=\"under_30k\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Under $30,000</SelectItem>\n                        <SelectItem value=\"30k-60k\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">$30,000 - $60,000</SelectItem>\n                        <SelectItem value=\"60k-100k\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">$60,000 - $100,000</SelectItem>\n                        <SelectItem value=\"100k-200k\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">$100,000 - $200,000</SelectItem>\n                        <SelectItem value=\"over_200k\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Over $200,000</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormDescription className=\"text-slate-500 text-sm mt-2\">\n                      This helps us provide appropriate recommendations\n                    </FormDescription>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step1Form.control}\n                name=\"riskTolerance\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Risk Tolerance</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-risk-tolerance\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue placeholder=\"How comfortable are you with risk?\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl\">\n                        <SelectItem value=\"conservative\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">\n                          Conservative - Prefer safe investments\n                        </SelectItem>\n                        <SelectItem value=\"moderate\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">\n                          Moderate - Balance safety and growth\n                        </SelectItem>\n                        <SelectItem value=\"aggressive\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">\n                          Aggressive - Higher risk for returns\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-end pt-6\">\n                <Button\n                  type=\"submit\"\n                  className=\"h-14 px-10 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-2xl shadow-lg shadow-blue-600/25 hover:shadow-xl hover:shadow-blue-500/30 transition-all duration-300\"\n                  data-testid=\"button-next-step-1\"\n                  disabled={saveProgressMutation.isPending}\n                >\n                  Continue\n                  <ChevronRight className=\"ml-2 h-5 w-5\" />\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      )}\n\n      {currentStep === 2 && (\n        <div className=\"bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-7 sm:p-9 shadow-2xl backdrop-blur-sm\">\n          <div className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-2\">Your Financial Goals</h2>\n            <p className=\"text-slate-400\">What are you working towards?</p>\n          </div>\n          <Form {...step2Form}>\n            <form onSubmit={step2Form.handleSubmit(handleStep2Submit)} className=\"space-y-6\">\n              <FormField\n                control={step2Form.control}\n                name=\"savingsTarget\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Savings Target</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        placeholder=\"10000\"\n                        {...field}\n                        data-testid=\"input-savings-target\"\n                        className=\"h-14 bg-slate-800/80 border-slate-600 text-white placeholder:text-slate-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base transition-all duration-200\"\n                      />\n                    </FormControl>\n                    <FormDescription className=\"text-slate-500 text-sm mt-2\">\n                      How much would you like to save? (in your local currency)\n                    </FormDescription>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step2Form.control}\n                name=\"savingsTimeline\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Timeline</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-savings-timeline\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue placeholder=\"When do you want to reach your goal?\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl\">\n                        <SelectItem value=\"3months\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">3 months</SelectItem>\n                        <SelectItem value=\"6months\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">6 months</SelectItem>\n                        <SelectItem value=\"1year\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">1 year</SelectItem>\n                        <SelectItem value=\"3years\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">3 years</SelectItem>\n                        <SelectItem value=\"5years+\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">5+ years</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step2Form.control}\n                name=\"financialPriorities\"\n                render={() => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Financial Priorities</FormLabel>\n                    <p className=\"text-slate-500 text-sm mb-4\">Select all that apply</p>\n                    <div className=\"space-y-3\">\n                      {[\n                        { id: \"emergency_fund\", label: \"Build Emergency Fund\" },\n                        { id: \"retirement\", label: \"Plan for Retirement\" },\n                        { id: \"debt_payoff\", label: \"Pay Off Debt\" },\n                        { id: \"investment\", label: \"Invest for Growth\" },\n                        { id: \"major_purchase\", label: \"Save for Major Purchase\" },\n                      ].map((priority) => (\n                        <FormField\n                          key={priority.id}\n                          control={step2Form.control}\n                          name=\"financialPriorities\"\n                          render={({ field }) => (\n                            <FormItem className=\"flex items-center space-x-4 space-y-0 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50 hover:border-slate-600 transition-colors cursor-pointer group\">\n                              <FormControl>\n                                <Checkbox\n                                  checked={field.value?.includes(priority.id)}\n                                  onCheckedChange={(checked) => {\n                                    const newValue = checked\n                                      ? [...(field.value || []), priority.id]\n                                      : (field.value || []).filter((v) => v !== priority.id);\n                                    field.onChange(newValue);\n                                  }}\n                                  data-testid={`checkbox-priority-${priority.id}`}\n                                  className=\"h-6 w-6 border-2 border-slate-500 data-[state=checked]:bg-blue-600 data-[state=checked]:border-blue-600 rounded-lg transition-all\"\n                                />\n                              </FormControl>\n                              <FormLabel className=\"font-normal text-slate-200 cursor-pointer text-base group-hover:text-white transition-colors\">\n                                {priority.label}\n                              </FormLabel>\n                            </FormItem>\n                          )}\n                        />\n                      ))}\n                    </div>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-between pt-6\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  onClick={() => setCurrentStep(1)}\n                  className=\"h-14 px-8 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-2xl transition-all duration-200\"\n                  data-testid=\"button-back-step-2\"\n                >\n                  <ChevronLeft className=\"mr-2 h-5 w-5\" />\n                  Back\n                </Button>\n                <Button\n                  type=\"submit\"\n                  className=\"h-14 px-10 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-semibold rounded-2xl shadow-lg shadow-blue-600/25 hover:shadow-xl hover:shadow-blue-500/30 transition-all duration-300\"\n                  data-testid=\"button-next-step-2\"\n                  disabled={saveProgressMutation.isPending}\n                >\n                  Continue\n                  <ChevronRight className=\"ml-2 h-5 w-5\" />\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      )}\n\n      {currentStep === 3 && (\n        <div className=\"bg-gradient-to-b from-slate-900 to-slate-900/80 border border-slate-700/80 rounded-3xl p-7 sm:p-9 shadow-2xl backdrop-blur-sm\">\n          <div className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-2\">Customize Your AI Assistant</h2>\n            <p className=\"text-slate-400\">How would you like your AI to help you?</p>\n          </div>\n          <Form {...step3Form}>\n            <form onSubmit={step3Form.handleSubmit(handleStep3Submit)} className=\"space-y-6\">\n              <FormField\n                control={step3Form.control}\n                name=\"notificationFrequency\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Notification Frequency</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-notification-frequency\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl\">\n                        <SelectItem value=\"daily\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Daily insights</SelectItem>\n                        <SelectItem value=\"weekly\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Weekly summaries</SelectItem>\n                        <SelectItem value=\"monthly\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Monthly reports</SelectItem>\n                        <SelectItem value=\"never\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Only when I ask</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step3Form.control}\n                name=\"adviceStyle\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Advice Style</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-advice-style\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl\">\n                        <SelectItem value=\"detailed\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Detailed analysis with numbers</SelectItem>\n                        <SelectItem value=\"concise\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Concise actionable points</SelectItem>\n                        <SelectItem value=\"conversational\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Conversational and friendly</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={step3Form.control}\n                name=\"preferredLanguage\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-slate-200 text-sm font-medium\">Preferred Language</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger \n                          data-testid=\"select-preferred-language\" \n                          className=\"h-14 bg-slate-800/80 border-slate-600 text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 rounded-2xl text-base\"\n                        >\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent className=\"bg-slate-800 border-slate-600 rounded-xl max-h-[280px]\">\n                        <SelectItem value=\"en\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">English</SelectItem>\n                        <SelectItem value=\"es\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Espanol</SelectItem>\n                        <SelectItem value=\"ar\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Arabic</SelectItem>\n                        <SelectItem value=\"hi\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Hindi</SelectItem>\n                        <SelectItem value=\"id\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Bahasa Indonesia</SelectItem>\n                        <SelectItem value=\"ms\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Bahasa Melayu</SelectItem>\n                        <SelectItem value=\"pt\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Portugues</SelectItem>\n                        <SelectItem value=\"th\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Thai</SelectItem>\n                        <SelectItem value=\"tl\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Tagalog</SelectItem>\n                        <SelectItem value=\"tr\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Turkish</SelectItem>\n                        <SelectItem value=\"vi\" className=\"text-white focus:bg-slate-700 rounded-lg py-3\">Vietnamese</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage className=\"text-red-400\" />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"flex justify-between pt-6\">\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  onClick={() => setCurrentStep(2)}\n                  className=\"h-14 px-8 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-2xl transition-all duration-200\"\n                  data-testid=\"button-back-step-3\"\n                >\n                  <ChevronLeft className=\"mr-2 h-5 w-5\" />\n                  Back\n                </Button>\n                <Button\n                  type=\"submit\"\n                  className=\"h-14 px-10 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-semibold rounded-2xl shadow-lg shadow-green-600/25 hover:shadow-xl hover:shadow-green-500/30 transition-all duration-300\"\n                  data-testid=\"button-complete-onboarding\"\n                  disabled={completeOnboardingMutation.isPending}\n                >\n                  {completeOnboardingMutation.isPending ? \"Finishing...\" : \"Complete Setup\"}\n                  <Check className=\"ml-2 h-5 w-5\" />\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":30423,"size_tokens":null},"client/src/components/ai/floating-ai-widget.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { Sparkles, X, Send, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\n\ninterface ChatMessage {\n  id: string;\n  conversationId: string;\n  role: 'user' | 'assistant';\n  content: string;\n  createdAt: string;\n}\n\ninterface QuickAction {\n  label: string;\n  prompt: string;\n}\n\nconst quickActions: QuickAction[] = [\n  { label: \"Add transaction\", prompt: \"Help me log a transaction\" },\n  { label: \"Create goal\", prompt: \"I want to create a savings goal\" },\n  { label: \"Budget advice\", prompt: \"Give me budget advice based on my spending\" },\n  { label: \"Savings tips\", prompt: \"How can I save more money?\" },\n];\n\nexport default function FloatingAIWidget() {\n  const [location] = useLocation();\n  const [isOpen, setIsOpen] = useState(false);\n  const [message, setMessage] = useState(\"\");\n  const [conversationId, setConversationId] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  \n  // Guard to prevent multiple conversation creation attempts\n  const isCreatingConversation = useRef(false);\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  // Create conversation mutation - defined before useEffect that uses it\n  const createConversation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/chat/conversations\", {\n        title: \"Quick Chat\"\n      });\n      return await response.json();\n    },\n    onSuccess: (data) => {\n      setConversationId(data.id);\n      isCreatingConversation.current = false;\n    },\n    onError: () => {\n      isCreatingConversation.current = false;\n    },\n  });\n\n  // Fetch or create conversation\n  const { data: conversations = [], isFetched } = useQuery<any[]>({\n    queryKey: [\"/api/chat/conversations\"],\n    enabled: isOpen,\n    staleTime: 30000, // Cache for 30 seconds to prevent excessive refetches\n  });\n\n  // Get or create conversation on open - with proper guards\n  useEffect(() => {\n    // Only run when widget is open and data has been fetched\n    if (!isOpen || !isFetched) return;\n    \n    // If we already have a conversation ID, don't do anything\n    if (conversationId) return;\n    \n    // If conversations exist, use the first one\n    if (conversations.length > 0) {\n      setConversationId(conversations[0].id);\n      return;\n    }\n    \n    // Only create if not already creating and mutation not pending\n    if (!isCreatingConversation.current && !createConversation.isPending) {\n      isCreatingConversation.current = true;\n      createConversation.mutate();\n    }\n  }, [isOpen, isFetched, conversations.length, conversationId, createConversation.isPending]);\n\n  // Fetch messages\n  const { data: currentConversation } = useQuery<any>({\n    queryKey: [\"/api/chat/conversations\", conversationId],\n    enabled: !!conversationId && isOpen,\n  });\n\n  const messages = currentConversation?.messages || [];\n\n  // Send message mutation\n  const sendMessage = useMutation({\n    mutationFn: async (content: string) => {\n      if (!conversationId) throw new Error(\"No conversation\");\n      const response = await apiRequest(\"POST\", `/api/chat/conversations/${conversationId}/messages`, {\n        content,\n        mode: \"quick\"\n      });\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/conversations\", conversationId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial-goals\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n      setMessage(\"\");\n      scrollToBottom();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send message\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSend = () => {\n    if (message.trim() && !sendMessage.isPending) {\n      sendMessage.mutate(message.trim());\n    }\n  };\n\n  const handleQuickAction = (prompt: string) => {\n    setMessage(prompt);\n    if (!sendMessage.isPending) {\n      sendMessage.mutate(prompt);\n    }\n  };\n\n  // Hide widget on AI Assistant page (after all hooks are called)\n  if (location?.startsWith('/ai-assistant')) {\n    return null;\n  }\n\n  if (!isOpen) {\n    return (\n      <div \n        className=\"fixed right-4 z-50 bottom-[calc(72px+env(safe-area-inset-bottom,0px))] md:bottom-6 md:right-6\"\n      >\n        <Button\n          onClick={() => setIsOpen(true)}\n          size=\"lg\"\n          className=\"rounded-full h-12 w-12 min-h-[48px] min-w-[48px] shadow-lg\"\n          data-testid=\"button-open-ai-widget\"\n        >\n          <Sparkles className=\"h-5 w-5\" />\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div \n      className=\"fixed right-2 z-50 w-[calc(100vw-16px)] sm:w-96 max-w-[400px] bottom-[calc(72px+env(safe-area-inset-bottom,0px))] md:bottom-6 md:right-6\"\n    >\n      <Card className=\"shadow-2xl\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-1.5 bg-primary/10 rounded-lg\">\n                <Sparkles className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-lg\">AI Assistant</CardTitle>\n                <CardDescription className=\"text-xs\">Ask me anything</CardDescription>\n              </div>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setIsOpen(false)}\n              data-testid=\"button-close-ai-widget\"\n              aria-label=\"Close AI assistant\"\n              className=\"min-w-[44px] min-h-[44px]\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          {/* Quick Actions */}\n          {messages.length === 0 && (\n            <div className=\"px-4 pb-3\">\n              <div className=\"grid grid-cols-2 gap-2\">\n                {quickActions.map((action, idx) => (\n                  <button\n                    key={idx}\n                    onClick={() => handleQuickAction(action.prompt)}\n                    className=\"p-3 text-left border rounded-lg hover:bg-muted transition-colors text-sm\"\n                    data-testid={`quick-action-${idx}`}\n                  >\n                    <div className=\"font-medium\">{action.label}</div>\n                  </button>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Messages */}\n          <div className=\"h-96 overflow-y-auto px-4 pb-4 space-y-3\">\n            {messages.map((msg: ChatMessage) => (\n              <div\n                key={msg.id}\n                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}\n              >\n                <div\n                  className={`max-w-[85%] rounded-lg px-3 py-2 text-sm ${\n                    msg.role === 'user'\n                      ? 'bg-primary text-primary-foreground'\n                      : 'bg-muted'\n                  }`}\n                >\n                  {msg.content}\n                </div>\n              </div>\n            ))}\n            {sendMessage.isPending && (\n              <div className=\"flex justify-start\">\n                <div className=\"bg-muted rounded-lg px-3 py-2 text-sm flex items-center gap-2\">\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  Thinking...\n                </div>\n              </div>\n            )}\n            <div ref={messagesEndRef} />\n          </div>\n\n          {/* Input */}\n          <div className=\"p-4 border-t\">\n            <div className=\"flex gap-2\">\n              <Input\n                value={message}\n                onChange={(e) => setMessage(e.target.value)}\n                onKeyDown={(e) => e.key === 'Enter' && handleSend()}\n                placeholder=\"Ask anything...\"\n                disabled={sendMessage.isPending}\n                className=\"flex-1\"\n                data-testid=\"input-ai-message\"\n              />\n              <Button\n                onClick={handleSend}\n                disabled={!message.trim() || sendMessage.isPending}\n                size=\"sm\"\n                data-testid=\"button-send-ai-message\"\n                aria-label=\"Send message\"\n                className=\"min-w-[44px] min-h-[44px]\"\n              >\n                <Send className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":9057,"size_tokens":null},"client/src/components/dashboard/predictive-insights-dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  TrendingUp, \n  TrendingDown, \n  Minus,\n  Target,\n  AlertTriangle,\n  CheckCircle2,\n  DollarSign,\n  Calendar,\n  ArrowRight,\n  Brain,\n  Lightbulb\n} from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\ninterface SpendingForecast {\n  category: string;\n  historicalAverage: number;\n  predictedAmount: number;\n  confidence: 'high' | 'medium' | 'low';\n  trend: 'increasing' | 'stable' | 'decreasing';\n  percentChange: number;\n}\n\ninterface GoalPrediction {\n  goalId: string;\n  goalTitle: string;\n  currentProgress: number;\n  predictedCompletionDate: string;\n  onTrack: boolean;\n  probability: number;\n  requiredMonthlyContribution: number;\n  recommendedAction: string;\n}\n\ninterface CashFlowForecast {\n  date: string;\n  projectedBalance: number;\n  projectedIncome: number;\n  projectedExpenses: number;\n  riskLevel: 'low' | 'medium' | 'high';\n}\n\ninterface Anomaly {\n  type: 'spending_spike' | 'income_drop' | 'unusual_pattern' | 'goal_at_risk';\n  severity: 'critical' | 'warning' | 'info';\n  title: string;\n  description: string;\n  affectedCategory?: string;\n  suggestedAction: string;\n  detectedAt: string;\n}\n\ninterface SavingsOpportunity {\n  category: string;\n  potentialSavings: number;\n  confidence: number;\n  timeframe: 'weekly' | 'monthly';\n  suggestion: string;\n  difficulty: 'easy' | 'medium' | 'hard';\n}\n\nexport default function PredictiveInsightsDashboard() {\n  const { formatAmount } = useUserCurrency();\n  \n  const { data: spendingForecast = [], isLoading: loadingForecast } = useQuery<SpendingForecast[]>({\n    queryKey: [\"/api/predictive/spending-forecast?days=30\"],\n  });\n\n  const { data: goalPredictions = [], isLoading: loadingGoals } = useQuery<GoalPrediction[]>({\n    queryKey: [\"/api/predictive/goal-predictions\"],\n  });\n\n  const { data: cashFlowForecast = [], isLoading: loadingCashFlow } = useQuery<CashFlowForecast[]>({\n    queryKey: [\"/api/predictive/cash-flow-forecast\"],\n  });\n\n  const { data: anomalies = [], isLoading: loadingAnomalies } = useQuery<Anomaly[]>({\n    queryKey: [\"/api/predictive/anomalies\"],\n  });\n\n  const { data: savingsOpportunities = [], isLoading: loadingOpportunities } = useQuery<SavingsOpportunity[]>({\n    queryKey: [\"/api/predictive/savings-opportunities\"],\n  });\n\n  const getTrendIcon = (trend: 'increasing' | 'stable' | 'decreasing') => {\n    if (trend === 'increasing') return <TrendingUp className=\"h-4 w-4 text-red-600\" />;\n    if (trend === 'decreasing') return <TrendingDown className=\"h-4 w-4 text-green-600\" />;\n    return <Minus className=\"h-4 w-4 text-gray-600\" />;\n  };\n\n  const getConfidenceBadge = (confidence: 'high' | 'medium' | 'low') => {\n    const variants: Record<string, 'default' | 'secondary' | 'outline'> = {\n      high: 'default',\n      medium: 'secondary',\n      low: 'outline'\n    };\n    return <Badge variant={variants[confidence]}>{confidence} confidence</Badge>;\n  };\n\n  const getSeverityColor = (severity: 'critical' | 'warning' | 'info') => {\n    if (severity === 'critical') return 'text-red-600';\n    if (severity === 'warning') return 'text-yellow-600';\n    return 'text-blue-600';\n  };\n\n  if (loadingForecast && loadingGoals && loadingCashFlow) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Brain className=\"h-5 w-5\" />\n            Predictive Insights\n          </CardTitle>\n          <CardDescription>AI-powered forecasts and predictions loading...</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map(i => (\n              <div key={i} className=\"h-20 bg-muted rounded\"></div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-2xl\">\n            <Brain className=\"h-6 w-6\" />\n            Predictive Insights\n          </CardTitle>\n          <CardDescription>AI-powered forecasts, predictions, and early warnings</CardDescription>\n        </CardHeader>\n      </Card>\n\n      {/* Anomalies & Alerts */}\n      {anomalies.length > 0 && (\n        <Card className=\"border-yellow-200 bg-yellow-50 dark:bg-yellow-950/10\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\n              Early Warnings ({anomalies.length})\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {anomalies.map((anomaly, idx) => (\n                <div\n                  key={idx}\n                  className=\"p-4 bg-background rounded-lg border\"\n                  data-testid={`anomaly-${idx}`}\n                >\n                  <div className=\"flex items-start justify-between mb-2\">\n                    <h4 className={`font-semibold ${getSeverityColor(anomaly.severity)}`}>\n                      {anomaly.title}\n                    </h4>\n                    <Badge variant={anomaly.severity === 'critical' ? 'destructive' : 'outline'}>\n                      {anomaly.severity}\n                    </Badge>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground mb-2\">{anomaly.description}</p>\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <ArrowRight className=\"h-4 w-4 text-primary\" />\n                    <span className=\"font-medium\">Action:</span>\n                    <span className=\"text-muted-foreground\">{anomaly.suggestedAction}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Tabs defaultValue=\"spending\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-4\">\n          <TabsTrigger value=\"spending\">Spending Forecast</TabsTrigger>\n          <TabsTrigger value=\"goals\">Goal Predictions</TabsTrigger>\n          <TabsTrigger value=\"cashflow\">Cash Flow</TabsTrigger>\n          <TabsTrigger value=\"savings\">Savings</TabsTrigger>\n        </TabsList>\n\n        {/* Spending Forecast */}\n        <TabsContent value=\"spending\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-xl\">Next 30 Days Spending Forecast</CardTitle>\n              <CardDescription>Predicted spending by category</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {spendingForecast.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  Not enough data to generate forecast. Add more transactions to see predictions.\n                </p>\n              ) : (\n                <div className=\"space-y-4\">\n                  {spendingForecast.slice(0, 5).map((forecast, idx) => (\n                    <div key={idx} className=\"p-4 border rounded-lg\" data-testid={`forecast-${idx}`}>\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"font-semibold text-lg capitalize\">{forecast.category}</div>\n                          {getTrendIcon(forecast.trend)}\n                        </div>\n                        {getConfidenceBadge(forecast.confidence)}\n                      </div>\n                      <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                        <div>\n                          <div className=\"text-muted-foreground\">Historical Avg</div>\n                          <div className=\"font-semibold\">{formatAmount(forecast.historicalAverage ?? 0)}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-muted-foreground\">Predicted</div>\n                          <div className=\"font-semibold text-primary\">{formatAmount(forecast.predictedAmount ?? 0)}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-muted-foreground\">Change</div>\n                          <div className={`font-semibold ${(forecast.percentChange ?? 0) > 0 ? 'text-red-600' : 'text-green-600'}`}>\n                            {(forecast.percentChange ?? 0) > 0 ? '+' : ''}{forecast.percentChange?.toFixed(1) ?? '0.0'}%\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Goal Predictions */}\n        <TabsContent value=\"goals\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-xl\">Goal Achievement Predictions</CardTitle>\n              <CardDescription>AI-predicted goal completion probability</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {goalPredictions.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  No active goals. Create a goal to see predictions.\n                </p>\n              ) : (\n                <div className=\"space-y-4\">\n                  {goalPredictions.map((prediction, idx) => (\n                    <div key={idx} className=\"p-4 border rounded-lg\" data-testid={`goal-prediction-${idx}`}>\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div>\n                          <h4 className=\"font-semibold text-lg\">{prediction.goalTitle}</h4>\n                          <div className=\"text-sm text-muted-foreground mt-1\">\n                            Predicted completion: {new Date(prediction.predictedCompletionDate).toLocaleDateString()}\n                          </div>\n                        </div>\n                        {prediction.onTrack ? (\n                          <Badge className=\"bg-green-600\">\n                            <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                            On Track\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"destructive\">\n                            <AlertTriangle className=\"h-3 w-3 mr-1\" />\n                            At Risk\n                          </Badge>\n                        )}\n                      </div>\n                      <div className=\"space-y-3\">\n                        <div>\n                          <div className=\"flex items-center justify-between text-sm mb-1\">\n                            <span>Success Probability</span>\n                            <span className=\"font-semibold\">{prediction.probability}%</span>\n                          </div>\n                          <Progress value={prediction.probability} className=\"h-2\" />\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                          <div>\n                            <div className=\"text-muted-foreground\">Current Progress</div>\n                            <div className=\"font-semibold\">{prediction.currentProgress?.toFixed(0) ?? '0'}%</div>\n                          </div>\n                          <div>\n                            <div className=\"text-muted-foreground\">Monthly Required</div>\n                            <div className=\"font-semibold\">{formatAmount(prediction.requiredMonthlyContribution ?? 0)}</div>\n                          </div>\n                        </div>\n                        <div className=\"p-3 bg-muted rounded-lg text-sm\">\n                          <div className=\"font-medium mb-1\">Recommendation:</div>\n                          <div className=\"text-muted-foreground\">{prediction.recommendedAction}</div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Cash Flow Forecast */}\n        <TabsContent value=\"cashflow\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-xl\">90-Day Cash Flow Forecast</CardTitle>\n              <CardDescription>Projected balance over time</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {cashFlowForecast.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  Not enough data to generate cash flow forecast.\n                </p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {cashFlowForecast.map((forecast, idx) => (\n                    <div key={idx} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                      <div className=\"flex items-center gap-4\">\n                        <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                        <div>\n                          <div className=\"font-semibold\">{new Date(forecast.date).toLocaleDateString()}</div>\n                          <div className=\"text-sm text-muted-foreground\">\n                            {formatAmount(forecast.projectedBalance ?? 0)} balance\n                          </div>\n                        </div>\n                      </div>\n                      <Badge variant={\n                        forecast.riskLevel === 'low' ? 'default' : \n                        forecast.riskLevel === 'medium' ? 'secondary' : \n                        'destructive'\n                      }>\n                        {forecast.riskLevel} risk\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Savings Opportunities */}\n        <TabsContent value=\"savings\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-xl\">Savings Opportunities</CardTitle>\n              <CardDescription>AI-identified ways to save money</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {savingsOpportunities.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  No savings opportunities identified yet. Keep tracking expenses.\n                </p>\n              ) : (\n                <div className=\"space-y-4\">\n                  {savingsOpportunities.map((opportunity, idx) => (\n                    <div key={idx} className=\"p-4 border rounded-lg bg-green-50 dark:bg-green-950/20\">\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div className=\"flex items-center gap-2\">\n                          <Lightbulb className=\"h-5 w-5 text-green-600\" />\n                          <h4 className=\"font-semibold capitalize\">{opportunity.category}</h4>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-2xl font-bold text-green-600\">\n                            {formatAmount(opportunity.potentialSavings)}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">per {opportunity.timeframe}</div>\n                        </div>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mb-3\">{opportunity.suggestion}</p>\n                      <div className=\"flex items-center gap-4 text-xs\">\n                        <Badge variant=\"outline\">\n                          {opportunity.difficulty} to implement\n                        </Badge>\n                        <Badge variant=\"outline\">\n                          {((opportunity.confidence ?? 0) * 100).toFixed(0)}% confidence\n                        </Badge>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":16484,"size_tokens":null},"server/predictiveAnalyticsService.ts":{"content":"// Predictive Analytics Service\n// Provides forecasting, predictions, and early warning systems for financial data\n\nimport { storage } from \"./storage\";\n\ninterface SpendingForecast {\n  category: string;\n  historicalAverage: number;\n  predictedAmount: number;\n  confidence: 'high' | 'medium' | 'low';\n  trend: 'increasing' | 'stable' | 'decreasing';\n  percentChange: number;\n}\n\ninterface GoalPrediction {\n  goalId: string;\n  goalTitle: string;\n  currentProgress: number;\n  predictedCompletionDate: string;\n  onTrack: boolean;\n  probability: number;\n  requiredMonthlyContribution: number;\n  recommendedAction: string;\n}\n\ninterface CashFlowForecast {\n  date: string;\n  projectedBalance: number;\n  projectedIncome: number;\n  projectedExpenses: number;\n  riskLevel: 'low' | 'medium' | 'high';\n}\n\ninterface Anomaly {\n  type: 'spending_spike' | 'income_drop' | 'unusual_pattern' | 'goal_at_risk';\n  severity: 'critical' | 'warning' | 'info';\n  title: string;\n  description: string;\n  affectedCategory?: string;\n  suggestedAction: string;\n  detectedAt: string;\n}\n\ninterface SavingsOpportunity {\n  category: string;\n  potentialSavings: number;\n  confidence: number;\n  timeframe: 'weekly' | 'monthly';\n  suggestion: string;\n  difficulty: 'easy' | 'medium' | 'hard';\n}\n\nexport class PredictiveAnalyticsService {\n  /**\n   * Forecast spending by category for next 30 or 90 days\n   */\n  async forecastSpending(userId: string, days: 30 | 90 = 30): Promise<SpendingForecast[]> {\n    const transactions = await storage.getTransactionsByUserId(userId);\n    const now = new Date();\n    const historicalDays = Math.min(days * 3, 180); // Use 3x forecast period for historical data\n    const cutoffDate = new Date(now.getTime() - historicalDays * 24 * 60 * 60 * 1000);\n\n    // Filter to expenses in the historical period\n    const expenses = transactions.filter(t => \n      t.type === 'expense' && new Date(t.date) >= cutoffDate\n    );\n\n    if (expenses.length === 0) {\n      return [];\n    }\n\n    // Group by category\n    const categoryData = new Map<string, number[]>();\n    expenses.forEach(expense => {\n      const amount = parseFloat(expense.amount);\n      if (!categoryData.has(expense.category)) {\n        categoryData.set(expense.category, []);\n      }\n      categoryData.get(expense.category)!.push(amount);\n    });\n\n    // Calculate forecasts\n    const forecasts: SpendingForecast[] = [];\n    categoryData.forEach((amounts, category) => {\n      const historicalAverage = amounts.reduce((sum, amt) => sum + amt, 0) / amounts.length;\n      const totalHistorical = amounts.reduce((sum, amt) => sum + amt, 0);\n      \n      // Calculate trend (compare first half vs second half)\n      const midpoint = Math.floor(amounts.length / 2);\n      const firstHalf = amounts.slice(0, midpoint);\n      const secondHalf = amounts.slice(midpoint);\n      const firstHalfAvg = firstHalf.reduce((s, a) => s + a, 0) / firstHalf.length;\n      const secondHalfAvg = secondHalf.reduce((s, a) => s + a, 0) / secondHalf.length;\n      \n      const trendPercent = ((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100;\n      let trend: 'increasing' | 'stable' | 'decreasing';\n      if (trendPercent > 10) trend = 'increasing';\n      else if (trendPercent < -10) trend = 'decreasing';\n      else trend = 'stable';\n\n      // Apply trend to forecast\n      const trendMultiplier = 1 + (trendPercent / 100);\n      const predictedAmount = historicalAverage * trendMultiplier * (days / 30);\n\n      // Calculate confidence based on variance\n      const variance = amounts.reduce((sum, amt) => sum + Math.pow(amt - historicalAverage, 2), 0) / amounts.length;\n      const stdDev = Math.sqrt(variance);\n      const coefficientOfVariation = stdDev / historicalAverage;\n      \n      let confidence: 'high' | 'medium' | 'low';\n      if (coefficientOfVariation < 0.3) confidence = 'high';\n      else if (coefficientOfVariation < 0.6) confidence = 'medium';\n      else confidence = 'low';\n\n      forecasts.push({\n        category,\n        historicalAverage,\n        predictedAmount,\n        confidence,\n        trend,\n        percentChange: trendPercent\n      });\n    });\n\n    return forecasts.sort((a, b) => b.predictedAmount - a.predictedAmount);\n  }\n\n  /**\n   * Predict goal achievement probability\n   */\n  async predictGoalAchievement(userId: string): Promise<GoalPrediction[]> {\n    const goals = await storage.getFinancialGoalsByUserId(userId);\n    const transactions = await storage.getTransactionsByUserId(userId);\n    const activeGoals = goals.filter(g => g.status === 'active');\n\n    if (activeGoals.length === 0) {\n      return [];\n    }\n\n    // Calculate recent savings rate\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n    const recentIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    const recentExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n    const monthlySavingsCapacity = recentIncome - recentExpenses;\n\n    const predictions: GoalPrediction[] = [];\n\n    for (const goal of activeGoals) {\n      const targetAmount = parseFloat(goal.targetAmount);\n      const currentAmount = parseFloat(goal.currentAmount || \"0\");\n      const remaining = targetAmount - currentAmount;\n      const targetDate = new Date(goal.targetDate);\n      const now = new Date();\n      const monthsRemaining = Math.max(0, (targetDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24 * 30));\n      const currentProgress = (currentAmount / targetAmount) * 100;\n\n      // Calculate required monthly contribution\n      const requiredMonthlyContribution = monthsRemaining > 0 ? remaining / monthsRemaining : remaining;\n\n      // Calculate probability based on current savings capacity\n      let probability = 0;\n      let onTrack = false;\n      if (monthlySavingsCapacity >= requiredMonthlyContribution) {\n        probability = Math.min(95, 70 + (monthlySavingsCapacity / requiredMonthlyContribution) * 25);\n        onTrack = true;\n      } else {\n        probability = Math.max(10, 50 * (monthlySavingsCapacity / requiredMonthlyContribution));\n        onTrack = false;\n      }\n\n      // Predict completion date based on current savings rate\n      const predictedMonthsToCompletion = monthlySavingsCapacity > 0 \n        ? remaining / monthlySavingsCapacity \n        : 999;\n      const predictedCompletionDate = new Date(now.getTime() + predictedMonthsToCompletion * 30 * 24 * 60 * 60 * 1000);\n\n      // Generate recommendation\n      let recommendedAction = \"\";\n      if (!onTrack && monthsRemaining > 0) {\n        const shortfall = requiredMonthlyContribution - monthlySavingsCapacity;\n        recommendedAction = `Increase monthly savings by $${shortfall.toFixed(0)} or extend deadline by ${Math.ceil((remaining / monthlySavingsCapacity) - monthsRemaining)} months`;\n      } else if (onTrack && probability > 85) {\n        recommendedAction = `On excellent track! Consider allocating surplus to other goals`;\n      } else {\n        recommendedAction = `Maintain current pace of $${monthlySavingsCapacity.toFixed(0)}/month`;\n      }\n\n      predictions.push({\n        goalId: goal.id,\n        goalTitle: goal.title,\n        currentProgress,\n        predictedCompletionDate: predictedCompletionDate.toISOString().split('T')[0],\n        onTrack,\n        probability: Math.round(probability),\n        requiredMonthlyContribution: Math.round(requiredMonthlyContribution),\n        recommendedAction\n      });\n    }\n\n    return predictions;\n  }\n\n  /**\n   * Forecast cash flow for next 90 days\n   */\n  async forecastCashFlow(userId: string): Promise<CashFlowForecast[]> {\n    const transactions = await storage.getTransactionsByUserId(userId);\n    const stats = await storage.getUserStats(userId);\n\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n\n    // Calculate averages\n    const avgDailyIncome = recentTransactions\n      .filter(t => t.type === 'income')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0) / 30;\n    \n    const avgDailyExpenses = recentTransactions\n      .filter(t => t.type === 'expense')\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0) / 30;\n\n    // Get current balance\n    const currentBalance = (stats as any)?.totalSavings || 0;\n\n    // Project for next 90 days\n    const forecasts: CashFlowForecast[] = [];\n    let projectedBalance = currentBalance;\n\n    for (let day = 1; day <= 90; day++) {\n      const date = new Date(Date.now() + day * 24 * 60 * 60 * 1000);\n      const projectedIncome = avgDailyIncome;\n      const projectedExpenses = avgDailyExpenses;\n      projectedBalance += (projectedIncome - projectedExpenses);\n\n      // Calculate risk level\n      let riskLevel: 'low' | 'medium' | 'high' = 'low';\n      const monthsOfExpenses = projectedBalance / (avgDailyExpenses * 30);\n      if (monthsOfExpenses < 1) riskLevel = 'high';\n      else if (monthsOfExpenses < 3) riskLevel = 'medium';\n\n      // Store forecast for each week (reduce data volume)\n      if (day % 7 === 0 || day === 1 || day === 90) {\n        forecasts.push({\n          date: date.toISOString().split('T')[0],\n          projectedBalance: Math.round(projectedBalance),\n          projectedIncome: Math.round(projectedIncome),\n          projectedExpenses: Math.round(projectedExpenses),\n          riskLevel\n        });\n      }\n    }\n\n    return forecasts;\n  }\n\n  /**\n   * Detect anomalies and early warnings\n   */\n  async detectAnomalies(userId: string): Promise<Anomaly[]> {\n    const transactions = await storage.getTransactionsByUserId(userId);\n    const goals = await storage.getFinancialGoalsByUserId(userId);\n    const anomalies: Anomaly[] = [];\n\n    // Analyze last 7 days vs previous 30 days\n    const now = new Date();\n    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n\n    const recentExpenses = transactions\n      .filter(t => t.type === 'expense' && new Date(t.date) >= sevenDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const historicalExpenses = transactions\n      .filter(t => t.type === 'expense' && new Date(t.date) >= thirtyDaysAgo && new Date(t.date) < sevenDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const historicalDaily = historicalExpenses / 23; // 30 - 7 days\n    const recentDaily = recentExpenses / 7;\n\n    // Spending spike detection\n    if (recentDaily > historicalDaily * 1.5 && recentExpenses > 100) {\n      anomalies.push({\n        type: 'spending_spike',\n        severity: recentDaily > historicalDaily * 2 ? 'critical' : 'warning',\n        title: 'Unusual Spending Detected',\n        description: `Your spending is ${((recentDaily / historicalDaily - 1) * 100).toFixed(0)}% higher than usual this week`,\n        suggestedAction: 'Review recent transactions and consider adjusting budget',\n        detectedAt: now.toISOString()\n      });\n    }\n\n    // Income drop detection\n    const recentIncome = transactions\n      .filter(t => t.type === 'income' && new Date(t.date) >= sevenDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    const historicalIncome = transactions\n      .filter(t => t.type === 'income' && new Date(t.date) >= thirtyDaysAgo && new Date(t.date) < sevenDaysAgo)\n      .reduce((sum, t) => sum + parseFloat(t.amount), 0);\n\n    if (historicalIncome > 0 && recentIncome < historicalIncome * 0.5) {\n      anomalies.push({\n        type: 'income_drop',\n        severity: 'critical',\n        title: 'Income Drop Detected',\n        description: `Your income this week is significantly lower than usual`,\n        suggestedAction: 'Review income sources and consider emergency budget measures',\n        detectedAt: now.toISOString()\n      });\n    }\n\n    // Goal at risk detection\n    const goalsAtRisk = await this.predictGoalAchievement(userId);\n    for (const goal of goalsAtRisk) {\n      if (!goal.onTrack && goal.probability < 50) {\n        anomalies.push({\n          type: 'goal_at_risk',\n          severity: goal.probability < 25 ? 'critical' : 'warning',\n          title: `Goal At Risk: ${goal.goalTitle}`,\n          description: `Only ${goal.probability}% chance of achieving on time`,\n          suggestedAction: goal.recommendedAction,\n          detectedAt: now.toISOString()\n        });\n      }\n    }\n\n    return anomalies;\n  }\n\n  /**\n   * Identify savings opportunities\n   */\n  async identifySavingsOpportunities(userId: string): Promise<SavingsOpportunity[]> {\n    const forecasts = await this.forecastSpending(userId, 30);\n    const opportunities: SavingsOpportunity[] = [];\n\n    // Find categories with high spending and increasing trends\n    for (const forecast of forecasts) {\n      if (forecast.predictedAmount > 200 && forecast.trend === 'increasing') {\n        const potentialSavings = forecast.predictedAmount * 0.15; // 15% reduction target\n        opportunities.push({\n          category: forecast.category,\n          potentialSavings: Math.round(potentialSavings),\n          confidence: forecast.confidence === 'high' ? 0.8 : forecast.confidence === 'medium' ? 0.6 : 0.4,\n          timeframe: 'monthly',\n          suggestion: `Reduce ${forecast.category} spending by 15% to save $${potentialSavings.toFixed(0)}/month`,\n          difficulty: forecast.predictedAmount > 500 ? 'easy' : 'medium'\n        });\n      }\n    }\n\n    return opportunities.slice(0, 5); // Return top 5\n  }\n}\n\nexport const predictiveAnalyticsService = new PredictiveAnalyticsService();\n","path":null,"size_bytes":13737,"size_tokens":null},"client/src/lib/finance/insights.ts":{"content":"import { Transaction } from './parseTransactions';\nimport { Category } from './categorize';\n\nexport interface Insight {\n  title: string;\n  message: string;\n}\n\n// Generate simple insights from categorized transactions.\nexport function generateInsights(transactions: (Transaction & { category: Category })[]): Insight[] {\n  const insights: Insight[] = [];\n  // Sum expenses by category\n  const totals: Record<string, number> = {};\n  for (const tx of transactions) {\n    const key = tx.category;\n    totals[key] = (totals[key] || 0) + tx.amount;\n  }\n  // Example: If total spent in category exceeds 3000 THB (negative), generate overspending insight\n  for (const [category, total] of Object.entries(totals)) {\n    if (total < -3000) {\n      insights.push({\n        title: `Overspending in ${category}`,\n        message: `You have spent \\u0e3f${Math.abs(total).toFixed(2)} in ${category} recently. Consider budgeting or cutting down.`,\n      });\n    }\n  }\n  return insights;\n}\n","path":null,"size_bytes":973,"size_tokens":null},"client/src/lib/finance/__tests__/finance.test.ts":{"content":"import { describe, it, expect } from 'vitest';\nimport { parseCSV, type Transaction } from '../parseTransactions';\nimport { categorizeTransaction, categorizeAll, type Category } from '../categorize';\nimport { forecastCashflow, forecastBalance } from '../forecast';\nimport { generateInsights } from '../insights';\n\ndescribe('Finance Library Tests', () => {\n  describe('CSV Parsing', () => {\n    it('should parse simple CSV lines correctly', () => {\n      const csv = `date,description,amount,currency\n2024-01-15,Coffee Shop,-4.50,USD\n2024-01-16,Salary,3000.00,USD\n2024-01-17,Grocery Store,-45.20,USD`;\n\n      const transactions = parseCSV(csv);\n\n      expect(transactions).toHaveLength(3);\n      expect(transactions[0]).toMatchObject({\n        date: '2024-01-15',\n        description: 'Coffee Shop',\n        amount: -4.50,\n        currency: 'USD',\n      });\n      expect(transactions[1]).toMatchObject({\n        date: '2024-01-16',\n        description: 'Salary',\n        amount: 3000.00,\n        currency: 'USD',\n      });\n      expect(transactions[2]).toMatchObject({\n        date: '2024-01-17',\n        description: 'Grocery Store',\n        amount: -45.20,\n        currency: 'USD',\n      });\n    });\n\n    it('should handle empty CSV gracefully', () => {\n      const csv = '';\n      const transactions = parseCSV(csv);\n      expect(transactions).toHaveLength(0);\n    });\n\n    it('should generate unique IDs for transactions', () => {\n      const csv = `date,description,amount,currency\n2024-01-15,Test1,-10.00,USD\n2024-01-16,Test2,-20.00,USD`;\n\n      const transactions = parseCSV(csv);\n      expect(transactions[0].id).toBeDefined();\n      expect(transactions[1].id).toBeDefined();\n      expect(transactions[0].id).not.toBe(transactions[1].id);\n    });\n\n    it('should handle malformed CSV rows gracefully', () => {\n      const csv = `date,description,amount,currency\n2024-01-15,Coffee,-5.00,USD\n2024-01-16,Invalid Row\n2024-01-17,Groceries,-50.00,USD`;\n\n      const transactions = parseCSV(csv);\n      \n      // Should parse valid rows and handle malformed ones\n      expect(transactions).toHaveLength(3);\n      expect(transactions[0].description).toBe('Coffee');\n      expect(transactions[1].description).toBe('Invalid Row');\n      expect(transactions[2].description).toBe('Groceries');\n    });\n\n    it('should handle missing currency field', () => {\n      const csv = `date,description,amount\n2024-01-15,Test,-10.00`;\n\n      const transactions = parseCSV(csv);\n      \n      expect(transactions).toHaveLength(1);\n      expect(transactions[0].currency).toBe('THB'); // Default currency\n    });\n  });\n\n  describe('Categorization', () => {\n    it('should categorize food transactions correctly', () => {\n      const transaction: Transaction = {\n        id: '1',\n        date: '2024-01-15',\n        description: 'Starbucks Coffee Shop',\n        amount: -5.50,\n        currency: 'USD',\n      };\n\n      const category = categorizeTransaction(transaction);\n      expect(category).toBe('Food');\n    });\n\n    it('should categorize bills correctly', () => {\n      const transaction: Transaction = {\n        id: '2',\n        date: '2024-01-15',\n        description: 'Electricity Bill Payment',\n        amount: -100.00,\n        currency: 'USD',\n      };\n\n      const category = categorizeTransaction(transaction);\n      expect(category).toBe('Bills');\n    });\n\n    it('should categorize subscriptions correctly', () => {\n      const transaction: Transaction = {\n        id: '3',\n        date: '2024-01-15',\n        description: 'Netflix Subscription',\n        amount: -15.99,\n        currency: 'USD',\n      };\n\n      const category = categorizeTransaction(transaction);\n      expect(category).toBe('Subscriptions');\n    });\n\n    it('should categorize positive amounts as Income', () => {\n      const transaction: Transaction = {\n        id: '4',\n        date: '2024-01-15',\n        description: 'Monthly Salary',\n        amount: 5000.00,\n        currency: 'USD',\n      };\n\n      const category = categorizeTransaction(transaction);\n      expect(category).toBe('Income');\n    });\n\n    it('should categorize unknown expenses as Other', () => {\n      const transaction: Transaction = {\n        id: '5',\n        date: '2024-01-15',\n        description: 'Unknown Payment',\n        amount: -25.00,\n        currency: 'USD',\n      };\n\n      const category = categorizeTransaction(transaction);\n      expect(category).toBe('Other');\n    });\n\n    it('should categorize all transactions in array', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Coffee', amount: -5.00, currency: 'USD' },\n        { id: '2', date: '2024-01-16', description: 'Salary', amount: 3000.00, currency: 'USD' },\n      ];\n\n      const categorized = categorizeAll(transactions);\n\n      expect(categorized).toHaveLength(2);\n      expect(categorized[0].category).toBe('Food');\n      expect(categorized[1].category).toBe('Income');\n    });\n  });\n\n  describe('Cash Flow Forecast', () => {\n    it('should generate correct forecast length', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Coffee', amount: -5.00, currency: 'USD' },\n        { id: '2', date: '2024-01-16', description: 'Salary', amount: 3000.00, currency: 'USD' },\n        { id: '3', date: '2024-01-17', description: 'Groceries', amount: -50.00, currency: 'USD' },\n      ];\n\n      const forecast = forecastCashflow(transactions, 30);\n\n      expect(forecast).toHaveLength(30);\n    });\n\n    it('should calculate daily average correctly', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Expense', amount: -100.00, currency: 'USD' },\n        { id: '2', date: '2024-01-16', description: 'Income', amount: 300.00, currency: 'USD' },\n      ];\n\n      const forecast = forecastCashflow(transactions, 5);\n\n      // Total: -100 + 300 = 200\n      // Daily average: 200 / 2 = 100\n      // Day 1 forecast: 100 * 1 = 100\n      expect(forecast[0]).toBe(100);\n      expect(forecast[1]).toBe(200);\n      expect(forecast[2]).toBe(300);\n    });\n\n    it('should handle empty transactions', () => {\n      const transactions: Transaction[] = [];\n      const forecast = forecastCashflow(transactions, 10);\n\n      expect(forecast).toHaveLength(10);\n      expect(forecast.every(amount => amount === 0)).toBe(true);\n    });\n\n    it('should forecast balance correctly', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Test', amount: 100.00, currency: 'USD' },\n      ];\n\n      const currentBalance = 1000;\n      const daysRemaining = 30;\n      const futureBalance = forecastBalance(transactions, currentBalance, daysRemaining);\n\n      // Average daily: 100 / 1 = 100\n      // Forecast: 1000 + (100 * 30) = 4000\n      expect(futureBalance).toBe(4000);\n    });\n\n    it('should handle negative forecast trajectories', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Expense', amount: -200.00, currency: 'USD' },\n      ];\n\n      const currentBalance = 500;\n      const daysRemaining = 10;\n      const futureBalance = forecastBalance(transactions, currentBalance, daysRemaining);\n\n      // Average daily: -200 / 1 = -200\n      // Forecast: 500 + (-200 * 10) = -1500\n      expect(futureBalance).toBe(-1500);\n      expect(futureBalance).toBeLessThan(currentBalance);\n    });\n\n    it('should handle large forecast periods', () => {\n      const transactions: Transaction[] = [\n        { id: '1', date: '2024-01-15', description: 'Test', amount: 10.00, currency: 'USD' },\n      ];\n\n      const forecast = forecastCashflow(transactions, 365);\n      \n      expect(forecast).toHaveLength(365);\n      expect(forecast[0]).toBe(10);\n      expect(forecast[364]).toBe(3650);\n    });\n  });\n\n  describe('Insights Generation', () => {\n    it('should trigger overspending insight for high expenses', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Food expense 1',\n          amount: -2000.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n        {\n          id: '2',\n          date: '2024-01-16',\n          description: 'Food expense 2',\n          amount: -1500.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n\n      expect(insights.length).toBeGreaterThan(0);\n      expect(insights[0].title).toContain('Overspending');\n      expect(insights[0].title).toContain('Food');\n    });\n\n    it('should not trigger insights for normal spending', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Small expense',\n          amount: -50.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n\n      expect(insights).toHaveLength(0);\n    });\n\n    it('should generate multiple insights for multiple categories', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Food expense',\n          amount: -3500.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n        {\n          id: '2',\n          date: '2024-01-16',\n          description: 'Shopping expense',\n          amount: -3500.00,\n          currency: 'THB',\n          category: 'Shopping' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n\n      expect(insights.length).toBeGreaterThanOrEqual(2);\n    });\n\n    it('should format insight messages correctly', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Bills',\n          amount: -4000.00,\n          currency: 'THB',\n          category: 'Bills' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n\n      expect(insights[0].message).toContain('4000.00');\n      expect(insights[0].message).toContain('Bills');\n      expect(insights[0].message).toContain('budget');\n    });\n\n    it('should handle mixed currencies in transactions', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'USD expense',\n          amount: -100.00,\n          currency: 'USD',\n          category: 'Food' as Category,\n        },\n        {\n          id: '2',\n          date: '2024-01-16',\n          description: 'THB expense',\n          amount: -3500.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n      ];\n\n      // Insights should still be generated even with mixed currencies\n      const insights = generateInsights(transactions);\n      \n      // At least THB should trigger overspending\n      expect(insights.length).toBeGreaterThan(0);\n    });\n\n    it('should handle edge case of exactly 3000 THB threshold', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Exactly at threshold',\n          amount: -3000.00,\n          currency: 'THB',\n          category: 'Food' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n      \n      // Should not trigger at exactly 3000 (only > 3000)\n      expect(insights).toHaveLength(0);\n    });\n\n    it('should handle very large spending amounts', () => {\n      const transactions = [\n        {\n          id: '1',\n          date: '2024-01-15',\n          description: 'Large expense',\n          amount: -1000000.00,\n          currency: 'THB',\n          category: 'Shopping' as Category,\n        },\n      ];\n\n      const insights = generateInsights(transactions);\n      \n      expect(insights.length).toBeGreaterThan(0);\n      expect(insights[0].message).toContain('1000000.00');\n    });\n  });\n});\n","path":null,"size_bytes":11963,"size_tokens":null},"client/src/components/money/csv-analysis-panel.tsx":{"content":"import { useState } from \"react\";\nimport { Upload, FileText, TrendingUp, Save, CheckCircle2 } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from \"recharts\";\nimport { parseCSV, type Transaction } from \"@/lib/finance/parseTransactions\";\nimport { categorizeAll, type Category } from \"@/lib/finance/categorize\";\nimport { forecastCashflow } from \"@/lib/finance/forecast\";\nimport { generateInsights, type Insight } from \"@/lib/finance/insights\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype AnalysisState = 'idle' | 'loading' | 'success' | 'error';\n\nexport default function CSVAnalysisPanel() {\n  const [csvText, setCsvText] = useState(\"\");\n  const [state, setState] = useState<AnalysisState>('idle');\n  const [error, setError] = useState<string>(\"\");\n  const [categorizedTransactions, setCategorizedTransactions] = useState<(Transaction & { category: Category })[]>([]);\n  const [categoryTotals, setCategoryTotals] = useState<{ category: string; total: number; percentage: number }[]>([]);\n  const [forecast, setForecast] = useState<{ day: number; amount: number }[]>([]);\n  const [insights, setInsights] = useState<Insight[]>([]);\n  const [fileInputKey, setFileInputKey] = useState(0);\n  const [saved, setSaved] = useState(false);\n  const { toast } = useToast();\n\n  const importMutation = useMutation({\n    mutationFn: async (transactions: (Transaction & { category: Category })[]) => {\n      const txData = transactions.map(tx => ({\n        date: tx.date,\n        description: tx.description,\n        amount: tx.amount,\n        category: tx.category,\n      }));\n      return apiRequest(\"POST\", \"/api/transactions/bulk-import\", { transactions: txData });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial-summary\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/user/financial-profile\"] });\n      setSaved(true);\n      toast({\n        title: \"Transactions Imported!\",\n        description: data.message || `Successfully saved ${categorizedTransactions.length} transactions`,\n        icon: <CheckCircle2 className=\"h-5 w-5 text-green-600\" />,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Import Failed\",\n        description: error.message || \"Failed to save transactions\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        const text = e.target?.result as string;\n        setCsvText(text);\n      };\n      reader.readAsText(file);\n    }\n  };\n\n  const handleAnalyze = () => {\n    if (!csvText.trim()) {\n      setError(\"Please enter CSV data\");\n      setState('error');\n      return;\n    }\n\n    setState('loading');\n    setError(\"\");\n    setSaved(false);\n\n    try {\n      // Parse CSV\n      const parsed = parseCSV(csvText);\n      if (parsed.length === 0) {\n        throw new Error(\"No transactions found in CSV\");\n      }\n\n      // Categorize\n      const categorized = categorizeAll(parsed);\n      setCategorizedTransactions(categorized);\n\n      // Calculate category totals\n      const totals: Record<string, number> = {};\n      let totalExpense = 0;\n      \n      categorized.forEach(tx => {\n        totals[tx.category] = (totals[tx.category] || 0) + tx.amount;\n        if (tx.amount < 0) totalExpense += Math.abs(tx.amount);\n      });\n\n      const totalsArray = Object.entries(totals).map(([category, total]) => ({\n        category,\n        total,\n        percentage: totalExpense > 0 ? (Math.abs(total) / totalExpense) * 100 : 0,\n      })).sort((a, b) => {\n        // Sort by absolute expense value descending (largest expenses first)\n        const absA = Math.abs(a.total);\n        const absB = Math.abs(b.total);\n        return absB - absA;\n      });\n\n      setCategoryTotals(totalsArray);\n\n      // Generate 30-day forecast\n      const forecastData = forecastCashflow(categorized, 30);\n      const forecastArray = forecastData.map((amount, index) => ({\n        day: index + 1,\n        amount: Math.round(amount),\n      }));\n      setForecast(forecastArray);\n\n      // Generate insights\n      const generatedInsights = generateInsights(categorized);\n      setInsights(generatedInsights.slice(0, 3));\n\n      setState('success');\n      \n      // Reset file input to allow re-uploading the same file\n      setFileInputKey(prev => prev + 1);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Failed to analyze CSV\");\n      setState('error');\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Upload Section */}\n      <Card data-testid=\"csv-upload-card\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            CSV Transaction Upload\n          </CardTitle>\n          <CardDescription>\n            Upload or paste CSV data in format: date,description,amount,currency\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <label className=\"block text-sm font-medium\">Upload CSV File</label>\n            <input\n              key={fileInputKey}\n              type=\"file\"\n              accept=\".csv\"\n              onChange={handleFileUpload}\n              className=\"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-primary-foreground hover:file:bg-primary/90\"\n              data-testid=\"csv-file-input\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <label className=\"block text-sm font-medium\">Or Paste CSV Data</label>\n            <Textarea\n              value={csvText}\n              onChange={(e) => setCsvText(e.target.value)}\n              placeholder=\"2024-01-15,Coffee Shop,-4.50,USD&#10;2024-01-16,Salary,3000.00,USD&#10;2024-01-17,Grocery Store,-45.20,USD\"\n              rows={6}\n              data-testid=\"csv-textarea\"\n            />\n          </div>\n\n          <Button \n            onClick={handleAnalyze} \n            disabled={state === 'loading'}\n            className=\"w-full\"\n            data-testid=\"analyze-button\"\n          >\n            <Upload className=\"h-4 w-4 mr-2\" />\n            {state === 'loading' ? 'Analyzing...' : 'Analyze Transactions'}\n          </Button>\n\n          {state === 'error' && error && (\n            <Alert variant=\"destructive\" data-testid=\"error-alert\">\n              <AlertDescription>{error}</AlertDescription>\n            </Alert>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Results Section */}\n      {state === 'success' && categorizedTransactions.length > 0 && (\n        <>\n          {/* Save to Database Button */}\n          <Card className=\"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950/30\">\n            <CardContent className=\"pt-6\">\n              <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n                <div>\n                  <h3 className=\"font-semibold text-green-900 dark:text-green-100\">\n                    {saved ? \"Transactions Saved!\" : \"Ready to Import\"}\n                  </h3>\n                  <p className=\"text-sm text-green-700 dark:text-green-300\">\n                    {saved \n                      ? \"Your transactions are now tracked and will be used for AI financial advice.\"\n                      : `${categorizedTransactions.length} transactions analyzed. Save them to track your finances.`\n                    }\n                  </p>\n                </div>\n                <Button \n                  onClick={() => importMutation.mutate(categorizedTransactions)}\n                  disabled={saved || importMutation.isPending}\n                  className={saved ? \"bg-green-600 hover:bg-green-600\" : \"\"}\n                  data-testid=\"save-transactions-button\"\n                >\n                  {importMutation.isPending ? (\n                    \"Saving...\"\n                  ) : saved ? (\n                    <>\n                      <CheckCircle2 className=\"h-4 w-4 mr-2\" />\n                      Saved\n                    </>\n                  ) : (\n                    <>\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save to My Finances\n                    </>\n                  )}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Category Totals */}\n          <Card data-testid=\"category-totals-card\">\n            <CardHeader>\n              <CardTitle>Spending by Category</CardTitle>\n              <CardDescription>\n                Analyzed {categorizedTransactions.length} transactions\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {categoryTotals.length > 0 ? (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Category</TableHead>\n                      <TableHead className=\"text-right\">Total</TableHead>\n                      <TableHead className=\"text-right\">% of Spending</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {categoryTotals.map((item) => (\n                      <TableRow key={item.category}>\n                        <TableCell className=\"font-medium\">{item.category}</TableCell>\n                        <TableCell className=\"text-right\">\n                          {item.total >= 0 ? '+' : ''}{item.total.toFixed(2)}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          {item.total < 0 ? `${item.percentage.toFixed(1)}%` : '-'}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              ) : (\n                <p className=\"text-muted-foreground text-center py-8\">No spending data available</p>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* 30-Day Forecast Chart */}\n          <Card data-testid=\"forecast-chart-card\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5\" />\n                30-Day Cash Flow Forecast\n              </CardTitle>\n              <CardDescription>\n                Projected cumulative balance based on historical patterns\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {forecast.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <LineChart data={forecast}>\n                    <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                    <XAxis \n                      dataKey=\"day\" \n                      label={{ value: 'Days', position: 'insideBottom', offset: -5 }}\n                      className=\"text-xs\"\n                    />\n                    <YAxis \n                      label={{ value: 'Amount', angle: -90, position: 'insideLeft' }}\n                      className=\"text-xs\"\n                    />\n                    <Tooltip \n                      contentStyle={{ \n                        backgroundColor: 'hsl(var(--background))',\n                        border: '1px solid hsl(var(--border))',\n                        borderRadius: '8px'\n                      }}\n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"amount\" \n                      stroke=\"hsl(var(--primary))\" \n                      strokeWidth={2}\n                      dot={false}\n                    />\n                  </LineChart>\n                </ResponsiveContainer>\n              ) : (\n                <p className=\"text-muted-foreground text-center py-8\">No forecast data available</p>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Insights */}\n          {insights.length > 0 && (\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Top Insights</h3>\n              <div className=\"grid gap-4\">\n                {insights.map((insight, index) => (\n                  <Card key={index} data-testid={`insight-card-${index}`}>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">{insight.title}</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <p className=\"text-sm text-muted-foreground\">{insight.message}</p>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </div>\n          )}\n        </>\n      )}\n\n      {/* Empty State */}\n      {state === 'idle' && (\n        <Card className=\"border-dashed\" data-testid=\"empty-state\">\n          <CardContent className=\"py-12\">\n            <div className=\"text-center space-y-4\">\n              <Upload className=\"h-12 w-12 mx-auto text-muted-foreground\" />\n              <div>\n                <h3 className=\"font-semibold text-lg\">No Data Analyzed Yet</h3>\n                <p className=\"text-muted-foreground\">\n                  Upload a CSV file or paste transaction data to get started\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14118,"size_tokens":null},"client/src/lib/finance/categorize.ts":{"content":"import { Transaction } from './parseTransactions';\n\nexport type Category = 'Food' | 'Bills' | 'Subscriptions' | 'Shopping' | 'Transport' | 'Income' | 'Other';\n\nconst KEYWORDS: { category: Category; keywords: string[] }[] = [\n  { category: 'Food', keywords: ['restaurant', 'cafe', 'coffee', 'eat', 'food'] },\n  { category: 'Bills', keywords: ['electricity', 'water', 'bill', 'utility', 'rent'] },\n  { category: 'Subscriptions', keywords: ['netflix', 'spotify', 'subscription', 'apple', 'prime'] },\n  { category: 'Shopping', keywords: ['amazon', 'shop', 'store', 'mall'] },\n  { category: 'Transport', keywords: ['uber', 'grab', 'taxi', 'bus', 'train'] },\n];\n\nexport function categorizeTransaction(tx: Transaction): Category {\n  const desc = tx.description.toLowerCase();\n  for (const { category, keywords } of KEYWORDS) {\n    if (keywords.some(k => desc.includes(k))) {\n      return category;\n    }\n  }\n  // if amount positive treat as income else other\n  return tx.amount >= 0 ? 'Income' : 'Other';\n}\n\nexport function categorizeAll(transactions: Transaction[]): (Transaction & { category: Category })[] {\n  return transactions.map(tx => ({\n    ...tx,\n    category: categorizeTransaction(tx),\n  }));\n}\n","path":null,"size_bytes":1200,"size_tokens":null},"client/public/sw.js":{"content":"// Twealth Service Worker for Mobile PWA\n// Version 6 - Aggressive cache clearing to fix stale asset issues\nconst CACHE_NAME = 'twealth-v6';\nconst STATIC_CACHE = 'twealth-static-v6';\nconst OFFLINE_URL = '/offline.html';\n\n// Only cache truly static assets - NOT dynamic app routes\nconst STATIC_ASSETS = [\n  '/offline.html',\n  '/manifest.json',\n  '/icon-192.png',\n  '/icon-512.png',\n  '/apple-touch-icon.png',\n  '/favicon.ico'\n];\n\n// Install event - FIRST clear ALL old caches, then cache only essential assets\nself.addEventListener('install', (event) => {\n  console.log('[SW] Installing service worker v6...');\n  event.waitUntil(\n    // Clear ALL existing caches first to prevent stale JS issues\n    caches.keys()\n      .then((cacheNames) => {\n        console.log('[SW] Clearing all old caches:', cacheNames);\n        return Promise.all(cacheNames.map((name) => caches.delete(name)));\n      })\n      .then(() => caches.open(STATIC_CACHE))\n      .then((cache) => {\n        console.log('[SW] Caching essential static assets');\n        return cache.addAll(STATIC_ASSETS.map(url => new Request(url, { cache: 'reload' })));\n      })\n      .then(() => self.skipWaiting())\n      .catch((error) => {\n        console.error('[SW] Install error:', error);\n        return self.skipWaiting();\n      })\n  );\n});\n\n// Activate event - take control immediately\nself.addEventListener('activate', (event) => {\n  console.log('[SW] Activating service worker v6...');\n  event.waitUntil(\n    Promise.all([\n      (async () => {\n        if (self.registration.navigationPreload) {\n          await self.registration.navigationPreload.enable();\n          console.log('[SW] Navigation preload enabled');\n        }\n      })(),\n      // Clear any remaining old caches\n      caches.keys().then((cacheNames) => {\n        return Promise.all(\n          cacheNames\n            .filter((name) => name !== CACHE_NAME && name !== STATIC_CACHE)\n            .map((name) => {\n              console.log('[SW] Deleting old cache:', name);\n              return caches.delete(name);\n            })\n        );\n      }),\n      self.clients.claim()\n    ])\n  );\n});\n\n// Fetch event - PWABuilder compliant with explicit response handling\nself.addEventListener('fetch', (event) => {\n  const request = event.request;\n  const url = new URL(request.url);\n\n  // Only handle same-origin GET requests\n  if (request.method !== 'GET' || url.origin !== self.location.origin) {\n    return;\n  }\n\n  // Critical: Never intercept OAuth or API routes - let browser handle normally\n  if (url.pathname.startsWith('/api/')) {\n    return;\n  }\n\n  // CRITICAL: Never cache JavaScript bundles - always fetch fresh to prevent stale code\n  if (url.pathname.endsWith('.js') || url.pathname.includes('/assets/')) {\n    return; // Let browser handle JS files directly - no caching\n  }\n\n  // Handle navigation requests (page loads)\n  if (request.mode === 'navigate') {\n    event.respondWith(\n      (async () => {\n        try {\n          // Try preload response first (faster)\n          const preloadResponse = event.preloadResponse;\n          if (preloadResponse) {\n            const response = await preloadResponse;\n            if (response) return response;\n          }\n\n          // Network first for navigation\n          const networkResponse = await fetch(request);\n          if (networkResponse.ok) {\n            const cache = await caches.open(STATIC_CACHE);\n            cache.put(request, networkResponse.clone());\n          }\n          return networkResponse;\n        } catch (error) {\n          console.log('[SW] Navigation failed, serving fallback');\n          \n          // Try cached version\n          const cached = await caches.match(request);\n          if (cached) return cached;\n          \n          // Try cached index\n          const indexCached = await caches.match('/');\n          if (indexCached) return indexCached;\n          \n          // Return offline page\n          const offlinePage = await caches.match(OFFLINE_URL);\n          if (offlinePage) return offlinePage;\n          \n          // Ultimate fallback\n          return new Response(\n            '<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Offline</title></head><body><h1>You are offline</h1></body></html>',\n            { headers: { 'Content-Type': 'text/html' }, status: 503 }\n          );\n        }\n      })()\n    );\n    return;\n  }\n\n  // Handle static assets (cache-first strategy)\n  event.respondWith(\n    (async () => {\n      const cached = await caches.match(request);\n      if (cached) {\n        // Update cache in background\n        fetch(request).then((response) => {\n          if (response.ok) {\n            caches.open(STATIC_CACHE).then((cache) => cache.put(request, response));\n          }\n        }).catch(() => {});\n        return cached;\n      }\n\n      try {\n        const networkResponse = await fetch(request);\n        if (networkResponse.ok) {\n          const cache = await caches.open(STATIC_CACHE);\n          cache.put(request, networkResponse.clone());\n        }\n        return networkResponse;\n      } catch (error) {\n        // Return a proper error response for failed static requests\n        return new Response('Resource unavailable offline', { \n          status: 503,\n          statusText: 'Service Unavailable'\n        });\n      }\n    })()\n  );\n});\n\n// Message handler\nself.addEventListener('message', (event) => {\n  if (event.data?.type === 'SKIP_WAITING') {\n    self.skipWaiting();\n  }\n  if (event.data?.type === 'GET_VERSION') {\n    event.ports[0]?.postMessage({ version: CACHE_NAME });\n  }\n  if (event.data?.type === 'CLEAR_CACHE') {\n    caches.keys().then((names) => Promise.all(names.map((n) => caches.delete(n))));\n  }\n});\n\n// Background sync support\nself.addEventListener('periodicsync', (event) => {\n  if (event.tag === 'update-cache') {\n    event.waitUntil(\n      caches.open(STATIC_CACHE).then(async (cache) => {\n        const keys = await cache.keys();\n        for (const req of keys) {\n          try {\n            const res = await fetch(req);\n            if (res.ok) await cache.put(req, res);\n          } catch (e) {}\n        }\n      })\n    );\n  }\n});\n\n// Push notification support\nself.addEventListener('push', (event) => {\n  if (!event.data) return;\n  \n  const data = event.data.json();\n  event.waitUntil(\n    self.registration.showNotification(data.title || 'Twealth', {\n      body: data.body || 'New notification',\n      icon: '/icon-192.png',\n      badge: '/icon-192.png',\n      vibrate: [100, 50, 100],\n      data: { url: data.url || '/' }\n    })\n  );\n});\n\n// Notification click handler\nself.addEventListener('notificationclick', (event) => {\n  event.notification.close();\n  const url = event.notification.data?.url || '/';\n  \n  event.waitUntil(\n    clients.matchAll({ type: 'window' }).then((clientList) => {\n      for (const client of clientList) {\n        if (client.url === url && 'focus' in client) return client.focus();\n      }\n      return clients.openWindow?.(url);\n    })\n  );\n});\n","path":null,"size_bytes":6957,"size_tokens":null},"client/src/lib/finance/parseTransactions.ts":{"content":"export interface Transaction {\n  id: string;\n  date: string; // ISO string\n  description: string;\n  amount: number;\n  currency: string;\n}\n\nexport function parseCSV(csv: string): Transaction[] {\n  const lines = csv.trim().split(/\\r?\\n/);\n  const header = lines.shift();\n  const transactions: Transaction[] = [];\n  for (const line of lines) {\n    const [date, description, amount, currency] = line.split(',');\n    transactions.push({\n      id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(),\n      date: date.trim(),\n      description: description.trim(),\n      amount: parseFloat(amount),\n      currency: currency?.trim() ?? 'THB',\n    });\n  }\n  return transactions;\n}\n","path":null,"size_bytes":723,"size_tokens":null},"client/src/lib/finance/forecast.ts":{"content":"import { Transaction } from './parseTransactions';\n\n// Forecast future balance based on past average transaction amount.\nexport function forecastBalance(transactions: Transaction[], currentBalance: number, daysRemaining: number): number {\n  if (transactions.length === 0) return currentBalance;\n  const total = transactions.reduce((sum, tx) => sum + tx.amount, 0);\n  const avgDaily = total / transactions.length;\n  return currentBalance + avgDaily * daysRemaining;\n}\n\n// Generate an array of projected cumulative amounts for the next N days.\nexport function forecastCashflow(transactions: Transaction[], days: number): number[] {\n  if (transactions.length === 0) return Array.from({ length: days }, () => 0);\n  const total = transactions.reduce((sum, tx) => sum + tx.amount, 0);\n  const avgDaily = total / transactions.length;\n  return Array.from({ length: days }, (_, i) => avgDaily * (i + 1));\n}\n","path":null,"size_bytes":898,"size_tokens":null},"server/config/ai.ts":{"content":"/**\n * AI Configuration for Hybrid Scout + Reasoning Architecture\n * \n * Three-tier AI system:\n * - Scout 4 (Llama 4): Fast queries for Free/Pro/Enterprise (90-95% of traffic)\n * - Sonnet 3.5: CFO-level analysis for Pro/Enterprise (5-10% of traffic)\n * - Opus 4.1: Advanced CFO analysis for Enterprise only (2-5% of traffic)\n * \n * Using Replit AI Integrations for Anthropic (no API key needed, billed to credits)\n */\n\n// Model cost table (USD per 1K tokens)\n// Based on provider pricing as of November 2025\nexport const MODEL_COST_TABLE = {\n  // GPT-5 (OpenAI via Replit AI Integrations) - NEW DEFAULT\n  // 13x cheaper than Opus, superior math/reasoning, 90% token savings\n  'gpt-5': {\n    input: 0.00125,  // $1.25 per 1M input tokens\n    output: 0.01,    // $10 per 1M output tokens (includes reasoning tokens)\n  },\n  'gpt-5-mini': {\n    input: 0.00025,  // $0.25 per 1M tokens\n    output: 0.002,   // $2 per 1M tokens\n  },\n  \n  // Scout models (Groq Llama 4) - LEGACY, being phased out\n  'meta-llama/llama-4-scout-17b-16e-instruct': {\n    input: 0.00011,  // $0.11 per 1M tokens\n    output: 0.00034, // $0.34 per 1M tokens\n  },\n  \n  // Reasoning models (Anthropic via Replit AI Integrations)\n  // Enterprise tier ONLY - Opus 4.1 for precision-critical work\n  'claude-opus-4-1-20250805': {\n    input: 0.015,    // $15 per 1M input tokens\n    output: 0.075,   // $75 per 1M output tokens\n  },\n  'claude-opus-4-1': {\n    input: 0.015,\n    output: 0.075,\n  },\n  \n  // Pro tier - Sonnet 4.5 (DEPRECATED, replaced by GPT-5)\n  'claude-sonnet-4-5-20250929': {\n    input: 0.003,    // $3 per 1M input tokens\n    output: 0.015,   // $15 per 1M output tokens\n  },\n  'claude-sonnet-4-5': {\n    input: 0.003,\n    output: 0.015,\n  },\n  \n  // Fallback - Sonnet 3.5 (still supported)\n  'claude-3-5-sonnet-20241022': {\n    input: 0.003,\n    output: 0.015,\n  },\n} as const;\n\nexport type ModelId = keyof typeof MODEL_COST_TABLE;\n\nexport interface AIConfig {\n  // Scout model config (Groq)\n  scout: {\n    provider: 'groq';\n    model: string;\n    apiKey: string;\n    maxTokens: number;\n    temperature: number;\n  };\n  \n  // Reasoning model config (Anthropic)\n  reasoning: {\n    provider: 'anthropic';\n    model: string;\n    apiKey: string;\n    baseURL: string;\n    maxTokens: number;\n    temperature: number;\n  };\n  \n  // Feature flags\n  reasoningEnabled: boolean;\n  \n  // Cost estimation helper\n  estimateCost: (modelId: ModelId, tokensIn: number, tokensOut: number) => number;\n}\n\n/**\n * Load AI configuration from environment variables\n */\nexport function loadAIConfig(): AIConfig {\n  // Scout config (Groq Llama 4)\n  const scoutModel = process.env.AI_SCOUT_MODEL || 'meta-llama/llama-4-scout-17b-16e-instruct';\n  const scoutApiKey = process.env.GROQ_API_KEY || '';\n  \n  // Reasoning config (Anthropic via Replit AI Integrations)\n  // Default to Sonnet 4.5 for Pro tier, Opus 4.1 available for Enterprise\n  const reasoningModel = process.env.AI_REASON_MODEL || 'claude-sonnet-4-5';\n  const reasoningApiKey = process.env.AI_INTEGRATIONS_ANTHROPIC_API_KEY || '';\n  const reasoningBaseURL = process.env.AI_INTEGRATIONS_ANTHROPIC_BASE_URL || '';\n  \n  // Shared config\n  const maxTokens = parseInt(process.env.AI_MAX_TOKENS || '8192', 10);\n  const temperature = parseFloat(process.env.AI_TEMPERATURE || '0.7');\n  const reasoningEnabled = process.env.AI_REASONING_ENABLED === 'true';\n  \n  return {\n    scout: {\n      provider: 'groq',\n      model: scoutModel,\n      apiKey: scoutApiKey,\n      maxTokens,\n      temperature,\n    },\n    reasoning: {\n      provider: 'anthropic',\n      model: reasoningModel,\n      apiKey: reasoningApiKey,\n      baseURL: reasoningBaseURL,\n      maxTokens,\n      temperature,\n    },\n    reasoningEnabled,\n    estimateCost: (modelId: ModelId, tokensIn: number, tokensOut: number): number => {\n      const costs = MODEL_COST_TABLE[modelId];\n      if (!costs) {\n        console.warn(`Unknown model ID: ${modelId}, returning 0 cost`);\n        return 0;\n      }\n      \n      // Convert tokens to cost (table is per 1K tokens)\n      const inputCost = (tokensIn / 1000) * costs.input;\n      const outputCost = (tokensOut / 1000) * costs.output;\n      \n      return inputCost + outputCost;\n    },\n  };\n}\n\n// Singleton instance\nlet cachedConfig: AIConfig | null = null;\n\n/**\n * Get the AI configuration (cached)\n */\nexport function getAIConfig(): AIConfig {\n  if (!cachedConfig) {\n    cachedConfig = loadAIConfig();\n  }\n  return cachedConfig;\n}\n\n/**\n * Validate that required config is present\n */\nexport function validateAIConfig(config: AIConfig): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n  \n  // Scout validation\n  if (!config.scout.apiKey) {\n    errors.push('Missing GROQ_API_KEY for Scout model');\n  }\n  \n  // Reasoning validation (only if enabled)\n  if (config.reasoningEnabled) {\n    if (!config.reasoning.apiKey) {\n      errors.push('Missing AI_INTEGRATIONS_ANTHROPIC_API_KEY for Reasoning model');\n    }\n    if (!config.reasoning.baseURL) {\n      errors.push('Missing AI_INTEGRATIONS_ANTHROPIC_BASE_URL for Reasoning model');\n    }\n  }\n  \n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n","path":null,"size_bytes":5138,"size_tokens":null},"server/ai/router.ts":{"content":"/**\n * Smart Router - Decides whether to use Scout or Reasoning model\n * \n * Escalation Rules (5-10% of traffic goes to Reasoning):\n * - Multi-year financial projections (10y, 20y, 30y)\n * - Debt payoff ordering (3+ debt accounts)\n * - Invest vs. payoff simulations\n * - Tax strategy (Roth vs Traditional, bracket optimization)\n * - Retirement glidepath planning\n * - Portfolio optimization\n * - Multi-scenario comparisons (2+ scenarios)\n * - Complex context (high token count or multiple financial products)\n * \n * Default: Scout for fast, cheap queries\n */\n\nexport interface ComplexitySignals {\n  message: string;\n  messageLength: number;\n  debtsCount?: number;\n  assetsCount?: number;\n  goalsCount?: number;\n  contextTokens?: number;\n}\n\nexport type RouteDecision = 'scout' | 'reasoning';\n\n/**\n * Keywords that trigger escalation to Reasoning model\n */\nconst ESCALATION_KEYWORDS = {\n  // Multi-year planning\n  multiYear: [\n    '10 year', '10-year', '10year',\n    '15 year', '15-year', '15year',\n    '20 year', '20-year', '20year',\n    '25 year', '25-year', '25year',\n    '30 year', '30-year', '30year',\n    'long term', 'long-term',\n    'decade',\n  ],\n  \n  // Debt optimization\n  debtOptimization: [\n    'debt payoff order',\n    'which debt first',\n    'snowball',\n    'avalanche',\n    'pay off debt',\n    'debt strategy',\n    'multiple debt',\n    'all my debt',\n  ],\n  \n  // Invest vs payoff\n  investVsPayoff: [\n    'invest or pay',\n    'invest vs pay',\n    'pay off or invest',\n    'debt or invest',\n    'investing vs debt',\n  ],\n  \n  // Tax strategy\n  taxStrategy: [\n    'roth',\n    'traditional ira',\n    'tax bracket',\n    'tax optimization',\n    'tax strategy',\n    'tax planning',\n    'tax efficient',\n  ],\n  \n  // Retirement planning\n  retirement: [\n    'retire',\n    'retirement',\n    'glidepath',\n    'target date',\n    '401k',\n    'pension',\n  ],\n  \n  // Portfolio optimization\n  portfolio: [\n    'portfolio',\n    'asset allocation',\n    'rebalance',\n    'diversif',\n    'risk tolerance',\n    'modern portfolio',\n  ],\n  \n  // Scenario comparison\n  scenarios: [\n    'compare',\n    'versus',\n    'vs.',\n    'which is better',\n    'should i',\n    'option',\n    'scenario',\n  ],\n  \n  // Complex analysis\n  complex: [\n    'optimize',\n    'optimal',\n    'best strategy',\n    'maximize',\n    'minimize',\n    'calculate',\n  ],\n};\n\n/**\n * Check if message contains any keywords from a category\n */\nfunction containsKeywords(message: string, keywords: string[]): boolean {\n  const lowerMsg = typeof message === 'string' ? message.toLowerCase() : '';\n  return keywords.some(keyword => lowerMsg.includes(keyword));\n}\n\n/**\n * Count how many scenario indicators are in the message\n */\nfunction countScenarios(message: string): number {\n  const scenarioIndicators = [\n    'option 1', 'option 2', 'option 3',\n    'scenario 1', 'scenario 2', 'scenario 3',\n    'first option', 'second option', 'third option',\n    'or', 'versus', 'vs.', 'compared to',\n  ];\n  \n  let count = 0;\n  const lowerMsg = typeof message === 'string' ? message.toLowerCase() : '';\n  \n  for (const indicator of scenarioIndicators) {\n    if (lowerMsg.includes(indicator)) {\n      count++;\n    }\n  }\n  \n  // If we found \"or\" or \"versus\", that suggests at least 2 scenarios\n  if (count > 0 && (lowerMsg.includes(' or ') || lowerMsg.includes('versus') || lowerMsg.includes('vs.'))) {\n    count = Math.max(count, 2);\n  }\n  \n  return count;\n}\n\n/**\n * Determine if query should be escalated to Reasoning model\n */\nexport function shouldEscalate(signals: ComplexitySignals): boolean {\n  const {\n    message,\n    messageLength,\n    debtsCount = 0,\n    assetsCount = 0,\n    goalsCount = 0,\n    contextTokens = 0,\n  } = signals;\n  \n  // Rule 1: Multi-year planning triggers\n  if (containsKeywords(message, ESCALATION_KEYWORDS.multiYear)) {\n    return true;\n  }\n  \n  // Rule 2: User has 3+ debts (auto-escalate for complex debt analysis regardless of keywords)\n  if (debtsCount >= 3) {\n    return true;\n  }\n  \n  // Rule 3: Invest vs. payoff questions\n  if (containsKeywords(message, ESCALATION_KEYWORDS.investVsPayoff)) {\n    return true;\n  }\n  \n  // Rule 4: Tax strategy\n  if (containsKeywords(message, ESCALATION_KEYWORDS.taxStrategy)) {\n    return true;\n  }\n  \n  // Rule 5: Retirement planning\n  if (containsKeywords(message, ESCALATION_KEYWORDS.retirement)) {\n    return true;\n  }\n  \n  // Rule 6: Portfolio optimization\n  if (containsKeywords(message, ESCALATION_KEYWORDS.portfolio)) {\n    return true;\n  }\n  \n  // Rule 7: Multi-scenario comparisons (2+ scenarios)\n  const scenarioCount = countScenarios(message);\n  if (scenarioCount >= 2) {\n    return true;\n  }\n  \n  // Rule 8: Complex analysis with financial products\n  if (containsKeywords(message, ESCALATION_KEYWORDS.complex)) {\n    // Only escalate complex queries if user has debts OR assets\n    if (debtsCount > 0 || assetsCount > 0) {\n      return true;\n    }\n  }\n  \n  // Rule 9: Long messages with multiple financial products\n  if (messageLength > 220 && (debtsCount > 0 || assetsCount > 0)) {\n    return true;\n  }\n  \n  // Rule 10: High context token count (very detailed financial situation)\n  if (contextTokens > 2000) {\n    return true;\n  }\n  \n  // Default: Use Scout\n  return false;\n}\n\n/**\n * Route to appropriate model based on complexity\n */\nexport function routeToModel(signals: ComplexitySignals): RouteDecision {\n  return shouldEscalate(signals) ? 'reasoning' : 'scout';\n}\n\n/**\n * Get explanation for routing decision (for debugging/logging)\n */\nexport function getRoutingReason(signals: ComplexitySignals): string {\n  const { message, debtsCount = 0, assetsCount = 0, messageLength, contextTokens = 0 } = signals;\n  \n  if (containsKeywords(message, ESCALATION_KEYWORDS.multiYear)) {\n    return 'Multi-year planning detected';\n  }\n  if (debtsCount >= 3) {\n    return `Complex debt situation (${debtsCount} debts) - auto-escalated`;\n  }\n  if (containsKeywords(message, ESCALATION_KEYWORDS.investVsPayoff)) {\n    return 'Invest vs. payoff analysis';\n  }\n  if (containsKeywords(message, ESCALATION_KEYWORDS.taxStrategy)) {\n    return 'Tax strategy planning';\n  }\n  if (containsKeywords(message, ESCALATION_KEYWORDS.retirement)) {\n    return 'Retirement planning';\n  }\n  if (containsKeywords(message, ESCALATION_KEYWORDS.portfolio)) {\n    return 'Portfolio optimization';\n  }\n  \n  const scenarioCount = countScenarios(message);\n  if (scenarioCount >= 2) {\n    return `Multi-scenario comparison (${scenarioCount} scenarios)`;\n  }\n  \n  if (containsKeywords(message, ESCALATION_KEYWORDS.complex) && (debtsCount > 0 || assetsCount > 0)) {\n    return 'Complex analysis with financial products';\n  }\n  if (messageLength > 220 && (debtsCount > 0 || assetsCount > 0)) {\n    return 'Long detailed query with financial products';\n  }\n  if (contextTokens > 2000) {\n    return 'High context complexity';\n  }\n  \n  return 'Simple query - using Scout';\n}\n","path":null,"size_bytes":6864,"size_tokens":null},"server/ai/clients.ts":{"content":"/**\n * AI Clients - 4-Model Architecture\n * - Scout (Llama 4 via Groq): PRIMARY - Fast queries (Fast)\n * - Sonnet 3.5/4.5 (Claude): REASONING - Multi-step logic (Smart)\n * - GPT-5 (OpenAI): MATH - Advanced calculations (Math)\n * - Opus 4.1 (Claude): CFO-LEVEL - Portfolio analysis (CFO)\n * \n * Standardized interface for all providers with cost tracking\n * Return shape: { text, tokensIn, tokensOut, cost, model }\n * \n * Features:\n * - Retry logic with exponential backoff for transient failures\n * - Graceful error handling with user-friendly messages\n * - Circuit-breaker pattern for provider outages\n * - Structured logging for production observability\n */\n\nimport Groq from \"groq-sdk\";\nimport Anthropic from \"@anthropic-ai/sdk\";\nimport OpenAI from \"openai\";\nimport { getAIConfig, type ModelId } from '../config/ai';\nimport { aiLogger } from '../utils/logger';\n\n// Retry configuration\nconst RETRY_CONFIG = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 10000,\n  retryableStatusCodes: [429, 500, 502, 503, 504],\n};\n\n// Error types for categorization\nexport interface AIClientError extends Error {\n  code: 'rate_limit' | 'provider_error' | 'timeout' | 'auth_error' | 'unknown';\n  retryable: boolean;\n  statusCode?: number;\n  provider: string;\n}\n\n/**\n * Create a standardized AI client error\n */\nfunction createAIClientError(\n  message: string,\n  code: AIClientError['code'],\n  provider: string,\n  statusCode?: number\n): AIClientError {\n  const error = new Error(message) as AIClientError;\n  error.code = code;\n  error.retryable = code === 'rate_limit' || code === 'provider_error';\n  error.statusCode = statusCode;\n  error.provider = provider;\n  return error;\n}\n\n/**\n * Sleep for exponential backoff\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Coerce tool arguments to proper types\n * Fixes common LLM issues like returning \"true\" instead of true\n */\nfunction coerceToolArguments(args: Record<string, any>): Record<string, any> {\n  const coerced: Record<string, any> = {};\n  for (const [key, value] of Object.entries(args)) {\n    if (value === \"true\" || value === \"True\" || value === \"TRUE\") {\n      coerced[key] = true;\n    } else if (value === \"false\" || value === \"False\" || value === \"FALSE\") {\n      coerced[key] = false;\n    } else if (typeof value === 'string' && /^-?\\d+(\\.\\d+)?$/.test(value.replace(/[$,]/g, ''))) {\n      // Keep numeric strings as strings (they might be amounts like \"5000000\")\n      coerced[key] = value;\n    } else if (typeof value === 'object' && value !== null) {\n      // Recursively coerce nested objects\n      coerced[key] = coerceToolArguments(value);\n    } else {\n      coerced[key] = value;\n    }\n  }\n  return coerced;\n}\n\n/**\n * Calculate exponential backoff delay with jitter\n */\nfunction getBackoffDelay(attempt: number): number {\n  const delay = Math.min(\n    RETRY_CONFIG.baseDelayMs * Math.pow(2, attempt),\n    RETRY_CONFIG.maxDelayMs\n  );\n  // Add jitter (0-30% of delay)\n  return delay + Math.random() * delay * 0.3;\n}\n\n/**\n * Determine if an error is retryable\n */\nfunction isRetryableError(error: any): boolean {\n  // Rate limit errors\n  if (error.status === 429 || error.code === 'rate_limit_exceeded') {\n    return true;\n  }\n  // Server errors (5xx)\n  if (error.status >= 500 && error.status < 600) {\n    return true;\n  }\n  // Network errors\n  if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT') {\n    return true;\n  }\n  return false;\n}\n\n/**\n * Generic retry wrapper for AI API calls\n */\nasync function withRetry<T>(\n  operation: () => Promise<T>,\n  provider: string,\n  operationName: string\n): Promise<T> {\n  let lastError: any;\n  \n  for (let attempt = 0; attempt < RETRY_CONFIG.maxRetries; attempt++) {\n    try {\n      return await operation();\n    } catch (error: any) {\n      lastError = error;\n      \n      // Log the error with structured context\n      aiLogger.warn(`${provider} ${operationName} attempt ${attempt + 1} failed`, {\n        data: {\n          provider,\n          operation: operationName,\n          attempt: attempt + 1,\n          errorMessage: error.message,\n          statusCode: error.status,\n        }\n      });\n      \n      // Don't retry if not retryable or last attempt\n      if (!isRetryableError(error) || attempt === RETRY_CONFIG.maxRetries - 1) {\n        break;\n      }\n      \n      // Wait before retrying\n      const delay = getBackoffDelay(attempt);\n      aiLogger.debug(`${provider} retrying in ${Math.round(delay)}ms`);\n      await sleep(delay);\n    }\n  }\n  \n  // Categorize the final error\n  const statusCode = lastError?.status || lastError?.statusCode;\n  let errorCode: AIClientError['code'] = 'unknown';\n  let message = 'An unexpected error occurred';\n  \n  if (statusCode === 429) {\n    errorCode = 'rate_limit';\n    message = 'AI service is temporarily overloaded. Please try again in a moment.';\n  } else if (statusCode === 401 || statusCode === 403) {\n    errorCode = 'auth_error';\n    message = 'AI service configuration error. Please contact support.';\n  } else if (statusCode >= 500) {\n    errorCode = 'provider_error';\n    message = 'AI service is temporarily unavailable. Please try again.';\n  } else if (lastError?.code === 'ETIMEDOUT') {\n    errorCode = 'timeout';\n    message = 'AI request timed out. Please try a simpler question.';\n  }\n  \n  throw createAIClientError(\n    `${provider} error: ${message}`,\n    errorCode,\n    provider,\n    statusCode\n  );\n}\n\n// Tool call interface\nexport interface ToolCall {\n  id: string;\n  type: 'function';\n  function: {\n    name: string;\n    arguments: any; // Parsed JSON object (not string)\n  };\n}\n\n// Standardized response shape\nexport interface AIResponse {\n  text: string;\n  tokensIn: number;\n  tokensOut: number;\n  cost: number;\n  model: string;\n  toolCalls?: ToolCall[]; // Optional array of tool calls from the AI\n}\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n}\n\nexport interface ChatOptions {\n  messages: ChatMessage[];\n  system?: string;\n  tools?: any[];\n  maxTokens?: number;\n  temperature?: number;\n}\n\n// Streaming chunk interface\nexport interface StreamChunk {\n  type: 'text' | 'tool_call' | 'done' | 'error';\n  content?: string;\n  toolCall?: ToolCall;\n  error?: string;\n  // Final metadata when done\n  tokensIn?: number;\n  tokensOut?: number;\n  cost?: number;\n  model?: string;\n}\n\n/**\n * GPT-5 Client (OpenAI via Replit AI Integrations)\n * MATH MODEL - Advanced math, projections, simulations (Pro: 5/month, Enterprise: 10/month)\n */\nexport class GPT5Client {\n  private openai: OpenAI;\n  private model = 'gpt-5';\n  \n  constructor() {\n    this.openai = new OpenAI({\n      apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY || '',\n      baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL || 'https://api.openai.com/v1',\n    });\n  }\n  \n  async chat(options: ChatOptions): Promise<AIResponse> {\n    const {\n      messages,\n      system,\n      tools,\n      maxTokens = 8192,\n      temperature = 0.7,\n    } = options;\n    \n    // Build OpenAI message format\n    const openaiMessages = messages.map(msg => ({\n      role: msg.role,\n      content: msg.content,\n    }));\n    \n    // Add system message if provided\n    if (system) {\n      openaiMessages.unshift({\n        role: 'system' as const,\n        content: system,\n      });\n    }\n    \n    return withRetry(async () => {\n      const completion = await this.openai.chat.completions.create({\n        model: this.model,\n        messages: openaiMessages,\n        max_tokens: maxTokens,\n        temperature,\n        tools: tools as any,\n      });\n      \n      const message = completion.choices[0]?.message;\n      const text = message?.content || '';\n      const tokensIn = completion.usage?.prompt_tokens || 0;\n      const tokensOut = completion.usage?.completion_tokens || 0;\n      \n      // Extract tool calls from OpenAI response\n      const toolCalls: ToolCall[] | undefined = message?.tool_calls\n        ?.filter((tc: any) => tc.type === 'function' && tc.function)\n        .map((tc: any) => {\n          try {\n            const parsedArgs = JSON.parse(tc.function.arguments);\n            // Coerce string booleans to actual booleans\n            const coercedArgs = coerceToolArguments(parsedArgs);\n            return {\n              id: tc.id,\n              type: 'function' as const,\n              function: {\n                name: tc.function.name,\n                arguments: coercedArgs,\n              },\n            };\n          } catch (error) {\n            console.error('[GPT5Client] Failed to parse tool call arguments:', error);\n            return null;\n          }\n        })\n        .filter((tc): tc is ToolCall => tc !== null);\n      \n      // Calculate cost (GPT-5 includes reasoning tokens in output)\n      const aiConfig = getAIConfig();\n      const cost = aiConfig.estimateCost(\n        'gpt-5' as ModelId,\n        tokensIn,\n        tokensOut\n      );\n      \n      return {\n        text,\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.model,\n        toolCalls: toolCalls && toolCalls.length > 0 ? toolCalls : undefined,\n      };\n    }, 'GPT5Client', 'chat');\n  }\n  \n  async *chatStream(options: ChatOptions): AsyncGenerator<StreamChunk> {\n    const {\n      messages,\n      system,\n      maxTokens = 8192,\n      temperature = 0.7,\n    } = options;\n    \n    const openaiMessages = messages.map(msg => ({\n      role: msg.role,\n      content: msg.content,\n    }));\n    \n    if (system) {\n      openaiMessages.unshift({\n        role: 'system' as const,\n        content: system,\n      });\n    }\n    \n    try {\n      const stream = await this.openai.chat.completions.create({\n        model: this.model,\n        messages: openaiMessages,\n        max_tokens: maxTokens,\n        temperature,\n        stream: true,\n        stream_options: { include_usage: true },\n      });\n      \n      let fullText = '';\n      let tokensIn = 0;\n      let tokensOut = 0;\n      \n      for await (const chunk of stream) {\n        const delta = chunk.choices[0]?.delta;\n        if (delta?.content) {\n          fullText += delta.content;\n          yield { type: 'text', content: delta.content };\n        }\n        \n        if (chunk.usage) {\n          tokensIn = chunk.usage.prompt_tokens || 0;\n          tokensOut = chunk.usage.completion_tokens || 0;\n        }\n      }\n      \n      const aiConfig = getAIConfig();\n      const cost = aiConfig.estimateCost('gpt-5' as ModelId, tokensIn, tokensOut);\n      \n      yield {\n        type: 'done',\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.model,\n      };\n    } catch (error: any) {\n      yield { type: 'error', error: error.message || 'GPT-5 streaming failed' };\n    }\n  }\n}\n\n/**\n * Scout Client (Groq Llama 4)\n * PRIMARY MODEL - Fast queries, budgeting, spending (Free: 50/month, Pro/Enterprise: unlimited)\n */\nexport class ScoutClient {\n  private groq: Groq;\n  private config = getAIConfig().scout;\n  \n  constructor() {\n    this.groq = new Groq({\n      apiKey: this.config.apiKey,\n    });\n  }\n  \n  async chat(options: ChatOptions): Promise<AIResponse> {\n    const {\n      messages,\n      system,\n      tools,\n      maxTokens = this.config.maxTokens,\n      temperature = this.config.temperature,\n    } = options;\n    \n    // Build Groq message format\n    const groqMessages = messages.map(msg => ({\n      role: msg.role === 'system' ? 'system' as const : msg.role,\n      content: msg.content,\n    }));\n    \n    // Add system message if provided\n    if (system) {\n      groqMessages.unshift({\n        role: 'system',\n        content: system,\n      });\n    }\n    \n    return withRetry(async () => {\n      const completion = await this.groq.chat.completions.create({\n        model: this.config.model,\n        messages: groqMessages,\n        max_tokens: maxTokens,\n        temperature,\n        tools: tools as any,\n      });\n      \n      const message = completion.choices[0]?.message;\n      const text = message?.content || '';\n      const tokensIn = completion.usage?.prompt_tokens || 0;\n      const tokensOut = completion.usage?.completion_tokens || 0;\n      \n      // Extract tool calls from Groq response (same format as OpenAI)\n      const toolCalls: ToolCall[] | undefined = message?.tool_calls\n        ?.filter((tc: any) => tc.type === 'function' && tc.function)\n        .map((tc: any) => {\n          try {\n            const parsedArgs = JSON.parse(tc.function.arguments);\n            // Coerce string booleans to actual booleans (Scout/Llama often returns \"true\" instead of true)\n            const coercedArgs = coerceToolArguments(parsedArgs);\n            return {\n              id: tc.id,\n              type: 'function' as const,\n              function: {\n                name: tc.function.name,\n                arguments: coercedArgs,\n              },\n            };\n          } catch (error) {\n            console.error('[ScoutClient] Failed to parse tool call arguments:', error);\n            return null;\n          }\n        })\n        .filter((tc): tc is ToolCall => tc !== null);\n      \n      // Calculate cost\n      const aiConfig = getAIConfig();\n      const cost = aiConfig.estimateCost(\n        this.config.model as ModelId,\n        tokensIn,\n        tokensOut\n      );\n      \n      return {\n        text,\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.config.model,\n        toolCalls: toolCalls && toolCalls.length > 0 ? toolCalls : undefined,\n      };\n    }, 'ScoutClient', 'chat');\n  }\n  \n  async *chatStream(options: ChatOptions): AsyncGenerator<StreamChunk> {\n    const {\n      messages,\n      system,\n      maxTokens = this.config.maxTokens,\n      temperature = this.config.temperature,\n    } = options;\n    \n    const groqMessages = messages.map(msg => ({\n      role: msg.role === 'system' ? 'system' as const : msg.role,\n      content: msg.content,\n    }));\n    \n    if (system) {\n      groqMessages.unshift({\n        role: 'system',\n        content: system,\n      });\n    }\n    \n    try {\n      const stream = await this.groq.chat.completions.create({\n        model: this.config.model,\n        messages: groqMessages,\n        max_tokens: maxTokens,\n        temperature,\n        stream: true,\n      });\n      \n      let fullText = '';\n      let tokensIn = 0;\n      let tokensOut = 0;\n      \n      for await (const chunk of stream) {\n        const delta = chunk.choices[0]?.delta;\n        if (delta?.content) {\n          fullText += delta.content;\n          yield { type: 'text', content: delta.content };\n        }\n        \n        if (chunk.x_groq?.usage) {\n          tokensIn = chunk.x_groq.usage.prompt_tokens || 0;\n          tokensOut = chunk.x_groq.usage.completion_tokens || 0;\n        }\n      }\n      \n      const aiConfig = getAIConfig();\n      const cost = aiConfig.estimateCost(this.config.model as ModelId, tokensIn, tokensOut);\n      \n      yield {\n        type: 'done',\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.config.model,\n      };\n    } catch (error: any) {\n      yield { type: 'error', error: error.message || 'Scout streaming failed' };\n    }\n  }\n}\n\n/**\n * Anthropic Client (Claude Sonnet 3.5/4.5 and Opus 4.1)\n * REASONING + CFO-LEVEL - Sonnet for strategy (Pro: 25 queries/month, Enterprise: 60 queries/month)\n * Opus for CFO analysis (Enterprise only: 20 queries/month)\n */\nexport class AnthropicClient {\n  private anthropic: Anthropic;\n  private model: string;\n  private modelType: 'opus' | 'sonnet'; // Track which type for config lookup\n  \n  constructor(model: 'claude-sonnet-4-5' | 'claude-opus-4-1') {\n    const config = getAIConfig();\n    this.modelType = model.includes('opus') ? 'opus' : 'sonnet';\n    const modelConfig = config.reasoning; // Both use the same reasoning config\n    \n    this.model = model; // Use exact model name passed in\n    this.anthropic = new Anthropic({\n      apiKey: modelConfig.apiKey,\n      baseURL: modelConfig.baseURL,\n    });\n  }\n  \n  async chat(options: ChatOptions): Promise<AIResponse> {\n    const config = getAIConfig();\n    const modelConfig = config.reasoning;\n    \n    const {\n      messages,\n      system,\n      tools,\n      maxTokens = modelConfig.maxTokens,\n      temperature = modelConfig.temperature,\n    } = options;\n    \n    // Build Anthropic message format (exclude system messages from messages array)\n    const anthropicMessages = messages\n      .filter(msg => msg.role !== 'system')\n      .map(msg => ({\n        role: msg.role as 'user' | 'assistant',\n        content: msg.content,\n      }));\n    \n    const clientName = this.modelType === 'opus' ? 'OpusClient' : 'SonnetClient';\n    \n    return withRetry(async () => {\n      const message = await this.anthropic.messages.create({\n        model: this.model,\n        max_tokens: maxTokens,\n        temperature,\n        system: system || undefined,\n        messages: anthropicMessages,\n        tools: tools as any,\n      });\n      \n      // Extract text from response\n      const textContent = message.content.find(block => block.type === 'text');\n      const text = textContent && textContent.type === 'text' ? textContent.text : '';\n      \n      // Extract tool calls from Anthropic response (they use 'tool_use' blocks)\n      const toolUseBlocks = message.content.filter(block => block.type === 'tool_use');\n      const toolCalls: ToolCall[] | undefined = toolUseBlocks.length > 0\n        ? toolUseBlocks.map((block: any) => ({\n            id: block.id,\n            type: 'function' as const,\n            function: {\n              name: block.name,\n              // Coerce string booleans to actual booleans\n              arguments: coerceToolArguments(block.input || {}),\n            },\n          }))\n        : undefined;\n      \n      const tokensIn = message.usage.input_tokens || 0;\n      const tokensOut = message.usage.output_tokens || 0;\n      \n      // Calculate cost\n      const cost = config.estimateCost(\n        this.model as ModelId,\n        tokensIn,\n        tokensOut\n      );\n      \n      return {\n        text,\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.model,\n        toolCalls,\n      };\n    }, clientName, 'chat');\n  }\n  \n  async *chatStream(options: ChatOptions): AsyncGenerator<StreamChunk> {\n    const config = getAIConfig();\n    const modelConfig = config.reasoning;\n    \n    const {\n      messages,\n      system,\n      maxTokens = modelConfig.maxTokens,\n      temperature = modelConfig.temperature,\n    } = options;\n    \n    const anthropicMessages = messages\n      .filter(msg => msg.role !== 'system')\n      .map(msg => ({\n        role: msg.role as 'user' | 'assistant',\n        content: msg.content,\n      }));\n    \n    try {\n      const stream = this.anthropic.messages.stream({\n        model: this.model,\n        max_tokens: maxTokens,\n        temperature,\n        system: system || undefined,\n        messages: anthropicMessages,\n      });\n      \n      let tokensIn = 0;\n      let tokensOut = 0;\n      \n      for await (const event of stream) {\n        if (event.type === 'content_block_delta') {\n          const delta = event.delta as any;\n          if (delta.type === 'text_delta' && delta.text) {\n            yield { type: 'text', content: delta.text };\n          }\n        }\n        \n        if (event.type === 'message_delta') {\n          const usage = (event as any).usage;\n          if (usage) {\n            tokensOut = usage.output_tokens || 0;\n          }\n        }\n        \n        if (event.type === 'message_start') {\n          const message = (event as any).message;\n          if (message?.usage) {\n            tokensIn = message.usage.input_tokens || 0;\n          }\n        }\n      }\n      \n      const cost = config.estimateCost(this.model as ModelId, tokensIn, tokensOut);\n      \n      yield {\n        type: 'done',\n        tokensIn,\n        tokensOut,\n        cost,\n        model: this.model,\n      };\n    } catch (error: any) {\n      yield { type: 'error', error: error.message || 'Anthropic streaming failed' };\n    }\n  }\n}\n\n/**\n * Legacy Reasoning Client - For backward compatibility\n * @deprecated Use getSonnetClient() or getOpusClient() directly\n */\nexport class ReasoningClient extends AnthropicClient {\n  constructor() {\n    super('claude-opus-4-1');\n  }\n}\n\n// Singleton instances\nlet gpt5Client: GPT5Client | null = null;\nlet scoutClient: ScoutClient | null = null;\nlet sonnetClient: AnthropicClient | null = null;\nlet opusClient: AnthropicClient | null = null;\nlet reasoningClient: ReasoningClient | null = null;\n\n/**\n * Get GPT-5 client (cached singleton)\n * MATH MODEL for advanced calculations (Pro: 5/month, Enterprise: 10/month)\n */\nexport function getGPT5Client(): GPT5Client {\n  if (!gpt5Client) {\n    gpt5Client = new GPT5Client();\n  }\n  return gpt5Client;\n}\n\n/**\n * Get Scout client (cached singleton)\n * PRIMARY MODEL - Unlimited for Pro/Enterprise, 50/month for Free\n */\nexport function getScoutClient(): ScoutClient {\n  if (!scoutClient) {\n    scoutClient = new ScoutClient();\n  }\n  return scoutClient;\n}\n\n/**\n * Get Sonnet client (cached singleton)\n * REASONING MODEL for Pro/Enterprise - Multi-step logic, strategy\n */\nexport function getSonnetClient(): AnthropicClient {\n  if (!sonnetClient) {\n    sonnetClient = new AnthropicClient('claude-sonnet-4-5');\n  }\n  return sonnetClient;\n}\n\n/**\n * Get Opus client (cached singleton)\n * CFO-LEVEL MODEL for Enterprise only - Portfolio analysis, high-stakes\n */\nexport function getOpusClient(): AnthropicClient {\n  if (!opusClient) {\n    opusClient = new AnthropicClient('claude-opus-4-1');\n  }\n  return opusClient;\n}\n\n/**\n * Get Reasoning client (cached singleton)\n * @deprecated Use getSonnetClient() for Pro/Enterprise or getOpusClient() for Enterprise CFO-level\n */\nexport function getReasoningClient(): ReasoningClient {\n  if (!reasoningClient) {\n    reasoningClient = new ReasoningClient();\n  }\n  return reasoningClient;\n}\n","path":null,"size_bytes":21800,"size_tokens":null},"server/ai/contextBuilder.ts":{"content":"/**\n * Context Builder - Normalize user financial data for AI models\n * \n * Pulls data from existing modules and formats it into a standardized\n * FinancialContext structure for both Scout and Reasoning models\n * \n * Includes country-specific financial intelligence for localized advice\n * \n * Features:\n * - Request-scoped caching to avoid repeated DB queries within same request\n * - TTL-based cache invalidation for data freshness\n * - Parallel data fetching for performance\n */\n\nimport type { IStorage } from '../storage';\nimport type {\n  UserFinancialProfile,\n  UserExpenseCategory,\n  UserDebt,\n  UserAsset,\n  FinancialGoal,\n  Transaction,\n} from '@shared/schema';\nimport { countryKnowledgeService, type CountryFinancialContext } from '../services/countryKnowledge';\n\n// Context cache configuration\nconst CONTEXT_CACHE_TTL_MS = 30000; // 30 seconds - balance between freshness and performance\nconst MAX_CACHE_SIZE = 100; // Maximum cached contexts\n\ninterface CachedContext {\n  context: FinancialContext;\n  timestamp: number;\n}\n\n// LRU cache for financial contexts\nconst contextCache = new Map<string, CachedContext>();\n\n/**\n * Get cached context if still valid\n */\nfunction getCachedContext(userId: string): FinancialContext | null {\n  const cached = contextCache.get(userId);\n  if (!cached) return null;\n  \n  const now = Date.now();\n  if (now - cached.timestamp > CONTEXT_CACHE_TTL_MS) {\n    contextCache.delete(userId);\n    return null;\n  }\n  \n  return cached.context;\n}\n\n/**\n * Cache a context with LRU eviction\n */\nfunction cacheContext(userId: string, context: FinancialContext): void {\n  // Evict oldest entries if cache is full\n  if (contextCache.size >= MAX_CACHE_SIZE) {\n    const oldestKey = contextCache.keys().next().value;\n    if (oldestKey) {\n      contextCache.delete(oldestKey);\n    }\n  }\n  \n  contextCache.set(userId, {\n    context,\n    timestamp: Date.now(),\n  });\n}\n\n/**\n * Invalidate cached context for a user (call after data updates)\n */\nexport function invalidateContextCache(userId: string): void {\n  contextCache.delete(userId);\n}\n\n/**\n * Clear entire context cache (for testing/admin)\n */\nexport function clearContextCache(): void {\n  contextCache.clear();\n}\n\n// Normalized financial context for AI models\nexport interface FinancialContext {\n  user: {\n    id: string;\n    countryCode: string;\n    region?: string;\n    age?: number;\n    riskTolerance?: 'low' | 'med' | 'high';\n  };\n  income: {\n    monthlyNet: number;\n    sources: Array<{ name: string; amount: number }>;\n  };\n  expenses: {\n    monthly: number;\n    byCategory: Record<string, number>;\n  };\n  debts: Array<{\n    name: string;\n    balance: number;\n    apr: number;\n    min: number;\n    monthlyPayment: number;\n  }>;\n  assets: Array<{\n    name: string;\n    value: number;\n    type: 'cash' | 'equity' | 'crypto' | 'bond' | 'real_estate' | 'vehicle' | 'other';\n  }>;\n  goals: Array<{\n    name: string;\n    horizonMonths: number;\n    target: number;\n    current: number;\n    progressPercent: number;\n    monthlyRequired: number;\n    onTrack: boolean;\n  }>;\n  recentTransactionsSample: Array<{\n    date: string;\n    desc: string;\n    amount: number;\n    category?: string;\n    type: 'income' | 'expense' | 'transfer';\n  }>;\n  // Enhanced analytics for proactive insights\n  analytics: {\n    savingsRate: number; // Percentage of income saved\n    netWorth: number; // Total assets - total debts\n    debtToIncomeRatio: number; // Monthly debt payments / monthly income\n    emergencyFundMonths: number; // Cash / monthly expenses\n    spendingTrends: {\n      currentMonth: number;\n      lastMonth: number;\n      monthOverMonthChange: number; // Percentage change\n      direction: 'up' | 'down' | 'stable';\n    };\n    categoryAnomalies: Array<{\n      category: string;\n      currentAmount: number;\n      averageAmount: number;\n      percentChange: number;\n      severity: 'low' | 'medium' | 'high';\n    }>;\n    financialHealthScore: number; // 0-100 score\n    topSpendingCategories: Array<{ category: string; amount: number; percent: number }>;\n    goalProgress: {\n      totalGoals: number;\n      onTrackGoals: number;\n      atRiskGoals: number;\n      completedGoals: number;\n    };\n  };\n  // Proactive insights generated from data\n  insights: Array<{\n    type: 'warning' | 'tip' | 'achievement' | 'opportunity';\n    title: string;\n    message: string;\n    priority: 'low' | 'medium' | 'high';\n  }>;\n  // Country-specific financial intelligence\n  countryContext?: {\n    countryName: string;\n    currency: string;\n    currencySymbol: string;\n    vatRate: number;\n    capitalGainsTaxRate: number;\n    costOfLivingIndex: number;\n    purchasingPowerIndex: number;\n    averageMonthlyIncome: number;\n    medianMonthlyIncome: number;\n    luxuryPricing: {\n      lamborghiniUrus: number;\n      porsche911: number;\n      rolexSubmariner: number;\n      medianHomeCity: number;\n      medianHomeSuburb: number;\n    };\n    economicSystem: string;\n    financialRegulations: string[];\n  };\n}\n\n/**\n * Build financial context from user data\n * Uses caching to avoid repeated DB queries for the same user within a short window\n * \n * @param userId - The user ID to build context for\n * @param storage - Storage interface for database access\n * @param skipCache - Force fresh data fetch (default: false)\n */\nexport async function buildFinancialContext(\n  userId: string,\n  storage: IStorage,\n  skipCache: boolean = false\n): Promise<FinancialContext> {\n  // Check cache first (unless explicitly skipped)\n  if (!skipCache) {\n    const cached = getCachedContext(userId);\n    if (cached) {\n      return cached;\n    }\n  }\n  \n  // Fetch all user financial data in parallel\n  const [\n    profile,\n    expenseCategories,\n    debts,\n    assets,\n    goals,\n    transactions,\n    allTransactions,\n    user,\n    userPreferences,\n  ] = await Promise.all([\n    storage.getUserFinancialProfile(userId).catch(() => null),\n    storage.getUserExpenseCategories(userId).catch(() => []),\n    storage.getUserDebts(userId).catch(() => []),\n    storage.getUserAssets(userId).catch(() => []),\n    storage.getFinancialGoalsByUserId(userId).catch(() => []),\n    storage.getTransactionsByUserId(userId, 20).catch(() => []), // Last 20 transactions for sample\n    storage.getTransactionsByUserId(userId, 1000).catch(() => []), // More transactions for calculating averages\n    storage.getUser(userId).catch(() => null),\n    storage.getUserPreferences(userId).catch(() => null),\n  ]);\n  \n  // Calculate income/expenses from real transaction data (last 6 months)\n  const sixMonthsAgo = new Date();\n  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);\n  \n  const recentTransactionsForCalc = allTransactions.filter(tx => {\n    const txDate = new Date(tx.date);\n    return txDate >= sixMonthsAgo;\n  });\n  \n  // Calculate from actual transactions\n  let calculatedIncome = 0;\n  let calculatedExpenses = 0;\n  for (const tx of recentTransactionsForCalc) {\n    const amount = Math.abs(parseFloat(tx.amount.toString()));\n    if (tx.type === 'income') {\n      calculatedIncome += amount;\n    } else if (tx.type === 'expense') {\n      calculatedExpenses += amount;\n    }\n  }\n  \n  // Calculate monthly averages (accounting for number of months with data)\n  const monthsWithData = recentTransactionsForCalc.length > 0 ? \n    Math.max(1, Math.min(6, Math.ceil((Date.now() - Math.min(...recentTransactionsForCalc.map(tx => new Date(tx.date).getTime()))) / (30.44 * 24 * 60 * 60 * 1000)))) \n    : 1;\n  \n  const avgMonthlyIncomeFromTx = Math.round(calculatedIncome / monthsWithData);\n  const avgMonthlyExpensesFromTx = Math.round(calculatedExpenses / monthsWithData);\n  \n  // Use calculated values if we have transaction data, otherwise fall back to manual profile values\n  const hasTransactionData = recentTransactionsForCalc.length >= 5; // Need at least 5 transactions to be meaningful\n  \n  const monthlyIncome = hasTransactionData && avgMonthlyIncomeFromTx > 0\n    ? avgMonthlyIncomeFromTx\n    : (profile?.monthlyIncome ? parseFloat(profile.monthlyIncome.toString()) : 0);\n  \n  const monthlyExpenses = hasTransactionData && avgMonthlyExpensesFromTx > 0\n    ? avgMonthlyExpensesFromTx\n    : (profile?.monthlyExpenses ? parseFloat(profile.monthlyExpenses.toString()) : 0);\n  \n  const monthlyNet = monthlyIncome - monthlyExpenses;\n  \n  // Build income sources - use transaction data if available\n  const incomeSources = monthlyIncome > 0\n    ? [{ \n        name: hasTransactionData ? 'Calculated from Transactions' : 'Primary Income (Manual)', \n        amount: monthlyIncome \n      }]\n    : [];\n  \n  // Build expense breakdown by category - use transaction data if available\n  const expensesByCategory: Record<string, number> = {};\n  \n  if (hasTransactionData) {\n    // Calculate from actual transactions\n    const expenseTransactions = recentTransactionsForCalc.filter(tx => tx.type === 'expense');\n    for (const tx of expenseTransactions) {\n      const category = tx.category || 'Other';\n      const amount = Math.abs(parseFloat(tx.amount.toString()));\n      expensesByCategory[category] = (expensesByCategory[category] || 0) + amount;\n    }\n    // Convert to monthly averages\n    for (const category in expensesByCategory) {\n      expensesByCategory[category] = Math.round(expensesByCategory[category] / monthsWithData);\n    }\n  } else {\n    // Fall back to manual expense categories\n    for (const cat of expenseCategories) {\n      expensesByCategory[cat.category] = parseFloat(cat.monthlyAmount.toString());\n    }\n  }\n  \n  // Normalize debts\n  const normalizedDebts = debts.map(debt => ({\n    name: debt.name,\n    balance: parseFloat(debt.balance.toString()),\n    apr: parseFloat(debt.interestRate.toString()),\n    min: parseFloat(debt.minimumPayment.toString()),\n    monthlyPayment: parseFloat(debt.monthlyPayment.toString()),\n  }));\n  \n  // Normalize assets\n  const normalizedAssets = assets.map(asset => {\n    // Map asset types to standard categories\n    let type: FinancialContext['assets'][0]['type'] = 'other';\n    \n    switch (typeof asset.type === 'string' ? asset.type.toLowerCase() : '') {\n      case 'savings':\n      case 'cash':\n        type = 'cash';\n        break;\n      case 'stocks':\n      case 'equity':\n      case 'etf':\n      case 'mutual fund':\n        type = 'equity';\n        break;\n      case 'bonds':\n      case 'bond':\n      case 'fixed income':\n      case 'treasury':\n        type = 'bond';\n        break;\n      case 'investment': // Generic - could be equity or bonds, default to equity\n        type = 'equity';\n        break;\n      case 'crypto':\n      case 'cryptocurrency':\n      case 'bitcoin':\n      case 'ethereum':\n        type = 'crypto';\n        break;\n      case 'real_estate':\n      case 'real estate':\n      case 'property':\n      case 'home':\n        type = 'real_estate';\n        break;\n      case 'vehicle':\n      case 'car':\n      case 'auto':\n        type = 'vehicle';\n        break;\n      default:\n        type = 'other';\n    }\n    \n    return {\n      name: asset.name,\n      value: parseFloat(asset.value.toString()),\n      type,\n    };\n  });\n  \n  // Normalize goals with enhanced progress tracking\n  const normalizedGoals = goals.map(goal => {\n    const targetDate = new Date(goal.targetDate);\n    const now = new Date();\n    const monthsDiff = Math.max(\n      0,\n      (targetDate.getFullYear() - now.getFullYear()) * 12 +\n      (targetDate.getMonth() - now.getMonth())\n    );\n    \n    const target = parseFloat(goal.targetAmount.toString());\n    const current = goal.currentAmount ? parseFloat(goal.currentAmount.toString()) : 0;\n    const progressPercent = target > 0 ? Math.round((current / target) * 100) : 0;\n    const remaining = Math.max(0, target - current);\n    const monthlyRequired = monthsDiff > 0 ? Math.max(0, Math.round(remaining / monthsDiff)) : Math.max(0, remaining);\n    \n    // Calculate if on track (can they save enough each month?)\n    // Clamp monthly savings to non-negative - negative savings means user can't make progress\n    const monthlySavings = Math.max(0, monthlyIncome - monthlyExpenses);\n    // Goal is on track if: already completed, or user can afford the monthly required amount\n    const onTrack = progressPercent >= 100 || (monthlySavings > 0 && monthlyRequired <= monthlySavings);\n    \n    return {\n      name: goal.title,\n      horizonMonths: monthsDiff,\n      target,\n      current,\n      progressPercent,\n      monthlyRequired,\n      onTrack,\n    };\n  });\n  \n  // Normalize recent transactions (last 20)\n  const recentTransactionsSample = transactions.slice(0, 20).map(tx => ({\n    date: tx.date.toISOString().split('T')[0], // YYYY-MM-DD\n    desc: tx.description || tx.category,\n    amount: parseFloat(tx.amount.toString()),\n    category: tx.category,\n    type: tx.type as 'income' | 'expense' | 'transfer',\n  }));\n  \n  // Build user metadata from preferences\n  const countryCode = userPreferences?.countryCode || 'US';\n  const userAge = undefined; // Could be calculated from DOB if available\n  const riskTolerance: 'low' | 'med' | 'high' = 'med'; // Could be from financial preferences\n  \n  // Get country-specific financial context\n  const countryData = countryKnowledgeService.getCountryContext(countryCode);\n  const countryContext = countryData ? {\n    countryName: countryData.countryName,\n    currency: countryData.currency,\n    currencySymbol: countryData.currencySymbol,\n    vatRate: countryData.vatRate,\n    capitalGainsTaxRate: countryData.capitalGainsTaxRate,\n    costOfLivingIndex: countryData.costOfLivingIndex,\n    purchasingPowerIndex: countryData.purchasingPowerIndex,\n    averageMonthlyIncome: countryData.averageMonthlyIncome,\n    medianMonthlyIncome: countryData.medianMonthlyIncome,\n    luxuryPricing: {\n      lamborghiniUrus: countryData.luxuryPricing.lamborghiniUrus,\n      porsche911: countryData.luxuryPricing.porsche911,\n      rolexSubmariner: countryData.luxuryPricing.rolexSubmariner,\n      medianHomeCity: countryData.luxuryPricing.medianHomePriceCity,\n      medianHomeSuburb: countryData.luxuryPricing.medianHomePriceSuburb,\n    },\n    economicSystem: countryData.economicSystem,\n    financialRegulations: countryData.financialRegulations,\n  } : undefined;\n  \n  // ========== ENHANCED ANALYTICS ==========\n  \n  // Calculate net worth\n  const totalAssets = normalizedAssets.reduce((sum, a) => sum + a.value, 0);\n  const totalDebts = normalizedDebts.reduce((sum, d) => sum + d.balance, 0);\n  const netWorth = totalAssets - totalDebts;\n  \n  // Calculate savings rate\n  const monthlySavings = monthlyIncome > 0 ? monthlyIncome - monthlyExpenses : 0;\n  const savingsRate = monthlyIncome > 0 ? Math.round((monthlySavings / monthlyIncome) * 100) : 0;\n  \n  // Calculate debt-to-income ratio\n  const totalMonthlyDebtPayments = normalizedDebts.reduce((sum, d) => sum + d.monthlyPayment, 0);\n  const debtToIncomeRatio = monthlyIncome > 0 ? Math.round((totalMonthlyDebtPayments / monthlyIncome) * 100) : 0;\n  \n  // Calculate emergency fund months\n  const cashAssets = normalizedAssets.filter(a => a.type === 'cash').reduce((sum, a) => sum + a.value, 0);\n  const emergencyFundMonths = monthlyExpenses > 0 ? Math.round((cashAssets / monthlyExpenses) * 10) / 10 : 0;\n  \n  // Calculate spending trends (current month vs last month)\n  const now = new Date();\n  const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n  const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n  const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);\n  \n  const currentMonthSpending = allTransactions\n    .filter(tx => tx.type === 'expense' && new Date(tx.date) >= currentMonthStart)\n    .reduce((sum, tx) => sum + Math.abs(parseFloat(tx.amount.toString())), 0);\n  \n  const lastMonthSpending = allTransactions\n    .filter(tx => {\n      const txDate = new Date(tx.date);\n      return tx.type === 'expense' && txDate >= lastMonthStart && txDate <= lastMonthEnd;\n    })\n    .reduce((sum, tx) => sum + Math.abs(parseFloat(tx.amount.toString())), 0);\n  \n  const monthOverMonthChange = lastMonthSpending > 0 \n    ? Math.round(((currentMonthSpending - lastMonthSpending) / lastMonthSpending) * 100)\n    : 0;\n  \n  const spendingDirection = monthOverMonthChange > 10 ? 'up' : monthOverMonthChange < -10 ? 'down' : 'stable';\n  \n  // Detect category anomalies (spending significantly above historical average)\n  const categoryAnomalies: FinancialContext['analytics']['categoryAnomalies'] = [];\n  const threeMonthsAgo = new Date();\n  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);\n  \n  // Build per-category monthly history for accurate anomaly detection\n  const categoryMonthlyHistory: Record<string, Record<string, number>> = {};\n  for (const tx of allTransactions.filter(t => t.type === 'expense' && new Date(t.date) >= threeMonthsAgo)) {\n    const cat = tx.category || 'Other';\n    const monthKey = `${new Date(tx.date).getFullYear()}-${new Date(tx.date).getMonth()}`;\n    if (!categoryMonthlyHistory[cat]) categoryMonthlyHistory[cat] = {};\n    if (!categoryMonthlyHistory[cat][monthKey]) categoryMonthlyHistory[cat][monthKey] = 0;\n    categoryMonthlyHistory[cat][monthKey] += Math.abs(parseFloat(tx.amount.toString()));\n  }\n  \n  // Current month key\n  const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;\n  \n  for (const [category, monthlyAmounts] of Object.entries(categoryMonthlyHistory)) {\n    const months = Object.entries(monthlyAmounts);\n    if (months.length < 2) continue; // Need at least 2 months of data\n    \n    // Calculate average excluding current month\n    const pastMonths = months.filter(([key]) => key !== currentMonthKey);\n    if (pastMonths.length === 0) continue;\n    \n    const avgAmount = pastMonths.reduce((sum, [, amt]) => sum + amt, 0) / pastMonths.length;\n    const currentAmount = monthlyAmounts[currentMonthKey] || 0;\n    \n    // Only flag if current month spending is significantly above historical average\n    if (avgAmount > 0 && currentAmount > avgAmount * 1.3 && currentAmount > 50) {\n      const percentChange = Math.round(((currentAmount - avgAmount) / avgAmount) * 100);\n      categoryAnomalies.push({\n        category,\n        currentAmount: Math.round(currentAmount),\n        averageAmount: Math.round(avgAmount),\n        percentChange,\n        severity: percentChange > 100 ? 'high' : percentChange > 50 ? 'medium' : 'low',\n      });\n    }\n  }\n  \n  // Sort by severity and percent change\n  categoryAnomalies.sort((a, b) => {\n    const severityOrder = { high: 0, medium: 1, low: 2 };\n    return severityOrder[a.severity] - severityOrder[b.severity] || b.percentChange - a.percentChange;\n  });\n  \n  // Calculate financial health score (0-100)\n  let healthScore = 50; // Base score\n  \n  // Savings rate impact (+/-20 points)\n  if (savingsRate >= 20) healthScore += 20;\n  else if (savingsRate >= 10) healthScore += 10;\n  else if (savingsRate < 0) healthScore -= 20;\n  else healthScore -= 10;\n  \n  // Emergency fund impact (+/-15 points)\n  if (emergencyFundMonths >= 6) healthScore += 15;\n  else if (emergencyFundMonths >= 3) healthScore += 8;\n  else if (emergencyFundMonths < 1) healthScore -= 15;\n  \n  // Debt-to-income impact (+/-15 points)\n  if (debtToIncomeRatio === 0) healthScore += 15;\n  else if (debtToIncomeRatio <= 20) healthScore += 8;\n  else if (debtToIncomeRatio > 40) healthScore -= 15;\n  \n  healthScore = Math.max(0, Math.min(100, healthScore));\n  \n  // Top spending categories\n  const sortedCategories = Object.entries(expensesByCategory)\n    .sort(([, a], [, b]) => b - a)\n    .slice(0, 5)\n    .map(([category, amount]) => ({\n      category,\n      amount: Math.round(amount),\n      percent: monthlyExpenses > 0 ? Math.round((amount / monthlyExpenses) * 100) : 0,\n    }));\n  \n  // Goal progress summary\n  const goalProgress = {\n    totalGoals: normalizedGoals.length,\n    onTrackGoals: normalizedGoals.filter(g => g.onTrack).length,\n    atRiskGoals: normalizedGoals.filter(g => !g.onTrack && g.progressPercent < 100).length,\n    completedGoals: normalizedGoals.filter(g => g.progressPercent >= 100).length,\n  };\n  \n  // ========== PROACTIVE INSIGHTS ==========\n  const insights: FinancialContext['insights'] = [];\n  \n  // Spending anomaly warnings\n  if (monthOverMonthChange > 25) {\n    insights.push({\n      type: 'warning',\n      title: 'Spending Spike Detected',\n      message: `Your spending is up ${monthOverMonthChange}% compared to last month. Review your recent transactions to identify the cause.`,\n      priority: 'high',\n    });\n  }\n  \n  // Category overspending\n  for (const anomaly of categoryAnomalies.slice(0, 2)) {\n    if (anomaly.severity === 'high') {\n      insights.push({\n        type: 'warning',\n        title: `High ${anomaly.category} Spending`,\n        message: `You've spent ${anomaly.percentChange}% more on ${anomaly.category} than your average. Consider reviewing these expenses.`,\n        priority: 'medium',\n      });\n    }\n  }\n  \n  // Emergency fund tip\n  if (emergencyFundMonths < 3 && monthlyExpenses > 0) {\n    insights.push({\n      type: 'tip',\n      title: 'Build Your Emergency Fund',\n      message: `You have ${emergencyFundMonths.toFixed(1)} months of expenses saved. Aim for 3-6 months for financial security.`,\n      priority: emergencyFundMonths < 1 ? 'high' : 'medium',\n    });\n  }\n  \n  // High savings rate achievement\n  if (savingsRate >= 30) {\n    insights.push({\n      type: 'achievement',\n      title: 'Excellent Savings Rate!',\n      message: `You're saving ${savingsRate}% of your income. You're on track for strong wealth building.`,\n      priority: 'low',\n    });\n  }\n  \n  // Goals at risk\n  const atRiskGoals = normalizedGoals.filter(g => !g.onTrack && g.horizonMonths > 0 && g.progressPercent < 100);\n  if (atRiskGoals.length > 0) {\n    insights.push({\n      type: 'warning',\n      title: `${atRiskGoals.length} Goal${atRiskGoals.length > 1 ? 's' : ''} At Risk`,\n      message: `${atRiskGoals[0].name} needs $${atRiskGoals[0].monthlyRequired}/month to stay on track. Consider adjusting your budget.`,\n      priority: 'high',\n    });\n  }\n  \n  // Debt payoff opportunity\n  if (normalizedDebts.length > 0 && savingsRate > 15) {\n    const highestAPR = normalizedDebts.reduce((max, d) => d.apr > max.apr ? d : max, normalizedDebts[0]);\n    if (highestAPR.apr > 10) {\n      insights.push({\n        type: 'opportunity',\n        title: 'Accelerate Debt Payoff',\n        message: `Your ${highestAPR.name} has ${highestAPR.apr}% interest. Consider putting extra savings toward this debt to save on interest.`,\n        priority: 'medium',\n      });\n    }\n  }\n\n  const context: FinancialContext = {\n    user: {\n      id: userId,\n      countryCode,\n      region: countryData?.region || 'north_america',\n      age: userAge,\n      riskTolerance,\n    },\n    income: {\n      monthlyNet,\n      sources: incomeSources,\n    },\n    expenses: {\n      monthly: monthlyExpenses,\n      byCategory: expensesByCategory,\n    },\n    debts: normalizedDebts,\n    assets: normalizedAssets,\n    goals: normalizedGoals,\n    recentTransactionsSample,\n    analytics: {\n      savingsRate,\n      netWorth,\n      debtToIncomeRatio,\n      emergencyFundMonths,\n      spendingTrends: {\n        currentMonth: Math.round(currentMonthSpending),\n        lastMonth: Math.round(lastMonthSpending),\n        monthOverMonthChange,\n        direction: spendingDirection,\n      },\n      categoryAnomalies,\n      financialHealthScore: healthScore,\n      topSpendingCategories: sortedCategories,\n      goalProgress,\n    },\n    insights,\n    countryContext,\n  };\n  \n  // Cache the context for future requests\n  cacheContext(userId, context);\n  \n  return context;\n}\n\n/**\n * Estimate token count for context (rough approximation)\n */\nexport function estimateContextTokens(context: FinancialContext): number {\n  // Very rough estimate: ~4 characters per token\n  const contextStr = JSON.stringify(context);\n  return Math.ceil(contextStr.length / 4);\n}\n","path":null,"size_bytes":23776,"size_tokens":null},"server/ai/orchestrators/retirement.ts":{"content":"/**\n * Retirement Orchestrator - CFO-level retirement planning\n * \n * Provides:\n * - Glidepath planning (asset allocation by age)\n * - Target retirement income projections\n * - Contribution optimization (401k, IRA, Roth)\n * - Retirement readiness scoring\n */\n\nimport type { FinancialContext } from '../contextBuilder';\nimport { getReasoningClient } from '../clients';\nimport { z } from 'zod';\n\n/**\n * Zod schema for retirement analysis validation\n */\nconst RetirementAnalysisSchema = z.object({\n  readiness: z.object({\n    score: z.number().min(0).max(100),\n    status: z.enum(['on_track', 'behind', 'ahead']),\n    yearsToRetirement: z.number().min(0).max(100),\n    monthlyGap: z.number(),\n  }),\n  glidepath: z.object({\n    current: z.object({\n      stocks: z.number().min(0).max(100),\n      bonds: z.number().min(0).max(100),\n      cash: z.number().min(0).max(100),\n    }),\n    target: z.object({\n      stocks: z.number().min(0).max(100),\n      bonds: z.number().min(0).max(100),\n      cash: z.number().min(0).max(100),\n    }),\n    reasoning: z.string().min(20),\n  }),\n  incomeProjection: z.object({\n    targetMonthlyIncome: z.number().min(0),\n    projectedMonthlyIncome: z.number().min(0),\n    sources: z.array(z.object({\n      name: z.string(),\n      monthlyAmount: z.number().min(0),\n    })),\n  }),\n  contributionStrategy: z.object({\n    monthlyTarget: z.number().min(0),\n    allocation: z.array(z.object({\n      account: z.string(),\n      monthlyAmount: z.number().min(0),\n      reason: z.string().min(10),\n    })),\n  }),\n  summary: z.string().min(50),\n});\n\n/**\n * Structured retirement analysis result\n */\nexport interface RetirementAnalysis {\n  // Retirement readiness\n  readiness: {\n    score: number; // 0-100\n    status: 'on_track' | 'behind' | 'ahead';\n    yearsToRetirement: number;\n    monthlyGap: number; // Amount to increase/decrease monthly savings\n  };\n  \n  // Recommended asset allocation glidepath\n  glidepath: {\n    current: { stocks: number; bonds: number; cash: number };\n    target: { stocks: number; bonds: number; cash: number };\n    reasoning: string;\n  };\n  \n  // Retirement income projection\n  incomeProjection: {\n    targetMonthlyIncome: number;\n    projectedMonthlyIncome: number;\n    sources: Array<{\n      name: string; // e.g., \"401k\", \"Social Security\", \"Rental Income\"\n      monthlyAmount: number;\n    }>;\n  };\n  \n  // Contribution strategy\n  contributionStrategy: {\n    monthlyTarget: number;\n    allocation: Array<{\n      account: string; // e.g., \"401k\", \"Roth IRA\", \"Taxable\"\n      monthlyAmount: number;\n      reason: string;\n    }>;\n  };\n  \n  // Natural language summary\n  summary: string;\n}\n\n/**\n * Orchestrate retirement planning using Claude Opus 4.1\n */\nexport async function analyzeRetirement(\n  context: FinancialContext,\n  userQuestion: string\n): Promise<RetirementAnalysis> {\n  const client = getReasoningClient();\n  \n  // Build structured prompt for CFO-level analysis\n  const prompt = buildRetirementPrompt(context, userQuestion);\n  \n  // Call Claude Opus 4.1 with structured output request\n  const response = await client.chat({\n    messages: [\n      {\n        role: 'system',\n        content: RETIREMENT_SYSTEM_PROMPT,\n      },\n      {\n        role: 'user',\n        content: prompt,\n      },\n    ],\n    temperature: 0.3, // Lower temperature for financial calculations\n    maxTokens: 2500,\n  });\n  \n  // Parse structured JSON response\n  const analysis = parseRetirementResponse(response.text);\n  \n  return analysis;\n}\n\n/**\n * System prompt for retirement analysis\n */\nconst RETIREMENT_SYSTEM_PROMPT = `You are Twealth AI's retirement planning specialist - a CFO-level financial advisor helping users build their retirement strategy.\n\nLANGUAGE MATCHING (CRITICAL): ALL text fields in your response MUST be in the SAME LANGUAGE the user writes in. If user writes in Thai, respond entirely in Thai. If Spanish, respond entirely in Spanish. This includes: \"reasoning\", \"summary\", \"reason\", and any other text. Numbers and field names stay as-is.\n\nYour task is to analyze the user's retirement readiness in Twealth and provide a comprehensive strategy.\n\n**Analysis Framework:**\n1. Current Position: Assess current retirement savings and asset allocation\n2. Target Income: Calculate target retirement income (typically 70-80% of current income)\n3. Glidepath Planning: Recommend age-appropriate asset allocation\n4. Contribution Strategy: Optimize 401k, IRA, Roth contributions\n5. Readiness Score: Calculate likelihood of reaching retirement goals\n\n**Output Requirements:**\nReturn a JSON object with this exact structure:\n\\`\\`\\`json\n{\n  \"readiness\": {\n    \"score\": 75,\n    \"status\": \"on_track\",\n    \"yearsToRetirement\": 25,\n    \"monthlyGap\": 0\n  },\n  \"glidepath\": {\n    \"current\": { \"stocks\": 60, \"bonds\": 30, \"cash\": 10 },\n    \"target\": { \"stocks\": 70, \"bonds\": 25, \"cash\": 5 },\n    \"reasoning\": \"At 40 years old with 25 years to retirement, increase stock allocation for growth\"\n  },\n  \"incomeProjection\": {\n    \"targetMonthlyIncome\": 6000,\n    \"projectedMonthlyIncome\": 5800,\n    \"sources\": [\n      { \"name\": \"401k\", \"monthlyAmount\": 4200 },\n      { \"name\": \"Social Security\", \"monthlyAmount\": 1600 }\n    ]\n  },\n  \"contributionStrategy\": {\n    \"monthlyTarget\": 1200,\n    \"allocation\": [\n      {\n        \"account\": \"401k (up to match)\",\n        \"monthlyAmount\": 500,\n        \"reason\": \"Capture full employer match (free money)\"\n      },\n      {\n        \"account\": \"Roth IRA\",\n        \"monthlyAmount\": 500,\n        \"reason\": \"Tax-free growth for long horizon\"\n      },\n      {\n        \"account\": \"Taxable brokerage\",\n        \"monthlyAmount\": 200,\n        \"reason\": \"Flexibility for early retirement goals\"\n      }\n    ]\n  },\n  \"summary\": \"Natural language summary with actionable next steps\"\n}\n\\`\\`\\`\n\n**Key Principles:**\n- Rule of 110: Target stock allocation = 110 - age (adjustable for risk tolerance)\n- 4% Rule: Can withdraw 4% of portfolio annually in retirement\n- Employer match beats everything (free money)\n- Roth for long horizons (>15 years), Traditional for near-term\n- Target 10-15x final salary saved by retirement\n- Social Security covers ~40% of pre-retirement income\n\n**Tone:** Professional, clear, actionable. No jargon. Explain trade-offs.`;\n\n/**\n * Build retirement analysis prompt with user context\n */\nfunction buildRetirementPrompt(context: FinancialContext, userQuestion: string): string {\n  const { user, income, expenses, assets, goals } = context;\n  \n  // Calculate retirement-specific metrics\n  const monthlyIncome = income.sources.reduce((sum, s) => sum + s.amount, 0);\n  const monthlySurplus = income.monthlyNet;\n  \n  // Calculate total retirement savings (equity + bonds)\n  const retirementSavings = assets\n    .filter(a => a.type === 'equity' || a.type === 'bond')\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  // Calculate current asset allocation\n  const totalInvested = assets\n    .filter(a => ['equity', 'bond', 'cash'].includes(a.type))\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  const stocksValue = assets\n    .filter(a => a.type === 'equity')\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  const bondsValue = assets\n    .filter(a => a.type === 'bond')\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  const cashValue = assets\n    .filter(a => a.type === 'cash')\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  let prompt = `**User Question:** ${userQuestion}\\n\\n`;\n  \n  prompt += `**Current Financial Situation:**\\n`;\n  prompt += `- Age: ${user.age || 'Not provided'}\\n`;\n  prompt += `- Monthly Income: $${monthlyIncome.toLocaleString()}\\n`;\n  prompt += `- Monthly Expenses: $${expenses.monthly.toLocaleString()}\\n`;\n  prompt += `- Monthly Surplus: $${monthlySurplus.toLocaleString()}\\n`;\n  prompt += `- Risk Tolerance: ${user.riskTolerance || 'medium'}\\n\\n`;\n  \n  prompt += `**Current Retirement Savings: $${retirementSavings.toLocaleString()}**\\n\\n`;\n  \n  // Safeguard: Only calculate percentages if totalInvested > 0\n  if (totalInvested > 0) {\n    const stocksPct = ((stocksValue / totalInvested) * 100).toFixed(1);\n    const bondsPct = ((bondsValue / totalInvested) * 100).toFixed(1);\n    const cashPct = ((cashValue / totalInvested) * 100).toFixed(1);\n    \n    prompt += `**Current Asset Allocation:**\\n`;\n    prompt += `- Stocks/Equity: ${stocksPct}% ($${stocksValue.toLocaleString()})\\n`;\n    prompt += `- Bonds: ${bondsPct}% ($${bondsValue.toLocaleString()})\\n`;\n    prompt += `- Cash: ${cashPct}% ($${cashValue.toLocaleString()})\\n\\n`;\n  } else {\n    prompt += `**Current Asset Allocation:** No investment assets found. Starting from zero.\\n\\n`;\n  }\n  \n  if (goals.length > 0) {\n    const retirementGoals = goals.filter(g => \n      g.name.toLowerCase().includes('retire') || \n      g.horizonMonths > 120 // >10 years\n    );\n    \n    if (retirementGoals.length > 0) {\n      prompt += `**Retirement Goals:**\\n`;\n      retirementGoals.forEach(g => {\n        prompt += `- ${g.name}: $${g.target.toLocaleString()} in ${Math.floor(g.horizonMonths / 12)} years (current: $${g.current.toLocaleString()})\\n`;\n      });\n      prompt += `\\n`;\n    }\n  }\n  \n  prompt += `Analyze this retirement situation and provide a comprehensive strategy. `;\n  prompt += `Return ONLY the JSON object specified in the system prompt, no additional text.`;\n  \n  return prompt;\n}\n\n/**\n * Parse Claude's response into structured RetirementAnalysis with strict validation\n */\nfunction parseRetirementResponse(responseText: string): RetirementAnalysis {\n  // Extract JSON from response (Claude might wrap it in markdown)\n  const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                    responseText.match(/\\{[\\s\\S]*\\}/);\n  \n  if (!jsonMatch) {\n    throw new Error(`Retirement orchestrator: No JSON found in Claude response. Response: ${responseText.substring(0, 200)}`);\n  }\n  \n  const jsonText = jsonMatch[1] || jsonMatch[0];\n  let parsed: unknown;\n  \n  try {\n    parsed = JSON.parse(jsonText);\n  } catch (error) {\n    throw new Error(`Retirement orchestrator: JSON parse error. ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n  \n  // Validate with Zod schema\n  const result = RetirementAnalysisSchema.safeParse(parsed);\n  \n  if (!result.success) {\n    console.error('Retirement analysis validation failed:', result.error.errors);\n    throw new Error(`Retirement orchestrator: Invalid response structure. Errors: ${JSON.stringify(result.error.errors)}`);\n  }\n  \n  return result.data;\n}\n","path":null,"size_bytes":10402,"size_tokens":null},"server/ai/orchestrators/debt.ts":{"content":"/**\n * Debt Orchestrator - CFO-level debt payoff analysis\n * \n * Provides:\n * - Snowball vs. Avalanche payoff ordering\n * - Invest vs. payoff simulations\n * - Multi-debt optimization strategies\n * - Payoff timeline projections\n */\n\nimport type { FinancialContext } from '../contextBuilder';\nimport { getReasoningClient } from '../clients';\nimport { z } from 'zod';\n\n/**\n * Zod schema for debt analysis validation\n */\nconst DebtAnalysisSchema = z.object({\n  strategy: z.object({\n    type: z.enum(['snowball', 'avalanche', 'hybrid', 'invest_and_payoff']),\n    reason: z.string().min(10),\n    projectedMonthsToDebtFree: z.number().min(0).max(600), // Max 50 years\n    totalInterestPaid: z.number().min(0),\n  }),\n  payoffOrder: z.array(z.object({\n    debtName: z.string(),\n    balance: z.number().min(0),\n    apr: z.number().min(0).max(100),\n    payoffMonth: z.number().int().min(1),\n    monthlyPayment: z.number().min(0),\n  })),\n  investVsPayoff: z.object({\n    investReturns: z.number(),\n    interestSaved: z.number(),\n    recommendation: z.enum(['invest', 'payoff', 'split']),\n    splitRatio: z.object({\n      invest: z.number().min(0).max(1),\n      payoff: z.number().min(0).max(1),\n    }).optional(),\n  }).optional(),\n  summary: z.string().min(50),\n});\n\n/**\n * Structured debt analysis result\n */\nexport interface DebtAnalysis {\n  // Recommended strategy\n  strategy: {\n    type: 'snowball' | 'avalanche' | 'hybrid' | 'invest_and_payoff';\n    reason: string;\n    projectedMonthsToDebtFree: number;\n    totalInterestPaid: number;\n  };\n  \n  // Payoff order\n  payoffOrder: Array<{\n    debtName: string;\n    balance: number;\n    apr: number;\n    payoffMonth: number; // Month in sequence (1, 2, 3...)\n    monthlyPayment: number;\n  }>;\n  \n  // Invest vs. payoff comparison (if applicable)\n  investVsPayoff?: {\n    investReturns: number; // 5-year projection\n    interestSaved: number; // By paying off debt\n    recommendation: 'invest' | 'payoff' | 'split';\n    splitRatio?: { invest: number; payoff: number }; // e.g., {invest: 0.6, payoff: 0.4}\n  };\n  \n  // Natural language summary\n  summary: string;\n}\n\n/**\n * Orchestrate debt payoff analysis using Claude Opus 4.1\n */\nexport async function analyzeDebt(\n  context: FinancialContext,\n  userQuestion: string\n): Promise<DebtAnalysis> {\n  // Validate input\n  if (context.debts.length === 0) {\n    throw new Error('Debt orchestrator: No debts found in user context');\n  }\n  \n  const client = getReasoningClient();\n  \n  // Build structured prompt for CFO-level analysis\n  const prompt = buildDebtPrompt(context, userQuestion);\n  \n  // Call Claude Opus 4.1 with structured output request\n  const response = await client.chat({\n    messages: [\n      {\n        role: 'system',\n        content: DEBT_SYSTEM_PROMPT,\n      },\n      {\n        role: 'user',\n        content: prompt,\n      },\n    ],\n    temperature: 0.3, // Lower temperature for financial calculations\n    maxTokens: 2000,\n  });\n  \n  // Parse structured JSON response with strict validation\n  const analysis = parseDebtResponse(response.text, context);\n  \n  return analysis;\n}\n\n/**\n * System prompt for debt analysis\n */\nconst DEBT_SYSTEM_PROMPT = `You are Twealth AI's debt optimization specialist - a CFO-level financial advisor helping users become debt-free.\n\nLANGUAGE MATCHING (CRITICAL): ALL text fields in your response MUST be in the SAME LANGUAGE the user writes in. If user writes in Thai, respond entirely in Thai. If Spanish, respond entirely in Spanish. This includes: \"reason\", \"summary\", descriptions, and any other text. Numbers and field names stay as-is.\n\nYour task is to analyze the user's debt situation in Twealth and provide a comprehensive payoff strategy.\n\n**Analysis Framework:**\n1. Debt Inventory: Review all debts (balances, APRs, minimum payments)\n2. Cash Flow Analysis: Calculate available monthly surplus for debt payoff\n3. Strategy Comparison:\n   - Snowball: Pay off smallest balance first (psychological wins)\n   - Avalanche: Pay off highest APR first (math optimal)\n   - Hybrid: Combine both based on debt characteristics\n4. Invest vs. Payoff: If user has investable income, compare returns\n5. Timeline Projection: Calculate months to debt-free with each strategy\n\n**Output Requirements:**\nReturn a JSON object with this exact structure:\n\\`\\`\\`json\n{\n  \"strategy\": {\n    \"type\": \"snowball\" | \"avalanche\" | \"hybrid\" | \"invest_and_payoff\",\n    \"reason\": \"Clear explanation of why this strategy is optimal\",\n    \"projectedMonthsToDebtFree\": 36,\n    \"totalInterestPaid\": 5420.50\n  },\n  \"payoffOrder\": [\n    {\n      \"debtName\": \"Credit Card A\",\n      \"balance\": 5000,\n      \"apr\": 18.99,\n      \"payoffMonth\": 12,\n      \"monthlyPayment\": 450\n    }\n  ],\n  \"investVsPayoff\": {\n    \"investReturns\": 8500,\n    \"interestSaved\": 6200,\n    \"recommendation\": \"payoff\",\n    \"splitRatio\": null\n  },\n  \"summary\": \"Natural language summary with actionable next steps\"\n}\n\\`\\`\\`\n\n**Key Principles:**\n- High-interest debt (>7% APR) almost always beats investing\n- Low-interest debt (<4% APR) may justify investing instead\n- Emergency fund takes priority over aggressive debt payoff\n- Employer match beats everything (free money)\n- Consider psychological factors (snowball motivation)\n\n**Tone:** Professional, clear, actionable. No jargon. Explain trade-offs.`;\n\n/**\n * Build debt analysis prompt with user context\n */\nfunction buildDebtPrompt(context: FinancialContext, userQuestion: string): string {\n  const { income, expenses, debts, goals, assets } = context;\n  \n  // Calculate financial metrics\n  const monthlyIncome = income.sources.reduce((sum, s) => sum + s.amount, 0);\n  const monthlyExpenses = expenses.monthly;\n  const monthlySurplus = income.monthlyNet;\n  const currentDebtPayments = debts.reduce((sum, d) => sum + d.monthlyPayment, 0);\n  const additionalPayoffCapacity = monthlySurplus - currentDebtPayments;\n  \n  // Calculate total savings from cash assets\n  const totalSavings = assets\n    .filter(a => a.type === 'cash')\n    .reduce((sum, a) => sum + a.value, 0);\n  \n  let prompt = `**User Question:** ${userQuestion}\\n\\n`;\n  \n  prompt += `**Financial Situation:**\\n`;\n  prompt += `- Monthly Income: $${monthlyIncome.toLocaleString()}\\n`;\n  prompt += `- Monthly Expenses: $${monthlyExpenses.toLocaleString()}\\n`;\n  prompt += `- Monthly Surplus: $${monthlySurplus.toLocaleString()}\\n`;\n  prompt += `- Total Cash/Savings: $${totalSavings.toLocaleString()}\\n\\n`;\n  \n  prompt += `**Debts (${debts.length} total):**\\n`;\n  debts.forEach((debt, i) => {\n    prompt += `${i + 1}. **${debt.name}**\\n`;\n    prompt += `   - Balance: $${debt.balance.toLocaleString()}\\n`;\n    prompt += `   - APR: ${debt.apr}%\\n`;\n    prompt += `   - Minimum Payment: $${debt.min.toLocaleString()}\\n`;\n    prompt += `   - Current Monthly Payment: $${debt.monthlyPayment.toLocaleString()}\\n`;\n  });\n  \n  prompt += `\\n**Additional Debt Payoff Capacity:** $${additionalPayoffCapacity.toLocaleString()}/month\\n\\n`;\n  \n  if (goals.length > 0) {\n    prompt += `**Active Goals:**\\n`;\n    goals.forEach(g => {\n      prompt += `- ${g.name}: $${g.target.toLocaleString()} (current: $${g.current.toLocaleString()})\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  prompt += `Analyze this debt situation and provide a comprehensive payoff strategy. `;\n  prompt += `Return ONLY the JSON object specified in the system prompt, no additional text.`;\n  \n  return prompt;\n}\n\n/**\n * Parse Claude's response into structured DebtAnalysis with strict validation\n */\nfunction parseDebtResponse(responseText: string, context: FinancialContext): DebtAnalysis {\n  // Extract JSON from response (Claude might wrap it in markdown)\n  const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                    responseText.match(/\\{[\\s\\S]*\\}/);\n  \n  if (!jsonMatch) {\n    throw new Error(`Debt orchestrator: No JSON found in Claude response. Response: ${responseText.substring(0, 200)}`);\n  }\n  \n  const jsonText = jsonMatch[1] || jsonMatch[0];\n  let parsed: unknown;\n  \n  try {\n    parsed = JSON.parse(jsonText);\n  } catch (error) {\n    throw new Error(`Debt orchestrator: JSON parse error. ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n  \n  // Validate with Zod schema\n  const result = DebtAnalysisSchema.safeParse(parsed);\n  \n  if (!result.success) {\n    console.error('Debt analysis validation failed:', result.error.errors);\n    throw new Error(`Debt orchestrator: Invalid response structure. Errors: ${JSON.stringify(result.error.errors)}`);\n  }\n  \n  return result.data;\n}\n","path":null,"size_bytes":8479,"size_tokens":null},"server/ai/orchestrators/tax.ts":{"content":"/**\n * Tax Orchestrator - CFO-level tax optimization\n * \n * Provides:\n * - Roth vs. Traditional IRA analysis\n * - Tax bracket optimization\n * - Multi-year tax strategy\n * - Tax-loss harvesting opportunities\n */\n\nimport type { FinancialContext } from '../contextBuilder';\nimport { getReasoningClient } from '../clients';\nimport { z } from 'zod';\n\n/**\n * Zod schema for tax analysis validation\n */\nconst TaxAnalysisSchema = z.object({\n  rothVsTraditional: z.object({\n    recommendation: z.enum(['roth', 'traditional', 'split']),\n    reason: z.string().min(20),\n    currentBracket: z.string(),\n    projectedRetirementBracket: z.string(),\n    splitRatio: z.object({\n      roth: z.number().min(0).max(1),\n      traditional: z.number().min(0).max(1),\n    }).optional(),\n  }),\n  strategies: z.array(z.object({\n    strategy: z.string(),\n    estimatedSavings: z.number().min(0),\n    complexity: z.enum(['low', 'medium', 'high']),\n    description: z.string().min(10),\n  })),\n  multiYearProjection: z.object({\n    currentYearTax: z.number().min(0),\n    fiveYearProjectedTax: z.number().min(0),\n    recommendedActions: z.array(z.string()),\n  }).optional(),\n  summary: z.string().min(50),\n});\n\n/**\n * Structured tax analysis result\n */\nexport interface TaxAnalysis {\n  // Roth vs Traditional recommendation\n  rothVsTraditional: {\n    recommendation: 'roth' | 'traditional' | 'split';\n    reason: string;\n    currentBracket: string; // e.g., \"22%\"\n    projectedRetirementBracket: string; // e.g., \"12%\"\n    splitRatio?: { roth: number; traditional: number }; // e.g., {roth: 0.6, traditional: 0.4}\n  };\n  \n  // Tax optimization strategies\n  strategies: Array<{\n    strategy: string;\n    estimatedSavings: number; // Annual tax savings\n    complexity: 'low' | 'medium' | 'high';\n    description: string;\n  }>;\n  \n  // Multi-year tax projection\n  multiYearProjection?: {\n    currentYearTax: number;\n    fiveYearProjectedTax: number;\n    recommendedActions: string[];\n  };\n  \n  // Natural language summary\n  summary: string;\n}\n\n/**\n * Orchestrate tax optimization using Claude Opus 4.1\n */\nexport async function analyzeTax(\n  context: FinancialContext,\n  userQuestion: string\n): Promise<TaxAnalysis> {\n  const client = getReasoningClient();\n  \n  // Build structured prompt for CFO-level analysis\n  const prompt = buildTaxPrompt(context, userQuestion);\n  \n  // Call Claude Opus 4.1 with structured output request\n  const response = await client.chat({\n    messages: [\n      {\n        role: 'system',\n        content: TAX_SYSTEM_PROMPT,\n      },\n      {\n        role: 'user',\n        content: prompt,\n      },\n    ],\n    temperature: 0.2, // Very low temperature for tax calculations\n    maxTokens: 2000,\n  });\n  \n  // Parse structured JSON response\n  const analysis = parseTaxResponse(response.text);\n  \n  return analysis;\n}\n\n/**\n * System prompt for tax analysis\n */\nconst TAX_SYSTEM_PROMPT = `You are Twealth AI's tax optimization specialist - a CFO-level financial advisor helping users minimize their tax burden.\n\nLANGUAGE MATCHING (CRITICAL): ALL text fields in your response MUST be in the SAME LANGUAGE the user writes in. If user writes in Thai, respond entirely in Thai. If Spanish, respond entirely in Spanish. This includes: \"reason\", \"summary\", \"description\", and any other text. Numbers and field names stay as-is.\n\nYour task is to analyze the user's tax situation in Twealth and provide optimization strategies.\n\n**Analysis Framework:**\n1. Current Tax Position: Estimate current marginal tax bracket\n2. Roth vs Traditional: Recommend optimal retirement account strategy\n3. Tax Optimization: Identify opportunities to reduce tax burden\n4. Multi-Year Planning: Project tax implications over time\n5. Implementation: Provide actionable steps\n\n**Output Requirements:**\nReturn a JSON object with this exact structure:\n\\`\\`\\`json\n{\n  \"rothVsTraditional\": {\n    \"recommendation\": \"roth\",\n    \"reason\": \"Currently in 22% bracket, expect 12% in retirement (lower bracket = Roth wins)\",\n    \"currentBracket\": \"22%\",\n    \"projectedRetirementBracket\": \"12%\",\n    \"splitRatio\": null\n  },\n  \"strategies\": [\n    {\n      \"strategy\": \"Max out employer 401k match\",\n      \"estimatedSavings\": 1200,\n      \"complexity\": \"low\",\n      \"description\": \"Free money + reduces taxable income\"\n    },\n    {\n      \"strategy\": \"Contribute to Roth IRA\",\n      \"estimatedSavings\": 0,\n      \"complexity\": \"low\",\n      \"description\": \"Tax-free growth and withdrawals in retirement\"\n    }\n  ],\n  \"multiYearProjection\": {\n    \"currentYearTax\": 15000,\n    \"fiveYearProjectedTax\": 78000,\n    \"recommendedActions\": [\n      \"Increase 401k contributions to reduce taxable income\",\n      \"Consider Roth conversions in low-income years\"\n    ]\n  },\n  \"summary\": \"Natural language summary with actionable next steps\"\n}\n\\`\\`\\`\n\n**Key Principles:**\n- Roth if expect higher bracket in retirement (young, low earner)\n- Traditional if expect lower bracket in retirement (peak earner, near retirement)\n- Employer match always comes before Roth vs Traditional debate\n- Tax diversification: Have both Roth and Traditional for flexibility\n- Standard deduction 2025: $14,600 single, $29,200 married\n- 2025 Tax Brackets (single): 10% ($0-$11,600), 12% ($11,600-$47,150), 22% ($47,150-$100,525), 24% ($100,525-$191,950), 32% ($191,950-$243,725), 35% ($243,725-$609,350), 37% ($609,350+)\n- Capital gains: 0% (income <$47,025), 15% ($47,025-$518,900), 20% ($518,900+)\n\n**Tone:** Professional, clear, actionable. Explain trade-offs. Acknowledge complexity but simplify.`;\n\n/**\n * Build tax analysis prompt with user context (enriched with filing status, deductions, etc.)\n */\nfunction buildTaxPrompt(context: FinancialContext, userQuestion: string): string {\n  const { user, income, expenses, assets, debts } = context;\n  \n  // Calculate tax-relevant metrics\n  const annualIncome = income.sources.reduce((sum, s) => sum + s.amount, 0) * 12;\n  const monthlySurplus = income.monthlyNet;\n  \n  // Calculate investment income (simplified estimate - 2% dividend yield assumption)\n  const investmentAssets = assets\n    .filter(a => a.type === 'equity' || a.type === 'bond')\n    .reduce((sum, a) => sum + a.value, 0);\n  const estimatedInvestmentIncome = investmentAssets * 0.02; // Annual dividends\n  \n  // Calculate mortgage interest deduction potential (from real estate debts)\n  const mortgageDebt = debts\n    .filter(d => d.name.toLowerCase().includes('mortgage') || d.name.toLowerCase().includes('home'))\n    .reduce((sum, d) => sum + (d.balance * (d.apr / 100)), 0);\n  \n  let prompt = `**User Question:** ${userQuestion}\\n\\n`;\n  \n  prompt += `**Tax-Relevant Information:**\\n`;\n  prompt += `- Estimated Annual W-2 Income: $${annualIncome.toLocaleString()}\\n`;\n  prompt += `- Estimated Investment Income: $${estimatedInvestmentIncome.toLocaleString()} (from dividends/interest)\\n`;\n  prompt += `- Monthly Surplus: $${monthlySurplus.toLocaleString()}\\n`;\n  prompt += `- Region: ${user.region || 'US'}\\n`;\n  prompt += `- Filing Status: Assume single (user should specify if married)\\n`;\n  prompt += `- Estimated Mortgage Interest Deduction: $${mortgageDebt.toLocaleString()}\\n\\n`;\n  \n  prompt += `**Investment Assets by Type:**\\n`;\n  const assetsByType = assets.reduce((acc, a) => {\n    acc[a.type] = (acc[a.type] || 0) + a.value;\n    return acc;\n  }, {} as Record<string, number>);\n  \n  for (const [type, value] of Object.entries(assetsByType)) {\n    prompt += `- ${type}: $${value.toLocaleString()}\\n`;\n  }\n  \n  prompt += `\\n**Note:** Adjust recommendations based on filing status (single vs married) and itemized deductions.\\n\\n`;\n  \n  prompt += `Analyze this tax situation and provide optimization strategies. `;\n  prompt += `Return ONLY the JSON object specified in the system prompt, no additional text.`;\n  \n  return prompt;\n}\n\n/**\n * Parse Claude's response into structured TaxAnalysis with strict validation\n */\nfunction parseTaxResponse(responseText: string): TaxAnalysis {\n  // Extract JSON from response (Claude might wrap it in markdown)\n  const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                    responseText.match(/\\{[\\s\\S]*\\}/);\n  \n  if (!jsonMatch) {\n    throw new Error(`Tax orchestrator: No JSON found in Claude response. Response: ${responseText.substring(0, 200)}`);\n  }\n  \n  const jsonText = jsonMatch[1] || jsonMatch[0];\n  let parsed: unknown;\n  \n  try {\n    parsed = JSON.parse(jsonText);\n  } catch (error) {\n    throw new Error(`Tax orchestrator: JSON parse error. ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n  \n  // Validate with Zod schema\n  const result = TaxAnalysisSchema.safeParse(parsed);\n  \n  if (!result.success) {\n    console.error('Tax analysis validation failed:', result.error.errors);\n    throw new Error(`Tax orchestrator: Invalid response structure. Errors: ${JSON.stringify(result.error.errors)}`);\n  }\n  \n  return result.data;\n}\n","path":null,"size_bytes":8858,"size_tokens":null},"server/ai/hybridAIService.ts":{"content":"/**\n * Hybrid AI Service - 4-Model Architecture (Scout/Sonnet/GPT-5/Opus)\n * \n * This service integrates all hybrid AI components:\n * - Scout (Llama 4 via Groq): PRIMARY - Fast queries, budgeting, spending\n * - Sonnet 3.5/4.5 (Claude): REASONING - Multi-step logic, strategy\n * - GPT-5 (OpenAI): MATH - Projections, simulations, calculations\n * - Opus 4.1 (Claude): CFO-LEVEL - Portfolio analysis, high-stakes\n * \n * Components:\n * - Smart router for complexity-based escalation\n * - Context builder for financial data normalization\n * - AI clients (Scout, Sonnet, GPT-5, Opus)\n * - Orchestrators for deep CFO-level analysis\n */\n\n// TESTING MODE: Set to true to bypass all quota limits and tier restrictions\n// REMEMBER TO SET BACK TO FALSE AFTER TESTING\nexport const TESTING_MODE = false;\n\nimport type { IStorage } from '../storage';\nimport { buildFinancialContext, estimateContextTokens, type FinancialContext } from './contextBuilder';\nimport { shouldEscalate, routeToModel, getRoutingReason, type ComplexitySignals } from './router';\nimport { getGPT5Client, getScoutClient, getSonnetClient, getOpusClient, getReasoningClient } from './clients';\nimport { analyzeDebt } from './orchestrators/debt';\nimport { analyzeRetirement } from './orchestrators/retirement';\nimport { analyzeTax } from './orchestrators/tax';\nimport { analyzePortfolio } from './orchestrators/portfolio';\nimport { getTwealthTools, getTwealthIdentity } from './tools';\nimport { marketDataService } from '../marketDataService';\n\n// Per-country cached market context to avoid repeated API calls\nconst cachedMarketContextByCountry = new Map<string, { data: string; timestamp: number }>();\nconst MARKET_CONTEXT_CACHE_DURATION = 15 * 60 * 1000; // 15 minutes\n\n/**\n * Get cached market context for AI prompts (country-specific caching)\n */\nasync function getMarketContextForPrompt(userCountry: string = 'US'): Promise<string> {\n  const cacheKey = userCountry.toUpperCase();\n  const cached = cachedMarketContextByCountry.get(cacheKey);\n  \n  if (cached && Date.now() - cached.timestamp < MARKET_CONTEXT_CACHE_DURATION) {\n    return cached.data;\n  }\n  \n  try {\n    const context = await marketDataService.getMarketContextForAI(userCountry);\n    cachedMarketContextByCountry.set(cacheKey, { data: context, timestamp: Date.now() });\n    return context;\n  } catch (error) {\n    console.error('[HybridAI] Error fetching market context:', error);\n    return ''; // Return empty string on error - prompts will work without it\n  }\n}\n\n/**\n * Model access levels (matches tier system)\n * Scout is PRIMARY, others are for escalation based on complexity\n */\nexport type ModelAccess = 'scout' | 'sonnet' | 'gpt5' | 'opus';\n\n/**\n * Conversation message for memory\n */\nexport interface ConversationMessage {\n  role: 'user' | 'assistant';\n  content: string;\n}\n\n/**\n * Options for generating AI advice\n */\nexport interface GenerateAdviceOptions {\n  forceModel?: ModelAccess; // Override auto-escalation with tier-selected model\n  preselectedContext?: FinancialContext; // Pre-built context to avoid double assembly\n  skipAutoEscalation?: boolean; // Disable internal escalation logic\n  conversationHistory?: ConversationMessage[]; // Previous messages for context\n  skipTools?: boolean; // Skip tool calling - use for plain text/JSON responses (e.g., playbooks)\n}\n\n/**\n * Structured response from hybrid AI service\n */\nexport interface HybridAIResponse {\n  answer: string; // Natural language response\n  modelUsed: 'scout' | 'sonnet' | 'gpt5' | 'opus' | 'reasoning'; // Which model was used (maps to quota counter)\n  modelSlug: string; // Exact model identifier (e.g., 'gpt-5', 'claude-opus-4-1')\n  tokensIn: number; // Input tokens\n  tokensOut: number; // Output tokens\n  cost: number; // Cost in USD\n  escalated: boolean; // Whether query was escalated from Scout\n  escalationReason?: string; // Why it was escalated (if applicable)\n  orchestratorUsed?: string; // Which orchestrator was called (if any)\n  structuredData?: any; // Structured data from orchestrator (if any)\n  tierDowngraded?: boolean; // Whether tier logic downgraded the model\n  actualModel?: 'scout' | 'sonnet' | 'gpt5' | 'opus'; // Actual model used (fallback for determineModelFromSlug)\n  toolCalls?: Array<{ id: string; type: 'function'; function: { name: string; arguments: any } }>; // Tool calls for action execution\n}\n\n/**\n * Main entry point for hybrid AI system\n * \n * @param userId - User ID for context building\n * @param userMessage - User's question/request\n * @param storage - Storage interface for data access\n * @param options - Optional configuration for forced model selection\n * @returns Structured AI response with metadata\n */\nexport async function generateHybridAdvice(\n  userId: string,\n  userMessage: string,\n  storage: IStorage,\n  options: GenerateAdviceOptions = {}\n): Promise<HybridAIResponse> {\n  const { forceModel, preselectedContext, skipAutoEscalation, conversationHistory = [], skipTools = false } = options;\n  \n  // Step 1: Build or use pre-selected financial context\n  const context = preselectedContext || await buildFinancialContext(userId, storage);\n  \n  // Add conversation history and skipTools flag to context for handlers\n  (context as any).conversationHistory = conversationHistory;\n  (context as any).skipTools = skipTools;\n  \n  // Step 2: Determine which model to use\n  let targetModel: ModelAccess;\n  let routingReason: string | undefined;\n  \n  if (forceModel) {\n    // Tier-aware router has pre-selected the model\n    targetModel = forceModel;\n    routingReason = `Tier-enforced model: ${forceModel}`;\n  } else if (skipAutoEscalation) {\n    // Skip escalation logic, use Scout\n    targetModel = 'scout';\n  } else {\n    // Auto-escalation based on complexity\n    const contextTokens = estimateContextTokens(context);\n    const signals: ComplexitySignals = {\n      message: userMessage,\n      debtsCount: context.debts.length,\n      assetsCount: context.assets.length,\n      messageLength: userMessage.length,\n      contextTokens,\n    };\n    \n    const escalate = shouldEscalate(signals);\n    routingReason = escalate ? getRoutingReason(signals) : undefined;\n    \n    // Default to Scout for simple, Opus for complex (tierAwareRouter will override this)\n    targetModel = escalate ? 'opus' : 'scout';\n  }\n  \n  // Step 3: Route to appropriate model/orchestrator\n  if (targetModel === 'scout') {\n    return await handleScoutQuery(userMessage, context);\n  } else if (targetModel === 'sonnet') {\n    return await handleReasoningQuery(userMessage, context, routingReason, 'sonnet');\n  } else if (targetModel === 'gpt5') {\n    return await handleGPT5Query(userMessage, context);\n  } else if (targetModel === 'opus') {\n    // Opus uses reasoning path with orchestrators\n    return await handleReasoningQuery(userMessage, context, routingReason, 'opus');\n  } else {\n    // Fallback to Scout\n    return await handleScoutQuery(userMessage, context);\n  }\n}\n\n/**\n * Handle queries with GPT-5 (OpenAI via Replit AI Integrations)\n * MATH MODEL - Advanced calculations, projections, simulations\n */\nasync function handleGPT5Query(\n  userMessage: string,\n  context: any\n): Promise<HybridAIResponse> {\n  const client = getGPT5Client();\n  \n  // Fetch market context for smarter financial advice\n  const marketContext = await getMarketContextForPrompt(context.countryContext?.countryCode || 'US');\n  \n  // Build optimized prompt with financial context\n  const systemPrompt = buildGPT5SystemPrompt(context, marketContext);\n  \n  // Build messages array with conversation history (last 6 messages for context)\n  const conversationHistory = (context.conversationHistory || []).slice(-6);\n  const messages: Array<{ role: 'system' | 'user' | 'assistant'; content: string }> = [\n    { role: 'system', content: systemPrompt },\n    ...conversationHistory.map((m: any) => ({ role: m.role, content: m.content })),\n    { role: 'user', content: userMessage },\n  ];\n  \n  const response = await client.chat({\n    messages,\n    tools: getTwealthTools(), // Pass tools for action-taking\n  });\n  \n  return {\n    answer: response.text,\n    modelUsed: 'gpt5', // CRITICAL: Use gpt5 to increment correct quota counter\n    modelSlug: response.model,\n    tokensIn: response.tokensIn,\n    tokensOut: response.tokensOut,\n    cost: response.cost,\n    escalated: true, // GPT-5 is an escalation from Scout\n    actualModel: 'gpt5', // Track actual model used\n    toolCalls: response.toolCalls, // Return tool calls for execution\n  };\n}\n\n/**\n * Handle simple/fast queries with Scout (Llama 4 via Groq)\n * PRIMARY MODEL - Fast queries, budgeting, spending, goals\n */\nasync function handleScoutQuery(\n  userMessage: string,\n  context: any\n): Promise<HybridAIResponse> {\n  const client = getScoutClient();\n  \n  // Fetch market context for smarter financial advice\n  const marketContext = await getMarketContextForPrompt(context.countryContext?.countryCode || 'US');\n  \n  // Build simple prompt with context\n  const systemPrompt = buildScoutSystemPrompt(context, marketContext);\n  \n  // Build messages array with conversation history (last 6 messages for context)\n  const conversationHistory = (context.conversationHistory || []).slice(-6);\n  const messages: Array<{ role: 'system' | 'user' | 'assistant'; content: string }> = [\n    { role: 'system', content: systemPrompt },\n    ...conversationHistory.map((m: any) => ({ role: m.role, content: m.content })),\n    { role: 'user', content: userMessage },\n  ];\n  \n  // Only pass tools if not in skipTools mode (for plain text/JSON responses)\n  const skipTools = context.skipTools === true;\n  \n  const response = await client.chat({\n    messages,\n    temperature: 0.7,\n    maxTokens: 1000,\n    tools: skipTools ? undefined : getTwealthTools(), // Skip tools for playbook generation\n  });\n  \n  return {\n    answer: response.text,\n    modelUsed: 'scout',\n    modelSlug: response.model,\n    tokensIn: response.tokensIn,\n    tokensOut: response.tokensOut,\n    cost: response.cost,\n    escalated: false,\n    actualModel: 'scout', // Track actual model used\n    toolCalls: response.toolCalls, // Return tool calls for execution\n  };\n}\n\n/**\n * Handle complex queries with Reasoning (Claude Sonnet or Opus) + orchestrators\n * Sonnet: REASONING - Multi-step logic, strategy\n * Opus: CFO-LEVEL - Portfolio analysis, high-stakes\n */\nasync function handleReasoningQuery(\n  userMessage: string,\n  context: any,\n  routingReason?: string,\n  targetModel: ModelAccess = 'sonnet'\n): Promise<HybridAIResponse> {\n  // Detect which orchestrator to use based on keywords\n  const orchestrator = detectOrchestrator(userMessage, context);\n  \n  if (orchestrator) {\n    // Call specialized orchestrator\n    return await callOrchestrator(orchestrator, userMessage, context, routingReason, targetModel);\n  } else {\n    // Generic reasoning query (no specific orchestrator)\n    return await handleGenericReasoningQuery(userMessage, context, routingReason, targetModel);\n  }\n}\n\n/**\n * Detect which orchestrator should handle the query\n */\nfunction detectOrchestrator(userMessage: string, context: any): string | null {\n  const msgLower = userMessage.toLowerCase();\n  \n  // Debt-related keywords\n  if (context.debts.length > 0 && \n      (msgLower.includes('debt') || \n       msgLower.includes('pay off') || \n       msgLower.includes('snowball') || \n       msgLower.includes('avalanche'))) {\n    return 'debt';\n  }\n  \n  // Retirement-related keywords\n  if (msgLower.includes('retire') || \n      msgLower.includes('retirement') || \n      msgLower.includes('glidepath') || \n      msgLower.includes('401k') || \n      msgLower.includes('ira')) {\n    return 'retirement';\n  }\n  \n  // Tax-related keywords\n  if (msgLower.includes('tax') || \n      msgLower.includes('roth') || \n      msgLower.includes('traditional') || \n      msgLower.includes('bracket')) {\n    return 'tax';\n  }\n  \n  // Portfolio-related keywords\n  if (context.assets.length > 0 && \n      (msgLower.includes('portfolio') || \n       msgLower.includes('asset allocation') || \n       msgLower.includes('rebalance') || \n       msgLower.includes('diversif'))) {\n    return 'portfolio';\n  }\n  \n  return null;\n}\n\n/**\n * Call the appropriate orchestrator\n */\nasync function callOrchestrator(\n  orchestrator: string,\n  userMessage: string,\n  context: any,\n  routingReason?: string,\n  targetModel: ModelAccess = 'opus'\n): Promise<HybridAIResponse> {\n  let structuredData: any;\n  let tokensIn = 0;\n  let tokensOut = 0;\n  let cost = 0;\n  \n  // Determine model slug for the target model\n  const modelSlug = targetModel === 'sonnet' ? 'claude-sonnet-4-5' : 'claude-opus-4-1';\n  \n  try {\n    switch (orchestrator) {\n      case 'debt':\n        structuredData = await analyzeDebt(context, userMessage);\n        // Estimate tokens (rough approximation)\n        tokensIn = Math.ceil((userMessage.length + JSON.stringify(context).length) / 4);\n        tokensOut = Math.ceil(structuredData.summary.length / 4);\n        // Use pricing for the actual model\n        const inputCost = targetModel === 'sonnet' ? 0.003 : 0.015; // $3 vs $15 per 1M\n        const outputCost = targetModel === 'sonnet' ? 0.015 : 0.075; // $15 vs $75 per 1M\n        cost = (tokensIn / 1000) * inputCost + (tokensOut / 1000) * outputCost;\n        break;\n      \n      case 'retirement':\n        structuredData = await analyzeRetirement(context, userMessage);\n        tokensIn = Math.ceil((userMessage.length + JSON.stringify(context).length) / 4);\n        tokensOut = Math.ceil(structuredData.summary.length / 4);\n        cost = (tokensIn / 1000) * (targetModel === 'sonnet' ? 0.003 : 0.015) + \n               (tokensOut / 1000) * (targetModel === 'sonnet' ? 0.015 : 0.075);\n        break;\n      \n      case 'tax':\n        structuredData = await analyzeTax(context, userMessage);\n        tokensIn = Math.ceil((userMessage.length + JSON.stringify(context).length) / 4);\n        tokensOut = Math.ceil(structuredData.summary.length / 4);\n        cost = (tokensIn / 1000) * (targetModel === 'sonnet' ? 0.003 : 0.015) + \n               (tokensOut / 1000) * (targetModel === 'sonnet' ? 0.015 : 0.075);\n        break;\n      \n      case 'portfolio':\n        structuredData = await analyzePortfolio(context, userMessage);\n        tokensIn = Math.ceil((userMessage.length + JSON.stringify(context).length) / 4);\n        tokensOut = Math.ceil(structuredData.summary.length / 4);\n        cost = (tokensIn / 1000) * (targetModel === 'sonnet' ? 0.003 : 0.015) + \n               (tokensOut / 1000) * (targetModel === 'sonnet' ? 0.015 : 0.075);\n        break;\n      \n      default:\n        throw new Error(`Unknown orchestrator: ${orchestrator}`);\n    }\n    \n    return {\n      answer: structuredData.summary,\n      modelUsed: 'reasoning',\n      modelSlug,\n      tokensIn,\n      tokensOut,\n      cost,\n      escalated: true,\n      escalationReason: routingReason,\n      orchestratorUsed: orchestrator,\n      structuredData,\n      actualModel: targetModel === 'sonnet' ? 'sonnet' : 'opus', // Track actual model for analytics\n    };\n  } catch (error) {\n    // If orchestrator fails, fall back to generic reasoning query\n    console.error(`Orchestrator ${orchestrator} failed:`, error);\n    return await handleGenericReasoningQuery(userMessage, context, routingReason, targetModel);\n  }\n}\n\n/**\n * Handle generic reasoning query (no specific orchestrator)\n */\nasync function handleGenericReasoningQuery(\n  userMessage: string,\n  context: any,\n  routingReason?: string,\n  targetModel: ModelAccess = 'opus'\n): Promise<HybridAIResponse> {\n  // Select the appropriate client based on target model\n  const client = targetModel === 'sonnet' ? getSonnetClient() : getOpusClient();\n  \n  // Fetch market context for smarter financial advice\n  const marketContext = await getMarketContextForPrompt(context.countryContext?.countryCode || 'US');\n  \n  // Build comprehensive prompt with context\n  const systemPrompt = buildReasoningSystemPrompt(context, marketContext);\n  \n  // Build messages array with conversation history (last 6 messages for context)\n  const conversationHistory = (context.conversationHistory || []).slice(-6);\n  const messages: Array<{ role: 'system' | 'user' | 'assistant'; content: string }> = [\n    { role: 'system', content: systemPrompt },\n    ...conversationHistory.map((m: any) => ({ role: m.role, content: m.content })),\n    { role: 'user', content: userMessage },\n  ];\n  \n  const response = await client.chat({\n    messages,\n    temperature: 0.5,\n    maxTokens: 2000,\n    tools: getTwealthTools(), // Pass tools for action-taking\n  });\n  \n  return {\n    answer: response.text,\n    modelUsed: 'reasoning',\n    modelSlug: response.model,\n    tokensIn: response.tokensIn,\n    tokensOut: response.tokensOut,\n    cost: response.cost,\n    escalated: true,\n    escalationReason: routingReason,\n    actualModel: targetModel === 'sonnet' ? 'sonnet' : 'opus', // Track actual model for analytics\n    toolCalls: response.toolCalls, // Return tool calls for execution\n  };\n}\n\n/**\n * Build country context section for prompts\n */\nfunction buildCountryContextSection(context: any): string {\n  const cc = context.countryContext;\n  if (!cc) return '';\n  \n  return `\n**Country-Specific Financial Context (${cc.countryName}):**\n- Currency: ${cc.currency} (${cc.currencySymbol})\n- VAT/Sales Tax: ${(cc.vatRate * 100).toFixed(1)}%\n- Capital Gains Tax: ${(cc.capitalGainsTaxRate * 100).toFixed(1)}%\n- Cost of Living Index: ${cc.costOfLivingIndex} (NYC = 100)\n- Purchasing Power Index: ${cc.purchasingPowerIndex}\n- Average Monthly Income: ${cc.currencySymbol}${cc.averageMonthlyIncome.toLocaleString()}\n- Median Home (City): ${cc.currencySymbol}${cc.luxuryPricing.medianHomeCity.toLocaleString()}\n\n**Luxury Goods Pricing (${cc.currency}):**\n- Lamborghini Urus: ${cc.currencySymbol}${cc.luxuryPricing.lamborghiniUrus.toLocaleString()}\n- Porsche 911: ${cc.currencySymbol}${cc.luxuryPricing.porsche911.toLocaleString()}\n- Rolex Submariner: ${cc.currencySymbol}${cc.luxuryPricing.rolexSubmariner.toLocaleString()}\n\n**Local Regulations:**\n${cc.financialRegulations.slice(0, 3).map((r: string) => `- ${r}`).join('\\n')}\n\nIMPORTANT: Use ${cc.currencySymbol} (${cc.currency}) for all monetary values. Apply local tax rates and cost of living when giving advice.\n`;\n}\n\n/**\n * Build system prompt for GPT-5 (optimized for financial reasoning)\n */\nfunction buildGPT5SystemPrompt(context: any, marketContext?: string): string {\n  const monthlyIncome = context.income.sources.reduce((sum: number, s: any) => sum + s.amount, 0);\n  const monthlyExpenses = context.expenses.monthly;\n  const totalDebts = context.debts.reduce((sum: number, d: any) => sum + d.balance, 0);\n  const totalAssets = context.assets.reduce((sum: number, a: any) => sum + a.value, 0);\n  const netWorth = totalAssets - totalDebts;\n  const monthlySurplus = monthlyIncome - monthlyExpenses;\n  \n  const countryContext = buildCountryContextSection(context);\n  const currencySymbol = context.countryContext?.currencySymbol || '$';\n  \n  let prompt = `${getTwealthIdentity()}\n${countryContext}\n**CRITICAL: YOU HAVE FULL ACCESS TO THIS USER'S FINANCIAL DATA IN TWEALTH**\nYou are their personal CFO with complete visibility into their finances. Reference their actual data below.\n\n**User Financial Profile:**\n- Monthly Income: ${currencySymbol}${monthlyIncome.toLocaleString()}\n- Monthly Expenses: ${currencySymbol}${monthlyExpenses.toLocaleString()}\n- Monthly Surplus: ${currencySymbol}${monthlySurplus.toLocaleString()}\n- Total Debts: ${currencySymbol}${totalDebts.toLocaleString()}\n- Total Assets: ${currencySymbol}${totalAssets.toLocaleString()}\n- Net Worth: ${currencySymbol}${netWorth.toLocaleString()}\n\n`;\n\n  // Include user's financial goals with progress\n  if (context.goals && context.goals.length > 0) {\n    prompt += `**User's Financial Goals (${context.goals.length} active):**\\n`;\n    context.goals.forEach((g: any, i: number) => {\n      const progress = g.target > 0 ? Math.round((g.current / g.target) * 100) : 0;\n      const monthlyNeeded = g.horizonMonths > 0 ? (g.target - g.current) / g.horizonMonths : 0;\n      prompt += `${i + 1}. **${g.name}**: ${currencySymbol}${g.current.toLocaleString()} / ${currencySymbol}${g.target.toLocaleString()} (${progress}% saved, needs ${currencySymbol}${monthlyNeeded.toLocaleString()}/mo)\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include debts for calculations\n  if (context.debts && context.debts.length > 0) {\n    prompt += `**User's Debts:**\\n`;\n    context.debts.forEach((d: any, i: number) => {\n      prompt += `${i + 1}. ${d.name}: ${currencySymbol}${d.balance.toLocaleString()} @ ${d.apr}% APR\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include assets\n  if (context.assets && context.assets.length > 0) {\n    prompt += `**User's Assets:**\\n`;\n    context.assets.forEach((a: any, i: number) => {\n      prompt += `${i + 1}. ${a.name} (${a.type}): ${currencySymbol}${a.value.toLocaleString()}\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include live market data context (only if available)\n  if (marketContext && marketContext.trim().length > 0) {\n    prompt += `\\n**LIVE MARKET DATA (Use for context-aware advice):**\\n${marketContext}\\n`;\n  }\n\n  prompt += `**Your Role as GPT-5 (MATH Model):**\nYou're the quantitative specialist. You HAVE ACCESS to all user data above - reference it directly.\n\n**ACTION-FIRST MINDSET - EXECUTE IMMEDIATELY:**\nWhen user gives a command with enough info, JUST DO IT:\n- \"Set a goal to buy a house for 5 million baht\" → IMMEDIATELY call create_financial_goal\n- \"I spent 200 on food\" → IMMEDIATELY call add_transaction  \n- The user's command IS their confirmation - execute immediately, don't ask for confirmation\n- Calculate dates automatically: \"next year\" = 1 year from today\n- Understand ALL languages including Thai, Chinese, Spanish, etc.\n\nYour strengths:\n- Superior mathematical reasoning (94.6% on AIME 2025)\n- Complex multi-variable financial analysis & projections\n- Compound interest calculations & retirement planning\n- Investment modeling & future value simulations\n- Country-specific tax calculations and cost comparisons\n\nCRITICAL: When user asks about their goals or finances, USE THE DATA ABOVE.\nNever say \"I don't have access\" - you DO have their complete financial picture.\n\n**PREMIUM RESPONSE FORMAT:**\n1. Provide your detailed calculations and analysis\n2. Reference specific numbers from their data\n3. For financial calculations, use \"---CALCULATION---\" blocks with structured data\n4. For goal/budget progress, use \"---PROGRESS---\" blocks\n5. If you spot a financial insight (opportunity, warning, or milestone), add \"---INSIGHT---\" section\n6. At the END of EVERY response, include \"---SUGGESTIONS---\" with exactly 3 follow-up questions\n\nExample format:\n[Your analysis here]\n\n---CALCULATION---\ntitle: Monthly Savings Projection\nitems:\n- Monthly Income: $5,000\n- Monthly Expenses: $3,500\n- *Current Savings Rate: 30%*\nresult: Annual Savings = $18,000\n\n---PROGRESS---\ntitle: Emergency Fund Goal\ncurrent: 4500\ntarget: 10000\nunit: $\n\n---INSIGHT---\ntype: opportunity\ntitle: Investment Potential\nmessage: With your $X surplus, you could earn $Y more annually\n\n---SUGGESTIONS---\n1. What if I increased my monthly contribution?\n2. How does this compare to alternative strategies?\n3. What's my break-even point?\n\nUse available tools to provide detailed calculations. Keep responses focused on measurable outcomes with specific numbers and actionable steps. Always use the user's local currency and apply their country's tax rates when relevant.`;\n\n  return prompt;\n}\n\n/**\n * Build system prompt for Scout (simple queries)\n */\nfunction buildScoutSystemPrompt(context: any, marketContext?: string): string {\n  const monthlyIncome = context.income.sources.reduce((sum: number, s: any) => sum + s.amount, 0);\n  const monthlyExpenses = context.expenses.monthly;\n  const totalDebts = context.debts.reduce((sum: number, d: any) => sum + d.balance, 0);\n  const totalAssets = context.assets.reduce((sum: number, a: any) => sum + a.value, 0);\n  const netWorth = totalAssets - totalDebts;\n  const monthlySurplus = monthlyIncome - monthlyExpenses;\n  \n  const countryContext = buildCountryContextSection(context);\n  const currencySymbol = context.countryContext?.currencySymbol || '$';\n  const countryName = context.countryContext?.countryName || 'United States';\n  \n  let prompt = `${getTwealthIdentity()}\n${countryContext}\n**CRITICAL: YOU HAVE FULL ACCESS TO THIS USER'S FINANCIAL DATA IN TWEALTH**\nYou are NOT a generic chatbot. You ARE their personal CFO with complete visibility into their finances.\nWhen they ask about their goals, spending, debts, or assets - YOU ALREADY KNOW THIS DATA.\nReference it directly. Never say \"I don't have access\" - you DO have access below.\n\n**User Financial Overview:**\n- Monthly Income: ${currencySymbol}${monthlyIncome.toLocaleString()}\n- Monthly Expenses: ${currencySymbol}${monthlyExpenses.toLocaleString()}\n- Monthly Surplus: ${currencySymbol}${monthlySurplus.toLocaleString()}\n- Total Debts: ${currencySymbol}${totalDebts.toLocaleString()}\n- Total Assets: ${currencySymbol}${totalAssets.toLocaleString()}\n- Net Worth: ${currencySymbol}${netWorth.toLocaleString()}\n\n`;\n\n  // Include user's financial goals with progress\n  if (context.goals && context.goals.length > 0) {\n    prompt += `**User's Financial Goals (${context.goals.length} active):**\\n`;\n    context.goals.forEach((g: any, i: number) => {\n      const progress = g.target > 0 ? Math.round((g.current / g.target) * 100) : 0;\n      const yearsRemaining = Math.floor(g.horizonMonths / 12);\n      const monthsRemaining = g.horizonMonths % 12;\n      const timeStr = yearsRemaining > 0 \n        ? `${yearsRemaining}y ${monthsRemaining}m`\n        : `${monthsRemaining}m`;\n      prompt += `${i + 1}. **${g.name}**: ${currencySymbol}${g.current.toLocaleString()} / ${currencySymbol}${g.target.toLocaleString()} (${progress}% saved, ${timeStr} remaining)\\n`;\n    });\n    prompt += `\\n`;\n  } else {\n    prompt += `**User's Financial Goals:** No goals set yet. Offer to help create one!\\n\\n`;\n  }\n\n  // Include user's debts\n  if (context.debts && context.debts.length > 0) {\n    prompt += `**User's Debts (${context.debts.length} accounts):**\\n`;\n    context.debts.forEach((d: any, i: number) => {\n      prompt += `${i + 1}. ${d.name}: ${currencySymbol}${d.balance.toLocaleString()} @ ${d.apr}% APR (${currencySymbol}${d.monthlyPayment.toLocaleString()}/mo)\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include user's assets\n  if (context.assets && context.assets.length > 0) {\n    prompt += `**User's Assets (${context.assets.length} items):**\\n`;\n    context.assets.forEach((a: any, i: number) => {\n      prompt += `${i + 1}. ${a.name} (${a.type}): ${currencySymbol}${a.value.toLocaleString()}\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include recent transactions for spending context\n  if (context.recentTransactionsSample && context.recentTransactionsSample.length > 0) {\n    prompt += `**Recent Transactions (last ${context.recentTransactionsSample.length}):**\\n`;\n    context.recentTransactionsSample.slice(0, 5).forEach((t: any) => {\n      const sign = t.type === 'income' ? '+' : '-';\n      const date = new Date(t.date).toLocaleDateString();\n      prompt += `- ${date}: ${sign}${currencySymbol}${Math.abs(t.amount).toLocaleString()} - ${t.desc || t.category || 'No description'}\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include expense breakdown\n  if (context.expenses.byCategory && Object.keys(context.expenses.byCategory).length > 0) {\n    prompt += `**Monthly Spending by Category:**\\n`;\n    const sortedCategories = Object.entries(context.expenses.byCategory)\n      .sort((a: any, b: any) => b[1] - a[1])\n      .slice(0, 5);\n    sortedCategories.forEach(([cat, amount]: [string, any]) => {\n      prompt += `- ${cat}: ${currencySymbol}${amount.toLocaleString()}\\n`;\n    });\n    prompt += `\\n`;\n  }\n\n  // Include live market data context (only if available)\n  if (marketContext && marketContext.trim().length > 0) {\n    prompt += `\\n**LIVE MARKET DATA (Use for context-aware advice):**\\n${marketContext}\\n`;\n  }\n\n  prompt += `**Your Role as Twealth AI (Personal CFO):**\nYou're the user's dedicated financial advisor in ${countryName}. You KNOW their financial situation.\n\n**ACTION-FIRST MINDSET - EXECUTE IMMEDIATELY:**\nWhen user gives a command with enough info, JUST DO IT:\n- \"Set a goal to buy a house for 5 million baht next year\" → IMMEDIATELY call create_financial_goal (name=\"Buy House\", targetAmount=\"5000000\", targetDate=1 year from today)\n- \"I spent 200 on food\" → IMMEDIATELY call add_transaction\n- \"Create a goal to save $10000 by December\" → IMMEDIATELY call create_financial_goal\n- \"Remind me to pay rent next week\" → IMMEDIATELY call create_calendar_event\n\nONLY ask for clarification when critical info is genuinely missing (like amount for a goal).\nThe user's command IS their confirmation - no need to ask \"should I create this?\"\n\nCRITICAL BEHAVIORS:\n1. EXECUTE commands immediately - don't ask for confirmation when user gives clear instructions\n2. When user asks about THEIR goals, spending, debts, assets - REFERENCE THE DATA ABOVE directly\n3. NEVER say \"I don't have access to your data\" - you DO have access (see above)\n4. Calculate dates automatically: \"next year\" = 1 year from today, \"in 6 months\" = 6 months from today\n5. Understand ALL languages including Thai, Chinese, Spanish, etc. Process them the same as English\n\nHandle:\n- General budgeting advice & spending analysis using their actual data\n- Quick financial calculations in ${context.countryContext?.currency || 'USD'}\n- Goal creation, updates, and progress tracking - EXECUTE IMMEDIATELY when commanded\n- Budget recommendations based on their actual spending patterns\n- Debt payoff strategies based on their actual debts\n\n**PREMIUM RESPONSE FORMAT:**\n1. Provide your advice (2-4 paragraphs, concise and actionable)\n2. Reference specific numbers from their data above\n3. For any calculations, use \"---CALCULATION---\" blocks with structured data\n4. For goal/budget progress, use \"---PROGRESS---\" blocks to show visual progress\n5. If you spot a financial concern, add a \"---INSIGHT---\" section\n6. At the END of EVERY response, include \"---SUGGESTIONS---\" with exactly 3 smart follow-up questions\n\nExample format:\n[Your main advice here]\n\n---PROGRESS---\ntitle: Savings Goal Progress\ncurrent: 2500\ntarget: 5000\nunit: ${currencySymbol}\n\n---INSIGHT---\ntype: warning|opportunity|milestone\ntitle: Brief insight title\nmessage: Specific insight based on their data\n\n---SUGGESTIONS---\n1. Specific follow-up question based on conversation\n2. Another relevant question they might ask\n3. A proactive question about improving their finances\n\nKeep responses focused. Always use the user's local currency (${currencySymbol}). Use available tools to take actions when users command you.`;\n\n  return prompt;\n}\n\n/**\n * Build system prompt for Reasoning (complex queries)\n */\nfunction buildReasoningSystemPrompt(context: any, marketContext?: string): string {\n  const monthlyIncome = context.income.sources.reduce((sum: number, s: any) => sum + s.amount, 0);\n  const monthlyExpenses = context.expenses.monthly;\n  const totalDebts = context.debts.reduce((sum: number, d: any) => sum + d.balance, 0);\n  const totalAssets = context.assets.reduce((sum: number, a: any) => sum + a.value, 0);\n  \n  const countryContext = buildCountryContextSection(context);\n  const currencySymbol = context.countryContext?.currencySymbol || '$';\n  const countryName = context.countryContext?.countryName || 'United States';\n  \n  let prompt = `${getTwealthIdentity()}\n${countryContext}\n**CRITICAL: YOU HAVE FULL ACCESS TO THIS USER'S FINANCIAL DATA IN TWEALTH**\nYou are their personal CFO with complete visibility into their finances. Reference their actual data below.\nNever say \"I don't have access\" - you DO have access to all their financial data.\n\n**User Financial Context (${countryName}):**\n- Monthly Income: ${currencySymbol}${monthlyIncome.toLocaleString()}\n- Monthly Expenses: ${currencySymbol}${monthlyExpenses.toLocaleString()}\n- Monthly Surplus: ${currencySymbol}${(monthlyIncome - monthlyExpenses).toLocaleString()}\n- Total Debts: ${currencySymbol}${totalDebts.toLocaleString()}\n- Total Assets: ${currencySymbol}${totalAssets.toLocaleString()}\n- Net Worth: ${currencySymbol}${(totalAssets - totalDebts).toLocaleString()}\n\n`;\n  \n  if (context.debts && context.debts.length > 0) {\n    prompt += `**User's Debts (${context.debts.length} accounts):**\\n`;\n    context.debts.forEach((d: any, i: number) => {\n      prompt += `${i + 1}. ${d.name}: ${currencySymbol}${d.balance.toLocaleString()} @ ${d.apr}% APR (${currencySymbol}${d.monthlyPayment.toLocaleString()}/mo)\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  if (context.assets && context.assets.length > 0) {\n    prompt += `**User's Assets (${context.assets.length} items):**\\n`;\n    context.assets.forEach((a: any, i: number) => {\n      prompt += `${i + 1}. ${a.name} (${a.type}): ${currencySymbol}${a.value.toLocaleString()}\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  if (context.goals && context.goals.length > 0) {\n    prompt += `**User's Financial Goals (${context.goals.length} active):**\\n`;\n    context.goals.forEach((g: any, i: number) => {\n      const progress = g.target > 0 ? Math.round((g.current / g.target) * 100) : 0;\n      const yearsRemaining = Math.floor(g.horizonMonths / 12);\n      const monthsRemaining = g.horizonMonths % 12;\n      const timeStr = yearsRemaining > 0 \n        ? `${yearsRemaining}y ${monthsRemaining}m`\n        : `${monthsRemaining}m`;\n      prompt += `${i + 1}. **${g.name}**: ${currencySymbol}${g.current.toLocaleString()} / ${currencySymbol}${g.target.toLocaleString()} (${progress}% saved, ${timeStr} remaining)\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  // Include live market data context (only if available)\n  if (marketContext && marketContext.trim().length > 0) {\n    prompt += `\\n**LIVE MARKET DATA (Use for context-aware advice):**\\n${marketContext}\\n`;\n  }\n\n  prompt += `**Your Role as Claude Sonnet/Opus (REASONING/CFO Model):**\nYou're the strategic advisor for complex financial decisions in ${countryName}. You HAVE ACCESS to all user data above.\n\n**ACTION-FIRST MINDSET - EXECUTE IMMEDIATELY:**\nWhen user gives a command with enough info, JUST DO IT:\n- \"Set a goal to buy a house for 5 million baht next year\" → IMMEDIATELY call create_financial_goal\n- \"I spent 200 on food\" → IMMEDIATELY call add_transaction\n- The user's command IS their confirmation - execute immediately, don't ask \"should I create this?\"\n- Calculate dates automatically: \"next year\" = 1 year from today\n\nCRITICAL BEHAVIORS:\n1. EXECUTE commands immediately - don't ask for confirmation when user gives clear instructions\n2. When user asks about THEIR goals, spending, debts, assets - REFERENCE THE DATA ABOVE directly\n3. NEVER say \"I don't have access to your data\" - you DO have access (see above)\n4. Be proactive - analyze their situation and provide specific recommendations\n5. Understand ALL languages including Thai, Chinese, Spanish, etc. Process them the same as English\n\nYour strengths:\n- Multi-step reasoning for debt payoff strategies using local interest rates\n- Investment portfolio optimization with country-specific tax implications\n- Tax planning using ${countryName}'s tax brackets and regulations\n- Country-specific retirement contribution strategies\n- Comprehensive CFO-level analysis for high-stakes decisions\n- Cost comparisons for luxury goods and major purchases in local currency\n\n**PREMIUM RESPONSE FORMAT:**\n1. Provide your comprehensive CFO-level analysis\n2. Include specific calculations with their real numbers using \"---CALCULATION---\" blocks\n3. For goal/budget/investment progress, use \"---PROGRESS---\" blocks for visual display\n4. If you identify important insights, add \"---INSIGHT---\" section\n5. At the END of EVERY response, include \"---SUGGESTIONS---\" with exactly 3 strategic follow-up questions\n\nExample format:\n[Your strategic analysis here]\n\n---CALCULATION---\ntitle: Investment Portfolio Analysis\nitems:\n- Current Portfolio Value: $50,000\n- Monthly Contribution: $500\n- *Expected Annual Return: 8%*\nresult: 10-Year Value = $127,000\n\n---PROGRESS---\ntitle: Retirement Fund Progress\ncurrent: 125000\ntarget: 500000\nunit: $\n\n---INSIGHT---\ntype: warning|opportunity|milestone\ntitle: Critical Finding\nmessage: Based on your data, specific insight about their situation\n\n---SUGGESTIONS---\n1. Strategic question about optimizing their approach\n2. Question exploring alternative scenarios\n3. Question about long-term implications\n\nUse available tools to provide detailed, well-reasoned analysis with specific numbers in ${currencySymbol} (${context.countryContext?.currency || 'USD'}). Apply local tax rates and financial regulations. Think step-by-step through complex problems.`;\n  \n  return prompt;\n}\n","path":null,"size_bytes":36721,"size_tokens":null},"server/ai/orchestrators/portfolio.ts":{"content":"/**\n * Portfolio Orchestrator - CFO-level portfolio optimization\n * \n * Provides:\n * - Asset allocation recommendations\n * - Rebalancing strategies\n * - Risk-adjusted returns analysis\n * - Diversification scoring\n */\n\nimport type { FinancialContext } from '../contextBuilder';\nimport { getReasoningClient } from '../clients';\nimport { z } from 'zod';\n\n/**\n * Zod schema for portfolio analysis validation\n */\nconst PortfolioAnalysisSchema = z.object({\n  health: z.object({\n    diversificationScore: z.number().min(0).max(100),\n    riskScore: z.number().min(0).max(100),\n    expectedReturn: z.number(),\n    status: z.enum(['well_diversified', 'concentrated', 'needs_rebalancing']),\n  }),\n  allocation: z.object({\n    current: z.record(z.number()),\n    target: z.record(z.number()),\n    rebalancingNeeded: z.boolean(),\n    rebalancingSteps: z.array(z.object({\n      action: z.enum(['buy', 'sell']),\n      asset: z.string(),\n      amount: z.number().min(0),\n      reason: z.string().min(10),\n    })).optional(),\n  }),\n  risk: z.object({\n    currentRisk: z.enum(['low', 'medium', 'high']),\n    appropriateForGoals: z.boolean(),\n    recommendations: z.array(z.string()),\n  }),\n  summary: z.string().min(50),\n});\n\n/**\n * Structured portfolio analysis result\n */\nexport interface PortfolioAnalysis {\n  // Current portfolio health\n  health: {\n    diversificationScore: number; // 0-100\n    riskScore: number; // 0-100 (higher = riskier)\n    expectedReturn: number; // Annual percentage\n    status: 'well_diversified' | 'concentrated' | 'needs_rebalancing';\n  };\n  \n  // Recommended asset allocation\n  allocation: {\n    current: Record<string, number>; // e.g., {equity: 60, bonds: 30, cash: 10}\n    target: Record<string, number>;\n    rebalancingNeeded: boolean;\n    rebalancingSteps?: Array<{\n      action: 'buy' | 'sell';\n      asset: string;\n      amount: number;\n      reason: string;\n    }>;\n  };\n  \n  // Risk analysis\n  risk: {\n    currentRisk: 'low' | 'medium' | 'high';\n    appropriateForGoals: boolean;\n    recommendations: string[];\n  };\n  \n  // Natural language summary\n  summary: string;\n}\n\n/**\n * Orchestrate portfolio optimization using Claude Opus 4.1\n */\nexport async function analyzePortfolio(\n  context: FinancialContext,\n  userQuestion: string\n): Promise<PortfolioAnalysis> {\n  const client = getReasoningClient();\n  \n  // Build structured prompt for CFO-level analysis\n  const prompt = buildPortfolioPrompt(context, userQuestion);\n  \n  // Call Claude Opus 4.1 with structured output request\n  const response = await client.chat({\n    messages: [\n      {\n        role: 'system',\n        content: PORTFOLIO_SYSTEM_PROMPT,\n      },\n      {\n        role: 'user',\n        content: prompt,\n      },\n    ],\n    temperature: 0.3, // Lower temperature for financial analysis\n    maxTokens: 2000,\n  });\n  \n  // Parse structured JSON response\n  const analysis = parsePortfolioResponse(response.text);\n  \n  return analysis;\n}\n\n/**\n * System prompt for portfolio analysis\n */\nconst PORTFOLIO_SYSTEM_PROMPT = `You are Twealth AI's portfolio optimization specialist - a CFO-level financial advisor helping users build wealth through smart investing.\n\nLANGUAGE MATCHING (CRITICAL): ALL text fields in your response MUST be in the SAME LANGUAGE the user writes in. If user writes in Thai, respond entirely in Thai. If Spanish, respond entirely in Spanish. This includes: \"reason\", \"summary\", \"recommendations\", and any other text. Numbers and field names stay as-is.\n\nYour task is to analyze the user's investment portfolio in Twealth and provide optimization recommendations.\n\n**Analysis Framework:**\n1. Portfolio Inventory: Review current asset allocation across types\n2. Diversification Analysis: Assess concentration risk\n3. Risk Assessment: Evaluate appropriateness for user's goals and horizon\n4. Rebalancing Strategy: Recommend adjustments if needed\n5. Expected Returns: Project risk-adjusted returns\n\n**Output Requirements:**\nReturn a JSON object with this exact structure:\n\\`\\`\\`json\n{\n  \"health\": {\n    \"diversificationScore\": 75,\n    \"riskScore\": 65,\n    \"expectedReturn\": 7.5,\n    \"status\": \"well_diversified\"\n  },\n  \"allocation\": {\n    \"current\": {\n      \"equity\": 60,\n      \"bonds\": 30,\n      \"cash\": 10\n    },\n    \"target\": {\n      \"equity\": 70,\n      \"bonds\": 25,\n      \"cash\": 5\n    },\n    \"rebalancingNeeded\": true,\n    \"rebalancingSteps\": [\n      {\n        \"action\": \"buy\",\n        \"asset\": \"equity\",\n        \"amount\": 5000,\n        \"reason\": \"Increase growth exposure for long horizon\"\n      }\n    ]\n  },\n  \"risk\": {\n    \"currentRisk\": \"medium\",\n    \"appropriateForGoals\": true,\n    \"recommendations\": [\n      \"Portfolio risk level matches 25-year retirement horizon\",\n      \"Consider adding bonds as you approach retirement\"\n    ]\n  },\n  \"summary\": \"Natural language summary with actionable next steps\"\n}\n\\`\\`\\`\n\n**Key Principles:**\n- Diversification reduces risk without sacrificing returns\n- Equities for growth (>10 year horizon), bonds for stability\n- Rule of 110: Target stock allocation = 110 - age (adjustable)\n- Rebalance when allocation drifts 5%+ from target\n- Expected returns (historical): Stocks 10%, Bonds 5%, Cash 2%\n- Crypto is high-risk speculative (limit to 5-10% max)\n- Don't chase past performance - focus on asset allocation\n- Tax-loss harvesting can reduce tax burden\n\n**Tone:** Professional, clear, actionable. No jargon. Explain trade-offs.`;\n\n/**\n * Build portfolio analysis prompt with enhanced asset categorization\n */\nfunction buildPortfolioPrompt(context: FinancialContext, userQuestion: string): string {\n  const { user, assets, goals } = context;\n  \n  // Calculate total portfolio value\n  const totalValue = assets.reduce((sum, a) => sum + a.value, 0);\n  \n  // Safeguard: Handle zero assets case early\n  if (totalValue === 0 || assets.length === 0) {\n    let prompt = `**User Question:** ${userQuestion}\\n\\n`;\n    prompt += `**Portfolio Information:**\\n`;\n    prompt += `- Total Portfolio Value: $0\\n`;\n    prompt += `- No assets found. User is starting from scratch.\\n`;\n    prompt += `- User Age: ${user.age || 'Not provided'}\\n`;\n    prompt += `- Risk Tolerance: ${user.riskTolerance || 'medium'}\\n\\n`;\n    \n    if (goals.length > 0) {\n      prompt += `**Financial Goals:**\\n`;\n      goals.forEach(g => {\n        const yearsToGoal = Math.floor(g.horizonMonths / 12);\n        prompt += `- ${g.name}: $${g.target.toLocaleString()} in ${yearsToGoal} years\\n`;\n      });\n      prompt += `\\n`;\n    }\n    \n    prompt += `Provide recommendations for starting a portfolio from zero. `;\n    prompt += `Return ONLY the JSON object specified in the system prompt, no additional text.`;\n    return prompt;\n  }\n  \n  // Categorize assets by liquidity and purpose\n  const liquidAssets = assets.filter(a => ['cash', 'equity', 'bond'].includes(a.type));\n  const illiquidAssets = assets.filter(a => ['real_estate', 'vehicle', 'crypto'].includes(a.type));\n  \n  const totalLiquid = liquidAssets.reduce((sum, a) => sum + a.value, 0);\n  const totalIlliquid = illiquidAssets.reduce((sum, a) => sum + a.value, 0);\n  \n  // Calculate allocation percentages\n  const allocationByType = assets.reduce((acc, a) => {\n    acc[a.type] = (acc[a.type] || 0) + a.value;\n    return acc;\n  }, {} as Record<string, number>);\n  \n  let prompt = `**User Question:** ${userQuestion}\\n\\n`;\n  \n  prompt += `**Portfolio Information:**\\n`;\n  prompt += `- Total Portfolio Value: $${totalValue.toLocaleString()}\\n`;\n  prompt += `- Liquid Assets: $${totalLiquid.toLocaleString()} (${((totalLiquid/totalValue)*100).toFixed(1)}%)\\n`;\n  prompt += `- Illiquid Assets: $${totalIlliquid.toLocaleString()} (${((totalIlliquid/totalValue)*100).toFixed(1)}%)\\n`;\n  prompt += `- User Age: ${user.age || 'Not provided'}\\n`;\n  prompt += `- Risk Tolerance: ${user.riskTolerance || 'medium'}\\n\\n`;\n  \n  prompt += `**Asset Allocation by Type:**\\n`;\n  for (const [type, value] of Object.entries(allocationByType)) {\n    const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : '0.0';\n    const liquidityNote = ['cash', 'equity', 'bond'].includes(type) ? ' (liquid)' : ' (illiquid)';\n    prompt += `- ${type}${liquidityNote}: ${percentage}% ($${value.toLocaleString()})\\n`;\n  }\n  prompt += `\\n`;\n  \n  if (assets.length > 0) {\n    prompt += `**Individual Assets:**\\n`;\n    assets.forEach((asset, i) => {\n      const percentage = totalValue > 0 ? ((asset.value / totalValue) * 100).toFixed(1) : '0.0';\n      const liquidityNote = ['cash', 'equity', 'bond'].includes(asset.type) ? ' [Liquid]' : ' [Illiquid]';\n      prompt += `${i + 1}. ${asset.name} (${asset.type})${liquidityNote}: $${asset.value.toLocaleString()} (${percentage}%)\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  prompt += `**Important Considerations:**\\n`;\n  prompt += `- Only liquid assets (cash, equity, bonds) can be rebalanced easily\\n`;\n  prompt += `- Real estate and vehicles are illiquid and have different rebalancing strategies\\n`;\n  prompt += `- Crypto is high-risk and should be limited\\n\\n`;\n  \n  if (goals.length > 0) {\n    prompt += `**Financial Goals:**\\n`;\n    goals.forEach(g => {\n      const yearsToGoal = Math.floor(g.horizonMonths / 12);\n      prompt += `- ${g.name}: $${g.target.toLocaleString()} in ${yearsToGoal} years\\n`;\n    });\n    prompt += `\\n`;\n  }\n  \n  prompt += `Analyze this portfolio and provide optimization recommendations. `;\n  prompt += `Return ONLY the JSON object specified in the system prompt, no additional text.`;\n  \n  return prompt;\n}\n\n/**\n * Parse Claude's response into structured PortfolioAnalysis with strict validation\n */\nfunction parsePortfolioResponse(responseText: string): PortfolioAnalysis {\n  // Extract JSON from response (Claude might wrap it in markdown)\n  const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                    responseText.match(/\\{[\\s\\S]*\\}/);\n  \n  if (!jsonMatch) {\n    throw new Error(`Portfolio orchestrator: No JSON found in Claude response. Response: ${responseText.substring(0, 200)}`);\n  }\n  \n  const jsonText = jsonMatch[1] || jsonMatch[0];\n  let parsed: unknown;\n  \n  try {\n    parsed = JSON.parse(jsonText);\n  } catch (error) {\n    throw new Error(`Portfolio orchestrator: JSON parse error. ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n  \n  // Validate with Zod schema\n  const result = PortfolioAnalysisSchema.safeParse(parsed);\n  \n  if (!result.success) {\n    console.error('Portfolio analysis validation failed:', result.error.errors);\n    throw new Error(`Portfolio orchestrator: Invalid response structure. Errors: ${JSON.stringify(result.error.errors)}`);\n  }\n  \n  return result.data;\n}\n","path":null,"size_bytes":10584,"size_tokens":null},"client/src/components/modals/PremiumGateModal.tsx":{"content":"import { Brain, Zap, Check, X, Sparkles } from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useLocation } from \"wouter\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\ninterface PremiumGateModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  trigger?: 'deep_analysis' | 'orchestrator' | 'general';\n  orchestratorType?: string;\n}\n\nexport function PremiumGateModal({\n  isOpen,\n  onClose,\n  trigger = 'general',\n  orchestratorType\n}: PremiumGateModalProps) {\n  const [, setLocation] = useLocation();\n  const { formatAmount, convertFromUSD } = useUserCurrency();\n\n  const handleUpgrade = () => {\n    setLocation(\"/upgrade\");\n    onClose();\n  };\n\n  // Customize messaging based on trigger\n  const getTriggerMessage = () => {\n    switch (trigger) {\n      case 'deep_analysis':\n        return {\n          title: \"Deep CFO-Level Analysis\",\n          description: \"You've requested advanced AI analysis powered by Claude Opus 4.1\",\n          icon: Brain\n        };\n      case 'orchestrator':\n        return {\n          title: `${orchestratorType?.toUpperCase() || 'Advanced'} Analysis`,\n          description: \"This complex financial scenario requires premium AI orchestration\",\n          icon: Sparkles\n        };\n      default:\n        return {\n          title: \"Premium AI Features\",\n          description: \"Unlock advanced AI capabilities\",\n          icon: Brain\n        };\n    }\n  };\n\n  const triggerInfo = getTriggerMessage();\n  const TriggerIcon = triggerInfo.icon;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent className=\"sm:max-w-[500px]\" data-testid=\"premium-gate-modal\">\n        <DialogHeader>\n          <div className=\"flex items-center gap-3 mb-2\">\n            <div className=\"p-2 rounded-lg bg-black dark:bg-white\">\n              <TriggerIcon className=\"h-5 w-5 text-white dark:text-black\" />\n            </div>\n            <div>\n              <DialogTitle className=\"text-lg\">{triggerInfo.title}</DialogTitle>\n              <DialogDescription className=\"text-xs\">\n                {triggerInfo.description}\n              </DialogDescription>\n            </div>\n          </div>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* Current Limitation */}\n          <div className=\"bg-muted/50 border border-border rounded-lg p-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"p-1.5 rounded bg-background border border-border\">\n                <Zap className=\"h-4 w-4\" />\n              </div>\n              <div className=\"flex-1\">\n                <p className=\"font-medium text-sm mb-1\">Free Plan</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Scout AI (Llama 4) - Fast answers for simple queries\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Premium Benefits */}\n          <div className=\"bg-black dark:bg-white text-white dark:text-black rounded-lg p-4\">\n            <div className=\"flex items-start gap-3 mb-3\">\n              <div className=\"p-1.5 rounded bg-white/20 dark:bg-black/20\">\n                <Brain className=\"h-4 w-4\" />\n              </div>\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <p className=\"font-semibold text-sm\">Premium Plan</p>\n                  <Badge variant=\"secondary\" className=\"text-xs bg-white/20 dark:bg-black/20 hover:bg-white/20\">\n                    {formatAmount(convertFromUSD(9.99))}/mo\n                  </Badge>\n                </div>\n                <p className=\"text-xs opacity-90\">\n                  Deep CFO-level analysis with Claude Opus 4.1\n                </p>\n              </div>\n            </div>\n\n            <Separator className=\"my-3 bg-white/20 dark:bg-black/20\" />\n\n            <ul className=\"space-y-2\">\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Advanced debt payoff strategies (Snowball vs Avalanche with projections)</span>\n              </li>\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Retirement planning with glidepath optimization</span>\n              </li>\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Tax optimization (Roth vs Traditional, bracket analysis)</span>\n              </li>\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Portfolio rebalancing & asset allocation analysis</span>\n              </li>\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Multi-year financial scenario planning</span>\n              </li>\n              <li className=\"flex items-start gap-2 text-xs\">\n                <Check className=\"h-4 w-4 shrink-0 mt-0.5\" />\n                <span>Unlimited deep analysis queries</span>\n              </li>\n            </ul>\n          </div>\n\n          {/* Value Prop */}\n          <div className=\"text-center py-2\">\n            <p className=\"text-xs text-muted-foreground\">\n              Get professional-grade financial insights for complex scenarios\n            </p>\n          </div>\n        </div>\n\n        <DialogFooter className=\"gap-2 sm:gap-0\">\n          <Button\n            variant=\"outline\"\n            onClick={onClose}\n            data-testid=\"button-cancel-upgrade\"\n          >\n            Maybe Later\n          </Button>\n          <Button\n            onClick={handleUpgrade}\n            className=\"bg-black dark:bg-white text-white dark:text-black hover:bg-black/90 dark:hover:bg-white/90\"\n            data-testid=\"button-upgrade-now\"\n          >\n            <Sparkles className=\"h-4 w-4 mr-2\" />\n            Upgrade to Premium\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":6387,"size_tokens":null},"tests/ai/hybrid-ai.test.ts":{"content":"/**\n * Hybrid AI System Smoke Tests\n * \n * Tests routing logic, escalation triggers, and response structure\n * for both Scout (Llama 4) and Reasoning (Claude Opus 4.1) paths\n */\n\nimport { describe, it, expect } from 'vitest';\nimport { shouldEscalate, routeToModel, getRoutingReason } from '../../server/ai/router';\nimport type { ComplexitySignals } from '../../server/ai/router';\n\ndescribe('Hybrid AI Router', () => {\n  describe('shouldEscalate()', () => {\n    it('should NOT escalate simple queries', () => {\n      const signals: ComplexitySignals = {\n        message: \"What's a good monthly budget?\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 30,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(false);\n    });\n\n    it('should escalate when 3+ debts present (auto-escalation)', () => {\n      const signals: ComplexitySignals = {\n        message: \"Help me with my finances\",\n        debtsCount: 3,\n        assetsCount: 0,\n        messageLength: 25,\n        contextTokens: 600,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate multi-year planning queries', () => {\n      const signals: ComplexitySignals = {\n        message: \"I need a 5-year financial plan to save for retirement\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 55,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate retirement planning queries', () => {\n      const signals: ComplexitySignals = {\n        message: \"How much should I save to retire at 65?\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 45,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate tax optimization queries', () => {\n      const signals: ComplexitySignals = {\n        message: \"Should I do Roth or Traditional IRA?\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 40,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate portfolio queries with assets', () => {\n      const signals: ComplexitySignals = {\n        message: \"Should I rebalance my portfolio?\",\n        debtsCount: 0,\n        assetsCount: 5,\n        messageLength: 35,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate invest vs pay-off scenarios', () => {\n      const signals: ComplexitySignals = {\n        message: \"Should I invest my bonus or pay off debt?\",\n        debtsCount: 1,\n        assetsCount: 0,\n        messageLength: 45,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should escalate complex multi-part queries', () => {\n      const signals: ComplexitySignals = {\n        message: \"I have $10k to spare. Should I invest, pay debt, or save? Consider tax implications.\",\n        debtsCount: 1,\n        assetsCount: 2,\n        messageLength: 90,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n  });\n\n  describe('routeToModel()', () => {\n    it('should route simple queries to Scout', () => {\n      const signals: ComplexitySignals = {\n        message: \"What's a good savings rate?\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 30,\n        contextTokens: 500,\n      };\n      \n      expect(routeToModel(signals)).toBe('scout');\n    });\n\n    it('should route complex queries to Reasoning', () => {\n      const signals: ComplexitySignals = {\n        message: \"Create a 10-year retirement plan with tax-optimized withdrawals\",\n        debtsCount: 0,\n        assetsCount: 3,\n        messageLength: 65,\n        contextTokens: 500,\n      };\n      \n      expect(routeToModel(signals)).toBe('reasoning');\n    });\n\n    it('should route 3+ debts to Reasoning', () => {\n      const signals: ComplexitySignals = {\n        message: \"Help me budget\",\n        debtsCount: 3,\n        assetsCount: 0,\n        messageLength: 15,\n        contextTokens: 500,\n      };\n      \n      expect(routeToModel(signals)).toBe('reasoning');\n    });\n  });\n\n  describe('getRoutingReason()', () => {\n    it('should explain debt auto-escalation', () => {\n      const signals: ComplexitySignals = {\n        message: \"Any advice?\",\n        debtsCount: 4,\n        assetsCount: 0,\n        messageLength: 12,\n        contextTokens: 500,\n      };\n      \n      const reason = getRoutingReason(signals);\n      expect(reason).toContain('4 debts');\n      expect(reason).toContain('auto-escalated');\n    });\n\n    it('should explain multi-year escalation', () => {\n      const signals: ComplexitySignals = {\n        message: \"I need a 5-year plan\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 22,\n        contextTokens: 500,\n      };\n      \n      const reason = getRoutingReason(signals);\n      expect(reason).toContain('Multi-year');\n    });\n\n    it('should explain retirement escalation', () => {\n      const signals: ComplexitySignals = {\n        message: \"When can I retire?\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 18,\n        contextTokens: 500,\n      };\n      \n      const reason = getRoutingReason(signals);\n      expect(reason).toContain('Retirement');\n    });\n  });\n\n  describe('Edge Cases', () => {\n    it('should handle zero-length messages', () => {\n      const signals: ComplexitySignals = {\n        message: \"\",\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 0,\n        contextTokens: 0,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(false);\n    });\n\n    it('should handle very long messages (>500 chars)', () => {\n      const longMessage = \"a\".repeat(600);\n      const signals: ComplexitySignals = {\n        message: longMessage,\n        debtsCount: 0,\n        assetsCount: 0,\n        messageLength: 600,\n        contextTokens: 2000,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(false);\n    });\n\n    it('should prioritize debt count over keywords', () => {\n      const signals: ComplexitySignals = {\n        message: \"Simple question\",\n        debtsCount: 5,\n        assetsCount: 0,\n        messageLength: 15,\n        contextTokens: 500,\n      };\n      \n      expect(shouldEscalate(signals)).toBe(true);\n    });\n\n    it('should handle mixed signals (high assets, no keywords)', () => {\n      const signals: ComplexitySignals = {\n        message: \"What should I do?\",\n        debtsCount: 0,\n        assetsCount: 10,\n        messageLength: 18,\n        contextTokens: 500,\n      };\n      \n      // Should NOT escalate without portfolio keywords\n      expect(shouldEscalate(signals)).toBe(false);\n    });\n  });\n\n  describe('Keyword Detection', () => {\n    const testCases = [\n      { keyword: 'debt', shouldEscalate: true },\n      { keyword: 'retirement', shouldEscalate: true },\n      { keyword: 'tax optimization', shouldEscalate: true },\n      { keyword: 'portfolio rebalancing', shouldEscalate: true },\n      { keyword: 'budget', shouldEscalate: false },\n      { keyword: 'spending', shouldEscalate: false },\n    ];\n\n    testCases.forEach(({ keyword, shouldEscalate: expected }) => {\n      it(`should ${expected ? 'escalate' : 'NOT escalate'} \"${keyword}\"`, () => {\n        const signals: ComplexitySignals = {\n          message: `Help me with ${keyword}`,\n          debtsCount: 0,\n          assetsCount: keyword.includes('portfolio') ? 3 : 0,\n          messageLength: keyword.length + 13,\n          contextTokens: 500,\n        };\n        \n        expect(shouldEscalate(signals)).toBe(expected);\n      });\n    });\n  });\n});\n\ndescribe('Context Builder', () => {\n  // Note: These are structure tests. Actual data would require mocked storage.\n  \n  it('should export estimateContextTokens function', async () => {\n    const { estimateContextTokens } = await import('../../server/ai/contextBuilder');\n    expect(typeof estimateContextTokens).toBe('function');\n  });\n\n  it('should export buildFinancialContext function', async () => {\n    const { buildFinancialContext } = await import('../../server/ai/contextBuilder');\n    expect(typeof buildFinancialContext).toBe('function');\n  });\n});\n\ndescribe('Orchestrators', () => {\n  it('should export debt orchestrator', async () => {\n    const { analyzeDebt } = await import('../../server/ai/orchestrators/debt');\n    expect(typeof analyzeDebt).toBe('function');\n  });\n\n  it('should export retirement orchestrator', async () => {\n    const { analyzeRetirement } = await import('../../server/ai/orchestrators/retirement');\n    expect(typeof analyzeRetirement).toBe('function');\n  });\n\n  it('should export tax orchestrator', async () => {\n    const { analyzeTax } = await import('../../server/ai/orchestrators/tax');\n    expect(typeof analyzeTax).toBe('function');\n  });\n\n  it('should export portfolio orchestrator', async () => {\n    const { analyzePortfolio } = await import('../../server/ai/orchestrators/portfolio');\n    expect(typeof analyzePortfolio).toBe('function');\n  });\n});\n\ndescribe('AI Clients', () => {\n  it('should export Scout client getter', async () => {\n    const { getScoutClient } = await import('../../server/ai/clients');\n    expect(typeof getScoutClient).toBe('function');\n  });\n\n  it('should export Reasoning client getter', async () => {\n    const { getReasoningClient } = await import('../../server/ai/clients');\n    expect(typeof getReasoningClient).toBe('function');\n  });\n});\n\ndescribe('Hybrid AI Service', () => {\n  it('should export generateHybridAdvice function', async () => {\n    const { generateHybridAdvice } = await import('../../server/ai/hybridAIService');\n    expect(typeof generateHybridAdvice).toBe('function');\n  });\n\n  describe('Response Contract', () => {\n    it('should return required fields in response', () => {\n      // Mock response structure validation\n      const mockResponse = {\n        answer: \"Test answer\",\n        modelUsed: 'scout' as const,\n        tokensIn: 100,\n        tokensOut: 50,\n        cost: 0.001,\n        escalated: false\n      };\n\n      expect(mockResponse).toHaveProperty('answer');\n      expect(mockResponse).toHaveProperty('modelUsed');\n      expect(mockResponse).toHaveProperty('tokensIn');\n      expect(mockResponse).toHaveProperty('tokensOut');\n      expect(mockResponse).toHaveProperty('cost');\n      expect(mockResponse).toHaveProperty('escalated');\n      expect(typeof mockResponse.answer).toBe('string');\n      expect(['scout', 'reasoning']).toContain(mockResponse.modelUsed);\n      expect(typeof mockResponse.tokensIn).toBe('number');\n      expect(typeof mockResponse.tokensOut).toBe('number');\n      expect(typeof mockResponse.cost).toBe('number');\n      expect(typeof mockResponse.escalated).toBe('boolean');\n    });\n\n    it('should include escalation metadata when escalated', () => {\n      const escalatedResponse = {\n        answer: \"Deep analysis...\",\n        modelUsed: 'reasoning' as const,\n        tokensIn: 1000,\n        tokensOut: 500,\n        cost: 0.05,\n        escalated: true,\n        escalationReason: \"Complex debt situation (3 debts) - auto-escalated\",\n        orchestratorUsed: \"debt\"\n      };\n\n      expect(escalatedResponse.escalated).toBe(true);\n      expect(escalatedResponse).toHaveProperty('escalationReason');\n      expect(escalatedResponse).toHaveProperty('orchestratorUsed');\n      expect(typeof escalatedResponse.escalationReason).toBe('string');\n    });\n\n    it('should include structuredData when orchestrator used', () => {\n      const orchestratorResponse = {\n        answer: \"Debt payoff strategy...\",\n        modelUsed: 'reasoning' as const,\n        tokensIn: 1000,\n        tokensOut: 500,\n        cost: 0.05,\n        escalated: true,\n        escalationReason: \"Debt optimization requested\",\n        orchestratorUsed: \"debt\",\n        structuredData: {\n          strategy: { type: 'avalanche' },\n          payoffOrder: []\n        }\n      };\n\n      expect(orchestratorResponse).toHaveProperty('structuredData');\n      expect(typeof orchestratorResponse.structuredData).toBe('object');\n    });\n  });\n\n  describe('Cost Calculations', () => {\n    it('should calculate Scout costs correctly', () => {\n      // Scout: $0.00059 input, $0.00079 output per 1K tokens\n      const tokensIn = 500;\n      const tokensOut = 300;\n      const expectedCost = (500 / 1000) * 0.00059 + (300 / 1000) * 0.00079;\n      \n      // Cost should be ~$0.000532\n      expect(expectedCost).toBeCloseTo(0.000532, 6);\n    });\n\n    it('should calculate Reasoning costs correctly', () => {\n      // Reasoning: $0.015 input, $0.075 output per 1K tokens\n      const tokensIn = 1000;\n      const tokensOut = 500;\n      const expectedCost = (1000 / 1000) * 0.015 + (500 / 1000) * 0.075;\n      \n      // Cost should be $0.0525\n      expect(expectedCost).toBeCloseTo(0.0525, 4);\n    });\n\n    it('should verify Reasoning is ~100x more expensive than Scout', () => {\n      const scoutCost = (500 / 1000) * 0.00059 + (300 / 1000) * 0.00079;\n      const reasoningCost = (500 / 1000) * 0.015 + (300 / 1000) * 0.075;\n      const ratio = reasoningCost / scoutCost;\n      \n      // Reasoning should be 40-100x more expensive\n      expect(ratio).toBeGreaterThan(40);\n      expect(ratio).toBeLessThan(100);\n    });\n  });\n});\n\ndescribe('Premium Gating Logic', () => {\n  describe('Client-Side Heuristics', () => {\n    const detectLikelyEscalation = (text: string): boolean => {\n      const lower = text.toLowerCase();\n      const triggers = [\n        'debt', 'debts', 'credit card', \n        'retire', 'retirement', '401k', 'ira',\n        'tax', 'roth', 'traditional',\n        'portfolio', 'asset allocation', 'rebalance',\n        'multi-year', 'invest vs pay'\n      ];\n      return triggers.some(trigger => lower.includes(trigger)) || text.length > 200;\n    };\n\n    it('should detect debt-related queries', () => {\n      expect(detectLikelyEscalation(\"I have credit card debt\")).toBe(true);\n      expect(detectLikelyEscalation(\"Should I pay off my debts?\")).toBe(true);\n    });\n\n    it('should detect retirement-related queries', () => {\n      expect(detectLikelyEscalation(\"How much for retirement?\")).toBe(true);\n      expect(detectLikelyEscalation(\"401k vs IRA?\")).toBe(true);\n    });\n\n    it('should detect tax-related queries', () => {\n      expect(detectLikelyEscalation(\"Roth or Traditional IRA?\")).toBe(true);\n      expect(detectLikelyEscalation(\"Tax optimization strategy?\")).toBe(true);\n    });\n\n    it('should detect portfolio-related queries', () => {\n      expect(detectLikelyEscalation(\"Should I rebalance my portfolio?\")).toBe(true);\n      expect(detectLikelyEscalation(\"Asset allocation advice?\")).toBe(true);\n    });\n\n    it('should NOT detect simple queries', () => {\n      expect(detectLikelyEscalation(\"What's a good budget?\")).toBe(false);\n      expect(detectLikelyEscalation(\"How much should I save?\")).toBe(false);\n    });\n\n    it('should detect very long queries', () => {\n      const longQuery = \"a\".repeat(250);\n      expect(detectLikelyEscalation(longQuery)).toBe(true);\n    });\n  });\n\n  describe('Subscription Tier Checks', () => {\n    it('should identify premium tier', () => {\n      const subscription = { tier: 'premium' };\n      const isPremium = subscription?.tier === 'premium' || subscription?.tier === 'pro';\n      expect(isPremium).toBe(true);\n    });\n\n    it('should identify pro tier as premium', () => {\n      const subscription = { tier: 'pro' };\n      const isPremium = subscription?.tier === 'premium' || subscription?.tier === 'pro';\n      expect(isPremium).toBe(true);\n    });\n\n    it('should identify free tier as non-premium', () => {\n      const subscription = { tier: 'free' };\n      const isPremium = subscription?.tier === 'premium' || subscription?.tier === 'pro';\n      expect(isPremium).toBe(false);\n    });\n\n    it('should handle missing subscription', () => {\n      const subscription: { tier?: string } | undefined = undefined;\n      const isPremium = subscription?.tier === 'premium' || subscription?.tier === 'pro';\n      expect(isPremium).toBe(false);\n    });\n  });\n\n  describe('Gate Trigger Behavior', () => {\n    it('should trigger gate for non-premium + complex query', () => {\n      const isPremium = false;\n      const wouldEscalate = true;\n      const shouldShowGate = wouldEscalate && !isPremium;\n      \n      expect(shouldShowGate).toBe(true);\n    });\n\n    it('should NOT trigger gate for premium + complex query', () => {\n      const isPremium = true;\n      const wouldEscalate = true;\n      const shouldShowGate = wouldEscalate && !isPremium;\n      \n      expect(shouldShowGate).toBe(false);\n    });\n\n    it('should NOT trigger gate for non-premium + simple query', () => {\n      const isPremium = false;\n      const wouldEscalate = false;\n      const shouldShowGate = wouldEscalate && !isPremium;\n      \n      expect(shouldShowGate).toBe(false);\n    });\n  });\n});\n","path":null,"size_bytes":16968,"size_tokens":null},"docs/ai-architecture.md":{"content":"# Hybrid AI Architecture Documentation\n\n## Overview\n\nTwealth uses a **hybrid AI architecture** that intelligently routes queries between two AI models:\n\n1. **Scout** (Llama 4 via Groq) - Fast, cost-effective model for 90-95% of queries\n2. **Reasoning** (Claude Opus 4.1 via Anthropic) - Deep CFO-level analysis for complex scenarios\n\nThis architecture delivers:\n- **92-96% cost savings** compared to using Claude Opus for all queries\n- **Sub-second response times** for simple queries\n- **Professional-grade analysis** for complex financial scenarios\n- **Estimated cost**: $0.40-$1.60 per premium user/month (vs. $9.99/month subscription)\n\n---\n\n## Architecture Flow\n\n```\nUser Query → API Endpoint\n              ↓\n         Router (shouldEscalate?)\n              ↓\n         ┌────┴────┐\n         ↓         ↓\n      Scout    Reasoning\n    (Llama 4)  (Opus 4.1)\n         ↓         ↓\n    Fast Answer  ↓\n              Orchestrator?\n                  ↓\n        ┌─────────┴──────────┐\n        ↓         ↓          ↓\n      Debt    Retirement   Tax   Portfolio\n        ↓         ↓          ↓      ↓\n     Structured Analysis (Zod-validated)\n                  ↓\n            Response with Metadata\n```\n\n---\n\n## Component Architecture\n\n### 1. Configuration Layer\n**File**: `server/config/ai.ts`\n\n```typescript\nexport const AI_CONFIG = {\n  SCOUT_PROVIDER: 'groq',\n  SCOUT_MODEL: 'llama-3.3-70b-versatile',\n  REASON_PROVIDER: 'anthropic',\n  REASON_MODEL: 'claude-opus-4-20250514',\n  MAX_TOKENS: 2000,\n  TEMPERATURE: 0.7\n};\n\nexport const MODEL_COSTS = {\n  'llama-3.3-70b-versatile': { input: 0.00059, output: 0.00079 },\n  'claude-opus-4-20250514': { input: 0.015, output: 0.075 }\n};\n```\n\n**Environment Variables**:\n- `AI_SCOUT_PROVIDER` - Provider for Scout (default: 'groq')\n- `AI_SCOUT_MODEL` - Model name for Scout\n- `AI_REASON_PROVIDER` - Provider for Reasoning (default: 'anthropic')\n- `AI_REASON_MODEL` - Model name for Reasoning\n- `GROQ_API_KEY` - Groq API key (required)\n- `ANTHROPIC_API_KEY` - Anthropic API key (required)\n\n---\n\n### 2. AI Clients\n**File**: `server/ai/clients.ts`\n\nThin wrappers around provider SDKs with standardized interface:\n\n```typescript\ninterface AIResponse {\n  text: string;      // Natural language response\n  tokensIn: number;  // Input tokens consumed\n  tokensOut: number; // Output tokens generated\n  cost: number;      // Cost in USD\n}\n```\n\n**Scout Client** (Groq SDK):\n- Model: Llama 3.3 70B Versatile\n- Cost: ~$0.0006/1K input, ~$0.0008/1K output\n- Latency: 200-500ms average\n\n**Reasoning Client** (Anthropic SDK):\n- Model: Claude Opus 4.1\n- Cost: ~$0.015/1K input, ~$0.075/1K output\n- Latency: 2-5s average\n\n---\n\n### 3. Smart Router\n**File**: `server/ai/router.ts`\n\n**Primary Function**: `shouldEscalate(signals: ComplexitySignals): boolean`\n\n**Complexity Signals**:\n```typescript\ninterface ComplexitySignals {\n  message: string;         // User query text\n  debtsCount: number;      // Number of debts\n  assetsCount: number;     // Number of assets\n  messageLength: number;   // Character count\n  contextTokens: number;   // Estimated context size\n}\n```\n\n**Auto-Escalation Triggers** (always escalate):\n1. **3+ debts** - Automatic regardless of keywords\n2. **Multi-year planning** - Keywords: \"5 year\", \"10 year\", \"multi-year\"\n3. **Retirement planning** - Keywords: \"retire\", \"retirement\", \"glidepath\", \"401k\", \"ira\"\n4. **Tax optimization** - Keywords: \"tax\", \"roth\", \"traditional\", \"bracket\"\n5. **Portfolio analysis** - Keywords: \"portfolio\", \"asset allocation\", \"rebalance\" + assets > 0\n6. **Invest vs pay-off** - Keywords: \"invest\" + (\"debt\" | \"pay off\")\n7. **Multiple scenarios** - Keywords: \"compare\", \"vs\", \"versus\" with 2+ financial terms\n\n**Routing Logic**:\n```typescript\nexport function shouldEscalate(signals: ComplexitySignals): boolean {\n  const msg = signals.message.toLowerCase();\n  \n  // Auto-escalate on 3+ debts (regardless of keywords)\n  if (signals.debtsCount >= 3) return true;\n  \n  // Multi-year planning\n  if (/\\d+[- ]year/i.test(msg) || /multi[- ]year/i.test(msg)) return true;\n  \n  // Retirement planning\n  if (/(retire|retirement|401k|ira|glidepath)/i.test(msg)) return true;\n  \n  // Tax optimization\n  if (/(tax|roth|traditional|bracket)/i.test(msg)) return true;\n  \n  // Portfolio (only if user has assets)\n  if (signals.assetsCount > 0 && \n      /(portfolio|asset allocation|rebalance|diversif)/i.test(msg)) return true;\n  \n  // Invest vs pay-off scenarios\n  if (/invest/i.test(msg) && /(debt|pay[ -]?off)/i.test(msg)) return true;\n  \n  return false;\n}\n```\n\n---\n\n### 4. Context Builder\n**File**: `server/ai/contextBuilder.ts`\n\n**Purpose**: Normalize user financial data into a structured format for both Scout and Reasoning models.\n\n**Data Sources**:\n- User income (monthly)\n- User expenses (monthly)\n- Transactions (last 30 days)\n- Financial goals\n- Debts (balance, APR, minimum payment)\n- Assets (type, value, liquid vs illiquid)\n- Budget categories\n- User preferences (risk tolerance, timeline)\n\n**Output Structure**:\n```typescript\ninterface FinancialContext {\n  income: {\n    sources: Array<{ name: string; amount: number; frequency: string }>;\n    total: number;\n  };\n  expenses: {\n    monthly: number;\n    categories: Array<{ name: string; amount: number }>;\n  };\n  debts: Array<{\n    name: string;\n    balance: number;\n    apr: number;\n    minimumPayment: number;\n    monthlyPayment: number;\n  }>;\n  assets: Array<{\n    name: string;\n    type: string;\n    value: number;\n    liquid: boolean;\n  }>;\n  goals: Array<{\n    name: string;\n    target: number;\n    current: number;\n    horizonMonths: number;\n  }>;\n  preferences: {\n    riskTolerance?: string;\n    savingsTimeline?: string;\n  };\n}\n```\n\n**Token Estimation**:\n```typescript\nexport function estimateContextTokens(context: FinancialContext): number {\n  // Rough estimate: 4 characters ≈ 1 token\n  return Math.ceil(JSON.stringify(context).length / 4);\n}\n```\n\n---\n\n### 5. Orchestrators\n**Directory**: `server/ai/orchestrators/`\n\nDeep CFO-level analysis modules for complex scenarios. Each orchestrator:\n- Uses Claude Opus 4.1 (Reasoning model)\n- Returns **structured JSON** validated by Zod\n- Provides **natural language summary**\n- Throws errors on validation failure (no silent fallbacks)\n\n#### Debt Orchestrator\n**File**: `debt.ts`\n\n**Purpose**: Analyze debt payoff strategies (Snowball vs Avalanche)\n\n**Input**: FinancialContext + user query\n**Output** (Zod-validated):\n```typescript\n{\n  strategy: {\n    type: 'snowball' | 'avalanche' | 'hybrid';\n    reason: string;\n    projectedMonthsToDebtFree: number;\n    totalInterestPaid: number;\n  };\n  payoffOrder: Array<{\n    debtName: string;\n    balance: number;\n    apr: number;\n    priorityRank: number;\n    monthsToPayoff: number;\n    interestPaid: number;\n  }>;\n  alternativeStrategy?: {\n    type: string;\n    projectedMonths: number;\n    totalInterest: number;\n    tradeoffs: string;\n  };\n  summary: string;\n}\n```\n\n**Safeguards**:\n- Throws if no debts provided\n- Validates all numeric fields are non-negative\n- Ensures payoff order has same count as debts\n\n#### Retirement Orchestrator\n**File**: `retirement.ts`\n\n**Purpose**: Retirement planning with glidepath optimization\n\n**Output** (Zod-validated):\n```typescript\n{\n  targetRetirementAge: number;\n  yearsToRetirement: number;\n  targetAmount: number;\n  currentSavings: number;\n  monthlyContributionNeeded: number;\n  glidepath: {\n    currentAllocation: { stocks: number; bonds: number; cash: number };\n    targetAllocation: { stocks: number; bonds: number; cash: number };\n    rebalancingSchedule: string;\n  };\n  incomeProjection: {\n    monthlyIncome: number;\n    source: string;\n    inflationAdjusted: boolean;\n  };\n  summary: string;\n}\n```\n\n**Safeguards**:\n- Division by zero guards for years to retirement\n- Validates allocation percentages sum to 100\n- Ensures all ages are positive\n\n#### Tax Orchestrator\n**File**: `tax.ts`\n\n**Purpose**: Tax optimization (Roth vs Traditional, bracket analysis)\n\n**Output** (Zod-validated):\n```typescript\n{\n  recommendation: {\n    accountType: 'roth' | 'traditional' | 'split';\n    rothContribution: number;\n    traditionalContribution: number;\n    reason: string;\n  };\n  taxImpact: {\n    currentBracket: string;\n    effectiveRate: number;\n    marginalRate: number;\n    estimatedSavings: number;\n  };\n  multiYearStrategy?: {\n    year1: string;\n    year2: string;\n    year3: string;\n  };\n  summary: string;\n}\n```\n\n**Safeguards**:\n- Validates contribution amounts are non-negative\n- Ensures rates are between 0-100%\n- Includes filing status and deductions in prompts\n\n#### Portfolio Orchestrator\n**File**: `portfolio.ts`\n\n**Purpose**: Asset allocation, rebalancing, risk-adjusted returns\n\n**Output** (Zod-validated):\n```typescript\n{\n  currentAllocation: {\n    stocks: number;\n    bonds: number;\n    cash: number;\n    alternatives: number;\n  };\n  targetAllocation: {\n    stocks: number;\n    bonds: number;\n    cash: number;\n    alternatives: number;\n  };\n  rebalancingPlan: Array<{\n    assetClass: string;\n    currentPercentage: number;\n    targetPercentage: number;\n    action: 'buy' | 'sell' | 'hold';\n    amount: number;\n  }>;\n  riskAssessment: {\n    currentRiskLevel: 'low' | 'medium' | 'high';\n    targetRiskLevel: 'low' | 'medium' | 'high';\n    volatility: number;\n  };\n  summary: string;\n}\n```\n\n**Safeguards**:\n- Early return if no assets\n- Asset categorization (liquid vs illiquid)\n- Validates allocation percentages\n- Prevents division by zero\n\n---\n\n### 6. Hybrid AI Service\n**File**: `server/ai/hybridAIService.ts`\n\n**Main Entry Point**: `generateHybridAdvice(userId, message, storage)`\n\n**Flow**:\n1. Build financial context from user data\n2. Evaluate complexity signals\n3. Route to Scout or Reasoning\n4. If Reasoning: detect and call orchestrator\n5. Return structured response with metadata\n\n**Response Structure**:\n```typescript\ninterface HybridAIResponse {\n  answer: string;              // Natural language response\n  modelUsed: 'scout' | 'reasoning';\n  tokensIn: number;\n  tokensOut: number;\n  cost: number;                // Cost in USD\n  escalated: boolean;\n  escalationReason?: string;   // Why it was escalated\n  orchestratorUsed?: string;   // 'debt' | 'retirement' | 'tax' | 'portfolio'\n  structuredData?: any;        // Zod-validated structured output\n}\n```\n\n---\n\n### 7. API Endpoint\n**File**: `server/routes.ts`\n\n**Endpoint**: `POST /api/ai/advise`\n\n**Request**:\n```json\n{\n  \"message\": \"I have 3 credit cards with high interest. What should I do?\"\n}\n```\n\n**Response**:\n```json\n{\n  \"answer\": \"Based on your debt situation...\",\n  \"modelUsed\": \"reasoning\",\n  \"tokensIn\": 850,\n  \"tokensOut\": 420,\n  \"cost\": 0.04425,\n  \"escalated\": true,\n  \"escalationReason\": \"Complex debt situation (3 debts) - auto-escalated\",\n  \"orchestratorUsed\": \"debt\",\n  \"structuredData\": { ... }\n}\n```\n\n**Authentication**: Required (`isAuthenticated` middleware)\n\n**Error Handling**:\n- Returns 400 if message is missing\n- Returns 500 with error details in development mode\n- Logs all requests with model used, escalation status, and cost\n\n---\n\n## Cost Analysis\n\n### Scout (Llama 4 via Groq)\n- **Input**: $0.00059 per 1K tokens\n- **Output**: $0.00079 per 1K tokens\n- **Typical query**: 500 input + 300 output = **$0.00053**\n\n### Reasoning (Claude Opus 4.1)\n- **Input**: $0.015 per 1K tokens\n- **Output**: $0.075 per 1K tokens\n- **Typical query**: 1000 input + 500 output = **$0.0525**\n\n### Monthly Cost Projection (Premium User)\n- **Assumption**: 50 queries/month\n- **Split**: 45 Scout (90%) + 5 Reasoning (10%)\n- **Cost**: (45 × $0.0005) + (5 × $0.05) = **$0.27/month**\n\n**Margin at $9.99/month**: 97.3%\n\n---\n\n## Environment Setup\n\n### Required API Keys\n```bash\n# Groq (Scout)\nGROQ_API_KEY=gsk_...\n\n# Anthropic (Reasoning)\nANTHROPIC_API_KEY=sk-ant-...\n```\n\n### Optional Configuration\n```bash\n# Override default models\nAI_SCOUT_MODEL=llama-3.3-70b-versatile\nAI_REASON_MODEL=claude-opus-4-20250514\n\n# Override providers\nAI_SCOUT_PROVIDER=groq\nAI_REASON_PROVIDER=anthropic\n\n# AI parameters\nAI_MAX_TOKENS=2000\nAI_TEMPERATURE=0.7\n```\n\n---\n\n## Adding New Orchestrators\n\n### Step 1: Create Orchestrator File\n**File**: `server/ai/orchestrators/[name].ts`\n\n```typescript\nimport Anthropic from '@anthropic-ai/sdk';\nimport { z } from 'zod';\n\n// 1. Define Zod schema\nconst MyAnalysisSchema = z.object({\n  recommendation: z.string(),\n  details: z.object({\n    // ... your fields\n  }),\n  summary: z.string()\n});\n\n// 2. Export orchestrator function\nexport async function analyzeMyFeature(context: any, userQuery: string) {\n  const client = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY\n  });\n  \n  // 3. Build prompt\n  const prompt = `Analyze the following scenario...\nContext: ${JSON.stringify(context)}\nUser Query: ${userQuery}\n\nReturn JSON matching this schema: ${JSON.stringify(MyAnalysisSchema.shape)}`;\n  \n  // 4. Call Claude Opus\n  const response = await client.messages.create({\n    model: 'claude-opus-4-20250514',\n    max_tokens: 2000,\n    messages: [{ role: 'user', content: prompt }]\n  });\n  \n  // 5. Extract and validate\n  const text = response.content[0].text;\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (!jsonMatch) throw new Error('No JSON in response');\n  \n  const parsed = JSON.parse(jsonMatch[0]);\n  const validated = MyAnalysisSchema.parse(parsed); // Throws if invalid\n  \n  return validated;\n}\n```\n\n### Step 2: Register in Hybrid Service\n**File**: `server/ai/hybridAIService.ts`\n\n```typescript\n// Add to detectOrchestrator()\nfunction detectOrchestrator(userMessage: string, context: any): string | null {\n  const msgLower = userMessage.toLowerCase();\n  \n  // ... existing conditions ...\n  \n  // Add your orchestrator\n  if (msgLower.includes('your-keyword')) {\n    return 'my-feature';\n  }\n  \n  return null;\n}\n\n// Add to callOrchestrator()\nasync function callOrchestrator(...) {\n  switch (orchestrator) {\n    // ... existing cases ...\n    \n    case 'my-feature':\n      structuredData = await analyzeMyFeature(context, userMessage);\n      break;\n  }\n}\n```\n\n### Step 3: Add Tests\n**File**: `tests/ai/hybrid-ai.test.ts`\n\n```typescript\ndescribe('My Feature Orchestrator', () => {\n  it('should export analyzeMyFeature function', async () => {\n    const { analyzeMyFeature } = await import('../../server/ai/orchestrators/my-feature');\n    expect(typeof analyzeMyFeature).toBe('function');\n  });\n  \n  it('should escalate on my-feature keywords', () => {\n    const signals: ComplexitySignals = {\n      message: \"Help me with my-feature\",\n      debtsCount: 0,\n      assetsCount: 0,\n      messageLength: 25,\n      contextTokens: 500,\n    };\n    \n    expect(shouldEscalate(signals)).toBe(true);\n  });\n});\n```\n\n---\n\n## Testing\n\n### Run Smoke Tests\n```bash\nnpm test tests/ai/hybrid-ai.test.ts\n```\n\n### Test Coverage\n- ✅ Router escalation logic\n- ✅ Keyword detection\n- ✅ Edge cases (zero debts, long messages)\n- ✅ Orchestrator exports\n- ✅ Client exports\n- ✅ Service exports\n\n### Manual Testing\nNavigate to `/hybrid-ai` in the app to test:\n- Sample queries (Scout vs Reasoning)\n- Custom queries\n- Premium gate (for non-premium users)\n- Model badges\n- Loading states\n- Response metadata\n\n---\n\n## UI Components\n\n### HybridAIDemo Page\n**Route**: `/hybrid-ai`\n**File**: `client/src/pages/HybridAIDemo.tsx`\n\n**Features**:\n- Sample query templates\n- Custom query input\n- Model badges (Scout ⚡ vs Reasoning 🧠)\n- Loading states with brain animation\n- Escalation reason display\n- Structured data preview\n- Cost/token metadata\n- Premium gate integration\n\n### PremiumGateModal\n**File**: `client/src/components/modals/PremiumGateModal.tsx`\n\n**Triggers**:\n- Non-premium user attempts deep analysis\n- Query would escalate to Reasoning\n\n**Benefits Highlighted**:\n- Advanced debt payoff strategies\n- Retirement planning with glidepath\n- Tax optimization (Roth vs Traditional)\n- Portfolio rebalancing\n- Multi-year financial planning\n- Unlimited deep analysis\n\n**CTA**: Upgrade to Premium ($9.99/mo)\n\n---\n\n## Production Deployment\n\n### Pre-Deployment Checklist\n- [ ] Set `GROQ_API_KEY` environment variable\n- [ ] Set `ANTHROPIC_API_KEY` environment variable\n- [ ] Test routing with sample queries\n- [ ] Verify premium gate triggers correctly\n- [ ] Check cost tracking logs\n- [ ] Run smoke tests (`npm test`)\n- [ ] Monitor initial cost per user\n\n### Monitoring\n- Log all escalations with reason\n- Track model usage distribution (Scout vs Reasoning)\n- Monitor cost per user per month\n- Alert if cost exceeds $2/user/month\n\n### Performance\n- **Scout**: 200-500ms average latency\n- **Reasoning**: 2-5s average latency\n- **Target**: 90-95% of queries use Scout\n\n---\n\n## Troubleshooting\n\n### Issue: All queries escalating to Reasoning\n**Solution**: Check router logic - likely too many keywords matching\n\n### Issue: Orchestrator throwing validation errors\n**Solution**: Check Zod schema matches Claude's JSON output exactly\n\n### Issue: High costs\n**Solution**: Review escalation logs - adjust router thresholds if needed\n\n### Issue: Premium gate not showing\n**Solution**: Check subscription query returns `{ tier: 'premium' }` or `{ tier: 'pro' }`\n\n---\n\n## Future Enhancements\n\n1. **Fine-tuned Scout Model**: Train Llama on Twealth-specific financial queries\n2. **Hybrid Routing ML**: Use ML model to predict escalation more accurately\n3. **Orchestrator Caching**: Cache common orchestrator results\n4. **Streaming Responses**: Stream Reasoning responses for better UX\n5. **Multi-model Consensus**: For critical decisions, get 2+ model opinions\n\n---\n\n## References\n\n- [Groq API Docs](https://console.groq.com/docs)\n- [Anthropic API Docs](https://docs.anthropic.com/)\n- [Llama 3.3 Model Card](https://llama.meta.com/)\n- [Claude Opus 4.1 Release Notes](https://www.anthropic.com/claude)\n\n---\n\n**Last Updated**: November 11, 2025\n**Version**: 1.0.0\n**Maintainer**: Twealth AI Team\n","path":null,"size_bytes":17827,"size_tokens":null},"server/ai/tierAwareRouter.ts":{"content":"/**\n * Tier-Aware AI Orchestrator\n * \n * Wraps the hybrid AI service with subscription tier checking and quota enforcement.\n * Ensures users only access models they're allowed to use based on their plan.\n * \n * Tier Access Matrix (4-Model System):\n * - Free: Scout only (50/month) - NO Sonnet, NO GPT-5, NO Opus\n * - Pro: Scout (unlimited) + Sonnet (25/month) + GPT-5 (5/month) - NO Opus\n * - Enterprise: Scout (unlimited) + Sonnet (60/month) + GPT-5 (10/month) + Opus (20/month)\n * \n * Model Usage Rules:\n * - Scout (Llama 4): PRIMARY - Fast queries, budgeting, spending, goals (Fast)\n * - Sonnet 3.5/4.5: REASONING - Multi-step logic, investment, debt strategy (Smart)\n * - GPT-5: MATH - Projections, simulations, compound interest, retirement (Math)\n * - Opus 4.1: CFO-LEVEL - Portfolio analysis, high-stakes decisions (CFO)\n */\n\nimport type { IStorage } from '../storage';\nimport { generateHybridAdvice, type HybridAIResponse, type ModelAccess, type GenerateAdviceOptions, TESTING_MODE } from './hybridAIService';\nimport { shouldEscalate, type ComplexitySignals } from './router';\nimport { estimateContextTokens, buildFinancialContext } from './contextBuilder';\n\n// Re-export ModelAccess for convenience\nexport type { ModelAccess };\n\n// Tier names\nexport type SubscriptionTier = 'free' | 'pro' | 'enterprise';\n\n// Quota exceeded error\nexport interface QuotaExceededError {\n  type: 'quota_exceeded';\n  model: ModelAccess;\n  remaining: number;\n  used: number;\n  limit: number;\n  nextTier: SubscriptionTier | null;\n  upgradeRequired: boolean;\n}\n\n// Tier-aware response (either success or quota error)\nexport type TierAwareResponse = HybridAIResponse | QuotaExceededError;\n\n/**\n * Map subscription tier to allowed models\n * Scout is PRIMARY model for all tiers (unlimited for Pro/Enterprise)\n */\nexport function resolveAllowedModels(tier: SubscriptionTier): ModelAccess[] {\n  switch (tier) {\n    case 'free':\n      return ['scout']; // Scout only, 50/month limit\n    case 'pro':\n      return ['scout', 'sonnet', 'gpt5']; // Unlimited Scout + Sonnet + GPT-5\n    case 'enterprise':\n      return ['scout', 'sonnet', 'gpt5', 'opus']; // All models available\n    default:\n      return ['scout']; // Default to Scout\n  }\n}\n\n/**\n * Get models in descending priority order (highest to lowest)\n * Used for cascading fallback when preferred model lacks quota\n * Scout is ALWAYS the final fallback (unlimited for paid tiers)\n */\nfunction getModelsByPriority(tier: SubscriptionTier): ModelAccess[] {\n  switch (tier) {\n    case 'free':\n      return ['scout']; // Scout only\n    case 'pro':\n      return ['gpt5', 'sonnet', 'scout']; // Try GPT-5/Sonnet first, fall back to Scout\n    case 'enterprise':\n      return ['opus', 'gpt5', 'sonnet', 'scout']; // Try premium models, fall back to Scout\n    default:\n      return ['scout'];\n  }\n}\n\n/**\n * Build fallback list: preferred first, then other specialty models, Scout LAST\n * \n * Strategy:\n * 1. Try preferred model (selected for quality/capability match)\n * 2. Fall back to other allowed specialty models in ascending cost order\n * 3. Fall back to Scout LAST as final fallback (unlimited for Pro/Enterprise)\n * \n * Examples:\n * - Free any query: preferred=scout → [scout]\n * - Pro simple query: preferred=scout → [scout, gpt5, sonnet]\n * - Pro reasoning query: preferred=sonnet → [sonnet, gpt5, scout] (Scout LAST!)\n * - Pro math query: preferred=gpt5 → [gpt5, sonnet, scout] (Scout LAST!)\n * - Enterprise CFO query: preferred=opus → [opus, gpt5, sonnet, scout] (Scout LAST!)\n */\nfunction buildFallbackList(preferredModel: ModelAccess, tier: SubscriptionTier): ModelAccess[] {\n  // Get tier-allowed models as a Set for efficient membership checks\n  const allowedModelsArray = resolveAllowedModels(tier);\n  const allowedModels = new Set(allowedModelsArray);\n  \n  // Free tier: only Scout available\n  if (tier === 'free') {\n    return ['scout'];\n  }\n  \n  // Start with preferred model\n  const fallbackOrder: ModelAccess[] = [preferredModel];\n  \n  // Add remaining specialty models in ascending cost order (GPT-5 < Sonnet < Opus)\n  const costOrderedModels: ModelAccess[] = ['gpt5', 'sonnet', 'opus'];\n  const specialtyModels = costOrderedModels.filter(\n    m => m !== preferredModel && allowedModels.has(m)\n  ) as ModelAccess[];\n  \n  fallbackOrder.push(...specialtyModels);\n  \n  // Add Scout as FINAL fallback (unlimited for paid tiers, cheapest)\n  if (preferredModel !== 'scout' && allowedModels.has('scout')) {\n    fallbackOrder.push('scout');\n  }\n  \n  return fallbackOrder;\n}\n\n/**\n * Get next tier for upgrade suggestions\n */\nfunction getNextTier(currentTier: SubscriptionTier): SubscriptionTier | null {\n  switch (currentTier) {\n    case 'free':\n      return 'pro';\n    case 'pro':\n      return 'enterprise';\n    case 'enterprise':\n      return null; // Already at highest tier\n    default:\n      return 'pro';\n  }\n}\n\n/**\n * Check if user has quota remaining for a specific model\n * Scout is unlimited for Pro/Enterprise (scoutLimit = 999999)\n */\nfunction hasQuota(\n  usage: { scoutUsed: number; sonnetUsed: number; gpt5Used: number; opusUsed: number },\n  limits: { scoutLimit: number; sonnetLimit: number; gpt5Limit: number; opusLimit: number },\n  model: ModelAccess\n): boolean {\n  switch (model) {\n    case 'scout':\n      return usage.scoutUsed < limits.scoutLimit; // Unlimited for paid (999999)\n    case 'sonnet':\n      return usage.sonnetUsed < limits.sonnetLimit;\n    case 'gpt5':\n      return usage.gpt5Used < limits.gpt5Limit;\n    case 'opus':\n      return usage.opusUsed < limits.opusLimit;\n    default:\n      return false;\n  }\n}\n\n/**\n * Select the best model based on complexity and tier (ignoring quotas)\n * \n * Model Selection Strategy (Scout-First):\n * 1. Analyze query complexity and keywords\n * 2. Route to appropriate model based on use case:\n *    - Scout: Simple queries (spending, budgeting, goals, transactions)\n *    - Sonnet: Multi-step reasoning (debt strategy, investment basics, risk assessment)\n *    - GPT-5: Advanced math (projections, simulations, compound interest, retirement)\n *    - Opus: CFO-level (portfolio analysis, macroeconomics, high-stakes decisions)\n * 3. Quota checking happens separately in routeWithTierCheck\n */\nfunction selectModelForTier(\n  signals: ComplexitySignals,\n  tier: SubscriptionTier\n): ModelAccess {\n  const msgLower = typeof signals.message === 'string' ? signals.message.toLowerCase() : '';\n  \n  // Free tier: Always Scout (no escalation allowed)\n  if (tier === 'free') {\n    return 'scout';\n  }\n  \n  // Pro tier: Scout, Sonnet, or GPT-5 based on query type\n  if (tier === 'pro') {\n    // GPT-5 for advanced math/projections\n    if (isMathQuery(msgLower)) {\n      return 'gpt5';\n    }\n    // Sonnet for reasoning/strategy\n    if (isReasoningQuery(msgLower) || shouldEscalate(signals)) {\n      return 'sonnet';\n    }\n    // Default to Scout for simple queries\n    return 'scout';\n  }\n  \n  // Enterprise tier: All models available\n  if (tier === 'enterprise') {\n    // Opus for CFO-level analysis\n    if (isCFOQuery(msgLower)) {\n      return 'opus';\n    }\n    // GPT-5 for advanced math\n    if (isMathQuery(msgLower)) {\n      return 'gpt5';\n    }\n    // Sonnet for reasoning\n    if (isReasoningQuery(msgLower) || shouldEscalate(signals)) {\n      return 'sonnet';\n    }\n    // Default to Scout\n    return 'scout';\n  }\n  \n  // Default fallback\n  return 'scout';\n}\n\n/**\n * Detect if query requires advanced math/projections (GPT-5)\n */\nfunction isMathQuery(msg: string): boolean {\n  return (\n    msg.includes('projection') ||\n    msg.includes('simulate') ||\n    msg.includes('compound interest') ||\n    msg.includes('retirement') ||\n    msg.includes('amortization') ||\n    msg.includes('inflation') ||\n    msg.includes('multi-year') ||\n    msg.includes('monte carlo') ||\n    msg.includes('calculate')\n  );\n}\n\n/**\n * Detect if query requires reasoning/strategy (Sonnet)\n */\nfunction isReasoningQuery(msg: string): boolean {\n  return (\n    msg.includes('strategy') ||\n    msg.includes('debt payoff') ||\n    msg.includes('investment') ||\n    msg.includes('risk') ||\n    msg.includes('crypto') ||\n    msg.includes('budget optimi') ||\n    msg.includes('should i') ||\n    msg.includes('analyze') ||\n    msg.includes('compare')\n  );\n}\n\n/**\n * Detect if query requires CFO-level intelligence (Opus)\n */\nfunction isCFOQuery(msg: string): boolean {\n  return (\n    msg.includes('portfolio') ||\n    msg.includes('multi-currency') ||\n    msg.includes('macroeconomic') ||\n    msg.includes('de-dollarization') ||\n    msg.includes('high stakes') ||\n    msg.includes('asset allocation') ||\n    msg.includes('tax optimization') ||\n    msg.includes('wealth management')\n  );\n}\n\n/**\n * Conversation message for memory\n */\nexport interface ConversationMessage {\n  role: 'user' | 'assistant';\n  content: string;\n}\n\n/**\n * Main orchestrator: Routes AI queries with tier-based access control\n */\nexport async function routeWithTierCheck(\n  userId: string,\n  message: string,\n  storage: IStorage,\n  conversationHistory: ConversationMessage[] = []\n): Promise<TierAwareResponse> {\n  try {\n    // CRITICAL: Sanitize message at entry point to prevent TypeError\n    // This ensures all downstream code receives a safe string\n    const sanitizedMessage = typeof message === 'string' ? message : '';\n    \n    // 1. Fetch user subscription and usage\n    const subData = await storage.getUserSubscriptionWithUsage(userId);\n    \n    if (!subData) {\n      throw new Error('User subscription not found');\n    }\n    \n    const { subscription, usage, plan } = subData;\n    \n    // Determine tier\n    const tier: SubscriptionTier = (plan.name?.toLowerCase() as SubscriptionTier) || 'free';\n    \n    // Current usage\n    const currentUsage = {\n      scoutUsed: usage?.scoutQueriesUsed || 0,\n      sonnetUsed: usage?.sonnetQueriesUsed || 0,\n      gpt5Used: usage?.gpt5QueriesUsed || 0,\n      opusUsed: usage?.opusQueriesUsed || 0,\n    };\n    \n    // Plan limits\n    const limits = {\n      scoutLimit: plan.scoutLimit || 0,\n      sonnetLimit: plan.sonnetLimit || 0,\n      gpt5Limit: plan.gpt5Limit || 0,\n      opusLimit: plan.opusLimit || 0,\n    };\n    \n    // 2. Build financial context once\n    const context = await buildFinancialContext(userId, storage);\n    \n    // 3. Create complexity signals for model selection using sanitized message\n    const signals: ComplexitySignals = {\n      message: sanitizedMessage,\n      debtsCount: context.debts.length,\n      assetsCount: context.assets.length,\n      messageLength: sanitizedMessage.length,\n      contextTokens: estimateContextTokens(context),\n    };\n    \n    // 4. Select preferred model for tier based on complexity\n    const preferredModel = selectModelForTier(signals, tier);\n    \n    // 5. Build fallback list: preferred first, then lower-priority models\n    const fallbackModels = buildFallbackList(preferredModel, tier);\n    \n    // 6. Find first model with available quota (try preferred, then fall back)\n    let selectedModel: ModelAccess | null = null;\n    let downgradedFrom: ModelAccess | null = null;\n    \n    // TESTING MODE: Bypass quota checks and grant access to all models\n    if (TESTING_MODE) {\n      selectedModel = preferredModel; // Use preferred model directly\n      downgradedFrom = null; // No downgrade in testing mode\n    } else {\n      // Production mode: Check quotas\n      for (const model of fallbackModels) {\n        if (hasQuota(currentUsage, limits, model)) {\n          selectedModel = model;\n          // Mark as downgraded only if we fell back from preferred\n          if (model !== preferredModel) {\n            downgradedFrom = preferredModel;\n          }\n          break;\n        }\n      }\n      \n      // 7. If no model has quota, return quota_exceeded\n      if (!selectedModel) {\n        // All tier models exhausted\n        return {\n          type: 'quota_exceeded',\n          model: preferredModel,\n          remaining: 0,\n          used: currentUsage[`${preferredModel}Used` as keyof typeof currentUsage],\n          limit: limits[`${preferredModel}Limit` as keyof typeof limits],\n          nextTier: getNextTier(tier),\n          upgradeRequired: true,\n        };\n      }\n    }\n    \n    // 8. Route to AI service with selected model and pre-built context\n    const options: GenerateAdviceOptions = {\n      forceModel: selectedModel,\n      preselectedContext: context,\n      skipAutoEscalation: true, // Tier router has already decided\n      conversationHistory, // Pass conversation history for context\n    };\n    \n    const response = await generateHybridAdvice(userId, sanitizedMessage, storage, options);\n    \n    // 9. Add downgrade warning if we fell back to a lower model\n    if (downgradedFrom) {\n      const warning = `Note: Your ${downgradedFrom} quota is exhausted. Using ${selectedModel} instead. ${\n        getNextTier(tier) ? `Upgrade to ${getNextTier(tier)} for more ${downgradedFrom} queries.` : ''\n      }`;\n      response.answer = `${warning}\\n\\n${response.answer}`;\n      response.tierDowngraded = true;\n    }\n    \n    // 7. Track usage synchronously\n    try {\n      await trackUsage(userId, sanitizedMessage, response, subscription.id, tier, storage);\n      \n      // Increment usage counters based on actual model used\n      const actualModel = determineModelFromSlug(response.modelSlug);\n      await storage.incrementUsageCounters(\n        userId,\n        subscription.id,\n        actualModel\n      );\n    } catch (error) {\n      console.error('[TierAwareRouter] Failed to track usage:', error);\n      // Don't fail the request if logging fails\n    }\n    \n    return response;\n  } catch (error) {\n    console.error('[TierAwareRouter] Error routing query:', error);\n    throw error;\n  }\n}\n\n/**\n * Determine model type from model slug for quota tracking\n * Maps actual AI model to database quota counter\n */\nfunction determineModelFromSlug(modelSlug: string): 'scout' | 'sonnet' | 'gpt5' | 'opus' {\n  const slug = modelSlug.toLowerCase();\n  \n  // Scout (Groq Llama models) - PRIMARY model\n  if (slug.includes('llama') || slug.includes('scout') || slug.includes('groq')) {\n    return 'scout';\n  }\n  \n  // Sonnet (Claude Sonnet models) - REASONING\n  if (slug.includes('sonnet')) {\n    return 'sonnet';\n  }\n  \n  // GPT-5 (OpenAI models) - MATH/PROJECTIONS\n  if (slug.includes('gpt-5') || slug.includes('gpt5') || slug.includes('openai')) {\n    return 'gpt5';\n  }\n  \n  // Opus (Claude Opus models) - CFO-LEVEL (Enterprise only)\n  if (slug.includes('opus')) {\n    return 'opus';\n  }\n  \n  // Unknown Claude model - log warning and default to Sonnet tier\n  if (slug.includes('claude')) {\n    console.warn(`[TierAwareRouter] Unknown Claude model: ${modelSlug}, defaulting to Sonnet tier`);\n    return 'sonnet';\n  }\n  \n  // Completely unknown model - throw error to prevent silent quota theft\n  throw new Error(`[TierAwareRouter] Unknown AI model slug: ${modelSlug}. Cannot determine tier for quota tracking.`);\n}\n\n/**\n * Track usage to aiUsageLogs table\n */\nasync function trackUsage(\n  userId: string,\n  query: string,\n  response: HybridAIResponse,\n  subscriptionId: string,\n  tier: SubscriptionTier,\n  storage: IStorage\n): Promise<void> {\n  // Determine model type from modelSlug (accurate, not heuristic)\n  const modelUsed = determineModelFromSlug(response.modelSlug);\n  \n  await storage.insertAIUsageLog({\n    userId,\n    subscriptionId,\n    query,\n    response: response.answer,\n    modelUsed,\n    modelName: response.modelSlug,\n    escalated: response.escalated,\n    escalationReason: response.escalationReason || null,\n    orchestratorUsed: response.orchestratorUsed || null,\n    tokensIn: response.tokensIn,\n    tokensOut: response.tokensOut,\n    totalTokens: response.tokensIn + response.tokensOut,\n    costUsd: response.cost.toString(),\n    tierAtQuery: tier,\n  });\n}\n","path":null,"size_bytes":15749,"size_tokens":null},"server/seed-subscriptions.ts":{"content":"import { db } from \"./db\";\nimport { subscriptionPlans, subscriptions } from \"../shared/schema\";\nimport { eq, sql, inArray } from \"drizzle-orm\";\n\nfunction normalizeName(name: string): string {\n  return name\n    .replace(/[\\u00A0\\u200B\\u200C\\u200D\\uFEFF]/g, '') // Remove non-breaking spaces and zero-width chars\n    .trim()\n    .toLowerCase();\n}\n\nexport async function seedSubscriptionPlans() {\n  console.log(\"Seeding subscription plans...\");\n\n  const validPlanNames = ['free', 'pro', 'enterprise'];\n\n  // Step 1: Clean up duplicate plans with transaction for atomicity\n  try {\n    const allPlans = await db.query.subscriptionPlans.findMany();\n    \n    for (const canonicalName of validPlanNames) {\n      const matchingPlans = allPlans.filter(p => normalizeName(p.name) === canonicalName);\n      \n      if (matchingPlans.length > 1) {\n        console.log(`  Found ${matchingPlans.length} duplicate \"${canonicalName}\" plans, consolidating...`);\n        \n        let canonicalPlan = matchingPlans.find(p => p.name === canonicalName);\n        if (!canonicalPlan) {\n          canonicalPlan = matchingPlans.find(p => p.stripePriceId !== null);\n        }\n        if (!canonicalPlan) {\n          canonicalPlan = matchingPlans.sort((a, b) => a.id.localeCompare(b.id))[0];\n        }\n        \n        const duplicatePlans = matchingPlans.filter(p => p.id !== canonicalPlan.id);\n        const duplicateIds = duplicatePlans.map(p => p.id);\n        \n        if (duplicateIds.length > 0) {\n          await db.transaction(async (tx) => {\n            await tx\n              .update(subscriptions)\n              .set({ planId: canonicalPlan.id })\n              .where(inArray(subscriptions.planId, duplicateIds));\n            \n            await tx\n              .delete(subscriptionPlans)\n              .where(inArray(subscriptionPlans.id, duplicateIds));\n          });\n          \n          console.log(`    Migrated subscriptions and deleted ${duplicateIds.length} duplicate(s): ${duplicatePlans.map(p => `\"${p.name}\"`).join(', ')}`);\n        }\n      }\n    }\n    \n    // Step 2: Remove orphaned plans\n    const remainingPlans = await db.query.subscriptionPlans.findMany();\n    for (const plan of remainingPlans) {\n      if (!validPlanNames.includes(normalizeName(plan.name))) {\n        const subscriptionsWithPlan = await db.query.subscriptions.findFirst({\n          where: (subs, { eq }) => eq(subs.planId, plan.id),\n        });\n        \n        if (!subscriptionsWithPlan) {\n          await db.delete(subscriptionPlans).where(eq(subscriptionPlans.id, plan.id));\n          console.log(`  Removed orphaned plan: ${plan.name} (${plan.id})`);\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Error during plan cleanup (non-fatal):\", error);\n  }\n\n  const STRIPE_PRO_PRICE_ID = process.env.STRIPE_PRO_PRICE_ID || null;\n  const STRIPE_ENTERPRISE_PRICE_ID = process.env.STRIPE_ENTERPRISE_PRICE_ID || null;\n\n  if (!STRIPE_PRO_PRICE_ID || !STRIPE_ENTERPRISE_PRICE_ID) {\n    console.warn(\"Stripe price IDs not configured. Set STRIPE_PRO_PRICE_ID and STRIPE_ENTERPRISE_PRICE_ID environment variables.\");\n    console.warn(\"Paid subscriptions will not work until these are configured.\");\n  } else {\n    console.log(\"✓ Stripe price IDs configured from environment variables\");\n  }\n\n  const plans = [\n    {\n      name: \"free\",\n      displayName: \"Twealth Free\",\n      description: \"Perfect for getting started with AI-powered financial advice\",\n      priceThb: \"0.00\",\n      priceUsd: \"0.00\",\n      currency: \"USD\",\n      stripePriceId: null,\n      billingInterval: \"monthly\",\n      scoutLimit: 50,\n      sonnetLimit: 0,\n      gpt5Limit: 0,\n      opusLimit: 0,\n      aiChatLimit: 50,\n      aiDeepAnalysisLimit: 0,\n      aiInsightsFrequency: \"never\",\n      isLifetimeLimit: false,\n      sortOrder: 0,\n      features: [\n        \"50 Scout queries/month Fast\",\n        \"Basic financial tracking\",\n        \"Budget management\",\n        \"Goal tracking\",\n        \"Transaction categorization\"\n      ],\n      isActive: true,\n    },\n    {\n      name: \"pro\",\n      displayName: \"Twealth Pro\",\n      description: \"Advanced AI insights with Sonnet reasoning for serious financial planning\",\n      priceThb: \"349.00\",\n      priceUsd: \"9.99\",\n      currency: \"USD\",\n      stripePriceId: STRIPE_PRO_PRICE_ID,\n      billingInterval: \"monthly\",\n      scoutLimit: 999999,\n      sonnetLimit: 25,\n      gpt5Limit: 5,\n      opusLimit: 0,\n      aiChatLimit: 999999,\n      aiDeepAnalysisLimit: 30,\n      aiInsightsFrequency: \"daily\",\n      isLifetimeLimit: false,\n      sortOrder: 1,\n      features: [\n        \"Unlimited Scout queries Fast\",\n        \"25 Sonnet queries/month Smart\",\n        \"5 GPT-5 queries/month Math\",\n        \"Daily proactive insights\",\n        \"Advanced analytics\",\n        \"Priority support\",\n        \"Crypto tracking\",\n        \"Investment recommendations\"\n      ],\n      isActive: true,\n    },\n    {\n      name: \"enterprise\",\n      displayName: \"Twealth Enterprise\",\n      description: \"CFO-level AI intelligence with Opus for comprehensive financial management\",\n      priceThb: \"1749.00\",\n      priceUsd: \"49.99\",\n      currency: \"USD\",\n      stripePriceId: STRIPE_ENTERPRISE_PRICE_ID,\n      billingInterval: \"monthly\",\n      scoutLimit: 999999,\n      sonnetLimit: 60,\n      gpt5Limit: 10,\n      opusLimit: 20,\n      aiChatLimit: 999999,\n      aiDeepAnalysisLimit: 90,\n      aiInsightsFrequency: \"daily\",\n      isLifetimeLimit: false,\n      sortOrder: 2,\n      features: [\n        \"Unlimited Scout queries Fast\",\n        \"60 Sonnet queries/month Smart\",\n        \"10 GPT-5 queries/month Math\",\n        \"20 Opus queries/month CFO\",\n        \"Real-time insights and alerts\",\n        \"Advanced predictive analytics\",\n        \"Premium support\",\n        \"Multi-currency support\",\n        \"De-dollarization insights\",\n        \"White-glove onboarding\"\n      ],\n      isActive: true,\n    },\n  ];\n\n  for (const plan of plans) {\n    // Query fresh each iteration to ensure we see any changes from previous iterations\n    const currentPlans = await db.query.subscriptionPlans.findMany();\n    // Use in-memory matching with full normalization (handles Unicode invisible chars)\n    const existing = currentPlans.find(p => normalizeName(p.name) === plan.name);\n\n    if (existing) {\n      const pricingUpdates: Record<string, any> = {\n        name: plan.name,\n        displayName: plan.displayName,\n        description: plan.description,\n        priceUsd: plan.priceUsd,\n        priceThb: plan.priceThb,\n        scoutLimit: plan.scoutLimit,\n        sonnetLimit: plan.sonnetLimit,\n        gpt5Limit: plan.gpt5Limit,\n        opusLimit: plan.opusLimit,\n        aiChatLimit: plan.aiChatLimit,\n        aiDeepAnalysisLimit: plan.aiDeepAnalysisLimit,\n        features: plan.features,\n        sortOrder: plan.sortOrder,\n      };\n      \n      if (plan.stripePriceId !== null) {\n        pricingUpdates.stripePriceId = plan.stripePriceId;\n      }\n      \n      await db\n        .update(subscriptionPlans)\n        .set(pricingUpdates)\n        .where(eq(subscriptionPlans.id, existing.id));\n      \n      const wasRenamed = existing.name !== plan.name;\n      console.log(`  Updated pricing for: ${plan.name} ($${plan.priceUsd})${plan.stripePriceId ? ' [Stripe ID updated]' : ''}${wasRenamed ? ` [renamed from \"${existing.name}\"]` : ''}`);\n    } else {\n      await db.insert(subscriptionPlans).values(plan);\n      console.log(`  Inserted plan: ${plan.name}`);\n    }\n  }\n\n  // Verification step: confirm exactly 3 plans exist\n  const finalPlans = await db.query.subscriptionPlans.findMany();\n  const planCount = finalPlans.length;\n  const planNames = finalPlans.map(p => p.name).join(', ');\n  \n  if (planCount === 3) {\n    console.log(`✓ Verified: exactly ${planCount} plans exist (${planNames})`);\n  } else {\n    console.warn(`⚠ Warning: expected 3 plans, found ${planCount} (${planNames})`);\n  }\n\n  console.log(\"Subscription plans synced successfully\");\n}\n","path":null,"size_bytes":7913,"size_tokens":null},"client/src/components/ai-roi-calculator.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calculator, TrendingUp, Clock, DollarSign, Sparkles } from \"lucide-react\";\n\ninterface AIROICalculatorProps {\n  userCurrency: string;\n  currentTier: 'free' | 'pro' | 'enterprise';\n}\n\nconst TIER_DATA = {\n  free: {\n    monthlyPrice: 0,\n    scoutQueries: 50,\n    advancedQueries: 0,\n    hoursPerQuery: 0.25,\n  },\n  pro: {\n    monthlyPrice: 9.99,\n    scoutQueries: 500,\n    advancedQueries: 100,\n    hoursPerQuery: 0.5,\n  },\n  enterprise: {\n    monthlyPrice: 49.99,\n    scoutQueries: 999999,\n    advancedQueries: 500,\n    hoursPerQuery: 1,\n  },\n};\n\nexport default function AIROICalculator({ userCurrency, currentTier }: AIROICalculatorProps) {\n  const [queriesPerMonth, setQueriesPerMonth] = useState(50);\n  const [hourlyRate, setHourlyRate] = useState(50);\n\n  const calculations = useMemo(() => {\n    const tier = TIER_DATA[currentTier];\n    const hoursWithoutAI = queriesPerMonth * 0.5;\n    const hoursWithAI = queriesPerMonth * 0.05;\n    const hoursSaved = hoursWithoutAI - hoursWithAI;\n    const moneySaved = hoursSaved * hourlyRate;\n    const netSavings = moneySaved - tier.monthlyPrice;\n    const roi = tier.monthlyPrice > 0 ? ((moneySaved / tier.monthlyPrice) * 100).toFixed(0) : 'Infinite';\n\n    return {\n      hoursWithoutAI,\n      hoursWithAI,\n      hoursSaved,\n      moneySaved,\n      netSavings,\n      roi,\n      monthlyPrice: tier.monthlyPrice,\n    };\n  }, [queriesPerMonth, hourlyRate, currentTier]);\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: userCurrency || 'USD',\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <Card className=\"border-border/40 bg-gradient-to-br from-background to-muted/20\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-primary/10\">\n              <Calculator className=\"w-5 h-5 text-primary\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-lg font-semibold\">AI Value Calculator</CardTitle>\n              <p className=\"text-sm text-muted-foreground mt-0.5\">See how much time and money you save</p>\n            </div>\n          </div>\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            {currentTier.charAt(0).toUpperCase() + currentTier.slice(1)} Plan\n          </Badge>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-8\">\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <label className=\"text-sm font-medium\">Financial questions per month</label>\n              <span className=\"text-sm font-bold text-primary\">{queriesPerMonth}</span>\n            </div>\n            <Slider\n              value={[queriesPerMonth]}\n              onValueChange={(value) => setQueriesPerMonth(value[0])}\n              min={10}\n              max={200}\n              step={10}\n              className=\"w-full\"\n              data-testid=\"slider-queries\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              Budget reviews, spending analysis, investment questions, tax planning...\n            </p>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <label className=\"text-sm font-medium\">Your hourly value</label>\n              <span className=\"text-sm font-bold text-primary\">{formatCurrency(hourlyRate)}/hr</span>\n            </div>\n            <Slider\n              value={[hourlyRate]}\n              onValueChange={(value) => setHourlyRate(value[0])}\n              min={15}\n              max={200}\n              step={5}\n              className=\"w-full\"\n              data-testid=\"slider-hourly-rate\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              What's your time worth? Consider salary or consulting rate.\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n          <div className=\"p-4 rounded-xl bg-white dark:bg-gray-900 border border-border/30 space-y-2\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Clock className=\"w-4 h-4\" />\n              <span className=\"text-xs font-medium\">Time Without AI</span>\n            </div>\n            <div className=\"text-2xl font-bold text-foreground\">\n              {calculations.hoursWithoutAI.toFixed(1)}h\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Research, calculations, analysis</p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-white dark:bg-gray-900 border border-border/30 space-y-2\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Sparkles className=\"w-4 h-4\" />\n              <span className=\"text-xs font-medium\">Time With AI</span>\n            </div>\n            <div className=\"text-2xl font-bold text-green-600\">\n              {calculations.hoursWithAI.toFixed(1)}h\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Quick answers, instant insights</p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200/30 dark:border-green-800/30 space-y-2\">\n            <div className=\"flex items-center gap-2 text-green-600 dark:text-green-400\">\n              <TrendingUp className=\"w-4 h-4\" />\n              <span className=\"text-xs font-medium\">Hours Saved</span>\n            </div>\n            <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n              {calculations.hoursSaved.toFixed(1)}h\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Per month productivity gain</p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-primary/5 border border-primary/20 space-y-2\">\n            <div className=\"flex items-center gap-2 text-primary\">\n              <DollarSign className=\"w-4 h-4\" />\n              <span className=\"text-xs font-medium\">Value Created</span>\n            </div>\n            <div className=\"text-2xl font-bold text-primary\">\n              {formatCurrency(calculations.moneySaved)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Time savings converted to money</p>\n          </div>\n        </div>\n\n        <div className=\"p-6 rounded-xl bg-gradient-to-r from-primary/10 via-primary/5 to-transparent border border-primary/20\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h4 className=\"font-semibold text-foreground\">Your Monthly ROI</h4>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                {calculations.monthlyPrice > 0 \n                  ? `After ${formatCurrency(calculations.monthlyPrice)}/month subscription`\n                  : 'Free plan - no subscription cost'\n                }\n              </p>\n            </div>\n            <div className=\"text-right\">\n              <div className=\"text-3xl font-bold text-primary\">\n                {calculations.monthlyPrice > 0 \n                  ? `${calculations.roi}%`\n                  : formatCurrency(calculations.moneySaved)\n                }\n              </div>\n              {calculations.monthlyPrice > 0 && (\n                <p className=\"text-sm text-green-600 dark:text-green-400 font-medium\">\n                  Net savings: {formatCurrency(calculations.netSavings)}/mo\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8016,"size_tokens":null},"server/ai/tools.ts":{"content":"/**\n * Twealth AI Action Tools\n * \n * Comprehensive set of tools available to all AI models (Scout, Sonnet, GPT-5, Opus)\n * for taking actions in the Twealth financial management app.\n * \n * Categories:\n * 1. Core Actions: create_financial_goal, add_transaction, create_calendar_event, create_group\n * 2. Portfolio & Investment: analyze_portfolio_allocation, compare_financing_options\n * 3. Debt Management: calculate_debt_payoff\n * 4. Projections: project_future_value, calculate_retirement_needs, calculate_net_worth_projection\n * 5. Budgeting: generate_budget_recommendations, suggest_savings_adjustment\n * 6. Risk Management: calculate_emergency_fund, credit_score_improvement_plan\n * 7. Real Estate: calculate_rent_affordability, calculate_mortgage_payment\n * 8. Tax Optimization: optimize_tax_strategy\n * 9. Crypto: add_crypto_holding\n * 10. Luxury Analysis: analyze_luxury_purchase, calculate_affordability\n * 11. Insights: generate_spending_insights, calculate_goal_progress\n * 12. Social: suggest_group_invites\n * 13. Data Collection: save_financial_estimates\n */\n\n/**\n * All available tools for Twealth AI models\n * Compatible with both OpenAI and Anthropic function calling formats\n */\nexport const TWEALTH_AI_TOOLS = [\n  // ========== CORE ACTIONS (User can command these directly) ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"create_financial_goal\",\n      description: \"Create a financial goal IMMEDIATELY when user gives a command with target amount. JUST DO IT - no confirmation needed! Examples that should IMMEDIATELY create goal: 'Set a goal to buy a house for 5 million baht' → call with name='Buy House', targetAmount='5000000', targetDate=next year. 'I want to save $10000 by December' → call immediately. Only ask for details if amount is genuinely missing. For timeline: 'next year' = 1 year from now, 'in 2 years' = 2 years from now. ALWAYS set userConfirmed=true for any imperative command.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"Always set to true for any goal creation command. The user's imperative statement IS their confirmation.\"\n          },\n          name: {\n            type: \"string\",\n            description: \"Short goal name extracted from user request (e.g., 'Buy House', 'Emergency Fund', 'Vacation')\"\n          },\n          targetAmount: {\n            type: \"string\",\n            description: \"Target amount as number string. Convert currencies: 5 million baht = 5000000. Remove currency symbols.\"\n          },\n          targetDate: {\n            type: \"string\",\n            description: \"Target date in YYYY-MM-DD format. Calculate: 'next year' = add 1 year, 'in X months' = add X months to today.\"\n          },\n          description: {\n            type: \"string\",\n            description: \"Brief description of the goal\"\n          }\n        },\n        required: [\"name\", \"targetAmount\", \"targetDate\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"add_transaction\",\n      description: \"Record a transaction when user explicitly states they spent/received money with specific amount. CRITICAL: Call this tool AND simultaneously provide detailed financial insights in natural language (impact on budget, monthly spend comparison, savings rate effect, actionable advice). NEVER just call the tool silently - ALWAYS explain the transaction's financial impact with specific numbers. Use when user says 'I spent $X on Y' or 'I earned $X from Y'.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          type: {\n            type: \"string\",\n            enum: [\"income\", \"expense\"],\n            description: \"Type of transaction\"\n          },\n          amount: {\n            type: \"string\",\n            description: \"Transaction amount in dollars (e.g., '300', '45.50', '$100'). Can include dollar signs and decimals.\"\n          },\n          category: {\n            type: \"string\",\n            description: \"Transaction category (e.g., 'groceries', 'salary', 'entertainment')\"\n          },\n          description: {\n            type: \"string\",\n            description: \"Transaction description\"\n          },\n          date: {\n            type: \"string\",\n            description: \"Transaction date in YYYY-MM-DD format (defaults to today if not specified)\"\n          }\n        },\n        required: [\"type\", \"amount\", \"category\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_calendar_event\",\n      description: \"Create a calendar event IMMEDIATELY when user gives a command. JUST DO IT! Examples: 'Remind me to pay rent next week' → create immediately. Calculate dates: 'next week' = 7 days, 'tomorrow' = 1 day, 'next month' = 30 days.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"Always set to true for any event creation command.\"\n          },\n          title: {\n            type: \"string\",\n            description: \"The event title\"\n          },\n          date: {\n            type: \"string\",\n            description: \"Date in YYYY-MM-DD format. Calculate relative dates from today.\"\n          },\n          description: {\n            type: \"string\",\n            description: \"Event description\"\n          }\n        },\n        required: [\"title\", \"date\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_group\",\n      description: \"Create a group ONLY after user explicitly confirms. CRITICAL: userConfirmed parameter MUST be true. WORKFLOW: (1) User mentions group/collaboration → (2) You explain benefits WITHOUT calling this tool → (3) You ask 'Want me to create this group for you?' → (4) User confirms → (5) THEN call with userConfirmed=true.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          userConfirmed: {\n            type: \"boolean\",\n            description: \"REQUIRED: Must be true. Can ONLY be true when user explicitly confirmed with words like 'yes', 'create it', 'make it', 'sure'. If user just mentioned a group idea without confirming, DON'T call this tool.\"\n          },\n          name: {\n            type: \"string\",\n            description: \"The group name (e.g., 'Family Budget', 'Roommates Expenses')\"\n          },\n          description: {\n            type: \"string\",\n            description: \"What this group is for\"\n          }\n        },\n        required: [\"userConfirmed\", \"name\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"add_crypto_holding\",\n      description: \"Track crypto holding ONLY when user explicitly states a PAST purchase with specific amounts. CRITICAL: Use ONLY for completed transactions like 'I bought 0.5 BTC at $50000' or 'I own 2 ETH purchased at $3000'. DO NOT use for: questions about crypto, future plans, hypothetical scenarios, or educational discussions. For informational queries, just explain in text without calling this tool.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          symbol: {\n            type: \"string\",\n            description: \"Crypto symbol in uppercase (e.g., 'BTC', 'ETH', 'BNB')\"\n          },\n          amount: {\n            type: \"string\",\n            description: \"Amount of cryptocurrency owned (e.g., '0.5', '2', '1.25'). Accepts decimal values.\"\n          },\n          purchasePrice: {\n            type: \"string\",\n            description: \"Purchase price per unit in USD (e.g., '50000', '$3000', '1500.50'). Can include dollar signs.\"\n          }\n        },\n        required: [\"symbol\", \"amount\", \"purchasePrice\"]\n      }\n    }\n  },\n\n  // ========== DATA COLLECTION (Automatically populate user profile) ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"save_financial_estimates\",\n      description: \"Save user's financial estimates when they provide monthly income, monthly expenses, or current savings. Use this IMMEDIATELY when user mentions these numbers to populate their financial profile. Examples: 'I make $5000/month', 'I spend about $3000 monthly', 'I have $10000 saved'. This helps provide better personalized advice.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyIncome: {\n            type: [\"number\", \"string\"],\n            description: \"Estimated monthly income in dollars. Can be number or string like '$5000' or '5000'. Only include if user provided this information.\"\n          },\n          monthlyExpenses: {\n            type: [\"number\", \"string\"],\n            description: \"Estimated monthly expenses in dollars. Can be number or string like '$3000' or '3000'. Only include if user provided this information.\"\n          },\n          currentSavings: {\n            type: [\"number\", \"string\"],\n            description: \"Current total savings/net worth in dollars. Can be number or string like '$10000' or '10000'. Only include if user provided this information.\"\n          }\n        }\n      }\n    }\n  },\n\n  // ========== CALCULATIONS & ANALYSIS (Provide detailed insights) ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_portfolio_allocation\",\n      description: \"Calculate portfolio allocation ONLY when user asks about investment strategy. CRITICAL: After calling this tool, you MUST explain the allocation breakdown with specific dollar amounts, fund recommendations (VTI/VOO/BND), and WHY this allocation works for their age/risk. NEVER just say 'Action completed' - always provide detailed investment advice explaining stocks/bonds/alternatives percentages.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          age: {\n            type: \"number\",\n            description: \"User's age for age-based allocation\"\n          },\n          riskTolerance: {\n            type: \"string\",\n            enum: [\"conservative\", \"moderate\", \"aggressive\"],\n            description: \"Risk tolerance level\"\n          },\n          investmentAmount: {\n            type: \"number\",\n            description: \"Amount to allocate\"\n          }\n        },\n        required: [\"age\", \"riskTolerance\", \"investmentAmount\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_debt_payoff\",\n      description: \"Calculate debt payoff strategies ONLY when user asks about paying off debts. CRITICAL: After calling this tool, you MUST explain BOTH avalanche (highest interest first) and snowball (smallest balance first) methods with total interest saved, payoff timeline, and clear recommendation. NEVER just say 'Action completed' - provide detailed comparison and advice.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          debts: {\n            type: \"array\",\n            description: \"Array of debts with balance and interest rate\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\" },\n                balance: { type: \"number\" },\n                interestRate: { type: \"number\" },\n                minPayment: { type: \"number\" }\n              }\n            }\n          },\n          extraPayment: {\n            type: \"number\",\n            description: \"Extra monthly payment amount available\"\n          }\n        },\n        required: [\"debts\", \"extraPayment\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_emergency_fund\",\n      description: \"Calculate the ideal emergency fund size based on monthly expenses, income stability, and life situation. Provides detailed breakdown of 3-6 months of expenses, risk-adjusted recommendations, and actionable savings plan. Use when user asks 'How much should I keep in my emergency fund?' or mentions emergency savings.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          monthlyExpenses: {\n            type: \"number\",\n            description: \"User's monthly expenses in dollars\"\n          },\n          incomeStability: {\n            type: \"string\",\n            enum: [\"very_stable\", \"stable\", \"variable\", \"unstable\"],\n            description: \"Income stability level. very_stable = salaried government/corporate, stable = salaried private sector, variable = freelance/commission, unstable = gig economy/seasonal\"\n          },\n          dependents: {\n            type: \"number\",\n            description: \"Number of financial dependents (children, elderly parents, etc.)\"\n          },\n          hasInsurance: {\n            type: \"boolean\",\n            description: \"Whether user has health/disability insurance\"\n          }\n        },\n        required: [\"monthlyExpenses\", \"incomeStability\"]\n      }\n    }\n  },\n\n  // ========== ADVANCED DEBT OPTIMIZER ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"optimize_debt_payoff\",\n      description: \"Advanced debt optimizer comparing Avalanche (highest interest first) vs Snowball (smallest balance first) strategies. Calculates detailed payoff schedules, total interest savings, payoff dates, and provides month-by-month breakdown. Use when user wants to optimize debt repayment or asks 'what's the best way to pay off my debt?'\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          debts: {\n            type: \"array\",\n            description: \"Array of debts to optimize\",\n            items: {\n              type: \"object\",\n              properties: {\n                name: { type: \"string\", description: \"Debt name (e.g., 'Credit Card', 'Car Loan')\" },\n                balance: { type: \"number\", description: \"Current balance in dollars\" },\n                interestRate: { type: \"number\", description: \"Annual interest rate as percentage (e.g., 18.9 for 18.9%)\" },\n                minimumPayment: { type: \"number\", description: \"Minimum monthly payment\" }\n              },\n              required: [\"name\", \"balance\", \"interestRate\", \"minimumPayment\"]\n            }\n          },\n          extraMonthlyBudget: {\n            type: \"number\",\n            description: \"Extra money available per month beyond minimum payments\"\n          },\n          includeSchedule: {\n            type: \"boolean\",\n            description: \"Whether to generate detailed month-by-month payoff schedule\"\n          }\n        },\n        required: [\"debts\", \"extraMonthlyBudget\"]\n      }\n    }\n  },\n\n  // ========== INVESTMENT PROJECTOR ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"project_investment_growth\",\n      description: \"Project investment growth with compound interest over time. Calculates future value with multiple scenarios (conservative/moderate/aggressive returns), includes inflation adjustment, and shows year-by-year breakdown. Use when user asks 'how much will my investment grow?' or wants retirement projections.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          initialAmount: {\n            type: \"number\",\n            description: \"Starting investment amount in dollars\"\n          },\n          monthlyContribution: {\n            type: \"number\",\n            description: \"Monthly contribution amount\"\n          },\n          years: {\n            type: \"number\",\n            description: \"Investment time horizon in years\"\n          },\n          expectedReturn: {\n            type: \"number\",\n            description: \"Expected annual return as percentage (e.g., 7 for 7%). If not provided, will show conservative/moderate/aggressive scenarios.\"\n          },\n          includeInflationAdjusted: {\n            type: \"boolean\",\n            description: \"Whether to include inflation-adjusted (real) values assuming 3% inflation\"\n          }\n        },\n        required: [\"initialAmount\", \"monthlyContribution\", \"years\"]\n      }\n    }\n  },\n\n  // ========== WHAT-IF SCENARIO ANALYZER ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_financial_scenario\",\n      description: \"Analyze 'what-if' financial scenarios comparing different choices. Examples: 'Should I pay off debt or invest?', 'Should I buy or rent?', 'Should I lease or buy a car?'. Provides detailed comparison with numbers, ROI, and clear recommendation.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          scenarioType: {\n            type: \"string\",\n            enum: [\"debt_vs_invest\", \"buy_vs_rent\", \"lease_vs_buy\", \"save_vs_spend\", \"early_retire\", \"custom\"],\n            description: \"Type of scenario to analyze\"\n          },\n          scenario1: {\n            type: \"object\",\n            description: \"First option details\",\n            properties: {\n              name: { type: \"string\", description: \"Option name\" },\n              upfrontCost: { type: \"number\", description: \"Initial cost\" },\n              monthlyCost: { type: \"number\", description: \"Monthly cost/payment\" },\n              duration: { type: \"number\", description: \"Duration in months\" },\n              returnRate: { type: \"number\", description: \"Expected return or appreciation rate %\" }\n            }\n          },\n          scenario2: {\n            type: \"object\",\n            description: \"Second option details\",\n            properties: {\n              name: { type: \"string\", description: \"Option name\" },\n              upfrontCost: { type: \"number\", description: \"Initial cost\" },\n              monthlyCost: { type: \"number\", description: \"Monthly cost/payment\" },\n              duration: { type: \"number\", description: \"Duration in months\" },\n              returnRate: { type: \"number\", description: \"Expected return or appreciation rate %\" }\n            }\n          },\n          additionalContext: {\n            type: \"string\",\n            description: \"Additional context about user's situation\"\n          }\n        },\n        required: [\"scenarioType\"]\n      }\n    }\n  },\n\n  // ========== REAL-TIME MARKET DATA ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"get_stock_price\",\n      description: \"Get real-time stock price and key metrics for any publicly traded company. Use when user asks about stock prices, market performance, or wants to analyze a specific stock. Returns current price, daily change, 52-week range, market cap, and P/E ratio.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          symbol: {\n            type: \"string\",\n            description: \"Stock ticker symbol (e.g., 'AAPL', 'GOOGL', 'TSLA')\"\n          },\n          includeAnalysis: {\n            type: \"boolean\",\n            description: \"Whether to include brief analysis and key metrics\"\n          }\n        },\n        required: [\"symbol\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"get_crypto_price\",\n      description: \"Get real-time cryptocurrency price and market data. Use when user asks about Bitcoin, Ethereum, or other crypto prices. Returns current price in USD, 24h change, market cap, and trading volume.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          symbol: {\n            type: \"string\",\n            description: \"Crypto symbol (e.g., 'BTC', 'ETH', 'BNB', 'SOL', 'XRP')\"\n          },\n          includeTrend: {\n            type: \"boolean\",\n            description: \"Whether to include 7-day and 30-day price trends\"\n          }\n        },\n        required: [\"symbol\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"get_forex_rate\",\n      description: \"Get current exchange rate between two currencies. Use when user asks about currency conversion or forex rates. Returns current rate, daily change, and conversion calculator.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          fromCurrency: {\n            type: \"string\",\n            description: \"Source currency code (e.g., 'USD', 'EUR', 'THB', 'GBP')\"\n          },\n          toCurrency: {\n            type: \"string\",\n            description: \"Target currency code\"\n          },\n          amount: {\n            type: \"number\",\n            description: \"Optional amount to convert\"\n          }\n        },\n        required: [\"fromCurrency\", \"toCurrency\"]\n      }\n    }\n  },\n\n  // ========== FINANCIAL HEALTH ASSESSMENT ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"assess_financial_health\",\n      description: \"Generate comprehensive financial health assessment based on user's data. Calculates health score (0-100), identifies strengths and weaknesses, and provides prioritized action items. Use when user asks 'how am I doing financially?' or wants a financial checkup.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          includeDetailedBreakdown: {\n            type: \"boolean\",\n            description: \"Whether to include detailed breakdown of each health metric\"\n          },\n          focusArea: {\n            type: \"string\",\n            enum: [\"overall\", \"savings\", \"debt\", \"investing\", \"emergency_fund\", \"goals\"],\n            description: \"Specific area to focus assessment on\"\n          }\n        }\n      }\n    }\n  },\n\n  // ========== SPENDING PATTERN ANALYZER ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_spending_patterns\",\n      description: \"Deep analysis of user's spending patterns over time. Identifies trends, anomalies, recurring expenses, and opportunities to save. Use when user asks 'where is my money going?' or wants spending insights.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          timeframe: {\n            type: \"string\",\n            enum: [\"last_month\", \"last_3_months\", \"last_6_months\", \"last_year\"],\n            description: \"Time period to analyze\"\n          },\n          focusCategory: {\n            type: \"string\",\n            description: \"Specific category to deep-dive (e.g., 'dining', 'entertainment', 'shopping')\"\n          },\n          compareToAverage: {\n            type: \"boolean\",\n            description: \"Whether to compare spending to national/regional averages\"\n          }\n        }\n      }\n    }\n  },\n\n  // ========== TAX OPTIMIZATION ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_tax_optimization\",\n      description: \"Calculate tax optimization strategies including retirement contributions, deductions, and tax-efficient investment strategies. Estimates potential tax savings and provides actionable recommendations.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          annualIncome: {\n            type: \"number\",\n            description: \"Annual gross income in dollars\"\n          },\n          filingStatus: {\n            type: \"string\",\n            enum: [\"single\", \"married_filing_jointly\", \"married_filing_separately\", \"head_of_household\"],\n            description: \"Tax filing status\"\n          },\n          currentRetirementContribution: {\n            type: \"number\",\n            description: \"Current annual retirement contribution (401k/IRA)\"\n          },\n          hasHSA: {\n            type: \"boolean\",\n            description: \"Whether user has access to HSA\"\n          },\n          state: {\n            type: \"string\",\n            description: \"State of residence (for state tax considerations)\"\n          }\n        },\n        required: [\"annualIncome\", \"filingStatus\"]\n      }\n    }\n  },\n\n  // ========== RETIREMENT READINESS ==========\n  {\n    type: \"function\",\n    function: {\n      name: \"calculate_retirement_readiness\",\n      description: \"Comprehensive retirement readiness calculator. Determines if user is on track for retirement, calculates required savings rate, and projects retirement income. Uses 4% rule and Monte Carlo simulation for accuracy.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          currentAge: {\n            type: \"number\",\n            description: \"Current age\"\n          },\n          targetRetirementAge: {\n            type: \"number\",\n            description: \"Desired retirement age\"\n          },\n          currentSavings: {\n            type: \"number\",\n            description: \"Current retirement savings (401k, IRA, etc.)\"\n          },\n          monthlyContribution: {\n            type: \"number\",\n            description: \"Current monthly retirement contribution\"\n          },\n          desiredMonthlyIncome: {\n            type: \"number\",\n            description: \"Desired monthly income in retirement (in today's dollars)\"\n          },\n          expectedSocialSecurity: {\n            type: \"number\",\n            description: \"Expected monthly Social Security benefit (optional)\"\n          }\n        },\n        required: [\"currentAge\", \"targetRetirementAge\", \"currentSavings\", \"monthlyContribution\"]\n      }\n    }\n  }\n];\n\n/**\n * Get tools array for AI model function calling\n * Returns tool definitions in the format expected by OpenAI/Anthropic APIs\n */\nexport function getTwealthTools(): typeof TWEALTH_AI_TOOLS {\n  return TWEALTH_AI_TOOLS;\n}\n\n/**\n * Get Twealth app feature list for AI identity/branding\n * Used in system prompts to help AI answer \"what can Twealth do?\"\n */\nexport function getTwealthFeatureList(): string {\n  return `\n**TWEALTH AI - YOUR CFO-LEVEL FINANCIAL ADVISOR**\n\n🎯 Core Actions:\n- Create & track financial goals with smart progress monitoring\n- Record transactions with intelligent auto-categorization\n- Set reminders for bills, payments, and financial events\n- Create groups for family/roommate shared budgeting\n- Track cryptocurrency holdings with real-time pricing\n\n📊 Proactive Insights (AI automatically detects):\n- Spending spikes and category anomalies\n- Goals at risk of missing deadlines\n- Emergency fund gaps\n- Debt payoff opportunities\n- Achievement milestones (savings rate, net worth)\n\n💰 Advanced Financial Planning:\n- Debt optimizer: Avalanche vs Snowball with month-by-month schedules\n- Investment projector: Multi-scenario compound growth calculations\n- Retirement readiness: Monte Carlo simulation, 4% rule analysis\n- Tax optimization: Contribution strategies, deduction maximization\n- What-if scenarios: Rent vs Buy, Lease vs Own, Debt vs Invest\n\n📈 Real-Time Market Intelligence:\n- Stock prices with key metrics (P/E, market cap, 52-week range)\n- Crypto prices with 24h/7d/30d trends\n- Forex rates with live conversion\n- Market context for investment decisions\n\n🏦 Financial Health Assessment:\n- Comprehensive health score (0-100)\n- Savings rate analysis\n- Debt-to-income ratio tracking\n- Emergency fund months calculation\n- Net worth tracking and projections\n\n🔍 Spending Pattern Analysis:\n- Month-over-month trend detection\n- Category breakdown with percentages\n- Anomaly detection (unusual spending)\n- Personalized savings recommendations\n`.trim();\n}\n\n/**\n * Get Twealth identity section for system prompts\n * Used to brand all AI models as \"Twealth AI\"\n */\nexport function getTwealthIdentity(): string {\n  return `\nYou are **Twealth AI**, the most advanced AI financial advisor - a CFO-level intelligence that helps users master their finances with data-driven insights and proactive guidance.\n\n${getTwealthFeatureList()}\n\n**Your Intelligence Level:**\nYou are powered by a 4-model hybrid AI system that automatically selects the best model for each task:\n- 🚀 Scout (Llama 4): Lightning-fast for quick questions and daily tasks\n- 🧠 Sonnet (Claude): Deep reasoning for investment strategy and debt optimization\n- 📐 GPT-5: Advanced math for projections, simulations, and compound calculations\n- 👔 Opus (Claude): CFO-level analysis for major financial decisions\n\n**When users ask \"what can Twealth do?\" or \"what are you?\":**\n- Introduce yourself: \"I'm Twealth AI - your personal CFO powered by 4 AI models\"\n- Highlight: \"I proactively analyze your finances and alert you to opportunities and risks\"\n- Emphasize: \"I can take actions - create goals, log transactions, calculate projections, and more\"\n- Mention: \"I have access to real-time market data for stocks, crypto, and forex\"\n\n**Your Tone:**\n- Expert but approachable - like having a brilliant CFO friend who genuinely cares\n- Proactive - don't wait to be asked, offer insights based on the user's data\n- Data-obsessed - always provide specific numbers, percentages, and calculations\n- Action-oriented - use tools to help users achieve goals, don't just give advice\n- Contextually aware - reference the user's actual financial situation in responses\n\n**Proactive Behavior:**\n- When you see concerning data (high spending, goals at risk), mention it naturally\n- Suggest next steps after every interaction (\"Would you like me to...\")\n- Use the user's analytics data to personalize every response\n- Celebrate wins (savings milestones, debt payoffs, goals achieved)\n`.trim();\n}\n","path":null,"size_bytes":28589,"size_tokens":null},"server/playbookService.ts":{"content":"/**\n * AI Playbooks Service\n * \n * Generates weekly financial reports with:\n * - Financial Pulse score (0-100 health rating)\n * - AI-powered insights (personalized observations)\n * - Action queue (prioritized recommendations)\n * - ROI tracking (savings identified vs implemented)\n * \n * Uses hybrid AI system (Scout/Sonnet/GPT-5/Opus) based on user's tier\n */\n\nimport type { IStorage } from './storage';\nimport { generateHybridAdvice } from './ai/hybridAIService';\nimport type { ModelAccess } from './ai/hybridAIService';\nimport type { InsertPlaybook } from '@shared/schema';\n\ninterface PlaybookInsight {\n  text: string;\n  tag: string; // \"spending\", \"saving\", \"goal\", \"budget\", \"investment\"\n  severity: \"high\" | \"medium\" | \"low\";\n}\n\ninterface PlaybookAction {\n  title: string;\n  description: string;\n  effort: \"low\" | \"medium\" | \"high\";\n  impact: \"low\" | \"medium\" | \"high\";\n  deepLink: string; // Route to relevant page\n}\n\n/**\n * Calculate financial health score (0-100) based on multiple factors\n */\nexport async function calculateFinancialHealthScore(\n  userId: string,\n  storage: IStorage\n): Promise<{ score: number; components: Record<string, number> }> {\n  // Get user's financial data - fetch all in parallel for efficiency\n  const [transactions, goals, budgets, profile, prefs, debts] = await Promise.all([\n    storage.getTransactionsByUserId(userId, 90), // Last 90 days\n    storage.getFinancialGoalsByUserId(userId),\n    storage.getBudgetsByUserId(userId),\n    storage.getUserFinancialProfile(userId),\n    storage.getUserPreferences(userId),\n    storage.getUserDebts(userId), // Moved to parallel for performance\n  ]);\n\n  // Component 1: Savings Rate (30 points)\n  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n  const recentTransactions = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);\n  const income = recentTransactions\n    .filter(t => t.type === 'income')\n    .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n  const expenses = recentTransactions\n    .filter(t => t.type === 'expense')\n    .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n  const savingsRate = income > 0 ? ((income - expenses) / income) * 100 : 0;\n  const savingsScore = Math.min((savingsRate / 20) * 30, 30); // 20%+ savings = full 30 points\n\n  // Component 2: Emergency Fund Coverage (25 points)\n  const monthlySavingsEstimate = parseFloat(prefs?.currentSavingsEstimate?.toString() || '0');\n  const monthlyExpenseEstimate = parseFloat(prefs?.monthlyExpensesEstimate?.toString() || '0');\n  const emergencyMonths = monthlyExpenseEstimate > 0 \n    ? monthlySavingsEstimate / monthlyExpenseEstimate \n    : 0;\n  const emergencyScore = Math.min((emergencyMonths / 6) * 25, 25); // 6 months = full 25 points\n\n  // Component 3: Goal Progress (20 points)\n  const activeGoals = goals.filter(g => g.status === 'active');\n  const goalProgress = activeGoals.length > 0\n    ? activeGoals.reduce((avg, g) => {\n        const current = parseFloat(g.currentAmount || '0');\n        const target = parseFloat(g.targetAmount.toString());\n        return avg + (current / target) * 100;\n      }, 0) / activeGoals.length\n    : 0;\n  const goalScore = (goalProgress / 100) * 20;\n\n  // Component 4: Budget Adherence (15 points)\n  const budgetAdherence = budgets.length > 0\n    ? budgets.reduce((avg, b) => {\n        const spent = recentTransactions\n          .filter(t => t.category === b.category && t.type === 'expense')\n          .reduce((sum, t) => sum + parseFloat(t.amount.toString()), 0);\n        const limit = parseFloat(b.monthlyLimit.toString());\n        const adherence = limit > 0 ? Math.max(0, (1 - (spent / limit)) * 100) : 0;\n        return avg + adherence;\n      }, 0) / budgets.length\n    : 50; // Neutral score if no budgets\n  const budgetScore = (budgetAdherence / 100) * 15;\n\n  // Component 5: Debt Management (10 points)\n  // debts already fetched in parallel above\n  const totalDebt = debts.reduce((sum, d) => {\n    const remaining = d.originalAmount ? parseFloat(d.originalAmount.toString()) : 0;\n    return sum + remaining;\n  }, 0);\n  const monthlyIncomeEstimate = parseFloat(prefs?.monthlyIncomeEstimate?.toString() || '0');\n  const debtToIncome = monthlyIncomeEstimate > 0 ? (totalDebt / (monthlyIncomeEstimate * 12)) : 0;\n  const debtScore = Math.max(0, 10 - (debtToIncome * 10)); // Lower debt = higher score\n\n  const finalScore = Math.round(\n    savingsScore + emergencyScore + goalScore + budgetScore + debtScore\n  );\n\n  return {\n    score: Math.min(100, Math.max(0, finalScore)),\n    components: {\n      savingsRate: Math.round(savingsScore),\n      emergencyFund: Math.round(emergencyScore),\n      goalProgress: Math.round(goalScore),\n      budgetAdherence: Math.round(budgetScore),\n      debtManagement: Math.round(debtScore),\n    },\n  };\n}\n\n/**\n * Generate weekly AI financial playbook\n */\nexport async function generateWeeklyPlaybook(\n  userId: string,\n  storage: IStorage,\n  tier: 'free' | 'pro' | 'enterprise'\n): Promise<InsertPlaybook> {\n  // Calculate week boundaries (Monday to Sunday)\n  const now = new Date();\n  const dayOfWeek = now.getDay();\n  const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n  const weekStartDate = new Date(now);\n  weekStartDate.setDate(now.getDate() + daysToMonday);\n  weekStartDate.setHours(0, 0, 0, 0);\n  \n  const weekEndDate = new Date(weekStartDate);\n  weekEndDate.setDate(weekStartDate.getDate() + 6);\n  weekEndDate.setHours(23, 59, 59, 999);\n\n  // Get last week's playbook for delta calculation\n  const existingPlaybooks = await storage.getPlaybooksByUserId(userId, 2);\n  const lastPlaybook = existingPlaybooks.length > 0 ? existingPlaybooks[0] : null;\n\n  // Calculate current financial health score\n  const { score: financialHealthScore, components} = await calculateFinancialHealthScore(userId, storage);\n  const scoreDelta = lastPlaybook \n    ? financialHealthScore - lastPlaybook.financialHealthScore \n    : 0;\n  \n  const confidenceBand: \"improving\" | \"stable\" | \"declining\" = \n    scoreDelta > 5 ? \"improving\" :\n    scoreDelta < -5 ? \"declining\" : \"stable\";\n\n  // Determine AI model based on tier\n  const modelToUse: ModelAccess = \n    tier === 'enterprise' ? 'opus' : // CFO-level for Enterprise\n    tier === 'pro' ? 'sonnet' : // Smart reasoning for Pro\n    'scout'; // Fast for Free\n\n  // Generate insights using AI\n  const insightsCount = tier === 'enterprise' ? 7 : tier === 'pro' ? 5 : 2;\n  \n  // Use simpler plain text prompt to avoid tool-calling issues with Scout/Llama\n  const insightsPrompt = `You are a financial analyst. Analyze this user's financial data and provide ${insightsCount} key insights.\n\nFinancial Health Score: ${financialHealthScore}/100 (${confidenceBand})\nScore Components:\n- Savings Rate: ${components.savingsRate}/30\n- Emergency Fund: ${components.emergencyFund}/25\n- Goal Progress: ${components.goalProgress}/20\n- Budget Adherence: ${components.budgetAdherence}/15\n- Debt Management: ${components.debtManagement}/10\n\nRespond with ONLY a valid JSON array. No other text before or after.\nEach object must have exactly these fields:\n- \"text\": a short insight sentence\n- \"tag\": EXACTLY ONE of these words: spending, saving, goal, budget, investment (pick the single most relevant one)\n- \"severity\": EXACTLY ONE of: high, medium, low\n\nExample format:\n[{\"text\": \"Your savings rate is strong at 20%.\", \"tag\": \"saving\", \"severity\": \"low\"}]\n\nProvide ${insightsCount} insights focused on actionable observations.`;\n\n  let insights: PlaybookInsight[] = [];\n  let totalTokensUsed = 0;\n  \n  try {\n    const aiResponse = await generateHybridAdvice(\n      userId,\n      insightsPrompt,\n      storage,\n      { forceModel: modelToUse, skipTools: true }\n    );\n    \n    totalTokensUsed += (aiResponse.tokensIn || 0) + (aiResponse.tokensOut || 0);\n\n    // Parse insights from AI response\n    const jsonMatch = aiResponse.answer.match(/\\[[\\s\\S]*\\]/);\n    if (jsonMatch) {\n      const parsed = JSON.parse(jsonMatch[0]);\n      // Validate and sanitize each insight\n      insights = parsed.map((item: any) => {\n        // Normalize tag - take first word if pipe-separated\n        let tag = String(item.tag || 'goal').toLowerCase().trim();\n        if (tag.includes('|')) tag = tag.split('|')[0].trim();\n        if (!['spending', 'saving', 'goal', 'budget', 'investment'].includes(tag)) tag = 'goal';\n        \n        // Normalize severity\n        let severity = String(item.severity || 'medium').toLowerCase().trim();\n        if (!['high', 'medium', 'low'].includes(severity)) severity = 'medium';\n        \n        return {\n          text: String(item.text || 'Financial insight'),\n          tag,\n          severity: severity as 'high' | 'medium' | 'low',\n        };\n      }).slice(0, insightsCount);\n    }\n  } catch (error) {\n    // AI call failed - use intelligent fallback insights based on actual scores\n    console.log('Playbook insights AI failed, using fallback:', error);\n  }\n  \n  // Ensure we always have insights (fallback if AI fails or returns empty)\n  if (insights.length === 0) {\n    insights = generateFallbackInsights(components, confidenceBand, scoreDelta, insightsCount);\n  }\n\n  // Generate actions using AI\n  const weakestAreas = Object.entries(components)\n    .sort(([, a], [, b]) => a - b)\n    .slice(0, 2)\n    .map(([key]) => key)\n    .join(', ');\n\n  const actionsPrompt = `You are a financial advisor. Based on this analysis, recommend 3 priority actions.\n\nScore: ${financialHealthScore}/100\nWeakest Areas: ${weakestAreas}\n\nRespond with ONLY a valid JSON array. No other text.\nEach object must have exactly these fields:\n- \"title\": short action title (3-5 words)\n- \"description\": why and how (1-2 sentences)\n- \"effort\": EXACTLY ONE of: low, medium, high\n- \"impact\": EXACTLY ONE of: low, medium, high\n- \"deepLink\": one of these routes: /money-tracking, /financial-goals, /investments, /crypto, /settings\n\nExample:\n[{\"title\": \"Review budget limits\", \"description\": \"Check if spending categories match your goals.\", \"effort\": \"low\", \"impact\": \"medium\", \"deepLink\": \"/money-tracking\"}]\n\nProvide exactly 3 actions.`;\n\n  let actions: PlaybookAction[] = [];\n  \n  try {\n    const actionsResponse = await generateHybridAdvice(\n      userId,\n      actionsPrompt,\n      storage,\n      { forceModel: modelToUse, skipTools: true }\n    );\n    \n    totalTokensUsed += (actionsResponse.tokensIn || 0) + (actionsResponse.tokensOut || 0);\n\n    const jsonMatch = actionsResponse.answer.match(/\\[[\\s\\S]*\\]/);\n    if (jsonMatch) {\n      const parsed = JSON.parse(jsonMatch[0]);\n      // Validate and sanitize each action\n      actions = parsed.map((item: any) => {\n        let effort = String(item.effort || 'medium').toLowerCase().trim();\n        if (!['low', 'medium', 'high'].includes(effort)) effort = 'medium';\n        \n        let impact = String(item.impact || 'medium').toLowerCase().trim();\n        if (!['low', 'medium', 'high'].includes(impact)) impact = 'medium';\n        \n        let deepLink = String(item.deepLink || '/money-tracking');\n        if (!deepLink.startsWith('/')) deepLink = '/money-tracking';\n        \n        return {\n          title: String(item.title || 'Take action').substring(0, 50),\n          description: String(item.description || 'Improve your finances').substring(0, 200),\n          effort: effort as 'low' | 'medium' | 'high',\n          impact: impact as 'low' | 'medium' | 'high',\n          deepLink,\n        };\n      }).slice(0, 3);\n    }\n  } catch (error) {\n    console.log('Playbook actions AI failed, using fallback:', error);\n  }\n  \n  // Ensure we always have actions (fallback if AI fails)\n  if (actions.length === 0) {\n    actions = generateFallbackActions(components, weakestAreas);\n  }\n\n  // Calculate ROI (simplified for MVP - can be enhanced later)\n  const roiSavings = \"0.00\"; // Will be updated as users complete actions\n  const cumulativeRoi = lastPlaybook && lastPlaybook.cumulativeRoi\n    ? (parseFloat(lastPlaybook.cumulativeRoi.toString())).toFixed(2)\n    : \"0.00\";\n\n  const playbook: InsertPlaybook = {\n    userId,\n    subscriptionId: null, // Will be set by caller if available\n    weekStartDate,\n    weekEndDate,\n    financialHealthScore,\n    scoreDelta,\n    confidenceBand,\n    insights: insights as any, // JSONB type\n    insightsCount,\n    actions: actions as any, // JSONB type\n    actionsCount: 3,\n    roiSavings,\n    cumulativeRoi,\n    forecastLift: scoreDelta > 0 ? `+${scoreDelta}% health improvement this week` : null,\n    tier,\n    generatedBy: modelToUse,\n    generationTimeMs: Math.round(Date.now() - now.getTime()),\n    tokensUsed: totalTokensUsed,\n  };\n\n  return playbook;\n}\n\n/**\n * Generate fallback insights when AI fails\n */\nfunction generateFallbackInsights(\n  components: Record<string, number>,\n  confidenceBand: string,\n  scoreDelta: number,\n  count: number\n): PlaybookInsight[] {\n  const insights: PlaybookInsight[] = [];\n  \n  // Savings insight\n  if (components.savingsRate < 15) {\n    insights.push({\n      text: \"Your savings rate could use improvement. Consider setting aside at least 20% of your income.\",\n      tag: \"saving\",\n      severity: \"high\"\n    });\n  } else if (components.savingsRate >= 25) {\n    insights.push({\n      text: \"Your savings rate is strong. Keep up the good work building your financial cushion.\",\n      tag: \"saving\",\n      severity: \"low\"\n    });\n  }\n  \n  // Emergency fund insight\n  if (components.emergencyFund < 10) {\n    insights.push({\n      text: \"Building an emergency fund should be a priority. Aim for 3-6 months of expenses.\",\n      tag: \"saving\",\n      severity: \"high\"\n    });\n  }\n  \n  // Budget insight\n  if (components.budgetAdherence < 10) {\n    insights.push({\n      text: \"Your spending is exceeding budget limits in some categories. Review and adjust your budgets.\",\n      tag: \"budget\",\n      severity: \"medium\"\n    });\n  } else if (components.budgetAdherence >= 12) {\n    insights.push({\n      text: \"You're staying within your budget limits. Great financial discipline.\",\n      tag: \"budget\",\n      severity: \"low\"\n    });\n  }\n  \n  // Goal progress insight\n  if (components.goalProgress < 10) {\n    insights.push({\n      text: \"Your financial goals need attention. Consider making regular contributions toward them.\",\n      tag: \"goal\",\n      severity: \"medium\"\n    });\n  }\n  \n  // Debt insight\n  if (components.debtManagement >= 8) {\n    insights.push({\n      text: \"Your debt management is excellent. Focus on maintaining this healthy balance.\",\n      tag: \"spending\",\n      severity: \"low\"\n    });\n  }\n  \n  // Trend insight\n  if (scoreDelta > 5) {\n    insights.push({\n      text: \"Your financial health is improving. The positive trend shows your efforts are paying off.\",\n      tag: \"goal\",\n      severity: \"low\"\n    });\n  } else if (scoreDelta < -5) {\n    insights.push({\n      text: \"Your financial health has declined this week. Review recent spending patterns.\",\n      tag: \"spending\",\n      severity: \"high\"\n    });\n  }\n  \n  // Ensure we have at least the requested count\n  while (insights.length < count) {\n    insights.push({\n      text: `Your financial health is ${confidenceBand}. Continue monitoring your progress.`,\n      tag: \"goal\",\n      severity: \"medium\"\n    });\n  }\n  \n  return insights.slice(0, count);\n}\n\n/**\n * Generate fallback actions when AI fails\n */\nfunction generateFallbackActions(\n  components: Record<string, number>,\n  weakestAreas: string\n): PlaybookAction[] {\n  const actions: PlaybookAction[] = [];\n  \n  // Always useful actions based on weakest areas\n  if (weakestAreas.includes('savingsRate') || weakestAreas.includes('emergencyFund')) {\n    actions.push({\n      title: \"Set up automatic savings\",\n      description: \"Automate transfers to a savings account to build your emergency fund consistently.\",\n      effort: \"low\",\n      impact: \"high\",\n      deepLink: \"/money-tracking\"\n    });\n  }\n  \n  if (weakestAreas.includes('budgetAdherence')) {\n    actions.push({\n      title: \"Review budget categories\",\n      description: \"Check which categories are over budget and adjust limits or reduce spending.\",\n      effort: \"low\",\n      impact: \"medium\",\n      deepLink: \"/money-tracking\"\n    });\n  }\n  \n  if (weakestAreas.includes('goalProgress')) {\n    actions.push({\n      title: \"Update financial goals\",\n      description: \"Review your goals and make a contribution toward your highest priority target.\",\n      effort: \"medium\",\n      impact: \"high\",\n      deepLink: \"/financial-goals\"\n    });\n  }\n  \n  // Default actions if we don't have enough\n  const defaultActions: PlaybookAction[] = [\n    {\n      title: \"Log recent transactions\",\n      description: \"Keep your financial picture accurate by recording this week's expenses.\",\n      effort: \"low\",\n      impact: \"medium\",\n      deepLink: \"/money-tracking\"\n    },\n    {\n      title: \"Review investment portfolio\",\n      description: \"Check your investment allocations and consider rebalancing if needed.\",\n      effort: \"medium\",\n      impact: \"medium\",\n      deepLink: \"/investments\"\n    },\n    {\n      title: \"Set a new savings goal\",\n      description: \"Define a specific financial target to work toward in the coming months.\",\n      effort: \"low\",\n      impact: \"high\",\n      deepLink: \"/financial-goals\"\n    }\n  ];\n  \n  // Fill up to 3 actions\n  for (const action of defaultActions) {\n    if (actions.length >= 3) break;\n    if (!actions.some(a => a.deepLink === action.deepLink)) {\n      actions.push(action);\n    }\n  }\n  \n  return actions.slice(0, 3);\n}\n\n/**\n * Mark a playbook action as completed and update ROI\n */\nexport async function completePlaybookAction(\n  playbookId: string,\n  actionIndex: number,\n  estimatedSavings: number,\n  storage: IStorage\n): Promise<void> {\n  const playbook = await storage.getPlaybook(playbookId);\n  if (!playbook) {\n    throw new Error('Playbook not found');\n  }\n\n  // Check for duplicate completion\n  const completedIndices = (playbook.completedActionIndices as number[]) || [];\n  if (completedIndices.includes(actionIndex)) {\n    throw new Error('Action already completed');\n  }\n\n  // Update playbook with completed action\n  const newActionsCompleted = (playbook.actionsCompleted || 0) + 1;\n  const newRoiSavings = parseFloat(playbook.roiSavings?.toString() || '0') + estimatedSavings;\n  const newCumulativeRoi = parseFloat(playbook.cumulativeRoi?.toString() || '0') + estimatedSavings;\n  const newCompletedIndices = [...completedIndices, actionIndex];\n\n  await storage.updatePlaybook(playbookId, {\n    actionsCompleted: newActionsCompleted,\n    roiSavings: newRoiSavings.toFixed(2),\n    cumulativeRoi: newCumulativeRoi.toFixed(2),\n    completedActionIndices: newCompletedIndices,\n  });\n}\n","path":null,"size_bytes":18580,"size_tokens":null},"server/services/countryKnowledge.ts":{"content":"/**\n * CountryKnowledge Service\n * \n * Provides country-specific financial intelligence for AI context:\n * - Tax rates (income tax, VAT/sales tax, capital gains)\n * - Cost of living indices\n * - Currency and exchange rate context\n * - Regional pricing for luxury goods (cars, real estate)\n * - Local financial regulations awareness\n */\n\nexport interface CountryFinancialContext {\n  countryCode: string;\n  countryName: string;\n  currency: string;\n  currencySymbol: string;\n  \n  // Tax Information\n  incomeTaxBrackets: TaxBracket[];\n  vatRate: number; // As decimal (e.g., 0.20 for 20%)\n  capitalGainsTaxRate: number;\n  corporateTaxRate: number;\n  \n  // Cost of Living\n  costOfLivingIndex: number; // NYC = 100 as baseline\n  rentIndex: number;\n  groceriesIndex: number;\n  \n  // Purchasing Power\n  purchasingPowerIndex: number;\n  averageMonthlyIncome: number; // In local currency\n  medianMonthlyIncome: number;\n  \n  // Luxury Goods Pricing (in local currency)\n  luxuryPricing: {\n    lamborghiniUrus: number;\n    lamborghiniHuracan: number;\n    porsche911: number;\n    rolexSubmariner: number;\n    medianHomePriceCity: number;\n    medianHomePriceSuburb: number;\n  };\n  \n  // Regional Context\n  region: 'north_america' | 'europe' | 'asia_pacific' | 'latin_america' | 'middle_east' | 'africa';\n  economicSystem: 'developed' | 'developing' | 'emerging';\n  financialRegulations: string[];\n  \n  // Last updated timestamp\n  lastUpdated: string;\n}\n\nexport interface TaxBracket {\n  minIncome: number;\n  maxIncome: number | null; // null = no upper limit\n  rate: number; // As decimal (e.g., 0.25 for 25%)\n}\n\n// Comprehensive country data for 195+ countries\n// Data sourced from: World Bank, OECD, IMF, Tax Foundation, Numbeo\nconst COUNTRY_DATA: Record<string, CountryFinancialContext> = {\n  // North America\n  US: {\n    countryCode: 'US',\n    countryName: 'United States',\n    currency: 'USD',\n    currencySymbol: '$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 11600, rate: 0.10 },\n      { minIncome: 11600, maxIncome: 47150, rate: 0.12 },\n      { minIncome: 47150, maxIncome: 100525, rate: 0.22 },\n      { minIncome: 100525, maxIncome: 191950, rate: 0.24 },\n      { minIncome: 191950, maxIncome: 243725, rate: 0.32 },\n      { minIncome: 243725, maxIncome: 609350, rate: 0.35 },\n      { minIncome: 609350, maxIncome: null, rate: 0.37 },\n    ],\n    vatRate: 0, // No federal VAT, states have sales tax 0-10%\n    capitalGainsTaxRate: 0.20, // Long-term (short-term taxed as income)\n    corporateTaxRate: 0.21,\n    costOfLivingIndex: 100,\n    rentIndex: 100,\n    groceriesIndex: 100,\n    purchasingPowerIndex: 100,\n    averageMonthlyIncome: 6228,\n    medianMonthlyIncome: 4500,\n    luxuryPricing: {\n      lamborghiniUrus: 240000,\n      lamborghiniHuracan: 275000,\n      porsche911: 120000,\n      rolexSubmariner: 10000,\n      medianHomePriceCity: 450000,\n      medianHomePriceSuburb: 350000,\n    },\n    region: 'north_america',\n    economicSystem: 'developed',\n    financialRegulations: ['SEC regulated', 'FDIC insured banking', 'IRS tax filing required'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  CA: {\n    countryCode: 'CA',\n    countryName: 'Canada',\n    currency: 'CAD',\n    currencySymbol: 'C$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 55867, rate: 0.15 },\n      { minIncome: 55867, maxIncome: 111733, rate: 0.205 },\n      { minIncome: 111733, maxIncome: 173205, rate: 0.26 },\n      { minIncome: 173205, maxIncome: 246752, rate: 0.29 },\n      { minIncome: 246752, maxIncome: null, rate: 0.33 },\n    ],\n    vatRate: 0.05, // Federal GST (provinces add more)\n    capitalGainsTaxRate: 0.25, // 50% of gains taxed at income rate\n    corporateTaxRate: 0.15,\n    costOfLivingIndex: 72,\n    rentIndex: 55,\n    groceriesIndex: 85,\n    purchasingPowerIndex: 85,\n    averageMonthlyIncome: 5500,\n    medianMonthlyIncome: 4200,\n    luxuryPricing: {\n      lamborghiniUrus: 290000,\n      lamborghiniHuracan: 330000,\n      porsche911: 145000,\n      rolexSubmariner: 13500,\n      medianHomePriceCity: 800000,\n      medianHomePriceSuburb: 550000,\n    },\n    region: 'north_america',\n    economicSystem: 'developed',\n    financialRegulations: ['CRA tax filing', 'CDIC insured banking', 'TFSA/RRSP tax-advantaged accounts'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  MX: {\n    countryCode: 'MX',\n    countryName: 'Mexico',\n    currency: 'MXN',\n    currencySymbol: '$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 7735, rate: 0.0192 },\n      { minIncome: 7735, maxIncome: 65651, rate: 0.064 },\n      { minIncome: 65651, maxIncome: 115375, rate: 0.1088 },\n      { minIncome: 115375, maxIncome: 134119, rate: 0.16 },\n      { minIncome: 134119, maxIncome: 160577, rate: 0.1792 },\n      { minIncome: 160577, maxIncome: 323862, rate: 0.2136 },\n      { minIncome: 323862, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.16,\n    capitalGainsTaxRate: 0.10,\n    corporateTaxRate: 0.30,\n    costOfLivingIndex: 35,\n    rentIndex: 18,\n    groceriesIndex: 40,\n    purchasingPowerIndex: 38,\n    averageMonthlyIncome: 15000,\n    medianMonthlyIncome: 9000,\n    luxuryPricing: {\n      lamborghiniUrus: 6800000,\n      lamborghiniHuracan: 7500000,\n      porsche911: 2800000,\n      rolexSubmariner: 210000,\n      medianHomePriceCity: 4500000,\n      medianHomePriceSuburb: 2500000,\n    },\n    region: 'latin_america',\n    economicSystem: 'emerging',\n    financialRegulations: ['SAT tax authority', 'AFORE retirement system', 'Import duties on luxury goods'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Europe\n  GB: {\n    countryCode: 'GB',\n    countryName: 'United Kingdom',\n    currency: 'GBP',\n    currencySymbol: '£',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 12570, rate: 0 },\n      { minIncome: 12570, maxIncome: 50270, rate: 0.20 },\n      { minIncome: 50270, maxIncome: 125140, rate: 0.40 },\n      { minIncome: 125140, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.20,\n    capitalGainsTaxRate: 0.20,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 75,\n    rentIndex: 45,\n    groceriesIndex: 70,\n    purchasingPowerIndex: 82,\n    averageMonthlyIncome: 3500,\n    medianMonthlyIncome: 2800,\n    luxuryPricing: {\n      lamborghiniUrus: 195000,\n      lamborghiniHuracan: 225000,\n      porsche911: 100000,\n      rolexSubmariner: 8000,\n      medianHomePriceCity: 550000,\n      medianHomePriceSuburb: 350000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['HMRC tax filing', 'FSCS protected deposits', 'ISA tax-free savings'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  DE: {\n    countryCode: 'DE',\n    countryName: 'Germany',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 11604, rate: 0 },\n      { minIncome: 11604, maxIncome: 66760, rate: 0.14 },\n      { minIncome: 66760, maxIncome: 277825, rate: 0.42 },\n      { minIncome: 277825, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.19,\n    capitalGainsTaxRate: 0.25,\n    corporateTaxRate: 0.30,\n    costOfLivingIndex: 65,\n    rentIndex: 38,\n    groceriesIndex: 65,\n    purchasingPowerIndex: 95,\n    averageMonthlyIncome: 4100,\n    medianMonthlyIncome: 3500,\n    luxuryPricing: {\n      lamborghiniUrus: 220000,\n      lamborghiniHuracan: 250000,\n      porsche911: 110000,\n      rolexSubmariner: 9500,\n      medianHomePriceCity: 450000,\n      medianHomePriceSuburb: 320000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Finanzamt tax filing', 'Deposit guarantee up to 100k EUR', 'Riester-Rente retirement plans'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  FR: {\n    countryCode: 'FR',\n    countryName: 'France',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 11294, rate: 0 },\n      { minIncome: 11294, maxIncome: 28797, rate: 0.11 },\n      { minIncome: 28797, maxIncome: 82341, rate: 0.30 },\n      { minIncome: 82341, maxIncome: 177106, rate: 0.41 },\n      { minIncome: 177106, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.20,\n    capitalGainsTaxRate: 0.30,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 74,\n    rentIndex: 38,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 78,\n    averageMonthlyIncome: 3100,\n    medianMonthlyIncome: 2500,\n    luxuryPricing: {\n      lamborghiniUrus: 230000,\n      lamborghiniHuracan: 260000,\n      porsche911: 115000,\n      rolexSubmariner: 10000,\n      medianHomePriceCity: 500000,\n      medianHomePriceSuburb: 280000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['DGFiP tax authority', 'PEA tax-advantaged investing', 'High social contributions'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  IT: {\n    countryCode: 'IT',\n    countryName: 'Italy',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 28000, rate: 0.23 },\n      { minIncome: 28000, maxIncome: 50000, rate: 0.35 },\n      { minIncome: 50000, maxIncome: null, rate: 0.43 },\n    ],\n    vatRate: 0.22,\n    capitalGainsTaxRate: 0.26,\n    corporateTaxRate: 0.24,\n    costOfLivingIndex: 70,\n    rentIndex: 32,\n    groceriesIndex: 68,\n    purchasingPowerIndex: 65,\n    averageMonthlyIncome: 2500,\n    medianMonthlyIncome: 2000,\n    luxuryPricing: {\n      lamborghiniUrus: 200000,\n      lamborghiniHuracan: 230000,\n      porsche911: 105000,\n      rolexSubmariner: 9200,\n      medianHomePriceCity: 380000,\n      medianHomePriceSuburb: 220000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Agenzia delle Entrate', 'TFR severance fund', 'PIR tax-advantaged plans'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  ES: {\n    countryCode: 'ES',\n    countryName: 'Spain',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 12450, rate: 0.19 },\n      { minIncome: 12450, maxIncome: 20200, rate: 0.24 },\n      { minIncome: 20200, maxIncome: 35200, rate: 0.30 },\n      { minIncome: 35200, maxIncome: 60000, rate: 0.37 },\n      { minIncome: 60000, maxIncome: 300000, rate: 0.45 },\n      { minIncome: 300000, maxIncome: null, rate: 0.47 },\n    ],\n    vatRate: 0.21,\n    capitalGainsTaxRate: 0.23,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 55,\n    rentIndex: 30,\n    groceriesIndex: 55,\n    purchasingPowerIndex: 62,\n    averageMonthlyIncome: 2300,\n    medianMonthlyIncome: 1800,\n    luxuryPricing: {\n      lamborghiniUrus: 220000,\n      lamborghiniHuracan: 250000,\n      porsche911: 115000,\n      rolexSubmariner: 9800,\n      medianHomePriceCity: 350000,\n      medianHomePriceSuburb: 200000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Agencia Tributaria', 'Patrimony tax (varies by region)', 'Plan de Pensiones'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  NL: {\n    countryCode: 'NL',\n    countryName: 'Netherlands',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 75518, rate: 0.3693 },\n      { minIncome: 75518, maxIncome: null, rate: 0.495 },\n    ],\n    vatRate: 0.21,\n    capitalGainsTaxRate: 0.32, // Box 3 wealth tax\n    corporateTaxRate: 0.258,\n    costOfLivingIndex: 73,\n    rentIndex: 45,\n    groceriesIndex: 62,\n    purchasingPowerIndex: 88,\n    averageMonthlyIncome: 3800,\n    medianMonthlyIncome: 3200,\n    luxuryPricing: {\n      lamborghiniUrus: 280000,\n      lamborghiniHuracan: 320000,\n      porsche911: 140000,\n      rolexSubmariner: 10500,\n      medianHomePriceCity: 550000,\n      medianHomePriceSuburb: 400000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Belastingdienst', 'Box 3 wealth tax system', 'Mandatory pension contributions'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  CH: {\n    countryCode: 'CH',\n    countryName: 'Switzerland',\n    currency: 'CHF',\n    currencySymbol: 'CHF',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 18500, rate: 0.0077 },\n      { minIncome: 18500, maxIncome: 32100, rate: 0.0088 },\n      { minIncome: 32100, maxIncome: 42100, rate: 0.0266 },\n      { minIncome: 42100, maxIncome: 56200, rate: 0.0299 },\n      { minIncome: 56200, maxIncome: 74300, rate: 0.0511 },\n      { minIncome: 74300, maxIncome: 760000, rate: 0.0611 },\n      { minIncome: 760000, maxIncome: null, rate: 0.115 },\n    ],\n    vatRate: 0.081,\n    capitalGainsTaxRate: 0, // No capital gains tax for individuals\n    corporateTaxRate: 0.085,\n    costOfLivingIndex: 125,\n    rentIndex: 70,\n    groceriesIndex: 115,\n    purchasingPowerIndex: 130,\n    averageMonthlyIncome: 7500,\n    medianMonthlyIncome: 6500,\n    luxuryPricing: {\n      lamborghiniUrus: 230000,\n      lamborghiniHuracan: 260000,\n      porsche911: 140000,\n      rolexSubmariner: 9500,\n      medianHomePriceCity: 1200000,\n      medianHomePriceSuburb: 800000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Cantonal tax variation', 'Pillar 3a retirement savings', 'No capital gains tax for private investors'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Asia Pacific\n  JP: {\n    countryCode: 'JP',\n    countryName: 'Japan',\n    currency: 'JPY',\n    currencySymbol: '¥',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 1950000, rate: 0.05 },\n      { minIncome: 1950000, maxIncome: 3300000, rate: 0.10 },\n      { minIncome: 3300000, maxIncome: 6950000, rate: 0.20 },\n      { minIncome: 6950000, maxIncome: 9000000, rate: 0.23 },\n      { minIncome: 9000000, maxIncome: 18000000, rate: 0.33 },\n      { minIncome: 18000000, maxIncome: 40000000, rate: 0.40 },\n      { minIncome: 40000000, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.10, // Consumption tax\n    capitalGainsTaxRate: 0.2015,\n    corporateTaxRate: 0.2974,\n    costOfLivingIndex: 83,\n    rentIndex: 42,\n    groceriesIndex: 95,\n    purchasingPowerIndex: 75,\n    averageMonthlyIncome: 450000,\n    medianMonthlyIncome: 370000,\n    luxuryPricing: {\n      lamborghiniUrus: 35000000,\n      lamborghiniHuracan: 40000000,\n      porsche911: 18000000,\n      rolexSubmariner: 1500000,\n      medianHomePriceCity: 70000000,\n      medianHomePriceSuburb: 40000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['NTA tax authority', 'NISA tax-free investment', 'iDeCo pension system'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  CN: {\n    countryCode: 'CN',\n    countryName: 'China',\n    currency: 'CNY',\n    currencySymbol: '¥',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 36000, rate: 0.03 },\n      { minIncome: 36000, maxIncome: 144000, rate: 0.10 },\n      { minIncome: 144000, maxIncome: 300000, rate: 0.20 },\n      { minIncome: 300000, maxIncome: 420000, rate: 0.25 },\n      { minIncome: 420000, maxIncome: 660000, rate: 0.30 },\n      { minIncome: 660000, maxIncome: 960000, rate: 0.35 },\n      { minIncome: 960000, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.13,\n    capitalGainsTaxRate: 0.20,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 40,\n    rentIndex: 25,\n    groceriesIndex: 45,\n    purchasingPowerIndex: 70,\n    averageMonthlyIncome: 12000,\n    medianMonthlyIncome: 7000,\n    luxuryPricing: {\n      lamborghiniUrus: 2600000,\n      lamborghiniHuracan: 3000000,\n      porsche911: 1500000,\n      rolexSubmariner: 100000,\n      medianHomePriceCity: 5000000,\n      medianHomePriceSuburb: 2000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['SAT tax authority', 'Housing Provident Fund', 'Capital controls on foreign exchange'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  KR: {\n    countryCode: 'KR',\n    countryName: 'South Korea',\n    currency: 'KRW',\n    currencySymbol: '₩',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 14000000, rate: 0.06 },\n      { minIncome: 14000000, maxIncome: 50000000, rate: 0.15 },\n      { minIncome: 50000000, maxIncome: 88000000, rate: 0.24 },\n      { minIncome: 88000000, maxIncome: 150000000, rate: 0.35 },\n      { minIncome: 150000000, maxIncome: 300000000, rate: 0.38 },\n      { minIncome: 300000000, maxIncome: 500000000, rate: 0.40 },\n      { minIncome: 500000000, maxIncome: 1000000000, rate: 0.42 },\n      { minIncome: 1000000000, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.10,\n    capitalGainsTaxRate: 0.22,\n    corporateTaxRate: 0.24,\n    costOfLivingIndex: 78,\n    rentIndex: 35,\n    groceriesIndex: 90,\n    purchasingPowerIndex: 70,\n    averageMonthlyIncome: 4200000,\n    medianMonthlyIncome: 3500000,\n    luxuryPricing: {\n      lamborghiniUrus: 350000000,\n      lamborghiniHuracan: 400000000,\n      porsche911: 180000000,\n      rolexSubmariner: 15000000,\n      medianHomePriceCity: 1200000000,\n      medianHomePriceSuburb: 600000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['NTS tax authority', 'National Pension Service', 'High property taxes in speculation zones'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  SG: {\n    countryCode: 'SG',\n    countryName: 'Singapore',\n    currency: 'SGD',\n    currencySymbol: 'S$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 20000, rate: 0 },\n      { minIncome: 20000, maxIncome: 30000, rate: 0.02 },\n      { minIncome: 30000, maxIncome: 40000, rate: 0.035 },\n      { minIncome: 40000, maxIncome: 80000, rate: 0.07 },\n      { minIncome: 80000, maxIncome: 120000, rate: 0.115 },\n      { minIncome: 120000, maxIncome: 160000, rate: 0.15 },\n      { minIncome: 160000, maxIncome: 200000, rate: 0.18 },\n      { minIncome: 200000, maxIncome: 240000, rate: 0.19 },\n      { minIncome: 240000, maxIncome: 280000, rate: 0.195 },\n      { minIncome: 280000, maxIncome: 320000, rate: 0.20 },\n      { minIncome: 320000, maxIncome: 500000, rate: 0.22 },\n      { minIncome: 500000, maxIncome: 1000000, rate: 0.23 },\n      { minIncome: 1000000, maxIncome: null, rate: 0.24 },\n    ],\n    vatRate: 0.09, // GST\n    capitalGainsTaxRate: 0, // No capital gains tax\n    corporateTaxRate: 0.17,\n    costOfLivingIndex: 85,\n    rentIndex: 80,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 95,\n    averageMonthlyIncome: 6500,\n    medianMonthlyIncome: 5200,\n    luxuryPricing: {\n      lamborghiniUrus: 850000,\n      lamborghiniHuracan: 950000,\n      porsche911: 450000,\n      rolexSubmariner: 15000,\n      medianHomePriceCity: 1800000,\n      medianHomePriceSuburb: 1200000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['IRAS tax authority', 'CPF mandatory savings', 'No capital gains tax', 'High COE for vehicles'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  AU: {\n    countryCode: 'AU',\n    countryName: 'Australia',\n    currency: 'AUD',\n    currencySymbol: 'A$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 18200, rate: 0 },\n      { minIncome: 18200, maxIncome: 45000, rate: 0.19 },\n      { minIncome: 45000, maxIncome: 120000, rate: 0.325 },\n      { minIncome: 120000, maxIncome: 180000, rate: 0.37 },\n      { minIncome: 180000, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.10, // GST\n    capitalGainsTaxRate: 0.225, // 50% CGT discount for assets held > 12 months\n    corporateTaxRate: 0.30,\n    costOfLivingIndex: 73,\n    rentIndex: 50,\n    groceriesIndex: 80,\n    purchasingPowerIndex: 95,\n    averageMonthlyIncome: 6500,\n    medianMonthlyIncome: 5200,\n    luxuryPricing: {\n      lamborghiniUrus: 450000,\n      lamborghiniHuracan: 520000,\n      porsche911: 250000,\n      rolexSubmariner: 15000,\n      medianHomePriceCity: 1100000,\n      medianHomePriceSuburb: 750000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['ATO tax authority', 'Superannuation mandatory 11%', 'Negative gearing for property'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  IN: {\n    countryCode: 'IN',\n    countryName: 'India',\n    currency: 'INR',\n    currencySymbol: '₹',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 300000, rate: 0 },\n      { minIncome: 300000, maxIncome: 700000, rate: 0.05 },\n      { minIncome: 700000, maxIncome: 1000000, rate: 0.10 },\n      { minIncome: 1000000, maxIncome: 1200000, rate: 0.15 },\n      { minIncome: 1200000, maxIncome: 1500000, rate: 0.20 },\n      { minIncome: 1500000, maxIncome: null, rate: 0.30 },\n    ],\n    vatRate: 0.18, // GST (varies by product)\n    capitalGainsTaxRate: 0.15, // Short-term; Long-term is 10% above 1L\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 24,\n    rentIndex: 8,\n    groceriesIndex: 28,\n    purchasingPowerIndex: 45,\n    averageMonthlyIncome: 50000,\n    medianMonthlyIncome: 30000,\n    luxuryPricing: {\n      lamborghiniUrus: 40000000,\n      lamborghiniHuracan: 45000000,\n      porsche911: 20000000,\n      rolexSubmariner: 1200000,\n      medianHomePriceCity: 15000000,\n      medianHomePriceSuburb: 6000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['Income Tax Department', 'PPF/NPS retirement savings', 'High import duties on luxury goods'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Middle East\n  AE: {\n    countryCode: 'AE',\n    countryName: 'United Arab Emirates',\n    currency: 'AED',\n    currencySymbol: 'د.إ',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: null, rate: 0 }, // No personal income tax\n    ],\n    vatRate: 0.05,\n    capitalGainsTaxRate: 0,\n    corporateTaxRate: 0.09, // New 2023, exempt under 375k AED\n    costOfLivingIndex: 62,\n    rentIndex: 50,\n    groceriesIndex: 55,\n    purchasingPowerIndex: 115,\n    averageMonthlyIncome: 18000,\n    medianMonthlyIncome: 12000,\n    luxuryPricing: {\n      lamborghiniUrus: 950000,\n      lamborghiniHuracan: 1100000,\n      porsche911: 500000,\n      rolexSubmariner: 42000,\n      medianHomePriceCity: 2500000,\n      medianHomePriceSuburb: 1500000,\n    },\n    region: 'middle_east',\n    economicSystem: 'developed',\n    financialRegulations: ['No personal income tax', 'Free zone benefits', 'Recent corporate tax introduction'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  SA: {\n    countryCode: 'SA',\n    countryName: 'Saudi Arabia',\n    currency: 'SAR',\n    currencySymbol: 'ر.س',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: null, rate: 0 }, // No personal income tax for citizens\n    ],\n    vatRate: 0.15,\n    capitalGainsTaxRate: 0.20, // On real estate\n    corporateTaxRate: 0.20,\n    costOfLivingIndex: 42,\n    rentIndex: 20,\n    groceriesIndex: 45,\n    purchasingPowerIndex: 90,\n    averageMonthlyIncome: 12000,\n    medianMonthlyIncome: 8000,\n    luxuryPricing: {\n      lamborghiniUrus: 1100000,\n      lamborghiniHuracan: 1250000,\n      porsche911: 550000,\n      rolexSubmariner: 45000,\n      medianHomePriceCity: 1500000,\n      medianHomePriceSuburb: 800000,\n    },\n    region: 'middle_east',\n    economicSystem: 'developing',\n    financialRegulations: ['No personal income tax', 'Zakat religious tax', 'GOSI social insurance'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Latin America\n  BR: {\n    countryCode: 'BR',\n    countryName: 'Brazil',\n    currency: 'BRL',\n    currencySymbol: 'R$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 26963, rate: 0 },\n      { minIncome: 26963, maxIncome: 33919, rate: 0.075 },\n      { minIncome: 33919, maxIncome: 45012, rate: 0.15 },\n      { minIncome: 45012, maxIncome: 55976, rate: 0.225 },\n      { minIncome: 55976, maxIncome: null, rate: 0.275 },\n    ],\n    vatRate: 0.17, // ICMS varies by state\n    capitalGainsTaxRate: 0.15,\n    corporateTaxRate: 0.34,\n    costOfLivingIndex: 35,\n    rentIndex: 15,\n    groceriesIndex: 35,\n    purchasingPowerIndex: 35,\n    averageMonthlyIncome: 4500,\n    medianMonthlyIncome: 2800,\n    luxuryPricing: {\n      lamborghiniUrus: 3500000,\n      lamborghiniHuracan: 4000000,\n      porsche911: 1200000,\n      rolexSubmariner: 80000,\n      medianHomePriceCity: 1200000,\n      medianHomePriceSuburb: 500000,\n    },\n    region: 'latin_america',\n    economicSystem: 'emerging',\n    financialRegulations: ['Receita Federal', 'High import taxes on luxury goods', 'Complex state/federal tax system'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  AR: {\n    countryCode: 'AR',\n    countryName: 'Argentina',\n    currency: 'ARS',\n    currencySymbol: '$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 419254, rate: 0.05 },\n      { minIncome: 419254, maxIncome: 838508, rate: 0.09 },\n      { minIncome: 838508, maxIncome: 1257762, rate: 0.12 },\n      { minIncome: 1257762, maxIncome: 1677016, rate: 0.15 },\n      { minIncome: 1677016, maxIncome: 2515524, rate: 0.19 },\n      { minIncome: 2515524, maxIncome: 3354032, rate: 0.23 },\n      { minIncome: 3354032, maxIncome: 5031048, rate: 0.27 },\n      { minIncome: 5031048, maxIncome: 6708064, rate: 0.31 },\n      { minIncome: 6708064, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.21,\n    capitalGainsTaxRate: 0.15,\n    corporateTaxRate: 0.35,\n    costOfLivingIndex: 28,\n    rentIndex: 8,\n    groceriesIndex: 25,\n    purchasingPowerIndex: 22,\n    averageMonthlyIncome: 350000,\n    medianMonthlyIncome: 250000,\n    luxuryPricing: {\n      lamborghiniUrus: 450000000,\n      lamborghiniHuracan: 500000000,\n      porsche911: 200000000,\n      rolexSubmariner: 15000000,\n      medianHomePriceCity: 200000000,\n      medianHomePriceSuburb: 80000000,\n    },\n    region: 'latin_america',\n    economicSystem: 'emerging',\n    financialRegulations: ['AFIP tax authority', 'High inflation environment', 'Currency controls (cepo)'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Africa\n  ZA: {\n    countryCode: 'ZA',\n    countryName: 'South Africa',\n    currency: 'ZAR',\n    currencySymbol: 'R',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 237100, rate: 0.18 },\n      { minIncome: 237100, maxIncome: 370500, rate: 0.26 },\n      { minIncome: 370500, maxIncome: 512800, rate: 0.31 },\n      { minIncome: 512800, maxIncome: 673000, rate: 0.36 },\n      { minIncome: 673000, maxIncome: 857900, rate: 0.39 },\n      { minIncome: 857900, maxIncome: 1817000, rate: 0.41 },\n      { minIncome: 1817000, maxIncome: null, rate: 0.45 },\n    ],\n    vatRate: 0.15,\n    capitalGainsTaxRate: 0.18,\n    corporateTaxRate: 0.27,\n    costOfLivingIndex: 32,\n    rentIndex: 12,\n    groceriesIndex: 35,\n    purchasingPowerIndex: 45,\n    averageMonthlyIncome: 25000,\n    medianMonthlyIncome: 15000,\n    luxuryPricing: {\n      lamborghiniUrus: 6500000,\n      lamborghiniHuracan: 7500000,\n      porsche911: 2500000,\n      rolexSubmariner: 200000,\n      medianHomePriceCity: 3500000,\n      medianHomePriceSuburb: 1500000,\n    },\n    region: 'africa',\n    economicSystem: 'emerging',\n    financialRegulations: ['SARS tax authority', 'Tax-free savings account (TFSA)', 'Retirement annuity contributions deductible'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  NG: {\n    countryCode: 'NG',\n    countryName: 'Nigeria',\n    currency: 'NGN',\n    currencySymbol: '₦',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 300000, rate: 0.07 },\n      { minIncome: 300000, maxIncome: 600000, rate: 0.11 },\n      { minIncome: 600000, maxIncome: 1100000, rate: 0.15 },\n      { minIncome: 1100000, maxIncome: 1600000, rate: 0.19 },\n      { minIncome: 1600000, maxIncome: 3200000, rate: 0.21 },\n      { minIncome: 3200000, maxIncome: null, rate: 0.24 },\n    ],\n    vatRate: 0.075,\n    capitalGainsTaxRate: 0.10,\n    corporateTaxRate: 0.30,\n    costOfLivingIndex: 28,\n    rentIndex: 18,\n    groceriesIndex: 32,\n    purchasingPowerIndex: 25,\n    averageMonthlyIncome: 200000,\n    medianMonthlyIncome: 100000,\n    luxuryPricing: {\n      lamborghiniUrus: 550000000,\n      lamborghiniHuracan: 620000000,\n      porsche911: 280000000,\n      rolexSubmariner: 22000000,\n      medianHomePriceCity: 150000000,\n      medianHomePriceSuburb: 50000000,\n    },\n    region: 'africa',\n    economicSystem: 'developing',\n    financialRegulations: ['FIRS tax authority', 'Pension Reform Act', 'High import duties'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  EG: {\n    countryCode: 'EG',\n    countryName: 'Egypt',\n    currency: 'EGP',\n    currencySymbol: 'E£',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 40000, rate: 0 },\n      { minIncome: 40000, maxIncome: 55000, rate: 0.10 },\n      { minIncome: 55000, maxIncome: 70000, rate: 0.15 },\n      { minIncome: 70000, maxIncome: 200000, rate: 0.20 },\n      { minIncome: 200000, maxIncome: 400000, rate: 0.225 },\n      { minIncome: 400000, maxIncome: 600000, rate: 0.25 },\n      { minIncome: 600000, maxIncome: null, rate: 0.275 },\n    ],\n    vatRate: 0.14,\n    capitalGainsTaxRate: 0.10,\n    corporateTaxRate: 0.225,\n    costOfLivingIndex: 22,\n    rentIndex: 5,\n    groceriesIndex: 22,\n    purchasingPowerIndex: 32,\n    averageMonthlyIncome: 12000,\n    medianMonthlyIncome: 7000,\n    luxuryPricing: {\n      lamborghiniUrus: 18000000,\n      lamborghiniHuracan: 20000000,\n      porsche911: 9000000,\n      rolexSubmariner: 700000,\n      medianHomePriceCity: 5000000,\n      medianHomePriceSuburb: 2000000,\n    },\n    region: 'africa',\n    economicSystem: 'developing',\n    financialRegulations: ['ETA tax authority', 'High import taxes on vehicles', 'Currency fluctuation concerns'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // More European countries\n  PL: {\n    countryCode: 'PL',\n    countryName: 'Poland',\n    currency: 'PLN',\n    currencySymbol: 'zł',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 30000, rate: 0 },\n      { minIncome: 30000, maxIncome: 120000, rate: 0.12 },\n      { minIncome: 120000, maxIncome: null, rate: 0.32 },\n    ],\n    vatRate: 0.23,\n    capitalGainsTaxRate: 0.19,\n    corporateTaxRate: 0.19,\n    costOfLivingIndex: 42,\n    rentIndex: 22,\n    groceriesIndex: 40,\n    purchasingPowerIndex: 58,\n    averageMonthlyIncome: 7500,\n    medianMonthlyIncome: 5800,\n    luxuryPricing: {\n      lamborghiniUrus: 1100000,\n      lamborghiniHuracan: 1250000,\n      porsche911: 550000,\n      rolexSubmariner: 48000,\n      medianHomePriceCity: 900000,\n      medianHomePriceSuburb: 500000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['KAS tax authority', 'IKE/IKZE retirement accounts', 'EU member regulations'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  SE: {\n    countryCode: 'SE',\n    countryName: 'Sweden',\n    currency: 'SEK',\n    currencySymbol: 'kr',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 540700, rate: 0.32 }, // Municipal tax only\n      { minIncome: 540700, maxIncome: null, rate: 0.52 }, // + 20% state tax\n    ],\n    vatRate: 0.25,\n    capitalGainsTaxRate: 0.30,\n    corporateTaxRate: 0.206,\n    costOfLivingIndex: 70,\n    rentIndex: 35,\n    groceriesIndex: 65,\n    purchasingPowerIndex: 90,\n    averageMonthlyIncome: 45000,\n    medianMonthlyIncome: 38000,\n    luxuryPricing: {\n      lamborghiniUrus: 2800000,\n      lamborghiniHuracan: 3200000,\n      porsche911: 1400000,\n      rolexSubmariner: 110000,\n      medianHomePriceCity: 6000000,\n      medianHomePriceSuburb: 4000000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Skatteverket', 'ISK tax-advantaged accounts', 'High progressive taxation'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  NO: {\n    countryCode: 'NO',\n    countryName: 'Norway',\n    currency: 'NOK',\n    currencySymbol: 'kr',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 198350, rate: 0.22 },\n      { minIncome: 198350, maxIncome: 279150, rate: 0.232 },\n      { minIncome: 279150, maxIncome: 644700, rate: 0.264 },\n      { minIncome: 644700, maxIncome: 969200, rate: 0.342 },\n      { minIncome: 969200, maxIncome: null, rate: 0.392 },\n    ],\n    vatRate: 0.25,\n    capitalGainsTaxRate: 0.22,\n    corporateTaxRate: 0.22,\n    costOfLivingIndex: 100,\n    rentIndex: 45,\n    groceriesIndex: 95,\n    purchasingPowerIndex: 105,\n    averageMonthlyIncome: 55000,\n    medianMonthlyIncome: 48000,\n    luxuryPricing: {\n      lamborghiniUrus: 3500000,\n      lamborghiniHuracan: 4000000,\n      porsche911: 1800000,\n      rolexSubmariner: 120000,\n      medianHomePriceCity: 7500000,\n      medianHomePriceSuburb: 5000000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Skatteetaten', 'Aksjesparekonto (ASK) tax-advantaged', 'Oil Fund sovereign wealth'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  DK: {\n    countryCode: 'DK',\n    countryName: 'Denmark',\n    currency: 'DKK',\n    currencySymbol: 'kr',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 46700, rate: 0 },\n      { minIncome: 46700, maxIncome: 552500, rate: 0.40 },\n      { minIncome: 552500, maxIncome: null, rate: 0.56 },\n    ],\n    vatRate: 0.25,\n    capitalGainsTaxRate: 0.42,\n    corporateTaxRate: 0.22,\n    costOfLivingIndex: 85,\n    rentIndex: 40,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 95,\n    averageMonthlyIncome: 42000,\n    medianMonthlyIncome: 36000,\n    luxuryPricing: {\n      lamborghiniUrus: 3200000,\n      lamborghiniHuracan: 3700000,\n      porsche911: 1600000,\n      rolexSubmariner: 95000,\n      medianHomePriceCity: 5500000,\n      medianHomePriceSuburb: 3500000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['SKAT tax authority', 'Very high vehicle registration tax (150%)', 'Aktiesparekonto stock savings'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  AT: {\n    countryCode: 'AT',\n    countryName: 'Austria',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 12816, rate: 0 },\n      { minIncome: 12816, maxIncome: 20818, rate: 0.20 },\n      { minIncome: 20818, maxIncome: 34513, rate: 0.30 },\n      { minIncome: 34513, maxIncome: 66612, rate: 0.40 },\n      { minIncome: 66612, maxIncome: 99266, rate: 0.48 },\n      { minIncome: 99266, maxIncome: 1000000, rate: 0.50 },\n      { minIncome: 1000000, maxIncome: null, rate: 0.55 },\n    ],\n    vatRate: 0.20,\n    capitalGainsTaxRate: 0.275,\n    corporateTaxRate: 0.23,\n    costOfLivingIndex: 72,\n    rentIndex: 40,\n    groceriesIndex: 70,\n    purchasingPowerIndex: 88,\n    averageMonthlyIncome: 3800,\n    medianMonthlyIncome: 3200,\n    luxuryPricing: {\n      lamborghiniUrus: 260000,\n      lamborghiniHuracan: 300000,\n      porsche911: 135000,\n      rolexSubmariner: 10500,\n      medianHomePriceCity: 500000,\n      medianHomePriceSuburb: 350000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['BMF tax authority', 'Mandatory pension contributions', 'EU financial regulations'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  BE: {\n    countryCode: 'BE',\n    countryName: 'Belgium',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 15200, rate: 0.25 },\n      { minIncome: 15200, maxIncome: 26830, rate: 0.40 },\n      { minIncome: 26830, maxIncome: 46440, rate: 0.45 },\n      { minIncome: 46440, maxIncome: null, rate: 0.50 },\n    ],\n    vatRate: 0.21,\n    capitalGainsTaxRate: 0, // Generally exempt for individuals\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 75,\n    rentIndex: 35,\n    groceriesIndex: 68,\n    purchasingPowerIndex: 80,\n    averageMonthlyIncome: 3600,\n    medianMonthlyIncome: 3000,\n    luxuryPricing: {\n      lamborghiniUrus: 270000,\n      lamborghiniHuracan: 310000,\n      porsche911: 140000,\n      rolexSubmariner: 10800,\n      medianHomePriceCity: 400000,\n      medianHomePriceSuburb: 300000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['SPF Finance', 'High social security contributions', 'Company car tax benefits'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  PT: {\n    countryCode: 'PT',\n    countryName: 'Portugal',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 7703, rate: 0.1325 },\n      { minIncome: 7703, maxIncome: 11623, rate: 0.18 },\n      { minIncome: 11623, maxIncome: 16472, rate: 0.23 },\n      { minIncome: 16472, maxIncome: 21321, rate: 0.26 },\n      { minIncome: 21321, maxIncome: 27146, rate: 0.3275 },\n      { minIncome: 27146, maxIncome: 39791, rate: 0.37 },\n      { minIncome: 39791, maxIncome: 51997, rate: 0.435 },\n      { minIncome: 51997, maxIncome: 81199, rate: 0.45 },\n      { minIncome: 81199, maxIncome: null, rate: 0.48 },\n    ],\n    vatRate: 0.23,\n    capitalGainsTaxRate: 0.28,\n    corporateTaxRate: 0.21,\n    costOfLivingIndex: 48,\n    rentIndex: 28,\n    groceriesIndex: 48,\n    purchasingPowerIndex: 50,\n    averageMonthlyIncome: 1600,\n    medianMonthlyIncome: 1200,\n    luxuryPricing: {\n      lamborghiniUrus: 280000,\n      lamborghiniHuracan: 320000,\n      porsche911: 150000,\n      rolexSubmariner: 11000,\n      medianHomePriceCity: 400000,\n      medianHomePriceSuburb: 220000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['AT tax authority', 'NHR tax regime for expats', 'Golden Visa program'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  IE: {\n    countryCode: 'IE',\n    countryName: 'Ireland',\n    currency: 'EUR',\n    currencySymbol: '€',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 42000, rate: 0.20 },\n      { minIncome: 42000, maxIncome: null, rate: 0.40 },\n    ],\n    vatRate: 0.23,\n    capitalGainsTaxRate: 0.33,\n    corporateTaxRate: 0.125,\n    costOfLivingIndex: 85,\n    rentIndex: 65,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 90,\n    averageMonthlyIncome: 4500,\n    medianMonthlyIncome: 3800,\n    luxuryPricing: {\n      lamborghiniUrus: 280000,\n      lamborghiniHuracan: 320000,\n      porsche911: 145000,\n      rolexSubmariner: 11500,\n      medianHomePriceCity: 550000,\n      medianHomePriceSuburb: 380000,\n    },\n    region: 'europe',\n    economicSystem: 'developed',\n    financialRegulations: ['Revenue Commissioners', 'Low corporate tax attracts multinationals', 'USC additional charge'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // Southeast Asia\n  TH: {\n    countryCode: 'TH',\n    countryName: 'Thailand',\n    currency: 'THB',\n    currencySymbol: '฿',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 150000, rate: 0 },\n      { minIncome: 150000, maxIncome: 300000, rate: 0.05 },\n      { minIncome: 300000, maxIncome: 500000, rate: 0.10 },\n      { minIncome: 500000, maxIncome: 750000, rate: 0.15 },\n      { minIncome: 750000, maxIncome: 1000000, rate: 0.20 },\n      { minIncome: 1000000, maxIncome: 2000000, rate: 0.25 },\n      { minIncome: 2000000, maxIncome: 5000000, rate: 0.30 },\n      { minIncome: 5000000, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.07,\n    capitalGainsTaxRate: 0, // Generally exempt\n    corporateTaxRate: 0.20,\n    costOfLivingIndex: 40,\n    rentIndex: 18,\n    groceriesIndex: 45,\n    purchasingPowerIndex: 55,\n    averageMonthlyIncome: 35000,\n    medianMonthlyIncome: 25000,\n    luxuryPricing: {\n      lamborghiniUrus: 35000000,\n      lamborghiniHuracan: 40000000,\n      porsche911: 15000000,\n      rolexSubmariner: 500000,\n      medianHomePriceCity: 8000000,\n      medianHomePriceSuburb: 3500000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['Revenue Department', 'LTF/RMF retirement funds', 'BOI investment incentives'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  VN: {\n    countryCode: 'VN',\n    countryName: 'Vietnam',\n    currency: 'VND',\n    currencySymbol: '₫',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 60000000, rate: 0.05 },\n      { minIncome: 60000000, maxIncome: 120000000, rate: 0.10 },\n      { minIncome: 120000000, maxIncome: 216000000, rate: 0.15 },\n      { minIncome: 216000000, maxIncome: 384000000, rate: 0.20 },\n      { minIncome: 384000000, maxIncome: 624000000, rate: 0.25 },\n      { minIncome: 624000000, maxIncome: 960000000, rate: 0.30 },\n      { minIncome: 960000000, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.10,\n    capitalGainsTaxRate: 0.20,\n    corporateTaxRate: 0.20,\n    costOfLivingIndex: 32,\n    rentIndex: 12,\n    groceriesIndex: 35,\n    purchasingPowerIndex: 42,\n    averageMonthlyIncome: 15000000,\n    medianMonthlyIncome: 10000000,\n    luxuryPricing: {\n      lamborghiniUrus: 25000000000,\n      lamborghiniHuracan: 28000000000,\n      porsche911: 9000000000,\n      rolexSubmariner: 350000000,\n      medianHomePriceCity: 8000000000,\n      medianHomePriceSuburb: 3000000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['GDT tax authority', 'Special consumption tax on luxury goods', 'Foreign ownership restrictions'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  ID: {\n    countryCode: 'ID',\n    countryName: 'Indonesia',\n    currency: 'IDR',\n    currencySymbol: 'Rp',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 60000000, rate: 0.05 },\n      { minIncome: 60000000, maxIncome: 250000000, rate: 0.15 },\n      { minIncome: 250000000, maxIncome: 500000000, rate: 0.25 },\n      { minIncome: 500000000, maxIncome: 5000000000, rate: 0.30 },\n      { minIncome: 5000000000, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.11,\n    capitalGainsTaxRate: 0.25,\n    corporateTaxRate: 0.22,\n    costOfLivingIndex: 32,\n    rentIndex: 10,\n    groceriesIndex: 38,\n    purchasingPowerIndex: 38,\n    averageMonthlyIncome: 8000000,\n    medianMonthlyIncome: 5000000,\n    luxuryPricing: {\n      lamborghiniUrus: 12000000000,\n      lamborghiniHuracan: 14000000000,\n      porsche911: 4500000000,\n      rolexSubmariner: 250000000,\n      medianHomePriceCity: 5000000000,\n      medianHomePriceSuburb: 2000000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['DJP tax authority', 'Luxury goods tax up to 200%', 'OJK financial regulation'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  MY: {\n    countryCode: 'MY',\n    countryName: 'Malaysia',\n    currency: 'MYR',\n    currencySymbol: 'RM',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 5000, rate: 0 },\n      { minIncome: 5000, maxIncome: 20000, rate: 0.01 },\n      { minIncome: 20000, maxIncome: 35000, rate: 0.03 },\n      { minIncome: 35000, maxIncome: 50000, rate: 0.06 },\n      { minIncome: 50000, maxIncome: 70000, rate: 0.11 },\n      { minIncome: 70000, maxIncome: 100000, rate: 0.19 },\n      { minIncome: 100000, maxIncome: 400000, rate: 0.25 },\n      { minIncome: 400000, maxIncome: 600000, rate: 0.26 },\n      { minIncome: 600000, maxIncome: 2000000, rate: 0.28 },\n      { minIncome: 2000000, maxIncome: null, rate: 0.30 },\n    ],\n    vatRate: 0, // No GST/VAT currently\n    capitalGainsTaxRate: 0, // No capital gains tax (except real estate)\n    corporateTaxRate: 0.24,\n    costOfLivingIndex: 35,\n    rentIndex: 15,\n    groceriesIndex: 38,\n    purchasingPowerIndex: 62,\n    averageMonthlyIncome: 5500,\n    medianMonthlyIncome: 4000,\n    luxuryPricing: {\n      lamborghiniUrus: 1800000,\n      lamborghiniHuracan: 2100000,\n      porsche911: 850000,\n      rolexSubmariner: 55000,\n      medianHomePriceCity: 800000,\n      medianHomePriceSuburb: 450000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['LHDN tax authority', 'EPF mandatory retirement savings', 'No capital gains tax for shares'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  PH: {\n    countryCode: 'PH',\n    countryName: 'Philippines',\n    currency: 'PHP',\n    currencySymbol: '₱',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 250000, rate: 0 },\n      { minIncome: 250000, maxIncome: 400000, rate: 0.15 },\n      { minIncome: 400000, maxIncome: 800000, rate: 0.20 },\n      { minIncome: 800000, maxIncome: 2000000, rate: 0.25 },\n      { minIncome: 2000000, maxIncome: 8000000, rate: 0.30 },\n      { minIncome: 8000000, maxIncome: null, rate: 0.35 },\n    ],\n    vatRate: 0.12,\n    capitalGainsTaxRate: 0.15,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 35,\n    rentIndex: 12,\n    groceriesIndex: 42,\n    purchasingPowerIndex: 35,\n    averageMonthlyIncome: 35000,\n    medianMonthlyIncome: 20000,\n    luxuryPricing: {\n      lamborghiniUrus: 35000000,\n      lamborghiniHuracan: 40000000,\n      porsche911: 15000000,\n      rolexSubmariner: 700000,\n      medianHomePriceCity: 10000000,\n      medianHomePriceSuburb: 4000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'emerging',\n    financialRegulations: ['BIR tax authority', 'SSS/GSIS social security', 'TRAIN tax reform law'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  // More countries for global coverage\n  NZ: {\n    countryCode: 'NZ',\n    countryName: 'New Zealand',\n    currency: 'NZD',\n    currencySymbol: 'NZ$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 15600, rate: 0.105 },\n      { minIncome: 15600, maxIncome: 53500, rate: 0.175 },\n      { minIncome: 53500, maxIncome: 78100, rate: 0.30 },\n      { minIncome: 78100, maxIncome: 180000, rate: 0.33 },\n      { minIncome: 180000, maxIncome: null, rate: 0.39 },\n    ],\n    vatRate: 0.15, // GST\n    capitalGainsTaxRate: 0, // No general capital gains tax\n    corporateTaxRate: 0.28,\n    costOfLivingIndex: 72,\n    rentIndex: 42,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 85,\n    averageMonthlyIncome: 6200,\n    medianMonthlyIncome: 5000,\n    luxuryPricing: {\n      lamborghiniUrus: 550000,\n      lamborghiniHuracan: 620000,\n      porsche911: 280000,\n      rolexSubmariner: 18000,\n      medianHomePriceCity: 1100000,\n      medianHomePriceSuburb: 750000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['IRD tax authority', 'KiwiSaver retirement scheme', 'No capital gains tax (except bright-line)'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  IL: {\n    countryCode: 'IL',\n    countryName: 'Israel',\n    currency: 'ILS',\n    currencySymbol: '₪',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 81480, rate: 0.10 },\n      { minIncome: 81480, maxIncome: 116760, rate: 0.14 },\n      { minIncome: 116760, maxIncome: 187440, rate: 0.20 },\n      { minIncome: 187440, maxIncome: 260520, rate: 0.31 },\n      { minIncome: 260520, maxIncome: 542160, rate: 0.35 },\n      { minIncome: 542160, maxIncome: 698280, rate: 0.47 },\n      { minIncome: 698280, maxIncome: null, rate: 0.50 },\n    ],\n    vatRate: 0.17,\n    capitalGainsTaxRate: 0.25,\n    corporateTaxRate: 0.23,\n    costOfLivingIndex: 85,\n    rentIndex: 55,\n    groceriesIndex: 80,\n    purchasingPowerIndex: 78,\n    averageMonthlyIncome: 12500,\n    medianMonthlyIncome: 9800,\n    luxuryPricing: {\n      lamborghiniUrus: 1800000,\n      lamborghiniHuracan: 2100000,\n      porsche911: 900000,\n      rolexSubmariner: 60000,\n      medianHomePriceCity: 3500000,\n      medianHomePriceSuburb: 2200000,\n    },\n    region: 'middle_east',\n    economicSystem: 'developed',\n    financialRegulations: ['ITA tax authority', 'Pension funds mandatory', 'High-tech industry benefits'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  TR: {\n    countryCode: 'TR',\n    countryName: 'Turkey',\n    currency: 'TRY',\n    currencySymbol: '₺',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 110000, rate: 0.15 },\n      { minIncome: 110000, maxIncome: 230000, rate: 0.20 },\n      { minIncome: 230000, maxIncome: 580000, rate: 0.27 },\n      { minIncome: 580000, maxIncome: 3000000, rate: 0.35 },\n      { minIncome: 3000000, maxIncome: null, rate: 0.40 },\n    ],\n    vatRate: 0.20,\n    capitalGainsTaxRate: 0.10,\n    corporateTaxRate: 0.25,\n    costOfLivingIndex: 28,\n    rentIndex: 10,\n    groceriesIndex: 32,\n    purchasingPowerIndex: 35,\n    averageMonthlyIncome: 35000,\n    medianMonthlyIncome: 22000,\n    luxuryPricing: {\n      lamborghiniUrus: 35000000,\n      lamborghiniHuracan: 40000000,\n      porsche911: 12000000,\n      rolexSubmariner: 800000,\n      medianHomePriceCity: 8000000,\n      medianHomePriceSuburb: 4000000,\n    },\n    region: 'europe',\n    economicSystem: 'emerging',\n    financialRegulations: ['GIB tax authority', 'High inflation environment', 'Heavy ÖTV tax on vehicles'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  RU: {\n    countryCode: 'RU',\n    countryName: 'Russia',\n    currency: 'RUB',\n    currencySymbol: '₽',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 5000000, rate: 0.13 },\n      { minIncome: 5000000, maxIncome: null, rate: 0.15 },\n    ],\n    vatRate: 0.20,\n    capitalGainsTaxRate: 0.13,\n    corporateTaxRate: 0.20,\n    costOfLivingIndex: 32,\n    rentIndex: 15,\n    groceriesIndex: 35,\n    purchasingPowerIndex: 42,\n    averageMonthlyIncome: 75000,\n    medianMonthlyIncome: 50000,\n    luxuryPricing: {\n      lamborghiniUrus: 35000000,\n      lamborghiniHuracan: 40000000,\n      porsche911: 18000000,\n      rolexSubmariner: 1500000,\n      medianHomePriceCity: 20000000,\n      medianHomePriceSuburb: 10000000,\n    },\n    region: 'europe',\n    economicSystem: 'emerging',\n    financialRegulations: ['FNS tax authority', 'Flat income tax rate', 'International sanctions impact'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  HK: {\n    countryCode: 'HK',\n    countryName: 'Hong Kong',\n    currency: 'HKD',\n    currencySymbol: 'HK$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 50000, rate: 0.02 },\n      { minIncome: 50000, maxIncome: 100000, rate: 0.06 },\n      { minIncome: 100000, maxIncome: 150000, rate: 0.10 },\n      { minIncome: 150000, maxIncome: 200000, rate: 0.14 },\n      { minIncome: 200000, maxIncome: null, rate: 0.17 },\n    ],\n    vatRate: 0, // No VAT/GST\n    capitalGainsTaxRate: 0, // No capital gains tax\n    corporateTaxRate: 0.165,\n    costOfLivingIndex: 82,\n    rentIndex: 90,\n    groceriesIndex: 75,\n    purchasingPowerIndex: 95,\n    averageMonthlyIncome: 32000,\n    medianMonthlyIncome: 22000,\n    luxuryPricing: {\n      lamborghiniUrus: 3200000,\n      lamborghiniHuracan: 3700000,\n      porsche911: 1600000,\n      rolexSubmariner: 95000,\n      medianHomePriceCity: 12000000,\n      medianHomePriceSuburb: 8000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['IRD tax authority', 'No capital gains tax', 'Territorial tax system', 'MPF mandatory pension'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  TW: {\n    countryCode: 'TW',\n    countryName: 'Taiwan',\n    currency: 'TWD',\n    currencySymbol: 'NT$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 560000, rate: 0.05 },\n      { minIncome: 560000, maxIncome: 1260000, rate: 0.12 },\n      { minIncome: 1260000, maxIncome: 2520000, rate: 0.20 },\n      { minIncome: 2520000, maxIncome: 4720000, rate: 0.30 },\n      { minIncome: 4720000, maxIncome: null, rate: 0.40 },\n    ],\n    vatRate: 0.05, // Business tax\n    capitalGainsTaxRate: 0.20,\n    corporateTaxRate: 0.20,\n    costOfLivingIndex: 55,\n    rentIndex: 28,\n    groceriesIndex: 55,\n    purchasingPowerIndex: 70,\n    averageMonthlyIncome: 55000,\n    medianMonthlyIncome: 45000,\n    luxuryPricing: {\n      lamborghiniUrus: 18000000,\n      lamborghiniHuracan: 22000000,\n      porsche911: 7500000,\n      rolexSubmariner: 400000,\n      medianHomePriceCity: 25000000,\n      medianHomePriceSuburb: 12000000,\n    },\n    region: 'asia_pacific',\n    economicSystem: 'developed',\n    financialRegulations: ['MOF tax authority', 'NHI universal healthcare', 'Labor pension fund'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  CL: {\n    countryCode: 'CL',\n    countryName: 'Chile',\n    currency: 'CLP',\n    currencySymbol: '$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 8952480, rate: 0 },\n      { minIncome: 8952480, maxIncome: 19894400, rate: 0.04 },\n      { minIncome: 19894400, maxIncome: 33157333, rate: 0.08 },\n      { minIncome: 33157333, maxIncome: 46420266, rate: 0.135 },\n      { minIncome: 46420266, maxIncome: 59683200, rate: 0.23 },\n      { minIncome: 59683200, maxIncome: 79577600, rate: 0.304 },\n      { minIncome: 79577600, maxIncome: null, rate: 0.40 },\n    ],\n    vatRate: 0.19,\n    capitalGainsTaxRate: 0.20,\n    corporateTaxRate: 0.27,\n    costOfLivingIndex: 42,\n    rentIndex: 20,\n    groceriesIndex: 50,\n    purchasingPowerIndex: 45,\n    averageMonthlyIncome: 900000,\n    medianMonthlyIncome: 650000,\n    luxuryPricing: {\n      lamborghiniUrus: 350000000,\n      lamborghiniHuracan: 400000000,\n      porsche911: 120000000,\n      rolexSubmariner: 12000000,\n      medianHomePriceCity: 250000000,\n      medianHomePriceSuburb: 150000000,\n    },\n    region: 'latin_america',\n    economicSystem: 'emerging',\n    financialRegulations: ['SII tax authority', 'AFP pension system', 'Low import tariffs'],\n    lastUpdated: '2025-01-01',\n  },\n  \n  CO: {\n    countryCode: 'CO',\n    countryName: 'Colombia',\n    currency: 'COP',\n    currencySymbol: '$',\n    incomeTaxBrackets: [\n      { minIncome: 0, maxIncome: 49850000, rate: 0 },\n      { minIncome: 49850000, maxIncome: 87890000, rate: 0.19 },\n      { minIncome: 87890000, maxIncome: 147680000, rate: 0.28 },\n      { minIncome: 147680000, maxIncome: 349960000, rate: 0.33 },\n      { minIncome: 349960000, maxIncome: 792290000, rate: 0.35 },\n      { minIncome: 792290000, maxIncome: 1332270000, rate: 0.37 },\n      { minIncome: 1332270000, maxIncome: null, rate: 0.39 },\n    ],\n    vatRate: 0.19,\n    capitalGainsTaxRate: 0.10,\n    corporateTaxRate: 0.35,\n    costOfLivingIndex: 28,\n    rentIndex: 10,\n    groceriesIndex: 30,\n    purchasingPowerIndex: 32,\n    averageMonthlyIncome: 3000000,\n    medianMonthlyIncome: 1800000,\n    luxuryPricing: {\n      lamborghiniUrus: 1800000000,\n      lamborghiniHuracan: 2100000000,\n      porsche911: 600000000,\n      rolexSubmariner: 55000000,\n      medianHomePriceCity: 800000000,\n      medianHomePriceSuburb: 350000000,\n    },\n    region: 'latin_america',\n    economicSystem: 'emerging',\n    financialRegulations: ['DIAN tax authority', 'Wealth tax on high earners', 'Pension fund contributions mandatory'],\n    lastUpdated: '2025-01-01',\n  },\n};\n\n// Default fallback for countries not in our database\nconst DEFAULT_COUNTRY_CONTEXT: CountryFinancialContext = {\n  countryCode: 'XX',\n  countryName: 'Unknown Country',\n  currency: 'USD',\n  currencySymbol: '$',\n  incomeTaxBrackets: [\n    { minIncome: 0, maxIncome: 50000, rate: 0.15 },\n    { minIncome: 50000, maxIncome: 100000, rate: 0.25 },\n    { minIncome: 100000, maxIncome: null, rate: 0.35 },\n  ],\n  vatRate: 0.15,\n  capitalGainsTaxRate: 0.15,\n  corporateTaxRate: 0.25,\n  costOfLivingIndex: 50,\n  rentIndex: 25,\n  groceriesIndex: 50,\n  purchasingPowerIndex: 50,\n  averageMonthlyIncome: 3000,\n  medianMonthlyIncome: 2000,\n  luxuryPricing: {\n    lamborghiniUrus: 300000,\n    lamborghiniHuracan: 350000,\n    porsche911: 150000,\n    rolexSubmariner: 12000,\n    medianHomePriceCity: 500000,\n    medianHomePriceSuburb: 300000,\n  },\n  region: 'europe',\n  economicSystem: 'developing',\n  financialRegulations: ['Standard tax regulations apply', 'Consult local tax authority'],\n  lastUpdated: '2025-01-01',\n};\n\n// Cache for country data with TTL\nconst countryCache = new Map<string, { data: CountryFinancialContext; timestamp: number }>();\nconst CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24 hours\n\n/**\n * CountryKnowledgeService - Main service class\n */\nclass CountryKnowledgeService {\n  /**\n   * Get financial context for a specific country\n   */\n  getCountryContext(countryCode: string): CountryFinancialContext {\n    const normalizedCode = countryCode.toUpperCase();\n    \n    // Check cache first\n    const cached = countryCache.get(normalizedCode);\n    if (cached && Date.now() - cached.timestamp < CACHE_TTL_MS) {\n      return cached.data;\n    }\n    \n    // Get from data or use default\n    const data = COUNTRY_DATA[normalizedCode] || {\n      ...DEFAULT_COUNTRY_CONTEXT,\n      countryCode: normalizedCode,\n      countryName: this.getCountryName(normalizedCode),\n    };\n    \n    // Cache the result\n    countryCache.set(normalizedCode, { data, timestamp: Date.now() });\n    \n    return data;\n  }\n  \n  /**\n   * Get country name from ISO code\n   */\n  private getCountryName(code: string): string {\n    const countryNames: Record<string, string> = {\n      AF: 'Afghanistan', AL: 'Albania', DZ: 'Algeria', AD: 'Andorra', AO: 'Angola',\n      AG: 'Antigua and Barbuda', AM: 'Armenia', AZ: 'Azerbaijan', BS: 'Bahamas',\n      BH: 'Bahrain', BD: 'Bangladesh', BB: 'Barbados', BY: 'Belarus', BZ: 'Belize',\n      BJ: 'Benin', BT: 'Bhutan', BO: 'Bolivia', BA: 'Bosnia and Herzegovina',\n      BW: 'Botswana', BN: 'Brunei', BG: 'Bulgaria', BF: 'Burkina Faso', BI: 'Burundi',\n      CV: 'Cabo Verde', KH: 'Cambodia', CM: 'Cameroon', CF: 'Central African Republic',\n      TD: 'Chad', CR: 'Costa Rica', CI: \"Cote d'Ivoire\", HR: 'Croatia', CU: 'Cuba',\n      CY: 'Cyprus', CZ: 'Czech Republic', CD: 'DR Congo', DJ: 'Djibouti', DM: 'Dominica',\n      DO: 'Dominican Republic', EC: 'Ecuador', SV: 'El Salvador', GQ: 'Equatorial Guinea',\n      ER: 'Eritrea', EE: 'Estonia', SZ: 'Eswatini', ET: 'Ethiopia', FJ: 'Fiji',\n      FI: 'Finland', GA: 'Gabon', GM: 'Gambia', GE: 'Georgia', GH: 'Ghana', GR: 'Greece',\n      GD: 'Grenada', GT: 'Guatemala', GN: 'Guinea', GW: 'Guinea-Bissau', GY: 'Guyana',\n      HT: 'Haiti', HN: 'Honduras', HU: 'Hungary', IS: 'Iceland', IQ: 'Iraq',\n      JM: 'Jamaica', JO: 'Jordan', KZ: 'Kazakhstan', KE: 'Kenya', KI: 'Kiribati',\n      KP: 'North Korea', KW: 'Kuwait', KG: 'Kyrgyzstan', LA: 'Laos', LV: 'Latvia',\n      LB: 'Lebanon', LS: 'Lesotho', LR: 'Liberia', LY: 'Libya', LI: 'Liechtenstein',\n      LT: 'Lithuania', LU: 'Luxembourg', MG: 'Madagascar', MW: 'Malawi', MV: 'Maldives',\n      ML: 'Mali', MT: 'Malta', MH: 'Marshall Islands', MR: 'Mauritania', MU: 'Mauritius',\n      FM: 'Micronesia', MD: 'Moldova', MC: 'Monaco', MN: 'Mongolia', ME: 'Montenegro',\n      MA: 'Morocco', MZ: 'Mozambique', MM: 'Myanmar', NA: 'Namibia', NR: 'Nauru',\n      NP: 'Nepal', NI: 'Nicaragua', NE: 'Niger', MK: 'North Macedonia', OM: 'Oman',\n      PK: 'Pakistan', PW: 'Palau', PA: 'Panama', PG: 'Papua New Guinea', PY: 'Paraguay',\n      PE: 'Peru', QA: 'Qatar', RO: 'Romania', RW: 'Rwanda', KN: 'Saint Kitts and Nevis',\n      LC: 'Saint Lucia', VC: 'Saint Vincent', WS: 'Samoa', SM: 'San Marino',\n      ST: 'Sao Tome and Principe', SN: 'Senegal', RS: 'Serbia', SC: 'Seychelles',\n      SL: 'Sierra Leone', SK: 'Slovakia', SI: 'Slovenia', SB: 'Solomon Islands',\n      SO: 'Somalia', SS: 'South Sudan', LK: 'Sri Lanka', SD: 'Sudan', SR: 'Suriname',\n      SY: 'Syria', TJ: 'Tajikistan', TZ: 'Tanzania', TL: 'Timor-Leste', TG: 'Togo',\n      TO: 'Tonga', TT: 'Trinidad and Tobago', TN: 'Tunisia', TM: 'Turkmenistan',\n      TV: 'Tuvalu', UG: 'Uganda', UA: 'Ukraine', UY: 'Uruguay', UZ: 'Uzbekistan',\n      VU: 'Vanuatu', VE: 'Venezuela', YE: 'Yemen', ZM: 'Zambia', ZW: 'Zimbabwe',\n    };\n    return countryNames[code] || 'Unknown Country';\n  }\n  \n  /**\n   * Get list of all supported countries with full data\n   */\n  getSupportedCountries(): { code: string; name: string; hasFullData: boolean }[] {\n    const allCountries = new Set([\n      ...Object.keys(COUNTRY_DATA),\n      ...['AF', 'AL', 'DZ', 'AD', 'AO', 'AG', 'AM', 'AZ', 'BS', 'BH', 'BD', 'BB', 'BY', 'BZ',\n          'BJ', 'BT', 'BO', 'BA', 'BW', 'BN', 'BG', 'BF', 'BI', 'CV', 'KH', 'CM', 'CF', 'TD',\n          'CR', 'CI', 'HR', 'CU', 'CY', 'CZ', 'CD', 'DJ', 'DM', 'DO', 'EC', 'SV', 'GQ', 'ER',\n          'EE', 'SZ', 'ET', 'FJ', 'FI', 'GA', 'GM', 'GE', 'GH', 'GR', 'GD', 'GT', 'GN', 'GW',\n          'GY', 'HT', 'HN', 'HU', 'IS', 'IQ', 'JM', 'JO', 'KZ', 'KE', 'KI', 'KP', 'KW', 'KG',\n          'LA', 'LV', 'LB', 'LS', 'LR', 'LY', 'LI', 'LT', 'LU', 'MG', 'MW', 'MV', 'ML', 'MT',\n          'MH', 'MR', 'MU', 'FM', 'MD', 'MC', 'MN', 'ME', 'MA', 'MZ', 'MM', 'NA', 'NR', 'NP',\n          'NI', 'NE', 'MK', 'OM', 'PK', 'PW', 'PA', 'PG', 'PY', 'PE', 'QA', 'RO', 'RW', 'KN',\n          'LC', 'VC', 'WS', 'SM', 'ST', 'SN', 'RS', 'SC', 'SL', 'SK', 'SI', 'SB', 'SO', 'SS',\n          'LK', 'SD', 'SR', 'SY', 'TJ', 'TZ', 'TL', 'TG', 'TO', 'TT', 'TN', 'TM', 'TV', 'UG',\n          'UA', 'UY', 'UZ', 'VU', 'VE', 'YE', 'ZM', 'ZW'],\n    ]);\n    \n    return Array.from(allCountries).map(code => ({\n      code,\n      name: COUNTRY_DATA[code]?.countryName || this.getCountryName(code),\n      hasFullData: code in COUNTRY_DATA,\n    })).sort((a, b) => a.name.localeCompare(b.name));\n  }\n  \n  /**\n   * Calculate effective income tax for a given income in a country\n   */\n  calculateIncomeTax(countryCode: string, annualIncome: number): { totalTax: number; effectiveRate: number; brackets: { range: string; tax: number; rate: number }[] } {\n    const context = this.getCountryContext(countryCode);\n    const brackets: { range: string; tax: number; rate: number }[] = [];\n    let totalTax = 0;\n    let remainingIncome = annualIncome;\n    \n    for (const bracket of context.incomeTaxBrackets) {\n      if (remainingIncome <= 0) break;\n      \n      const bracketMin = bracket.minIncome;\n      const bracketMax = bracket.maxIncome ?? Infinity;\n      const bracketSize = bracketMax - bracketMin;\n      const taxableInThisBracket = Math.min(remainingIncome, bracketSize);\n      const taxInBracket = taxableInThisBracket * bracket.rate;\n      \n      if (taxableInThisBracket > 0) {\n        brackets.push({\n          range: `${context.currencySymbol}${bracketMin.toLocaleString()} - ${bracket.maxIncome ? context.currencySymbol + bracketMax.toLocaleString() : 'Above'}`,\n          tax: taxInBracket,\n          rate: bracket.rate * 100,\n        });\n        totalTax += taxInBracket;\n      }\n      \n      remainingIncome -= taxableInThisBracket;\n    }\n    \n    return {\n      totalTax,\n      effectiveRate: annualIncome > 0 ? (totalTax / annualIncome) * 100 : 0,\n      brackets,\n    };\n  }\n  \n  /**\n   * Generate AI-friendly context summary for a country\n   */\n  generateAIContextSummary(countryCode: string): string {\n    const ctx = this.getCountryContext(countryCode);\n    \n    const effectiveTaxExample = this.calculateIncomeTax(countryCode, ctx.averageMonthlyIncome * 12);\n    \n    return `\nCOUNTRY FINANCIAL CONTEXT: ${ctx.countryName} (${ctx.countryCode})\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nCURRENCY & ECONOMY:\n• Currency: ${ctx.currency} (${ctx.currencySymbol})\n• Economic Status: ${ctx.economicSystem.charAt(0).toUpperCase() + ctx.economicSystem.slice(1)} market\n• Region: ${ctx.region.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}\n\nTAXATION:\n• VAT/Sales Tax: ${(ctx.vatRate * 100).toFixed(1)}%\n• Capital Gains Tax: ${(ctx.capitalGainsTaxRate * 100).toFixed(1)}%\n• Corporate Tax: ${(ctx.corporateTaxRate * 100).toFixed(1)}%\n• Income Tax (avg earner): ~${effectiveTaxExample.effectiveRate.toFixed(1)}% effective rate\n• Top Marginal Rate: ${(ctx.incomeTaxBrackets[ctx.incomeTaxBrackets.length - 1].rate * 100).toFixed(1)}%\n\nCOST OF LIVING (NYC = 100 baseline):\n• Overall Index: ${ctx.costOfLivingIndex}\n• Rent Index: ${ctx.rentIndex}\n• Groceries Index: ${ctx.groceriesIndex}\n• Purchasing Power: ${ctx.purchasingPowerIndex}\n\nINCOME LEVELS (in ${ctx.currency}):\n• Average Monthly: ${ctx.currencySymbol}${ctx.averageMonthlyIncome.toLocaleString()}\n• Median Monthly: ${ctx.currencySymbol}${ctx.medianMonthlyIncome.toLocaleString()}\n\nLUXURY GOODS PRICING (in ${ctx.currency}):\n• Lamborghini Urus: ${ctx.currencySymbol}${ctx.luxuryPricing.lamborghiniUrus.toLocaleString()}\n• Lamborghini Huracan: ${ctx.currencySymbol}${ctx.luxuryPricing.lamborghiniHuracan.toLocaleString()}\n• Porsche 911: ${ctx.currencySymbol}${ctx.luxuryPricing.porsche911.toLocaleString()}\n• Rolex Submariner: ${ctx.currencySymbol}${ctx.luxuryPricing.rolexSubmariner.toLocaleString()}\n• Median Home (City): ${ctx.currencySymbol}${ctx.luxuryPricing.medianHomePriceCity.toLocaleString()}\n• Median Home (Suburb): ${ctx.currencySymbol}${ctx.luxuryPricing.medianHomePriceSuburb.toLocaleString()}\n\nLOCAL REGULATIONS:\n${ctx.financialRegulations.map(r => `• ${r}`).join('\\n')}\n\nUse these figures when providing financial advice. All monetary values are in local currency (${ctx.currency}) unless the user specifies otherwise.\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;\n  }\n  \n  /**\n   * Compare cost of living between two countries\n   */\n  compareCostOfLiving(countryCode1: string, countryCode2: string): {\n    country1: string;\n    country2: string;\n    overallDifference: number; // Percentage difference\n    rentDifference: number;\n    groceriesDifference: number;\n    purchasingPowerDifference: number;\n    summary: string;\n  } {\n    const ctx1 = this.getCountryContext(countryCode1);\n    const ctx2 = this.getCountryContext(countryCode2);\n    \n    const calcDiff = (a: number, b: number) => ((b - a) / a) * 100;\n    \n    const overall = calcDiff(ctx1.costOfLivingIndex, ctx2.costOfLivingIndex);\n    const rent = calcDiff(ctx1.rentIndex, ctx2.rentIndex);\n    const groceries = calcDiff(ctx1.groceriesIndex, ctx2.groceriesIndex);\n    const purchasing = calcDiff(ctx1.purchasingPowerIndex, ctx2.purchasingPowerIndex);\n    \n    const moreExpensive = overall > 0 ? ctx2.countryName : ctx1.countryName;\n    const lessExpensive = overall > 0 ? ctx1.countryName : ctx2.countryName;\n    \n    return {\n      country1: ctx1.countryName,\n      country2: ctx2.countryName,\n      overallDifference: overall,\n      rentDifference: rent,\n      groceriesDifference: groceries,\n      purchasingPowerDifference: purchasing,\n      summary: `${moreExpensive} is ${Math.abs(overall).toFixed(0)}% more expensive than ${lessExpensive} overall. ` +\n        `Rent is ${Math.abs(rent).toFixed(0)}% ${rent > 0 ? 'higher' : 'lower'} in ${ctx2.countryName}, ` +\n        `and purchasing power is ${Math.abs(purchasing).toFixed(0)}% ${purchasing > 0 ? 'stronger' : 'weaker'}.`,\n    };\n  }\n}\n\n// Export singleton instance\nexport const countryKnowledgeService = new CountryKnowledgeService();\n","path":null,"size_bytes":65400,"size_tokens":null},"client/src/components/ui/page-shell.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\ninterface PageHeaderProps {\n  title: string;\n  description?: string;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nexport function PageHeader({ title, description, children, className }: PageHeaderProps) {\n  return (\n    <header className={cn(\n      \"bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\",\n      \"border-b border-border/40 sticky top-0 z-30\",\n      className\n    )}>\n      <div className=\"w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-6\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex-1 min-w-0\">\n            <h1 className=\"text-2xl sm:text-3xl font-semibold tracking-tight text-foreground\">\n              {title}\n            </h1>\n            {description && (\n              <p className=\"text-sm text-muted-foreground mt-1\">{description}</p>\n            )}\n          </div>\n          {children && (\n            <div className=\"flex items-center gap-3 flex-shrink-0\">\n              {children}\n            </div>\n          )}\n        </div>\n      </div>\n    </header>\n  );\n}\n\ninterface PageContainerProps {\n  children: React.ReactNode;\n  className?: string;\n  maxWidth?: \"sm\" | \"md\" | \"lg\" | \"xl\" | \"2xl\" | \"full\";\n}\n\nexport function PageContainer({ children, className, maxWidth = \"xl\" }: PageContainerProps) {\n  const maxWidthClasses = {\n    sm: \"max-w-2xl\",\n    md: \"max-w-4xl\",\n    lg: \"max-w-5xl\",\n    xl: \"max-w-7xl\",\n    \"2xl\": \"max-w-[1400px]\",\n    full: \"max-w-full\",\n  };\n\n  return (\n    <div className={cn(\n      \"w-full mx-auto px-4 sm:px-6 lg:px-8 xl:px-12 py-8 sm:py-12\",\n      maxWidthClasses[maxWidth],\n      className\n    )}>\n      {children}\n    </div>\n  );\n}\n\ninterface SectionHeaderProps {\n  title: string;\n  description?: string;\n  action?: React.ReactNode;\n  className?: string;\n}\n\nexport function SectionHeader({ title, description, action, className }: SectionHeaderProps) {\n  return (\n    <div className={cn(\"flex items-start justify-between gap-4 mb-6\", className)}>\n      <div>\n        <h2 className=\"text-xl font-semibold text-foreground\">{title}</h2>\n        {description && (\n          <p className=\"text-sm text-muted-foreground mt-1\">{description}</p>\n        )}\n      </div>\n      {action && <div className=\"flex-shrink-0\">{action}</div>}\n    </div>\n  );\n}\n\ninterface StatCardProps {\n  title: string;\n  value: string | number;\n  unit?: string;\n  trend?: {\n    value: number;\n    label?: string;\n  };\n  icon?: React.ReactNode;\n  className?: string;\n}\n\nexport function StatCard({ title, value, unit, trend, icon, className }: StatCardProps) {\n  return (\n    <div className={cn(\n      \"bg-card border border-border/50 rounded-xl p-5\",\n      className\n    )}>\n      <div className=\"flex items-center gap-2 mb-3\">\n        {icon && (\n          <div className=\"text-muted-foreground\">\n            {icon}\n          </div>\n        )}\n        <span className=\"text-sm font-medium text-muted-foreground\">{title}</span>\n      </div>\n      <div className=\"flex items-baseline gap-1.5\">\n        <span className=\"text-2xl sm:text-3xl font-bold text-foreground tabular-nums\">\n          {value}\n        </span>\n        {unit && (\n          <span className=\"text-lg text-muted-foreground\">{unit}</span>\n        )}\n      </div>\n      {trend && (\n        <div className={cn(\n          \"text-xs font-medium mt-2\",\n          trend.value >= 0 ? \"text-green-600 dark:text-green-400\" : \"text-red-600 dark:text-red-400\"\n        )}>\n          {trend.value >= 0 ? \"+\" : \"\"}{trend.value}%\n          {trend.label && <span className=\"text-muted-foreground ml-1\">{trend.label}</span>}\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface MetricGridProps {\n  children: React.ReactNode;\n  columns?: 2 | 3 | 4;\n  className?: string;\n}\n\nexport function MetricGrid({ children, columns = 4, className }: MetricGridProps) {\n  const columnClasses = {\n    2: \"grid-cols-1 sm:grid-cols-2\",\n    3: \"grid-cols-1 sm:grid-cols-2 lg:grid-cols-3\",\n    4: \"grid-cols-1 sm:grid-cols-2 lg:grid-cols-4\",\n  };\n\n  return (\n    <div className={cn(\n      \"grid gap-4 sm:gap-6\",\n      columnClasses[columns],\n      className\n    )}>\n      {children}\n    </div>\n  );\n}\n\ninterface EmptyStateProps {\n  icon: React.ReactNode;\n  title: string;\n  description?: string;\n  action?: React.ReactNode;\n  className?: string;\n}\n\nexport function EmptyState({ icon, title, description, action, className }: EmptyStateProps) {\n  return (\n    <div className={cn(\n      \"flex flex-col items-center justify-center text-center py-12 px-6\",\n      className\n    )}>\n      <div className=\"w-16 h-16 mb-4 text-muted-foreground/40\">\n        {icon}\n      </div>\n      <h3 className=\"text-lg font-semibold text-foreground mb-2\">{title}</h3>\n      {description && (\n        <p className=\"text-sm text-muted-foreground max-w-sm mb-6\">{description}</p>\n      )}\n      {action}\n    </div>\n  );\n}\n","path":null,"size_bytes":4868,"size_tokens":null},"server/utils/logger.ts":{"content":"/**\n * Structured Logger for Production Observability\n * \n * Features:\n * - JSON-structured logs for easy parsing\n * - Log levels (debug, info, warn, error)\n * - Request context tracking\n * - Performance timing utilities\n * - Environment-aware formatting\n */\n\nexport type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\ninterface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  message: string;\n  context?: string;\n  userId?: string;\n  requestId?: string;\n  duration?: number;\n  error?: {\n    name: string;\n    message: string;\n    stack?: string;\n  };\n  data?: Record<string, unknown>;\n}\n\n// Log level priority for filtering\nconst LOG_LEVELS: Record<LogLevel, number> = {\n  debug: 0,\n  info: 1,\n  warn: 2,\n  error: 3,\n};\n\n// Get minimum log level from environment\nfunction getMinLogLevel(): LogLevel {\n  const env = process.env.LOG_LEVEL?.toLowerCase();\n  if (env && env in LOG_LEVELS) {\n    return env as LogLevel;\n  }\n  // Default to 'info' in production, 'debug' in development\n  return process.env.NODE_ENV === 'production' ? 'info' : 'debug';\n}\n\nconst minLogLevel = getMinLogLevel();\nconst isProduction = process.env.NODE_ENV === 'production';\n\n/**\n * Format log entry for output\n */\nfunction formatLogEntry(entry: LogEntry): string {\n  if (isProduction) {\n    // JSON format for production (easy to parse by log aggregators)\n    return JSON.stringify(entry);\n  }\n  \n  // Pretty format for development\n  const { timestamp, level, context, message, duration, error, data, userId, requestId } = entry;\n  const levelColor = {\n    debug: '\\x1b[36m', // cyan\n    info: '\\x1b[32m',  // green\n    warn: '\\x1b[33m',  // yellow\n    error: '\\x1b[31m', // red\n  }[level];\n  const reset = '\\x1b[0m';\n  \n  let output = `${timestamp} ${levelColor}[${level.toUpperCase()}]${reset}`;\n  if (context) output += ` [${context}]`;\n  if (requestId) output += ` (req:${requestId.slice(0, 8)})`;\n  if (userId) output += ` (user:${userId.slice(0, 8)})`;\n  output += ` ${message}`;\n  if (duration !== undefined) output += ` (${duration}ms)`;\n  if (data) output += ` ${JSON.stringify(data)}`;\n  if (error) output += `\\n  Error: ${error.message}${error.stack ? '\\n' + error.stack : ''}`;\n  \n  return output;\n}\n\n/**\n * Write log entry\n */\nfunction writeLog(entry: LogEntry): void {\n  // Filter by minimum log level\n  if (LOG_LEVELS[entry.level] < LOG_LEVELS[minLogLevel]) {\n    return;\n  }\n  \n  const formatted = formatLogEntry(entry);\n  \n  if (entry.level === 'error') {\n    console.error(formatted);\n  } else if (entry.level === 'warn') {\n    console.warn(formatted);\n  } else {\n    console.log(formatted);\n  }\n}\n\n/**\n * Create a scoped logger with context\n */\nexport function createLogger(context: string) {\n  const log = (level: LogLevel, message: string, options?: Partial<LogEntry>) => {\n    writeLog({\n      timestamp: new Date().toISOString(),\n      level,\n      context,\n      message,\n      ...options,\n    });\n  };\n  \n  return {\n    debug: (message: string, options?: Partial<LogEntry>) => log('debug', message, options),\n    info: (message: string, options?: Partial<LogEntry>) => log('info', message, options),\n    warn: (message: string, options?: Partial<LogEntry>) => log('warn', message, options),\n    error: (message: string, error?: Error | unknown, options?: Partial<LogEntry>) => {\n      const errorData = error instanceof Error ? {\n        name: error.name,\n        message: error.message,\n        stack: error.stack,\n      } : error ? { message: String(error) } : undefined;\n      \n      log('error', message, { ...options, error: errorData as any });\n    },\n  };\n}\n\n/**\n * Request-scoped logger with timing\n */\nexport function createRequestLogger(context: string, requestId?: string, userId?: string) {\n  const startTime = Date.now();\n  const baseLogger = createLogger(context);\n  \n  return {\n    ...baseLogger,\n    requestId,\n    userId,\n    \n    // Automatically include request context in all logs\n    debug: (message: string, data?: Record<string, unknown>) => \n      baseLogger.debug(message, { requestId, userId, data }),\n    info: (message: string, data?: Record<string, unknown>) => \n      baseLogger.info(message, { requestId, userId, data }),\n    warn: (message: string, data?: Record<string, unknown>) => \n      baseLogger.warn(message, { requestId, userId, data }),\n    error: (message: string, error?: Error | unknown, data?: Record<string, unknown>) => \n      baseLogger.error(message, error, { requestId, userId, data }),\n    \n    // Log with timing since request started\n    timed: (level: LogLevel, message: string, data?: Record<string, unknown>) => {\n      const duration = Date.now() - startTime;\n      writeLog({\n        timestamp: new Date().toISOString(),\n        level,\n        context,\n        message,\n        requestId,\n        userId,\n        duration,\n        data,\n      });\n    },\n    \n    // Get duration since request started\n    getDuration: () => Date.now() - startTime,\n  };\n}\n\n/**\n * Performance timing utility\n */\nexport function createTimer(label: string) {\n  const start = Date.now();\n  \n  return {\n    label,\n    elapsed: () => Date.now() - start,\n    end: () => {\n      const duration = Date.now() - start;\n      return { label, duration };\n    },\n  };\n}\n\n// Pre-configured loggers for common contexts\nexport const aiLogger = createLogger('AI');\nexport const authLogger = createLogger('Auth');\nexport const stripeLogger = createLogger('Stripe');\nexport const dbLogger = createLogger('Database');\nexport const apiLogger = createLogger('API');\n\n// Default export for quick usage\nexport default createLogger;\n","path":null,"size_bytes":5555,"size_tokens":null},"client/src/pages/terms.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\n\nexport default function Terms() {\n  const [, setLocation] = useLocation();\n\n  return (\n    <div className=\"min-h-screen bg-slate-950\">\n      <header className=\"border-b border-slate-800 bg-slate-950/80 backdrop-blur-sm sticky top-0 z-50\">\n        <div className=\"max-w-4xl mx-auto px-6 py-4 flex items-center justify-between\">\n          <button\n            onClick={() => setLocation(\"/\")}\n            className=\"flex items-center gap-3\"\n          >\n            <img src={logoUrl} alt=\"Twealth\" className=\"w-8 h-8\" />\n            <span className=\"text-xl font-semibold text-white\">Twealth</span>\n          </button>\n          <Button\n            variant=\"ghost\"\n            onClick={() => window.history.back()}\n            className=\"text-slate-400 hover:text-white\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back\n          </Button>\n        </div>\n      </header>\n\n      <main className=\"max-w-4xl mx-auto px-6 py-12\">\n        <h1 className=\"text-4xl font-bold text-white mb-8\">Terms of Service</h1>\n        \n        <div className=\"prose prose-invert prose-slate max-w-none\">\n          <p className=\"text-slate-400 text-lg mb-8\">\n            Last updated: November 2025\n          </p>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">1. Acceptance of Terms</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              By accessing or using Twealth, you agree to be bound by these Terms of Service. \n              If you do not agree to these terms, please do not use our services.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">2. Description of Service</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              Twealth provides AI-powered financial management tools, including budget tracking, \n              goal setting, and financial insights. Our service is designed to help you make \n              informed financial decisions but does not constitute financial advice.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">3. User Accounts</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              You are responsible for maintaining the confidentiality of your account credentials \n              and for all activities that occur under your account. You agree to notify us \n              immediately of any unauthorized use of your account.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">4. Subscription and Billing</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              Some features require a paid subscription. By subscribing, you agree to pay the \n              applicable fees. Subscriptions auto-renew unless cancelled. You may cancel your \n              subscription at any time through your account settings.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">5. Disclaimer</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              Twealth is not a registered financial advisor, broker, or dealer. The information \n              provided is for educational and informational purposes only. Always consult with \n              a qualified financial professional before making financial decisions.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">6. Limitation of Liability</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              Twealth shall not be liable for any indirect, incidental, special, consequential, \n              or punitive damages arising from your use of the service or any financial decisions \n              made based on information provided by the service.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">7. Changes to Terms</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              We reserve the right to modify these terms at any time. We will notify users of \n              significant changes via email or through the application. Continued use of the \n              service after changes constitutes acceptance of the modified terms.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">8. Contact</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              For questions about these Terms of Service, please contact us at support@twealth.ltd\n            </p>\n          </section>\n        </div>\n      </main>\n\n      <footer className=\"border-t border-slate-800 py-8 mt-12\">\n        <div className=\"max-w-4xl mx-auto px-6 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <img src={logoUrl} alt=\"Twealth\" className=\"w-6 h-6\" />\n            <span className=\"text-sm text-slate-500\">2025 Twealth</span>\n          </div>\n          <div className=\"flex items-center gap-6 text-sm text-slate-500\">\n            <button \n              onClick={() => setLocation(\"/terms\")}\n              className=\"hover:text-slate-300 transition-colors\"\n            >\n              Terms\n            </button>\n            <button \n              onClick={() => setLocation(\"/privacy\")}\n              className=\"hover:text-slate-300 transition-colors\"\n            >\n              Privacy\n            </button>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":6079,"size_tokens":null},"client/src/pages/privacy.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport logoUrl from \"@assets/5-removebg-preview_1761748275134.png\";\n\nexport default function Privacy() {\n  const [, setLocation] = useLocation();\n\n  return (\n    <div className=\"min-h-screen bg-slate-950\">\n      <header className=\"border-b border-slate-800 bg-slate-950/80 backdrop-blur-sm sticky top-0 z-50\">\n        <div className=\"max-w-4xl mx-auto px-6 py-4 flex items-center justify-between\">\n          <button\n            onClick={() => setLocation(\"/\")}\n            className=\"flex items-center gap-3\"\n          >\n            <img src={logoUrl} alt=\"Twealth\" className=\"w-8 h-8\" />\n            <span className=\"text-xl font-semibold text-white\">Twealth</span>\n          </button>\n          <Button\n            variant=\"ghost\"\n            onClick={() => window.history.back()}\n            className=\"text-slate-400 hover:text-white\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back\n          </Button>\n        </div>\n      </header>\n\n      <main className=\"max-w-4xl mx-auto px-6 py-12\">\n        <h1 className=\"text-4xl font-bold text-white mb-8\">Privacy Policy</h1>\n        \n        <div className=\"prose prose-invert prose-slate max-w-none\">\n          <p className=\"text-slate-400 text-lg mb-8\">\n            Last updated: November 2025\n          </p>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">1. Information We Collect</h2>\n            <p className=\"text-slate-300 leading-relaxed mb-4\">\n              We collect information you provide directly, including:\n            </p>\n            <ul className=\"list-disc list-inside text-slate-300 space-y-2 ml-4\">\n              <li>Account information (name, email) from OAuth providers</li>\n              <li>Financial data you input (transactions, goals, budgets)</li>\n              <li>Preferences and settings you configure</li>\n              <li>Communications with our AI assistant</li>\n            </ul>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">2. How We Use Your Information</h2>\n            <p className=\"text-slate-300 leading-relaxed mb-4\">\n              We use your information to:\n            </p>\n            <ul className=\"list-disc list-inside text-slate-300 space-y-2 ml-4\">\n              <li>Provide and personalize our financial management services</li>\n              <li>Generate AI-powered insights and recommendations</li>\n              <li>Process payments and manage subscriptions</li>\n              <li>Improve our services and develop new features</li>\n              <li>Communicate with you about your account and updates</li>\n            </ul>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">3. Data Security</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              We implement industry-standard security measures to protect your data, including \n              256-bit encryption for data in transit and at rest, secure authentication via \n              OAuth providers, and regular security audits. Your financial data is never sold \n              to third parties.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">4. Data Sharing</h2>\n            <p className=\"text-slate-300 leading-relaxed mb-4\">\n              We do not sell your personal information. We may share data with:\n            </p>\n            <ul className=\"list-disc list-inside text-slate-300 space-y-2 ml-4\">\n              <li>Service providers who assist in operating our platform (e.g., Stripe for payments)</li>\n              <li>AI providers for generating financial insights (data is anonymized where possible)</li>\n              <li>Legal authorities when required by law</li>\n            </ul>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">5. Your Rights</h2>\n            <p className=\"text-slate-300 leading-relaxed mb-4\">\n              You have the right to:\n            </p>\n            <ul className=\"list-disc list-inside text-slate-300 space-y-2 ml-4\">\n              <li>Access your personal data</li>\n              <li>Correct inaccurate information</li>\n              <li>Request deletion of your data</li>\n              <li>Export your data in a portable format</li>\n              <li>Opt out of marketing communications</li>\n            </ul>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">6. Cookies and Tracking</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              We use essential cookies for authentication and session management. We do not use \n              third-party advertising trackers. Analytics data is collected in aggregate form \n              to improve our services.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">7. Data Retention</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              We retain your data for as long as your account is active. Upon account deletion, \n              your personal data will be removed within 30 days, except where retention is \n              required by law.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">8. International Users</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              Twealth is designed to serve users globally. We comply with GDPR for European \n              users and other applicable data protection regulations. Data may be processed \n              in the United States with appropriate safeguards.\n            </p>\n          </section>\n\n          <section className=\"mb-8\">\n            <h2 className=\"text-2xl font-semibold text-white mb-4\">9. Contact</h2>\n            <p className=\"text-slate-300 leading-relaxed\">\n              For privacy-related inquiries or to exercise your rights, please contact us at \n              privacy@twealth.ltd\n            </p>\n          </section>\n        </div>\n      </main>\n\n      <footer className=\"border-t border-slate-800 py-8 mt-12\">\n        <div className=\"max-w-4xl mx-auto px-6 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <img src={logoUrl} alt=\"Twealth\" className=\"w-6 h-6\" />\n            <span className=\"text-sm text-slate-500\">2025 Twealth</span>\n          </div>\n          <div className=\"flex items-center gap-6 text-sm text-slate-500\">\n            <button \n              onClick={() => setLocation(\"/terms\")}\n              className=\"hover:text-slate-300 transition-colors\"\n            >\n              Terms\n            </button>\n            <button \n              onClick={() => setLocation(\"/privacy\")}\n              className=\"hover:text-slate-300 transition-colors\"\n            >\n              Privacy\n            </button>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":7402,"size_tokens":null},"client/src/components/milestone-celebration.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Trophy, Star, Target, Sparkles, X, ChevronRight } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\nimport confetti from \"canvas-confetti\";\n\ninterface GoalMilestone {\n  id: string;\n  goalId: string;\n  userId: string;\n  milestone: number;\n  amountAtMilestone: string;\n  celebratedAt: string;\n  isSeen: boolean;\n  goal: {\n    id: string;\n    title: string;\n    targetAmount: string;\n    currentAmount: string;\n    category: string;\n  };\n}\n\nconst milestoneMessages: Record<number, { title: string; subtitle: string; icon: typeof Trophy }> = {\n  25: {\n    title: \"Quarter Way There\",\n    subtitle: \"You've reached 25% of your goal. Great momentum!\",\n    icon: Star,\n  },\n  50: {\n    title: \"Halfway Champion\",\n    subtitle: \"50% complete! You're crushing this goal.\",\n    icon: Target,\n  },\n  75: {\n    title: \"Almost There\",\n    subtitle: \"75% done! The finish line is in sight.\",\n    icon: Sparkles,\n  },\n  100: {\n    title: \"Goal Achieved\",\n    subtitle: \"Congratulations! You've reached your target.\",\n    icon: Trophy,\n  },\n};\n\nconst milestoneColors: Record<number, { bg: string; border: string; text: string }> = {\n  25: { bg: \"from-blue-500 to-blue-600\", border: \"border-blue-400\", text: \"text-blue-50\" },\n  50: { bg: \"from-violet-500 to-purple-600\", border: \"border-violet-400\", text: \"text-violet-50\" },\n  75: { bg: \"from-amber-500 to-orange-600\", border: \"border-amber-400\", text: \"text-amber-50\" },\n  100: { bg: \"from-emerald-500 to-green-600\", border: \"border-emerald-400\", text: \"text-emerald-50\" },\n};\n\nfunction triggerConfetti(milestone: number) {\n  const intensity = milestone / 100;\n  \n  confetti({\n    particleCount: Math.floor(100 * intensity),\n    spread: 70 + (milestone / 4),\n    origin: { y: 0.6 },\n    colors: milestone === 100 \n      ? ['#ffd700', '#22c55e', '#3b82f6', '#f59e0b']\n      : ['#3b82f6', '#8b5cf6', '#f59e0b'],\n  });\n\n  if (milestone === 100) {\n    setTimeout(() => {\n      confetti({\n        particleCount: 50,\n        angle: 60,\n        spread: 55,\n        origin: { x: 0 },\n        colors: ['#ffd700', '#22c55e'],\n      });\n      confetti({\n        particleCount: 50,\n        angle: 120,\n        spread: 55,\n        origin: { x: 1 },\n        colors: ['#ffd700', '#22c55e'],\n      });\n    }, 250);\n  }\n}\n\nexport function MilestoneCelebration() {\n  const [, setLocation] = useLocation();\n  const [celebrationQueue, setCelebrationQueue] = useState<GoalMilestone[]>([]);\n  const [isShowing, setIsShowing] = useState(false);\n  const [lastSeenMilestoneIds, setLastSeenMilestoneIds] = useState<string[]>([]);\n\n  const { data: milestones = [] } = useQuery<GoalMilestone[]>({\n    queryKey: ['/api/goal-milestones'],\n    staleTime: 1000 * 10,\n    refetchInterval: 1000 * 30,\n  });\n\n  const markSeenMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", \"/api/goal-milestones/mark-seen\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/goal-milestones'] });\n      setLastSeenMilestoneIds([]);\n    },\n    onError: () => {\n      setCelebrationQueue(prev => {\n        const restored = milestones.filter(m => lastSeenMilestoneIds.includes(m.id));\n        return [...restored, ...prev];\n      });\n      setIsShowing(true);\n    },\n  });\n\n  useEffect(() => {\n    if (milestones.length > 0) {\n      const newMilestones = milestones.filter(\n        m => !celebrationQueue.some(q => q.id === m.id) && !lastSeenMilestoneIds.includes(m.id)\n      );\n      if (newMilestones.length > 0) {\n        setCelebrationQueue(prev => [...prev, ...newMilestones]);\n        setIsShowing(true);\n      }\n    }\n  }, [milestones]);\n\n  const currentMilestone = celebrationQueue[0];\n\n  useEffect(() => {\n    if (currentMilestone && isShowing) {\n      triggerConfetti(currentMilestone.milestone);\n    }\n  }, [currentMilestone?.id, isShowing]);\n\n  const handleDismiss = () => {\n    if (!currentMilestone) return;\n    \n    setLastSeenMilestoneIds(prev => [...prev, currentMilestone.id]);\n    setCelebrationQueue(prev => prev.slice(1));\n    \n    if (celebrationQueue.length <= 1) {\n      setIsShowing(false);\n      markSeenMutation.mutate();\n    }\n  };\n\n  const handleViewGoal = () => {\n    if (currentMilestone) {\n      setLocation(`/financial-goals?highlight=${currentMilestone.goalId}`);\n      handleDismiss();\n    }\n  };\n\n  if (!celebrationQueue.length || !isShowing || !currentMilestone) {\n    return null;\n  }\n\n  const message = milestoneMessages[currentMilestone.milestone] || milestoneMessages[25];\n  const colors = milestoneColors[currentMilestone.milestone] || milestoneColors[25];\n  const IconComponent = message.icon;\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\"\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        exit={{ opacity: 0 }}\n        onClick={handleDismiss}\n        data-testid=\"milestone-celebration-overlay\"\n      >\n        <motion.div\n          className={`relative max-w-md w-full mx-4 rounded-3xl bg-gradient-to-br ${colors.bg} p-8 shadow-2xl border ${colors.border}`}\n          initial={{ scale: 0.8, y: 50, opacity: 0 }}\n          animate={{ scale: 1, y: 0, opacity: 1 }}\n          exit={{ scale: 0.8, y: 50, opacity: 0 }}\n          transition={{ type: \"spring\", damping: 20, stiffness: 300 }}\n          onClick={(e) => e.stopPropagation()}\n          data-testid=\"milestone-celebration-card\"\n        >\n          <button\n            onClick={handleDismiss}\n            className=\"absolute top-4 right-4 p-2 rounded-full hover:bg-white/20 transition-colors\"\n            data-testid=\"button-dismiss-milestone\"\n          >\n            <X className=\"w-5 h-5 text-white/80\" />\n          </button>\n\n          <div className=\"text-center\">\n            <motion.div\n              className=\"w-20 h-20 mx-auto mb-6 rounded-full bg-white/20 flex items-center justify-center\"\n              animate={{ \n                scale: [1, 1.1, 1],\n                rotate: [0, 5, -5, 0],\n              }}\n              transition={{ \n                duration: 2,\n                repeat: Infinity,\n                repeatType: \"reverse\",\n              }}\n            >\n              <IconComponent className=\"w-10 h-10 text-white\" />\n            </motion.div>\n\n            <motion.div\n              className=\"mb-2 text-white/80 text-sm font-medium uppercase tracking-wider\"\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.2 }}\n            >\n              {currentMilestone.milestone}% Milestone\n            </motion.div>\n\n            <motion.h2\n              className=\"text-3xl font-bold text-white mb-2\"\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              {message.title}\n            </motion.h2>\n\n            <motion.p\n              className={`${colors.text} mb-4`}\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.4 }}\n            >\n              {message.subtitle}\n            </motion.p>\n\n            <motion.div\n              className=\"bg-white/20 rounded-xl p-4 mb-6\"\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.5 }}\n            >\n              <p className=\"text-white/80 text-sm mb-1\">Goal: {currentMilestone.goal.title}</p>\n              <p className=\"text-2xl font-bold text-white\">\n                ${parseFloat(currentMilestone.amountAtMilestone).toLocaleString()}\n                <span className=\"text-white/60 text-lg font-normal\">\n                  {\" \"}/ ${parseFloat(currentMilestone.goal.targetAmount).toLocaleString()}\n                </span>\n              </p>\n            </motion.div>\n\n            <motion.div\n              className=\"flex gap-3\"\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.6 }}\n            >\n              <Button\n                variant=\"outline\"\n                className=\"flex-1 bg-white/20 border-white/30 text-white hover:bg-white/30 hover:text-white\"\n                onClick={handleDismiss}\n                data-testid=\"button-continue\"\n              >\n                {celebrationQueue.length > 1 ? 'Next' : 'Continue'}\n              </Button>\n              <Button\n                className=\"flex-1 bg-white text-gray-900 hover:bg-white/90\"\n                onClick={handleViewGoal}\n                data-testid=\"button-view-goal\"\n              >\n                View Goal\n                <ChevronRight className=\"w-4 h-4 ml-1\" />\n              </Button>\n            </motion.div>\n\n            {celebrationQueue.length > 1 && (\n              <motion.div\n                className=\"mt-4 flex justify-center gap-2\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.7 }}\n              >\n                {celebrationQueue.map((_, idx) => (\n                  <div\n                    key={idx}\n                    className={`w-2 h-2 rounded-full transition-colors ${\n                      idx === 0 ? 'bg-white' : 'bg-white/30'\n                    }`}\n                  />\n                ))}\n              </motion.div>\n            )}\n          </div>\n        </motion.div>\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n\nexport default MilestoneCelebration;\n","path":null,"size_bytes":9803,"size_tokens":null},"client/src/components/chat/proactive-insights-panel.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  AlertTriangle, \n  TrendingUp, \n  Target, \n  Award,\n  Bell,\n  Lightbulb,\n  ChevronRight,\n  Sparkles\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface ProactiveInsight {\n  id: string;\n  type: 'spending_anomaly' | 'savings_opportunity' | 'goal_deadline' | 'budget_warning' | 'achievement';\n  priority: 'high' | 'medium' | 'low';\n  title: string;\n  message: string;\n  actionable: string;\n  data?: any;\n  createdAt: string;\n}\n\nconst insightConfig = {\n  spending_anomaly: {\n    icon: AlertTriangle,\n    colors: {\n      bg: 'bg-amber-50 dark:bg-amber-950/30',\n      border: 'border-amber-200/60 dark:border-amber-800/40',\n      icon: 'text-amber-600 dark:text-amber-400',\n      iconBg: 'bg-amber-100 dark:bg-amber-900/50',\n      title: 'text-amber-800 dark:text-amber-200',\n      badge: 'bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300'\n    }\n  },\n  savings_opportunity: {\n    icon: TrendingUp,\n    colors: {\n      bg: 'bg-emerald-50 dark:bg-emerald-950/30',\n      border: 'border-emerald-200/60 dark:border-emerald-800/40',\n      icon: 'text-emerald-600 dark:text-emerald-400',\n      iconBg: 'bg-emerald-100 dark:bg-emerald-900/50',\n      title: 'text-emerald-800 dark:text-emerald-200',\n      badge: 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300'\n    }\n  },\n  goal_deadline: {\n    icon: Target,\n    colors: {\n      bg: 'bg-blue-50 dark:bg-blue-950/30',\n      border: 'border-blue-200/60 dark:border-blue-800/40',\n      icon: 'text-blue-600 dark:text-blue-400',\n      iconBg: 'bg-blue-100 dark:bg-blue-900/50',\n      title: 'text-blue-800 dark:text-blue-200',\n      badge: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300'\n    }\n  },\n  budget_warning: {\n    icon: Bell,\n    colors: {\n      bg: 'bg-red-50 dark:bg-red-950/30',\n      border: 'border-red-200/60 dark:border-red-800/40',\n      icon: 'text-red-600 dark:text-red-400',\n      iconBg: 'bg-red-100 dark:bg-red-900/50',\n      title: 'text-red-800 dark:text-red-200',\n      badge: 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300'\n    }\n  },\n  achievement: {\n    icon: Award,\n    colors: {\n      bg: 'bg-violet-50 dark:bg-violet-950/30',\n      border: 'border-violet-200/60 dark:border-violet-800/40',\n      icon: 'text-violet-600 dark:text-violet-400',\n      iconBg: 'bg-violet-100 dark:bg-violet-900/50',\n      title: 'text-violet-800 dark:text-violet-200',\n      badge: 'bg-violet-100 dark:bg-violet-900/50 text-violet-700 dark:text-violet-300'\n    }\n  }\n};\n\nconst priorityBadge = {\n  high: 'Urgent',\n  medium: 'Important',\n  low: 'Note'\n};\n\ninterface ProactiveInsightsPanelProps {\n  onAskAbout?: (prompt: string) => void;\n  maxItems?: number;\n}\n\nexport function ProactiveInsightsPanel({ onAskAbout, maxItems = 3 }: ProactiveInsightsPanelProps) {\n  const { data: insights, isLoading, error } = useQuery<ProactiveInsight[]>({\n    queryKey: ['/api/proactive-insights'],\n    staleTime: 1000 * 60 * 5,\n    refetchOnWindowFocus: false,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-3\">\n        {[1, 2].map((i) => (\n          <div key={i} className=\"animate-pulse\">\n            <div className=\"h-24 bg-muted/30 rounded-xl\" />\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  if (error || !insights || insights.length === 0) {\n    return null;\n  }\n\n  const displayedInsights = insights.slice(0, maxItems);\n  const hasMore = insights.length > maxItems;\n\n  return (\n    <motion.div \n      className=\"space-y-4\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4, delay: 0.3 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <div className=\"p-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/50\">\n          <Lightbulb className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n        </div>\n        <h3 className=\"text-sm font-semibold text-foreground\">Insights for You</h3>\n        <Badge variant=\"secondary\" className=\"text-[10px] ml-auto\">\n          {insights.length} new\n        </Badge>\n      </div>\n\n      <AnimatePresence mode=\"popLayout\">\n        {displayedInsights.map((insight, index) => {\n          const config = insightConfig[insight.type];\n          const Icon = config.icon;\n          const colors = config.colors;\n\n          return (\n            <motion.div\n              key={insight.id}\n              className={`relative p-4 rounded-xl border ${colors.bg} ${colors.border} group transition-all duration-200 hover:shadow-md cursor-pointer`}\n              initial={{ opacity: 0, y: 10, scale: 0.98 }}\n              animate={{ opacity: 1, y: 0, scale: 1 }}\n              exit={{ opacity: 0, y: -10, scale: 0.98 }}\n              transition={{ duration: 0.3, delay: index * 0.1 }}\n              whileHover={{ y: -2 }}\n              onClick={() => onAskAbout?.(insight.actionable)}\n              data-testid={`insight-card-${insight.type}`}\n            >\n              <div className=\"flex gap-3\">\n                <div className={`p-2 rounded-lg ${colors.iconBg} shrink-0`}>\n                  <Icon className={`w-4 h-4 ${colors.icon}`} />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-start justify-between gap-2 mb-1\">\n                    <h4 className={`text-sm font-semibold ${colors.title} line-clamp-1`}>\n                      {insight.title}\n                    </h4>\n                    <Badge \n                      variant=\"secondary\" \n                      className={`text-[10px] shrink-0 ${colors.badge}`}\n                    >\n                      {priorityBadge[insight.priority]}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground line-clamp-2 mb-2\">\n                    {insight.message}\n                  </p>\n                  <div className=\"flex items-center gap-2 text-xs\">\n                    <Sparkles className=\"w-3 h-3 text-blue-500\" />\n                    <span className=\"text-muted-foreground/70\">Click to ask AI for help</span>\n                    <ChevronRight className=\"w-3 h-3 text-muted-foreground/30 group-hover:text-blue-500 group-hover:translate-x-0.5 transition-all\" />\n                  </div>\n                </div>\n              </div>\n            </motion.div>\n          );\n        })}\n      </AnimatePresence>\n\n      {hasMore && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 0.5 }}\n        >\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"w-full text-xs text-muted-foreground hover:text-blue-600\"\n            onClick={() => onAskAbout?.(\"What are all my financial insights and what should I focus on first?\")}\n            data-testid=\"button-view-all-insights\"\n          >\n            View all {insights.length} insights\n            <ChevronRight className=\"w-3 h-3 ml-1\" />\n          </Button>\n        </motion.div>\n      )}\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":7191,"size_tokens":null},"client/src/components/weekly-summary-card.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Activity, \n  TrendingUp, \n  TrendingDown,\n  Minus,\n  Sparkles, \n  ChevronRight, \n  CheckCircle2, \n  Circle,\n  ArrowUpRight,\n  Target,\n  Wallet,\n  PiggyBank,\n  Receipt,\n  CreditCard,\n  RefreshCw,\n  Calendar\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { format } from \"date-fns\";\n\ninterface PlaybookInsight {\n  text: string;\n  tag: string;\n  severity: \"high\" | \"medium\" | \"low\";\n}\n\ninterface PlaybookAction {\n  title: string;\n  description: string;\n  effort: \"low\" | \"medium\" | \"high\";\n  impact: \"low\" | \"medium\" | \"high\";\n  deepLink: string;\n}\n\ninterface Playbook {\n  id: string;\n  userId: string;\n  weekStartDate: string;\n  weekEndDate: string;\n  financialHealthScore: number;\n  scoreDelta: number | null;\n  confidenceBand: \"improving\" | \"stable\" | \"declining\" | null;\n  insights: PlaybookInsight[];\n  insightsCount: number;\n  actions: PlaybookAction[];\n  actionsCount: number;\n  actionsCompleted: number | null;\n  completedActionIndices: number[] | null;\n  roiSavings: string;\n  cumulativeRoi: string;\n  forecastLift: string | null;\n  tier: string;\n  generatedBy: string;\n  isViewed: boolean;\n  viewedAt: string | null;\n  createdAt: string;\n}\n\nconst tagColors: Record<string, { bg: string; text: string }> = {\n  spending: { bg: \"bg-red-100 dark:bg-red-900/30\", text: \"text-red-700 dark:text-red-300\" },\n  saving: { bg: \"bg-emerald-100 dark:bg-emerald-900/30\", text: \"text-emerald-700 dark:text-emerald-300\" },\n  goal: { bg: \"bg-blue-100 dark:bg-blue-900/30\", text: \"text-blue-700 dark:text-blue-300\" },\n  budget: { bg: \"bg-amber-100 dark:bg-amber-900/30\", text: \"text-amber-700 dark:text-amber-300\" },\n  investment: { bg: \"bg-violet-100 dark:bg-violet-900/30\", text: \"text-violet-700 dark:text-violet-300\" }\n};\n\nconst severityStyles: Record<string, string> = {\n  high: \"border-l-4 border-l-red-500\",\n  medium: \"border-l-4 border-l-amber-500\",\n  low: \"border-l-4 border-l-emerald-500\"\n};\n\nconst effortLabels: Record<string, { text: string; color: string }> = {\n  low: { text: \"Quick\", color: \"text-emerald-600\" },\n  medium: { text: \"Moderate\", color: \"text-amber-600\" },\n  high: { text: \"Involved\", color: \"text-red-600\" }\n};\n\nconst impactLabels: Record<string, { text: string; color: string }> = {\n  low: { text: \"Minor\", color: \"text-gray-600\" },\n  medium: { text: \"Good\", color: \"text-blue-600\" },\n  high: { text: \"Major\", color: \"text-violet-600\" }\n};\n\nfunction HealthScoreRing({ score, delta }: { score: number; delta: number | null }) {\n  const radius = 54;\n  const circumference = 2 * Math.PI * radius;\n  const offset = circumference - (score / 100) * circumference;\n  \n  const getScoreColor = (score: number) => {\n    if (score >= 80) return \"#10b981\";\n    if (score >= 60) return \"#3b82f6\";\n    if (score >= 40) return \"#f59e0b\";\n    return \"#ef4444\";\n  };\n\n  return (\n    <div className=\"relative w-32 h-32\">\n      <svg className=\"w-full h-full transform -rotate-90\" viewBox=\"0 0 120 120\">\n        <circle\n          cx=\"60\"\n          cy=\"60\"\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          className=\"text-muted/20\"\n          strokeWidth=\"8\"\n        />\n        <motion.circle\n          cx=\"60\"\n          cy=\"60\"\n          r={radius}\n          fill=\"none\"\n          stroke={getScoreColor(score)}\n          strokeWidth=\"8\"\n          strokeLinecap=\"round\"\n          strokeDasharray={circumference}\n          initial={{ strokeDashoffset: circumference }}\n          animate={{ strokeDashoffset: offset }}\n          transition={{ duration: 1.5, ease: \"easeOut\" }}\n        />\n      </svg>\n      <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\n        <motion.span \n          className=\"text-3xl font-bold text-foreground\"\n          initial={{ opacity: 0, scale: 0.5 }}\n          animate={{ opacity: 1, scale: 1 }}\n          transition={{ delay: 0.5, duration: 0.3 }}\n        >\n          {score}\n        </motion.span>\n        {delta !== null && delta !== 0 && (\n          <motion.div \n            className={`flex items-center text-xs font-medium ${delta > 0 ? 'text-emerald-600' : 'text-red-600'}`}\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ delay: 0.8 }}\n          >\n            {delta > 0 ? <TrendingUp className=\"w-3 h-3 mr-0.5\" /> : <TrendingDown className=\"w-3 h-3 mr-0.5\" />}\n            {delta > 0 ? '+' : ''}{delta}\n          </motion.div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport function WeeklySummaryCard() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  \n  const { data: playbooks, isLoading } = useQuery<Playbook[]>({\n    queryKey: ['/api/playbooks'],\n    staleTime: 1000 * 60 * 5,\n  });\n\n  const generateMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/playbooks/generate\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/playbooks'] });\n      toast({\n        title: \"Weekly Summary Generated\",\n        description: \"Your personalized financial insights are ready\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Generation Failed\",\n        description: error.message || \"Could not generate weekly summary\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const completeActionMutation = useMutation({\n    mutationFn: async ({ playbookId, actionIndex }: { playbookId: string; actionIndex: number }) => {\n      const response = await apiRequest(\"POST\", `/api/playbooks/${playbookId}/complete-action`, {\n        actionIndex,\n        estimatedSavings: 0,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/playbooks'] });\n      toast({\n        title: \"Action Completed\",\n        description: \"Great progress on your financial health\",\n      });\n    }\n  });\n\n  const currentPlaybook = playbooks && playbooks.length > 0 ? playbooks[0] : null;\n  const completedIndices = currentPlaybook?.completedActionIndices || [];\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 rounded-2xl border border-border/50 bg-white dark:bg-zinc-900 shadow-sm\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-6 bg-muted/30 rounded w-1/3\" />\n          <div className=\"h-32 bg-muted/30 rounded-xl\" />\n          <div className=\"h-20 bg-muted/30 rounded\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!currentPlaybook) {\n    return (\n      <motion.div \n        className=\"p-6 rounded-2xl border border-border/50 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 shadow-sm\"\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n      >\n        <div className=\"text-center py-8\">\n          <div className=\"w-16 h-16 mx-auto mb-4 rounded-2xl bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n            <Calendar className=\"w-8 h-8 text-blue-600 dark:text-blue-400\" />\n          </div>\n          <h3 className=\"text-lg font-semibold text-foreground mb-2\">Weekly Financial Summary</h3>\n          <p className=\"text-sm text-muted-foreground mb-6 max-w-sm mx-auto\">\n            Get personalized AI insights, health scores, and action items tailored to your financial situation\n          </p>\n          <Button\n            onClick={() => generateMutation.mutate()}\n            disabled={generateMutation.isPending}\n            className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n            data-testid=\"button-generate-summary\"\n          >\n            {generateMutation.isPending ? (\n              <>\n                <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                Generating...\n              </>\n            ) : (\n              <>\n                <Sparkles className=\"w-4 h-4 mr-2\" />\n                Generate My Summary\n              </>\n            )}\n          </Button>\n        </div>\n      </motion.div>\n    );\n  }\n\n  const weekStart = new Date(currentPlaybook.weekStartDate);\n  const weekEnd = new Date(currentPlaybook.weekEndDate);\n\n  return (\n    <motion.div \n      className=\"rounded-2xl border border-border/50 bg-white dark:bg-zinc-900 shadow-sm overflow-hidden\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      data-testid=\"weekly-summary-card\"\n    >\n      <div className=\"p-6 border-b border-border/30\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h3 className=\"text-lg font-semibold text-foreground\">Weekly Financial Pulse</h3>\n            <p className=\"text-xs text-muted-foreground\">\n              {format(weekStart, 'MMM d')} - {format(weekEnd, 'MMM d, yyyy')}\n            </p>\n          </div>\n          <Badge \n            variant=\"outline\" \n            className={`text-xs ${\n              currentPlaybook.confidenceBand === 'improving' ? 'border-emerald-500 text-emerald-600' :\n              currentPlaybook.confidenceBand === 'declining' ? 'border-red-500 text-red-600' :\n              'border-gray-500 text-gray-600'\n            }`}\n          >\n            {currentPlaybook.confidenceBand === 'improving' && <TrendingUp className=\"w-3 h-3 mr-1\" />}\n            {currentPlaybook.confidenceBand === 'declining' && <TrendingDown className=\"w-3 h-3 mr-1\" />}\n            {currentPlaybook.confidenceBand === 'stable' && <Minus className=\"w-3 h-3 mr-1\" />}\n            {currentPlaybook.confidenceBand}\n          </Badge>\n        </div>\n\n        <div className=\"flex items-center gap-6\">\n          <HealthScoreRing score={currentPlaybook.financialHealthScore} delta={currentPlaybook.scoreDelta} />\n          \n          <div className=\"flex-1 space-y-3\">\n            <div className=\"text-sm font-medium text-foreground\">Financial Health Score</div>\n            <div className=\"grid grid-cols-2 gap-3 text-xs\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center\">\n                  <PiggyBank className=\"w-4 h-4 text-emerald-600 dark:text-emerald-400\" />\n                </div>\n                <div>\n                  <div className=\"text-muted-foreground\">ROI This Week</div>\n                  <div className=\"font-semibold text-emerald-600\">${parseFloat(currentPlaybook.roiSavings || '0').toLocaleString()}</div>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <div className=\"w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center\">\n                  <Wallet className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                </div>\n                <div>\n                  <div className=\"text-muted-foreground\">Total Savings</div>\n                  <div className=\"font-semibold text-blue-600\">${parseFloat(currentPlaybook.cumulativeRoi || '0').toLocaleString()}</div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"p-6 border-b border-border/30\">\n        <h4 className=\"text-sm font-semibold text-foreground mb-3 flex items-center gap-2\">\n          <Sparkles className=\"w-4 h-4 text-blue-500\" />\n          AI Insights ({currentPlaybook.insights?.length || 0})\n        </h4>\n        <div className=\"space-y-2\">\n          {currentPlaybook.insights?.slice(0, 3).map((insight, idx) => (\n            <motion.div\n              key={idx}\n              className={`p-3 rounded-lg bg-muted/30 ${severityStyles[insight.severity]}`}\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: idx * 0.1 }}\n            >\n              <div className=\"flex items-start justify-between gap-2\">\n                <p className=\"text-sm text-foreground/90\">{insight.text}</p>\n                <Badge \n                  variant=\"secondary\" \n                  className={`text-[10px] shrink-0 ${tagColors[insight.tag]?.bg || ''} ${tagColors[insight.tag]?.text || ''}`}\n                >\n                  {insight.tag}\n                </Badge>\n              </div>\n            </motion.div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"p-6\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <h4 className=\"text-sm font-semibold text-foreground flex items-center gap-2\">\n            <Target className=\"w-4 h-4 text-blue-500\" />\n            Action Queue\n          </h4>\n          <span className=\"text-xs text-muted-foreground\">\n            {completedIndices.length}/{currentPlaybook.actionsCount} done\n          </span>\n        </div>\n        \n        <Progress \n          value={(completedIndices.length / currentPlaybook.actionsCount) * 100} \n          className=\"h-1.5 mb-4\"\n        />\n        \n        <div className=\"space-y-2\">\n          {currentPlaybook.actions?.map((action, idx) => {\n            const isCompleted = completedIndices.includes(idx);\n            \n            return (\n              <motion.div\n                key={idx}\n                className={`p-3 rounded-lg border transition-all ${\n                  isCompleted \n                    ? 'bg-emerald-50 dark:bg-emerald-950/20 border-emerald-200 dark:border-emerald-800/40' \n                    : 'bg-muted/20 border-border/50 hover:border-blue-500/30 cursor-pointer'\n                }`}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: idx * 0.1 }}\n                onClick={() => {\n                  if (!isCompleted) {\n                    setLocation(action.deepLink);\n                  }\n                }}\n                whileHover={!isCompleted ? { y: -2 } : undefined}\n              >\n                <div className=\"flex items-start gap-3\">\n                  <button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      if (!isCompleted) {\n                        completeActionMutation.mutate({ \n                          playbookId: currentPlaybook.id, \n                          actionIndex: idx \n                        });\n                      }\n                    }}\n                    className=\"mt-0.5 shrink-0\"\n                    data-testid={`action-checkbox-${idx}`}\n                  >\n                    {isCompleted ? (\n                      <CheckCircle2 className=\"w-5 h-5 text-emerald-600\" />\n                    ) : (\n                      <Circle className=\"w-5 h-5 text-muted-foreground hover:text-blue-500 transition-colors\" />\n                    )}\n                  </button>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className={`text-sm font-medium ${isCompleted ? 'text-emerald-700 dark:text-emerald-300 line-through' : 'text-foreground'}`}>\n                      {action.title}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground line-clamp-1 mt-0.5\">{action.description}</p>\n                    <div className=\"flex items-center gap-2 mt-2 text-[10px]\">\n                      <span className={effortLabels[action.effort].color}>\n                        {effortLabels[action.effort].text} effort\n                      </span>\n                      <span className=\"text-muted-foreground\">|</span>\n                      <span className={impactLabels[action.impact].color}>\n                        {impactLabels[action.impact].text} impact\n                      </span>\n                    </div>\n                  </div>\n                  {!isCompleted && (\n                    <ChevronRight className=\"w-4 h-4 text-muted-foreground/50 mt-0.5\" />\n                  )}\n                </div>\n              </motion.div>\n            );\n          })}\n        </div>\n      </div>\n\n      <div className=\"px-6 py-4 bg-muted/20 border-t border-border/30\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"w-full text-xs text-muted-foreground hover:text-blue-600\"\n          onClick={() => generateMutation.mutate()}\n          disabled={generateMutation.isPending}\n          data-testid=\"button-refresh-summary\"\n        >\n          {generateMutation.isPending ? (\n            <RefreshCw className=\"w-3 h-3 mr-2 animate-spin\" />\n          ) : (\n            <RefreshCw className=\"w-3 h-3 mr-2\" />\n          )}\n          Refresh Summary\n        </Button>\n      </div>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":16881,"size_tokens":null},"client/src/components/pro-trial-paywall.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useLocation } from \"wouter\";\nimport {\n  Crown,\n  Lock,\n  Sparkles,\n  Check,\n  Zap,\n  Brain,\n  TrendingUp,\n  Shield,\n  ArrowRight,\n  X,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\ninterface ProTrialPaywallProps {\n  feature: string;\n  description?: string;\n  children?: React.ReactNode;\n  showBlurred?: boolean;\n}\n\nconst premiumFeatures = [\n  { icon: Brain, label: \"GPT-5 & Claude Opus AI\" },\n  { icon: TrendingUp, label: \"Advanced Analytics\" },\n  { icon: Sparkles, label: \"Unlimited AI Queries\" },\n  { icon: Shield, label: \"Priority Support\" },\n];\n\nexport function ProTrialPaywall({\n  feature,\n  description,\n  children,\n  showBlurred = true,\n}: ProTrialPaywallProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [, setLocation] = useLocation();\n  const { formatAmount, convertFromUSD } = useUserCurrency();\n\n  return (\n    <>\n      <div className=\"relative\">\n        {showBlurred && children && (\n          <div className=\"blur-sm pointer-events-none select-none opacity-60\">\n            {children}\n          </div>\n        )}\n\n        <motion.div\n          initial={{ opacity: 0, scale: 0.95 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className={`${showBlurred ? 'absolute inset-0' : ''} flex items-center justify-center`}\n        >\n          <Card className=\"border-primary/30 bg-gradient-to-br from-background via-background to-primary/5 shadow-xl max-w-sm w-full mx-4\">\n            <CardContent className=\"p-6 text-center\">\n              <motion.div\n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                transition={{ type: \"spring\", delay: 0.1 }}\n                className=\"w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center shadow-lg shadow-primary/25\"\n              >\n                <Lock className=\"w-7 h-7 text-primary-foreground\" />\n              </motion.div>\n\n              <motion.div\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.15 }}\n              >\n                <Badge className=\"mb-3 bg-primary/10 text-primary border-primary/20\">\n                  <Crown className=\"w-3 h-3 mr-1\" />\n                  Pro Feature\n                </Badge>\n              </motion.div>\n\n              <motion.h3\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.2 }}\n                className=\"text-lg font-semibold mb-2\"\n              >\n                Unlock {feature}\n              </motion.h3>\n\n              <motion.p\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.25 }}\n                className=\"text-sm text-muted-foreground mb-5\"\n              >\n                {description || `Get access to ${feature} and all premium features with Pro.`}\n              </motion.p>\n\n              <motion.div\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.3 }}\n                className=\"space-y-2\"\n              >\n                <Button\n                  onClick={() => setShowModal(true)}\n                  className=\"w-full bg-gradient-to-r from-primary to-primary/80 shadow-lg shadow-primary/25\"\n                  data-testid=\"button-unlock-pro\"\n                >\n                  <Zap className=\"w-4 h-4 mr-2\" />\n                  Unlock with Pro\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setLocation(\"/subscription\")}\n                  className=\"text-xs text-muted-foreground\"\n                >\n                  Compare all plans\n                  <ArrowRight className=\"w-3 h-3 ml-1\" />\n                </Button>\n              </motion.div>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </div>\n\n      <ProUpgradeModal open={showModal} onOpenChange={setShowModal} />\n    </>\n  );\n}\n\ninterface ProUpgradeModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport function ProUpgradeModal({ open, onOpenChange }: ProUpgradeModalProps) {\n  const [, setLocation] = useLocation();\n  const { formatAmount, convertFromUSD } = useUserCurrency();\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg p-0 overflow-hidden\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n        >\n          <div className=\"relative bg-gradient-to-br from-primary via-primary to-primary/80 p-6 text-primary-foreground\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => onOpenChange(false)}\n              className=\"absolute top-3 right-3 text-primary-foreground/80 hover:text-primary-foreground hover:bg-primary-foreground/10\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ type: \"spring\", delay: 0.1 }}\n              className=\"w-16 h-16 mx-auto mb-4 rounded-2xl bg-white/20 flex items-center justify-center backdrop-blur-sm\"\n            >\n              <Crown className=\"w-8 h-8\" />\n            </motion.div>\n\n            <h2 className=\"text-2xl font-bold text-center mb-2\">\n              Upgrade to Pro\n            </h2>\n            <p className=\"text-center text-primary-foreground/80 text-sm\">\n              Unlock the full power of AI-driven financial management\n            </p>\n          </div>\n\n          <div className=\"p-6\">\n            <div className=\"space-y-3 mb-6\">\n              {premiumFeatures.map((feature, idx) => (\n                <motion.div\n                  key={feature.label}\n                  initial={{ opacity: 0, x: -20 }}\n                  animate={{ opacity: 1, x: 0 }}\n                  transition={{ delay: 0.2 + idx * 0.1 }}\n                  className=\"flex items-center gap-3\"\n                >\n                  <div className=\"w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center\">\n                    <feature.icon className=\"w-4 h-4 text-primary\" />\n                  </div>\n                  <span className=\"text-sm font-medium\">{feature.label}</span>\n                  <Check className=\"w-4 h-4 text-green-500 ml-auto\" />\n                </motion.div>\n              ))}\n            </div>\n\n            <div className=\"bg-muted/50 rounded-xl p-4 mb-6\">\n              <div className=\"flex items-baseline justify-center gap-1 mb-1\">\n                <span className=\"text-3xl font-bold\">{formatAmount(convertFromUSD(9.99))}</span>\n                <span className=\"text-muted-foreground\">/month</span>\n              </div>\n              <p className=\"text-center text-xs text-muted-foreground\">\n                Cancel anytime. No questions asked.\n              </p>\n            </div>\n\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.5 }}\n              className=\"space-y-2\"\n            >\n              <Button\n                onClick={() => {\n                  onOpenChange(false);\n                  setLocation(\"/checkout/pro\");\n                }}\n                className=\"w-full h-12 bg-gradient-to-r from-primary to-primary/80 shadow-lg shadow-primary/25 text-base\"\n                data-testid=\"button-start-pro-trial\"\n              >\n                <Sparkles className=\"w-5 h-5 mr-2\" />\n                Start Pro Trial\n              </Button>\n              <p className=\"text-center text-xs text-muted-foreground\">\n                7-day free trial, then {formatAmount(convertFromUSD(9.99))}/month\n              </p>\n            </motion.div>\n          </div>\n        </motion.div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\ninterface FeatureLockedBadgeProps {\n  onClick?: () => void;\n}\n\nexport function FeatureLockedBadge({ onClick }: FeatureLockedBadgeProps) {\n  return (\n    <motion.button\n      onClick={onClick}\n      whileHover={{ scale: 1.05 }}\n      whileTap={{ scale: 0.95 }}\n      className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium cursor-pointer hover:bg-primary/20 transition-colors\"\n    >\n      <Crown className=\"w-3 h-3\" />\n      Pro\n    </motion.button>\n  );\n}\n","path":null,"size_bytes":8890,"size_tokens":null},"client/src/components/command-palette.tsx":{"content":"import { useEffect, useState, useCallback } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n  CommandSeparator,\n} from \"@/components/ui/command\";\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\nimport {\n  Home,\n  Brain,\n  Target,\n  Wallet,\n  Users,\n  Settings,\n  Crown,\n  Plus,\n  Search,\n  TrendingUp,\n  PiggyBank,\n  Calculator,\n  HelpCircle,\n  Moon,\n  Sun,\n  LogOut,\n  User,\n  CreditCard,\n  Bell,\n  Sparkles,\n} from \"lucide-react\";\nimport { useTheme } from \"@/components/theme-provider\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface CommandAction {\n  id: string;\n  title: string;\n  description?: string;\n  icon: any;\n  action: () => void;\n  keywords?: string[];\n  shortcut?: string;\n}\n\ninterface CommandGroup {\n  heading: string;\n  items: CommandAction[];\n}\n\nexport function CommandPalette() {\n  const [open, setOpen] = useState(false);\n  const [, setLocation] = useLocation();\n  const { theme, setTheme } = useTheme();\n  const { user } = useAuth();\n  const { toast } = useToast();\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest('POST', '/api/auth/logout', {});\n    },\n    onSuccess: () => {\n      queryClient.clear();\n      setLocation('/login');\n      toast({ title: \"Signed out successfully\" });\n    },\n  });\n\n  useEffect(() => {\n    const down = (e: KeyboardEvent) => {\n      if (e.key === \"k\" && (e.metaKey || e.ctrlKey)) {\n        e.preventDefault();\n        setOpen((open) => !open);\n      }\n      if (e.key === \"Escape\") {\n        setOpen(false);\n      }\n    };\n\n    document.addEventListener(\"keydown\", down);\n    return () => document.removeEventListener(\"keydown\", down);\n  }, []);\n\n  const runCommand = useCallback((command: () => void) => {\n    setOpen(false);\n    command();\n  }, []);\n\n  const navigationItems: CommandAction[] = [\n    {\n      id: \"dashboard\",\n      title: \"Dashboard\",\n      description: \"Go to your financial overview\",\n      icon: Home,\n      action: () => setLocation(\"/\"),\n      keywords: [\"home\", \"overview\", \"main\"],\n      shortcut: \"G D\",\n    },\n    {\n      id: \"ai-assistant\",\n      title: \"AI Assistant\",\n      description: \"Chat with your AI financial advisor\",\n      icon: Brain,\n      action: () => setLocation(\"/ai-assistant\"),\n      keywords: [\"chat\", \"advisor\", \"help\", \"gpt\", \"claude\"],\n      shortcut: \"G A\",\n    },\n    {\n      id: \"goals\",\n      title: \"Financial Goals\",\n      description: \"Track your savings goals\",\n      icon: Target,\n      action: () => setLocation(\"/financial-goals\"),\n      keywords: [\"savings\", \"targets\", \"objectives\"],\n      shortcut: \"G G\",\n    },\n    {\n      id: \"money\",\n      title: \"Money Tracking\",\n      description: \"View transactions and budgets\",\n      icon: Wallet,\n      action: () => setLocation(\"/money-tracking\"),\n      keywords: [\"transactions\", \"spending\", \"budget\", \"expenses\"],\n      shortcut: \"G M\",\n    },\n    {\n      id: \"groups\",\n      title: \"Groups\",\n      description: \"Shared goals and cost splitting\",\n      icon: Users,\n      action: () => setLocation(\"/groups\"),\n      keywords: [\"shared\", \"split\", \"friends\", \"family\"],\n      shortcut: \"G R\",\n    },\n    {\n      id: \"subscription\",\n      title: \"Subscription\",\n      description: \"Manage your plan\",\n      icon: Crown,\n      action: () => setLocation(\"/subscription\"),\n      keywords: [\"upgrade\", \"pro\", \"enterprise\", \"billing\"],\n      shortcut: \"G S\",\n    },\n    {\n      id: \"settings\",\n      title: \"Settings\",\n      description: \"Preferences and account\",\n      icon: Settings,\n      action: () => setLocation(\"/settings\"),\n      keywords: [\"preferences\", \"account\", \"profile\"],\n      shortcut: \"G ,\",\n    },\n  ];\n\n  const quickActions: CommandAction[] = [\n    {\n      id: \"new-goal\",\n      title: \"Create New Goal\",\n      description: \"Set a new savings target\",\n      icon: Plus,\n      action: () => {\n        setLocation(\"/financial-goals\");\n        setTimeout(() => {\n          const btn = document.querySelector('[data-testid=\"button-add-goal\"]') as HTMLButtonElement;\n          btn?.click();\n        }, 300);\n      },\n      keywords: [\"add\", \"new\", \"create\", \"goal\"],\n    },\n    {\n      id: \"new-transaction\",\n      title: \"Add Transaction\",\n      description: \"Record income or expense\",\n      icon: CreditCard,\n      action: () => {\n        setLocation(\"/money-tracking\");\n        setTimeout(() => {\n          const btn = document.querySelector('[data-testid=\"button-add-transaction\"]') as HTMLButtonElement;\n          btn?.click();\n        }, 300);\n      },\n      keywords: [\"add\", \"expense\", \"income\", \"payment\"],\n    },\n    {\n      id: \"ask-ai\",\n      title: \"Ask AI a Question\",\n      description: \"Get financial advice instantly\",\n      icon: Sparkles,\n      action: () => {\n        setLocation(\"/ai-assistant\");\n        setTimeout(() => {\n          const input = document.querySelector('[data-testid=\"input-message\"]') as HTMLInputElement;\n          input?.focus();\n        }, 300);\n      },\n      keywords: [\"question\", \"help\", \"advice\"],\n    },\n  ];\n\n  const toolsAndUtilities: CommandAction[] = [\n    {\n      id: \"calculator\",\n      title: \"Financial Calculator\",\n      description: \"Calculate savings, interest, etc.\",\n      icon: Calculator,\n      action: () => {\n        setLocation(\"/ai-assistant\");\n        setTimeout(() => {\n          const input = document.querySelector('[data-testid=\"input-message\"]') as HTMLInputElement;\n          if (input) {\n            input.value = \"Help me calculate \";\n            input.focus();\n          }\n        }, 300);\n      },\n      keywords: [\"math\", \"compute\", \"calculate\"],\n    },\n    {\n      id: \"spending-analysis\",\n      title: \"Analyze My Spending\",\n      description: \"Get insights on your expenses\",\n      icon: TrendingUp,\n      action: () => {\n        setLocation(\"/ai-assistant\");\n        setTimeout(() => {\n          const input = document.querySelector('[data-testid=\"input-message\"]') as HTMLInputElement;\n          if (input) {\n            input.value = \"Analyze my spending patterns and give me advice\";\n            input.focus();\n          }\n        }, 300);\n      },\n      keywords: [\"analyze\", \"insights\", \"patterns\"],\n    },\n    {\n      id: \"savings-tips\",\n      title: \"Get Savings Tips\",\n      description: \"AI-powered money saving advice\",\n      icon: PiggyBank,\n      action: () => {\n        setLocation(\"/ai-assistant\");\n        setTimeout(() => {\n          const input = document.querySelector('[data-testid=\"input-message\"]') as HTMLInputElement;\n          if (input) {\n            input.value = \"What are some ways I can save more money?\";\n            input.focus();\n          }\n        }, 300);\n      },\n      keywords: [\"tips\", \"advice\", \"save\"],\n    },\n  ];\n\n  const preferencesActions: CommandAction[] = [\n    {\n      id: \"toggle-theme\",\n      title: theme === \"dark\" ? \"Switch to Light Mode\" : \"Switch to Dark Mode\",\n      description: \"Toggle appearance\",\n      icon: theme === \"dark\" ? Sun : Moon,\n      action: () => setTheme(theme === \"dark\" ? \"light\" : \"dark\"),\n      keywords: [\"theme\", \"dark\", \"light\", \"mode\", \"appearance\"],\n    },\n    {\n      id: \"notifications\",\n      title: \"Notification Settings\",\n      description: \"Manage alerts and reminders\",\n      icon: Bell,\n      action: () => setLocation(\"/settings\"),\n      keywords: [\"alerts\", \"reminders\", \"notifications\"],\n    },\n    {\n      id: \"profile\",\n      title: \"Edit Profile\",\n      description: \"Update your information\",\n      icon: User,\n      action: () => setLocation(\"/financial-profile\"),\n      keywords: [\"profile\", \"account\", \"information\"],\n    },\n    {\n      id: \"logout\",\n      title: \"Sign Out\",\n      description: \"Log out of your account\",\n      icon: LogOut,\n      action: () => logoutMutation.mutate(),\n      keywords: [\"logout\", \"sign out\", \"exit\"],\n    },\n  ];\n\n  const commandGroups: CommandGroup[] = [\n    { heading: \"Navigation\", items: navigationItems },\n    { heading: \"Quick Actions\", items: quickActions },\n    { heading: \"Tools & AI\", items: toolsAndUtilities },\n    { heading: \"Preferences\", items: preferencesActions },\n  ];\n\n  return (\n    <>\n      <button\n        onClick={() => setOpen(true)}\n        className=\"hidden md:flex items-center gap-2 px-3 py-1.5 text-sm text-muted-foreground hover:text-foreground border border-border/50 rounded-lg hover:border-border hover:bg-accent/50 transition-all\"\n        data-testid=\"button-command-palette\"\n      >\n        <Search className=\"w-4 h-4\" />\n        <span className=\"hidden lg:inline\">Search...</span>\n        <kbd className=\"hidden lg:inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n          <span className=\"text-xs\">⌘</span>K\n        </kbd>\n      </button>\n\n      <AnimatePresence>\n        {open && (\n          <Dialog open={open} onOpenChange={setOpen}>\n            <DialogContent className=\"overflow-hidden p-0 shadow-2xl border-border/50 max-w-2xl\">\n              <motion.div\n                initial={{ opacity: 0, scale: 0.95, y: -10 }}\n                animate={{ opacity: 1, scale: 1, y: 0 }}\n                exit={{ opacity: 0, scale: 0.95, y: -10 }}\n                transition={{ duration: 0.15, ease: [0.4, 0, 0.2, 1] }}\n              >\n                <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\">\n                  <div className=\"flex items-center border-b px-4 py-3\">\n                    <Search className=\"mr-3 h-5 w-5 shrink-0 text-muted-foreground\" />\n                    <CommandInput \n                      placeholder=\"Type a command or search...\" \n                      className=\"flex h-10 w-full bg-transparent text-base outline-none placeholder:text-muted-foreground\"\n                    />\n                  </div>\n                  <CommandList className=\"max-h-[400px] overflow-y-auto p-2\">\n                    <CommandEmpty className=\"py-6 text-center text-sm text-muted-foreground\">\n                      No results found. Try a different search term.\n                    </CommandEmpty>\n\n                    {commandGroups.map((group, groupIndex) => (\n                      <div key={group.heading}>\n                        <CommandGroup heading={group.heading}>\n                          {group.items.map((item, itemIndex) => (\n                            <CommandItem\n                              key={item.id}\n                              value={`${item.title} ${item.keywords?.join(\" \") || \"\"}`}\n                              onSelect={() => runCommand(item.action)}\n                              className=\"flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer\"\n                            >\n                              <motion.div\n                                initial={{ opacity: 0, x: -10 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                transition={{ \n                                  duration: 0.2, \n                                  delay: groupIndex * 0.05 + itemIndex * 0.02 \n                                }}\n                                className=\"flex items-center gap-3 flex-1\"\n                              >\n                                <div className=\"flex h-9 w-9 items-center justify-center rounded-lg bg-accent/50\">\n                                  <item.icon className=\"h-4 w-4 text-foreground\" />\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"font-medium text-sm\">{item.title}</p>\n                                  {item.description && (\n                                    <p className=\"text-xs text-muted-foreground truncate\">\n                                      {item.description}\n                                    </p>\n                                  )}\n                                </div>\n                                {item.shortcut && (\n                                  <kbd className=\"hidden sm:inline-flex h-6 select-none items-center gap-1 rounded border bg-muted px-2 font-mono text-[10px] font-medium text-muted-foreground\">\n                                    {item.shortcut}\n                                  </kbd>\n                                )}\n                              </motion.div>\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                        {groupIndex < commandGroups.length - 1 && (\n                          <CommandSeparator className=\"my-2\" />\n                        )}\n                      </div>\n                    ))}\n                  </CommandList>\n\n                  <div className=\"flex items-center justify-between border-t px-4 py-2 text-xs text-muted-foreground\">\n                    <div className=\"flex items-center gap-4\">\n                      <span className=\"flex items-center gap-1\">\n                        <kbd className=\"rounded border px-1.5 py-0.5 bg-muted\">↑↓</kbd>\n                        Navigate\n                      </span>\n                      <span className=\"flex items-center gap-1\">\n                        <kbd className=\"rounded border px-1.5 py-0.5 bg-muted\">↵</kbd>\n                        Select\n                      </span>\n                      <span className=\"flex items-center gap-1\">\n                        <kbd className=\"rounded border px-1.5 py-0.5 bg-muted\">esc</kbd>\n                        Close\n                      </span>\n                    </div>\n                    <span className=\"hidden sm:inline\">\n                      {user?.firstName ? `Signed in as ${user.firstName}` : 'Twealth'}\n                    </span>\n                  </div>\n                </Command>\n              </motion.div>\n            </DialogContent>\n          </Dialog>\n        )}\n      </AnimatePresence>\n    </>\n  );\n}\n\nexport default CommandPalette;\n","path":null,"size_bytes":14236,"size_tokens":null},"client/src/components/swipeable-card.tsx":{"content":"import { useState, ReactNode } from \"react\";\nimport { motion, useMotionValue, useTransform, PanInfo } from \"framer-motion\";\nimport { Archive, Flag, Edit, Trash2, Check, MoreHorizontal } from \"lucide-react\";\n\ninterface SwipeAction {\n  id: string;\n  icon: any;\n  label: string;\n  color: string;\n  bgColor: string;\n  onAction: () => void;\n}\n\ninterface SwipeableCardProps {\n  children: ReactNode;\n  leftActions?: SwipeAction[];\n  rightActions?: SwipeAction[];\n  onSwipeLeft?: () => void;\n  onSwipeRight?: () => void;\n  threshold?: number;\n  className?: string;\n}\n\nconst defaultLeftActions: SwipeAction[] = [\n  {\n    id: \"archive\",\n    icon: Archive,\n    label: \"Archive\",\n    color: \"text-white\",\n    bgColor: \"bg-blue-500\",\n    onAction: () => {},\n  },\n];\n\nconst defaultRightActions: SwipeAction[] = [\n  {\n    id: \"delete\",\n    icon: Trash2,\n    label: \"Delete\",\n    color: \"text-white\",\n    bgColor: \"bg-red-500\",\n    onAction: () => {},\n  },\n];\n\nexport function SwipeableCard({\n  children,\n  leftActions = defaultLeftActions,\n  rightActions = defaultRightActions,\n  onSwipeLeft,\n  onSwipeRight,\n  threshold = 80,\n  className = \"\",\n}: SwipeableCardProps) {\n  const [isDragging, setIsDragging] = useState(false);\n  const x = useMotionValue(0);\n  \n  const leftOpacity = useTransform(x, [0, threshold], [0, 1]);\n  const rightOpacity = useTransform(x, [-threshold, 0], [1, 0]);\n  \n  const leftScale = useTransform(x, [0, threshold], [0.8, 1]);\n  const rightScale = useTransform(x, [-threshold, 0], [1, 0.8]);\n\n  const handleDragEnd = (_: any, info: PanInfo) => {\n    setIsDragging(false);\n    const offsetX = info.offset.x;\n\n    if (offsetX > threshold && leftActions.length > 0) {\n      leftActions[0].onAction();\n      onSwipeRight?.();\n    } else if (offsetX < -threshold && rightActions.length > 0) {\n      rightActions[0].onAction();\n      onSwipeLeft?.();\n    }\n  };\n\n  return (\n    <div className={`relative overflow-hidden rounded-xl ${className}`}>\n      {leftActions.length > 0 && (\n        <motion.div\n          style={{ opacity: leftOpacity, scale: leftScale }}\n          className={`absolute inset-y-0 left-0 flex items-center justify-start pl-4 ${leftActions[0].bgColor} rounded-l-xl`}\n        >\n          <div className=\"flex flex-col items-center gap-1\">\n            {(() => {\n              const IconComponent = leftActions[0].icon;\n              return <IconComponent className={`w-5 h-5 ${leftActions[0].color}`} />;\n            })()}\n            <span className={`text-xs font-medium ${leftActions[0].color}`}>\n              {leftActions[0].label}\n            </span>\n          </div>\n        </motion.div>\n      )}\n\n      {rightActions.length > 0 && (\n        <motion.div\n          style={{ opacity: rightOpacity, scale: rightScale }}\n          className={`absolute inset-y-0 right-0 flex items-center justify-end pr-4 ${rightActions[0].bgColor} rounded-r-xl`}\n        >\n          <div className=\"flex flex-col items-center gap-1\">\n            {(() => {\n              const IconComponent = rightActions[0].icon;\n              return <IconComponent className={`w-5 h-5 ${rightActions[0].color}`} />;\n            })()}\n            <span className={`text-xs font-medium ${rightActions[0].color}`}>\n              {rightActions[0].label}\n            </span>\n          </div>\n        </motion.div>\n      )}\n\n      <motion.div\n        drag=\"x\"\n        dragConstraints={{ left: 0, right: 0 }}\n        dragElastic={0.1}\n        onDragStart={() => setIsDragging(true)}\n        onDragEnd={handleDragEnd}\n        style={{ x }}\n        className={`relative bg-card rounded-xl ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}\n        whileTap={{ cursor: \"grabbing\" }}\n      >\n        {children}\n      </motion.div>\n    </div>\n  );\n}\n\ninterface TransactionSwipeCardProps {\n  transaction: {\n    id: number;\n    description: string;\n    amount: string;\n    type: string;\n    category: string;\n    date: string;\n  };\n  onArchive?: () => void;\n  onDelete?: () => void;\n  onEdit?: () => void;\n  children: ReactNode;\n}\n\nexport function TransactionSwipeCard({\n  transaction,\n  onArchive,\n  onDelete,\n  onEdit,\n  children,\n}: TransactionSwipeCardProps) {\n  const leftActions: SwipeAction[] = [\n    {\n      id: \"complete\",\n      icon: Check,\n      label: \"Done\",\n      color: \"text-white\",\n      bgColor: \"bg-green-500\",\n      onAction: onArchive || (() => {}),\n    },\n  ];\n\n  const rightActions: SwipeAction[] = [\n    {\n      id: \"delete\",\n      icon: Trash2,\n      label: \"Delete\",\n      color: \"text-white\",\n      bgColor: \"bg-red-500\",\n      onAction: onDelete || (() => {}),\n    },\n  ];\n\n  return (\n    <SwipeableCard\n      leftActions={leftActions}\n      rightActions={rightActions}\n      className=\"mb-2\"\n    >\n      {children}\n    </SwipeableCard>\n  );\n}\n\ninterface GoalSwipeCardProps {\n  goal: {\n    id: number;\n    title: string;\n    currentAmount: string;\n    targetAmount: number;\n  };\n  onAddFunds?: () => void;\n  onEdit?: () => void;\n  children: ReactNode;\n}\n\nexport function GoalSwipeCard({\n  goal,\n  onAddFunds,\n  onEdit,\n  children,\n}: GoalSwipeCardProps) {\n  const leftActions: SwipeAction[] = [\n    {\n      id: \"add-funds\",\n      icon: () => (\n        <span className=\"text-lg font-bold text-white\">+$</span>\n      ),\n      label: \"Add Funds\",\n      color: \"text-white\",\n      bgColor: \"bg-green-500\",\n      onAction: onAddFunds || (() => {}),\n    },\n  ];\n\n  const rightActions: SwipeAction[] = [\n    {\n      id: \"edit\",\n      icon: Edit,\n      label: \"Edit\",\n      color: \"text-white\",\n      bgColor: \"bg-blue-500\",\n      onAction: onEdit || (() => {}),\n    },\n  ];\n\n  return (\n    <SwipeableCard\n      leftActions={leftActions}\n      rightActions={rightActions}\n      className=\"mb-3\"\n    >\n      {children}\n    </SwipeableCard>\n  );\n}\n","path":null,"size_bytes":5751,"size_tokens":null},"client/src/components/streak-system.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Flame, Trophy, Star, Zap, Calendar, Target, TrendingUp, Award, Check } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport confetti from \"canvas-confetti\";\n\ninterface StreakData {\n  currentStreak: number;\n  longestStreak: number;\n  lastCheckIn: string | null;\n  totalCheckIns: number;\n  weeklyProgress: boolean[];\n  achievements: Achievement[];\n}\n\ninterface Achievement {\n  id: string;\n  title: string;\n  description: string;\n  icon: string;\n  earnedAt: string | null;\n  progress: number;\n  target: number;\n}\n\nconst achievementIcons: Record<string, any> = {\n  flame: Flame,\n  trophy: Trophy,\n  star: Star,\n  zap: Zap,\n  target: Target,\n  trending: TrendingUp,\n  award: Award,\n};\n\nfunction triggerStreakConfetti() {\n  const count = 100;\n  const defaults = {\n    origin: { y: 0.7 },\n    zIndex: 9999,\n  };\n\n  function fire(particleRatio: number, opts: confetti.Options) {\n    confetti({\n      ...defaults,\n      ...opts,\n      particleCount: Math.floor(count * particleRatio),\n    });\n  }\n\n  fire(0.25, { spread: 26, startVelocity: 55, colors: ['#ff6b35', '#f7c59f'] });\n  fire(0.2, { spread: 60, colors: ['#ffd700', '#ff6b35'] });\n  fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8, colors: ['#ff6b35', '#ffd700', '#f7c59f'] });\n  fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2, colors: ['#ffd700'] });\n  fire(0.1, { spread: 120, startVelocity: 45, colors: ['#ff6b35'] });\n}\n\nexport function StreakWidget() {\n  const [showCelebration, setShowCelebration] = useState(false);\n  const { toast } = useToast();\n\n  const { data: streakData, isLoading } = useQuery<StreakData>({\n    queryKey: ['/api/streaks'],\n    staleTime: 1000 * 60 * 5,\n  });\n\n  const checkInMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest('POST', '/api/streaks/check-in', {});\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/streaks'] });\n      if (data.streakIncreased) {\n        setShowCelebration(true);\n        triggerStreakConfetti();\n        setTimeout(() => setShowCelebration(false), 3000);\n      }\n      toast({\n        title: data.streakIncreased ? \"Streak increased!\" : \"Already checked in today\",\n        description: data.streakIncreased \n          ? `You're on a ${data.newStreak}-day streak!` \n          : \"Come back tomorrow to keep your streak going.\",\n      });\n    },\n  });\n\n  const canCheckIn = () => {\n    if (!streakData?.lastCheckIn) return true;\n    const lastCheck = new Date(streakData.lastCheckIn);\n    const now = new Date();\n    return lastCheck.toDateString() !== now.toDateString();\n  };\n\n  if (isLoading) {\n    return (\n      <Card className=\"border-border/40\">\n        <CardContent className=\"p-4\">\n          <div className=\"animate-pulse space-y-3\">\n            <div className=\"h-6 bg-muted rounded w-24\" />\n            <div className=\"h-10 bg-muted rounded w-16\" />\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const streak = streakData?.currentStreak ?? 0;\n  const weekProgress = streakData?.weeklyProgress ?? [false, false, false, false, false, false, false];\n\n  return (\n    <Card className=\"border-border/40 hover:border-border/60 transition-colors overflow-hidden relative\">\n      <AnimatePresence>\n        {showCelebration && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"absolute inset-0 bg-gradient-to-br from-orange-500/20 to-yellow-500/20 z-10 pointer-events-none\"\n          />\n        )}\n      </AnimatePresence>\n\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"flex items-center gap-2\">\n            <motion.div\n              animate={streak > 0 ? { \n                scale: [1, 1.1, 1],\n                rotate: [0, -5, 5, 0],\n              } : {}}\n              transition={{ \n                duration: 2,\n                repeat: Infinity,\n                repeatType: \"reverse\",\n              }}\n              className={`p-2 rounded-lg ${streak > 0 ? 'bg-gradient-to-br from-orange-500 to-yellow-500' : 'bg-muted'}`}\n            >\n              <Flame className={`w-5 h-5 ${streak > 0 ? 'text-white' : 'text-muted-foreground'}`} />\n            </motion.div>\n            <div>\n              <p className=\"text-xs font-medium text-muted-foreground\">Daily Streak</p>\n              <motion.p \n                key={streak}\n                initial={{ scale: 1.5, opacity: 0 }}\n                animate={{ scale: 1, opacity: 1 }}\n                className=\"text-2xl font-bold\"\n              >\n                {streak}\n                <span className=\"text-sm font-normal text-muted-foreground ml-1\">days</span>\n              </motion.p>\n            </div>\n          </div>\n\n          <Button\n            size=\"sm\"\n            onClick={() => checkInMutation.mutate()}\n            disabled={!canCheckIn() || checkInMutation.isPending}\n            className={canCheckIn() \n              ? \"bg-gradient-to-r from-orange-500 to-yellow-500 hover:from-orange-600 hover:to-yellow-600 text-white shadow-lg shadow-orange-500/25\"\n              : \"\"\n            }\n            data-testid=\"button-check-in\"\n          >\n            {checkInMutation.isPending ? (\n              <motion.div\n                animate={{ rotate: 360 }}\n                transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n              >\n                <Zap className=\"w-4 h-4\" />\n              </motion.div>\n            ) : canCheckIn() ? (\n              <>\n                <Check className=\"w-4 h-4 mr-1\" />\n                Check In\n              </>\n            ) : (\n              <>\n                <Check className=\"w-4 h-4 mr-1\" />\n                Done\n              </>\n            )}\n          </Button>\n        </div>\n\n        <div className=\"flex items-center gap-1 mt-3\">\n          {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, idx) => (\n            <div key={idx} className=\"flex-1 flex flex-col items-center gap-1\">\n              <span className=\"text-[10px] text-muted-foreground\">{day}</span>\n              <motion.div\n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                transition={{ delay: idx * 0.05 }}\n                className={`w-6 h-6 rounded-full flex items-center justify-center ${\n                  weekProgress[idx]\n                    ? 'bg-gradient-to-br from-orange-500 to-yellow-500'\n                    : 'bg-muted'\n                }`}\n              >\n                {weekProgress[idx] && <Check className=\"w-3 h-3 text-white\" />}\n              </motion.div>\n            </div>\n          ))}\n        </div>\n\n        {streak >= 7 && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mt-3 pt-3 border-t border-border/40\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <Trophy className=\"w-4 h-4 text-yellow-500\" />\n              <span className=\"text-xs text-muted-foreground\">\n                Best: {streakData?.longestStreak ?? streak} days\n              </span>\n            </div>\n          </motion.div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport function AchievementBadges() {\n  const { data: streakData } = useQuery<StreakData>({\n    queryKey: ['/api/streaks'],\n  });\n\n  const achievements = streakData?.achievements ?? [];\n  const earnedAchievements = achievements.filter(a => a.earnedAt);\n  const inProgressAchievements = achievements.filter(a => !a.earnedAt && a.progress > 0);\n\n  if (achievements.length === 0) {\n    return null;\n  }\n\n  return (\n    <Card className=\"border-border/40\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Award className=\"w-5 h-5 text-primary\" />\n          <h3 className=\"font-semibold\">Achievements</h3>\n          <Badge variant=\"secondary\" className=\"ml-auto\">\n            {earnedAchievements.length}/{achievements.length}\n          </Badge>\n        </div>\n\n        <div className=\"grid grid-cols-4 sm:grid-cols-6 gap-3\">\n          {achievements.slice(0, 6).map((achievement, idx) => {\n            const IconComponent = achievementIcons[achievement.icon] || Trophy;\n            const isEarned = !!achievement.earnedAt;\n\n            return (\n              <motion.div\n                key={achievement.id}\n                initial={{ opacity: 0, scale: 0.8 }}\n                animate={{ opacity: 1, scale: 1 }}\n                transition={{ delay: idx * 0.05 }}\n                className=\"relative group\"\n              >\n                <div\n                  className={`aspect-square rounded-xl flex items-center justify-center transition-all ${\n                    isEarned\n                      ? 'bg-gradient-to-br from-primary to-primary/80 shadow-lg shadow-primary/25'\n                      : 'bg-muted/50 grayscale'\n                  }`}\n                >\n                  <IconComponent className={`w-6 h-6 ${isEarned ? 'text-primary-foreground' : 'text-muted-foreground'}`} />\n                </div>\n\n                {!isEarned && achievement.progress > 0 && (\n                  <div className=\"absolute -bottom-1 left-1 right-1\">\n                    <Progress \n                      value={(achievement.progress / achievement.target) * 100} \n                      className=\"h-1\"\n                    />\n                  </div>\n                )}\n\n                <div className=\"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\">\n                  <div className=\"absolute inset-0 bg-black/60 rounded-xl\" />\n                  <p className=\"relative text-[10px] text-white text-center px-1 font-medium\">\n                    {achievement.title}\n                  </p>\n                </div>\n              </motion.div>\n            );\n          })}\n        </div>\n\n        {inProgressAchievements.length > 0 && (\n          <div className=\"mt-4 pt-3 border-t border-border/40\">\n            <p className=\"text-xs text-muted-foreground mb-2\">Next achievement</p>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-muted\">\n                {(() => {\n                  const next = inProgressAchievements[0];\n                  const IconComponent = achievementIcons[next.icon] || Trophy;\n                  return <IconComponent className=\"w-4 h-4 text-muted-foreground\" />;\n                })()}\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium truncate\">{inProgressAchievements[0].title}</p>\n                <Progress \n                  value={(inProgressAchievements[0].progress / inProgressAchievements[0].target) * 100} \n                  className=\"h-1.5 mt-1\"\n                />\n              </div>\n              <span className=\"text-xs text-muted-foreground\">\n                {inProgressAchievements[0].progress}/{inProgressAchievements[0].target}\n              </span>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":11603,"size_tokens":null},"client/src/components/product-tour.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useLocation } from \"wouter\";\nimport {\n  X,\n  ChevronRight,\n  ChevronLeft,\n  Sparkles,\n  Target,\n  Brain,\n  Wallet,\n  Check,\n  ArrowRight,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport confetti from \"canvas-confetti\";\n\ninterface TourStep {\n  id: string;\n  title: string;\n  description: string;\n  target?: string;\n  position: \"top\" | \"bottom\" | \"left\" | \"right\" | \"center\";\n  icon: any;\n  action?: {\n    label: string;\n    onClick: () => void;\n  };\n}\n\nconst tourSteps: TourStep[] = [\n  {\n    id: \"welcome\",\n    title: \"Welcome to Twealth\",\n    description: \"Your AI-powered financial command center. Let me show you around in 30 seconds.\",\n    position: \"center\",\n    icon: Sparkles,\n  },\n  {\n    id: \"dashboard\",\n    title: \"Your Financial Health\",\n    description: \"See your overall score, key metrics, and AI-powered insights at a glance.\",\n    target: '[data-testid=\"hero-health-score\"]',\n    position: \"bottom\",\n    icon: Target,\n  },\n  {\n    id: \"ai-assistant\",\n    title: \"AI Financial Advisor\",\n    description: \"Ask anything about your finances. Get personalized advice from GPT-5 & Claude.\",\n    target: '[data-testid=\"button-view-ai-insights\"]',\n    position: \"left\",\n    icon: Brain,\n  },\n  {\n    id: \"quick-actions\",\n    title: \"Quick Actions\",\n    description: \"Add transactions, create goals, and track spending with one tap.\",\n    target: '[data-testid=\"fab-add\"]',\n    position: \"top\",\n    icon: Wallet,\n  },\n  {\n    id: \"complete\",\n    title: \"You're All Set!\",\n    description: \"Start by asking the AI a question or setting your first savings goal.\",\n    position: \"center\",\n    icon: Check,\n  },\n];\n\nexport function ProductTour() {\n  const [isActive, setIsActive] = useState(false);\n  const [currentStep, setCurrentStep] = useState(0);\n  const [targetRect, setTargetRect] = useState<DOMRect | null>(null);\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    const hasSeenTour = localStorage.getItem(\"twealth_tour_completed\");\n    const hasSeenOnboarding = localStorage.getItem(\"onboarding_completed\");\n    \n    if (hasSeenOnboarding === \"true\" && !hasSeenTour) {\n      const timer = setTimeout(() => {\n        setIsActive(true);\n      }, 1500);\n      return () => clearTimeout(timer);\n    }\n  }, []);\n\n  useEffect(() => {\n    if (!isActive) return;\n\n    const step = tourSteps[currentStep];\n    if (step.target) {\n      const element = document.querySelector(step.target);\n      if (element) {\n        const rect = element.getBoundingClientRect();\n        setTargetRect(rect);\n        element.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n      } else {\n        setTargetRect(null);\n      }\n    } else {\n      setTargetRect(null);\n    }\n  }, [currentStep, isActive]);\n\n  const completeTour = useCallback(() => {\n    localStorage.setItem(\"twealth_tour_completed\", \"true\");\n    setIsActive(false);\n    \n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n      colors: ['#3b82f6', '#8b5cf6', '#22c55e'],\n    });\n  }, []);\n\n  const nextStep = () => {\n    if (currentStep < tourSteps.length - 1) {\n      setCurrentStep(currentStep + 1);\n    } else {\n      completeTour();\n    }\n  };\n\n  const prevStep = () => {\n    if (currentStep > 0) {\n      setCurrentStep(currentStep - 1);\n    }\n  };\n\n  const skipTour = () => {\n    localStorage.setItem(\"twealth_tour_completed\", \"true\");\n    setIsActive(false);\n  };\n\n  if (!isActive) return null;\n\n  const step = tourSteps[currentStep];\n  const IconComponent = step.icon;\n  const progress = ((currentStep + 1) / tourSteps.length) * 100;\n\n  const getTooltipPosition = () => {\n    if (!targetRect || step.position === \"center\") {\n      return {\n        top: \"50%\",\n        left: \"50%\",\n        transform: \"translate(-50%, -50%)\",\n      };\n    }\n\n    const padding = 16;\n    const tooltipWidth = 320;\n    const tooltipHeight = 200;\n\n    switch (step.position) {\n      case \"top\":\n        return {\n          top: `${targetRect.top - tooltipHeight - padding}px`,\n          left: `${targetRect.left + targetRect.width / 2}px`,\n          transform: \"translateX(-50%)\",\n        };\n      case \"bottom\":\n        return {\n          top: `${targetRect.bottom + padding}px`,\n          left: `${targetRect.left + targetRect.width / 2}px`,\n          transform: \"translateX(-50%)\",\n        };\n      case \"left\":\n        return {\n          top: `${targetRect.top + targetRect.height / 2}px`,\n          left: `${targetRect.left - tooltipWidth - padding}px`,\n          transform: \"translateY(-50%)\",\n        };\n      case \"right\":\n        return {\n          top: `${targetRect.top + targetRect.height / 2}px`,\n          left: `${targetRect.right + padding}px`,\n          transform: \"translateY(-50%)\",\n        };\n      default:\n        return {};\n    }\n  };\n\n  return (\n    <AnimatePresence>\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        exit={{ opacity: 0 }}\n        className=\"fixed inset-0 z-[100]\"\n      >\n        <div \n          className=\"absolute inset-0 bg-black/60 backdrop-blur-sm\"\n          onClick={skipTour}\n        />\n\n        {targetRect && step.position !== \"center\" && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            className=\"absolute pointer-events-none\"\n            style={{\n              top: targetRect.top - 8,\n              left: targetRect.left - 8,\n              width: targetRect.width + 16,\n              height: targetRect.height + 16,\n              boxShadow: \"0 0 0 9999px rgba(0, 0, 0, 0.6)\",\n              borderRadius: \"12px\",\n            }}\n          >\n            <motion.div\n              animate={{\n                boxShadow: [\n                  \"0 0 0 0 rgba(59, 130, 246, 0.4)\",\n                  \"0 0 0 8px rgba(59, 130, 246, 0)\",\n                ],\n              }}\n              transition={{\n                duration: 1.5,\n                repeat: Infinity,\n              }}\n              className=\"absolute inset-0 rounded-xl border-2 border-primary\"\n            />\n          </motion.div>\n        )}\n\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9, y: 20 }}\n          animate={{ opacity: 1, scale: 1, y: 0 }}\n          exit={{ opacity: 0, scale: 0.9, y: 20 }}\n          transition={{ type: \"spring\", damping: 25, stiffness: 300 }}\n          style={getTooltipPosition()}\n          className=\"fixed w-[320px] max-w-[90vw] z-[101]\"\n        >\n          <Card className=\"border-primary/30 shadow-2xl overflow-hidden\">\n            <CardContent className=\"p-0\">\n              <div className=\"p-5\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    transition={{ type: \"spring\", delay: 0.1 }}\n                    className=\"p-2.5 rounded-xl bg-gradient-to-br from-primary to-primary/80 shadow-lg shadow-primary/25\"\n                  >\n                    <IconComponent className=\"w-5 h-5 text-primary-foreground\" />\n                  </motion.div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={skipTour}\n                    className=\"h-8 text-xs text-muted-foreground hover:text-foreground\"\n                  >\n                    Skip tour\n                    <X className=\"w-3 h-3 ml-1\" />\n                  </Button>\n                </div>\n\n                <motion.h3\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.15 }}\n                  className=\"text-lg font-semibold mb-2\"\n                >\n                  {step.title}\n                </motion.h3>\n\n                <motion.p\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: 0.2 }}\n                  className=\"text-sm text-muted-foreground mb-4\"\n                >\n                  {step.description}\n                </motion.p>\n\n                <div className=\"mb-4\">\n                  <div className=\"flex items-center justify-between text-xs text-muted-foreground mb-1.5\">\n                    <span>Step {currentStep + 1} of {tourSteps.length}</span>\n                    <span>{Math.round(progress)}%</span>\n                  </div>\n                  <Progress value={progress} className=\"h-1.5\" />\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                  {currentStep > 0 && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={prevStep}\n                      className=\"flex-1\"\n                    >\n                      <ChevronLeft className=\"w-4 h-4 mr-1\" />\n                      Back\n                    </Button>\n                  )}\n                  <Button\n                    size=\"sm\"\n                    onClick={nextStep}\n                    className=\"flex-1 bg-gradient-to-r from-primary to-primary/80\"\n                  >\n                    {currentStep === tourSteps.length - 1 ? (\n                      <>\n                        Get Started\n                        <ArrowRight className=\"w-4 h-4 ml-1\" />\n                      </>\n                    ) : (\n                      <>\n                        Next\n                        <ChevronRight className=\"w-4 h-4 ml-1\" />\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </div>\n\n              <div className=\"flex justify-center gap-1.5 pb-4\">\n                {tourSteps.map((_, idx) => (\n                  <motion.button\n                    key={idx}\n                    onClick={() => setCurrentStep(idx)}\n                    className={`h-1.5 rounded-full transition-all ${\n                      idx === currentStep\n                        ? \"w-6 bg-primary\"\n                        : idx < currentStep\n                        ? \"w-1.5 bg-primary/50\"\n                        : \"w-1.5 bg-muted\"\n                    }`}\n                    whileHover={{ scale: 1.2 }}\n                  />\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n\nexport function TourTrigger() {\n  const [, setIsActive] = useState(false);\n\n  const startTour = () => {\n    localStorage.removeItem(\"twealth_tour_completed\");\n    window.location.reload();\n  };\n\n  return (\n    <Button\n      variant=\"outline\"\n      size=\"sm\"\n      onClick={startTour}\n      className=\"text-xs\"\n      data-testid=\"button-restart-tour\"\n    >\n      <Sparkles className=\"w-3 h-3 mr-1.5\" />\n      Product Tour\n    </Button>\n  );\n}\n\nexport default ProductTour;\n","path":null,"size_bytes":11092,"size_tokens":null},"client/src/components/smart-nudges.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport {\n  AlertTriangle,\n  TrendingUp,\n  Target,\n  Sparkles,\n  Crown,\n  X,\n  ArrowRight,\n  Zap,\n  PiggyBank,\n  Bell,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useUserCurrency } from \"@/lib/userContext\";\n\ninterface Nudge {\n  id: string;\n  type: \"warning\" | \"opportunity\" | \"celebration\" | \"upgrade\";\n  title: string;\n  message: string;\n  action?: {\n    label: string;\n    href: string;\n  };\n  icon: any;\n  priority: number;\n  dismissable: boolean;\n}\n\nconst nudgeStyles = {\n  warning: {\n    bg: \"from-orange-500/10 to-red-500/10\",\n    border: \"border-orange-500/30\",\n    icon: \"text-orange-500\",\n    badge: \"bg-orange-500/20 text-orange-600\",\n  },\n  opportunity: {\n    bg: \"from-green-500/10 to-emerald-500/10\",\n    border: \"border-green-500/30\",\n    icon: \"text-green-500\",\n    badge: \"bg-green-500/20 text-green-600\",\n  },\n  celebration: {\n    bg: \"from-purple-500/10 to-pink-500/10\",\n    border: \"border-purple-500/30\",\n    icon: \"text-purple-500\",\n    badge: \"bg-purple-500/20 text-purple-600\",\n  },\n  upgrade: {\n    bg: \"from-blue-500/10 to-primary/10\",\n    border: \"border-primary/30\",\n    icon: \"text-primary\",\n    badge: \"bg-primary/20 text-primary\",\n  },\n};\n\nexport function SmartNudgeBanner() {\n  const [, setLocation] = useLocation();\n  const [dismissedNudges, setDismissedNudges] = useState<Set<string>>(new Set());\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const { formatAmount } = useUserCurrency();\n\n  const { data: subscription } = useQuery<any>({\n    queryKey: ['/api/subscription'],\n  });\n\n  const { data: stats } = useQuery<any>({\n    queryKey: ['/api/dashboard/stats'],\n  });\n\n  const { data: goals } = useQuery<any>({\n    queryKey: ['/api/financial-goals'],\n  });\n\n  const generateNudges = (): Nudge[] => {\n    const nudges: Nudge[] = [];\n\n    if (subscription?.plan?.name === 'free') {\n      const scoutUsed = subscription?.usage?.scoutQueriesUsed ?? 0;\n      const scoutLimit = subscription?.plan?.scoutLimit ?? 50;\n      const usagePercent = (scoutUsed / scoutLimit) * 100;\n\n      if (usagePercent >= 80) {\n        nudges.push({\n          id: \"ai-limit-warning\",\n          type: \"upgrade\",\n          title: usagePercent >= 100 ? \"AI Query Limit Reached\" : \"Running Low on AI Queries\",\n          message: usagePercent >= 100\n            ? \"Upgrade to Pro for unlimited AI conversations and premium insights.\"\n            : `You've used ${scoutUsed}/${scoutLimit} queries. Upgrade for unlimited access.`,\n          action: { label: \"Upgrade to Pro\", href: \"/subscription\" },\n          icon: Crown,\n          priority: 1,\n          dismissable: false,\n        });\n      }\n    }\n\n    if (stats) {\n      const monthlyIncome = stats.monthlyIncome ?? 0;\n      const monthlyExpenses = stats.monthlyExpenses ?? 0;\n      \n      if (monthlyExpenses > monthlyIncome && monthlyIncome > 0) {\n        nudges.push({\n          id: \"overspending-warning\",\n          type: \"warning\",\n          title: \"Spending Exceeds Income\",\n          message: `You're spending ${formatAmount(monthlyExpenses - monthlyIncome)} more than you earn. Let's fix this.`,\n          action: { label: \"Review Spending\", href: \"/money-tracking\" },\n          icon: AlertTriangle,\n          priority: 2,\n          dismissable: true,\n        });\n      }\n\n      const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100 : 0;\n      if (savingsRate >= 20 && savingsRate < 30) {\n        nudges.push({\n          id: \"savings-opportunity\",\n          type: \"opportunity\",\n          title: \"Great Savings Rate!\",\n          message: `You're saving ${savingsRate.toFixed(0)}% of income. A few tweaks could push you to 30%.`,\n          action: { label: \"Get AI Tips\", href: \"/ai-assistant\" },\n          icon: TrendingUp,\n          priority: 4,\n          dismissable: true,\n        });\n      }\n    }\n\n    if (Array.isArray(goals)) {\n      const activeGoals = goals.filter((g: any) => g.status === \"active\");\n      \n      activeGoals.forEach((goal: any) => {\n        const progress = (parseFloat(goal.currentAmount || \"0\") / parseFloat(goal.targetAmount)) * 100;\n        \n        if (progress >= 90 && progress < 100) {\n          nudges.push({\n            id: `goal-almost-${goal.id}`,\n            type: \"celebration\",\n            title: \"Almost There!\",\n            message: `\"${goal.title}\" is ${progress.toFixed(0)}% complete. One final push!`,\n            action: { label: \"View Goal\", href: \"/financial-goals\" },\n            icon: Target,\n            priority: 3,\n            dismissable: true,\n          });\n        }\n\n        if (goal.targetDate) {\n          const daysLeft = Math.ceil((new Date(goal.targetDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));\n          if (daysLeft <= 7 && daysLeft > 0 && progress < 80) {\n            nudges.push({\n              id: `goal-deadline-${goal.id}`,\n              type: \"warning\",\n              title: \"Deadline Approaching\",\n              message: `\"${goal.title}\" is due in ${daysLeft} days with ${progress.toFixed(0)}% progress.`,\n              action: { label: \"Add Funds\", href: \"/financial-goals\" },\n              icon: Bell,\n              priority: 2,\n              dismissable: true,\n            });\n          }\n        }\n      });\n\n      if (activeGoals.length === 0 && (stats?.monthlyIncome ?? 0) > 0) {\n        nudges.push({\n          id: \"no-goals\",\n          type: \"opportunity\",\n          title: \"Set Your First Goal\",\n          message: \"Start your savings journey with a clear target. AI can help you plan.\",\n          action: { label: \"Create Goal\", href: \"/financial-goals\" },\n          icon: PiggyBank,\n          priority: 5,\n          dismissable: true,\n        });\n      }\n    }\n\n    return nudges\n      .filter(n => !dismissedNudges.has(n.id))\n      .sort((a, b) => a.priority - b.priority);\n  };\n\n  const nudges = generateNudges();\n  const currentNudge = nudges[currentIndex];\n\n  useEffect(() => {\n    if (nudges.length > 1) {\n      const interval = setInterval(() => {\n        setCurrentIndex(prev => (prev + 1) % nudges.length);\n      }, 8000);\n      return () => clearInterval(interval);\n    }\n  }, [nudges.length]);\n\n  if (!currentNudge) return null;\n\n  const style = nudgeStyles[currentNudge.type];\n  const IconComponent = currentNudge.icon;\n\n  return (\n    <AnimatePresence mode=\"wait\">\n      <motion.div\n        key={currentNudge.id}\n        initial={{ opacity: 0, y: -10, height: 0 }}\n        animate={{ opacity: 1, y: 0, height: \"auto\" }}\n        exit={{ opacity: 0, y: -10, height: 0 }}\n        transition={{ duration: 0.3, ease: [0.4, 0, 0.2, 1] }}\n        className=\"w-full\"\n      >\n        <Card className={`border ${style.border} overflow-hidden`}>\n          <CardContent className={`p-0 bg-gradient-to-r ${style.bg}`}>\n            <div className=\"flex items-center gap-3 p-3 sm:p-4\">\n              <motion.div\n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                transition={{ type: \"spring\", damping: 15 }}\n                className={`p-2 rounded-lg bg-background/80 ${style.icon}`}\n              >\n                <IconComponent className=\"w-5 h-5\" />\n              </motion.div>\n\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 mb-0.5\">\n                  <h4 className=\"font-semibold text-sm\">{currentNudge.title}</h4>\n                  {nudges.length > 1 && (\n                    <Badge variant=\"outline\" className=\"text-[10px] px-1.5\">\n                      {currentIndex + 1}/{nudges.length}\n                    </Badge>\n                  )}\n                </div>\n                <p className=\"text-xs text-muted-foreground line-clamp-1\">\n                  {currentNudge.message}\n                </p>\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                {currentNudge.action && (\n                  <Button\n                    size=\"sm\"\n                    onClick={() => setLocation(currentNudge.action!.href)}\n                    className=\"hidden sm:flex h-8 text-xs\"\n                    data-testid={`nudge-action-${currentNudge.id}`}\n                  >\n                    {currentNudge.action.label}\n                    <ArrowRight className=\"w-3 h-3 ml-1\" />\n                  </Button>\n                )}\n\n                {currentNudge.dismissable && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => setDismissedNudges(prev => {\n                      const newSet = new Set(Array.from(prev));\n                      newSet.add(currentNudge.id);\n                      return newSet;\n                    })}\n                    className=\"h-8 w-8 text-muted-foreground hover:text-foreground\"\n                    data-testid={`nudge-dismiss-${currentNudge.id}`}\n                  >\n                    <X className=\"w-4 h-4\" />\n                  </Button>\n                )}\n              </div>\n            </div>\n\n            {nudges.length > 1 && (\n              <div className=\"flex gap-1 px-4 pb-2\">\n                {nudges.map((_, idx) => (\n                  <motion.button\n                    key={idx}\n                    onClick={() => setCurrentIndex(idx)}\n                    className={`h-1 rounded-full transition-all ${\n                      idx === currentIndex \n                        ? 'w-6 bg-foreground/60' \n                        : 'w-2 bg-foreground/20 hover:bg-foreground/40'\n                    }`}\n                    whileHover={{ scale: 1.2 }}\n                    whileTap={{ scale: 0.9 }}\n                  />\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </motion.div>\n    </AnimatePresence>\n  );\n}\n\nexport function UpgradeNudgeCard() {\n  const [, setLocation] = useLocation();\n  const [isVisible, setIsVisible] = useState(true);\n\n  const { data: subscription } = useQuery<any>({\n    queryKey: ['/api/subscription'],\n  });\n\n  if (!isVisible || subscription?.plan?.name !== 'free') return null;\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.95 }}\n      animate={{ opacity: 1, scale: 1 }}\n      exit={{ opacity: 0, scale: 0.95 }}\n    >\n      <Card className=\"border-primary/30 bg-gradient-to-br from-primary/5 to-primary/10 overflow-hidden relative\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setIsVisible(false)}\n          className=\"absolute top-2 right-2 h-6 w-6 text-muted-foreground\"\n        >\n          <X className=\"w-3 h-3\" />\n        </Button>\n\n        <CardContent className=\"p-5\">\n          <div className=\"flex items-start gap-4\">\n            <motion.div\n              animate={{ \n                rotate: [0, 10, -10, 0],\n                scale: [1, 1.1, 1],\n              }}\n              transition={{ \n                duration: 3,\n                repeat: Infinity,\n                repeatType: \"reverse\",\n              }}\n              className=\"p-3 rounded-xl bg-gradient-to-br from-primary to-primary/80 shadow-lg shadow-primary/25\"\n            >\n              <Crown className=\"w-6 h-6 text-primary-foreground\" />\n            </motion.div>\n\n            <div className=\"flex-1\">\n              <h3 className=\"font-semibold mb-1\">Unlock Premium AI</h3>\n              <p className=\"text-sm text-muted-foreground mb-3\">\n                Get GPT-5 & Claude Opus, unlimited queries, and advanced financial tools.\n              </p>\n\n              <div className=\"flex flex-wrap gap-2 mb-4\">\n                {['Unlimited AI', 'Advanced Insights', 'Priority Support'].map((feature, idx) => (\n                  <motion.div\n                    key={feature}\n                    initial={{ opacity: 0, x: -10 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    transition={{ delay: idx * 0.1 }}\n                  >\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      <Sparkles className=\"w-3 h-3 mr-1\" />\n                      {feature}\n                    </Badge>\n                  </motion.div>\n                ))}\n              </div>\n\n              <Button\n                onClick={() => setLocation(\"/subscription\")}\n                className=\"w-full sm:w-auto bg-gradient-to-r from-primary to-primary/80 shadow-lg shadow-primary/25\"\n                data-testid=\"upgrade-nudge-button\"\n              >\n                <Zap className=\"w-4 h-4 mr-2\" />\n                Upgrade Now\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":12899,"size_tokens":null},"client/src/components/virtual-list.tsx":{"content":"import { useRef, useCallback, useState, useEffect, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useVirtualList } from '@/hooks/use-mobile-performance';\n\ninterface VirtualListProps<T> {\n  items: T[];\n  itemHeight: number;\n  containerHeight: number;\n  renderItem: (item: T, index: number, isVisible: boolean) => React.ReactNode;\n  keyExtractor: (item: T) => string | number;\n  overscan?: number;\n  className?: string;\n  emptyState?: React.ReactNode;\n  animationDelay?: number;\n  showAllItems?: boolean;\n}\n\nexport function VirtualList<T>({\n  items,\n  itemHeight,\n  containerHeight,\n  renderItem,\n  keyExtractor,\n  overscan = 5,\n  className = '',\n  emptyState,\n  animationDelay = 0.03,\n  showAllItems = false,\n}: VirtualListProps<T>) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const animatedItemsRef = useRef<Set<string | number>>(new Set());\n  const [, forceUpdate] = useState(0);\n\n  const {\n    visibleItems,\n    totalHeight,\n    offsetY,\n    onScroll,\n  } = useVirtualList(items, itemHeight, containerHeight, overscan);\n\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\n    onScroll(e);\n  }, [onScroll]);\n\n  const markAnimated = useCallback((key: string | number) => {\n    if (!animatedItemsRef.current.has(key)) {\n      animatedItemsRef.current.add(key);\n    }\n  }, []);\n\n  const checkShouldAnimate = useCallback((key: string | number): boolean => {\n    return !animatedItemsRef.current.has(key);\n  }, []);\n\n  if (items.length === 0 && emptyState) {\n    return <>{emptyState}</>;\n  }\n\n  if (showAllItems || items.length <= 20) {\n    return (\n      <div className={className}>\n        <AnimatePresence mode=\"popLayout\">\n          {items.map((item, index) => {\n            const key = keyExtractor(item);\n            const shouldAnimate = checkShouldAnimate(key);\n            \n            return (\n              <motion.div\n                key={key}\n                initial={shouldAnimate ? { opacity: 0, y: 15 } : false}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, x: -50, scale: 0.95 }}\n                transition={{\n                  duration: 0.25,\n                  delay: shouldAnimate ? index * animationDelay : 0,\n                  ease: [0.25, 0.1, 0.25, 1],\n                }}\n                onAnimationComplete={() => markAnimated(key)}\n              >\n                {renderItem(item, index, true)}\n              </motion.div>\n            );\n          })}\n        </AnimatePresence>\n      </div>\n    );\n  }\n\n  const startIndex = Math.max(0, Math.floor(offsetY / itemHeight));\n\n  return (\n    <div\n      ref={containerRef}\n      className={`overflow-y-auto ${className}`}\n      style={{ height: containerHeight }}\n      onScroll={handleScroll}\n    >\n      <div style={{ height: totalHeight, position: 'relative' }}>\n        <div\n          style={{\n            position: 'absolute',\n            top: 0,\n            left: 0,\n            right: 0,\n            transform: `translateY(${offsetY}px)`,\n          }}\n        >\n          <AnimatePresence mode=\"popLayout\">\n            {visibleItems.map((item, localIndex) => {\n              const globalIndex = startIndex + localIndex;\n              const key = keyExtractor(item);\n              const shouldAnimate = checkShouldAnimate(key);\n\n              return (\n                <motion.div\n                  key={key}\n                  initial={shouldAnimate ? { opacity: 0, y: 15 } : false}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, scale: 0.95 }}\n                  transition={{\n                    duration: 0.2,\n                    delay: shouldAnimate ? localIndex * 0.02 : 0,\n                    ease: [0.25, 0.1, 0.25, 1],\n                  }}\n                  onAnimationComplete={() => markAnimated(key)}\n                  style={{ height: itemHeight }}\n                >\n                  {renderItem(item, globalIndex, true)}\n                </motion.div>\n              );\n            })}\n          </AnimatePresence>\n        </div>\n      </div>\n    </div>\n  );\n}\n\ninterface VirtualGridProps<T> {\n  items: T[];\n  itemWidth: number;\n  itemHeight: number;\n  containerHeight: number;\n  columns: number;\n  renderItem: (item: T, index: number) => React.ReactNode;\n  keyExtractor: (item: T) => string | number;\n  gap?: number;\n  className?: string;\n  emptyState?: React.ReactNode;\n}\n\nexport function VirtualGrid<T>({\n  items,\n  itemWidth,\n  itemHeight,\n  containerHeight,\n  columns,\n  renderItem,\n  keyExtractor,\n  gap = 16,\n  className = '',\n  emptyState,\n}: VirtualGridProps<T>) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const animatedItemsRef = useRef<Set<string | number>>(new Set());\n  const [scrollTop, setScrollTop] = useState(0);\n\n  const rowHeight = itemHeight + gap;\n  const totalRows = Math.ceil(items.length / columns);\n  const totalHeight = totalRows * rowHeight;\n\n  const overscan = 2;\n  const startRow = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);\n  const endRow = Math.min(\n    totalRows - 1,\n    Math.ceil((scrollTop + containerHeight) / rowHeight) + overscan\n  );\n\n  const visibleItems: Array<{ item: T; row: number; col: number; index: number }> = [];\n  for (let row = startRow; row <= endRow; row++) {\n    for (let col = 0; col < columns; col++) {\n      const index = row * columns + col;\n      if (index < items.length) {\n        visibleItems.push({ item: items[index], row, col, index });\n      }\n    }\n  }\n\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\n    setScrollTop(e.currentTarget.scrollTop);\n  }, []);\n\n  const markAnimated = useCallback((key: string | number) => {\n    if (!animatedItemsRef.current.has(key)) {\n      animatedItemsRef.current.add(key);\n    }\n  }, []);\n\n  const checkShouldAnimate = useCallback((key: string | number): boolean => {\n    return !animatedItemsRef.current.has(key);\n  }, []);\n\n  if (items.length === 0 && emptyState) {\n    return <>{emptyState}</>;\n  }\n\n  if (items.length <= columns * 4) {\n    return (\n      <div \n        className={`grid gap-4 ${className}`}\n        style={{ gridTemplateColumns: `repeat(${columns}, minmax(0, 1fr))` }}\n      >\n        <AnimatePresence mode=\"popLayout\">\n          {items.map((item, index) => {\n            const key = keyExtractor(item);\n            const shouldAnimate = checkShouldAnimate(key);\n            \n            return (\n              <motion.div\n                key={key}\n                initial={shouldAnimate ? { opacity: 0, y: 20, scale: 0.95 } : false}\n                animate={{ opacity: 1, y: 0, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.9 }}\n                transition={{\n                  duration: 0.3,\n                  delay: shouldAnimate ? index * 0.05 : 0,\n                  ease: [0.25, 0.1, 0.25, 1],\n                }}\n                onAnimationComplete={() => markAnimated(key)}\n              >\n                {renderItem(item, index)}\n              </motion.div>\n            );\n          })}\n        </AnimatePresence>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={`overflow-y-auto ${className}`}\n      style={{ height: containerHeight }}\n      onScroll={handleScroll}\n    >\n      <div style={{ height: totalHeight, position: 'relative' }}>\n        <AnimatePresence mode=\"popLayout\">\n          {visibleItems.map(({ item, row, col, index }) => {\n            const key = keyExtractor(item);\n            const shouldAnimate = checkShouldAnimate(key);\n            const localIndex = index - startRow * columns;\n\n            return (\n              <motion.div\n                key={key}\n                initial={shouldAnimate ? { opacity: 0, y: 20, scale: 0.95 } : false}\n                animate={{ opacity: 1, y: 0, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.9 }}\n                transition={{\n                  duration: 0.25,\n                  delay: shouldAnimate ? localIndex * 0.03 : 0,\n                  ease: [0.25, 0.1, 0.25, 1],\n                }}\n                onAnimationComplete={() => markAnimated(key)}\n                style={{\n                  position: 'absolute',\n                  top: row * rowHeight,\n                  left: col * (itemWidth + gap),\n                  width: itemWidth,\n                  height: itemHeight,\n                }}\n              >\n                {renderItem(item, index)}\n              </motion.div>\n            );\n          })}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n\nexport function InfiniteScrollList<T>({\n  items,\n  itemHeight,\n  renderItem,\n  keyExtractor,\n  onLoadMore,\n  hasMore,\n  isLoading,\n  className = '',\n  emptyState,\n  loadingIndicator,\n}: {\n  items: T[];\n  itemHeight: number;\n  renderItem: (item: T, index: number) => React.ReactNode;\n  keyExtractor: (item: T) => string | number;\n  onLoadMore: () => void;\n  hasMore: boolean;\n  isLoading: boolean;\n  className?: string;\n  emptyState?: React.ReactNode;\n  loadingIndicator?: React.ReactNode;\n}) {\n  const observerRef = useRef<HTMLDivElement>(null);\n  const animatedItemsRef = useRef<Set<string | number>>(new Set());\n\n  useEffect(() => {\n    const observer = new IntersectionObserver(\n      (entries) => {\n        if (entries[0].isIntersecting && hasMore && !isLoading) {\n          onLoadMore();\n        }\n      },\n      { threshold: 0.1 }\n    );\n\n    if (observerRef.current) {\n      observer.observe(observerRef.current);\n    }\n\n    return () => observer.disconnect();\n  }, [hasMore, isLoading, onLoadMore]);\n\n  const markAnimated = useCallback((key: string | number) => {\n    if (!animatedItemsRef.current.has(key)) {\n      animatedItemsRef.current.add(key);\n    }\n  }, []);\n\n  const checkShouldAnimate = useCallback((key: string | number): boolean => {\n    return !animatedItemsRef.current.has(key);\n  }, []);\n\n  if (items.length === 0 && emptyState && !isLoading) {\n    return <>{emptyState}</>;\n  }\n\n  return (\n    <div className={className}>\n      <AnimatePresence mode=\"popLayout\">\n        {items.map((item, index) => {\n          const key = keyExtractor(item);\n          const shouldAnimate = checkShouldAnimate(key);\n          const recentlyAdded = index >= items.length - 10;\n\n          return (\n            <motion.div\n              key={key}\n              initial={shouldAnimate ? { opacity: 0, y: 15 } : false}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, x: -50 }}\n              transition={{\n                duration: 0.25,\n                delay: shouldAnimate && recentlyAdded ? (index % 10) * 0.03 : 0,\n                ease: [0.25, 0.1, 0.25, 1],\n              }}\n              onAnimationComplete={() => markAnimated(key)}\n              style={{ minHeight: itemHeight }}\n            >\n              {renderItem(item, index)}\n            </motion.div>\n          );\n        })}\n      </AnimatePresence>\n\n      <div ref={observerRef} className=\"h-4\" />\n\n      {isLoading && (\n        <motion.div\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"py-4 flex justify-center\"\n        >\n          {loadingIndicator || (\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <div className=\"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin\" />\n              <span className=\"text-sm\">Loading more...</span>\n            </div>\n          )}\n        </motion.div>\n      )}\n    </div>\n  );\n}\n\nexport function CollapsibleList<T>({\n  items,\n  renderItem,\n  keyExtractor,\n  initialVisible = 5,\n  showMoreLabel = 'Show more',\n  showLessLabel = 'Show less',\n  className = '',\n  emptyState,\n}: {\n  items: T[];\n  renderItem: (item: T, index: number) => React.ReactNode;\n  keyExtractor: (item: T) => string | number;\n  initialVisible?: number;\n  showMoreLabel?: string;\n  showLessLabel?: string;\n  className?: string;\n  emptyState?: React.ReactNode;\n}) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const seenItemsRef = useRef<Set<string | number>>(new Set());\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  const visibleItems = isExpanded ? items : items.slice(0, initialVisible);\n  const hasMore = items.length > initialVisible;\n\n  const checkAndMarkSeen = useCallback((key: string | number): boolean => {\n    if (seenItemsRef.current.has(key)) {\n      return false;\n    }\n    seenItemsRef.current.add(key);\n    return true;\n  }, []);\n\n  const handleToggle = useCallback(() => {\n    setIsExpanded(prev => !prev);\n  }, []);\n\n  if (items.length === 0 && emptyState) {\n    return <>{emptyState}</>;\n  }\n\n  return (\n    <div ref={containerRef} className={className}>\n      <AnimatePresence mode=\"sync\">\n        {visibleItems.map((item, index) => {\n          const key = keyExtractor(item);\n          const shouldAnimate = checkAndMarkSeen(key);\n          const isNewlyVisible = isExpanded && index >= initialVisible;\n\n          return (\n            <motion.div\n              key={key}\n              initial={shouldAnimate ? { opacity: 0, y: 12 } : false}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0 }}\n              transition={{\n                duration: 0.2,\n                delay: shouldAnimate && isNewlyVisible ? (index - initialVisible) * 0.025 : (shouldAnimate ? Math.min(index * 0.025, 0.15) : 0),\n                ease: [0.25, 0.1, 0.25, 1],\n              }}\n            >\n              {renderItem(item, index)}\n            </motion.div>\n          );\n        })}\n      </AnimatePresence>\n\n      {hasMore && (\n        <motion.button\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          onClick={handleToggle}\n          className=\"w-full py-3 text-sm text-primary hover:text-primary/80 font-medium flex items-center justify-center gap-2 transition-colors\"\n          data-testid=\"button-toggle-list-expansion\"\n        >\n          <motion.span\n            animate={{ rotate: isExpanded ? 180 : 0 }}\n            transition={{ duration: 0.2 }}\n          >\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n              <path d=\"m6 9 6 6 6-6\" />\n            </svg>\n          </motion.span>\n          {isExpanded ? showLessLabel : `${showMoreLabel} (${items.length - initialVisible} more)`}\n        </motion.button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14359,"size_tokens":null},"client/src/components/ui/responsive-dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { useMediaQuery } from \"@/hooks/use-mobile\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n  DialogClose,\n} from \"./dialog\"\nimport {\n  Drawer,\n  DrawerClose,\n  DrawerContent,\n  DrawerDescription,\n  DrawerFooter,\n  DrawerHeader,\n  DrawerTitle,\n} from \"./drawer\"\nimport { cn } from \"@/lib/utils\"\n\ninterface ResponsiveDialogProps {\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n  children: React.ReactNode\n}\n\nconst ResponsiveDialog = ({ \n  open, \n  onOpenChange, \n  children \n}: ResponsiveDialogProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <Drawer open={open} onOpenChange={onOpenChange}>\n        {children}\n      </Drawer>\n    )\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      {children}\n    </Dialog>\n  )\n}\n\ninterface ResponsiveDialogContentProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogContent = ({ \n  children, \n  className \n}: ResponsiveDialogContentProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerContent \n        className={cn(\n          \"max-h-[90dvh] overflow-y-auto\",\n          className\n        )}\n      >\n        {children}\n      </DrawerContent>\n    )\n  }\n\n  return (\n    <DialogContent className={className}>\n      {children}\n    </DialogContent>\n  )\n}\n\ninterface ResponsiveDialogHeaderProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogHeader = ({ \n  children, \n  className \n}: ResponsiveDialogHeaderProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerHeader className={className}>\n        {children}\n      </DrawerHeader>\n    )\n  }\n\n  return (\n    <DialogHeader className={className}>\n      {children}\n    </DialogHeader>\n  )\n}\n\ninterface ResponsiveDialogTitleProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogTitle = ({ \n  children, \n  className \n}: ResponsiveDialogTitleProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerTitle className={className}>\n        {children}\n      </DrawerTitle>\n    )\n  }\n\n  return (\n    <DialogTitle className={className}>\n      {children}\n    </DialogTitle>\n  )\n}\n\ninterface ResponsiveDialogDescriptionProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogDescription = ({ \n  children, \n  className \n}: ResponsiveDialogDescriptionProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerDescription className={className}>\n        {children}\n      </DrawerDescription>\n    )\n  }\n\n  return (\n    <DialogDescription className={className}>\n      {children}\n    </DialogDescription>\n  )\n}\n\ninterface ResponsiveDialogFooterProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogFooter = ({ \n  children, \n  className \n}: ResponsiveDialogFooterProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerFooter className={cn(\"pb-safe\", className)}>\n        {children}\n      </DrawerFooter>\n    )\n  }\n\n  return (\n    <DialogFooter className={className}>\n      {children}\n    </DialogFooter>\n  )\n}\n\ninterface ResponsiveDialogCloseProps {\n  children: React.ReactNode\n  className?: string\n  asChild?: boolean\n}\n\nconst ResponsiveDialogClose = ({ \n  children, \n  className,\n  asChild \n}: ResponsiveDialogCloseProps) => {\n  const isMobile = useMediaQuery(\"(max-width: 640px)\")\n\n  if (isMobile) {\n    return (\n      <DrawerClose asChild={asChild} className={className}>\n        {children}\n      </DrawerClose>\n    )\n  }\n\n  return (\n    <DialogClose asChild={asChild} className={className}>\n      {children}\n    </DialogClose>\n  )\n}\n\ninterface ResponsiveDialogBodyProps {\n  children: React.ReactNode\n  className?: string\n}\n\nconst ResponsiveDialogBody = ({ \n  children, \n  className \n}: ResponsiveDialogBodyProps) => {\n  return (\n    <div className={cn(\"px-4 py-2 sm:px-6\", className)}>\n      {children}\n    </div>\n  )\n}\n\nexport {\n  ResponsiveDialog,\n  ResponsiveDialogContent,\n  ResponsiveDialogHeader,\n  ResponsiveDialogTitle,\n  ResponsiveDialogDescription,\n  ResponsiveDialogFooter,\n  ResponsiveDialogClose,\n  ResponsiveDialogBody,\n}\n","path":null,"size_bytes":4418,"size_tokens":null},"client/src/components/glassmorphism-checkout-modal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { X, CreditCard, Check, Loader2, Shield, Lock, Sparkles, Crown, Zap, ArrowRight, ArrowLeft, CheckCircle2, AlertCircle, Users, Calendar } from \"lucide-react\";\nimport { SiVisa, SiMastercard, SiApplepay, SiGooglepay } from \"react-icons/si\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { loadStripe } from \"@stripe/stripe-js\";\nimport { Elements, CardNumberElement, CardExpiryElement, CardCvcElement, useStripe, useElements, PaymentRequestButtonElement } from \"@stripe/react-stripe-js\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nconst stripePromise = import.meta.env.VITE_STRIPE_PUBLIC_KEY \n  ? loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY)\n  : null;\n\ninterface SubscriptionPlan {\n  id: string;\n  name: string;\n  displayName: string;\n  description: string;\n  priceUsd: string;\n  billingInterval: string;\n  scoutLimit: number;\n  sonnetLimit: number;\n  gpt5Limit: number;\n  opusLimit: number;\n  features: string[];\n}\n\ninterface GlassmorphismCheckoutModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  plan: SubscriptionPlan | null;\n  localizedPrice: {\n    amount: number;\n    currency: { symbol: string; code: string };\n    isDiscounted?: boolean;\n    originalAmount?: number;\n  };\n  userCurrency: string;\n  onSuccess: () => void;\n}\n\nconst cardElementOptions = {\n  style: {\n    base: {\n      fontSize: '16px',\n      color: '#1f2937',\n      fontFamily: '\"Inter\", system-ui, -apple-system, sans-serif',\n      fontSmoothing: 'antialiased',\n      '::placeholder': {\n        color: '#9ca3af',\n      },\n    },\n    invalid: {\n      color: '#ef4444',\n      iconColor: '#ef4444',\n    },\n  },\n};\n\nconst cardElementOptionsDark = {\n  style: {\n    base: {\n      fontSize: '16px',\n      color: '#f9fafb',\n      fontFamily: '\"Inter\", system-ui, -apple-system, sans-serif',\n      fontSmoothing: 'antialiased',\n      '::placeholder': {\n        color: '#6b7280',\n      },\n    },\n    invalid: {\n      color: '#ef4444',\n      iconColor: '#ef4444',\n    },\n  },\n};\n\nfunction StepIndicator({ currentStep, totalSteps }: { currentStep: number; totalSteps: number }) {\n  return (\n    <div className=\"flex items-center justify-center gap-2 mb-4\">\n      {Array.from({ length: totalSteps }, (_, i) => (\n        <div key={i} className=\"flex items-center\">\n          <motion.div \n            className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium transition-all ${\n              i + 1 <= currentStep \n                ? 'bg-blue-600 text-white' \n                : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'\n            }`}\n            initial={false}\n            animate={{ scale: i + 1 === currentStep ? 1.1 : 1 }}\n          >\n            {i + 1 < currentStep ? <Check className=\"w-4 h-4\" /> : i + 1}\n          </motion.div>\n          {i < totalSteps - 1 && (\n            <div className={`w-8 h-0.5 mx-1 transition-colors ${\n              i + 1 < currentStep ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'\n            }`} />\n          )}\n        </div>\n      ))}\n    </div>\n  );\n}\n\nfunction QuickPayButtons({ \n  plan, \n  localizedPrice, \n  onSuccess, \n  onError,\n  isEnterprise,\n  isPro\n}: { \n  plan: SubscriptionPlan;\n  localizedPrice: any;\n  onSuccess: () => void;\n  onError: (error: string) => void;\n  isEnterprise: boolean;\n  isPro: boolean;\n}) {\n  const stripe = useStripe();\n  const [paymentRequest, setPaymentRequest] = useState<any>(null);\n  const [canMakePayment, setCanMakePayment] = useState(false);\n\n  useEffect(() => {\n    if (!stripe) return;\n\n    const pr = stripe.paymentRequest({\n      country: 'US',\n      currency: localizedPrice.currency.code.toLowerCase(),\n      total: {\n        label: `Twealth ${plan.displayName}`,\n        amount: Math.round(localizedPrice.amount * 100),\n      },\n      requestPayerName: true,\n      requestPayerEmail: true,\n    });\n\n    pr.canMakePayment().then(result => {\n      if (result) {\n        setPaymentRequest(pr);\n        setCanMakePayment(true);\n      }\n    });\n\n    pr.on('paymentmethod', async (ev) => {\n      try {\n        const response = await apiRequest(\"POST\", \"/api/subscription/create-payment-intent\", { \n          planId: plan.id \n        });\n        const data = await response.json();\n\n        if (!data.clientSecret) {\n          ev.complete('fail');\n          onError(\"Unable to process payment\");\n          return;\n        }\n\n        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(\n          data.clientSecret,\n          { payment_method: ev.paymentMethod.id },\n          { handleActions: false }\n        );\n\n        if (confirmError) {\n          ev.complete('fail');\n          onError(confirmError.message || \"Payment failed\");\n        } else if (paymentIntent?.status === 'succeeded') {\n          ev.complete('success');\n          queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n          queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n          onSuccess();\n        } else if (paymentIntent?.status === 'requires_action') {\n          ev.complete('success');\n          const { error } = await stripe.confirmCardPayment(data.clientSecret);\n          if (error) {\n            onError(error.message || \"Authentication failed\");\n          } else {\n            queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n            queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n            onSuccess();\n          }\n        } else {\n          ev.complete('fail');\n          onError(\"Payment could not be completed\");\n        }\n      } catch (err: any) {\n        ev.complete('fail');\n        onError(err.message || \"Payment failed\");\n      }\n    });\n  }, [stripe, plan, localizedPrice]);\n\n  if (!canMakePayment || !paymentRequest) return null;\n\n  return (\n    <div className=\"space-y-3 mb-4\">\n      <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400\">\n        <div className=\"flex-1 h-px bg-gray-200 dark:bg-gray-700\" />\n        <span>Express Checkout</span>\n        <div className=\"flex-1 h-px bg-gray-200 dark:bg-gray-700\" />\n      </div>\n      \n      <div className=\"rounded-xl overflow-hidden border border-gray-200/50 dark:border-gray-700/50\">\n        <PaymentRequestButtonElement\n          options={{\n            paymentRequest,\n            style: {\n              paymentRequestButton: {\n                type: 'default',\n                theme: 'dark',\n                height: '48px',\n              },\n            },\n          }}\n        />\n      </div>\n\n      <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400\">\n        <div className=\"flex-1 h-px bg-gray-200 dark:bg-gray-700\" />\n        <span>Or pay with card</span>\n        <div className=\"flex-1 h-px bg-gray-200 dark:bg-gray-700\" />\n      </div>\n    </div>\n  );\n}\n\nfunction EmbeddedPaymentForm({ \n  plan, \n  localizedPrice,\n  userCurrency,\n  onSuccess, \n  onBack,\n  isEnterprise,\n  isPro,\n  onAuthError\n}: { \n  plan: SubscriptionPlan;\n  localizedPrice: any;\n  userCurrency: string;\n  onSuccess: () => void;\n  onBack: () => void;\n  isEnterprise: boolean;\n  isPro: boolean;\n  onAuthError: () => void;\n}) {\n  const stripe = useStripe();\n  const elements = useElements();\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [cardComplete, setCardComplete] = useState({\n    cardNumber: false,\n    cardExpiry: false,\n    cardCvc: false,\n  });\n  const [focusedField, setFocusedField] = useState<string | null>(null);\n  const [isDark, setIsDark] = useState(false);\n  const [saveCard, setSaveCard] = useState(true);\n\n  useEffect(() => {\n    setIsDark(document.documentElement.classList.contains('dark'));\n    const observer = new MutationObserver(() => {\n      setIsDark(document.documentElement.classList.contains('dark'));\n    });\n    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });\n    return () => observer.disconnect();\n  }, []);\n\n  const isFormComplete = cardComplete.cardNumber && cardComplete.cardExpiry && cardComplete.cardCvc;\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n\n    if (!stripe || !elements) {\n      setError(\"Payment system not initialized. Please try again.\");\n      return;\n    }\n\n    const cardNumber = elements.getElement(CardNumberElement);\n    if (!cardNumber) {\n      setError(\"Card input not found\");\n      return;\n    }\n\n    setIsProcessing(true);\n\n    try {\n      const response = await apiRequest(\"POST\", \"/api/subscription/create-payment-intent\", { \n        planId: plan.id \n      });\n      const data = await response.json();\n\n      if (data.requiresSetup) {\n        setError(\"Payment processing is being configured. Please try again later.\");\n        setIsProcessing(false);\n        return;\n      }\n\n      const { clientSecret } = data;\n\n      if (!clientSecret) {\n        setError(\"Unable to initialize payment. Please try again.\");\n        setIsProcessing(false);\n        return;\n      }\n\n      const result = await stripe.confirmCardPayment(clientSecret, {\n        payment_method: {\n          card: cardNumber,\n        },\n        setup_future_usage: saveCard ? 'off_session' : undefined,\n      });\n\n      if (result.error) {\n        if (result.error.type === 'card_error' || result.error.type === 'validation_error') {\n          setError(result.error.message || \"Your card was declined. Please try a different card.\");\n        } else if (result.error.code === 'payment_intent_authentication_failure') {\n          setError(\"Authentication failed. Please try again or use a different card.\");\n        } else {\n          setError(result.error.message || \"Payment failed. Please try again.\");\n        }\n        setIsProcessing(false);\n        return;\n      }\n      \n      const { paymentIntent } = result;\n      \n      if (paymentIntent) {\n        switch (paymentIntent.status) {\n          case 'succeeded':\n            queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n            queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n            onSuccess();\n            break;\n          case 'requires_action':\n          case 'requires_confirmation':\n            const { error: actionError, paymentIntent: confirmedIntent } = await stripe.confirmCardPayment(clientSecret);\n            \n            if (actionError) {\n              setError(actionError.message || \"Authentication failed. Please try again.\");\n            } else if (confirmedIntent?.status === 'succeeded') {\n              queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n              queryClient.invalidateQueries({ queryKey: ['/api/subscription/usage'] });\n              onSuccess();\n            } else {\n              setError(\"Payment could not be completed. Please try again.\");\n            }\n            break;\n          case 'requires_payment_method':\n            setError(\"Your card was declined. Please check your card details or try a different card.\");\n            setCardComplete({ cardNumber: false, cardExpiry: false, cardCvc: false });\n            break;\n          case 'processing':\n            queryClient.invalidateQueries({ queryKey: ['/api/subscription/current'] });\n            onSuccess();\n            break;\n          case 'canceled':\n            setError(\"Payment was canceled. Please try again.\");\n            break;\n          default:\n            setError(`Unexpected payment status. Please contact support if the issue persists.`);\n        }\n      }\n    } catch (err: any) {\n      if (err.message?.includes('sign in') || err.message?.includes('401')) {\n        onAuthError();\n        return;\n      }\n      setError(err.message || \"An unexpected error occurred. Please try again.\");\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const getAccentColor = () => {\n    if (isEnterprise) return \"from-amber-500 to-yellow-600\";\n    if (isPro) return \"from-blue-600 to-indigo-600\";\n    return \"from-gray-700 to-gray-900\";\n  };\n\n  const currentOptions = isDark ? cardElementOptionsDark : cardElementOptions;\n  const dailyCost = (localizedPrice.amount / 30).toFixed(2);\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-5\">\n      <StepIndicator currentStep={2} totalSteps={2} />\n      \n      <QuickPayButtons\n        plan={plan}\n        localizedPrice={localizedPrice}\n        onSuccess={onSuccess}\n        onError={setError}\n        isEnterprise={isEnterprise}\n        isPro={isPro}\n      />\n\n      <div className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2\">\n            <CreditCard className=\"w-4 h-4\" />\n            Card Number\n          </label>\n          <div \n            className={`relative rounded-xl border transition-all duration-200 ${\n              focusedField === 'number' \n                ? 'border-blue-500 ring-2 ring-blue-500/20' \n                : 'border-gray-200/50 dark:border-gray-700/50'\n            } bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm`}\n          >\n            <div className=\"px-4 py-3.5\">\n              <CardNumberElement\n                options={currentOptions}\n                onFocus={() => setFocusedField('number')}\n                onBlur={() => setFocusedField(null)}\n                onChange={(e) => setCardComplete(prev => ({ ...prev, cardNumber: e.complete }))}\n              />\n            </div>\n            {cardComplete.cardNumber && (\n              <motion.div \n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                className=\"absolute right-3 top-1/2 -translate-y-1/2\"\n              >\n                <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n              </motion.div>\n            )}\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n              Expiry Date\n            </label>\n            <div \n              className={`relative rounded-xl border transition-all duration-200 ${\n                focusedField === 'expiry' \n                  ? 'border-blue-500 ring-2 ring-blue-500/20' \n                  : 'border-gray-200/50 dark:border-gray-700/50'\n              } bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm`}\n            >\n              <div className=\"px-4 py-3.5\">\n                <CardExpiryElement\n                  options={currentOptions}\n                  onFocus={() => setFocusedField('expiry')}\n                  onBlur={() => setFocusedField(null)}\n                  onChange={(e) => setCardComplete(prev => ({ ...prev, cardExpiry: e.complete }))}\n                />\n              </div>\n              {cardComplete.cardExpiry && (\n                <motion.div \n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2\"\n                >\n                  <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n                </motion.div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n              CVC\n            </label>\n            <div \n              className={`relative rounded-xl border transition-all duration-200 ${\n                focusedField === 'cvc' \n                  ? 'border-blue-500 ring-2 ring-blue-500/20' \n                  : 'border-gray-200/50 dark:border-gray-700/50'\n              } bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm`}\n            >\n              <div className=\"px-4 py-3.5\">\n                <CardCvcElement\n                  options={currentOptions}\n                  onFocus={() => setFocusedField('cvc')}\n                  onBlur={() => setFocusedField(null)}\n                  onChange={(e) => setCardComplete(prev => ({ ...prev, cardCvc: e.complete }))}\n                />\n              </div>\n              {cardComplete.cardCvc && (\n                <motion.div \n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2\"\n                >\n                  <CheckCircle2 className=\"w-5 h-5 text-green-500\" />\n                </motion.div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-3 p-3 rounded-xl bg-gray-50/50 dark:bg-gray-800/30 border border-gray-200/50 dark:border-gray-700/30\">\n        <Checkbox \n          id=\"save-card\" \n          checked={saveCard} \n          onCheckedChange={(checked) => setSaveCard(checked as boolean)}\n          data-testid=\"checkbox-save-card\"\n        />\n        <label htmlFor=\"save-card\" className=\"text-sm text-gray-600 dark:text-gray-400 cursor-pointer\">\n          Save card for future payments\n        </label>\n      </div>\n\n      <AnimatePresence>\n        {error && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            className=\"flex items-center gap-2 p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 text-red-600 dark:text-red-400 text-sm\"\n            data-testid=\"alert-payment-error\"\n          >\n            <AlertCircle className=\"w-4 h-4 flex-shrink-0\" />\n            <span>{error}</span>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      <div className=\"pt-2 space-y-3\">\n        <div className=\"flex items-center justify-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-2\">\n          <Users className=\"w-3.5 h-3.5\" />\n          <span>Join 12,000+ users managing their wealth</span>\n        </div>\n\n        <Button\n          type=\"submit\"\n          disabled={!stripe || !isFormComplete || isProcessing}\n          className={`w-full h-12 rounded-xl font-medium transition-all duration-300 bg-gradient-to-r ${getAccentColor()} text-white shadow-lg ${\n            isEnterprise ? 'shadow-amber-500/25 hover:shadow-amber-500/40' : \n            isPro ? 'shadow-blue-500/25 hover:shadow-blue-500/40' : \n            'shadow-gray-500/25'\n          } disabled:opacity-50 disabled:cursor-not-allowed`}\n          data-testid=\"button-pay-now\"\n        >\n          {isProcessing ? (\n            <div className=\"flex items-center gap-2\">\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\n              <span>Processing Payment...</span>\n            </div>\n          ) : (\n            <div className=\"flex items-center gap-2\">\n              <Lock className=\"w-4 h-4\" />\n              <span>Pay {localizedPrice.currency.symbol}{localizedPrice.amount.toFixed(2)}</span>\n            </div>\n          )}\n        </Button>\n\n        <div className=\"text-center text-xs text-gray-500 dark:text-gray-400\">\n          Only {localizedPrice.currency.symbol}{dailyCost}/day\n        </div>\n\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          onClick={onBack}\n          disabled={isProcessing}\n          className=\"w-full h-10 rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-100/50 dark:hover:bg-gray-800/50\"\n          data-testid=\"button-back-to-plan\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Back to plan details\n        </Button>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-4 text-xs text-gray-400 dark:text-gray-500 pt-2\">\n        <div className=\"flex items-center gap-1.5\">\n          <Shield className=\"w-3.5 h-3.5\" />\n          <span>256-bit SSL</span>\n        </div>\n        <div className=\"flex items-center gap-1.5\">\n          <Lock className=\"w-3.5 h-3.5\" />\n          <span>PCI Compliant</span>\n        </div>\n        <div className=\"flex items-center gap-1.5\">\n          <CheckCircle2 className=\"w-3.5 h-3.5\" />\n          <span>30-day guarantee</span>\n        </div>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-3 pt-1\">\n        <SiVisa className=\"w-8 h-5 text-gray-400\" />\n        <SiMastercard className=\"w-8 h-5 text-gray-400\" />\n        <SiApplepay className=\"w-8 h-5 text-gray-400\" />\n        <SiGooglepay className=\"w-8 h-5 text-gray-400\" />\n      </div>\n    </form>\n  );\n}\n\nfunction PaymentSuccessView({ plan, onClose }: { plan: SubscriptionPlan; onClose: () => void }) {\n  return (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.9 }}\n      animate={{ opacity: 1, scale: 1 }}\n      className=\"text-center py-8 space-y-6\"\n    >\n      <motion.div\n        initial={{ scale: 0 }}\n        animate={{ scale: 1 }}\n        transition={{ type: \"spring\", damping: 15, stiffness: 200, delay: 0.2 }}\n        className=\"w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center shadow-lg shadow-green-500/30\"\n      >\n        <Check className=\"w-10 h-10 text-white\" />\n      </motion.div>\n\n      <div className=\"space-y-2\">\n        <motion.h3\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n          className=\"text-2xl font-bold text-gray-900 dark:text-white\"\n        >\n          Welcome to {plan.displayName}!\n        </motion.h3>\n        <motion.p\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.4 }}\n          className=\"text-gray-600 dark:text-gray-400\"\n        >\n          Your subscription is now active. Enjoy your premium features!\n        </motion.p>\n      </div>\n\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.5 }}\n      >\n        <Button\n          onClick={onClose}\n          className=\"px-8 h-12 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-medium shadow-lg shadow-green-500/25\"\n          data-testid=\"button-close-success\"\n        >\n          Start Exploring\n          <ArrowRight className=\"w-4 h-4 ml-2\" />\n        </Button>\n      </motion.div>\n    </motion.div>\n  );\n}\n\nexport default function GlassmorphismCheckoutModal({\n  isOpen,\n  onClose,\n  plan,\n  localizedPrice,\n  userCurrency,\n  onSuccess,\n}: GlassmorphismCheckoutModalProps) {\n  const [step, setStep] = useState<'confirm' | 'payment' | 'success'>('confirm');\n\n  useEffect(() => {\n    if (!isOpen) {\n      setStep('confirm');\n    }\n  }, [isOpen]);\n\n  if (!plan) return null;\n\n  const isPro = plan.name === \"pro\";\n  const isEnterprise = plan.name === \"enterprise\";\n  const dailyCost = (localizedPrice.amount / 30).toFixed(2);\n\n  const getGradientColors = () => {\n    if (isEnterprise) return \"from-amber-500/20 via-yellow-500/10 to-orange-500/20\";\n    if (isPro) return \"from-blue-500/20 via-indigo-500/10 to-purple-500/20\";\n    return \"from-gray-500/20 via-slate-500/10 to-gray-500/20\";\n  };\n\n  const getAccentColor = () => {\n    if (isEnterprise) return \"text-amber-400\";\n    if (isPro) return \"text-blue-400\";\n    return \"text-gray-400\";\n  };\n\n  const getBorderGlow = () => {\n    if (isEnterprise) return \"shadow-[0_0_60px_-15px_rgba(251,191,36,0.3)]\";\n    if (isPro) return \"shadow-[0_0_60px_-15px_rgba(59,130,246,0.3)]\";\n    return \"shadow-[0_0_60px_-15px_rgba(100,100,100,0.3)]\";\n  };\n\n  const getPlanIcon = () => {\n    if (isEnterprise) return <Crown className=\"w-6 h-6 text-amber-400\" />;\n    if (isPro) return <Sparkles className=\"w-6 h-6 text-blue-400\" />;\n    return <Zap className=\"w-6 h-6 text-gray-400\" />;\n  };\n\n  const getKeyFeatures = () => {\n    const features = [];\n    if (plan.scoutLimit === 999999) {\n      features.push(\"Unlimited Scout AI queries\");\n    } else {\n      features.push(`${plan.scoutLimit} Scout AI queries/month`);\n    }\n    if (plan.sonnetLimit > 0) features.push(`${plan.sonnetLimit} Sonnet reasoning queries`);\n    if (plan.gpt5Limit > 0) features.push(`${plan.gpt5Limit} GPT-5 math queries`);\n    if (plan.opusLimit > 0) features.push(`${plan.opusLimit === 999999 ? 'Unlimited' : plan.opusLimit} Opus CFO queries`);\n    return features.slice(0, 4);\n  };\n\n  const handleProceedToPayment = () => {\n    setStep('payment');\n  };\n\n  const handlePaymentSuccess = () => {\n    setStep('success');\n    onSuccess();\n  };\n\n  const handleClose = () => {\n    setStep('confirm');\n    onClose();\n  };\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50\"\n            onClick={step !== 'payment' ? handleClose : undefined}\n            data-testid=\"modal-backdrop\"\n          />\n\n          <motion.div\n            initial={{ opacity: 0, scale: 0.9, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 10 }}\n            transition={{ \n              type: \"spring\", \n              damping: 25, \n              stiffness: 300,\n              duration: 0.4 \n            }}\n            className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none overflow-y-auto\"\n          >\n            <div \n              className={`relative w-full max-w-md pointer-events-auto my-4 ${getBorderGlow()}`}\n              data-testid=\"modal-checkout\"\n            >\n              <div className={`absolute inset-0 rounded-3xl bg-gradient-to-br ${getGradientColors()} blur-xl opacity-50`} />\n              \n              <div className=\"relative rounded-3xl border border-white/20 dark:border-white/10 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl overflow-hidden max-h-[90vh] overflow-y-auto\">\n                <button\n                  onClick={handleClose}\n                  className=\"absolute top-4 right-4 p-2 rounded-full bg-white/20 dark:bg-gray-800/50 backdrop-blur-sm hover:bg-white/30 dark:hover:bg-gray-700/50 transition-colors z-10\"\n                  data-testid=\"button-close-modal\"\n                >\n                  <X className=\"w-4 h-4 text-gray-600 dark:text-gray-300\" />\n                </button>\n\n                <AnimatePresence mode=\"wait\">\n                  {step === 'confirm' && (\n                    <motion.div\n                      key=\"confirm\"\n                      initial={{ opacity: 0, x: -20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: -20 }}\n                      transition={{ duration: 0.3 }}\n                    >\n                      <div className=\"relative p-6 pb-4\">\n                        <StepIndicator currentStep={1} totalSteps={2} />\n                        \n                        <div className={`absolute top-0 left-0 right-0 h-32 bg-gradient-to-br ${getGradientColors()} opacity-60`} />\n                        \n                        <div className=\"relative\">\n                          <motion.div \n                            className=\"w-full aspect-[1.586/1] rounded-2xl relative overflow-hidden mb-6\"\n                            initial={{ rotateY: -10, rotateX: 5 }}\n                            animate={{ rotateY: 0, rotateX: 0 }}\n                            transition={{ duration: 0.6, delay: 0.1 }}\n                            style={{ perspective: 1000, transformStyle: \"preserve-3d\" }}\n                          >\n                            <div className={`absolute inset-0 bg-gradient-to-br ${\n                              isEnterprise \n                                ? \"from-amber-600 via-yellow-500 to-orange-600\"\n                                : isPro \n                                  ? \"from-blue-600 via-indigo-600 to-purple-600\"\n                                  : \"from-gray-700 via-gray-600 to-gray-800\"\n                            } rounded-2xl`} />\n                            \n                            <div className=\"absolute inset-0 bg-gradient-to-tr from-white/0 via-white/10 to-white/20 rounded-2xl\" />\n                            \n                            <div className=\"absolute inset-0 opacity-20\">\n                              <div className=\"absolute top-4 left-4 w-12 h-12 rounded-full bg-white/30 blur-lg\" />\n                              <div className=\"absolute bottom-8 right-8 w-20 h-20 rounded-full bg-white/20 blur-xl\" />\n                            </div>\n                            \n                            <div className=\"absolute inset-0 p-5 flex flex-col justify-between text-white\">\n                              <div className=\"flex justify-between items-start\">\n                                <div className=\"flex items-center gap-2\">\n                                  {getPlanIcon()}\n                                  <span className=\"font-semibold text-lg tracking-wide\">{plan.displayName}</span>\n                                </div>\n                                <div className=\"flex flex-col items-end\">\n                                  <CreditCard className=\"w-8 h-8 opacity-80\" />\n                                </div>\n                              </div>\n                              \n                              <div>\n                                <div className=\"flex items-end gap-2 mb-1\">\n                                  <span className=\"text-4xl font-bold tracking-tight\">\n                                    {localizedPrice.currency.symbol}{localizedPrice.amount.toFixed(2)}\n                                  </span>\n                                  <span className=\"text-white/70 text-sm mb-1.5\">/{plan.billingInterval}</span>\n                                </div>\n                                <div className=\"flex items-center gap-2\">\n                                  {userCurrency !== 'USD' && (\n                                    <p className=\"text-white/60 text-xs\">\n                                      ≈ ${parseFloat(plan.priceUsd).toFixed(2)} USD\n                                    </p>\n                                  )}\n                                  <p className=\"text-white/60 text-xs\">\n                                    ({localizedPrice.currency.symbol}{dailyCost}/day)\n                                  </p>\n                                </div>\n                              </div>\n                              \n                              <div className=\"flex items-center justify-between\">\n                                <div className=\"text-xs text-white/60 tracking-widest\">\n                                  TWEALTH {plan.name.toUpperCase()}\n                                </div>\n                                <div className=\"flex gap-1\">\n                                  <div className=\"w-6 h-6 rounded-full bg-white/30\" />\n                                  <div className=\"w-6 h-6 rounded-full bg-white/20 -ml-3\" />\n                                </div>\n                              </div>\n                            </div>\n                          </motion.div>\n                        </div>\n                      </div>\n\n                      <div className=\"px-6 pb-4\">\n                        <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-3\">\n                          What you'll get\n                        </h3>\n                        <div className=\"space-y-2.5\">\n                          {getKeyFeatures().map((feature, index) => (\n                            <motion.div\n                              key={index}\n                              initial={{ opacity: 0, x: -10 }}\n                              animate={{ opacity: 1, x: 0 }}\n                              transition={{ delay: 0.2 + index * 0.1 }}\n                              className=\"flex items-center gap-3\"\n                            >\n                              <div className={`w-5 h-5 rounded-full flex items-center justify-center ${\n                                isEnterprise \n                                  ? \"bg-amber-100 dark:bg-amber-900/30\" \n                                  : isPro \n                                    ? \"bg-blue-100 dark:bg-blue-900/30\"\n                                    : \"bg-gray-100 dark:bg-gray-800\"\n                              }`}>\n                                <Check className={`w-3 h-3 ${getAccentColor()}`} />\n                              </div>\n                              <span className=\"text-sm text-gray-600 dark:text-gray-300\">{feature}</span>\n                            </motion.div>\n                          ))}\n                        </div>\n                      </div>\n\n                      <div className=\"px-6 py-4 bg-gray-50/50 dark:bg-gray-800/30 border-t border-gray-200/50 dark:border-gray-700/30\">\n                        <div className=\"flex items-center justify-center gap-2 mb-3 text-xs text-gray-500 dark:text-gray-400\">\n                          <Users className=\"w-3.5 h-3.5\" />\n                          <span>Join 12,000+ users managing their wealth</span>\n                        </div>\n\n                        <div className=\"flex items-center justify-center gap-4 mb-4 text-xs text-gray-500 dark:text-gray-400\">\n                          <div className=\"flex items-center gap-1.5\">\n                            <Shield className=\"w-3.5 h-3.5\" />\n                            <span>Secure checkout</span>\n                          </div>\n                          <div className=\"flex items-center gap-1.5\">\n                            <Lock className=\"w-3.5 h-3.5\" />\n                            <span>256-bit encryption</span>\n                          </div>\n                          <div className=\"flex items-center gap-1.5\">\n                            <Calendar className=\"w-3.5 h-3.5\" />\n                            <span>30-day guarantee</span>\n                          </div>\n                        </div>\n\n                        <div className=\"flex gap-3\">\n                          <Button\n                            variant=\"outline\"\n                            onClick={handleClose}\n                            className=\"flex-1 h-12 rounded-xl border-gray-200 dark:border-gray-700 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm hover:bg-gray-100/80 dark:hover:bg-gray-700/50\"\n                            data-testid=\"button-cancel-checkout\"\n                          >\n                            Cancel\n                          </Button>\n                          <Button\n                            onClick={handleProceedToPayment}\n                            className={`flex-1 h-12 rounded-xl font-medium transition-all duration-300 ${\n                              isEnterprise\n                                ? \"bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-600 hover:to-yellow-700 text-white shadow-lg shadow-amber-500/25\"\n                                : isPro\n                                  ? \"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white shadow-lg shadow-blue-500/25\"\n                                  : \"bg-gray-900 dark:bg-white text-white dark:text-gray-900 hover:bg-gray-800 dark:hover:bg-gray-100\"\n                            }`}\n                            data-testid=\"button-continue-to-payment\"\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <CreditCard className=\"w-4 h-4\" />\n                              <span>Continue</span>\n                              <ArrowRight className=\"w-4 h-4\" />\n                            </div>\n                          </Button>\n                        </div>\n                      </div>\n                    </motion.div>\n                  )}\n\n                  {step === 'payment' && (\n                    <motion.div\n                      key=\"payment\"\n                      initial={{ opacity: 0, x: 20 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: 20 }}\n                      transition={{ duration: 0.3 }}\n                      className=\"p-6\"\n                    >\n                      <div className=\"mb-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          {getPlanIcon()}\n                          <div>\n                            <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                              {plan.displayName}\n                            </h3>\n                            <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                              {localizedPrice.currency.symbol}{localizedPrice.amount.toFixed(2)}/{plan.billingInterval}\n                            </p>\n                          </div>\n                        </div>\n                      </div>\n\n                      {stripePromise ? (\n                        <Elements stripe={stripePromise}>\n                          <EmbeddedPaymentForm\n                            plan={plan}\n                            localizedPrice={localizedPrice}\n                            userCurrency={userCurrency}\n                            onSuccess={handlePaymentSuccess}\n                            onBack={() => setStep('confirm')}\n                            isEnterprise={isEnterprise}\n                            isPro={isPro}\n                            onAuthError={() => {\n                              handleClose();\n                              window.location.href = '/auth';\n                            }}\n                          />\n                        </Elements>\n                      ) : (\n                        <div className=\"text-center py-8 space-y-4\">\n                          <div className=\"w-16 h-16 mx-auto rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center\">\n                            <AlertCircle className=\"w-8 h-8 text-amber-600 dark:text-amber-400\" />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <h4 className=\"font-semibold text-gray-900 dark:text-white\">\n                              Payment Not Available\n                            </h4>\n                            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                              Payment processing is being configured. Please try again later or contact support.\n                            </p>\n                          </div>\n                          <Button\n                            onClick={() => setStep('confirm')}\n                            variant=\"outline\"\n                            className=\"mt-4\"\n                          >\n                            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                            Go Back\n                          </Button>\n                        </div>\n                      )}\n                    </motion.div>\n                  )}\n\n                  {step === 'success' && (\n                    <motion.div\n                      key=\"success\"\n                      initial={{ opacity: 0, scale: 0.9 }}\n                      animate={{ opacity: 1, scale: 1 }}\n                      transition={{ duration: 0.3 }}\n                      className=\"p-6\"\n                    >\n                      <PaymentSuccessView plan={plan} onClose={handleClose} />\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n","path":null,"size_bytes":39776,"size_tokens":null},"client/src/pages/share.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Share2, MessageSquare, Target, ArrowRight, Loader2 } from \"lucide-react\";\n\nexport default function SharePage() {\n  const [, setLocation] = useLocation();\n  const [sharedData, setSharedData] = useState<{\n    title?: string;\n    text?: string;\n    url?: string;\n  }>({});\n  const [isProcessing, setIsProcessing] = useState(true);\n\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const title = params.get(\"title\") || \"\";\n    const text = params.get(\"text\") || \"\";\n    const url = params.get(\"url\") || \"\";\n\n    setSharedData({ title, text, url });\n    setIsProcessing(false);\n  }, []);\n\n  const handleAskAI = () => {\n    const query = [sharedData.title, sharedData.text, sharedData.url]\n      .filter(Boolean)\n      .join(\" - \");\n    \n    setLocation(`/ai-assistant?query=${encodeURIComponent(query)}`);\n  };\n\n  const handleAddToGoal = () => {\n    setLocation(\"/financial-goals\");\n  };\n\n  const handleGoToDashboard = () => {\n    setLocation(\"/\");\n  };\n\n  if (isProcessing) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[60vh]\" data-testid=\"share-loading\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          <p className=\"text-muted-foreground\">Processing shared content...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const hasContent = sharedData.title || sharedData.text || sharedData.url;\n\n  return (\n    <div className=\"container max-w-2xl mx-auto p-4 space-y-6\" data-testid=\"share-page\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-primary/10 rounded-lg\">\n              <Share2 className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div>\n              <CardTitle>Shared Content</CardTitle>\n              <CardDescription>\n                You shared something with Twealth\n              </CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {hasContent ? (\n            <>\n              {sharedData.title && (\n                <div className=\"space-y-1\">\n                  <p className=\"text-sm font-medium text-muted-foreground\">Title</p>\n                  <p className=\"text-foreground\" data-testid=\"text-shared-title\">\n                    {sharedData.title}\n                  </p>\n                </div>\n              )}\n              {sharedData.text && (\n                <div className=\"space-y-1\">\n                  <p className=\"text-sm font-medium text-muted-foreground\">Content</p>\n                  <p className=\"text-foreground\" data-testid=\"text-shared-text\">\n                    {sharedData.text}\n                  </p>\n                </div>\n              )}\n              {sharedData.url && (\n                <div className=\"space-y-1\">\n                  <p className=\"text-sm font-medium text-muted-foreground\">URL</p>\n                  <a \n                    href={sharedData.url} \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-primary hover:underline break-all\"\n                    data-testid=\"link-shared-url\"\n                  >\n                    {sharedData.url}\n                  </a>\n                </div>\n              )}\n            </>\n          ) : (\n            <p className=\"text-muted-foreground text-center py-4\">\n              No content was shared. Try sharing something from another app!\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {hasContent && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">What would you like to do?</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <Button \n              onClick={handleAskAI}\n              className=\"w-full justify-between\"\n              variant=\"outline\"\n              data-testid=\"button-ask-ai\"\n            >\n              <span className=\"flex items-center gap-2\">\n                <MessageSquare className=\"h-4 w-4\" />\n                Ask AI about this\n              </span>\n              <ArrowRight className=\"h-4 w-4\" />\n            </Button>\n            \n            <Button \n              onClick={handleAddToGoal}\n              className=\"w-full justify-between\"\n              variant=\"outline\"\n              data-testid=\"button-add-goal\"\n            >\n              <span className=\"flex items-center gap-2\">\n                <Target className=\"h-4 w-4\" />\n                Create a financial goal\n              </span>\n              <ArrowRight className=\"h-4 w-4\" />\n            </Button>\n            \n            <Button \n              onClick={handleGoToDashboard}\n              className=\"w-full\"\n              data-testid=\"button-go-dashboard\"\n            >\n              Go to Dashboard\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      {!hasContent && (\n        <div className=\"flex justify-center\">\n          <Button onClick={handleGoToDashboard} data-testid=\"button-back-home\">\n            Back to Home\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":5437,"size_tokens":null}},"version":2}